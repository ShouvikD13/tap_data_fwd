/******************************************************************************************/
/*	Program	    			:	SFO_PRCS_PIPO                                                     */
/*                                                                                        */
/*  Input             : FFO_XCHNG_CD                                                      */
/*                      FFO_TRD_DT                                                        */
/*                      FFO_EBA_MTCH_ACT_NO                                               */
/*                      FFO_RUN_NUM                                                       */
/*                      FFO_BAT_TAG                                                       */
/*                                                                                        */
/*  Output            :                                                                   */
/*                                                                                        */
/*  Desription        :                                                                   */
/*                                                                                        */
/*  Log               :                                                                   */
/*                                                                                        */
/******************************************************************************************/
/*      17-Dec-2001      Ver 1.0        P.Senthil kumar     Release 1.0                   */
/*      08-Nov-2003      Ver 1.1        Sangeet Sinha	      Payin Payout 		             	*/
/*																													Revamp for rerun 	            */
/*		  21-Sep-2006 		Ver 1.2					Smitha Nuti					NRI TDS Payout                */
/*      30-Nov-2007     Ver 1.3         Vidyayini Krish     IBM Changes                   */
/*      13-Sep-2011     Ver 1.4         Sachin Birje        Narration Changes             */
/*      25-Sep-2012     Ver 1.5         Sachin Birje        Code Optimization             */
/*      04-Dec-2013     Ver 1.6         Sachin Birje        Run No Handling               */
/*      18-Nov-2014     Ver 1.7         Sachin Birje        View to FML Changes           */
/*			28-Jan-2016			Ver 1.9					Tanmay Warkhade 		NRI Changes			            	*/
/*      18-Oct-2016     Ver 2.0         Vishal Borhade      IBR product code changes      */
/*			18-Jul-2018			Ver 2.1					Samip M 						Run number for Bank Service		*/
/*      09-Aug-2019     Ver 2.2         Akash B             Deposit Model Changes         */
/*      05-Mar-2021     Ver 2.3         Akash B             Minor Change                  */
/*      30-Sep-2021     Ver 2.4         Sachin Birje        IDFC Changes Changes          */
/*      08-Oct-2022     Ver 2.5         Sachin Birje        Spira257 Changes              */
/*      23-Jan-2023     Ver 2.6         Sachin Birje        R-ISEC03-177298_Wallet_balance*/
/*                                                          to_be_discontinued            */
/*      09-Mar-2023     Ver 2.7         Sachin Birje        Client Lock Changes           */
/*      03-May-2023     Ver 2.8         Sandip Tambe        HSBC Payin Payout Changes     */
/******************************************************************************************/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <atmi.h>
#include <fml32.h>
#include <sqlca.h>
/*Add header files here */
#include <fml_def.h>
/*** #include <fo_view_def.h> ** Ver 1.7 **/
#include <fo_view_def.h>      /** Ver 1.7 **/
#include <fn_battmpt.h>
#include <fo_fml_def.h>
/* Ver 1.3 #include <eba_to_ors.h> Not needed  */
#include <fn_tuxlib.h>
#include <fo.h>
#include <fo_bank.h>
#include <fn_ddr.h>
#include <fn_log.h> /* Ver 1.3 */
#include <fml_rout.h> /* Ver 1.3 */
#include <fn_read_debug_lvl.h> /* Ver 1.3 */
#include <fn_session.h>        /** Ver 2.2 **/
/** #include <eba.h>               ** ver 2.2 **/

/****** Ver 2.2 starts ******/

#define ALLOCATE_TO_SEGMENT 'A'     
#define CLEAR_BAL_TO_SGMNT_ALLOCATE 'I'        
#define WALLET_UNBLOCK_DEBIT 'J'

/****** Ver 2.2 ends *****/


int fn_ins_flr_tbl(	char *,	char *, char *, long, char *, char *, char, int	,
										char, double , char, char,char, char*, char*,char*,char ); /*** Ver 2.2 for model flag ***/ 

int fn_insrt_pipo_rpt_tbl(	char   *c_ServiceName,	
													  char   *c_xchng_cd, 
													  char   *c_cln_mtch_accnt, 
													  char   *c_run_dt, 
                            double d_payout_amt,
                            double d_blk4trd_amt,
                            double d_payin_amt,
                            double d_intadj_amt,
                            double d_bnk_pipo_amt,
                            double d_eba_pipo_amt,
                            double d_bnk_bft_amt,
                            double d_eba_bft_amt,
													  long	 li_run_no,
                            char   *c_bnk_narration, /*** Ver 1.4 bnk_narration added ***/
                            char *c_payin_pool_acc_nse, /*** Ver 2.2 ***/
                            char *c_payout_pool_acc_nse, /*** Ver 2.2 ***/
                            char *c_payin_pool_acc_bse,  /*** Ver 2.2 ***/
                            char *c_payout_pool_acc_bse, /*** Ver 2.2 ***/
                            char c_model_flg);   /** Ver 2.2 ***/  
 
/**** Ver 2.2 Starts ***/

int fn_ins_seg_log(char *,long,char *,char *,double,char,char *,double,char,char *,char *,long,char *,char *);
int fn_call_inc_dec_svc(double,char,double *,long,char *);
int fn_insrt_pbp_tbl(double);
int fn_call_ud_fromeq( double d_amt, char c_account_typ, double *d_bnk_avl_amt, long li_run_no ,char *c_run_dt ); /*Ver 2.6 */
int fn_eq_free_limit(double *d_eq_free);  /* ver 2.6 */

char c_txn_typ  = '\0';
char c_bnk_narration[21];
char c_xchng_cd[4];
char c_bnk_accnt[21];
char c_ServiceName [ 33 ];
char c_err_msg [ 256 ];
char c_tmstamp[23];
char c_refrnce[16];
char c_trace[13];
char c_narration[50];
char c_seg_prdct_cd[6];

int i_returncode;
int i_err[14];
int i_err_cd = 0;

long l_run_no = 0;
long l_tpurcode;

double d_tot_alc_amt = 0.0;

double d_amt_rs=0.0;
double d_wallet_amt_rs=0.0;
double d_rmng_pipo_amt_rs=0.0;
double d_amount_rs=0.0;
double d_amount_recovered=0.0;
double d_avlbl_amt=0.0;

struct vw_usr_prfl st_usr_prfl; /*** Ver 2.2 **/

FBFR32 *ptr_fml_Ibuf;

/********* Ver 2.2 ends ******/


void SFO_PRCS_PIPO( TPSVCINFO *rqst )
{
	FBFR32 *ptr_fml_Ibuf;
	
/*	char c_ServiceName [ 33 ]; *** made global in ver 2.2 */
/*	char c_err_msg [ 256 ];   *** made global in ver 2.2 */
	char c_tag [ 256 ];
	char c_msg [ 256 ];
	char c_rout [ 4 ];
	char c_timestamp [ 14 + 1 ]; /*1.1*/
/**  char c_bnk_narration[21]; *** Ver 1.4 ***  **** made global in ver 2.2 **/
  char c_blk_deposit_flg='\0';  /*** Ver 2.2 ***/


/*** 	int i_returncode; made global in ver 2.2 **/ 
	int i_ret_val;
	int i_ch_val;
	int i_ch_val_1 = 0;
	int i;
	int i_ip_len;
	int i_op_len;
	int i_trnsctn;
	int i_ret_state = 0;
 /** 	int i_err[11];  ** made global in ver 2.2 **/
	int i_ferr[14];
	int i_rc;


	long	li_run_no;

	double d_pipo_amt= 0.0;
	double d_limit= 0.0;
	double d_ia_amt= 0.0;
	double d_val_bal= 0.0;
	double d_new_bft= 0.0;
	double d_bal_amt= 0.0;
	double d_amt= 0.0;
  double d_amount_alloc=0.0;  /* Ver 2.6 */
  double d_eq_freelmt=0;     /* Ver 2.6 */

   /** Ver 2.2 starts **/

  double d_wallet_amt = 0.0;
  double d_rmng_pipo_amt = 0.0 ;
  double d_allocation_debit=0.0;

  char c_payin_pool_acc_nse[20];
  char c_payout_pool_acc_nse[20];
  char c_payin_pool_acc_bse[20];
  char c_payout_pool_acc_bse[20];
  char c_sgmnt_cd[4];
  char c_seg_narr[101];
  char c_bank_nm [ 11 ];    /** Ver 2.4 **/
  char c_idfc_payin_flg ='N';  /** Ver 2.4 **/
  char c_hsbc_payin_flg ='N';  /** Ver 2.8 **/

  c_txn_typ  = '\0';
  MEMSET(c_bnk_narration);
  MEMSET(c_xchng_cd);
  MEMSET(c_bnk_accnt);
  MEMSET(c_err_msg); 
  MEMSET(c_refrnce);
  MEMSET(c_trace);
  MEMSET(c_narration);
  MEMSET(c_seg_prdct_cd);

  MEMSET(c_payin_pool_acc_nse);
  MEMSET(c_payout_pool_acc_nse);
  MEMSET(c_payin_pool_acc_bse);
  MEMSET(c_payout_pool_acc_bse);
  MEMSET(c_sgmnt_cd);
  MEMSET(c_seg_narr);
  MEMSET(c_bank_nm);   /** Ver 2.4 **/

  i_returncode=0;
  i_err_cd = 0;

  l_run_no = 0;
  l_tpurcode=0;

  d_tot_alc_amt = 0.0;
  d_amt_rs=0.0;
  d_wallet_amt_rs=0.0;
  d_rmng_pipo_amt_rs=0.0;
  d_amount_rs=0.0;
  d_amount_recovered=0.0;
  d_avlbl_amt=0.0;


  /** Ver 2.2 ends **/


	struct vw_upd_limits st_upd_lmts;
	/*struct vw_gt_lmt_dtls st_gt_lmt;*/
/**	struct vw_usr_prfl st_usr_prfl;  made global in ver 2.2 ***/

 	EXEC SQL BEGIN DECLARE SECTION;
/**	char c_xchng_cd[4];  made global in ver 2.2 ***/
	char c_narration_id[4];
	char c_dr_cr_flg;
	char c_lmt_prj_flg;
	char c_cln_mtch_accnt[11];
/**	char c_bnk_accnt[21];  made global in ver 2.2 ***/
	char c_reference[16];
	varchar c_bill_no[51];
	int i_grp_id;
	double d_cr_amt;
	double d_dr_amt;
	double d_amount;
	double d_alctd_amt;
	double d_bft_amt;
	double d_amt_to_be_clsd;
	double d_adj_amt;
	double d_min_payin_amt;
	double d_min_payout_amt;
	char c_run_dt[12];
	char c_trd_dt[12];
	char c_payin_dt[12];
	char c_payout_dt[12];
	char c_sys_dt[12];

  double d_payin_amt;
  double d_payout_amt;
  double d_intadj_amt;
  double d_blk4trd_amt;
  double d_bnk_pipo_amt;
  double d_eba_pipo_amt;
  double d_bnk_bft_amt;
  double d_eba_bft_amt;

	double d_dr_tds_amt; 	/*Ver 1.2 */

	EXEC SQL END DECLARE SECTION;

	d_payin_amt    = 0.0;
	d_payout_amt   = 0.0;
	d_intadj_amt   = 0.0;
	d_blk4trd_amt  = 0.0;
	d_bnk_pipo_amt = 0.0;
	d_eba_pipo_amt = 0.0;
	d_bnk_bft_amt  = 0.0;
	d_eba_bft_amt  = 0.0;
	d_dr_tds_amt   = 0.0; /*Ver 1.2 */

  EXEC SQL INCLUDE "table/iai_info_account_info.h"; /* Ver 1.9 */
	ptr_fml_Ibuf = ( FBFR32 * )rqst->data;
	strcpy( c_ServiceName, "SFO_PRCS_PIPO" );
	INITDBGLVL(c_ServiceName);

/*The Copied date will notify that it is not for rerun but for fresh run 
  The code below is commented because it was decided during testing to keep 
	date as date variable in the rerun table*/

	/*strcpy( c_timestamp, "N" );*/
  strcpy( c_timestamp, "01-Jan-1980" );				/*1.1*/
  strcpy(c_sgmnt_cd,"NFO"); 

	i_err[0] = Fget32( ptr_fml_Ibuf, FFO_XCHNG_CD, 0,
                                   (char *)c_xchng_cd, 0 );
  i_ferr[0] = Ferror32;
	i_err[1] = Fget32( ptr_fml_Ibuf, FFO_TRD_DT, 0,
                                   (char *)c_run_dt, 0 );
  i_ferr[1] = Ferror32;
	i_err[2] = Fget32( ptr_fml_Ibuf, FFO_EBA_MTCH_ACT_NO, 0,
                                   (char *)c_cln_mtch_accnt, 0 );
  i_ferr[2] = Ferror32;
	i_err[3] = Fget32( ptr_fml_Ibuf, FFO_RUN_NUM, 0,
                                   (char *)&li_run_no, 0 );
  i_ferr[3] = Ferror32;
	i_err[4] = Fget32( ptr_fml_Ibuf, FFO_BAT_TAG, 0,
                                   (char *)c_tag, 0 );
  i_ferr[4] = Ferror32;
	i_err[5] = Fget32( ptr_fml_Ibuf, FFO_ROUT_CRT, 0,
                                   (char *)c_rout, 0 );
  i_ferr[5] = Ferror32;
  
  /**** Ver 1.5 starts here ****/
  i_err[6] = Fget32( ptr_fml_Ibuf, FFO_U_ORDR_MRGN, 0,
                                   (char *)&d_min_payin_amt, 0 );
  i_ferr[6] = Ferror32;

  i_err[7] = Fget32( ptr_fml_Ibuf, FFO_U_EXCTD_MRGN, 0,
                                   (char *)&d_min_payout_amt, 0 );
  i_ferr[7] = Ferror32;

  /**** Ver 2.2 starts  ******/

  i_err[8] =  Fget32( ptr_fml_Ibuf, FFO_UPLD_MTCH_FLG, 0,
                                    (char *)&c_blk_deposit_flg, 0 ); 
  i_ferr[8] = Ferror32;

  i_err[9] = Fget32( ptr_fml_Ibuf, FFO_IP_VIEW_NM, 0,
                                   (char *)c_payin_pool_acc_nse, 0 );
  i_ferr[9] = Ferror32;

  i_err[10] = Fget32( ptr_fml_Ibuf, FFO_OP_VIEW_NM, 0,
                                   (char *)c_payout_pool_acc_nse, 0 );
  i_ferr[10] = Ferror32;

  i_err[11] = Fget32( ptr_fml_Ibuf,FFO_SETTLOR, 0,
                                     (char *)c_payin_pool_acc_bse, 0);
  i_ferr[11] = Ferror32;

  i_err[12] = Fget32( ptr_fml_Ibuf,FFO_SPRD_ORD_REF, 0,
                                     (char *)c_payout_pool_acc_bse, 0);
  i_ferr[12] = Ferror32;

  i_err[13] = Fget32( ptr_fml_Ibuf,FFO_QUEUE_NAME, 0,                           /*** Ver 2.4, added here ***/
                                     (char *)c_bank_nm, 0);
  i_ferr[13] = Ferror32;

  /**** Ver 2.2 ends *****/

  /**** Ver 1.5 ends here *****/
  for (i=0;i<14;i++)         /*** Ver 1.5 , Changed from 6 to 8 ***/  /***** changed from 8 to 13 in ver 2.2 ****/ /*Ver 2.4, 14 */
	{
 		 if (i_err[i] == -1)
  	 {
  			fn_userlog(c_ServiceName,"Error in Fget at [%d],[%s]",
																					i,Fstrerror32( i_ferr[i]));
    		fn_errlog(c_ServiceName, "S31005", FMLMSG, c_err_msg  );
    		tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  	 }
  }

   /**** Ver 2.2 Starts *****/

  if ( c_blk_deposit_flg!='B' && c_blk_deposit_flg!='D')
  {
    fn_userlog(c_ServiceName,"Invalid model flag");
    fn_userlog(c_ServiceName,"Skipping for match account :%s:",c_cln_mtch_accnt);
    fn_errlog(c_ServiceName, "S31010",LIBMSG,c_err_msg);
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 ); 
  }

  /***** Ver 2.2 Ends *******/

 /*** Added for Order Routing ***/
  fn_init_ddr_val ( c_rout );

  /*sprintf ( c_msg, "Processing match account no %s ", c_cln_mtch_accnt );
  fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag ); */
 
  /***** Ver 1.5 , Commented here & included in calling Batch Program ****
  EXEC SQL
 			SELECT FSP_MIN_PAYIN_AMT,
 		 			   FSP_MIN_PAYOUT_AMT,
             to_char(sysdate,'dd-Mon-yyyy')
			INTO  :d_min_payin_amt,
 		 		    :d_min_payout_amt,
						:c_sys_dt
			FROM FSP_FO_SYSTM_PRMTR; 

  if ( SQLCODE != 0 )
  {
    fn_errlog(c_ServiceName, "S31015",SQLMSG,c_err_msg);
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
  ********* Ver 1.5 Ends here **********/
  
	EXEC SQL
  	SELECT 	FAB_BNK_ACCNT ,
				 		FAB_ALCTD_AMT,
				 		FAB_BFT_AMT
		INTO  	:c_bnk_accnt,
        		:d_alctd_amt,
        		:d_bft_amt
		FROM FAB_FO_ALC_BFT_SMRY , CLB_BNK_ACCTS
		WHERE FAB_CLM_MTCH_ACCNT = :c_cln_mtch_accnt
		AND CLB_CLM_MTCH_ACCNT = FAB_CLM_MTCH_ACCNT;

  if ( SQLCODE != 0 )
  {
    fn_errlog(c_ServiceName, "S31020",SQLMSG,c_err_msg);
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
 	rtrim(c_bnk_accnt); 

  strcpy(st_usr_prfl.c_user_id,"system");
  strcpy(st_usr_prfl.c_cln_mtch_accnt,c_cln_mtch_accnt);
  strcpy(st_usr_prfl.c_bnk_accnt_nmbr[0],c_bnk_accnt);
  st_usr_prfl.l_session_id = 0;

	/** Ver 1.2 Add **/
	/** Get the TDS amount to be debited for a given client **/ 
 
  /**** Ver 1.5, Select TDS amount, only for NRI( 751 Series ) customer ****/
  
  /**** if(strncmp(c_cln_mtch_accnt, "751", 3)  == 0 )  *** Commented in Ver 1.9 *******/


  /***** Ver 2.4 Starts Here ***/
  fn_userlog(c_ServiceName,"c_bank_nm :%s:",c_bank_nm);
  if( strcmp(c_bank_nm,"IDFC") == 0 && c_blk_deposit_flg=='B' && strcmp(c_bnk_accnt,DUMMY_BNK_ACCNT)!=0 )
  {
    c_idfc_payin_flg ='Y';
    fn_userlog(c_ServiceName,"c_idfc_payin_flg :%c:",c_idfc_payin_flg);
  }
  /***** Ver 2.4 Ends Here ****/
  /***** Ver 2.8 Starts Here ***/
  if( strcmp(c_bank_nm,"HSBC") == 0)
  {
    c_hsbc_payin_flg ='Y';
    fn_userlog(c_ServiceName,"c_hsbc_payin_flg :%c:",c_hsbc_payin_flg);
  }
  /***** Ver 2.8 Ends Here ****/

		
	/********** Added in Ver 1.9 starts ********/
  MEMSET( sql_iai_type );
  EXEC SQL
  SELECT  IAI_TYPE
  INTO    :sql_iai_type
  FROM    IAI_INFO_ACCOUNT_INFO
  WHERE   IAI_MATCH_ACCOUNT_NO  = :c_cln_mtch_accnt ;

  if ( SQLCODE != 0 )
  {
     fn_errlog(c_ServiceName, "S31025",SQLMSG,c_err_msg);
     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  SETNULL(sql_iai_type);
  /********** Added in Ver 1.9 Ends ********/

  if(strcmp(sql_iai_type.arr,"NRO_NON_PINS") == 0)   /********** check Added in Ver 1.9 ********/
  {
   fn_userlog(c_ServiceName,"TDS Selection ....");  /*** Ver 1.5 ***/

   EXEC SQL
				SELECT  NVL(SUM(FBD_DC_AMT - FBD_PI_PO_AMT - FBD_INT_ADJ_AMT),0)
				INTO  :d_dr_tds_amt
				FROM  FBD_FO_BNK_DRCR
				WHERE FBD_XCHNG_CD = :c_xchng_cd
				AND   FBD_DC_FLG = 'D'
				AND   FBD_CLM_MTCH_ACCNT  = :c_cln_mtch_accnt 
				AND   FBD_PAYIN_DT <= to_date(:c_run_dt, 'dd-Mon-yyyy' )
				AND   FBD_DC_AMT != FBD_PI_PO_AMT + FBD_INT_ADJ_AMT
				AND   FBD_GRP_ID = 9;

	 if (( SQLCODE != 0 ) && ( SQLCODE != NO_DATA_FOUND ))
	 {
		 fn_errlog(c_ServiceName, "S31030",SQLMSG,c_err_msg);
		 tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
	 }
	 if ( SQLCODE == NO_DATA_FOUND)
	 {
		d_dr_tds_amt = 0.0;
	 }
  }
  else  /*** Ver 1.5 ***/ 
  {
   d_dr_tds_amt = 0.0;  /*** For Normal Customers TDS is 0 ***/
  }

	fn_userlog(c_ServiceName,"TDS....... d_dr_tds_amt [%lf]",d_dr_tds_amt);

	/*** Ver 1.2 add end**/

  EXEC SQL
				SELECT  NVL(SUM(FBD_DC_AMT - FBD_PI_PO_AMT - FBD_INT_ADJ_AMT),0)
				INTO  :d_cr_amt
				FROM  FBD_FO_BNK_DRCR
				WHERE FBD_XCHNG_CD = :c_xchng_cd
				AND   FBD_DC_FLG = 'C'
				AND   FBD_CLM_MTCH_ACCNT  = :c_cln_mtch_accnt 
				AND   FBD_PAYOUT_DT <= to_date(:c_run_dt, 'dd-Mon-yyyy' ) 
				AND   FBD_DC_AMT != FBD_PI_PO_AMT + FBD_INT_ADJ_AMT;

  if (( SQLCODE != 0 ) && ( SQLCODE != NO_DATA_FOUND ))
  {
    fn_errlog(c_ServiceName, "S31035",SQLMSG,c_err_msg);
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
  if ( SQLCODE == NO_DATA_FOUND)
  {
		d_cr_amt = 0;
  }

  EXEC SQL
				SELECT  NVL(SUM(FBD_DC_AMT - FBD_PI_PO_AMT - FBD_INT_ADJ_AMT),0)
				INTO  :d_dr_amt
				FROM  FBD_FO_BNK_DRCR
				WHERE FBD_XCHNG_CD = :c_xchng_cd
				AND   FBD_DC_FLG = 'D'
				AND   FBD_CLM_MTCH_ACCNT  = :c_cln_mtch_accnt 
				AND   FBD_PAYIN_DT <= to_date(:c_run_dt, 'dd-Mon-yyyy' )
				AND   FBD_DC_AMT != FBD_PI_PO_AMT + FBD_INT_ADJ_AMT
				AND   FBD_GRP_ID <> 9;							/** Ver 1.2 add **/

  if (( SQLCODE != 0 ) && ( SQLCODE != NO_DATA_FOUND ))
  {
    fn_errlog(c_ServiceName, "S31040",SQLMSG,c_err_msg);
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
  if ( SQLCODE == NO_DATA_FOUND)
  {
		d_dr_amt = 0;
  }

  /* net Payin-Payout amount = payout amount + payin amount */
  d_pipo_amt = d_cr_amt + d_dr_amt ;

	fn_userlog(c_ServiceName,"DEBIT...............d_dr_amt [%lf]",d_dr_amt);
	fn_userlog(c_ServiceName,"CREDIT..............d_cr_amt [%lf]",d_cr_amt);
	fn_userlog(c_ServiceName,"PIPO................d_pipo_amt [%lf]",d_pipo_amt);

/************************************ 
  d_payin_amt = d_dr_amt * -1.0;
************************************/
  d_payin_amt = d_dr_amt;
  d_payout_amt = d_cr_amt;

  /*sprintf ( c_msg, "Payin Payout amount is [%lf] for match account %s ", 
            d_pipo_amt, c_cln_mtch_accnt );
  fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag ); */

  if ( d_pipo_amt >= 0 )
  {
     d_ia_amt = d_dr_amt;  /* Internal Adjustment amount = payin amt*/
  }
  else 
  {
     d_ia_amt = d_cr_amt; /* Internal Adjustment amount = payout amt*/
  }

 /* sprintf ( c_msg, "Internal adjustment amount is [%lf] for match account %s ",
            d_ia_amt, c_cln_mtch_accnt );
  fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );*/

	fn_userlog(c_ServiceName,"d_ia_amt [%lf]",d_ia_amt);
  /*** Ver 1.4 Starts ***/
  fn_userlog(c_ServiceName," Run Date :%s:",c_run_dt);
  MEMSET(c_bnk_narration);
  sprintf(c_bnk_narration,"F&O/%s",c_run_dt);
  fn_userlog(c_ServiceName," Narration Formed :%s:",c_bnk_narration); 
  /*** Ver 1.4 Ends ***/

  if ( d_pipo_amt   >= 0 )  /*  Payout Process */
  {

    if(c_blk_deposit_flg=='D' )
    {
     sprintf(c_seg_prdct_cd,"%s%s",c_xchng_cd,"OD");
    }
    else
    {
     sprintf(c_seg_prdct_cd,"%s%s",c_xchng_cd,"O");
    }

    rtrim(c_seg_prdct_cd);
    fn_userlog(c_ServiceName,"c_seg_prdct_cd :%s:",c_seg_prdct_cd);

		fn_userlog(c_ServiceName,"PIPO >=0................ d_pipo_amt [%lf]",d_pipo_amt );
     if ( d_ia_amt < 0 ) /* Internal adjustment for Payout */ 
     {   

			fn_userlog(c_ServiceName,"DR (-1) Internal adjustment for Payout %lf",d_ia_amt);

				i_returncode =  fn_do_ia ( 	c_ServiceName,
               											c_err_msg,
               											c_cln_mtch_accnt,
               											c_xchng_cd,
               											c_run_dt,
               											c_tag,
               											DEBIT,
               											d_ia_amt * (-1.0),
                                    li_run_no, /*** Ver 1.6 Run number Added */
                                    c_bnk_accnt, /** Ver 2.2 **/ 
                                    c_blk_deposit_flg); /** Ver 2.2 ***/

  			if ( i_returncode != 0 ) 
  			{
    			/*1.1:Insert into FTR not needed*/
					fn_errlog(c_ServiceName, "S31045",LIBMSG,c_err_msg); 
    			tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  			}
     		d_intadj_amt = d_ia_amt;

     } /* d_ia_amt < 0 Internal adjustment for Payout */

     if ( d_pipo_amt  < d_min_payout_amt )
     {
      	sprintf ( c_msg,"Payout amount is less than the minimum payout for :%s:"
                  ,c_cln_mtch_accnt); 
  			/*fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag ); */
     }
     else if ( d_pipo_amt  > 0 )/* Bank Payout to be processed */
 		 {	
				fn_userlog(c_ServiceName,"PIPO > 0................ d_pipo_amt [%lf]",d_pipo_amt );
		

      if( c_blk_deposit_flg == 'B') /**** Ver 2.2 ****/
      { 
    		d_new_bft = d_pipo_amt ;
				fn_userlog(c_ServiceName,"PIPO > 0................ d_new_bft [%lf]",d_new_bft );

        d_blk4trd_amt = d_new_bft;

 			 sprintf ( c_msg, "BFT amount is [%lf] for match account %s ",
           d_new_bft, c_cln_mtch_accnt );
  			 /*fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );*/
        
				 fn_userlog(c_ServiceName,"%s",c_msg );

         c_dr_cr_flg = CR ;
         
				 /******************************************************/
         /*  Sending Payout message to Bank                    */   
         /******************************************************/

  			 strcpy( c_timestamp, "01-Jan-1980" );	/*1.1*/
         i_returncode =  fn_send_bnk_msg (&st_usr_prfl,
                        					        c_dr_cr_flg,
                                 					"  ",
                                 					d_pipo_amt,
                                 					BACKOFFICE,
                                 					c_ServiceName,
                                 					c_err_msg,
                                 					&d_val_bal,
                                 					c_reference,
																					c_timestamp,
																					c_bnk_narration, /*** Ver 1.4 bnk_narration added ***/
                                          c_xchng_cd,     /** Ver 2.0 **/
																					li_run_no);			/** Added for Ver 2.1 **/

       }   
       else
       {
         i_returncode = SUCCESS;     /*** Ver 2.2 ***/
       }
	
      	switch ( i_returncode )
      	{
        	case SUCCESS :
						i_ret_state = FROM_CREDIT_SUCCESS ;
            d_bnk_pipo_amt = d_pipo_amt;

						break;
  

        	case GENERAL_FAILURE :
        	case INSUF_FUNDS :
        	case BLOCK_NOT_EXISTING :
						i_ret_state = FROM_CREDIT_FAILURE ;
    				fn_errlog(c_ServiceName, "S31050",LIBMSG,c_err_msg);
      			sprintf ( c_msg,
                      "Error while sending credit message to bank for %s",
                      c_cln_mtch_accnt); 
  					fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
						i_rc 	=	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	
					  				                        c_xchng_cd, 
					  				                        c_cln_mtch_accnt, 
					  				                        c_run_dt, 
                                            d_payout_amt,
                                            d_blk4trd_amt,
                                            d_payin_amt,
                                            d_intadj_amt,
                                            d_bnk_pipo_amt,
                                            d_eba_pipo_amt,
                                            d_bnk_bft_amt,
                                            d_eba_bft_amt,
									                          li_run_no,
                                            c_bnk_narration,  /*** Ver 1.4 bnk_narration added ***/
                                            c_payin_pool_acc_nse, /**** Ver 2.2 pool ***/
                                            c_payout_pool_acc_nse, /**** Ver 2.2 pool ***/
                                            c_payin_pool_acc_bse, /**** Ver 2.2 pool ***/
                                            c_payout_pool_acc_bse,  /**** Ver 2.2 pool ***/
                                            c_blk_deposit_flg ); /**** Ver 2.2 pool ***/

						if ( i_rc != 0 )
						{
    					fn_errlog(c_ServiceName, "S31055",LIBMSG,c_err_msg);
      				strcpy( c_msg, "System error. Contact system support" );
  						fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    					tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
						}
    				tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );  
						break;

        	case INDERMINATE_FAILURE :
					case RERUN_FAILURE :																				/*1.1*/
					default :
						i_ret_state = FROM_CREDIT_INDERMINATE_FAILURE ;
      			sprintf(c_msg,"Indet. failure for %s while sending credit messageto bank",c_cln_mtch_accnt); 
  					fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
						i_ret_val = fn_ins_flr_tbl(	c_ServiceName,								/*1.1*/
																			c_xchng_cd,
																			c_cln_mtch_accnt,
																			li_run_no,
																			c_run_dt,
																			c_bnk_accnt,
																			CREDIT,
																			CREDIT_ON_PAYOUT,
																			CREDIT, 
																			d_pipo_amt,
																			NOT_UPDATED,
																			NOT_UPDATED,
																			NOT_UPDATED,											/* Three more added by 1.1*/
																			c_reference,
																			c_timestamp,
                                      c_bnk_narration,        /*** Ver 1.4 bnk_narration added ***/
                                      c_blk_deposit_flg);     /*** Ver 2.2 flag added *****/
 
          if ( i_ret_val != 0 )
					{
      			strcpy ( c_msg, "System error. Contact system support" );
  					fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    				tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );  
					}
					/****This condition is under supervision******************************/
					/*** Need to be checked at testing that whether it is required or not*/
					if ( d_new_bft > 0 )						/*1.1:added to Insert  BFT ERROR in this case*/
					{
   								 i_ret_val = fn_ins_flr_tbl( c_ServiceName,
                               c_xchng_cd,
                               c_cln_mtch_accnt,
                               li_run_no,
                               c_run_dt,
                               c_bnk_accnt,
                               BLOCK,
                               BFT_ON_PAYOUT,
                               CREDIT,
                               d_new_bft,
                               NOT_UPDATED,
                               NOT_UPDATED,
															 NOT_UPDATED,														/* Three more added by 1.1*/
															 c_reference,
															 c_timestamp,
                               c_bnk_narration,        /*** Ver 1.4 bnk_narration added ***/
                               c_blk_deposit_flg);    /**** Ver 2.2 block flag added ****/
 
   								if ( i_ret_val != 0 )
									{
										 strcpy ( c_msg, "System error. Contact system support" );
										 fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
										 i_rc  = fn_insrt_pipo_rpt_tbl(  	  c_ServiceName,
																										    c_xchng_cd,
																												c_cln_mtch_accnt,
																												c_run_dt,
																												d_payout_amt,
																												d_blk4trd_amt,
																												d_payin_amt,
																												d_intadj_amt,
																												d_bnk_pipo_amt,
																												d_eba_pipo_amt,
																												d_bnk_bft_amt,
																												d_eba_bft_amt,
																												li_run_no,
                                                        c_bnk_narration,   /*** Ver 1.4 bnk_narration added ***/
                                                        c_payin_pool_acc_nse,  /*** Ver 2.2 *****/
                                                        c_payout_pool_acc_nse,  /*** Ver 2.2 *****/
                                                        c_payin_pool_acc_bse,  /*** Ver 2.2 *****/
                                                        c_payout_pool_acc_bse,  /*** Ver 2.2 *****/
					                                              c_blk_deposit_flg);  /*** Ver 2.2 *****/

										if ( i_rc != 0 )
										{
											fn_errlog(c_ServiceName, "S31060",LIBMSG,c_err_msg);
											strcpy( c_msg, "System error. Contact system support" );
											fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
											tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
										}
							      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              		}
         }
				 i_rc 	 =	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	   
					  				                        c_xchng_cd, 
					  				                        c_cln_mtch_accnt, 
					  				                        c_run_dt, 
                                            d_payout_amt,
                                            d_blk4trd_amt,
                                            d_payin_amt,
                                            d_intadj_amt,
                                            d_bnk_pipo_amt,
                                            d_eba_pipo_amt,
                                            d_bnk_bft_amt,
                                            d_eba_bft_amt,
									                          li_run_no,
                                            c_bnk_narration,  /*** Ver 1.4 bnk_narration added ***/
                                            c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                            c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                            c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                            c_payout_pool_acc_bse, /*** Ver 2.2 **/
					                                  c_blk_deposit_flg); /*** Ver 2.2 **/

							if ( i_rc != 0 )
							{
    						fn_errlog(c_ServiceName, "S31065",LIBMSG,c_err_msg);
      					strcpy( c_msg, "System error. Contact system support" );
  							fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    						tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
							}
    			 		tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );  
					 		break;
        
				}/*End of switch*/



				i_returncode =  fn_do_cr ( 	c_ServiceName,
               											c_err_msg,
               											c_cln_mtch_accnt,
               											c_xchng_cd,
               											c_run_dt,
               											c_tag,
               											d_pipo_amt,
                                    li_run_no, /** Ver 1.6 Run Number Added **/
                                    c_bnk_accnt, /*** Ver 2.2 ***/
                                    c_reference, /*** Ver 2.2 ***/
                                    c_blk_deposit_flg ); /** Ver 2.2 */

 

  			if ( i_returncode != 0 ) 
  			{
    			fn_errlog(c_ServiceName, "S31070",LIBMSG,c_err_msg); 
      		strcpy ( c_msg, "System error. Contact system support" );
  				fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
																																		/*1.1:Ops Proposed Removal of 
																																			this part of error condition but 
																																			I am still carrying with Coinsid
																																			ering there is no harm in keeping 
                                                                      this as success bank message but
                                                                      failed EBA*/
   
	    		if( c_blk_deposit_flg == 'B')                                  
          {																															
			    	 i_ret_val = fn_ins_flr_tbl( c_ServiceName,
                                         c_xchng_cd,
                                         c_cln_mtch_accnt,
                                         li_run_no,
                                         c_run_dt,
                                         c_bnk_accnt,
                                         CREDIT,
                                         CREDIT_ON_PAYOUT,
                                         CREDIT,
                                         d_pipo_amt,
                                         UPDATED,												/*1.1*/
                                         NOT_UPDATED, 								 
																	   	 	NOT_UPDATED,												/* Three more added by 1.1*/
																	   		c_reference,
																		  	c_timestamp,
                                        c_bnk_narration,     /*** Ver 1.4 bnk_narration added ***/
                                        c_blk_deposit_flg); /*** Ver 2.2 **/
           
            if ( i_ret_val != 0 )
				 	  {
      				strcpy ( c_msg, "System error. Contact system support" );
  						fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
					    i_rc 	=	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	
						    			                        c_xchng_cd, 
							    		                        c_cln_mtch_accnt, 
								    	                        c_run_dt, 
                                              d_payout_amt,
                                              d_blk4trd_amt,
                                              d_payin_amt,
                                              d_intadj_amt,
                                              d_bnk_pipo_amt,
                                              d_eba_pipo_amt,
                                              d_bnk_bft_amt,
                                              d_eba_bft_amt,
									                            li_run_no,
                                              c_bnk_narration,       /*** Ver 1.4 bnk_narration added ***/
                                              c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                              c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                              c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                              c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                              c_blk_deposit_flg); /*** Ver 2.2 **/

					    if ( i_rc != 0 )
					    {
    						fn_errlog(c_ServiceName, "S31075",LIBMSG,c_err_msg);
      			    strcpy( c_msg, "System error. Contact system support" );
  					    fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    				    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
					    }
    					tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
					 }
					/****This condition is under supervision******************************/
					/*** Need to be checked at testing that whether it is required or not*/
					 if ( d_new_bft > 0 )
					 {
							i_ret_val = fn_ins_flr_tbl(	c_ServiceName,
																					c_xchng_cd,
																					c_cln_mtch_accnt,
																					li_run_no,
																					c_run_dt,
																					c_bnk_accnt,
																					BLOCK,
																					BFT_ON_PAYOUT,
																					CREDIT, 
																					d_new_bft,
																					NOT_UPDATED,
																					NOT_UPDATED,
																					NOT_UPDATED,										/* Three more added by 1.1*/
																					c_reference,
																					c_timestamp,
                                          c_bnk_narration,         /*** Ver 1.4 bnk_narration added ***/ 
                                          c_blk_deposit_flg); /*** Ver 2.2 ****/
 
           		if ( i_ret_val != 0 )
					 		{
      					strcpy ( c_msg, "System error. Contact system support" );
  							fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
					      i_rc 	=	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	
							      		                        c_xchng_cd, 
									                              c_cln_mtch_accnt, 
									                              c_run_dt, 
                                                d_payout_amt,
                                                d_blk4trd_amt,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_bnk_pipo_amt,
                                                d_eba_pipo_amt,
                                                d_bnk_bft_amt,
                                                d_eba_bft_amt,
									                              li_run_no,
                                                c_bnk_narration,        /*** Ver 1.4 bnk_narration added ***/
                                                c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                c_blk_deposit_flg); /*** Ver 2.2 **/                                               

					      if ( i_rc != 0 )
					      {
    							fn_errlog(c_ServiceName, "S31080",LIBMSG,c_err_msg);
      			      strcpy( c_msg, "System error. Contact system support" );
  					      fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    				      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
					      }
    						tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
					 		}
					 	}
						i_rc 	=	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	
					   				                        c_xchng_cd, 
						   			                        c_cln_mtch_accnt, 
							   		                        c_run_dt, 
                                            d_payout_amt,
                                            d_blk4trd_amt,
                                            d_payin_amt,
                                            d_intadj_amt,
                                            d_bnk_pipo_amt,
                                            d_eba_pipo_amt,
                                            d_bnk_bft_amt,
                                            d_eba_bft_amt,
									                          li_run_no,
                                            c_bnk_narration,   /*** Ver 1.4 bnk_narration added ***/
                                            c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                            c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                            c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                            c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                            c_blk_deposit_flg); /*** Ver 2.2 **/

						if ( i_rc != 0 )
						{
    					fn_errlog(c_ServiceName, "S31085",LIBMSG,c_err_msg);
							strcpy( c_msg, "System error. Contact system support" );
							fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
							tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
					  }
    	    }
          else
          {
            fn_userlog(c_ServiceName," FTR Entry - Error in  Credit to Allocation ( Deposit Model)");

            i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                             c_xchng_cd,
                                             c_cln_mtch_accnt,
                                             c_run_dt,
                                             d_payout_amt,
                                             0,
                                             d_payin_amt,
                                             d_intadj_amt,
                                             0, /** bank 0 amount **/
                                             0, /** EBA 0 amount **/
                                             0,
                                             0,
                                             li_run_no,
                                             c_bnk_narration,
                                             c_payin_pool_acc_nse, /*** Ver 2.2 **/
                                             c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                             c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                             c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                             c_blk_deposit_flg);  /*** Ver 2.2 **/
            

            if ( i_rc != 0 )
            {
             fn_errlog(c_ServiceName, "S31090",LIBMSG,c_err_msg);
             strcpy( c_msg, "System error. Contact system support" );
             fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
             tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
            }

            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );

          }
        	tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 ); 
  			}/*End of fn_do_cr failed.*/
    
        d_amount_recovered=d_pipo_amt;
        fn_userlog(c_ServiceName,"Amount recovered upto allocation :%lf:",d_amount_recovered);

				/*1.1:If condition of indeterminate failure is removed and taken care into the switch
				 section itself*/

       if ( c_blk_deposit_flg =='B') /**** Ver 2.2 ******/ 
       {
				d_eba_pipo_amt = d_pipo_amt;
				i_ret_state = 0 ;

				if ( d_new_bft > 0 ) /* Handling BFT */
        {
        	c_dr_cr_flg = BK ;
  			 strcpy( c_timestamp, "01-Jan-1980" );
         if( c_idfc_payin_flg =='Y' )
         {
            
            i_returncode =  fn_send_bnk_msg (&st_usr_prfl,
                                            c_dr_cr_flg,
                                            FO_BLK_CD,
                                            d_new_bft,
                                            BACKOFFICE,
                                            c_ServiceName,
                                            c_err_msg,
                                            &d_val_bal,
                                            c_reference,
                                            c_timestamp,
                                            c_bnk_narration, 
                                            c_xchng_cd,     
                                            li_run_no);    
         }
         else
         {
         	i_returncode =  fn_send_bnk_msg (&st_usr_prfl,
         			             					        c_dr_cr_flg,
            		                  					FO_BFT_BLK_CD,
               		                					d_new_bft,
                 		              					BACKOFFICE,
                   		            					c_ServiceName,
                     		          					c_err_msg,
                       		        					&d_val_bal,
                         		      					c_reference,
																						c_timestamp,
																						c_bnk_narration, /*** Ver 1.4 bnk_narration added ***/
                                            c_xchng_cd,     /** Ver 2.0 **/
																						li_run_no);			/** Added for Ver 2.1 **/
          }
     			switch ( i_returncode )
     			{
       			case SUCCESS :
            d_bnk_bft_amt = d_new_bft;
						break;

       			case GENERAL_FAILURE :
       			case INSUF_FUNDS :
       			case BLOCK_NOT_EXISTING :
       			case INDERMINATE_FAILURE :
       			case RERUN_FAILURE :																	/*1.1:new error trap*/
						default :
    					fn_errlog(c_ServiceName, "S31095",LIBMSG,c_err_msg);
							/*** Insert into Failure table ***/
							i_ret_val = fn_ins_flr_tbl(	c_ServiceName,
																					c_xchng_cd,
																					c_cln_mtch_accnt,
																					li_run_no,
																					c_run_dt,
																				  c_bnk_accnt,
																					BLOCK,
																				  BFT_ON_PAYOUT,
																					CREDIT, /* ignore */
																					d_new_bft,
																					NOT_UPDATED,
																					NOT_UPDATED,
																					NOT_UPDATED,									/* Three more added by 1.1*/
																					c_reference,
																					c_timestamp,
                                          c_bnk_narration,          /*** Ver 1.4 bnk_narration added ***/
                                          c_blk_deposit_flg); /*** Ver 2.2 **/
    
           		if ( i_ret_val != 0 )
							{
     						strcpy ( c_msg, "System error. Contact system support" );
  							fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
								i_rc 	=	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	
							       		                        c_xchng_cd, 
									                              c_cln_mtch_accnt, 
									                              c_run_dt, 
                                                d_payout_amt,
                                                d_blk4trd_amt,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_bnk_pipo_amt,
                                                d_eba_pipo_amt,
                                                d_bnk_bft_amt,
                                                d_eba_bft_amt,
									                              li_run_no,
                                                c_bnk_narration,       /*** Ver 1.4 bnk_narration added ***/
                                                c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                c_blk_deposit_flg); /*** Ver 2.2 **/

								if ( i_rc != 0 )
								{
    							fn_errlog(c_ServiceName, "S31100",LIBMSG,c_err_msg);
      						strcpy( c_msg, "System error. Contact system support" );
  								fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    							tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
								}
    						tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
							}
     					sprintf (c_msg,"Error sending BFT message on payout to bank for %s", c_cln_mtch_accnt); 
  						fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
							i_rc 	=	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	
						    			                        c_xchng_cd, 
							    		                        c_cln_mtch_accnt, 
								    	                        c_run_dt, 
                                              d_payout_amt,
                                              d_blk4trd_amt,
                                              d_payin_amt,
                                              d_intadj_amt,
                                              d_bnk_pipo_amt,
                                              d_eba_pipo_amt,
                                              d_bnk_bft_amt,
                                              d_eba_bft_amt,
									                            li_run_no,
                                              c_bnk_narration,     /*** Ver 1.4 bnk_narration added ***/
                                              c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                              c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                              c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                              c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                              c_blk_deposit_flg); /*** Ver 2.2 **/

							if ( i_rc != 0 )
							{
    						fn_errlog(c_ServiceName, "S31105",LIBMSG,c_err_msg);
      					strcpy( c_msg, "System error. Contact system support" );
  							fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    						tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
							}
    					tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
							break;
					}
 
          if ( c_idfc_payin_flg == 'Y')  /** Ver 2.4 If condition added **/ 
          {

	  				i_returncode =  fn_do_alloc ( c_ServiceName,
                											c_err_msg,
                											c_cln_mtch_accnt,
                											c_bnk_accnt,
                											c_tag,
               												d_new_bft,
                                      li_run_no);   /** Ver 1.6 Run Number Added **/
         }
         else
         {
           i_returncode =  fn_do_bft ( c_ServiceName,
                                      c_err_msg,
                                      c_cln_mtch_accnt,
                                      c_bnk_accnt,
                                      c_tag,
                                      d_new_bft,
                                      li_run_no);  /** Ver 1.6 Run Number Added **/ 
         }
					if ( i_returncode == -1 )
					{
    				fn_errlog(c_ServiceName, "S31110",LIBMSG,c_err_msg);
						/*** Insert into Failure table ***/
						i_ret_val = fn_ins_flr_tbl(	c_ServiceName,
																				c_xchng_cd,
																				c_cln_mtch_accnt,
																				li_run_no,
																				c_run_dt,
																			  c_bnk_accnt,
																				BLOCK,
																			  BFT_ON_PAYOUT,
																				CREDIT, /* ignore */
																				d_new_bft,
																				UPDATED,							/*1.1:changed to sucess*/
																				NOT_UPDATED ,
																				NOT_UPDATED,					/* Three more added by 1.1*/
																				c_reference,
																				c_timestamp,
                                        c_bnk_narration,        /*** Ver 1.4 bnk_narration added ***/ 
                                        c_blk_deposit_flg);     /**** Ver 2.2 *****/ 
           	if ( i_ret_val != 0 )
						{
     					strcpy ( c_msg, "System error. Contact system support" );
  						fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
							i_rc 	=	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	
						    			                        c_xchng_cd, 
							    		                        c_cln_mtch_accnt, 
								    	                        c_run_dt, 
                                              d_payout_amt,
                                              d_blk4trd_amt,
                                              d_payin_amt,
                                              d_intadj_amt,
                                              d_bnk_pipo_amt,
                                              d_eba_pipo_amt,
                                              d_bnk_bft_amt,
                                              d_eba_bft_amt,
									                            li_run_no,
                                              c_bnk_narration,       /*** Ver 1.4 bnk_narration added ***/
                                              c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                              c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                              c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                              c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                              c_blk_deposit_flg); /*** Ver 2.2 **/

							if ( i_rc != 0 )
							{
    						fn_errlog(c_ServiceName, "S31115",LIBMSG,c_err_msg);
      					strcpy( c_msg, "System error. Contact system support" );
  							fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    						tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
							}
    					tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
						}
					} 
					d_eba_bft_amt = d_new_bft;
         		   
         } /* d_new_bft > 0 */

        } /* End for block  model payout */

     } /* Bank Payout to be processed */

  } /* d_pipo_amt >= 0  Payout Process */ /*else removed*/
	if ( d_pipo_amt  < 0  || d_dr_tds_amt < 0 )  /* Payin Process */ /*Ver 1.2 add */
  {

    if(c_blk_deposit_flg=='D' )
    {
     sprintf(c_seg_prdct_cd,"%s%s",c_xchng_cd,"ID");
    }
    else
    {
     sprintf(c_seg_prdct_cd,"%s%s",c_xchng_cd,"I");
    }

    rtrim(c_seg_prdct_cd);
    fn_userlog(c_ServiceName,"c_seg_prdct_cd :%s:",c_seg_prdct_cd);

		fn_userlog(c_ServiceName,"Payin Process");
		fn_userlog(c_ServiceName,"TDS [%lf]",d_dr_tds_amt);
		fn_userlog(c_ServiceName,"PIPO [%lf]",d_pipo_amt);

		if (d_pipo_amt > 0 )
		{
			fn_userlog(c_ServiceName,"In SN1 [%lf]",d_pipo_amt);
			d_pipo_amt = d_dr_tds_amt;
		}
		else
		{
			fn_userlog(c_ServiceName,"In SN2 [%lf]",d_pipo_amt);
			d_pipo_amt = d_pipo_amt + d_dr_tds_amt;
		}

     if ( d_ia_amt > 0 ) /* Internal adjustment for Payin */ 
     {
				fn_userlog(c_ServiceName,"CR Internal adjustment for Payin %lf",d_ia_amt);

        /**************************************************************/
        /* All pending payout amounts qualify for Internal Adjustment */
        /* when the net is a payin amount                             */
        /**************************************************************/

				i_returncode =  fn_do_ia ( 	c_ServiceName,
               											c_err_msg,
               											c_cln_mtch_accnt,
               											c_xchng_cd,
               											c_run_dt,
               											c_tag,
               											CREDIT,
               											d_ia_amt,
                                    li_run_no, /** Ver 1.6 Run Number Added **/
                                    c_bnk_accnt, /** Ver 2.2 **/ 
                                    c_blk_deposit_flg); 

  			if ( i_returncode != 0 ) 
  			{
    			fn_errlog(c_ServiceName, "S31120",LIBMSG,c_err_msg);
    			tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  			}
     		d_intadj_amt = d_ia_amt;
     } /* d_ia_amt > 0 Internal adjustment for Payin */
     if ( ( d_pipo_amt  * (-1.0) ) < d_min_payin_amt )
     {
      	sprintf ( c_msg,"Payin amount is less than the minimum Payin for :%s:",c_cln_mtch_accnt); 
  			/*fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );*/
    		tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 ); /*1.1:Return when LT min amount*/
     }
     else if ( d_pipo_amt  < 0 ) /* Bank Payin to be processed d_pipo_amt < 0 */
 		 {	

      	/*sprintf( c_msg,"Bank Payin to be performed for :%s:",c_cln_mtch_accnt); 
  			fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );*/

        d_bal_amt = d_pipo_amt ;
        d_amount = 0;
        c_reference[0] = '\0';

       fn_userlog(c_ServiceName," c_blk_deposit_flg is :%c:",c_blk_deposit_flg);


      /*********** Ver 2.2  only for block model ******************************/ 
        
      if ( c_blk_deposit_flg == 'B' )
      {
        if(( d_bft_amt > 0 ) && ( d_bal_amt < 0 )) 
        {
	        d_amount =  fn_mind(d_bft_amt, -1.0 * d_bal_amt );
				 	c_dr_cr_flg = UD ;
         
				 	/******************************************************/
         	/*  Sending Unblock Debit message to Bank             */   
         	/******************************************************/

  			 strcpy( c_timestamp, "01-Jan-1980" );
        	i_ch_val =  fn_send_bnk_msg (	&st_usr_prfl,
         	             					        c_dr_cr_flg,
         		                  					FO_BFT_BLK_CD,
           		                					d_amount,
             		              					BACKOFFICE,
               		            					c_ServiceName,
                 		          					c_err_msg,
                   		        					&d_val_bal,
                     		      					c_reference,
																				c_timestamp,
																				c_bnk_narration,  /*** Ver 1.4 bnk_narration added ***/
                                        c_xchng_cd,     /** Ver 2.0 **/	
																				li_run_no);			/** Added for Ver 2.1 **/


         switch ( i_ch_val )
          {
            case SUCCESS :
              d_bnk_pipo_amt = d_amount * (-1.0);
              i_returncode =  fn_do_db_on_bft ( c_ServiceName,
                                                c_err_msg,
                                                c_cln_mtch_accnt,
                                                c_xchng_cd,
                                                c_run_dt,
                                                c_bnk_accnt,
                                                c_tag,
                                                d_amount,
                                                li_run_no,  /** Ver 1.6 Run Number Added **/
                                                c_reference, /**** Ver 2.2 ****/
                                                c_blk_deposit_flg ); /** Ver 2.2 **/

              if ( i_returncode != 0 )
              {
                fn_errlog(c_ServiceName, "S31125",LIBMSG,c_err_msg);
                /*** Insert into Failure table ***/
                i_ret_val = fn_ins_flr_tbl( c_ServiceName,
                                            c_xchng_cd,
                                            c_cln_mtch_accnt,
                                            li_run_no,
                                            c_run_dt,
                                            c_bnk_accnt,
                                            UNBLOCK_DEBIT,
                                            BFT_DEBIT_ON_PAYIN,
                                            DEBIT, /* ignore */
                                            d_amount,
                                            UPDATED,          /*1.1:bank is successful*/
                                            NOT_UPDATED,
                                            NOT_UPDATED,      /* Three more added by 1.1*/
                                            c_reference,
                                            c_timestamp,
                                            c_bnk_narration,     /*** Ver 1.4 bnk_narration added ***/
                                            c_blk_deposit_flg);  /*** Ver 2.2 *****/ 


                if ( i_ret_val != 0 )
                {
                  strcpy ( c_msg, "System error. Contact system support" );
                  fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                  i_rc  = fn_insrt_pipo_rpt_tbl(  c_ServiceName,
                                                  c_xchng_cd,
                                                  c_cln_mtch_accnt,
                                                  c_run_dt,
                                                  d_payout_amt,
                                                  d_blk4trd_amt,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_bnk_pipo_amt,
                                                  d_eba_pipo_amt,
                                                  d_bnk_bft_amt,
                                                  d_eba_bft_amt,
                                                  li_run_no,
                                                  c_bnk_narration,    /*** Ver 1.4 bnk_narration added ***/
                                                  c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                 c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                  c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                  c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                  c_blk_deposit_flg); /*** Ver 2.2 **/


                  if ( i_rc != 0 )
                  {
                    fn_errlog(c_ServiceName, "S31130",LIBMSG,c_err_msg);
                    strcpy( c_msg, "System error. Contact system support" );
                    fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                  }
                  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                }


           i_rc  = fn_insrt_pipo_rpt_tbl(  c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                d_blk4trd_amt,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_bnk_pipo_amt,
                                                d_eba_pipo_amt,
                                                d_bnk_bft_amt,
                                                d_eba_bft_amt,
                                                li_run_no,
                                                c_bnk_narration,      /*** Ver 1.4 bnk_narration added ***/
                                                c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                c_blk_deposit_flg); /*** Ver 2.2 **/


                if ( i_rc != 0 )
                {
                  fn_errlog(c_ServiceName, "S31135",LIBMSG,c_err_msg);
                  strcpy( c_msg, "System error. Contact system support" );
                  fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                }
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }
              d_eba_pipo_amt = d_amount * (-1.0);

              d_bal_amt = d_bal_amt + d_amount;
              break;

             case GENERAL_FAILURE :
            case INSUF_FUNDS :
              fn_errlog(c_ServiceName, "S31140",LIBMSG,c_err_msg);
              sprintf(c_msg,"Error sending BFT debit message on Pay in to bank for %s",c_cln_mtch_accnt);
              fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
              i_rc  = fn_insrt_pipo_rpt_tbl(  c_ServiceName,
                                              c_xchng_cd,
                                              c_cln_mtch_accnt,
                                              c_run_dt,
                                              d_payout_amt,
                                              d_blk4trd_amt,
                                              d_payin_amt,
                                              d_intadj_amt,
                                              d_bnk_pipo_amt,
                                              d_eba_pipo_amt,
                                              d_bnk_bft_amt,
                                              d_eba_bft_amt,
                                              li_run_no,
                                              c_bnk_narration,    /*** Ver 1.4 bnk_narration added ***/
                                              c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                              c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                              c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                              c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                              c_blk_deposit_flg); /*** Ver 2.2 **/


              if ( i_rc != 0 )
              {
                fn_errlog(c_ServiceName, "S31145",LIBMSG,c_err_msg);
                strcpy( c_msg, "System error. Contact system support" );
                fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }
              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              break;

              case BLOCK_NOT_EXISTING :
              sprintf (c_msg,"Error sending BFT debit message on Pay in to bank for %s",c_cln_mtch_accnt);
              fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
              break;

           case 100 :
            break ;

            case INDERMINATE_FAILURE :
            case RERUN_FAILURE :
            default :
              i_ret_val = fn_ins_flr_tbl( c_ServiceName,
                                          c_xchng_cd,
                                          c_cln_mtch_accnt,
                                          li_run_no,
                                          c_run_dt,
                                          c_bnk_accnt,
                                          UNBLOCK_DEBIT,
                                          BFT_DEBIT_ON_PAYIN,
                                          DEBIT, /* ignore */
                                          d_amount,
                                          NOT_UPDATED,
                                          NOT_UPDATED,
                                          NOT_UPDATED,                /* Three more added by 1.1*/
                                          c_reference,
                                          c_timestamp,
                                          c_bnk_narration,        /*** Ver 1.4 bnk_narration added ***/
                                          c_blk_deposit_flg);    /*** Ver 2.2 ****/

           if ( i_ret_val != 0 )
              {
                strcpy ( c_msg, "System error. Contact system support" );
                fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                i_rc  = fn_insrt_pipo_rpt_tbl(  c_ServiceName,
                                              c_xchng_cd,
                                              c_cln_mtch_accnt,
                                              c_run_dt,
                                              d_payout_amt,
                                              d_blk4trd_amt,
                                              d_payin_amt,
                                              d_intadj_amt,
                                              d_bnk_pipo_amt,
                                              d_eba_pipo_amt,
                                              d_bnk_bft_amt,
                                              d_eba_bft_amt,
                                              li_run_no,
                                              c_bnk_narration,      /*** Ver 1.4 bnk_narration added ***/
                                              c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                              c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                              c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                              c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                              c_blk_deposit_flg); /*** Ver 2.2 **/

                if ( i_rc != 0 )
                {
                fn_errlog(c_ServiceName, "S31150",LIBMSG,c_err_msg);
                strcpy( c_msg, "System error. Contact system support" );
                fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                }
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }


              sprintf(c_msg,"Indet. failure for %s at  BFT debit  on Pay in to bank",c_cln_mtch_accnt);
              fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
              i_rc  = fn_insrt_pipo_rpt_tbl(  c_ServiceName,
                                              c_xchng_cd,
                                              c_cln_mtch_accnt,
                                              c_run_dt,
                                              d_payout_amt,
                                              d_blk4trd_amt,
                                              d_payin_amt,
                                              d_intadj_amt,
                                              d_bnk_pipo_amt,
                                              d_eba_pipo_amt,
                                              d_bnk_bft_amt,
                                              d_eba_bft_amt,
                                              li_run_no,
                                              c_bnk_narration,       /*** Ver 1.4 bnk_narration added ***/
                                              c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                              c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                              c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                              c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                              c_blk_deposit_flg); /*** Ver 2.2 **/

              if ( i_rc != 0 )
              {
                fn_errlog(c_ServiceName, "S31155",LIBMSG,c_err_msg);
                strcpy( c_msg, "System error. Contact system support" );
                fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }
              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              break;

          }/*End of switch */
         }
        }
        if(( d_alctd_amt > 0 ) && ( d_bal_amt < 0 ))
        {
            d_amount =  fn_mind(d_alctd_amt, -1.0 * d_bal_amt );
            c_dr_cr_flg = UD ;

          /********* Ver 2.2 for Block Model ************************/

          if ( c_blk_deposit_flg =='B')
          {
            /******************************************************/
            /*  Sending Unblock Debit message to Bank             */
            /******************************************************/

             strcpy( c_timestamp, "01-Jan-1980" );
            i_ch_val =  fn_send_bnk_msg (&st_usr_prfl,
                                              c_dr_cr_flg,
                                              FO_BLK_CD,
                                              d_amount,
                                              BACKOFFICE,
                                              c_ServiceName,
                                              c_err_msg,
                                              &d_val_bal,
                                              c_reference,
                                              c_timestamp,
                                              c_bnk_narration,     /*** Ver 1.4 bnk_narration added ***/
                                              c_xchng_cd,     /** Ver 2.0 **/
                                              li_run_no);     /** Added for Ver 2.1 **/


          }
          else
          {
            i_ch_val = SUCCESS;     /** Ver 2.2 **/
            MEMSET(c_reference);    /** Ver 2.2 ***/
          }
        
          switch ( i_ch_val )
          {
            case SUCCESS :
            if( c_blk_deposit_flg =='B')  /*** Ver 2.2 Added ***/
            {
             d_bnk_pipo_amt = d_bnk_pipo_amt + ( d_amount * (-1.0) );
            }
            else
            {
             d_bnk_pipo_amt = d_amount * (-1.0);       /** Ver 2.2 **/
             d_allocation_debit = d_bnk_pipo_amt;
             fn_userlog(c_ServiceName,"Amount to be debited from Allocation %lf:",d_allocation_debit);
            }
 
							i_returncode =  fn_do_db_on_alloc ( c_ServiceName,
                      														c_err_msg,
                      														c_cln_mtch_accnt,
                      														c_xchng_cd,
                      														c_run_dt,
                      														c_bnk_accnt,
                      														c_tag,
                      														d_amount,
                                                  li_run_no,  /** Run Number Added **/
                                                  c_reference,  /*** Ver 2.2 ***/
                                                  c_blk_deposit_flg ); /** Ver 2.2 **/


  						if ( i_returncode != 0 ) 
  						{
    						fn_errlog(c_ServiceName, "S31160",LIBMSG,c_err_msg);
	              strcpy ( c_msg, "System error. Contact system support" );
                fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );				


	
               if( c_blk_deposit_flg == 'B')
               { 	
              	/*** Insert into Failure table ***/
								i_ret_val = fn_ins_flr_tbl(	c_ServiceName,
																						c_xchng_cd,
																						c_cln_mtch_accnt,
																						li_run_no,
																						c_run_dt,
																			  		c_bnk_accnt,
																						UNBLOCK_DEBIT,
																			  		ALLOCATION_DEBIT_ON_PAYIN,
																						DEBIT, /* ignore */
																						d_amount,
																						NOT_UPDATED,								/*1.1:changed to success*/
																						NOT_UPDATED, 
																						NOT_UPDATED,								/* Three more added by 1.1*/
																						c_reference,
																						c_timestamp,
                                            c_bnk_narration,     /*** Ver 1.4 bnk_narration added ***/ 
                                            c_blk_deposit_flg);  /*** Ver 2.2 ****/          		

              	if ( i_ret_val != 0 )
								{
     							strcpy ( c_msg, "System error. Contact system support" );
  								fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
									i_rc 	=	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	
						         			                        c_xchng_cd, 
							    	     	                        c_cln_mtch_accnt, 
								    	                            c_run_dt, 
                                                  d_payout_amt,
                                                  d_blk4trd_amt,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_bnk_pipo_amt,
                                                  d_eba_pipo_amt,
                                                  d_bnk_bft_amt,
                                                  d_eba_bft_amt,
									                                li_run_no,
                                                  c_bnk_narration,   /*** Ver 1.4 bnk_narration added ***/
                                                  c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                  c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                  c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                  c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                  c_blk_deposit_flg); /*** Ver 2.2 **/

									if ( i_rc != 0 )
									{
    								fn_errlog(c_ServiceName, "S31165",LIBMSG,c_err_msg);
      							strcpy( c_msg, "System error. Contact system support" );
  									fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    								tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
									}
    							tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
								}
								i_rc 	=	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	
						       			                        c_xchng_cd, 
						    	     	                        c_cln_mtch_accnt, 
							    	                            c_run_dt, 
                                                d_payout_amt,
                                                d_blk4trd_amt,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_bnk_pipo_amt,
                                                d_eba_pipo_amt,
                                                d_bnk_bft_amt,
                                                d_eba_bft_amt,
								                                li_run_no,
                                                c_bnk_narration,    /*** Ver 1.4 bnk_narration added ***/
                                                c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                c_blk_deposit_flg); /*** Ver 2.2 **/

								if ( i_rc != 0 )
								{
    							fn_errlog(c_ServiceName, "S31170",LIBMSG,c_err_msg);
      						strcpy( c_msg, "System error. Contact system support" );
  								fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    							tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
								}
    						tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );  
  						}
              else
              {
                fn_userlog(c_ServiceName," FTR Entry - Error in Debit amount from allocation(Deposit Model) ");  
                
                i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                 c_xchng_cd,
                                                 c_cln_mtch_accnt,
                                                 c_run_dt,
                                                 d_payout_amt,
                                                 0,
                                                 d_payin_amt,
                                                 d_intadj_amt,
                                                 0, /** bank 0 amount **/
                                                 0, /** EBA 0 amount **/
                                                 0,
                                                 0,
                                                 li_run_no,
                                                 c_bnk_narration,
                                                 c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                 c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                 c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                 c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                 c_blk_deposit_flg);  /*** Ver 2.2 **/
   
             
  
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }
              
             }
              d_amount_recovered=d_allocation_debit;
							d_eba_pipo_amt = d_eba_pipo_amt + ( d_amount * (-1.0) );
            	d_bal_amt = d_bal_amt + d_amount;  
							break;

        		case GENERAL_FAILURE :
        		case INSUF_FUNDS :
    					fn_errlog(c_ServiceName, "S31175",LIBMSG,c_err_msg);
							i_rc 	=	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	
						    			                        c_xchng_cd, 
							    		                        c_cln_mtch_accnt, 
								    	                        c_run_dt, 
                                              d_payout_amt,
                                              d_blk4trd_amt,
                                              d_payin_amt,
                                              d_intadj_amt,
                                              d_bnk_pipo_amt,
                                              d_eba_pipo_amt,
                                              d_bnk_bft_amt,
                                              d_eba_bft_amt,
									                            li_run_no,
                                              c_bnk_narration,  /*** Ver 1.4 bnk_narration added ***/
                                              c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                              c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                              c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                              c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                              c_blk_deposit_flg); /*** Ver 2.2 **/

							if ( i_rc != 0 )
							{
    						fn_errlog(c_ServiceName, "S31180",LIBMSG,c_err_msg);
      					strcpy( c_msg, "System error. Contact system support" );
  							fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    						tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
							}
    					tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
							break;

					
						case 100 :
						break ;

        		case BLOCK_NOT_EXISTING :
      				sprintf(c_msg,"Error sending allocation debit on Pay in to bank for %s",c_cln_mtch_accnt); 
  						fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
							break;

        		case INDERMINATE_FAILURE :
        		case RERUN_FAILURE :											/*1.1:added rerun failure*/
						default :

								/*** Insert into Failure table ***/
								i_ret_val = fn_ins_flr_tbl(	c_ServiceName,
																						c_xchng_cd,
																						c_cln_mtch_accnt,
																						li_run_no,
																						c_run_dt,
																						c_bnk_accnt,
																						UNBLOCK_DEBIT,
																						ALLOCATION_DEBIT_ON_PAYIN,
																						DEBIT, /* ignore */
																						d_amount,
																						NOT_UPDATED,
																						NOT_UPDATED,
																						NOT_UPDATED,								/* Three more added by 1.1*/
																						c_reference,
																						c_timestamp,
                                            c_bnk_narration,     /*** Ver 1.4 bnk_narration added ***/
                                            c_blk_deposit_flg); /*** Ver 2.2 **/ 
      
            		if ( i_ret_val != 0 )
								{
      						strcpy ( c_msg, "System error. Contact system support" );
  								fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
									i_rc 	=	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	
						      			                        c_xchng_cd, 
							      		                        c_cln_mtch_accnt, 
								      	                        c_run_dt, 
                                                d_payout_amt,
                                                d_blk4trd_amt,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_bnk_pipo_amt,
                                                d_eba_pipo_amt,
                                                d_bnk_bft_amt,
                                                d_eba_bft_amt,
									                              li_run_no,
                                                c_bnk_narration,    /*** Ver 1.4 bnk_narration added ***/
                                                c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                c_blk_deposit_flg); /*** Ver 2.2 **/

								if ( i_rc != 0 )
								{
    							fn_errlog(c_ServiceName, "S31185",LIBMSG,c_err_msg);
      						strcpy( c_msg, "System error. Contact system support" );
  								fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    							tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
								}
    							tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
								}
      					sprintf(c_msg,"Indet failure for %s in BFT debit on Payin to bank",c_cln_mtch_accnt); 
  							fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
								i_rc 	=	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	
						      			                        c_xchng_cd, 
							      		                        c_cln_mtch_accnt, 
								      	                        c_run_dt, 
                                                d_payout_amt,
                                                d_blk4trd_amt,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_bnk_pipo_amt,
                                                d_eba_pipo_amt,
                                                d_bnk_bft_amt,
                                                d_eba_bft_amt,
									                              li_run_no,
                                                c_bnk_narration,       /*** Ver 1.4 bnk_narration added ***/
                                                c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                c_blk_deposit_flg); /*** Ver 2.2 **/

								if ( i_rc != 0 )
								{
    							fn_errlog(c_ServiceName, "S31190",LIBMSG,c_err_msg);
      						strcpy( c_msg, "System error. Contact system support" );
  								fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    							tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
								}
    						tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
								break;
						}/*End of switch*/
        }
				if( d_bal_amt < 0 ) 
        {

	          d_amount =  -1.0 * d_bal_amt ;
					 	c_dr_cr_flg = DB ;
      			 strcpy( c_timestamp, "01-Jan-1980" );
           
            /************************* Ver 2.2 Starts here ***********************************************/
 
           if( c_blk_deposit_flg =='D')   /*** Ver 2.2 ****/
           {
             if(DEBUG_MSG_LVL_3)
             {
              fn_userlog(c_ServiceName,"Inside wallet check");
              fn_userlog(c_ServiceName,"Excess Amount required :%lf:",d_amount);
              fn_userlog(c_ServiceName,"Amount recovered upt Allocation :%lf:",d_amount_recovered); 
             }

            /**********************************************************************************************/
            /* Logic to DEBIT Amount                                                                      */
            /* Check Wallet Amount : If (wallet amt) > d_amount : Debit d_amount from Wallet              */
            /*                       If (wallet amt) > 0 and wallet amt < d_amount : Debit Wallet Amount  */
            /*                          and (remng amt) = ( wallet amt ) - d_amount : Debit From Bank     */
            /*                       If (wallet amt) < 0 : Debit from Bank                                */
            /**********************************************************************************************/ 


            
            /********* Begin Transaction **********/
            i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

            if ( i_trnsctn == -1 )
            {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog(c_ServiceName, "S31195",LIBMSG,c_err_msg);
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );

              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                                );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31200",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
            }


            /********** Lock User ***********/
            i_returncode = fn_lock_usr( c_ServiceName, c_cln_mtch_accnt );

            if ( i_returncode == -1 )
            {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog(c_ServiceName, "S31205",LIBMSG,c_err_msg);
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );

              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                                );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31210",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
            }

            /** Ver 2.7 Starts here ***/
            i_returncode = fn_lock_fno( c_ServiceName, c_cln_mtch_accnt );

            if ( i_returncode == -1 )
            {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog(c_ServiceName, "S31215",LIBMSG,c_err_msg);
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );

              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                                );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31220",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
            }
            /** Ver 2.7 Ends Here ***/

            EXEC SQL
            SELECT NVL(CLM_WALLET_AMT*100,0)
            INTO  :d_wallet_amt
            FROM  CLM_CLNT_MSTR
            WHERE CLM_MTCH_ACCNT = :c_cln_mtch_accnt;

            if( SQLCODE != 0 )
            {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog( c_ServiceName , "S31225", TPMSG, c_err_msg);
              Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);

              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                                );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31230",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }
 
              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
            }

            fn_userlog( c_ServiceName,"Wallet Amount is |%lf|",d_wallet_amt );

            if( d_wallet_amt >= d_amount )
            {
              if(DEBUG_MSG_LVL_3)
              {
               fn_userlog(c_ServiceName,"Inside wallet amount greater than amount to be debited ");
              }

              /********* Decreament Wallet *****************/
              c_txn_typ = ALLOCATE_TO_SEGMENT;

              i_returncode = fn_call_inc_dec_svc( d_amount, c_txn_typ,&d_avlbl_amt,li_run_no,c_run_dt  );

              if( i_returncode != 0 )
              {
                fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                fn_errlog( c_ServiceName , "S31235", TPMSG, c_err_msg);
                Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);
 
                i_rc  = fn_insrt_pipo_rpt_tbl(  c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                                );

               if ( i_rc != 0 )
               {
                fn_errlog(c_ServiceName, "S31240",LIBMSG,c_err_msg);
                strcpy( c_msg, "System error. Contact system support" );
                fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
               }
              
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0); 
             } 

              if(DEBUG_MSG_LVL_3)
              {
               fn_userlog(c_ServiceName,"Before calling fn to increase allocation amount ");
              }

              /*** To increase allocation amount ****/
              i_returncode = fn_updt_allctn_dtls ( c_ServiceName,
                                                   c_err_msg,
                                                   c_cln_mtch_accnt,
                                                   c_bnk_accnt,
                                                   c_ServiceName,
                                                   d_amount,
                                                   &d_tot_alc_amt);

              if( i_returncode != 0 )
              {
                fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                fn_errlog( c_ServiceName , "S31245", TPMSG, c_err_msg);
                Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);

               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                               );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31250",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              } 



                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
             } 

             i_returncode = fn_ins_seg_log( "system",
                                              0,
                                              c_ServiceName,
                                              c_cln_mtch_accnt,
                                              d_amount*0.01,
                                              'A', /**** To increase allocation **/
                                              c_sgmnt_cd,
                                              d_tot_alc_amt*0.01,
                                              'A',
                                              "SYS",
                                              "Allocation towards ISEC obligation",
                                              li_run_no,
                                              "ALLOC",
                                              "WALLET");
 
             if ( i_returncode != 0 )
             {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog(c_ServiceName, "S31255",LIBMSG,c_err_msg);
              strcpy ( c_msg, "System error. Contact system support" );
              fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );

              
               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                               );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31260",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }


              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
             }
 
             fn_userlog(c_ServiceName,"Allocation amount increased");
             fn_userlog(c_ServiceName,"FAB Allocated by Amount |%lf|", d_amount );
             fn_userlog(c_ServiceName,"Total FAB Allocated Amount |%lf|", d_tot_alc_amt );

              /************** Reduce Allocation **************/

              fn_userlog(c_ServiceName,"Before calling fn to debit amount from allocation ");
              i_returncode = fn_updt_allctn_dtls ( c_ServiceName,
                                                   c_err_msg,
                                                   c_cln_mtch_accnt,
                                                   c_bnk_accnt,
                                                   c_ServiceName,
                                                   d_amount * -1.0,
                                                   &d_tot_alc_amt);


              if( i_returncode != 0 )
              {
                fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                fn_errlog( c_ServiceName , "S31265", TPMSG, c_err_msg);
                Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);

               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                                );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31270",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }
          

                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
              }

              MEMSET(c_seg_narr);
              sprintf(c_seg_narr,"NFO PI %s",c_run_dt);
              rtrim(c_seg_narr); 

              i_returncode = fn_ins_seg_log( "system",
                                              0,
                                              c_ServiceName,
                                              c_cln_mtch_accnt,
                                              d_amount*0.01,
                                              'I', /**** To reduce  allocation **/
                                              c_sgmnt_cd,
                                              d_tot_alc_amt*0.01,
                                              'N',
                                              "SYS",  /**** Channel **/
                                              c_seg_narr,
                                              li_run_no,
                                              "DEALLOC",
                                              "WALLET");

 
             if ( i_returncode != 0 )
             {
               fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
               fn_errlog(c_ServiceName, "S31275",LIBMSG,c_err_msg);
               strcpy ( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
             
               
              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                               );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31280",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              } 

 
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
             }
         
             if(DEBUG_MSG_LVL_3)
             {
              fn_userlog(c_ServiceName,"Amount debited from allocation successfully ");
              fn_userlog(c_ServiceName,"FAB Allocated by Amount |%lf|", d_amount );
              fn_userlog(c_ServiceName,"Total FAB Allocated Amount |%lf|", d_tot_alc_amt );             
             }

             EXEC SQL
             SELECT to_char(sysdate,'DDMONYYYY')||LPAD(piposeq.nextval,6,0)
             INTO : c_refrnce
             FROM   DUAL;

             if ( SQLCODE != 0 )
             {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog(c_ServiceName, "L31230",SQLMSG,c_err_msg);
              strcpy ( c_msg, "System error. Contact system support" );
              fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );

               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                 c_blk_deposit_flg
                                                );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31285",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }
 

              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
             }
            
             if(DEBUG_MSG_LVL_3)
             { 
              fn_userlog(c_ServiceName,"Reference no for Pass class :%s:",c_refrnce);
              fn_userlog(c_ServiceName,"before calling fn_pass class entry ");           
             }

             i_returncode = fn_pass_cls_entry (  c_ServiceName,
                                                  c_err_msg,
                                                  c_cln_mtch_accnt,
                                                  c_xchng_cd,
                                                  c_run_dt,
                                                  c_tag,
                                                  DEBIT,
                                                  d_amount,
                                                  PAYIN_PAYOUT,
                                                  c_refrnce ,
                                                  li_run_no,
                                                  'W',
                                                   c_bnk_accnt,
                                                  "",
                                                   c_blk_deposit_flg);
 

             if ( i_returncode != 0 )
             {
              fn_errlog( c_ServiceName, "L31250",LIBMSG,c_err_msg);
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              strcpy ( c_msg, "System error. Contact system support" );
              fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );

               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                 c_blk_deposit_flg
                                                );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31290",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
             }
              
             if(DEBUG_MSG_LVL_3)
             {
              fn_userlog(c_ServiceName,"After calling fn_pass_cls_entry");
             }

             if( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
             {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog( c_ServiceName , "S31295", TPMSG, c_err_msg);
              Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);

              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                               c_xchng_cd,
                                               c_cln_mtch_accnt,
                                               c_run_dt,
                                               d_payout_amt,
                                               0,
                                               d_payin_amt,
                                               d_intadj_amt,
                                               d_amount_recovered,
                                               d_amount_recovered,
                                               0,
                                               0,
                                               li_run_no,
                                               c_bnk_narration,
                                               c_payin_pool_acc_nse,
                                               c_payout_pool_acc_nse,
                                               c_payin_pool_acc_bse,
                                               c_payout_pool_acc_bse,
                                               c_blk_deposit_flg);

            if ( i_rc != 0 )
            {
             fn_errlog(c_ServiceName, "S31300",LIBMSG,c_err_msg);
             strcpy( c_msg, "System error. Contact system support" );
             fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
             tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
            }

              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
            }


              d_amount_recovered=d_amount_recovered +( d_amount*-1);
             
             if(DEBUG_MSG_LVL_3)
             {
              fn_userlog(c_ServiceName,"Amount recovered upto wallet is :%lf:",d_amount_recovered);
             }
          
           }
           else if( d_wallet_amt > 0 && d_wallet_amt < d_amount )
           {
              if(DEBUG_MSG_LVL_3)
              {
               fn_userlog(c_ServiceName,"Inside wallet amount is less than debit amount");
              }

              /********* First Decrement Wallet ***********/
              c_txn_typ = ALLOCATE_TO_SEGMENT;
  
               i_returncode = fn_call_inc_dec_svc( d_wallet_amt, c_txn_typ,&d_avlbl_amt,li_run_no,c_run_dt );

              if( i_returncode != 0 )
              {
                fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                fn_errlog( c_ServiceName , "S31305", TPMSG, c_err_msg);
                Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);
                  
               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                                );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31310",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              } 

                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
              }
 
              if(DEBUG_MSG_LVL_3)
              {
               fn_userlog(c_ServiceName,"Wallet Decrement Successful");
               fn_userlog(c_ServiceName,"Before calling fn to increase Allocation amount");
              }
 
              /*** To increase allocation amount ****/
              i_returncode = fn_updt_allctn_dtls ( c_ServiceName,
                                                   c_err_msg,
                                                   c_cln_mtch_accnt,
                                                   c_bnk_accnt,
                                                   c_ServiceName,
                                                   d_wallet_amt,
                                                   &d_tot_alc_amt);
              if( i_returncode != 0 )
              {
                fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                fn_errlog( c_ServiceName , "S31315", TPMSG, c_err_msg);
                Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);

                i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                                );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31320",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }


                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
              }

              
              i_returncode = fn_ins_seg_log( "system",
                                              0,
                                              c_ServiceName,
                                              c_cln_mtch_accnt,
                                              d_wallet_amt*0.01,
                                              'A', /**** To increase allocation **/
                                              c_sgmnt_cd,
                                              d_tot_alc_amt*0.01,
                                              'N',
                                              "SYS",  /**** Channel **/
                                              "Allocation towards ISEC obligation",
                                              li_run_no,
                                              "ALLOC",
                                              "WALLET");

              if ( i_returncode != 0 )
              {
               fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
               fn_errlog(c_ServiceName, "S31325",LIBMSG,c_err_msg);
               strcpy ( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );

               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                               );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31330",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }


                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              if(DEBUG_MSG_LVL_3)
              {
               fn_userlog(c_ServiceName,"Amount increased in Allocation");
               fn_userlog(c_ServiceName,"FAB Allocated by Amount |%lf|", d_wallet_amt );
               fn_userlog(c_ServiceName,"Total FAB Allocated Amount |%lf|", d_tot_alc_amt );
              }

              if(DEBUG_MSG_LVL_3)
              { 
               fn_userlog(c_ServiceName,"Before calling fn to debit amount from allocation");
              }
                 /*** To reduce allocation amount ****/
           
               i_returncode = fn_updt_allctn_dtls ( c_ServiceName,
                                                   c_err_msg,
                                                   c_cln_mtch_accnt,
                                                   c_bnk_accnt,
                                                   c_ServiceName,
                                                   d_wallet_amt * -1.0,
                                                   &d_tot_alc_amt);
              if( i_returncode != 0 )
              {
                fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                fn_errlog( c_ServiceName , "S31335", TPMSG, c_err_msg);
                Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);

                i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                                );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31340",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
              }

              MEMSET(c_seg_narr);
              sprintf(c_seg_narr,"NFO PI %s",c_run_dt);
              rtrim(c_seg_narr);

              i_returncode = fn_ins_seg_log( "system",
                                              0,
                                              c_ServiceName,
                                              c_cln_mtch_accnt,
                                              d_wallet_amt*0.01,
                                              'I', /**** To  reduce  allocation **/
                                              c_sgmnt_cd,
                                              d_tot_alc_amt*0.01,
                                              'N',
                                              "SYS",  /**** Channel **/
                                              c_seg_narr,
                                              li_run_no,
                                              "DEALLOC",
                                              "WALLET");

              if ( i_returncode != 0 )
              {
               fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
               fn_errlog(c_ServiceName, "S31345",LIBMSG,c_err_msg);
               strcpy ( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
  
               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                               );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31350",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }               
 
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

             if(DEBUG_MSG_LVL_3)
             {
              fn_userlog(c_ServiceName,"Amount debited from allocation successfully");
             }

              EXEC SQL
              SELECT to_char(sysdate,'DDMONYYYY')||LPAD(piposeq.nextval,6,0)
              INTO :c_refrnce
              FROM   DUAL;

              if ( SQLCODE != 0 )
              {
               fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
               fn_errlog(c_ServiceName, "L31230",SQLMSG,c_err_msg);
               strcpy ( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );

                i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                                );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31355",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
              }
             
              if(DEBUG_MSG_LVL_3)
              {   
               fn_userlog(c_ServiceName,"Reference no for Pass class :%s:",c_refrnce);
              }

              i_returncode = fn_pass_cls_entry (  c_ServiceName,
                                                  c_err_msg,
                                                  c_cln_mtch_accnt,
                                                  c_xchng_cd,
                                                  c_run_dt,
                                                  c_tag,
                                                  DEBIT,
                                                  d_wallet_amt,
                                                  PAYIN_PAYOUT,
                                                  c_refrnce ,
                                                  li_run_no,
                                                  'W',
                                                   c_bnk_accnt,
                                                   "",
                                                   c_blk_deposit_flg);

             if ( i_returncode != 0 )
             {
              fn_errlog( c_ServiceName, "L31250",LIBMSG,c_err_msg);
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              strcpy ( c_msg, "System error. Contact system support" );
              fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );

              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                                );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31360",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }


              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
             }
           
             if(DEBUG_MSG_LVL_3)
             {
              fn_userlog(c_ServiceName,"FAB Allocated by Amount |%lf|", d_wallet_amt );
              fn_userlog(c_ServiceName,"Total FAB Allocated Amount |%lf|", d_tot_alc_amt );
             }

             if( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
             {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog( c_ServiceName , "S31365", TPMSG, c_err_msg);
              Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);
              
              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                  c_xchng_cd,
                                                  c_cln_mtch_accnt,
                                                  c_run_dt,
                                                  d_payout_amt,
                                                  0,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_amount_recovered,
                                                  d_amount_recovered,
                                                  0,
                                                  0,
                                                  li_run_no,
                                                  c_bnk_narration,
                                                  c_payin_pool_acc_nse,
                                                  c_payout_pool_acc_nse,
                                                  c_payin_pool_acc_bse,
                                                  c_payout_pool_acc_bse,
                                                  c_blk_deposit_flg
                                                  );

                  if ( i_rc != 0 )
                  {
                   fn_errlog(c_ServiceName, "S31370",LIBMSG,c_err_msg);
                   strcpy( c_msg, "System error. Contact system support" );
                   fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                  }
              
              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
             }

             d_amount_recovered=d_amount_recovered+(d_wallet_amt*-1); 
             
  
             if(DEBUG_MSG_LVL_3)
             {
              fn_userlog(c_ServiceName,"----Amount recovered upto wallet----:%lf:",d_amount_recovered);
             }

             /********* Bring excess amount required from Bank ************/
          
          if ( strcmp(c_bnk_accnt,DUMMY_BNK_ACCNT)!=0 && c_hsbc_payin_flg !='Y')   /**** Bank hit only for linked bank account **/ /** ver 2.8**/
          {

             i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

             if ( i_trnsctn == -1 )
             {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog(c_ServiceName, "S31375",LIBMSG,c_err_msg);
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );

               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                                );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31380",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
             }

             /********** Lock User ***********/
            i_returncode = fn_lock_usr( c_ServiceName, c_cln_mtch_accnt );


            if ( i_returncode == -1 )
            {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog(c_ServiceName, "S31385",LIBMSG,c_err_msg);
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
         
              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                                );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31390",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
            }
           
            /*** Ver 2.7 Starts here ***/
            i_returncode = fn_lock_fno( c_ServiceName, c_cln_mtch_accnt );
            if ( i_returncode == -1 )
            {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog(c_ServiceName, "S31395",LIBMSG,c_err_msg);
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );

              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                                );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31400",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
            } 
            /*** Ver 2.7 Ends here ****/

            d_rmng_pipo_amt =  d_amount - d_wallet_amt ;

            if(DEBUG_MSG_LVL_3)
            {
             fn_userlog(c_ServiceName,"Remaining amount to be brought from the bank :%lf:",d_rmng_pipo_amt);
            }

            c_txn_typ = CLEAR_BAL_TO_SGMNT_ALLOCATE;

            MEMSET(c_trace);
            MEMSET(c_refrnce);

            	i_returncode =  fn_call_inc_dec_svc( d_rmng_pipo_amt , c_txn_typ,&d_avlbl_amt,li_run_no,c_run_dt  );
            
              if( i_returncode != 0 )
              {
                fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                fn_errlog( c_ServiceName , "S31405", TPMSG, c_err_msg);
                Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);


              if(l_tpurcode == 911 ||
                 l_tpurcode == -99 ||
                 l_tpurcode == -98 ||
                 l_tpurcode == -2  ||
                 l_tpurcode == 115 ||
                 l_tpurcode == 907 ||
                 l_tpurcode == -1  
                )
              {
                i_ret_val = fn_ins_flr_tbl( c_ServiceName,
                                            c_xchng_cd,
                                            c_cln_mtch_accnt,
                                            li_run_no,
                                            c_run_dt,
                                            c_bnk_accnt,
                                            DEBIT,
                                            CLEAR_BALANCE_DEBIT_ON_PAYIN,
                                            DEBIT,
                                            d_rmng_pipo_amt,
                                            NOT_UPDATED,
                                            NOT_UPDATED,
                                            NOT_UPDATED,
                                            c_trace,
                                            c_tmstamp,
                                            c_bnk_narration,
                                            c_blk_deposit_flg);
         
              if ( i_ret_val != 0 )
              {
               strcpy( c_msg, "System error. Contact system support" );

               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                     c_xchng_cd,
                                                     c_cln_mtch_accnt,
                                                     c_run_dt,
                                                     d_payout_amt,
                                                     0,
                                                     d_payin_amt,
                                                     d_intadj_amt,
                                                     d_amount_recovered,
                                                     d_amount_recovered,
                                                     0,
                                                     0,
                                                     li_run_no,
                                                     c_bnk_narration,
                                                     c_payin_pool_acc_nse,
                                                     c_payout_pool_acc_nse,
                                                     c_payin_pool_acc_bse,
                                                     c_payout_pool_acc_bse,
                                                     c_blk_deposit_flg
                                                     );

                    if ( i_rc != 0 )
                    {
                     fn_errlog(c_ServiceName, "S31410",LIBMSG,c_err_msg);
                     strcpy( c_msg, "System error. Contact system support" );
                     fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                    }

              }
  
              strcpy( c_msg, "System error. Contact system support" );

              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                  c_xchng_cd,
                                                  c_cln_mtch_accnt,
                                                  c_run_dt,
                                                  d_payout_amt,
                                                  0,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_amount_recovered,
                                                  d_amount_recovered,
                                                  0,
                                                  0,
                                                  li_run_no,
                                                  c_bnk_narration,
                                                  c_payin_pool_acc_nse,
                                                  c_payout_pool_acc_nse,
                                                  c_payin_pool_acc_bse,
                                                  c_payout_pool_acc_bse,
                                                  c_blk_deposit_flg
                                                   );

               if ( i_rc != 0 )
               {
                fn_errlog(c_ServiceName, "S31415",LIBMSG,c_err_msg);
                strcpy( c_msg, "System error. Contact system support" );
                fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
               }


              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0); 
 
           }
           else if( l_tpurcode == 116 && d_avlbl_amt > 0 )
           {

             i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

             if ( i_trnsctn == -1 )
             {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog(c_ServiceName, "S31420",LIBMSG,c_err_msg);
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );         
               
              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                               c_xchng_cd,
                                               c_cln_mtch_accnt,
                                               c_run_dt,
                                               d_payout_amt,
                                               0,
                                               d_payin_amt,
                                               d_intadj_amt,
                                               d_amount_recovered,
                                               d_amount_recovered,
                                               0,
                                               0,
                                               li_run_no,
                                               c_bnk_narration,
                                               c_payin_pool_acc_nse,
                                               c_payout_pool_acc_nse,
                                               c_payin_pool_acc_bse,
                                               c_payout_pool_acc_bse,
                                               c_blk_deposit_flg
                                               );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31425",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
             }


             i_returncode = fn_lock_usr( c_ServiceName, c_cln_mtch_accnt );

             if ( i_returncode == -1 )
             {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog(c_ServiceName, "S31430",LIBMSG,c_err_msg);
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );

              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                   c_xchng_cd,
                                                   c_cln_mtch_accnt,
                                                   c_run_dt,
                                                   d_payout_amt,
                                                   0,
                                                   d_payin_amt,
                                                   d_intadj_amt,
                                                   d_amount_recovered,
                                                   d_amount_recovered,
                                                   0,
                                                   0,
                                                   li_run_no,
                                                   c_bnk_narration,
                                                   c_payin_pool_acc_nse,
                                                   c_payout_pool_acc_nse,
                                                   c_payin_pool_acc_bse,
                                                   c_payout_pool_acc_bse,
                                                   c_blk_deposit_flg
                                                  );

                if ( i_rc != 0 )
                {
                 fn_errlog(c_ServiceName, "S31435",LIBMSG,c_err_msg);
                 strcpy( c_msg, "System error. Contact system support" );
                 fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                 tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                }

                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
             }

             /** Ver 2.7 Starts here **/
              i_returncode = fn_lock_fno( c_ServiceName, c_cln_mtch_accnt );
             if ( i_returncode == -1 )
             {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog(c_ServiceName, "S31440",LIBMSG,c_err_msg);
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );

              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                   c_xchng_cd,
                                                   c_cln_mtch_accnt,
                                                   c_run_dt,
                                                   d_payout_amt,
                                                   0,
                                                   d_payin_amt,
                                                   d_intadj_amt,
                                                   d_amount_recovered,
                                                   d_amount_recovered,
                                                   0,
                                                   0,
                                                   li_run_no,
                                                   c_bnk_narration,
                                                   c_payin_pool_acc_nse,
                                                   c_payout_pool_acc_nse,
                                                   c_payin_pool_acc_bse,
                                                   c_payout_pool_acc_bse,
                                                   c_blk_deposit_flg
                                                  );

                if ( i_rc != 0 )
                {
                 fn_errlog(c_ServiceName, "S31445",LIBMSG,c_err_msg);
                 strcpy( c_msg, "System error. Contact system support" );
                 fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                 tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                }

                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
             } 
             /** Ver 2.7 Ends Here **/   


                i_returncode =  fn_call_inc_dec_svc( d_avlbl_amt*100 , c_txn_typ ,&d_avlbl_amt,li_run_no,c_run_dt );

                if( i_returncode != 0 )
                {
                  fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                  fn_errlog( c_ServiceName , "S31450", TPMSG, c_err_msg);
                  Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);

                 if(l_tpurcode == 911 ||
                    l_tpurcode == -99 ||
                    l_tpurcode == -98 ||
                    l_tpurcode == -2  ||
                    l_tpurcode == 115 ||
                    l_tpurcode == 907 ||
                    l_tpurcode == -1)
                  {
                   i_ret_val = fn_ins_flr_tbl( c_ServiceName,
                                                 c_xchng_cd,
                                                 c_cln_mtch_accnt,
                                                 li_run_no,
                                                 c_run_dt,
                                                 c_bnk_accnt,
                                                 DEBIT,
                                                 CLEAR_BALANCE_DEBIT_ON_PAYIN,
                                                 DEBIT,
                                                 d_avlbl_amt*100,
                                                 NOT_UPDATED,
                                                 NOT_UPDATED,
                                                 NOT_UPDATED,
                                                 c_trace,
                                                 c_tmstamp,
                                                 c_bnk_narration,
                                                 c_blk_deposit_flg); 

                   if ( i_ret_val != 0 )
                   {
                    strcpy( c_msg, "System error. Contact system support" );
                      
                    i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                     c_xchng_cd,
                                                     c_cln_mtch_accnt,
                                                     c_run_dt,
                                                     d_payout_amt,
                                                     0,
                                                     d_payin_amt,
                                                     d_intadj_amt,
                                                     d_amount_recovered,
                                                     d_amount_recovered,
                                                     0,
                                                     0,
                                                     li_run_no,
                                                     c_bnk_narration,
                                                     c_payin_pool_acc_nse,
                                                     c_payout_pool_acc_nse,
                                                     c_payin_pool_acc_bse,
                                                     c_payout_pool_acc_bse,
                                                     c_blk_deposit_flg
                                                     );

                    if ( i_rc != 0 )
                    {
                     fn_errlog(c_ServiceName, "S31455",LIBMSG,c_err_msg);
                     strcpy( c_msg, "System error. Contact system support" );
                     fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                    }

                }

                strcpy( c_msg, "System error. Contact system support" );

                 i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                  c_xchng_cd,
                                                  c_cln_mtch_accnt,
                                                  c_run_dt,
                                                  d_payout_amt,
                                                  0,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_amount_recovered,
                                                  d_amount_recovered,
                                                  0,
                                                  0,
                                                  li_run_no,
                                                  c_bnk_narration,
                                                  c_payin_pool_acc_nse,
                                                  c_payout_pool_acc_nse,
                                                  c_payin_pool_acc_bse,
                                                  c_payout_pool_acc_bse,
                                                  c_blk_deposit_flg
                                                   );

                  if ( i_rc != 0 )
                  {
                   fn_errlog(c_ServiceName, "S31460",LIBMSG,c_err_msg);
                   strcpy( c_msg, "System error. Contact system support" );
                   fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                  }

                 tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
               } 
               else
               {
                 if(DEBUG_MSG_LVL_3)
                 {
                  fn_userlog(c_ServiceName," Inside Insufficient limit/ Non Generic Bank error in second attempt");
                 }
               
                if( l_tpurcode != 116 )  /*** Ignoring FBM Insert in Insuff funds for 2nd attempt **/ 
                { 
                 i_ret_val = fn_ins_flr_tbl( c_ServiceName,
                                             c_xchng_cd,
                                             c_cln_mtch_accnt,
                                             li_run_no,
                                             c_run_dt,
                                             c_bnk_accnt,
                                             DEBIT,
                                             CLEAR_BALANCE_DEBIT_ON_PAYIN,
                                             DEBIT,
                                             d_avlbl_amt*100,
                                             NOT_UPDATED,
                                             NOT_UPDATED,
                                             NOT_UPDATED,
                                             c_trace,
                                             c_tmstamp,
                                             c_bnk_narration,
                                             c_blk_deposit_flg);


               if ( i_ret_val != 0 )
               {
                 strcpy( c_msg, "System error. Contact system support" );

                 i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                  c_xchng_cd,
                                                  c_cln_mtch_accnt,
                                                  c_run_dt,
                                                  d_payout_amt,
                                                  0,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_amount_recovered,
                                                  d_amount_recovered,
                                                  0,
                                                  0,
                                                  li_run_no,
                                                  c_bnk_narration,
                                                  c_payin_pool_acc_nse,
                                                  c_payout_pool_acc_nse,
                                                  c_payin_pool_acc_bse,
                                                  c_payout_pool_acc_bse,
                                                  c_blk_deposit_flg
                                                );

                 if ( i_rc != 0 )
                 {
                  fn_errlog(c_ServiceName, "S31465",LIBMSG,c_err_msg);
                  strcpy( c_msg, "System error. Contact system support" );
                  fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                 }

                }
               } 	 

                 i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                  c_xchng_cd,
                                                  c_cln_mtch_accnt,
                                                  c_run_dt,
                                                  d_payout_amt,
                                                  0,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_amount_recovered,
                                                  d_amount_recovered,
                                                  0,
                                                  0,
                                                  li_run_no,
                                                  c_bnk_narration,
                                                  c_payin_pool_acc_nse,
                                                  c_payout_pool_acc_nse,
                                                  c_payin_pool_acc_bse,
                                                  c_payout_pool_acc_bse,
                                                  c_blk_deposit_flg
                                                   );

                 if ( i_rc != 0 )
                 {
                   fn_errlog(c_ServiceName, "S31470",LIBMSG,c_err_msg);
                   strcpy( c_msg, "System error. Contact system support" );
                   fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                 }
            

                 tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
               }
              
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
              }
              else
              {
                if(DEBUG_MSG_LVL_3)
                {
                 fn_userlog(c_ServiceName,"Service called succesfully for available amount in bank");
                }

                d_rmng_pipo_amt=d_avlbl_amt*100;
              }

            }
            else
            {
              if(DEBUG_MSG_LVL_3)
              {
               fn_userlog(c_ServiceName,"Inside Non Generic Bank error");
              }
 
             if( l_tpurcode != 116 )  /**** Ignoring FBM Insert in Insuff case for 2nd attemp ***/          
             {
              if(DEBUG_MSG_LVL_3)
              {
               fn_userlog(c_ServiceName,"Inside FBM insert");
              }                                 
              
              i_ret_val = fn_ins_flr_tbl( c_ServiceName,
                                          c_xchng_cd,
                                          c_cln_mtch_accnt,
                                          li_run_no,
                                          c_run_dt,
                                          c_bnk_accnt,
                                          DEBIT,
                                          CLEAR_BALANCE_DEBIT_ON_PAYIN,
                                          DEBIT,
                                          d_rmng_pipo_amt,
                                          NOT_UPDATED,
                                          NOT_UPDATED,
                                          NOT_UPDATED,
                                          c_trace,
                                          c_tmstamp,
                                          c_bnk_narration,
                                          c_blk_deposit_flg);



              if ( i_ret_val != 0 )
              {
               strcpy( c_msg, "System error. Contact system support" );

               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                     c_xchng_cd,
                                                     c_cln_mtch_accnt,
                                                     c_run_dt,
                                                     d_payout_amt,
                                                     0,
                                                     d_payin_amt,
                                                     d_intadj_amt,
                                                     d_amount_recovered,
                                                     d_amount_recovered,
                                                     0,
                                                     0,
                                                     li_run_no,
                                                     c_bnk_narration,
                                                     c_payin_pool_acc_nse,
                                                     c_payout_pool_acc_nse,
                                                     c_payin_pool_acc_bse,
                                                     c_payout_pool_acc_bse,
                                                     c_blk_deposit_flg
                                                     );

                    if ( i_rc != 0 )
                    {
                     fn_errlog(c_ServiceName, "S31475",LIBMSG,c_err_msg);
                     strcpy( c_msg, "System error. Contact system support" );
                     fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                    }

              }
             }
          

              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                  c_xchng_cd,
                                                  c_cln_mtch_accnt,
                                                  c_run_dt,
                                                  d_payout_amt,
                                                  0,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_amount_recovered,
                                                  d_amount_recovered,
                                                  0,
                                                  0,
                                                  li_run_no,
                                                  c_bnk_narration,
                                                  c_payin_pool_acc_nse,
                                                  c_payout_pool_acc_nse,
                                                  c_payin_pool_acc_bse,
                                                  c_payout_pool_acc_bse,
                                                  c_blk_deposit_flg
                                                   );

               if ( i_rc != 0 )
               {
                fn_errlog(c_ServiceName, "S31480",LIBMSG,c_err_msg);
                strcpy( c_msg, "System error. Contact system support" );
                fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
               }
            
              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0); 
            }
                     
          }

          fn_userlog(c_ServiceName,"Payin to segment service Successfull");

           /*** To increase allocation amount ****/

             i_returncode = fn_updt_allctn_dtls ( c_ServiceName,
                                                   c_err_msg,
                                                   c_cln_mtch_accnt,
                                                   c_bnk_accnt,
                                                   c_ServiceName,
                                                   d_rmng_pipo_amt,
                                                   &d_tot_alc_amt);
             
              if( i_returncode != 0 )
              {
                fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                fn_errlog( c_ServiceName , "S31485", TPMSG, c_err_msg);
                Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);

                i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                                );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31490",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }
 
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
              }

              i_returncode = fn_ins_seg_log( "system",
                                              0,
                                              c_ServiceName,
                                              c_cln_mtch_accnt,
                                              d_rmng_pipo_amt*0.01,
                                              'A', /**** To increase allocation **/
                                              c_sgmnt_cd,
                                              d_tot_alc_amt*0.01,
                                              'N',
                                              "SYS",  /**** Channel **/
                                              "Allocation towards ISEC obligation",
                                              li_run_no,
                                              "ALLOC",
                                              "CLEAR_BAL");

              if ( i_returncode != 0 )
              {
               fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
               fn_errlog(c_ServiceName, "S31495",LIBMSG,c_err_msg);
               strcpy ( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );

               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                               );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31500",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }
            
              if(DEBUG_MSG_LVL_3)
              {
               fn_userlog(c_ServiceName,"Allocation amount increased");
               fn_userlog(c_ServiceName,"FAB Allocated by Amount |%lf|", d_rmng_pipo_amt );
               fn_userlog(c_ServiceName,"Total FAB Allocated Amount |%lf|", d_tot_alc_amt );
              }

               /*** To reduce allocation amount ****/

              i_returncode = fn_updt_allctn_dtls ( c_ServiceName,
                                                   c_err_msg,
                                                   c_cln_mtch_accnt,
                                                   c_bnk_accnt,
                                                   c_ServiceName,
                                                   d_rmng_pipo_amt * -1.0,
                                                   &d_tot_alc_amt);
              if( i_returncode != 0 )
              {
                fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                fn_errlog( c_ServiceName , "S31505", TPMSG, c_err_msg);
                Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);

                 i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                                );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31510",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }


                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
              }

              
              /*** Added Sachin ****/
              MEMSET(c_seg_narr);
              sprintf(c_seg_narr,"NFO PI %s",c_run_dt);
              rtrim(c_seg_narr);


              i_returncode = fn_ins_seg_log( "system",
                                              0,
                                              c_ServiceName,
                                              c_cln_mtch_accnt,
                                              d_rmng_pipo_amt*0.01,
                                              'I', /**** To  reduce  allocation **/
                                              c_sgmnt_cd,
                                              d_tot_alc_amt*0.01,
                                              'N',
                                              "SYS",  /**** Channel **/
                                              c_seg_narr,
                                              li_run_no,
                                              "DEALLOC",
                                              "CLEAR_BAL");
              if( i_returncode != 0 )
              {
                fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                fn_errlog( c_ServiceName , "S31515", TPMSG, c_err_msg);
                Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);

                 i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                                );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31520",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }


              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
             }
              /*** End here by Sachin ***/

              if(DEBUG_MSG_LVL_3)
              {       
               fn_userlog(c_ServiceName,"Final Debit from allocation");
               fn_userlog(c_ServiceName,"FAB Allocated by Amount |%lf|", d_wallet_amt );
               fn_userlog(c_ServiceName,"Total FAB Allocated Amount |%lf|", d_tot_alc_amt );
              }

              EXEC SQL
              SELECT to_char(sysdate,'DDMONYYYY')||LPAD(piposeq.nextval,6,0)
              INTO : c_refrnce
              FROM   DUAL;

              if ( SQLCODE != 0 )
              {
               fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
               fn_errlog(c_ServiceName, "L31230",SQLMSG,c_err_msg);
               strcpy ( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
              
               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg  );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31525",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }
 
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
              }
 
              if(DEBUG_MSG_LVL_3)
              { 
               fn_userlog(c_ServiceName,"Reference no for Pass class :%s:",c_refrnce);
              }

              i_returncode = fn_pass_cls_entry (  c_ServiceName,
                                                  c_err_msg,
                                                  c_cln_mtch_accnt,
                                                  c_xchng_cd,
                                                  c_run_dt,
                                                  c_tag,
                                                  DEBIT,
                                                  d_rmng_pipo_amt,
                                                  PAYIN_PAYOUT,
                                                  c_refrnce ,
                                                  li_run_no,
                                                  'C',
                                                  c_bnk_accnt,
                                                  c_trace,
                                                  c_blk_deposit_flg);            
 

              if ( i_returncode != 0 )
              {
               fn_errlog( c_ServiceName, "L31250",LIBMSG,c_err_msg);
               fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
               strcpy ( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );  
 
               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg);

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31530",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }
 
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
             }

             if(DEBUG_MSG_LVL_3)
             {
              fn_userlog(c_ServiceName,"======== Testing d_bal_amt============ :%lf:",d_bal_amt);
              fn_userlog(c_ServiceName,"======== Testing d_rmng_pipo_amt =========== :%lf:",d_rmng_pipo_amt);
             }
 
             if( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
             {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog( c_ServiceName , "S31535", TPMSG, c_err_msg);
              Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);

              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                               c_xchng_cd,
                                               c_cln_mtch_accnt,
                                               c_run_dt,
                                               d_payout_amt,
                                               0,
                                               d_payin_amt,
                                               d_intadj_amt,
                                               d_amount_recovered,
                                               d_amount_recovered,
                                               0,
                                               0,
                                               li_run_no,
                                               c_bnk_narration,
                                               c_payin_pool_acc_nse,
                                               c_payout_pool_acc_nse,
                                               c_payin_pool_acc_bse,
                                               c_payout_pool_acc_bse,
                                               c_blk_deposit_flg);

             if ( i_rc != 0 )
             {
              fn_errlog(c_ServiceName, "S31540",LIBMSG,c_err_msg);
              strcpy( c_msg, "System error. Contact system support" );
              fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
             }

             tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
            } 


              d_amount_recovered=d_amount_recovered + (d_rmng_pipo_amt*-1); 
              if(DEBUG_MSG_LVL_3)
              {
               fn_userlog(c_ServiceName,"-------- Amount recovered upto bank :%lf:",d_amount_recovered);
               fn_userlog(c_ServiceName,"Payin Success");
              } 
           }
           else
           { 
             if(DEBUG_MSG_LVL_3)
             {
              fn_userlog(c_ServiceName," As this is non linked bank account Payin Successful upto wallet");
             } 
           }
               
          } 
          else if( d_wallet_amt == 0 && ( strcmp(c_bnk_accnt,DUMMY_BNK_ACCNT)!=0 ))  /*** only for linked bank accounts ****/
          {
            fn_userlog(c_ServiceName,"Inside linked bank account and Wallet Amount 0 case for :%lf:",d_amount);
            d_amount_alloc = d_amount;
            d_eq_freelmt=0;
            /*** Ver 2.6 Starts here ***/

            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );

            fn_eq_free_limit(&d_eq_freelmt);
            d_eq_freelmt = d_eq_freelmt * 100;
            d_amount_alloc= fn_mind(d_amount_alloc,d_eq_freelmt);
           
           fn_userlog(c_ServiceName,"Amount from EQ d_amount_alloc :%lf:",d_amount_alloc); 
           if( d_amount_alloc > 0 )
           {
             
            i_returncode = fn_call_ud_fromeq( d_amount_alloc, 'N',&d_avlbl_amt,li_run_no,c_run_dt );  /* N for Linked bank Acc */
            if( i_returncode == 0 )
            {
              EXEC SQL
    						SELECT FAB_ALCTD_AMT
                  INTO :d_alctd_amt
                  FROM FAB_FO_ALC_BFT_SMRY , CLB_BNK_ACCTS
                 WHERE FAB_CLM_MTCH_ACCNT = :c_cln_mtch_accnt
                   AND CLB_CLM_MTCH_ACCNT = FAB_CLM_MTCH_ACCNT;             
              if ( SQLCODE != 0 )
              {
               fn_errlog(c_ServiceName, "S31545",SQLMSG,c_err_msg);
               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                               c_xchng_cd,
                                               c_cln_mtch_accnt,
                                               c_run_dt,
                                               d_payout_amt,
                                               0,
                                               d_payin_amt,
                                               d_intadj_amt,
                                               d_amount_recovered,
                                               d_amount_recovered,
                                               0,
                                               0,
                                               li_run_no,
                                               c_bnk_narration,
                                               c_payin_pool_acc_nse,
                                               c_payout_pool_acc_nse,
                                               c_payin_pool_acc_bse,
                                               c_payout_pool_acc_bse,
                                               c_blk_deposit_flg);

            if ( i_rc != 0 )
            {
             fn_errlog(c_ServiceName, "S31550",LIBMSG,c_err_msg);
             strcpy( c_msg, "System error. Contact system support" );
             fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
             tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
            } 
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }                
                
               d_amount_alloc = fn_mind(d_amount_alloc,d_alctd_amt);
                 
               i_returncode =  fn_do_db_on_alloc ( c_ServiceName,
                                                  c_err_msg,
                                                  c_cln_mtch_accnt,
                                                  c_xchng_cd,
                                                  c_run_dt,
                                                  c_bnk_accnt,
                                                  c_tag,
                                                  d_amount_alloc,
                                                  li_run_no, 
                                                  c_reference,  
                                                  c_blk_deposit_flg ); 
               if( i_returncode  != 0 )
               {
                fn_userlog(c_ServiceName," FTR Entry - Error in Debit amount from allocation(Deposit Model) ");

                i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                 c_xchng_cd,
                                                 c_cln_mtch_accnt,
                                                 c_run_dt,
                                                 d_payout_amt,
                                                 0,
                                                 d_payin_amt,
                                                 d_intadj_amt,
                                                 d_amount_recovered, /** bank 0 amount **/
                                                 d_amount_recovered, /** EBA 0 amount **/
                                                 0,
                                                 0,
                                                 li_run_no,
                                                 c_bnk_narration,
                                                 c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                 c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                 c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                 c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                 c_blk_deposit_flg);  /*** Ver 2.2 **/



                  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                }

                d_amount = d_amount - d_amount_alloc;  /** Remaining Amount ***/
                fn_userlog(c_ServiceName,"Balance Amount d_amount After getting from EQ:%lf:",d_amount);
                d_amount_recovered=d_amount_recovered + ( d_amount_alloc * -1); 
                if(DEBUG_MSG_LVL_3)
                {
                 fn_userlog(c_ServiceName,"-------- Amount recovered upto eq free :%lf:",d_amount_recovered);
                } 
            }
            else
            {
               fn_userlog(c_ServiceName,"Error from Func Free EQ Limit");                
            }
           }
 
            if( d_amount > 0 && c_hsbc_payin_flg!='Y' )  /** balance after Eq Free Limit ***/  /** Ver 2.8 no bank hit for HSBC **/
            { 
            

             i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );  /** Ver 2.6 Starts here ***/
             if(i_trnsctn == -1 )   
             {
               fn_errlog(c_ServiceName, "S31555",TPMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                               c_xchng_cd,
                                               c_cln_mtch_accnt,
                                               c_run_dt,
                                               d_payout_amt,
                                               0,
                                               d_payin_amt,
                                               d_intadj_amt,
                                               d_amount_recovered,
                                               d_amount_recovered,
                                               0,
                                               0,
                                               li_run_no,
                                               c_bnk_narration,
                                               c_payin_pool_acc_nse,
                                               c_payout_pool_acc_nse,
                                               c_payin_pool_acc_bse,
                                               c_payout_pool_acc_bse,
                                               c_blk_deposit_flg);

            if ( i_rc != 0 )
            {
             fn_errlog(c_ServiceName, "S31560",LIBMSG,c_err_msg);
             strcpy( c_msg, "System error. Contact system support" );
             fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
             tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
            }
             tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
            }
            /********* Increament Wallet and Decreament Wallet **********/
            c_txn_typ = CLEAR_BAL_TO_SGMNT_ALLOCATE;

            MEMSET(c_trace);
 
            i_returncode = fn_call_inc_dec_svc( d_amount, c_txn_typ,&d_avlbl_amt,li_run_no,c_run_dt );

            if( i_returncode != 0 )
            {
             fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
             fn_errlog( c_ServiceName , "S31565", TPMSG, c_err_msg);
             Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);

              if(l_tpurcode == 911 ||
                 l_tpurcode == -99 ||
                 l_tpurcode == -98 ||
                 l_tpurcode == -2  ||
                 l_tpurcode == 115 ||
                 l_tpurcode == 907 ||
                 l_tpurcode == -1  
                )  
              {
                i_ret_val = fn_ins_flr_tbl( c_ServiceName,
                                            c_xchng_cd,
                                            c_cln_mtch_accnt,
                                            li_run_no,
                                            c_run_dt,
                                            c_bnk_accnt,
                                            DEBIT,
                                            CLEAR_BALANCE_DEBIT_ON_PAYIN,
                                            DEBIT,
                                            d_amount,
                                            NOT_UPDATED,
                                            NOT_UPDATED,
                                            NOT_UPDATED,
                                            c_trace,
                                            c_tmstamp,
                                            c_bnk_narration,
                                            c_blk_deposit_flg );

                if ( i_ret_val != 0 )
                {
                  strcpy( c_msg, "System error. Contact system support" );

                  i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                     c_xchng_cd,
                                                     c_cln_mtch_accnt,
                                                     c_run_dt,
                                                     d_payout_amt,
                                                     0,
                                                     d_payin_amt,
                                                     d_intadj_amt,
                                                     d_amount_recovered,
                                                     d_amount_recovered,
                                                     0,
                                                     0,
                                                     li_run_no,
                                                     c_bnk_narration,
                                                     c_payin_pool_acc_nse,
                                                     c_payout_pool_acc_nse,
                                                     c_payin_pool_acc_bse,
                                                     c_payout_pool_acc_bse,
                                                     c_blk_deposit_flg);

                    if ( i_rc != 0 )
                    {
                     fn_errlog(c_ServiceName, "S31570",LIBMSG,c_err_msg);
                     strcpy( c_msg, "System error. Contact system support" );
                     fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                    }

                }
 
                 strcpy( c_msg, "System error. Contact system support" );

                i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                     c_xchng_cd,
                                                     c_cln_mtch_accnt,
                                                     c_run_dt,
                                                     d_payout_amt,
                                                     0,
                                                     d_payin_amt,
                                                     d_intadj_amt,
                                                     d_amount_recovered,
                                                     d_amount_recovered,
                                                     0,
                                                     0,
                                                     li_run_no,
                                                     c_bnk_narration,
                                                     c_payin_pool_acc_nse,
                                                     c_payout_pool_acc_nse,
                                                     c_payin_pool_acc_bse,
                                                     c_payout_pool_acc_bse,
                                                     c_blk_deposit_flg);

                if ( i_rc != 0 )
                {
                 fn_errlog(c_ServiceName, "S31575",LIBMSG,c_err_msg);
                 strcpy( c_msg, "System error. Contact system support" );
                 fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                 tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                }
 
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );

             }
             else if( l_tpurcode == 116  && d_avlbl_amt > 0 )
             {
                 i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

                  if ( i_trnsctn == -1 )
                  {
                   fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                   fn_errlog(c_ServiceName, "S31580",LIBMSG,c_err_msg);
                   Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );

                   i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                    c_xchng_cd,
                                                    c_cln_mtch_accnt,
                                                    c_run_dt,
                                                    d_payout_amt,
                                                    0,
                                                    d_payin_amt,
                                                    d_intadj_amt,
                                                    d_amount_recovered,
                                                    d_amount_recovered,
                                                    0,
                                                    0,
                                                   li_run_no,
                                                   c_bnk_narration,
                                                   c_payin_pool_acc_nse,
                                                   c_payout_pool_acc_nse,
                                                   c_payin_pool_acc_bse,
                                                   c_payout_pool_acc_bse,
                                                   c_blk_deposit_flg
                                                  );

                   if ( i_rc != 0 )
                  {
                   fn_errlog(c_ServiceName, "S31585",LIBMSG,c_err_msg);
                   strcpy( c_msg, "System error. Contact system support" );
                   fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                  }

                  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                 }

                i_returncode = fn_lock_usr( c_ServiceName, c_cln_mtch_accnt );

                  if ( i_returncode == -1 )
                  {
                  fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                  fn_errlog(c_ServiceName, "S31590",LIBMSG,c_err_msg);
                  Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );

                  i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                   c_xchng_cd,
                                                   c_cln_mtch_accnt,
                                                   c_run_dt,
                                                   d_payout_amt,
                                                   0,
                                                   d_payin_amt,
                                                   d_intadj_amt,
                                                   d_amount_recovered,
                                                   d_amount_recovered,
                                                   0,
                                                   0,
                                                   li_run_no,
                                                   c_bnk_narration,
                                                   c_payin_pool_acc_nse,
                                                   c_payout_pool_acc_nse,
                                                   c_payin_pool_acc_bse,
                                                   c_payout_pool_acc_bse,
                                                   c_blk_deposit_flg
                                                  );

                if ( i_rc != 0 )
                {
                 fn_errlog(c_ServiceName, "S31595",LIBMSG,c_err_msg);
                 strcpy( c_msg, "System error. Contact system support" );
                 fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                 tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                }

               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
             }
        
             /*** Ver 2.7 Starts Here ****/
             i_returncode = fn_lock_fno( c_ServiceName, c_cln_mtch_accnt );

                if ( i_returncode == -1 )
                {
                 fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                 fn_errlog(c_ServiceName, "S31600",LIBMSG,c_err_msg);
                 Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );

                 i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                   c_xchng_cd,
                                                   c_cln_mtch_accnt,
                                                   c_run_dt,
                                                   d_payout_amt,
                                                   0,
                                                   d_payin_amt,
                                                   d_intadj_amt,
                                                   d_amount_recovered,
                                                   d_amount_recovered,
                                                   0,
                                                   0,
                                                   li_run_no,
                                                   c_bnk_narration,
                                                   c_payin_pool_acc_nse,
                                                   c_payout_pool_acc_nse,
                                                   c_payin_pool_acc_bse,
                                                   c_payout_pool_acc_bse,
                                                   c_blk_deposit_flg
                                                  );

                if ( i_rc != 0 )
                {
                 fn_errlog(c_ServiceName, "S31605",LIBMSG,c_err_msg);
                 strcpy( c_msg, "System error. Contact system support" );
                 fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                 tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                }
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }
             /*** Ver 2.7 Ends Here ***/
            if(DEBUG_MSG_LVL_3)
            {
             fn_userlog(c_ServiceName,"Available amount :%lf:",d_avlbl_amt);
            }
            
            i_returncode =  fn_call_inc_dec_svc( d_avlbl_amt*100 , c_txn_typ ,&d_avlbl_amt,li_run_no,c_run_dt );

            if( i_returncode != 0 )
            {
             fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
             fn_errlog( c_ServiceName , "S31610", TPMSG, c_err_msg);
             Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0); 
  
             
                if( l_tpurcode == 911 ||
                    l_tpurcode == -99 ||
                    l_tpurcode == -98 ||
                    l_tpurcode == -2  ||
                    l_tpurcode == 115 ||
                    l_tpurcode == 907 ||
                    l_tpurcode == -1   
                   )
                  {
                     i_ret_val = fn_ins_flr_tbl( c_ServiceName,
                                                 c_xchng_cd,
                                                 c_cln_mtch_accnt,
                                                 li_run_no,
                                                 c_run_dt,
                                                 c_bnk_accnt,
                                                 DEBIT,
                                                 CLEAR_BALANCE_DEBIT_ON_PAYIN,
                                                 DEBIT,
                                                 d_avlbl_amt*100, /** test**/
                                                 NOT_UPDATED,
                                                 NOT_UPDATED,
                                                 NOT_UPDATED,
                                                 c_trace,
                                                 c_tmstamp,
                                                 c_bnk_narration,
                                                c_blk_deposit_flg );
                      
                 if ( i_ret_val != 0 )
                 {
                    strcpy( c_msg, "System error. Contact system support" );

                    i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                     c_xchng_cd,
                                                     c_cln_mtch_accnt,
                                                     c_run_dt,
                                                     d_payout_amt,
                                                     0,
                                                     d_payin_amt,
                                                     d_intadj_amt,
                                                     d_amount_recovered,
                                                     d_amount_recovered,
                                                     0,
                                                     0,
                                                     li_run_no,
                                                     c_bnk_narration,
                                                     c_payin_pool_acc_nse,
                                                     c_payout_pool_acc_nse,
                                                     c_payin_pool_acc_bse,
                                                     c_payout_pool_acc_bse,
                                                     c_blk_deposit_flg
                                                     );

                    if ( i_rc != 0 )
                    {
                     fn_errlog(c_ServiceName, "S31615",LIBMSG,c_err_msg);
                     strcpy( c_msg, "System error. Contact system support" );
                     fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                    }

               }

                 strcpy( c_msg, "System error. Contact system support" );

                 i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                  c_xchng_cd,
                                                  c_cln_mtch_accnt,
                                                  c_run_dt,
                                                  d_payout_amt,
                                                  0,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_amount_recovered,
                                                  d_amount_recovered,
                                                  0,
                                                  0,
                                                  li_run_no,
                                                  c_bnk_narration,
                                                  c_payin_pool_acc_nse,
                                                  c_payout_pool_acc_nse,
                                                  c_payin_pool_acc_bse,
                                                  c_payout_pool_acc_bse,
                                                  c_blk_deposit_flg
                                                   );

                  if ( i_rc != 0 )
                  {
                   fn_errlog(c_ServiceName, "S31620",LIBMSG,c_err_msg);
                   strcpy( c_msg, "System error. Contact system support" );
                   fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                  }

                  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
               }
               else
               {
                 fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                 
                 if(DEBUG_MSG_LVL_3)
                 {
                  fn_userlog(c_ServiceName," Inside Insufficient funds /Non Generic Bank error  in second attempt");
                 }

                if( l_tpurcode != 116 )  /*** Ignoring FBM Insert for insuf funds in 2nd attemp **/
                {
                 i_ret_val = fn_ins_flr_tbl( c_ServiceName,
                                             c_xchng_cd,
                                             c_cln_mtch_accnt,
                                             li_run_no,
                                             c_run_dt,
                                             c_bnk_accnt,
                                             DEBIT,
                                             CLEAR_BALANCE_DEBIT_ON_PAYIN,
                                             DEBIT,
                                             d_avlbl_amt*100, /** test**/
                                             NOT_UPDATED,
                                             NOT_UPDATED,
                                             NOT_UPDATED,
                                             c_trace,
                                             c_tmstamp,
                                             c_bnk_narration,
                                             c_blk_deposit_flg );
               

                
             		if ( i_ret_val != 0 )
                {
                    strcpy( c_msg, "System error. Contact system support" );

                    i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                     c_xchng_cd,
                                                     c_cln_mtch_accnt,
                                                     c_run_dt,
                                                     d_payout_amt,
                                                     0,
                                                     d_payin_amt,
                                                     d_intadj_amt,
                                                     d_amount_recovered,
                                                     d_amount_recovered,
                                                     0,
                                                     0,
                                                     li_run_no,
                                                     c_bnk_narration,
                                                     c_payin_pool_acc_nse,
                                                     c_payout_pool_acc_nse,
                                                     c_payin_pool_acc_bse,
                                                     c_payout_pool_acc_bse,
                                                     c_blk_deposit_flg
                                                     );

                    if ( i_rc != 0 )
                    {
                     fn_errlog(c_ServiceName, "S31625",LIBMSG,c_err_msg);
                     strcpy( c_msg, "System error. Contact system support" );
                     fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                    }

               }
             }              

                strcpy( c_msg, "System error. Contact system support" );

                 i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                  c_xchng_cd,
                                                  c_cln_mtch_accnt,
                                                  c_run_dt,
                                                  d_payout_amt,
                                                  0,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_amount_recovered,
                                                  d_amount_recovered,
                                                  0,
                                                  0,
                                                  li_run_no,
                                                  c_bnk_narration,
                                                  c_payin_pool_acc_nse,
                                                  c_payout_pool_acc_nse,
                                                  c_payin_pool_acc_bse,
                                                  c_payout_pool_acc_bse,
                                                  c_blk_deposit_flg
                                                   );

                  if ( i_rc != 0 )
                  {
                   fn_errlog(c_ServiceName, "S31630",LIBMSG,c_err_msg);
                   strcpy( c_msg, "System error. Contact system support" );
                   fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                  }
 

                 tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
               }

              }
              else
              {
                if(DEBUG_MSG_LVL_3)
                {
                 fn_userlog(c_ServiceName,"Service callled succesfully for available amount in bank");
                }
 
                d_amount=d_avlbl_amt*100;
              }

             }
             else
             {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_userlog(c_ServiceName,"Inside unhandled bank error :%ld:",l_tpurcode);

              if( l_tpurcode !=116)  /*** Ignoring FBM Insert for Insuff funds for amount <= 0 **/
              {
                i_ret_val = fn_ins_flr_tbl( c_ServiceName,
                                            c_xchng_cd,
                                            c_cln_mtch_accnt,
                                            li_run_no,
                                            c_run_dt,
                                            c_bnk_accnt,
                                            DEBIT,
                                            CLEAR_BALANCE_DEBIT_ON_PAYIN,
                                            DEBIT,
                                            d_amount,
                                            NOT_UPDATED,
                                            NOT_UPDATED,
                                            NOT_UPDATED,
                                            c_trace,
                                            c_tmstamp,
                                            c_bnk_narration,
                                            c_blk_deposit_flg );

             if ( i_ret_val != 0 )
             {
               strcpy( c_msg, "System error. Contact system support" );

               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                 c_xchng_cd,
                                                 c_cln_mtch_accnt,
                                                 c_run_dt,
                                                 d_payout_amt,
                                                 0,
                                                 d_payin_amt,
                                                 d_intadj_amt,
                                                 d_amount_recovered,
                                                 d_amount_recovered,
                                                 0,
                                                 0,
                                                 li_run_no,
                                                 c_bnk_narration,
                                                 c_payin_pool_acc_nse,
                                                 c_payout_pool_acc_nse,
                                                 c_payin_pool_acc_bse,
                                                 c_payout_pool_acc_bse,
                                                 c_blk_deposit_flg);

                 if ( i_rc != 0 )
                 {
                  fn_errlog(c_ServiceName, "S31635",LIBMSG,c_err_msg);
                  strcpy( c_msg, "System error. Contact system support" );
                  fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                 }

                }
              }

            
                strcpy( c_msg, "System error. Contact system support" );

                i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                 c_xchng_cd,
                                                 c_cln_mtch_accnt,
                                                 c_run_dt,
                                                 d_payout_amt,
                                                 0,
                                                 d_payin_amt,
                                                 d_intadj_amt,
                                                 d_amount_recovered,
                                                 d_amount_recovered,
                                                 0,
                                                 0,
                                                 li_run_no,
                                                 c_bnk_narration,
                                                 c_payin_pool_acc_nse,
                                                 c_payout_pool_acc_nse,
                                                 c_payin_pool_acc_bse,
                                                 c_payout_pool_acc_bse,
                                                 c_blk_deposit_flg);

                if ( i_rc != 0 )
                {
                 fn_errlog(c_ServiceName, "S31640",LIBMSG,c_err_msg);
                 strcpy( c_msg, "System error. Contact system support" );
                 fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                 tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                }


              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
             }

            }         
     
             /*** To increase allocation amount ****/
              i_returncode = fn_updt_allctn_dtls ( c_ServiceName,
                                                   c_err_msg,
                                                   c_cln_mtch_accnt,
                                                   c_bnk_accnt,
                                                   c_ServiceName,
                                                   d_amount,
                                                   &d_tot_alc_amt);
              if( i_returncode != 0 )
              {
                fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                fn_errlog( c_ServiceName , "S31645", TPMSG, c_err_msg);
                Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);
              
                 i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg);

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31650",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

                 tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
              }

              i_returncode = fn_ins_seg_log( "system",
                                              0,
                                              c_ServiceName,
                                              c_cln_mtch_accnt,
                                              d_amount*0.01,
                                              'A', /**** To increase allocation **/
                                              c_sgmnt_cd,
                                              d_tot_alc_amt*0.01,
                                              'N',
                                              "SYS",  /**** Channel **/
                                              "Allocation towards ISEC obligation",
                                              li_run_no,
                                              "ALLOC",
                                              "CLEAR_BAL");

              if ( i_returncode != 0 )
              {
               fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
               fn_errlog(c_ServiceName, "S31655",LIBMSG,c_err_msg);
               strcpy ( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );

                i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                               );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31660",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }
               
              if(DEBUG_MSG_LVL_3)
              {
               fn_userlog(c_ServiceName,"FAB Allocated by Amount |%lf|", d_amount );
               fn_userlog(c_ServiceName,"Total FAB Allocated Amount |%lf|", d_tot_alc_amt );
              }

              /*** To reduce allocation amount ****/
              i_returncode = fn_updt_allctn_dtls ( c_ServiceName,
                                                   c_err_msg,
                                                   c_cln_mtch_accnt,
                                                   c_bnk_accnt,
                                                   c_ServiceName,
                                                   d_amount * -1.0,
                                                   &d_tot_alc_amt);
              if( i_returncode != 0 )
              {
                fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                fn_errlog( c_ServiceName , "S31665", TPMSG, c_err_msg);
                Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);
          
                i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg);

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31670",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }
 
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
              }

             MEMSET(c_seg_narr);
             sprintf(c_seg_narr,"NFO PI %s",c_run_dt);
             rtrim(c_seg_narr);


             i_returncode = fn_ins_seg_log( "system",
                                              0,
                                              c_ServiceName,
                                              c_cln_mtch_accnt,
                                              d_amount*0.01,
                                              'I', /**** To  reduce  allocation **/
                                              c_sgmnt_cd,
                                              d_tot_alc_amt*0.01,
                                              'N',
                                              "SYS",  /**** Channel **/
                                              c_seg_narr,
                                              li_run_no,
                                              "DEALLOC",
                                              "CLEAR_BAL");

              if ( i_returncode != 0 )
              {
               fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
               fn_errlog(c_ServiceName, "S31675",LIBMSG,c_err_msg);
               strcpy ( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );


               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                               );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31680",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }            
               
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              if(DEBUG_MSG_LVL_3)
              {
               fn_userlog(c_ServiceName,"FAB Allocated by Amount |%lf|", d_amount );
               fn_userlog(c_ServiceName,"Total FAB Allocated Amount |%lf|", d_tot_alc_amt );
              }
 
              EXEC SQL
              SELECT to_char(sysdate,'DDMONYYYY')||LPAD(piposeq.nextval,6,0)
              INTO : c_refrnce
              FROM   DUAL;

              if ( SQLCODE != 0 )
              {
               fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
               fn_errlog(c_ServiceName, "L31230",SQLMSG,c_err_msg);
               strcpy ( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
             
              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg);

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31685",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }          
 
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
              }

              if(DEBUG_MSG_LVL_3)
              {
               fn_userlog(c_ServiceName,"Reference no for Pass class :%s:",c_refrnce);
              }

              i_returncode = fn_pass_cls_entry (  c_ServiceName,
                                                  c_err_msg,
                                                  c_cln_mtch_accnt,
                                                  c_xchng_cd,
                                                  c_run_dt,
                                                  c_tag,
                                                  DEBIT,
                                                  d_amount,
                                                  PAYIN_PAYOUT,
                                                  c_refrnce ,
                                                  li_run_no,
                                                  'C',
                                                  c_bnk_accnt,
                                                  c_trace,
                                                  c_blk_deposit_flg
                                                 );

             if ( i_returncode != 0 )
             {
              fn_errlog( c_ServiceName, "L31250",LIBMSG,c_err_msg);
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              strcpy ( c_msg, "System error. Contact system support" );
              fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               
              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg);

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31690",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
             }


             if( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
             {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog( c_ServiceName , "S31695", TPMSG, c_err_msg);
              Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);

              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                               c_xchng_cd,
                                               c_cln_mtch_accnt,
                                               c_run_dt,
                                               d_payout_amt,
                                               0,
                                               d_payin_amt,
                                               d_intadj_amt,
                                               d_amount_recovered,
                                               d_amount_recovered,
                                               0,
                                               0,
                                               li_run_no,
                                               c_bnk_narration,
                                               c_payin_pool_acc_nse,
                                               c_payout_pool_acc_nse,
                                               c_payin_pool_acc_bse,
                                               c_payout_pool_acc_bse,
                                               c_blk_deposit_flg);

            if ( i_rc != 0 )
            {
             fn_errlog(c_ServiceName, "S31700",LIBMSG,c_err_msg);
             strcpy( c_msg, "System error. Contact system support" );
             fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
             tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
            }

              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
            }



             d_amount_recovered=d_amount_recovered + (d_amount*-1); 
              
             if(DEBUG_MSG_LVL_3)
             {
              fn_userlog(c_ServiceName,"-------- Amount recovered upto bank :%lf:",d_amount_recovered);
             }
             
             }/** End of EQ Limit ***/  
            }
            else
            {
              if(DEBUG_MSG_LVL_3)
              {
               fn_userlog(c_ServiceName,"Inside Wallet amount zero and non link account for :%lf:",d_amount);
              }

              /*** Ver 2.6 Starts Here ***/
              d_amount_alloc = d_amount;
              d_eq_freelmt=0;
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );

              fn_eq_free_limit(&d_eq_freelmt);
              d_eq_freelmt = d_eq_freelmt * 100;
              d_amount_alloc= fn_mind(d_amount_alloc,d_eq_freelmt);

              fn_userlog(c_ServiceName,"from Eq free limit d_amount_alloc :%lf:",d_amount_alloc);
             if( d_amount_alloc > 0)
             {
              i_returncode = fn_call_ud_fromeq( d_amount_alloc, 'Y',&d_avlbl_amt,li_run_no,c_run_dt ); /* Y for Non link */
              if( i_returncode == 0 )
              {
                EXEC SQL
                SELECT FAB_ALCTD_AMT
                  INTO :d_alctd_amt
                  FROM FAB_FO_ALC_BFT_SMRY , CLB_BNK_ACCTS
                 WHERE FAB_CLM_MTCH_ACCNT = :c_cln_mtch_accnt
                   AND CLB_CLM_MTCH_ACCNT = FAB_CLM_MTCH_ACCNT;
                if ( SQLCODE != 0 )
                {
                 fn_errlog(c_ServiceName, "S31705",SQLMSG,c_err_msg);
                 i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                 c_xchng_cd,
                                                 c_cln_mtch_accnt,
                                                 c_run_dt,
                                                 d_payout_amt,
                                                 0,
                                                 d_payin_amt,
                                                 d_intadj_amt,
                                                 d_amount_recovered, /** bank 0 amount **/
                                                 d_amount_recovered, /** EBA 0 amount **/
                                                 0,
                                                 0,
                                                 li_run_no,
                                                 c_bnk_narration,
                                                 c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                 c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                 c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                 c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                 c_blk_deposit_flg);
                 strcpy( c_msg, "System error. Contact system support" );
                 fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                 tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                }

                d_amount_alloc = fn_mind(d_amount_alloc,d_alctd_amt);

                i_returncode =  fn_do_db_on_alloc ( c_ServiceName,
                                                  c_err_msg,
                                                  c_cln_mtch_accnt,
                                                  c_xchng_cd,
                                                  c_run_dt,
                                                  c_bnk_accnt,
                                                  c_tag,
                                                  d_amount_alloc,
                                                  li_run_no,
                                                  c_reference,
                                                  c_blk_deposit_flg );
                if( i_returncode  != 0 )
                {
                 fn_userlog(c_ServiceName," FTR Entry - Error in Debit amount from allocation(Deposit Model) ");

                 i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                 c_xchng_cd,
                                                 c_cln_mtch_accnt,
                                                 c_run_dt,
                                                 d_payout_amt,
                                                 0,
                                                 d_payin_amt,
                                                 d_intadj_amt,
                                                 d_amount_recovered, /** bank 0 amount **/
                                                 d_amount_recovered, /** EBA 0 amount **/
                                                 0,
                                                 0,
                                                 li_run_no,
                                                 c_bnk_narration,
                                                 c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                 c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                 c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                 c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                 c_blk_deposit_flg);  /*** Ver 2.2 **/



                  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                }

                d_amount = d_amount - d_amount_alloc;  /** Remaining Amount ***/
                d_amount_recovered=d_amount_recovered + (d_amount_alloc*-1);  /** Ver 2.6 */
              }
             } 
             else
             {
               fn_userlog(c_ServiceName,"Error from Func Free EQ Limit");
              /*** Ver 2.6 Ends Here ***/

              /**i_returncode= fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );  

              if ( i_returncode != 0 )
              {
               fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
               fn_errlog( c_ServiceName , "S31710", TPMSG, c_err_msg);
               Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);


               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                               c_xchng_cd,
                                               c_cln_mtch_accnt,
                                               c_run_dt,
                                               d_payout_amt,
                                               0,
                                               d_payin_amt,
                                               d_intadj_amt,
                                               d_amount_recovered,
                                               d_amount_recovered,
                                               0,
                                               0,
                                               li_run_no,
                                               c_bnk_narration,
                                               c_payin_pool_acc_nse,
                                               c_payout_pool_acc_nse,
                                               c_payin_pool_acc_bse,
                                               c_payout_pool_acc_bse,
                                               c_blk_deposit_flg);

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31715",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }
     
              fn_userlog(c_ServiceName,"Abort successfull");
              fn_userlog(c_ServiceName,"Going for FTR Entry Non link Account"); 
              **  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 ); **
              }  *******/      
             } 
            } 

          }            
           /****************** Payin for Deposit Model ends ************/  

          /*** Ver 2.4 Starts Here ***/
          if( c_idfc_payin_flg == 'Y' && c_hsbc_payin_flg == 'Y' )  /** Ver 2.8 HSBC added **/
          {
            if(DEBUG_MSG_LVL_3)
             {
              fn_userlog(c_ServiceName,"Inside wallet check");
              fn_userlog(c_ServiceName,"Excess Amount required :%lf:",d_amount);
              fn_userlog(c_ServiceName,"Amount recovered upt Allocation :%lf:",d_amount_recovered);
             }

            /**********************************************************************************************/
            /* Logic to DEBIT Amount                                                                      */
            /* Check Wallet Amount : If (wallet amt) > d_amount : Debit d_amount from Wallet              */
            /*                       If (wallet amt) > 0 and wallet amt < d_amount : Debit Wallet Amount  */
            /*                          and (remng amt) = ( wallet amt ) - d_amount : Debit From Bank     */
            /*                       If (wallet amt) < 0 : Debit from Bank                                */
            /**********************************************************************************************/



            /********* Begin Transaction **********/
            i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

            if ( i_trnsctn == -1 )
            {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog(c_ServiceName, "S31720",LIBMSG,c_err_msg);
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );

              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                                );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31725",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
            }


            /********** Lock User ***********/
            i_returncode = fn_lock_usr( c_ServiceName, c_cln_mtch_accnt );

            if ( i_returncode == -1 )
            {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog(c_ServiceName, "S31730",LIBMSG,c_err_msg);
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );   
              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                                );

              if ( i_rc != 0 )
              { 
                fn_errlog(c_ServiceName, "S31735",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
            }

            /*** Ver 2.7 Starts here ****/ 
            i_returncode = fn_lock_fno( c_ServiceName, c_cln_mtch_accnt );

            if ( i_returncode == -1 )
            {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog(c_ServiceName, "S31740",LIBMSG,c_err_msg);
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                                );

              if ( i_rc != 0 )
              {
                fn_errlog(c_ServiceName, "S31745",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
            }
            /*** Ver 2.7 Ends here **/

            EXEC SQL
            SELECT NVL(CLM_WALLET_AMT*100,0)
            INTO  :d_wallet_amt
            FROM  CLM_CLNT_MSTR
            WHERE CLM_MTCH_ACCNT = :c_cln_mtch_accnt;

            if( SQLCODE != 0 )
            {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog( c_ServiceName , "S31750", TPMSG, c_err_msg);
              Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);

              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                                );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31755",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
            }

            fn_userlog( c_ServiceName,"Wallet Amount is |%lf|",d_wallet_amt );

            if( d_wallet_amt >= d_amount )
            {
              if(DEBUG_MSG_LVL_3)
              {
               fn_userlog(c_ServiceName,"Inside wallet amount greater than amount to be debited ");
              }

              c_txn_typ = WALLET_UNBLOCK_DEBIT;
              
              i_returncode = fn_call_inc_dec_svc( d_amount, c_txn_typ,&d_avlbl_amt,li_run_no,c_run_dt  );
              
              if( i_returncode != 0 )
              {
                fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                fn_errlog( c_ServiceName , "S31760", TPMSG, c_err_msg);
                Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);
        
                if(l_tpurcode == 911 ||
                 l_tpurcode == -99 ||
                 l_tpurcode == -98 ||
                 l_tpurcode == -2  ||
                 l_tpurcode == 115 ||
                 l_tpurcode == 907 ||
                 l_tpurcode == -1
                )
              {
                i_ret_val = fn_ins_flr_tbl( c_ServiceName,
                                            c_xchng_cd,
                                            c_cln_mtch_accnt,
                                            li_run_no,
                                            c_run_dt,
                                            c_bnk_accnt,
                                            DEBIT,
                                            UNBLOCK_DEBIT_FROM_WALLET,
                                            DEBIT,
                                            d_amount,
                                            NOT_UPDATED,
                                            NOT_UPDATED,
                                            NOT_UPDATED,
                                            c_trace,
                                            c_tmstamp,
                                            c_bnk_narration,
                                            c_blk_deposit_flg);

              if ( i_ret_val != 0 )
              {
               strcpy( c_msg, "System error. Contact system support" );
               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                     c_xchng_cd,
                                                     c_cln_mtch_accnt,
                                                     c_run_dt,
                                                     d_payout_amt,
                                                     0,
                                                     d_payin_amt,
                                                     d_intadj_amt,
                                                     d_amount_recovered,
                                                     d_amount_recovered,
                                                     0,
                                                     0,
                                                     li_run_no,
                                                     c_bnk_narration,
                                                     c_payin_pool_acc_nse,
                                                     c_payout_pool_acc_nse,
                                                     c_payin_pool_acc_bse,
                                                     c_payout_pool_acc_bse,
                                                     c_blk_deposit_flg
                                                     );

                    if ( i_rc != 0 )
                    {
                     fn_errlog(c_ServiceName, "S31765",LIBMSG,c_err_msg);
                     strcpy( c_msg, "System error. Contact system support" );
                     fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                    }

              }

              strcpy( c_msg, "System error. Contact system support" );
              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                  c_xchng_cd,
                                                  c_cln_mtch_accnt,
                                                  c_run_dt,
                                                  d_payout_amt,
                                                  0,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_amount_recovered,
                                                  d_amount_recovered,
                                                  0,
                                                  0,
                                                  li_run_no,
                                                  c_bnk_narration,
                                                  c_payin_pool_acc_nse,
                                                  c_payout_pool_acc_nse,
                                                  c_payin_pool_acc_bse,
                                                  c_payout_pool_acc_bse,
                                                  c_blk_deposit_flg
                                                   );

               if ( i_rc != 0 )
               {
                fn_errlog(c_ServiceName, "S31770",LIBMSG,c_err_msg);
                strcpy( c_msg, "System error. Contact system support" );
                fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
               }


              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);

           }
           else if( l_tpurcode == 116 && d_avlbl_amt > 0 )
           {

             i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

             if ( i_trnsctn == -1 )
             {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog(c_ServiceName, "S31775",LIBMSG,c_err_msg);
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );

              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                               c_xchng_cd,
                                               c_cln_mtch_accnt,
                                               c_run_dt,
                                               d_payout_amt,
                                               0,
                                               d_payin_amt,
                                               d_intadj_amt,
                                               d_amount_recovered,
                                               d_amount_recovered,
                                               0,
                                               0,
                                               li_run_no,
                                               c_bnk_narration,
                                               c_payin_pool_acc_nse,
                                               c_payout_pool_acc_nse,
                                               c_payin_pool_acc_bse,
                                               c_payout_pool_acc_bse,
                                               c_blk_deposit_flg
                                               );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31780",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
             }


             i_returncode = fn_lock_usr( c_ServiceName, c_cln_mtch_accnt );

             if ( i_returncode == -1 )
             {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog(c_ServiceName, "S31785",LIBMSG,c_err_msg);
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );

              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                   c_xchng_cd,
                                                   c_cln_mtch_accnt,
                                                   c_run_dt,
                                                   d_payout_amt,
                                                   0,
                                                   d_payin_amt,
                                                   d_intadj_amt,
                                                   d_amount_recovered,
                                                   d_amount_recovered,
                                                   0,
                                                   0,
                                                   li_run_no,
                                                   c_bnk_narration,
                                                   c_payin_pool_acc_nse,
                                                   c_payout_pool_acc_nse,
                                                   c_payin_pool_acc_bse,
                                                   c_payout_pool_acc_bse,
                                                   c_blk_deposit_flg
                                                  );

                if ( i_rc != 0 )
                {
                 fn_errlog(c_ServiceName, "S31790",LIBMSG,c_err_msg);
                 strcpy( c_msg, "System error. Contact system support" );
                 fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                 tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                }

                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
             }
             
             /**** Ver 2.7 Starts here ***/
             i_returncode = fn_lock_fno( c_ServiceName, c_cln_mtch_accnt );

             if ( i_returncode == -1 )
             {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog(c_ServiceName, "S31795",LIBMSG,c_err_msg);
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );

              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                   c_xchng_cd,
                                                   c_cln_mtch_accnt,
                                                   c_run_dt,
                                                   d_payout_amt,
                                                   0,
                                                   d_payin_amt,
                                                   d_intadj_amt,
                                                   d_amount_recovered,
                                                   d_amount_recovered,
                                                   0,
                                                   0,
                                                   li_run_no,
                                                   c_bnk_narration,
                                                   c_payin_pool_acc_nse,
                                                   c_payout_pool_acc_nse,
                                                   c_payin_pool_acc_bse,
                                                   c_payout_pool_acc_bse,
                                                   c_blk_deposit_flg
                                                  );

                if ( i_rc != 0 )
                {
                 fn_errlog(c_ServiceName, "S31800",LIBMSG,c_err_msg);
                 strcpy( c_msg, "System error. Contact system support" );
                 fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                 tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                }

                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
             }
             /**** Ver 2.7 Ends Here ***/
   
                i_returncode =  fn_call_inc_dec_svc( d_avlbl_amt*100 , c_txn_typ ,&d_avlbl_amt,li_run_no,c_run_dt );

             if( i_returncode != 0 )
                {
                  fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                  fn_errlog( c_ServiceName , "S31805", TPMSG, c_err_msg);
                  Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);

                 if(l_tpurcode == 911 ||
                    l_tpurcode == -99 ||
                    l_tpurcode == -98 ||
                    l_tpurcode == -2  ||
                    l_tpurcode == 115 ||
                    l_tpurcode == 907 ||
                    l_tpurcode == -1)
                  {
                   i_ret_val = fn_ins_flr_tbl( c_ServiceName,
                                                 c_xchng_cd,
                                                 c_cln_mtch_accnt,
                                                 li_run_no,
                                                 c_run_dt,
                                                 c_bnk_accnt,
                                                 DEBIT,
                                                 UNBLOCK_DEBIT_FROM_WALLET,
                                                 DEBIT,
                                                 d_avlbl_amt*100,
                                                 NOT_UPDATED,
                                                 NOT_UPDATED,
                                                 NOT_UPDATED,
                                                 c_trace,
                                                 c_tmstamp,
                                                 c_bnk_narration,
                                                 c_blk_deposit_flg);
                   if ( i_ret_val != 0 )
                   {
                    strcpy( c_msg, "System error. Contact system support" );

                    i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                     c_xchng_cd,
                                                     c_cln_mtch_accnt,
                                                     c_run_dt,
                                                     d_payout_amt,
                                                     0,
                                                     d_payin_amt,
                                                     d_intadj_amt,
                                                     d_amount_recovered,
                                                     d_amount_recovered,
                                                     0,
                                                     0,
                                                     li_run_no,
                                                     c_bnk_narration,
                                                     c_payin_pool_acc_nse,
                                                     c_payout_pool_acc_nse,
                                                     c_payin_pool_acc_bse,
                                                     c_payout_pool_acc_bse,
                                                     c_blk_deposit_flg
                                                     );

                    if ( i_rc != 0 )
                    {
                     fn_errlog(c_ServiceName, "S31810",LIBMSG,c_err_msg);
                     strcpy( c_msg, "System error. Contact system support" );
                     fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                    }

                }

                strcpy( c_msg, "System error. Contact system support" );

                 i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                  c_xchng_cd,
                                                  c_cln_mtch_accnt,
                                                  c_run_dt,
                                                  d_payout_amt,
                                                  0,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_amount_recovered,
                                                  d_amount_recovered,
                                                  0,
                                                  0,
                                                  li_run_no,
                                                  c_bnk_narration,
                                                  c_payin_pool_acc_nse,
                                                  c_payout_pool_acc_nse,
                                                  c_payin_pool_acc_bse,
                                                  c_payout_pool_acc_bse,
                                                  c_blk_deposit_flg
                                                   );

                  if ( i_rc != 0 )
                  {
                   fn_errlog(c_ServiceName, "S31815",LIBMSG,c_err_msg);
                   strcpy( c_msg, "System error. Contact system support" );
                   fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                  }

                 tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
               }
               else
               {
                 if(DEBUG_MSG_LVL_3)
                 {
                  fn_userlog(c_ServiceName," Inside Insufficient limit/ Non Generic Bank error in second attempt");
                 }

                if( l_tpurcode != 116 )  /*** Ignoring FBM Insert in Insuff funds for 2nd attempt **/
                {
                 i_ret_val = fn_ins_flr_tbl( c_ServiceName,
                                             c_xchng_cd,
                                             c_cln_mtch_accnt,
                                             li_run_no,
                                             c_run_dt,
                                             c_bnk_accnt,
                                             DEBIT,
                                             UNBLOCK_DEBIT_FROM_WALLET,
                                             DEBIT,
                                             d_avlbl_amt*100,
                                             NOT_UPDATED,
                                             NOT_UPDATED,
                                             NOT_UPDATED,
                                             c_trace,
                                             c_tmstamp,
                                             c_bnk_narration,
                                             c_blk_deposit_flg);


               if ( i_ret_val != 0 )
               {
                 strcpy( c_msg, "System error. Contact system support" );
                 i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                  c_xchng_cd,
                                                  c_cln_mtch_accnt,
                                                  c_run_dt,
                                                  d_payout_amt,
                                                  0,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_amount_recovered,
                                                  d_amount_recovered,
                                                  0,
                                                  0,
                                                  li_run_no,
                                                  c_bnk_narration,
                                                  c_payin_pool_acc_nse,
                                                  c_payout_pool_acc_nse,
                                                  c_payin_pool_acc_bse,
                                                  c_payout_pool_acc_bse,
                                                  c_blk_deposit_flg
                                                );

                 if ( i_rc != 0 )
                 {
                  fn_errlog(c_ServiceName, "S31820",LIBMSG,c_err_msg);
                  strcpy( c_msg, "System error. Contact system support" );
                  fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                 }

                }
               }
          
               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                  c_xchng_cd,
                                                  c_cln_mtch_accnt,
                                                  c_run_dt,
                                                  d_payout_amt,
                                                  0,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_amount_recovered,
                                                  d_amount_recovered,
                                                  0,
                                                  0,
                                                  li_run_no,
                                                  c_bnk_narration,
                                                  c_payin_pool_acc_nse,
                                                  c_payout_pool_acc_nse,
                                                  c_payin_pool_acc_bse,
                                                  c_payout_pool_acc_bse,
                                                  c_blk_deposit_flg
                                                   );

                 if ( i_rc != 0 )
                 {
                   fn_errlog(c_ServiceName, "S31825",LIBMSG,c_err_msg);
                   strcpy( c_msg, "System error. Contact system support" );
                   fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                 }


                 tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
               }

                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);

              }
              else
              {
                if(DEBUG_MSG_LVL_3)
                {
                 fn_userlog(c_ServiceName,"Service called succesfully for available amount in bank");
                }

                d_rmng_pipo_amt=d_avlbl_amt*100;
              }

            }
            else
            {
              if(DEBUG_MSG_LVL_3)
              {
               fn_userlog(c_ServiceName,"Inside Non Generic Bank error");
              }

             if( l_tpurcode != 116 )  /**** Ignoring FBM Insert in Insuff case for 2nd attemp ***/
             {
              if(DEBUG_MSG_LVL_3)
              {
               fn_userlog(c_ServiceName,"Inside FBM insert");
              }

              i_ret_val = fn_ins_flr_tbl( c_ServiceName,
                                          c_xchng_cd,
                                          c_cln_mtch_accnt,
                                          li_run_no,
                                          c_run_dt,
                                          c_bnk_accnt,
                                          DEBIT,
                                          UNBLOCK_DEBIT_FROM_WALLET,
                                          DEBIT,
                                          d_amount,
                                          NOT_UPDATED,
                                          NOT_UPDATED,
                                          NOT_UPDATED,
                                          c_trace,
                                          c_tmstamp,
                                          c_bnk_narration,
                                          c_blk_deposit_flg);



              if ( i_ret_val != 0 )
              {
               strcpy( c_msg, "System error. Contact system support" );
               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                     c_xchng_cd,
                                                     c_cln_mtch_accnt,
                                                     c_run_dt,
                                                     d_payout_amt,
                                                     0,
                                                     d_payin_amt,
                                                     d_intadj_amt,
                                                     d_amount_recovered,
                                                     d_amount_recovered,
                                                     0,
                                                     0,
                                                     li_run_no,
                                                     c_bnk_narration,
                                                     c_payin_pool_acc_nse,
                                                     c_payout_pool_acc_nse,
                                                     c_payin_pool_acc_bse,
                                                     c_payout_pool_acc_bse,
                                                     c_blk_deposit_flg
                                                     );

                    if ( i_rc != 0 )
                    {
                     fn_errlog(c_ServiceName, "S31830",LIBMSG,c_err_msg);
                     strcpy( c_msg, "System error. Contact system support" );
                     fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                    }

              }
             }

             i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                  c_xchng_cd,
                                                  c_cln_mtch_accnt,
                                                  c_run_dt,
                                                  d_payout_amt,
                                                  0,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_amount_recovered,
                                                  d_amount_recovered,
                                                  0,
                                                  0,
                                                  li_run_no,
                                                  c_bnk_narration,
                                                  c_payin_pool_acc_nse,
                                                  c_payout_pool_acc_nse,
                                                  c_payin_pool_acc_bse,
                                                  c_payout_pool_acc_bse,
                                                  c_blk_deposit_flg
                                                   );

               if ( i_rc != 0 )
               {
                fn_errlog(c_ServiceName, "S31835",LIBMSG,c_err_msg);
                strcpy( c_msg, "System error. Contact system support" );
                fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
               }

              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
            }

           }               
                 
              if(DEBUG_MSG_LVL_3)
              {
               fn_userlog(c_ServiceName,"Before calling fn to increase allocation amount ");
              }

              EXEC SQL
             SELECT to_char(sysdate,'DDMONYYYY')||LPAD(piposeq.nextval,6,0)
             INTO : c_refrnce
             FROM   DUAL;

             if ( SQLCODE != 0 )
             {
               fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog(c_ServiceName, "L31230",SQLMSG,c_err_msg);
              strcpy ( c_msg, "System error. Contact system support" );
              fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );

               /** i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                 c_blk_deposit_flg
                                                ); ***/
               i_rc = fn_ins_flr_tbl( c_ServiceName,
                                            c_xchng_cd,
                                            c_cln_mtch_accnt,
                                            li_run_no,
                                            c_run_dt,
                                            c_bnk_accnt,
                                            DEBIT,
                                            UNBLOCK_DEBIT_FROM_WALLET,
                                            DEBIT,
                                            d_amount,
                                            NOT_UPDATED,
                                            NOT_UPDATED,
                                            NOT_UPDATED,
                                            c_trace,
                                            c_tmstamp,
                                            c_bnk_narration,
                                            c_blk_deposit_flg);

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31840",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }


              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
             }

             if(DEBUG_MSG_LVL_3)
             {
              fn_userlog(c_ServiceName,"Reference no for Pass class :%s:",c_refrnce);
              fn_userlog(c_ServiceName,"before calling fn_pass class entry ");
             }

             i_returncode = fn_pass_cls_entry (  c_ServiceName,
                                                  c_err_msg,
                                                  c_cln_mtch_accnt,
                                                  c_xchng_cd,
                                                  c_run_dt,
                                                  c_tag,
                                                  DEBIT,
                                                  d_amount,
                                                  PAYIN_PAYOUT,
                                                  c_refrnce ,
                                                  li_run_no,
                                                  'W',
                                                   c_bnk_accnt,
                                                  "",
                                                   c_blk_deposit_flg);


             if ( i_returncode != 0 )
             {
              fn_errlog( c_ServiceName, "L31250",LIBMSG,c_err_msg);
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              strcpy ( c_msg, "System error. Contact system support" );
              fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
              /** i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                 c_blk_deposit_flg
                                                ); ***/
              i_rc = fn_ins_flr_tbl( c_ServiceName,
                                            c_xchng_cd,
                                            c_cln_mtch_accnt,
                                            li_run_no,
                                            c_run_dt,
                                            c_bnk_accnt,
                                            DEBIT,
                                            UNBLOCK_DEBIT_FROM_WALLET,
                                            DEBIT,
                                            d_amount,
                                            NOT_UPDATED,
                                            NOT_UPDATED,
                                            NOT_UPDATED,
                                            c_trace,
                                            c_tmstamp,
                                            c_bnk_narration,
                                            c_blk_deposit_flg);

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31845",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
             }

             if(DEBUG_MSG_LVL_3)
             {
              fn_userlog(c_ServiceName,"After calling fn_pass_cls_entry");
             }


             if( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
             {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog( c_ServiceName , "S31850", TPMSG, c_err_msg);
              Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);
              /****
              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                               c_xchng_cd,
                                               c_cln_mtch_accnt,
                                               c_run_dt,
                                               d_payout_amt,
                                               0,
                                               d_payin_amt,
                                               d_intadj_amt,
                                               d_amount_recovered,
                                               d_amount_recovered,
                                               0,
                                               0,
                                               li_run_no,
                                               c_bnk_narration,
                                               c_payin_pool_acc_nse,
                                               c_payout_pool_acc_nse,
                                               c_payin_pool_acc_bse,
                                               c_payout_pool_acc_bse,
                                               c_blk_deposit_flg);
               *******/
               i_rc = fn_ins_flr_tbl( c_ServiceName,
                                            c_xchng_cd,
                                            c_cln_mtch_accnt,
                                            li_run_no,
                                            c_run_dt,
                                            c_bnk_accnt,
                                            DEBIT,
                                            UNBLOCK_DEBIT_FROM_WALLET,
                                            DEBIT,
                                            d_amount,
                                            NOT_UPDATED,
                                            NOT_UPDATED,
                                            NOT_UPDATED,
                                            c_trace,
                                            c_tmstamp,
                                            c_bnk_narration,
                                            c_blk_deposit_flg);

             if ( i_rc != 0 )
            {
             fn_errlog(c_ServiceName, "S31855",LIBMSG,c_err_msg);
             strcpy( c_msg, "System error. Contact system support" );
             fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
             tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
            }

              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
            }

            d_amount_recovered=d_amount_recovered +( d_amount*-1); 

             if(DEBUG_MSG_LVL_3)
             {
              fn_userlog(c_ServiceName,"Amount recovered upto wallet is :%lf:",d_amount_recovered);
             }
             d_amount=0;   /*** Complete Amount Payin Done ***/

           }
           else if( d_wallet_amt > 0 && d_wallet_amt < d_amount )      
           {
              if(DEBUG_MSG_LVL_3)
              {
               fn_userlog(c_ServiceName,"Inside wallet amount is less than debit amount");
              }

              /********* First Decrement Wallet ***********/
              c_txn_typ = WALLET_UNBLOCK_DEBIT;
               
               i_returncode = fn_call_inc_dec_svc( d_wallet_amt, c_txn_typ,&d_avlbl_amt,li_run_no,c_run_dt );

              if( i_returncode != 0 )
              {
                fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                fn_errlog( c_ServiceName , "S31860", TPMSG, c_err_msg);
                Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);

                if(l_tpurcode == 911 ||
                 l_tpurcode == -99 ||
                 l_tpurcode == -98 ||
                 l_tpurcode == -2  ||
                 l_tpurcode == 115 ||
                 l_tpurcode == 907 ||
                 l_tpurcode == -1
                )
              {
                i_ret_val = fn_ins_flr_tbl( c_ServiceName,
                                            c_xchng_cd,
                                            c_cln_mtch_accnt,
                                            li_run_no,
                                            c_run_dt,
                                            c_bnk_accnt,
                                            DEBIT,
                                            UNBLOCK_DEBIT_FROM_WALLET,
                                            DEBIT,
                                            d_wallet_amt,
                                            NOT_UPDATED,
                                            NOT_UPDATED,
                                            NOT_UPDATED,
                                            c_trace,
                                            c_tmstamp,
                                            c_bnk_narration,
                                            c_blk_deposit_flg);

              if ( i_ret_val != 0 )
              {

                strcpy( c_msg, "System error. Contact system support" );
               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                     c_xchng_cd,
                                                     c_cln_mtch_accnt,
                                                     c_run_dt,
                                                     d_payout_amt,
                                                     0,
                                                     d_payin_amt,
                                                     d_intadj_amt,
                                                     d_amount_recovered,
                                                     d_amount_recovered,
                                                     0,
                                                     0,
                                                     li_run_no,
                                                     c_bnk_narration,
                                                     c_payin_pool_acc_nse,
                                                     c_payout_pool_acc_nse,
                                                     c_payin_pool_acc_bse,
                                                     c_payout_pool_acc_bse,
                                                     c_blk_deposit_flg
                                                     );

                    if ( i_rc != 0 )
                    {
                     fn_errlog(c_ServiceName, "S31865",LIBMSG,c_err_msg);
                     strcpy( c_msg, "System error. Contact system support" );
                     fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                    }

              }

              strcpy( c_msg, "System error. Contact system support" );
              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                  c_xchng_cd,
                                                  c_cln_mtch_accnt,
                                                  c_run_dt,
                                                  d_payout_amt,
                                                  0,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_amount_recovered,
                                                  d_amount_recovered,
                                                  0,
                                                  0,
                                                  li_run_no,
                                                  c_bnk_narration,
                                                  c_payin_pool_acc_nse,
                                                  c_payout_pool_acc_nse,
                                                  c_payin_pool_acc_bse,
                                                  c_payout_pool_acc_bse,
                                                  c_blk_deposit_flg
                                                   );

               if ( i_rc != 0 )
               {
                fn_errlog(c_ServiceName, "S31870",LIBMSG,c_err_msg);
                strcpy( c_msg, "System error. Contact system support" );
                fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
               }


              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);

           }
           else if( l_tpurcode == 116 && d_avlbl_amt > 0 )
           {
             i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

             if ( i_trnsctn == -1 )
             {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog(c_ServiceName, "S31875",LIBMSG,c_err_msg);
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );

              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                               c_xchng_cd,
                                               c_cln_mtch_accnt,
                                               c_run_dt,
                                               d_payout_amt,
                                               0,
                                               d_payin_amt,
                                               d_intadj_amt,
                                               d_amount_recovered,
                                               d_amount_recovered,
                                               0,
                                               0,
                                               li_run_no,
                                               c_bnk_narration,
                                               c_payin_pool_acc_nse,
                                               c_payout_pool_acc_nse,
                                               c_payin_pool_acc_bse,
                                               c_payout_pool_acc_bse,
                                               c_blk_deposit_flg
                                               );

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31880",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }
  
              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
             }


             i_returncode = fn_lock_usr( c_ServiceName, c_cln_mtch_accnt );

             if ( i_returncode == -1 )
             {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog(c_ServiceName, "S31885",LIBMSG,c_err_msg);
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );

              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                   c_xchng_cd,
                                                   c_cln_mtch_accnt,
                                                   c_run_dt,
                                                   d_payout_amt,
                                                   0,
                                                   d_payin_amt,
                                                   d_intadj_amt,
                                                   d_amount_recovered,
                                                   d_amount_recovered,
                                                   0,
                                                   0,
                                                   li_run_no,
                                                   c_bnk_narration,
                                                   c_payin_pool_acc_nse,
                                                   c_payout_pool_acc_nse,
                                                   c_payin_pool_acc_bse,
                                                   c_payout_pool_acc_bse,
                                                   c_blk_deposit_flg
                                                  );

                if ( i_rc != 0 )
                {

                   fn_errlog(c_ServiceName, "S31890",LIBMSG,c_err_msg);
                 strcpy( c_msg, "System error. Contact system support" );
                 fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                 tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                }

                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
             }
               
             /*** ver 2.7 Starts here ***/
              i_returncode = fn_lock_fno( c_ServiceName, c_cln_mtch_accnt );

             if ( i_returncode == -1 )
             {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog(c_ServiceName, "S31895",LIBMSG,c_err_msg);
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );

              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                   c_xchng_cd,
                                                   c_cln_mtch_accnt,
                                                   c_run_dt,
                                                   d_payout_amt,
                                                   0,
                                                   d_payin_amt,
                                                   d_intadj_amt,
                                                   d_amount_recovered,
                                                   d_amount_recovered,
                                                   0,
                                                   0,
                                                   li_run_no,
                                                   c_bnk_narration,
                                                   c_payin_pool_acc_nse,
                                                   c_payout_pool_acc_nse,
                                                   c_payin_pool_acc_bse,
                                                   c_payout_pool_acc_bse,
                                                   c_blk_deposit_flg
                                                  );

                if ( i_rc != 0 )
                {

                   fn_errlog(c_ServiceName, "S31900",LIBMSG,c_err_msg);
                 strcpy( c_msg, "System error. Contact system support" );
                 fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                 tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                }

                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
             }
             /*** Ver 2.7 Ends Here ***/
 
                i_returncode =  fn_call_inc_dec_svc( d_avlbl_amt*100 , c_txn_typ ,&d_avlbl_amt,li_run_no,c_run_dt );

             if( i_returncode != 0 )
                {
                  fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                  fn_errlog( c_ServiceName , "S31905", TPMSG, c_err_msg);
                  Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);

                 if(l_tpurcode == 911 ||
                    l_tpurcode == -99 ||
                    l_tpurcode == -98 ||
                    l_tpurcode == -2  ||
                    l_tpurcode == 115 ||
                    l_tpurcode == 907 ||
                    l_tpurcode == -1)
                  {
                     i_ret_val = fn_ins_flr_tbl( c_ServiceName,
                                                 c_xchng_cd,
                                                 c_cln_mtch_accnt,
                                                 li_run_no,
                                                 c_run_dt,
                                                 c_bnk_accnt,
                                                 DEBIT,
                                                 UNBLOCK_DEBIT_FROM_WALLET,
                                                 DEBIT,
                                                 d_avlbl_amt*100,
                                                 NOT_UPDATED,
                                                 NOT_UPDATED,
                                                 NOT_UPDATED,
                                                 c_trace,
                                                 c_tmstamp,
                                                 c_bnk_narration,
                                                 c_blk_deposit_flg);
                   if ( i_ret_val != 0 )
                   {
                    strcpy( c_msg, "System error. Contact system support" );

                    i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                     c_xchng_cd,
                                                     c_cln_mtch_accnt,
                                                     c_run_dt,
                                                     d_payout_amt,
                                                     0,
                                                     d_payin_amt,
                                                     d_intadj_amt,
                                                     d_amount_recovered,
                                                     d_amount_recovered,
                                                     0,
                                                     0,
                                                     li_run_no,
                                                     c_bnk_narration,
                                                     c_payin_pool_acc_nse,
                                                     c_payout_pool_acc_nse,
                                                     c_payin_pool_acc_bse,
                                                     c_payout_pool_acc_bse,
                                                     c_blk_deposit_flg
                                                     );

                    if ( i_rc != 0 )
                    {
                     fn_errlog(c_ServiceName, "S31910",LIBMSG,c_err_msg);
                     strcpy( c_msg, "System error. Contact system support" );
                     fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                    }

                }

                strcpy( c_msg, "System error. Contact system support" );

                 i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                  c_xchng_cd,
                                                  c_cln_mtch_accnt,
                                                  c_run_dt,
                                                  d_payout_amt,
                                                  0,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_amount_recovered,
                                                  d_amount_recovered,
                                                  0,
                                                  0,
                                                  li_run_no,
                                                  c_bnk_narration,
                                                  c_payin_pool_acc_nse,
                                                  c_payout_pool_acc_nse,
                                                  c_payin_pool_acc_bse,
                                                  c_payout_pool_acc_bse,
                                                  c_blk_deposit_flg
                                                   );

                  if ( i_rc != 0 )
                  {
                   fn_errlog(c_ServiceName, "S31915",LIBMSG,c_err_msg);
                   strcpy( c_msg, "System error. Contact system support" );
                   fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                  }

                 tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
               }
               else
               {
                 if(DEBUG_MSG_LVL_3)
                 {
                  fn_userlog(c_ServiceName," Inside Insufficient limit/ Non Generic Bank error in second attempt");
                 }

                if( l_tpurcode != 116 )  /*** Ignoring FBM Insert in Insuff funds for 2nd attempt **/
                {
                 i_ret_val = fn_ins_flr_tbl( c_ServiceName,
                                             c_xchng_cd,
                                             c_cln_mtch_accnt,
                                             li_run_no,
                                             c_run_dt,
                                             c_bnk_accnt,
                                             DEBIT,
                                             UNBLOCK_DEBIT_FROM_WALLET,
                                             DEBIT,
                                             d_avlbl_amt*100,
                                             NOT_UPDATED,
                                             NOT_UPDATED,
                                             NOT_UPDATED,
                                             c_trace,
                                             c_tmstamp,
                                             c_bnk_narration,
                                             c_blk_deposit_flg);


               if ( i_ret_val != 0 )
               {
                  strcpy( c_msg, "System error. Contact system support" );
                 i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                  c_xchng_cd,
                                                  c_cln_mtch_accnt,
                                                  c_run_dt,
                                                  d_payout_amt,
                                                  0,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_amount_recovered,
                                                  d_amount_recovered,
                                                  0,
                                                  0,
                                                  li_run_no,
                                                  c_bnk_narration,
                                                  c_payin_pool_acc_nse,
                                                  c_payout_pool_acc_nse,
                                                  c_payin_pool_acc_bse,
                                                  c_payout_pool_acc_bse,
                                                  c_blk_deposit_flg
                                                );

                 if ( i_rc != 0 )
                 {
                  fn_errlog(c_ServiceName, "S31920",LIBMSG,c_err_msg);
                  strcpy( c_msg, "System error. Contact system support" );
                  fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                 }

                }
               }

               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                  c_xchng_cd,
                                                  c_cln_mtch_accnt,
                                                  c_run_dt,
                                                  d_payout_amt,
                                                  0,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_amount_recovered,
                                                  d_amount_recovered,
                                                  0,
                                                  0,
                                                  li_run_no,
                                                  c_bnk_narration,
                                                  c_payin_pool_acc_nse,
                                                  c_payout_pool_acc_nse,
                                                  c_payin_pool_acc_bse,
                                                  c_payout_pool_acc_bse,
                                                  c_blk_deposit_flg
                                                   );

                 if ( i_rc != 0 )
                 {
                   fn_errlog(c_ServiceName, "S31925",LIBMSG,c_err_msg);
                   strcpy( c_msg, "System error. Contact system support" );
                   fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                 }


                 tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
               }

                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);

              }
              else
              {
                if(DEBUG_MSG_LVL_3)
                {
                 fn_userlog(c_ServiceName,"Service called succesfully for available amount in bank");
                }

                d_rmng_pipo_amt=d_avlbl_amt*100;
              }

            }
            else
            {
              if(DEBUG_MSG_LVL_3)
              {
               fn_userlog(c_ServiceName,"Inside Non Generic Bank error");
              }

             if( l_tpurcode != 116 )  /**** Ignoring FBM Insert in Insuff case for 2nd attemp ***/
             {
              if(DEBUG_MSG_LVL_3)
              {
               fn_userlog(c_ServiceName,"Inside FBM insert");
              }

              i_ret_val = fn_ins_flr_tbl( c_ServiceName,
                                          c_xchng_cd,
                                          c_cln_mtch_accnt,
                                          li_run_no,
                                          c_run_dt,
                                          c_bnk_accnt,
                                          DEBIT,
                                          UNBLOCK_DEBIT_FROM_WALLET,
                                          DEBIT,
                                          d_wallet_amt,
                                          NOT_UPDATED,
                                          NOT_UPDATED,
                                          NOT_UPDATED,
                                          c_trace,
                                          c_tmstamp,
                                          c_bnk_narration,
                                          c_blk_deposit_flg);



              if ( i_ret_val != 0 )
              {
               strcpy( c_msg, "System error. Contact system support" );
               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                     c_xchng_cd,
                                                     c_cln_mtch_accnt,
                                                     c_run_dt,
                                                     d_payout_amt,
                                                     0,
                                                     d_payin_amt,
                                                     d_intadj_amt,
                                                     d_amount_recovered,
                                                     d_amount_recovered,
                                                     0,
                                                     0,
                                                     li_run_no,
                                                     c_bnk_narration,
                                                     c_payin_pool_acc_nse,
                                                     c_payout_pool_acc_nse,
                                                     c_payin_pool_acc_bse,
                                                     c_payout_pool_acc_bse,
                                                     c_blk_deposit_flg
                                                     );

                    if ( i_rc != 0 )
                    {
                     fn_errlog(c_ServiceName, "S31930",LIBMSG,c_err_msg);
                     strcpy( c_msg, "System error. Contact system support" );
                     fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                    }

              }
             }

             i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                  c_xchng_cd,
                                                  c_cln_mtch_accnt,
                                                  c_run_dt,
                                                  d_payout_amt,
                                                  0,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_amount_recovered,
                                                  d_amount_recovered,
                                                  0,
                                                  0,
                                                  li_run_no,
                                                  c_bnk_narration,
                                                  c_payin_pool_acc_nse,
                                                  c_payout_pool_acc_nse,
                                                  c_payin_pool_acc_bse,
                                                  c_payout_pool_acc_bse,
                                                  c_blk_deposit_flg
                                                   );

               if ( i_rc != 0 )
               {
                fn_errlog(c_ServiceName, "S31935",LIBMSG,c_err_msg);
                strcpy( c_msg, "System error. Contact system support" );
                fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
               }

              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
            }

           }


              if(DEBUG_MSG_LVL_3)
              {
               fn_userlog(c_ServiceName,"Wallet Decrement Successful");
               fn_userlog(c_ServiceName,"Before calling fn to increase Allocation amount");
              }

              if(DEBUG_MSG_LVL_3)
             {
              fn_userlog(c_ServiceName,"Amount debited from allocation successfully");
             }

              EXEC SQL
              SELECT to_char(sysdate,'DDMONYYYY')||LPAD(piposeq.nextval,6,0)
              INTO :c_refrnce
              FROM   DUAL;

              if ( SQLCODE != 0 )
              {
               fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
               fn_errlog(c_ServiceName, "L31230",SQLMSG,c_err_msg);
               strcpy ( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );

                /*** i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                                ); ***/
                                           
              i_rc = fn_ins_flr_tbl( c_ServiceName,
                                            c_xchng_cd,
                                            c_cln_mtch_accnt,
                                            li_run_no,
                                            c_run_dt,
                                            c_bnk_accnt,
                                            DEBIT,
                                            UNBLOCK_DEBIT_FROM_WALLET,
                                            DEBIT,
                                            d_wallet_amt,
                                            NOT_UPDATED,
                                            NOT_UPDATED,
                                            NOT_UPDATED,
                                            c_trace,
                                            c_tmstamp,
                                            c_bnk_narration,
                                            c_blk_deposit_flg); 

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31940",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
              }

              if(DEBUG_MSG_LVL_3)
              {
               fn_userlog(c_ServiceName,"Reference no for Pass class :%s:",c_refrnce);
              }

              i_returncode = fn_pass_cls_entry (  c_ServiceName,
                                                  c_err_msg,
                                                  c_cln_mtch_accnt,
                                                  c_xchng_cd,
                                                  c_run_dt,
                                                  c_tag,
                                                  DEBIT,
                                                  d_wallet_amt,
                                                  PAYIN_PAYOUT,
                                                  c_refrnce ,
                                                  li_run_no,
                                                  'W',
                                                   c_bnk_accnt,
                                                   "",
                                                   c_blk_deposit_flg);

             if ( i_returncode != 0 )
             {
              fn_errlog( c_ServiceName, "L31250",LIBMSG,c_err_msg);
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              strcpy ( c_msg, "System error. Contact system support" );
              fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );

              /****
              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                c_xchng_cd,
                                                c_cln_mtch_accnt,
                                                c_run_dt,
                                                d_payout_amt,
                                                0,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_amount_recovered,
                                                d_amount_recovered,
                                                0,
                                                0,
                                                li_run_no,
                                                c_bnk_narration,
                                                c_payin_pool_acc_nse,
                                                c_payout_pool_acc_nse,
                                                c_payin_pool_acc_bse,
                                                c_payout_pool_acc_bse,
                                                c_blk_deposit_flg
                                                );
               ************/
                      i_rc = fn_ins_flr_tbl( c_ServiceName,
                                            c_xchng_cd,
                                            c_cln_mtch_accnt,
                                            li_run_no,
                                            c_run_dt,
                                            c_bnk_accnt,
                                            DEBIT,
                                            UNBLOCK_DEBIT_FROM_WALLET,
                                            DEBIT,
                                            d_wallet_amt,
                                            NOT_UPDATED,
                                            NOT_UPDATED,
                                            NOT_UPDATED,
                                            c_trace,
                                            c_tmstamp,
                                            c_bnk_narration,
                                            c_blk_deposit_flg); 

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31945",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }
 
              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
             }

             if(DEBUG_MSG_LVL_3)
             {
              fn_userlog(c_ServiceName,"FAB Allocated by Amount |%lf|", d_wallet_amt );
              fn_userlog(c_ServiceName,"Total FAB Allocated Amount |%lf|", d_tot_alc_amt );
             }

             if( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
             {
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              fn_errlog( c_ServiceName , "S31950", TPMSG, c_err_msg);
              Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);
              /*************
              i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                  c_xchng_cd,
                                                  c_cln_mtch_accnt,
                                                  c_run_dt,
                                                  d_payout_amt,
                                                  0,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_amount_recovered,
                                                  d_amount_recovered,
                                                  0,
                                                  0,
                                                  li_run_no,
                                                  c_bnk_narration,
                                                  c_payin_pool_acc_nse,
                                                  c_payout_pool_acc_nse,
                                                  c_payin_pool_acc_bse,
                                                  c_payout_pool_acc_bse,
                                                  c_blk_deposit_flg
                                                  );
                ********/
                  i_rc = fn_ins_flr_tbl( c_ServiceName,
                                            c_xchng_cd,
                                            c_cln_mtch_accnt,
                                            li_run_no,
                                            c_run_dt,
                                            c_bnk_accnt,
                                            DEBIT,
                                            UNBLOCK_DEBIT_FROM_WALLET,
                                            DEBIT,
                                            d_wallet_amt,
                                            NOT_UPDATED,
                                            NOT_UPDATED,
                                            NOT_UPDATED,
                                            c_trace,
                                            c_tmstamp,
                                            c_bnk_narration,
                                            c_blk_deposit_flg);
                  if ( i_rc != 0 )
                  {
                   fn_errlog(c_ServiceName, "S31955",LIBMSG,c_err_msg);
                   strcpy( c_msg, "System error. Contact system support" );
                   fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                  }

              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
             }

             d_amount_recovered=d_amount_recovered+(d_wallet_amt*-1);
             d_amount_recovered=d_amount_recovered+d_wallet_amt;  /** Ver 2.6 **/

             if(DEBUG_MSG_LVL_3)
             {
              fn_userlog(c_ServiceName,"----Amount recovered upto wallet----:%lf:",d_amount_recovered);
             }   
             
             d_amount = d_amount - d_wallet_amt;  /*** Computing left over payin amount to be debited from Clear balance**/
             fn_userlog(c_ServiceName," Amount to be recoverd for IDFC :%lf",d_amount);

            }
            else
            {
              if(DEBUG_MSG_LVL_3)
              {
               fn_userlog(c_ServiceName,"Inside Wallet amount zero and go Debit Case after abort transaction ");
              }

              i_returncode= fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );

              if ( i_returncode != 0 )
              {
               fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
               fn_errlog( c_ServiceName , "S31960", TPMSG, c_err_msg);
               Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG,(char*)c_err_msg,0);


               i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                               c_xchng_cd,
                                               c_cln_mtch_accnt,
                                               c_run_dt,
                                               d_payout_amt,
                                               0,
                                               d_payin_amt,
                                               d_intadj_amt,
                                               d_amount_recovered,
                                               d_amount_recovered,
                                               0,
                                               0,
                                               li_run_no,
                                               c_bnk_narration,
                                               c_payin_pool_acc_nse,
                                               c_payout_pool_acc_nse,
                                               c_payin_pool_acc_bse,
                                               c_payout_pool_acc_bse,
                                               c_blk_deposit_flg);

              if ( i_rc != 0 )
              {
               fn_errlog(c_ServiceName, "S31965",LIBMSG,c_err_msg);
               strcpy( c_msg, "System error. Contact system support" );
               fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
               tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              fn_userlog(c_ServiceName,"Abort successfull");
              fn_userlog(c_ServiceName,"Going for FTR Entry Non link Account");
              /**  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 ); **/
              }
                  
              /**** Ver 2.6 Starts here Payin from EQ Free Limit ****/         
              d_amount_alloc = d_amount;
              d_eq_freelmt=0;
              fn_eq_free_limit(&d_eq_freelmt);
              d_eq_freelmt = d_eq_freelmt * 100;
              d_amount_alloc= fn_mind(d_amount_alloc,d_eq_freelmt);
             
              fn_userlog(c_ServiceName,"d_amount_alloc :%lf:",d_amount_alloc);
             if( d_amount_alloc > 0 )
             {
              i_returncode = fn_call_ud_fromeq( d_amount_alloc, 'N',&d_avlbl_amt,li_run_no,c_run_dt );  /* N for Linked bank Acc */
              if( i_returncode == 0 )
              {
                EXEC SQL
                  SELECT FAB_ALCTD_AMT
                    INTO :d_alctd_amt
                    FROM FAB_FO_ALC_BFT_SMRY , CLB_BNK_ACCTS
                   WHERE FAB_CLM_MTCH_ACCNT = :c_cln_mtch_accnt
                     AND CLB_CLM_MTCH_ACCNT = FAB_CLM_MTCH_ACCNT;
                if ( SQLCODE != 0 )
                {
                 fn_errlog(c_ServiceName, "S31970",SQLMSG,c_err_msg);
                 i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                 c_xchng_cd,
                                                 c_cln_mtch_accnt,
                                                 c_run_dt,
                                                 d_payout_amt,
                                                 0,
                                                 d_payin_amt,
                                                 d_intadj_amt,
                                                 d_amount_recovered, /** bank 0 amount **/
                                                 d_amount_recovered, /** EBA 0 amount **/
                                                 0,
                                                 0,
                                                 li_run_no,
                                                 c_bnk_narration,
                                                 c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                 c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                 c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                 c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                 c_blk_deposit_flg);
                 strcpy( c_msg, "System error. Contact system support" );
                 fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
                 tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                }  


                d_amount_alloc = fn_mind(d_amount_alloc,d_alctd_amt);

                i_returncode =  fn_do_db_on_alloc ( c_ServiceName,
                                                  c_err_msg,
                                                  c_cln_mtch_accnt,
                                                  c_xchng_cd,
                                                  c_run_dt,
                                                  c_bnk_accnt,
                                                  c_tag,
                                                  d_amount_alloc,
                                                  li_run_no,
                                                  c_reference,
                                                  c_blk_deposit_flg );
                if( i_returncode  != 0 )
               {
                fn_userlog(c_ServiceName," FTR Entry - Error in Debit amount from allocation(Deposit Model) ");

                i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                                 c_xchng_cd,
                                                 c_cln_mtch_accnt,
                                                 c_run_dt,
                                                 d_payout_amt,
                                                 0,
                                                 d_payin_amt,
                                                 d_intadj_amt,
                                                 d_amount_recovered, /** bank 0 amount **/
                                                 d_amount_recovered, /** EBA 0 amount **/
                                                 0,
                                                 0,
                                                 li_run_no,
                                                 c_bnk_narration,
                                                 c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                 c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                 c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                 c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                 c_blk_deposit_flg);
                 tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
                }

                d_amount = d_amount - d_amount_alloc;  /** Remaining Amount ***/
                d_amount_recovered=d_amount_recovered+(d_amount_alloc*-1);  /** Ver 2.6 **/
                fn_userlog(c_ServiceName,"Balance Amount d_amount After getting from EQ:%lf:",d_amount); 
               }
              }  
              /*** Ver 2.6 Ends Here *****************/
            }
          }
          /**** Ver 2.4 Ends Here ***/
 
            /********  Block Model Payin Starts for excess Amount required from Bank  **************************/
 
           if ( c_blk_deposit_flg =='B' && d_amount !=0 )  /*** Ver 2.2 **/ /** Ver 2.4 d_amount added ***/ 
           {  
         		i_ch_val =  fn_send_bnk_msg (	&st_usr_prfl,
           			             					    c_dr_cr_flg,
               		                  			" ",
                 		                			d_amount,
                   		              			BACKOFFICE,
                     		            			c_ServiceName,
                       		          			c_err_msg,
                         		        			&d_val_bal,
                           		      			c_reference,
																					c_timestamp,
																					c_bnk_narration,   /*** Ver 1.4 bnk_narration added ***/
                                          c_xchng_cd,     /** Ver 2.0 **/
																					li_run_no);			/** Added for Ver 2.1 **/

      			switch(i_ch_val)
      			{
        			case SUCCESS :
								d_bnk_pipo_amt = d_bnk_pipo_amt + ( d_amount * (-1.0) );
								i_returncode =  fn_do_db_on_clr_bal ( c_ServiceName,
                      																c_err_msg,
                      																c_cln_mtch_accnt,
                      																c_xchng_cd,
                      																c_run_dt,
                      																c_bnk_accnt,
                      																c_tag,
                      																d_amount,
                                                      li_run_no,   /*** Ver 1.6 Run Number Added **/
                                                      c_reference,   /*** Ver 2.2 **/
                                                      c_blk_deposit_flg ); /** Ver 2.2 **/

  							if ( i_returncode != 0 ) 
  							{
    							fn_errlog(c_ServiceName, "S31975",LIBMSG,c_err_msg);
									/*** Insert into Failure table ***/
									i_ret_val = fn_ins_flr_tbl(	c_ServiceName,
																							c_xchng_cd,
																							c_cln_mtch_accnt,
																							li_run_no,
																							c_run_dt,
																			  			c_bnk_accnt,
																							DEBIT,
																			  			CLEAR_BALANCE_DEBIT_ON_PAYIN,
																							DEBIT, /* ignore */
																							d_amount,
																							UPDATED,  					/*1.1:changed to success*/
																							NOT_UPDATED,
																							NOT_UPDATED,				/* Three more added by 1.1*/
																							c_reference,
																							c_timestamp,
                                              c_bnk_narration,   /*** Ver 1.4 bnk_narration added ***/
                                              c_blk_deposit_flg); /**** Ver 2.2 **/ 
           				if ( i_ret_val != 0 )
									{
     								strcpy ( c_msg, "System error. Contact system support" );
  									fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
										i_rc 	=	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	
						    	      		                        c_xchng_cd, 
							    		                              c_cln_mtch_accnt, 
								    	                              c_run_dt, 
                                                    d_payout_amt,
                                                    d_blk4trd_amt,
                                                    d_payin_amt,
                                                    d_intadj_amt,
                                                    d_bnk_pipo_amt,
                                                    d_eba_pipo_amt,
                                                    d_bnk_bft_amt,
                                                    d_eba_bft_amt,
									                                  li_run_no,
                                                    c_bnk_narration,  /*** Ver 1.4 bnk_narration added ***/
                                                    c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                    c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                    c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                    c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                    c_blk_deposit_flg); /*** Ver 2.2 **/

										if ( i_rc != 0 )
										{
    									fn_errlog(c_ServiceName, "S31980",LIBMSG,c_err_msg);
      								strcpy( c_msg, "System error. Contact system support" );
  										fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    									tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
										}
    								tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
									}
									i_rc 	=	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	
						         			                        c_xchng_cd, 
							    	     	                        c_cln_mtch_accnt, 
								    	                            c_run_dt, 
                                                  d_payout_amt,
                                                  d_blk4trd_amt,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_bnk_pipo_amt,
                                                  d_eba_pipo_amt,
                                                  d_bnk_bft_amt,
                                                  d_eba_bft_amt,
									                                li_run_no,
                                                  c_bnk_narration,   /*** Ver 1.4 bnk_narration added ***/
                                                  c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                  c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                  c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                  c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                  c_blk_deposit_flg); /*** Ver 2.2 **/

									if ( i_rc != 0 )
									{
    								fn_errlog(c_ServiceName, "S31985",LIBMSG,c_err_msg);
      							strcpy( c_msg, "System error. Contact system support" );
  									fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    								tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
									}
    							tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  							}
								d_eba_pipo_amt = d_eba_pipo_amt + ( d_amount * (-1.0) );
            		d_bal_amt = d_bal_amt + d_amount;
								break;

        			case INSUF_FUNDS :
								break ;

            case 100 :
            break ;

        			case GENERAL_FAILURE :
        			case BLOCK_NOT_EXISTING :
    						fn_errlog(c_ServiceName, "S31990",LIBMSG,c_err_msg);
      					sprintf(c_msg,"Error sending clr balance debit on Payin to bank for %s",c_cln_mtch_accnt); 
  							fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
								i_rc 	=	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	
						       			                        c_xchng_cd, 
							     	 		                        c_cln_mtch_accnt, 
								      	                        c_run_dt, 
                                                d_payout_amt,
                                                d_blk4trd_amt,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_bnk_pipo_amt,
                                                d_eba_pipo_amt,
                                                d_bnk_bft_amt,
                                                d_eba_bft_amt,
									                              li_run_no,
                                                c_bnk_narration,       /*** Ver 1.4 bnk_narration added ***/
                                                c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                c_blk_deposit_flg); /*** Ver 2.2 **/

								if ( i_rc != 0 )
								{
    							fn_errlog(c_ServiceName, "S31995",LIBMSG,c_err_msg);
      						strcpy( c_msg, "System error. Contact system support" );
  								fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    							tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
								}
    						tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
								break;																								
        			case INDERMINATE_FAILURE :
        			case RERUN_FAILURE :
							default :
								i_ret_val = fn_ins_flr_tbl(	c_ServiceName,
																						c_xchng_cd,
																						c_cln_mtch_accnt,
																						li_run_no,
																						c_run_dt,
																						c_bnk_accnt,
																						DEBIT,
																						CLEAR_BALANCE_DEBIT_ON_PAYIN,
																						DEBIT, 
																						d_amount,
																						NOT_UPDATED,
																						NOT_UPDATED,
																						NOT_UPDATED,							/* Three more added by 1.1*/
																						c_reference,
																						c_timestamp,
                                            c_bnk_narration,   /*** Ver 1.4 bnk_narration added ***/
                                            c_blk_deposit_flg); /*** Ver 2.2 **/ 
            		if ( i_ret_val != 0 )
								{
      						strcpy ( c_msg, "System error. Contact system support" );
  								fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
									i_rc 	=	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	
						        			                        c_xchng_cd, 
							        		                        c_cln_mtch_accnt, 
								        	                        c_run_dt, 
                                                  d_payout_amt,
                                                  d_blk4trd_amt,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_bnk_pipo_amt,
                                                  d_eba_pipo_amt,
                                                  d_bnk_bft_amt,
                                                  d_eba_bft_amt,
									                                li_run_no,
                                                  c_bnk_narration,    /*** Ver 1.4 bnk_narration added ***/
                                                  c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                  c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                  c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                  c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                  c_blk_deposit_flg); /*** Ver 2.2 **/

									if ( i_rc != 0 )
									{
    								fn_errlog(c_ServiceName, "S32000",LIBMSG,c_err_msg);
      							strcpy( c_msg, "System error. Contact system support" );
  									fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    								tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
									}
    							tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
								}
      					sprintf(c_msg,"Indeterminate failure for [%s] in sending clr balance debit message on Payin to bank",c_cln_mtch_accnt); 
  							fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
								i_rc 	=	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	
						       			                        c_xchng_cd, 
							       		                        c_cln_mtch_accnt, 
								       	                        c_run_dt, 
                                                d_payout_amt,
                                                d_blk4trd_amt,
                                                d_payin_amt,
                                                d_intadj_amt,
                                                d_bnk_pipo_amt,
                                                d_eba_pipo_amt,
                                                d_bnk_bft_amt,
                                                d_eba_bft_amt,
									                              li_run_no,
                                                c_bnk_narration,    /*** Ver 1.4 bnk_narration added ***/ 
                                                c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                c_blk_deposit_flg); /*** Ver 2.2 **/

								if ( i_rc != 0 )
								{
    							fn_errlog(c_ServiceName, "S32005",LIBMSG,c_err_msg);
      						strcpy( c_msg, "System error. Contact system support" );
  								fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    							tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
								}
    						tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
								break;
						}


						if ( ( i_ch_val == INSUF_FUNDS ) && ( d_val_bal > 0 ) )
						{


           		d_amount = fn_mind( -1.0 * d_bal_amt, d_val_bal ); 


  			 			strcpy( c_timestamp, "01-Jan-1980" );
         			i_returncode =  fn_send_bnk_msg (	&st_usr_prfl,
           	             					        			c_dr_cr_flg,
           		                  								" ",
             		                								d_amount,
               		              								BACKOFFICE,
                 		            								c_ServiceName,
                   		          								c_err_msg,
                     		        								&d_val_bal,
                       		      								c_reference,
																								c_timestamp,
																								c_bnk_narration,  /*** Ver 1.4 bnk_narration added ***/
                                                c_xchng_cd,     /** Ver 2.0 **/
																								li_run_no);			/** Added for Ver 2.1 **/

   						switch ( i_returncode )
   						{
     						case SUCCESS :
									d_bnk_pipo_amt = d_bnk_pipo_amt + ( d_amount * (-1.0) );
									i_returncode =  fn_do_db_on_clr_bal ( c_ServiceName,
                      																	c_err_msg,
                      																	c_cln_mtch_accnt,
                      																	c_xchng_cd,
                      																	c_run_dt,
                      																	c_bnk_accnt,
                      																	c_tag,
                      																	d_amount,
                                                        li_run_no,  /** Ver 1.6 Run Number Added **/
                                                        c_reference,  /**** Ver 2.2 ****/  
                                                        c_blk_deposit_flg ); /** Ver 2.2 **/

  								if ( i_returncode != 0 ) 
  								{
    								fn_errlog(c_ServiceName, "S32010",LIBMSG,c_err_msg);
										/*** Insert into Failure table ***/
										i_ret_val = fn_ins_flr_tbl(	c_ServiceName,
																								c_xchng_cd,
																								c_cln_mtch_accnt,
																								li_run_no,
																								c_run_dt,
																			  				c_bnk_accnt,
																								DEBIT,
																			  				CLEAR_BALANCE_DEBIT_ON_PAYIN,
																								DEBIT, /* ignore */
																								d_amount,
																								UPDATED,							/*1.1:changed to success*/
																								NOT_UPDATED,
																								NOT_UPDATED,					/* Three more added by 1.1*/
																								c_reference,
																								c_timestamp,
                                                c_bnk_narration,    /*** Ver 1.4 bnk_narration added ***/
                                                c_blk_deposit_flg); /** Ver 2.2 **/ 
           					if ( i_ret_val != 0 )
										{
     									strcpy ( c_msg, "System error. Contact system support" );
  										fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
											i_rc 	=	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	
						    	        		                        c_xchng_cd, 
							    		                                c_cln_mtch_accnt, 
								    	                                c_run_dt, 
                                                      d_payout_amt,
                                                      d_blk4trd_amt,
                                                      d_payin_amt,
                                                      d_intadj_amt,
                                                      d_bnk_pipo_amt,
                                                      d_eba_pipo_amt,
                                                      d_bnk_bft_amt,
                                                      d_eba_bft_amt,
									                                    li_run_no,
                                                      c_bnk_narration,   /*** Ver 1.4 bnk_narration added ***/
                                                      c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                      c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                      c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                      c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                      c_blk_deposit_flg); /*** Ver 2.2 **/

											if ( i_rc != 0 )
											{
    										fn_errlog(c_ServiceName, "S32015",LIBMSG,c_err_msg);
      									strcpy( c_msg, "System error. Contact system support" );
  											fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    										tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
											}
    									tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
										}
										i_rc 	=	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	
						    	      		                        c_xchng_cd, 
							    		                              c_cln_mtch_accnt, 
								    	                              c_run_dt, 
                                                    d_payout_amt,
                                                    d_blk4trd_amt,
                                                    d_payin_amt,
                                                    d_intadj_amt,
                                                    d_bnk_pipo_amt,
                                                    d_eba_pipo_amt,
                                                    d_bnk_bft_amt,
                                                    d_eba_bft_amt,
									                                  li_run_no,
                                                    c_bnk_narration,    /*** Ver 1.4 bnk_narration added ***/
                                                    c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                    c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                    c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                    c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                    c_blk_deposit_flg); /*** Ver 2.2 **/
 
										if ( i_rc != 0 )
										{
    									fn_errlog(c_ServiceName, "S32020",LIBMSG,c_err_msg);
      								strcpy( c_msg, "System error. Contact system support" );
  										fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    									tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
										}
    								tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  								}
									d_eba_pipo_amt = d_eba_pipo_amt + ( d_amount * (-1.0) );
            			d_bal_amt = d_bal_amt + d_amount;
									break;


            case 100 :
            break ;

     						case GENERAL_FAILURE :
     						case BLOCK_NOT_EXISTING :
     						case INSUF_FUNDS :
 									fn_errlog(c_ServiceName, "S32025",LIBMSG,c_err_msg);
      						sprintf(c_msg,"Error sending clr bal debit on Pay in to bank for %s",c_cln_mtch_accnt); 
  								fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
									i_rc 	=	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	
						        			                        c_xchng_cd, 
							        		                        c_cln_mtch_accnt, 
								        	                        c_run_dt, 
                                                  d_payout_amt,
                                                  d_blk4trd_amt,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_bnk_pipo_amt,
                                                  d_eba_pipo_amt,
                                                  d_bnk_bft_amt,
                                                  d_eba_bft_amt,
									                                li_run_no,
                                                  c_bnk_narration,  /*** Ver 1.4 bnk_narration added ***/
                                                  c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                  c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                  c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                  c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                  c_blk_deposit_flg); /*** Ver 2.2 **/

									if ( i_rc != 0 )
									{
    								fn_errlog(c_ServiceName, "S32030",LIBMSG,c_err_msg);
      							strcpy( c_msg, "System error. Contact system support" );
  									fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    								tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
									}
    							tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
									break;

     						case INDERMINATE_FAILURE :
     						case RERUN_FAILURE :								/*1.1:Added */
								default :
									/*** Insert into Failure table ***/
									i_ret_val = fn_ins_flr_tbl(	c_ServiceName,
																							c_xchng_cd,
																							c_cln_mtch_accnt,
																							li_run_no,
																							c_run_dt,
																							c_bnk_accnt,
																							DEBIT,
																							CLEAR_BALANCE_DEBIT_ON_PAYIN,
																							DEBIT, 
																							d_amount,
																							NOT_UPDATED,
																							NOT_UPDATED,
																							NOT_UPDATED,						/* Three more added by 1.1*/
																							c_reference,
																							c_timestamp,
                                              c_bnk_narration,    /*** Ver 1.4 bnk_narration added ***/
                                              c_blk_deposit_flg); /** Ver 2.2 ****/ 
           				if ( i_ret_val != 0 )
									{
      							strcpy( c_msg, "System error. Contact system support" );
  									fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
										i_rc 	=	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	
						    	       		                        c_xchng_cd, 
							    		                              c_cln_mtch_accnt, 
								    	                              c_run_dt, 
                                                    d_payout_amt,
                                                    d_blk4trd_amt,
                                                    d_payin_amt,
                                                    d_intadj_amt,
                                                    d_bnk_pipo_amt,
                                                    d_eba_pipo_amt,
                                                    d_bnk_bft_amt,
                                                    d_eba_bft_amt,
									                                  li_run_no,
                                                    c_bnk_narration,  /*** Ver 1.4 bnk_narration added ***/
                                                    c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                    c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                    c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                    c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                    c_blk_deposit_flg); /*** Ver 2.2 **/

										if ( i_rc != 0 )
										{
    									fn_errlog(c_ServiceName, "S32035",LIBMSG,c_err_msg);
      								strcpy( c_msg, "System error. Contact system support" );
  										fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    									tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
										}
    								tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
									}
      						sprintf(c_msg,"Indeterminate failure for %s in sending clr bal debit message on Payin to bank",c_cln_mtch_accnt); 
  								fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
									i_rc 	=	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	
						    			                            c_xchng_cd, 
							    		                            c_cln_mtch_accnt, 
								    	                            c_run_dt, 
                                                  d_payout_amt,
                                                  d_blk4trd_amt,
                                                  d_payin_amt,
                                                  d_intadj_amt,
                                                  d_bnk_pipo_amt,
                                                  d_eba_pipo_amt,
                                                  d_bnk_bft_amt,
                                                  d_eba_bft_amt,
									                                li_run_no,
                                                  c_bnk_narration,    /*** Ver 1.4 bnk_narration added ***/
                                                  c_payin_pool_acc_nse,  /*** Ver 2.2 **/
                                                  c_payout_pool_acc_nse, /*** Ver 2.2 **/
                                                  c_payin_pool_acc_bse, /*** Ver 2.2 **/
                                                  c_payout_pool_acc_bse, /*** Ver 2.2 **/
                                                  c_blk_deposit_flg); /*** Ver 2.2 **/

									if ( i_rc != 0 )
									{
    								fn_errlog(c_ServiceName, "S32040",LIBMSG,c_err_msg);
      							strcpy( c_msg, "System error. Contact system support" );
  									fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    								tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
									}
    							tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
									break;
								}/*End of switch*/
						}/*End of i_ch_val == INSUF_FUNDS*/
          }/* End of Payin for Block model */
        }/*End of d_bal_amt < 0 */
     } /* d_pipo_amt < 0 */  
     if ( d_bal_amt < 0 )
     {
  		 sprintf ( c_msg, "Balance [%lf] to be recovered from %s ", d_bal_amt, c_cln_mtch_accnt );
			 fn_userlog(c_ServiceName,c_msg);
			 /* Commented by Mohit on 21-Feb-2003 as asked by Prasannan ******
  		 	fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
			 */
     }
  }/* Bank payin process ends here */
 
   /*** Ver 2.2 starts *******/
 
  if( c_blk_deposit_flg == 'B')
  {
	 i_rc 	=	fn_insrt_pipo_rpt_tbl(	c_ServiceName,	
    			                        c_xchng_cd, 
	    		                        c_cln_mtch_accnt, 
		    	                        c_run_dt, 
                                  d_payout_amt,
                                  d_blk4trd_amt,
                                  d_payin_amt,
                                  d_intadj_amt,
                                  d_bnk_pipo_amt,
                                  d_eba_pipo_amt,
                                  d_bnk_bft_amt,
                                  d_eba_bft_amt,
			                            li_run_no, /*** Ver 1.4 bnk_narration added ***/
                                  c_bnk_narration,
                                  c_payin_pool_acc_nse,
                                  c_payout_pool_acc_nse,
                                  c_payin_pool_acc_bse,
                                  c_payout_pool_acc_bse,
                                  c_blk_deposit_flg);  

 }
 else
 {
   i_rc  = fn_insrt_pipo_rpt_tbl(   c_ServiceName,
                                   c_xchng_cd,
                                   c_cln_mtch_accnt,
                                   c_run_dt,
                                   d_payout_amt,
                                   0,
                                   d_payin_amt,
                                   d_intadj_amt,
                                   d_amount_recovered,
                                   d_amount_recovered,
                                   0,
                                   0,
                                   li_run_no,
                                   c_bnk_narration,
                                   c_payin_pool_acc_nse,
                                   c_payout_pool_acc_nse,
                                   c_payin_pool_acc_bse,
                                   c_payout_pool_acc_bse,
                                   c_blk_deposit_flg);

 }
 
  if ( i_rc != 0 )
  {
    fn_errlog(c_ServiceName, "S32045",LIBMSG,c_err_msg);
    strcpy( c_msg, "System error. Contact system support" );
    fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
 
  /****** Ver 2.2 Ends *******/
 
  /*sprintf ( c_msg, "Pay in Pay out process completed successfully for %s ", c_cln_mtch_accnt );
  fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );*/
	tpreturn( TPSUCCESS, SUCC_BFR, NULL, 0, 0 );
}

int fn_ins_flr_tbl(	char *c_ServiceName,	
										char *c_xchng_cd, 
										char *c_cln_mtch_accnt, 
										long	li_run_no,
										char *c_run_dt, 
										char *c_bnk_accnt_no, 
										char	c_trn_typ,
										int		i_block_cd,
										char	c_dr_cr_flg,
										double d_amount,
										char  c_bank_status,
										char	c_eba_status,
										char	c_process_status,									/* Three more added by 1.1*/
										char	*c_reference,
										char	*c_time,
                    char  *c_bnk_narration, /*** Ver 1.4 bnk_narration added ***/
                    char c_model_flg )   /*** Ver 2.2 model flag added ***/ 
{

	int i_trnsctn ;
	char c_err_msg[256];

	i_trnsctn = fn_begintran( c_ServiceName, c_err_msg ); 
	if ( i_trnsctn == -1 )
	{
		fn_errlog(c_ServiceName, "S32050",LIBMSG,c_err_msg);
		return ( FAILURE );
	}
/*
if(DEBUG_MSG_LVL_3){
  fn_userlog(c_ServiceName,"INSIDE Failier function........Start");
	fn_userlog(c_ServiceName,"c_xchng_cd [%s]",c_xchng_cd);
	fn_userlog(c_ServiceName,"c_cln_mtch_accnt [%s]",c_cln_mtch_accnt);
	fn_userlog(c_ServiceName,"li_run_no [%d]",li_run_no);
	fn_userlog(c_ServiceName,"c_run_dt [%s]",c_run_dt);
	fn_userlog(c_ServiceName,"c_bnk_accnt_no [%s]",c_bnk_accnt_no);
	fn_userlog(c_ServiceName,"c_trn_typ [%c]",c_trn_typ);
	fn_userlog(c_ServiceName,"i_block_cd [%d]",i_block_cd);
	fn_userlog(c_ServiceName,"c_dr_cr_flg [%c]",c_dr_cr_flg);
	fn_userlog(c_ServiceName,"d_amount [%lf]",d_amount);
	fn_userlog(c_ServiceName,"c_bank_status [%c]",c_bank_status);
	fn_userlog(c_ServiceName,"c_eba_status [%c]",c_eba_status);
	fn_userlog(c_ServiceName,"c_process_status [%c]",c_process_status);
	fn_userlog(c_ServiceName,"c_reference [%s]",c_reference);
	fn_userlog(c_ServiceName,"c_time [%s]",c_time);
  fn_userlog(c_ServiceName,"c_bnk_narration [%s]",c_bnk_narration);
  fn_userlog(c_ServiceName,"INSIDE Failier function........End");
}
*/

  if(DEBUG_MSG_LVL_3)
  {
   fn_userlog(c_ServiceName,"Before inserting values in FBM");
   fn_userlog(c_ServiceName,"c_xchng_cd :%s:",c_xchng_cd);
   fn_userlog(c_ServiceName,"c_cln_mtch_accnt :%s:",c_cln_mtch_accnt);
   fn_userlog(c_ServiceName,"li_run_no :%ld:",li_run_no);
   fn_userlog(c_ServiceName,"c_run_dt :%s:",c_run_dt);
   fn_userlog(c_ServiceName,"c_bnk_accnt_no :%s:",c_bnk_accnt_no);
   fn_userlog(c_ServiceName,"c_trn_typ :%c:",c_trn_typ);
   fn_userlog(c_ServiceName,"i_block_cd :%d:",i_block_cd);
   fn_userlog(c_ServiceName,"c_dr_cr_flg :%c:",c_dr_cr_flg);
   fn_userlog(c_ServiceName,"d_amount :%lf:",d_amount);
   fn_userlog(c_ServiceName,"c_bank_status :%c:",c_bank_status);
   fn_userlog(c_ServiceName,"c_eba_status :%c:",c_eba_status);
   fn_userlog(c_ServiceName,"c_process_status :%c:",c_process_status);
   fn_userlog(c_ServiceName,"c_reference :%s:",c_reference);
   fn_userlog(c_ServiceName,"c_time :%s:",c_time);
   fn_userlog(c_ServiceName,"c_bnk_narration :%s:",c_bnk_narration);
   fn_userlog(c_ServiceName,"c_model_flg :%c:",c_model_flg);
  } 
    


		EXEC SQL 
			INSERT INTO FBM_FO_BNK_FLR_MSG
			(
				FBM_XCHNG_CD,
				FBM_CLM_MTCH_ACCNT,
				FBM_RUN_NO,
				FBM_RUN_DT,
				FBM_BNK_ACCNT_NMBR,
				FBM_TRNSCTN_TYP,
				FBM_BLK_CD,
				FBM_DC_FLG,
				FBM_AMT,
				FBM_BNK_STTS,
				FBM_EBA_STTS,
				FBM_STTS,
				FBM_TRACE ,
				FBM_TIMESTAMP,
        FBM_NARRATION,           /*** Ver 1.4 ***/
        FBM_FUND_MODEL_FLG       /**** Ver 2.2 ***/
			)
			VALUES
			(
				:c_xchng_cd, 
				:c_cln_mtch_accnt, 
			  :li_run_no,
				to_date(:c_run_dt,'DD-Mon-YYYY'),
			  :c_bnk_accnt_no, 
				:c_trn_typ,
				:i_block_cd,
				:c_dr_cr_flg,
				:d_amount,
				:c_bank_status,
				:c_eba_status,
				:c_process_status,
				:c_reference,
		 /*   decode(:c_model_flg,'B',to_date(:c_time,'yyyymmddhh24miss'),NULL),*/	
         to_date(:c_time,'yyyymmddhh24miss'),
        :c_bnk_narration,        /*** Ver 1.4 ***/
        :c_model_flg /*** Ver 2.2 **/
			);

		if ( SQLCODE != 0 )
		{
			fn_errlog( c_ServiceName, "S32055",SQLMSG,c_err_msg);
      fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg ); 
			return ( FAILURE );
		}

		if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
		{    
 			fn_errlog( c_ServiceName, "S32060",LIBMSG,c_err_msg);
   		fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg ); 
			return ( FAILURE );
    }

	return ( SUCCESS );
}


int fn_insrt_pipo_rpt_tbl(	char *c_ServiceName,	
													char *c_xchng_cd, 
													char *c_cln_mtch_accnt, 
													char *c_run_dt, 
                          double d_payout_amt,
                          double d_blk4trd_amt,
                          double d_payin_amt,
                          double d_intadj_amt,
                          double d_bnk_pipo_amt,
                          double d_eba_pipo_amt,
                          double d_bnk_bft_amt,
                          double d_eba_bft_amt,
													long	li_run_no,
                          char *c_bnk_narration,   /*** Ver 1.4 bnk_narration added ***/
                          char *c_payin_pool_acc_nse, /*** Ver 2.2 **/
                          char *c_payout_pool_acc_nse,   /** Ver 2.2 **/
                          char *c_payin_pool_acc_bse,    /** Ver 2.2 ***/
                          char *c_payout_pool_acc_bse,  /** ver 2.2 **/ 
                          char c_model_flg)   /** Ver 2.2 ***/
{

	int i_trnsctn ;
	char c_err_msg[256];    
  char c_prdct_cd[4];       /*** Ver 2.2 ***/  /* VER TOL : TUX on LINUX -- Size increased from 3 to 4 (Ravindra) */
  char c_ibr_prdct_cd[11];   /*** Ver 2.2 ***/ 
  char c_pipo_typ='\0';     /*** Ver 2.2 ***/
  char c_pool_acc[20];      /*** Ver 2.2 ***/
  char c_othr_pool_acc[20]; /*** Ver 2.2 ***/


	i_trnsctn = fn_begintran( c_ServiceName, c_err_msg ); 

	if ( i_trnsctn == -1 )
	{
		fn_errlog(c_ServiceName, "S32065",LIBMSG,c_err_msg);
		return ( FAILURE );
	}

		EXEC SQL 
			INSERT INTO FTR_FO_TRNSCTN_RCRD
			(
				FTR_CLM_MTCH_ACCNT,
				FTR_XCHNG_CD,
				FTR_PIPO_DT,
				FTR_PO_AMT,
				FTR_BFT_AMT,
				FTR_PI_AMT,
				FTR_INT_ADJ_AMT,
				FTR_BNK_AMT,
				FTR_EBA_AMT,
				FTR_BFT_BNK_AMT,
				FTR_BFT_EBA_AMT,
				FTR_RUN_NO,
        FTR_NARRATION,              /*** Ver 1.4 ***/
        FTR_FUND_MODEL_FLG          /*** Ver 2.2 ***/
			)
			VALUES
			(
				:c_cln_mtch_accnt,
				:c_xchng_cd,
				to_date(:c_run_dt,'DD-Mon-YYYY'),
				:d_payout_amt,
				:d_blk4trd_amt,
       	:d_payin_amt,
				:d_intadj_amt,
				:d_bnk_pipo_amt,		 	
				:d_eba_pipo_amt,		 	
				:d_bnk_bft_amt,
				:d_eba_bft_amt,
				:li_run_no,
        :c_bnk_narration,         /*** Ver 1.4 ***/ 
        :c_model_flg              /**** Ver 2.2  ***/
			);


		if ( SQLCODE != 0 )
		{
			fn_errlog( c_ServiceName, "S32070",SQLMSG,c_err_msg);
      fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg ); 
			return ( FAILURE );
		}

   
     /***** Ver 2.2 starts ********/
 
    if(strcmp(c_xchng_cd,"BFO")==0 && c_model_flg=='D' )
    {
      strcpy(c_prdct_cd,"BFO");

      if(d_payin_amt!=0)
      {
         c_pipo_typ='I';
         strcpy(c_pool_acc,c_payin_pool_acc_nse);
         strcpy(c_othr_pool_acc,c_payin_pool_acc_bse);
         strcpy(c_ibr_prdct_cd,"BFOID");
      }
    
      if(d_payout_amt!=0)
      {
        c_pipo_typ='O';
        strcpy(c_pool_acc,c_payout_pool_acc_nse);
        strcpy(c_othr_pool_acc,c_payout_pool_acc_bse);
        strcpy(c_ibr_prdct_cd,"BFOOD");
       }
       
       rtrim(c_ibr_prdct_cd);

       EXEC SQL
       INSERT INTO PBP_PRD_BNK_PIPO
       (
         PBP_CLM_MTCH_ACCNT,
         PBP_PROD_CD,
         PBP_RUN_NO,
         PBP_RUN_DATE,
         PBP_PIPO_TYP,
         PBP_AMT,
         PBP_POOL_ACC,
         PBP_DBCR_FLG,
         PBP_PRCSS_FLG,
         PBP_TRACE,
         PBP_TIMESTAMP,
         PBP_DC_DATE,
         PBP_IBR_PRDCT_CD,
         PBP_INS_DATE,
         PBP_OTH_POOL_ACC
        )
        VALUES
        (
          :c_cln_mtch_accnt,
          :c_prdct_cd,
          :li_run_no,
          to_date(:c_run_dt,'DD-Mon-YYYY'),
          :c_pipo_typ,
          :d_bnk_pipo_amt,
          :c_pool_acc,
          'N',
          'N',
          NULL,
          NULL,
          NULL,
          :c_ibr_prdct_cd,
          SYSDATE,
         :c_othr_pool_acc
        );
      }

      if ( SQLCODE != 0 )
      {
        fn_errlog( c_ServiceName, "S32075",SQLMSG,c_err_msg);
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        return ( FAILURE );
      }

    /****** Ver 2.2 Ends ********/

		if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
		{    
 			fn_errlog( c_ServiceName, "S32080",LIBMSG,c_err_msg);
   		fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg ); 
			return ( FAILURE );
    }

	return ( SUCCESS );
} 

/********************** Ver 2.2 starts here *********************/

int fn_call_inc_dec_svc( double d_amt, char c_txn_typ, double *d_bnk_avl_amt, long li_run_no ,char *c_run_dt)
{
  FBFR32 *ptr_fml_Rbuf;
  FBFR32 *ptr_fml_Sbuf;

  char c_sgmnt_cd[20+1];
  char c_mdc_crdt_nmbr[20+1];
  char c_channel[4] = {'\0'};  /* VER TOL : TUX on LINUX -- Size changed from 3 to 4 (Ravindra) */
  char c_ip_add[15+1] = "\0";
  char c_called_svc[33];
  char c_bnk_nrtn[101];

  double d_clear_bal=0.0;

  MEMSET(c_sgmnt_cd);
  MEMSET(c_mdc_crdt_nmbr);
  MEMSET(c_channel);
  MEMSET(c_ip_add);
  MEMSET(c_called_svc);
  MEMSET(c_bnk_nrtn);

  l_tpurcode=0;       /* Ver 2.5 **/

  double d_amt_rs=0.0;
  strcpy(c_sgmnt_cd,"NFO");
  strcpy(c_channel,"SYS");
 

  d_amt_rs=d_amt/100;

  int i;
  int x;
  long li_len_tobuf=0;

  ptr_fml_Sbuf = (FBFR32 *)tpalloc( "FML32", NULL, MIN_FML_BUF_LEN );

  if(ptr_fml_Sbuf == NULL)
  {
    fn_errlog( c_ServiceName , "S32085", TPMSG, c_err_msg);
    fn_userlog( c_ServiceName, "tpalloc failed for ptr_fml_Sbuf");
    return -1;
  }

  ptr_fml_Rbuf = (FBFR32 *)tpalloc( "FML32", NULL, MIN_FML_BUF_LEN );

  if(ptr_fml_Rbuf == NULL)
  {
    fn_errlog( c_ServiceName , "S32090", TPMSG, c_err_msg);
    fn_userlog( c_ServiceName, "tpalloc failed for ptr_fml_Rbuf");
    tpfree((char *)ptr_fml_Sbuf);  
    return -1;
  }

  if( c_txn_typ == ALLOCATE_TO_SEGMENT || c_txn_typ == WALLET_UNBLOCK_DEBIT) /** Ver 2.4, WALLET_UNBLOCK_DEBIT added **/
  {
    strcpy( c_called_svc, "SVC_DEC_WALLET" );
    x=11;
    sprintf(c_bnk_nrtn,"NFO PI %s",c_run_dt); 
    rtrim(c_bnk_nrtn);
    fn_userlog(c_ServiceName,"narration for bank hit :%s:",c_bnk_nrtn);

  }
  if( c_txn_typ == CLEAR_BAL_TO_SGMNT_ALLOCATE )
  {
    strcpy( c_called_svc, "SVC_INC_WALLET" );
    x=12;
    /**** commented in ver 2.3 **  strcpy(c_bnk_nrtn,"NFO PI 18-Dec-2019");     **/  
    sprintf(c_bnk_nrtn,"NFO PI %s",c_run_dt); /** Ver 2.3 **/     
    rtrim(c_bnk_nrtn);
    fn_userlog(c_ServiceName,"narration for bank hit :%s:",c_bnk_nrtn);
  }

  if(DEBUG_MSG_LVL_3)
  {
   fn_userlog(c_ServiceName,"Service To be called |%s| ",c_called_svc );
   fn_userlog(c_ServiceName,"Transaction Type |%c|",c_txn_typ);
   fn_userlog(c_ServiceName,"User ID |%s| ",st_usr_prfl.c_user_id );
   fn_userlog(c_ServiceName,"Session ID |%ld| ",st_usr_prfl.l_session_id );
   fn_userlog(c_ServiceName,"Match Acc No |%s| ",st_usr_prfl.c_cln_mtch_accnt );
   fn_userlog(c_ServiceName,"Allcated Amount |%lf|",d_amt_rs );
   fn_userlog(c_ServiceName,"Channel |%s| ",c_channel );
   fn_userlog(c_ServiceName,"IP Address |%s| ",c_ip_add );
   fn_userlog(c_ServiceName,"d_amt_rs :%lf:",d_amt_rs);
   fn_userlog(c_ServiceName,"c_bnk_narration :%s:",c_bnk_narration);
   fn_userlog(c_ServiceName,"c_sgmnt_cd :%s:",c_sgmnt_cd);
   fn_userlog(c_ServiceName,"li_run_no :%ld:",li_run_no);
   fn_userlog(c_ServiceName,"c_bnk_accnt :%s:",c_bnk_accnt);
  }

  i_err[0] = Fadd32(ptr_fml_Sbuf,FML_USR_ID,(char *)st_usr_prfl.c_user_id, 0);
  i_err[1] = Fadd32(ptr_fml_Sbuf,FML_SSSN_ID,(char *)&st_usr_prfl.l_session_id,0);
  i_err[2] = Fadd32(ptr_fml_Sbuf,FML_EBA_MTCH_ACT_NO,(char *)st_usr_prfl.c_cln_mtch_accnt,0);
  i_err[3] = Fadd32(ptr_fml_Sbuf,FML_MSG_TYP,(char *)&c_txn_typ,0);
  i_err[4] = Fadd32(ptr_fml_Sbuf,FML_TRNSCTN_AMT,(char *)&d_amt_rs,0);
  i_err[5] = Fadd32(ptr_fml_Sbuf,FML_MDC_NARRATION,(char *)c_bnk_nrtn,0);
  i_err[6] = Fadd32(ptr_fml_Sbuf,FML_XCHNG_SG,(char *)c_sgmnt_cd,0);
  i_err[7] = Fadd32(ptr_fml_Sbuf,FML_VLME,(char *)&li_run_no,0);
  i_err[8] = Fadd32(ptr_fml_Sbuf,FML_USR_PASSWORD_ID,(char *)c_channel,0);
  i_err[9] = Fadd32(ptr_fml_Sbuf,FML_IP_ID,(char *)c_ip_add,0);
  i_err[10] = Fadd32(ptr_fml_Sbuf,FML_TRANS_TYP,(char *)c_seg_prdct_cd,0);  /*** IBR Product code sent for bank hit **/

  fn_userlog(c_ServiceName,"Extra fml required bank accnt :%s:",c_bnk_accnt);


  if(c_txn_typ == CLEAR_BAL_TO_SGMNT_ALLOCATE || c_txn_typ == WALLET_UNBLOCK_DEBIT)   /** ver 2.4 WALLET_UNBLOCK_DEBIT added **/
  {
   i_err[11] = Fadd32(ptr_fml_Sbuf,FML_ARD_BNK_ACCNT_NMBR,(char *)c_bnk_accnt,0);
  }

   /***** commented as it is common for both modes ***
  if(c_txn_typ == ALLOCATE_TO_SEGMENT )
  {
   i_err[10] = Fadd32(ptr_fml_Sbuf,FML_TRANS_TYP,(char *)c_seg_prdct_cd,0);
  }
  
   ************/

  for( i = 0 ; i < x ; i++ )
  {
    if(i_err[i] == -1)
    {
      fn_userlog(c_ServiceName,"Fadd failed for %d", i );
      fn_errlog(c_ServiceName,"L31055",FMLMSG,c_err_msg);
      tpfree((char *)ptr_fml_Sbuf);
      tpfree((char *)ptr_fml_Rbuf); 
      return -1;
    }
  }

  if(tpcall( c_called_svc,(char*)ptr_fml_Sbuf,0,(char **)&ptr_fml_Rbuf,&li_len_tobuf,0 ) == -1)
  {
    if(tperrno == TPESVCFAIL)
    {
      fn_userlog("TPESVCFAIL returned by |%s|",c_called_svc);

      if(Foccur32(ptr_fml_Rbuf, FML_ERR_MSG) > 0)
      {
        if(Fget32(ptr_fml_Rbuf,FML_ERR_MSG, 0, (char*)c_err_msg, 0 ) == -1)
        {
          fn_userlog(c_ServiceName,"error in fget of FML_ERR_MSG");
          fn_errlog(c_ServiceName,"S32095",FMLMSG,c_err_msg);
          tpfree((char *)ptr_fml_Sbuf);
          tpfree((char *)ptr_fml_Rbuf);
          return -1;
        }
      }

   if( c_txn_typ == CLEAR_BAL_TO_SGMNT_ALLOCATE || c_txn_typ == WALLET_UNBLOCK_DEBIT )
      {
        strcpy(c_trace, "************");


        i_err_cd = tpurcode;
        l_tpurcode = tpurcode;
 
        if(DEBUG_MSG_LVL_3)
        {
         fn_userlog(c_ServiceName,"tpurcode after call is |%ld|",tpurcode);
         fn_userlog(c_ServiceName,"l_tpurcode is |%ld|",l_tpurcode);
        }

       if (tpurcode != 116)  /** Ignoring Insufficient Funds case **/
       {

         if(Foccur32(ptr_fml_Rbuf, FML_SYSTEM_TRACE) > 0)
         {
           if(Fget32(ptr_fml_Rbuf,FML_SYSTEM_TRACE, 0, (char*)c_trace, 0 ) == -1)
           {
             fn_userlog(c_ServiceName,"error in fget of FML_SYSTEM_TRACE");
             fn_errlog(c_ServiceName,"S32100",FMLMSG,c_err_msg);
             tpfree((char *)ptr_fml_Sbuf);
             tpfree((char *)ptr_fml_Rbuf);
             return -1;
           }
         }

          MEMSET(c_tmstamp);

         if(Foccur32(ptr_fml_Rbuf, FML_TM) > 0)
         {
           if(Fget32(ptr_fml_Rbuf,FML_TM, 0, (char*)c_tmstamp, 0 ) == -1)
           {
             fn_userlog(c_ServiceName,"error in fget of FML_TM");
             fn_errlog(c_ServiceName,"S32105",FMLMSG,c_err_msg);
             tpfree((char *)ptr_fml_Sbuf);
             tpfree((char *)ptr_fml_Rbuf);
             return -1;
           }
         }

      }
      else
      {
         if(Fget32(ptr_fml_Rbuf,FML_AVLB_BAL,0,(char*)&d_clear_bal,0)== -1)
         {
          fn_userlog(c_ServiceName,"error in fget of FML_AVLB_BAL");
          fn_errlog(c_ServiceName,"S32110",FMLMSG,c_err_msg);
          tpfree((char *)ptr_fml_Sbuf);
          tpfree((char *)ptr_fml_Rbuf);
          return -1 ;
         }

         if(DEBUG_MSG_LVL_3)
         {
          fn_userlog(c_ServiceName," Inside Insufficient Balance , Available balance of customer :%lf:",d_clear_bal);
         }

         *d_bnk_avl_amt = d_clear_bal;
         if(DEBUG_MSG_LVL_3)
         {
          fn_userlog(c_ServiceName,"Bank available balance :%lf:",*d_bnk_avl_amt);
         }
        }
      }
      else
      {
       strcpy(c_trace," ");
      }
    }
    tpfree((char *)ptr_fml_Sbuf);  /* ver 2.5 */
    tpfree((char *)ptr_fml_Rbuf);  /* ver 2.5 */
    return -1;
   }

  if(Foccur32(ptr_fml_Rbuf, FML_SYSTEM_TRACE) > 0)
    {
     if(Fget32(ptr_fml_Rbuf,FML_SYSTEM_TRACE, 0, (char*)c_trace, 0 ) == -1)
     {
      fn_userlog(c_ServiceName,"error in fget of FML_ERR_MSG");
      fn_errlog(c_ServiceName,"S32115",FMLMSG,c_err_msg);
      tpfree((char *)ptr_fml_Sbuf);
      tpfree((char *)ptr_fml_Rbuf);
      return -1;
     }
   }

   if(DEBUG_MSG_LVL_3)
   {
    fn_userlog(c_ServiceName,"After Sucessful Payin to segment - Trace number for the transaction is :%s:",c_trace);
   }

  tpfree ( ( char * ) ptr_fml_Rbuf );
  tpfree ( ( char * ) ptr_fml_Sbuf ); 

  return 0;
}

/************ Ver 2.2 ends *****************/
/*** Ver 2.6 Starts here ***/
int fn_call_ud_fromeq( double d_amt, char c_account_typ, double *d_bnk_avl_amt, long li_run_no ,char *c_run_dt )
{
  FBFR32 *ptr_fml_Rbuf;
  FBFR32 *ptr_fml_Sbuf;

  char c_sgmnt_cd[20+1];
  char c_mdc_crdt_nmbr[20+1];
  char c_channel[4] = {'\0'};  /* VER TOL : TUX on LINUX -- Size chnaged from 3 to 4 (Ravindra) */
  char c_ip_add[15+1] = "\0";
  char c_called_svc[33];
  char c_bnk_nrtn[101];
  char c_sgmnt_type='\0';
  char c_model_flag='\0';
  double d_clear_bal=0.0;
  
  char c_prdct_typ='\0';
  

  MEMSET(c_sgmnt_cd);
  MEMSET(c_mdc_crdt_nmbr);
  MEMSET(c_channel);
  MEMSET(c_ip_add);
  MEMSET(c_called_svc);
  MEMSET(c_bnk_nrtn);

  l_tpurcode=0;    

  double d_amt_rs=0.0;
  strcpy(c_sgmnt_cd,"NFO");
  strcpy(c_channel,"SYS");

  int i;
  int x;
  long li_len_tobuf=0;

  ptr_fml_Sbuf = (FBFR32 *)tpalloc( "FML32", NULL, MIN_FML_BUF_LEN );

  if(ptr_fml_Sbuf == NULL)
  {
    fn_errlog( c_ServiceName , "S32120", TPMSG, c_err_msg);
    fn_userlog( c_ServiceName, "tpalloc failed for ptr_fml_Sbuf");
    return -1;
  }

  ptr_fml_Rbuf = (FBFR32 *)tpalloc( "FML32", NULL, MIN_FML_BUF_LEN );

  if(ptr_fml_Rbuf == NULL)
  {
    fn_errlog( c_ServiceName , "S32125", TPMSG, c_err_msg);
    fn_userlog( c_ServiceName, "tpalloc failed for ptr_fml_Rbuf");
    tpfree((char *)ptr_fml_Sbuf);
    return -1;
  }
  c_txn_typ='T';  /** Transfer ***/
  c_prdct_typ='E';
  c_sgmnt_type='F'; 
  c_model_flag='D';

  EXEC SQL
    SELECT ROUND(:d_amt,2)
      INTO :d_amt
      FROM DUAL;
  if(SQLCODE!=0)
  {
    fn_errlog( c_ServiceName , "S32130", SQLMSG, c_err_msg);
    fn_userlog( c_ServiceName, "tpalloc failed for ptr_fml_Rbuf");
    tpfree((char *)ptr_fml_Sbuf);
    tpfree((char *)ptr_fml_Rbuf);
    return -1;
  }

  /**c_account_typ='Y'; **/ 
 
  i_err[0] = Fadd32(ptr_fml_Sbuf,FML_USR_ID,(char *)st_usr_prfl.c_user_id, 0);
  i_err[1] = Fadd32(ptr_fml_Sbuf,FML_SSSN_ID,(char *)&st_usr_prfl.l_session_id,0);
  i_err[2] = Fadd32(ptr_fml_Sbuf,FML_ORD_CLM_MTCH_ACCNT,(char *)st_usr_prfl.c_cln_mtch_accnt,0);
  i_err[3] = Fadd32(ptr_fml_Sbuf,FML_RQST_TYP,(char *)&c_txn_typ,0);
  i_err[4] = Fadd32(ptr_fml_Sbuf,FML_TRNSCTN_AMT,(char *)&d_amt,0);
  i_err[5] = Fadd32(ptr_fml_Sbuf,FML_PRDCT_TYP,(char *)&c_prdct_typ,0);
  i_err[6] = Fadd32(ptr_fml_Sbuf,FML_DAM_TRNSCTN,(char *)&c_sgmnt_type,0);
  i_err[7] = Fadd32(ptr_fml_Sbuf,FML_EMP_FLAG,(char *)&c_model_flag,0);
  i_err[8] = Fadd32(ptr_fml_Sbuf,FML_VALID_FLAG,(char *)&c_account_typ,0);

  for( i = 0 ; i < 9 ; i++ )
  {
    if(i_err[i] == -1)
    {
      fn_userlog(c_ServiceName,"Fadd failed for %d", i );
      fn_errlog(c_ServiceName,"L31055",FMLMSG,c_err_msg);
      tpfree((char *)ptr_fml_Sbuf);
      tpfree((char *)ptr_fml_Rbuf);
      return -1;
    }
  }

  strcpy(c_called_svc,"SVC_MDFY_ALLOC");

  if(tpcall( c_called_svc,(char*)ptr_fml_Sbuf,0,(char **)&ptr_fml_Rbuf,&li_len_tobuf,0 ) == -1)
  {
    fn_errlog( c_ServiceName , "S32135", TPMSG, c_err_msg);
    fn_userlog( c_ServiceName, "tpalloc failed for ptr_fml_Rbuf");
    tpfree((char *)ptr_fml_Sbuf); 
    tpfree((char *)ptr_fml_Rbuf);
    return -1;
  }

  tpfree ( ( char * ) ptr_fml_Rbuf );
  tpfree ( ( char * ) ptr_fml_Sbuf );

return 0;
}
/** Ver 2.6 Ends Here ***/

int fn_eq_free_limit(double *d_eq_free)
{

 double d_allctd_amt=0;
 double d_trd_blk_amt=0;
 double d_Isec_mrgn_amt=0;
 double d_uncovered_bal=0;
 double d_tot_blk_amt=0;

 char c_pay_out_date[11+1];
 char c_cln_mtch_accnt[11];

    EXEC SQL
    SELECT    nvl(clm_allctd_amt,0),
              nvl(CLM_BLK_TRD_AMT,0),
              nvl(CLM_ISEC_MRGN_AMT_NSE,0) + nvl(CLM_ISEC_MRGN_AMT_BSE,0),
              TO_CHAR(SYSDATE,'DD-Mon-YYYY') 
    INTO      :d_allctd_amt,
              :d_trd_blk_amt,
              :d_Isec_mrgn_amt,
              :c_pay_out_date 
    FROM      clm_clnt_mstr
    WHERE     clm_mtch_accnt = :st_usr_prfl.c_cln_mtch_accnt;

    if (SQLCODE != 0 )  
    {
        fn_errlog( c_ServiceName , "S32140", SQLMSG, c_err_msg); 
        return -1;
    }


  strcpy(c_cln_mtch_accnt,st_usr_prfl.c_cln_mtch_accnt);
 
   EXEC SQL EXECUTE
      BEGIN get_alc_uncov_db
        (:c_cln_mtch_accnt,
         TO_DATE(:c_pay_out_date,'DD-Mon-YYYY'),
         :d_uncovered_bal);
      END;
   END-EXEC; 

   if (SQLCODE != 0 )
   {
      fn_errlog( c_ServiceName , "S32145", SQLMSG, c_err_msg);
      return -1;
  }

  fn_userlog(c_ServiceName,"d_uncovered_bal :%lf:",d_uncovered_bal);
  
  d_tot_blk_amt = d_allctd_amt+d_trd_blk_amt+d_Isec_mrgn_amt;
  fn_userlog(c_ServiceName,"d_uncovered_bal :%lf: d_tot_blk_amt :%lf: ",d_uncovered_bal,d_tot_blk_amt);
  *d_eq_free= d_tot_blk_amt - d_uncovered_bal;   
  fn_userlog(c_ServiceName,"d_eq_free:%lf: ",*d_eq_free);
}
