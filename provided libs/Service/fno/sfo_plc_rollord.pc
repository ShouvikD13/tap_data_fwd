/******************************************************************************/ 
/*  Program           : SFO_PLC_ROLLORD                                       */
/*                                                                            */
/*  Input             : FFO_USR_ID                                            */
/*                      FFO_SSSN_ID                                           */
/*                      FFO_EBA_MTCH_ACT_NO                                   */
/*                      FFO_PIPE_ID                                           */
/*                      FFO_TRD_PSSWD                                         */
/*                      FFO_OPERATION_TYP                                     */
/*                      FFO_XCHNG_CD [2]                                      */
/*                      FFO_PRDCT_TYP [2]                                     */
/*                      FFO_UNDRLYNG [2]                                      */
/*                      FFO_EXPRY_DT [2]                                      */
/*                      FFO_EXER_TYP [2]                                      */
/*                      FFO_OPT_TYP  [2]                                      */
/*                      FFO_STRK_PRC [2]                                      */
/*                      FFO_CTGRY_INDSTK [2]                                  */
/*                      FFO_ORDR_FLW [2]                                      */
/*                      FFO_LMT_MKT_SL_FLG [2]                                */
/*                      FFO_ORD_TOT_QTY [2]                                   */
/*                      FFO_LMT_RT [2]                                        */
/*                                                                            */
/*  Optional          : FFO_SETTLOR                                           */
/*                                                                            */
/*  Output            : FFO_ORDR_RFRNC [2]                                    */
/*                                                                            */
/*  Description       : This service is used to place rollover order    			*/
/*                                                                            */
/*  Log               : 1.0   22-Oct-2012   						                      */
/*  Log               : 1.1   23-Apr-2013   						                      */
/*  Log               : 1.2   18-Apr-2013   Infotech|Sandeep Patil            */
/*  Log               : 1.3   05-Jun-2013   Infotech|Bhushan Sonwane          */
/*  Log               : 1.4   16-Jul-2013   Infotech|Samip M                  */
/*  Log               : 1.5   06-Nov-2013   Infotech|Swati A.B                */
/*  Log               : 1.6   30-Jan-2014   Infotech|Mahesh Shinde            */
/*  Log               : 1.8   23-Sep-2014   Infotech|Bhushan Sonwane          */
/*  Log 							: 1.9   26-Feb-2015   Infotech|Sonu Jalap								*/
/*	Log								:	2.0   24-Apr-2015   Infotech|Ritesh Deolekar          */
/*  Log               : 2.1   25-Jun-2015   Infotech|Anand Dhopte             */
/*  Log               : 2.2   07_Aug-2015   Infotech|Bhupendra Malik          */
/*  Log               : 2.3   13_Aug-2015   Infotech|Ritesh Deolekar          */
/*  Log               : 2.5   29-Jun-2016   Infotech|Samip M                  */
/*  Log               : 2.6   14-Feb-2017		Infotech|Tanmay W.								*/
/*  Log               : 2.7   12-Dec-2017   Infotech|Mrinal K                 */
/*  Log               : 2.8   10-Nov-2017   Infotech|Bhushan Harekar | Parag  */
/*  Log               : 2.9   24-Oct-2019   Infotech|Tanmay Patel             */
/*  Log               : 3.0   20-Nov-2020   Infotech|Abhinav Kumbhar          */
/*  Log               : 3.1   01-Mar-2021   Infotech|Sachin Birje             */
/*  Log               : 3.2   28-Apr-2021   Infotech|Navina D.                */
/*  Log               : 3.3   18-May-2021   Infotech|Sandip T.                */
/*  Log               : 3.4   20-Aug-2021   Infotech|Sachin Birje             */
/*  Log               : 3.5   19-MAY-2022   Infotech|Suchita Dabir            */
/*  Log               : 3.6   21-Apr-2023   Dipin                             */ 
/******************************************************************************/
/*  1.0  -  New release                                                       */
/*	1.1	 -  BSE SPAN Changes																									*/
/*  1.2  -  Removal of second level trading password (CR-ISEC14-37738)        */
/*  1.3  -  Restrict DBC mapped customer to place order if CLM_TRD_FLG = 'N'  */
/*  1.4  -  Changes for Modify Allocation                                     */
/*  1.5  -  FNO limit Logging (Swati A.B)                                     */
/*  1.6  -  Disable rollover in ban period CR-ISEC14-40913 (Mahesh Shinde)    */
/*  1.8  -  Changes For DL .NET                                               */
/*  1.9  -  Changes for FFL																										*/ 
/*	2.0  -  Notional Profit/Loss Computation Changes For NON SPAN Customers 	*/ 
/*  2.1  -  Insufficient Limits - Modify Allocation changes for DL .Net       */
/*  2.2  -  Include changes for Insider trading check                         */
/*  2.3  -  Contract Master and Trade Quote Table Merger Changes              */
/*  2.5  -  Check Session IP Common Function                                  */
/*  2.6  -  Insider check bug fix																						  */
/*  2.7  -  Optimization                                                      */
/*	2.8  -  Rollover with Spread                                              */
/*  2.9  -  Ipv6 Format                                                       */
/*  3.0  -  Disallow Rollover if Rollover facility is Disabled for that       */
/*          Contract.		                                                      */
/*  3.1  -  Minor Change: Multileg Order in single pipe id                    */
/*  3.2  -  Action id handling for itrade                                     */
/*  3.3  -  Derivative_trd_restrict_CR_ISEC04_152948                          */
/*  3.4  -  Pipe ID Changes                                                   */
/*  3.5  -  CR-ISEC14-170898  System validation for placement of 2L and 3L market orders changes */
/*  3.6  -  Margin Reporting Regulatory Changes */
/******************************************************************************/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <atmi.h>
#include <fml32.h>
#include <sqlca.h>
#include <fo.h>
#include <fo_fml_def.h>
#include <fo_view_def.h>
#include <fn_session.h>
#include <fn_tuxlib.h>
#include <fn_ddr.h>
#include <fn_log.h> 
#include <fn_val_ord.h> 
#include <fml_rout.h>
#include <fn_read_debug_lvl.h>
#include <fn_pos.h>
#include <fn_span_lib.h>
#include <eba_to_ors.h>
#include <math.h>

EXEC SQL INCLUDE "table/ffp_fo_futures_pstn.h";
EXEC SQL INCLUDE "table/fop_fo_options_pstn.h";

/*** Ver 2.8 Comment Starts Here ***

int fn_chk_spn_mrgn  (  char *,
												struct vw_orderbook ,
												struct vw_orderbook ,
												struct st_pstn_actn *,
												double *,
												double *,
												char *
										 );	

int fn_chk_nrml_mrgn  (  char *,
                        struct vw_orderbook ,
                        struct vw_orderbook ,
												double *,	
												double *,	
                       	char *
                     );

int fn_upd_mrgn( char *,
                 struct vw_pstn_actn *,
                 struct vw_undfut_pos ,
                 struct vw_undfut_pos *,
                 struct vw_err_msg *);

**** Ver 2.8 Comment Ends Here ***/

/*** Ver 2.8 Starts ***/

int fn_chk_sprd_trdng_qt( char *c_ServiceName,
                          struct vw_orderbook ,
                          struct vw_orderbook ,
                           char c_sub_rqst_typ,   
                          char *c_err_msg
                        );

/*** Ver 2.8 Ends ***/

/*** Ver 1.4 ***/
double d_required_amt = 0.0;
/*** Ver 1.4 ***/

void SFO_PLC_ROLLORD ( TPSVCINFO *rqst )
{
  char  c_ServiceName[33];
  char  c_err_msg[256];
  char  c_regonize_error[256]; 
  char  c_trdng_psswrd_flg = YES;
  char  c_temp_psswrd[LEN_USR_TRDNG_PSSWRD];
  char  c_settlor_flg;
  char  c_spl_flg;
  char  c_srvc_nm[33];
  char  c_pipe_id[3];
  char  c_mleg_pipe_id[3];  /** Ver 3.1 **/
  char  c_channel[4];
  char  c_bp_id[9];
  char  c_alias[9];
  char  c_seq_num[9];
  char  c_sprdordr_rfrnc[19];
  char  c_sprd_ord_ind;
  char  c_opn_typ;
  char  c_sub_rqst_typ = '\0';              /*** Ver 2.8 ***/
  char  c_sprd_exp_dt1[ LEN_DATE ] = {'\0'}; /*** Ver 2.8 ***/
  char  c_sprd_exp_dt2[ LEN_DATE ] = {'\0'}; /*** Ver 2.8 ***/
  char  c_diff_mrgn_flg='\0';               /*** Ver 2.8 ***/
  char  c_diff_pnl_flg='\0';                /*** Ver 2.8 ***/
  char  c_usr_flg = '\0';                   /*** Ver 2.8 ***/
  char  c_warn_msg='N';
  char  c_fno_dmn_nm [ 16 ];
  char  c_fno_trg_nm [ 16 ];
  char  c_fno_trg_dat [ 256 ];
  char  c_ds_channel[4];
  char  c_spn_allwd_flg;
  char  c_cntrct_tag;
  char  c_dr_without_lmt_flg;
  char  c_narration_id[4];
	char	c_qt_trdng_flg;
	char	c_act_stts;
	char 	c_fcm_mrkt_typ;
  char c_actn_flg = '\0';      				 /*** Ver 1.5 ***/
	char  c_brkr_clsout_flg = '\0';      /*** Ver 1.6 ***/
  char  c_trdqt_flg = '\0';      			 /*** Ver 1.6 ***/
	char  c_rollover_flg = '\0';         /*** Ver 3.0 ***/
	char  c_source_flag = '\0';      					/*** Ver 1.8 ***/
  char  c_undrlyng_rollovr_flg = '\0';      /*** Ver 1.8 ***/
  char c_txn_flg='Y';             /*** Ver 2.5 ***/
  char c_ip_address[45+1]="\0";   /** Changed to 45 from 15 in Ver 2.9 **/  /*** Ver 2.5 ***/
	char c_sys_msg[4];							/*** Ver 2.8 ***/
	char c_xchng_rmrks[257];				/*** Ver 2.8 ***/
	
	int   i_err[ 20 ];
  int   i_ferr[ 20 ];
  int   i_returncode;
  int   i_trnsctn;
  int   i_cnt;
  int   i;
  int   i_ip_len;
  int   i_op_len;
  int   i_tot_rec;
  int   i_noof_rec=2;     /***  Ver 1.2 ***/
  int   i_ch_val;
  int   i_counter;
  int   i_is_dbc_cust = 0 ;            /***  Ver 1.3 ***/
  int		insider_exist = 0;              /*** Ver 2.2 ***/

  long  l_recvbuff;
  long  l_first_ord_qty;
  long  l_second_ord_qty;
  long  l_sprdord_seq_num;
  long  l_no_of_calls; 
  long  l_lot_size = 0; 
	long  l_lot_sz_near = 0;     /*** Ver 1.6 ***/
  long  l_lot_sz_far = 0;      /*** Ver 1.6 ***/
  long  l_cse_id  = 0;      /*** Ver 1.8 ***/
  long  l_mdfctn_cntr = 0;  /*** Ver 2.8 ***/

  int i_actn_id = -1;    

  double d_limit_amt = 0.0;
	double d_diff_mrgn = 0;
  double d_old_diff_mrgn = 0;   /*** Ver 2.8 ***/
  double d_old_diff_pnl =  0;   /*** Ver 2.8 ***/
  double d_new_diff_mrgn = 0;   /*** Ver 2.8 ***/
  double d_new_diff_pnl =  0;   /*** Ver 2.8 ***/
	double d_diff_pnl = 0;
	double d_total_def = 0;
	double d_balance_amt = 0;

  /*** Ver 1.4 ***/
  double d_required_diff_mrgn = 0.0;
  double d_required_diff_pnl = 0.0;
  char c_insuff_diff_mrgn = 'N';
  char c_insuff_diff_pnl = 'N';
  char c_insuff_flg = 'N';
  /*** Ver 1.4 ***/

  TPTRANID tranid  ; /*** Ver 1.5 ***/

  FBFR32 *ptr_fml_Ibuf;
  FBFR32 *ptr_fml_Obuf;
  FBFR32 *ptr_fml_Rbuf;
  FBFR32 *ptr_fml_Sbuf;

	EXEC SQL BEGIN DECLARE SECTION;
		/** struct vw_err_msg *ptr_st_err_msg; Ver 1.4 ***/
    struct vw_err_msg ptr_st_err_msg; /*** Ver 1.4 ***/
		struct st_err_msg *ptr_st_err;
    struct vw_usr_prfl st_usr_prfl;
    struct vw_orderbook st_ordbook;
    struct vw_gt_lmt_dtls st_gt_lmt_dtls;
		struct st_pstn_actn st_pstn_action;
		struct vw_pstn_actn ptr_st_pstn_actn_mn;
    varchar c_exp_dt[ LEN_DATE ];
    varchar c_usr_usr_psswrd[50+1];
    varchar c_trd_dt[LEN_DATE];
    varchar c_trade_dt[LEN_DATE];
    varchar c_date[LEN_DATE];
    char  c_exg_stts;
		long int li_opn_qty;
		long	l_session_id;
  EXEC SQL END DECLARE SECTION;

  struct vw_orderbook st_first_ordbk;
  struct vw_orderbook st_next_ordbk;
  struct vw_orderbook st_temp_ordbook;
  struct vw_err_msg   st_err_msg;
  struct vw_sequence  st_s_sequence;
  struct vw_sequence  st_r_sequence;
  struct vw_spdordbk  st_spd_ordbk;
  struct st_err_msg st_errmsg;

	MEMSET(st_pstn_action);
	MEMSET(st_ordbook);
	MEMSET(st_gt_lmt_dtls);
	MEMSET(st_usr_prfl);
	MEMSET(ptr_st_pstn_actn_mn);
	MEMSET(st_first_ordbk);
	MEMSET(st_next_ordbk);
	MEMSET(st_temp_ordbook);
	MEMSET(st_s_sequence);
	MEMSET(st_r_sequence);
	MEMSET(st_spd_ordbk);
  MEMSET(c_usr_usr_psswrd);     /***  Ver 1.2 ***/
	MEMSET(c_sys_msg);						/*** Ver 2.8 ***/
	MEMSET(c_xchng_rmrks);				/*** Ver 2.8 ***/
	
  MEMSET(c_temp_psswrd);   /** Ver 1.4 **/
  MEMSET(c_usr_usr_psswrd);  /** Ver 1.4 **/
  MEMSET(st_err_msg);       /** Ver 2.5 **/

  ptr_fml_Ibuf = (FBFR32 *)rqst->data;
  strcpy(c_ServiceName, rqst->name);
  INITDBGLVL(c_ServiceName);

  i_returncode = Fvftos32( ptr_fml_Ibuf,
                           (char *) &st_usr_prfl,
                           "vw_usr_prfl" );

  if ( i_returncode == -1 )
  {
    fn_errlog( c_ServiceName, "S31005", FMLMSG, c_err_msg  );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
    Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
		Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );		/*** Ver 3.2 ***/
    Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

	if(DEBUG_MSG_LVL_3)
  {
    fn_userlog( c_ServiceName, "User id       :%s:",  st_usr_prfl.c_user_id );
    fn_userlog( c_ServiceName, "Session id    :%ld:", st_usr_prfl.l_session_id );
    fn_userlog( c_ServiceName, "Match Account :%s:", 	st_usr_prfl.c_cln_mtch_accnt );
    fn_userlog( c_ServiceName, "Pipe id 			:%s:",	st_usr_prfl.c_pipe_id );
  }

  /***	fn_init_ddr_pop ( st_usr_prfl.c_pipe_id,TRADING_SECTION,COMMON); ** commented and moved below in Ver 1.8 ***/

  /************Commented in ver 1.2 *****************************

  i_ch_val = fn_unpack_fmltovar ( c_ServiceName,
                                  c_err_msg,
                                  ptr_fml_Ibuf,
                                  3,
                                  FFO_TRD_PSSWD, ( char * )c_usr_usr_psswrd.arr, NULL,
                                  FFO_XCHNG_CD,( char * )st_ordbook.c_xchng_cd, NULL,
                                  FFO_OPERATION_TYP,( char * )&c_opn_typ, NULL);

  if( i_ch_val != 0 )
  {
    fn_errlog( c_ServiceName, "S31010", FMLMSG , c_err_msg );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
    Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );    
    tpreturn( TPFAIL, ERR_BFR, ( char * )ptr_fml_Ibuf, 0, 0 );
  }

  ************** Comment Ends ver 1.2 ***************************/

  /******************* Ver 1.2 Starts ***************************/

  if(Fget32(ptr_fml_Ibuf,FFO_XCHNG_CD,0,(char *)&st_ordbook.c_xchng_cd,0) == -1)
  {
    fn_errlog( c_ServiceName, "S31015", FMLMSG, c_err_msg  );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
    Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
    Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
    Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  if(Fget32(ptr_fml_Ibuf,FFO_OPERATION_TYP,0,(char *)&c_opn_typ,0) == -1)
  {
    fn_errlog( c_ServiceName, "S31020", FMLMSG, c_err_msg  );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
    Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
    Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
    Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  if(Fget32(ptr_fml_Ibuf,FFO_TRD_PSSWD,0,(char *)&c_usr_usr_psswrd.arr,0) == -1)
  {

    if(Ferror32 != FNOTPRES)
    {
      fn_errlog( c_ServiceName, "S31025", FMLMSG, c_err_msg  );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

    if(Ferror32 == FNOTPRES)
    {
      if(DEBUG_MSG_LVL_3)
      {
        fn_userlog(c_ServiceName,"Trading password FML not present.");
      }
      c_trdng_psswrd_flg = NO;
    }
  }

  if(DEBUG_MSG_LVL_3)
  {
    fn_userlog(c_ServiceName,"Trading password flag is |%c|.",c_trdng_psswrd_flg);
  }

  /*********************** Ver 1.2 Ends ********************************/
  /*** Ver 2.8 Starts ***/

  if(Fget32(ptr_fml_Ibuf,FFO_RQST_TYP,0,(char *)&c_sub_rqst_typ,0) == -1)
  {
    if( Ferror32 == FNOTPRES )
    {
      if(DEBUG_MSG_LVL_3)
      {
        fn_userlog(c_ServiceName,"FFO_RQST_TYP FML is not present.");
      }
    }

    if(Ferror32 != FNOTPRES)
    {
      fn_errlog( c_ServiceName, "S31030", FMLMSG, c_err_msg  );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }
  }

  /*** Ver 2.8 Ends ***/

	if(Fget32(ptr_fml_Ibuf,FFO_CHANNEL,0,(char *)c_ds_channel,0) == -1) 
  {

    if(Ferror32 != FNOTPRES)
    {
      fn_errlog( c_ServiceName, "S31035", FMLMSG, c_err_msg  );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );     
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }
  }
	
	/***  Ver 1.8 Starts  ***/
	
	if(Fget32(ptr_fml_Ibuf,FFO_SOURCE_FLG,0,(char *)&c_source_flag,0) == -1)
  {

    if(Ferror32 != FNOTPRES)
    {
      fn_errlog( c_ServiceName, "S31040", FMLMSG, c_err_msg  );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

    if(Ferror32 == FNOTPRES)
    {
      if(DEBUG_MSG_LVL_3)
      {
        fn_userlog(c_ServiceName,"FFO_SOURCE_FLG FML not present.");
      }
    }
  }

 /*** Ver 2.2 Starts ** Commented in Ver 2.6 ********
   i_returncode = fn_chk_und_insider(c_ServiceName,
                                    st_usr_prfl,
                                    st_ordbook.c_undrlyng,
                                    &insider_exist);
  if (i_returncode == -1)
  {
      fn_errlog( c_ServiceName, "S31045", "Error in Function fn_chk_und_insider", c_err_msg);
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }

  if (insider_exist == 1)
  {
      fn_errlog( c_ServiceName, "B21042", DEFMSG, c_err_msg  );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
  *** Ver 2.2 Ends *** Commented in Ver 2.6 ********/


	if(c_source_flag == 'Y')       /*** For New Trade Racer ***/
  {
    strcpy(c_ds_channel ,"NET") ;

    if( st_usr_prfl.c_user_id[0] != BPID )
    {
      EXEC SQL
      SELECT  pcm_crnt_pipe_id
      INTO    :st_usr_prfl.c_pipe_id
      FROM    pcm_pipe_clm_map
      WHERE   pcm_xchng_cd       = :st_ordbook.c_xchng_cd
      AND     pcm_clm_mtch_accnt   = :st_usr_prfl.c_cln_mtch_accnt;

      if(SQLCODE != 0)
      {
        fn_errlog( c_ServiceName, "S31050",SQLMSG,c_err_msg);
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }
		else
    {
      fn_userlog(c_ServiceName, "Inside DBC user pipe id select");

      EXEC SQL
          SELECT  CIM_PIPE_ID
          INTO    :st_usr_prfl.c_pipe_id
          FROM    CIM_CTCL_ID_MSTR
          WHERE   CIM_DBC_CSE_ID = :st_usr_prfl.c_user_id
          AND     CIM_XCHNG_CD   = :st_ordbook.c_xchng_cd
          AND     CIM_INDCTR     = 'D'
          AND     NVL(CIM_CTCL_DEACT_FLG,' ')  = 'A';

      if( (SQLCODE != NO_DATA_FOUND) && (SQLCODE != 0))
      {
        fn_errlog( c_ServiceName, "S31055",SQLMSG,c_err_msg);
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 ); 
      }
      if(SQLCODE == NO_DATA_FOUND)
      {
        fn_errlog( c_ServiceName,"B56067",DEFMSG, c_err_msg );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 ); 
      }
    }
    fn_userlog( c_ServiceName, "Pipe id after select    :%s:",  st_usr_prfl.c_pipe_id );

  }
	else if(c_source_flag == 'Z')       /*** For New Trade Racer by super user ***/
  {
    strcpy(c_ds_channel ,"CN2") ;

    fn_userlog(c_ServiceName," st_usr_prfl.l_session_id Is :%ld: ", st_usr_prfl.l_session_id);

    EXEC SQL
        SELECT  NVL(USM_CSE_ID,0)
        INTO    :l_cse_id
        FROM    USM_SSSN_MNGR
        WHERE   USM_USR_ID  = :st_usr_prfl.c_user_id
        AND     USM_SSSN_ID = :st_usr_prfl.l_session_id;

    if(SQLCODE != 0)
    {
      fn_errlog( c_ServiceName, "S31060",SQLMSG,c_err_msg);
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

    fn_userlog(c_ServiceName,"CSE ID :%ld:",l_cse_id);
		
		EXEC SQL
         SELECT  CIM_PIPE_ID
         INTO    :st_usr_prfl.c_pipe_id
         FROM    CIM_CTCL_ID_MSTR
         WHERE   CIM_DBC_CSE_ID = to_char(:l_cse_id)
         AND     CIM_XCHNG_CD   = :st_ordbook.c_xchng_cd
         AND     CIM_INDCTR     = 'C'
         AND     NVL(CIM_CTCL_DEACT_FLG,' ') = 'A';

    if(SQLCODE != 0 && SQLCODE != NO_DATA_FOUND)
    {
      fn_errlog( c_ServiceName, "S31065", SQLMSG, c_err_msg  );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/ 
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

    if(SQLCODE == NO_DATA_FOUND)
    {
      fn_errlog( c_ServiceName,"B56067",DEFMSG, c_err_msg );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

    fn_userlog( c_ServiceName, "Pipe id after select    :%s:",  st_usr_prfl.c_pipe_id );
  }

  fn_init_ddr_pop ( st_usr_prfl.c_pipe_id,TRADING_SECTION,COMMON);

  /*** Ver 1.8 ** Ends ***/
	

  /***  Ver 1.3 Starts  ***/

  if( st_usr_prfl.c_user_id[0] != BPID )
  {
    i_is_dbc_cust = 0;

    EXEC SQL
        SELECT 1
            INTO :i_is_dbc_cust
        FROM  CLM_CLNT_MSTR
        WHERE CLM_MTCH_ACCNT = :st_usr_prfl.c_cln_mtch_accnt
        AND   CLM_TRD_FLG = 'N'
        AND   CLM_BP_ID IS NOT NULL;

    if( (SQLCODE != NO_DATA_FOUND) && (SQLCODE != 0))
    {
      fn_errlog( c_ServiceName, "S31070",SQLMSG,c_err_msg);
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 ); 
    }
    if ( i_is_dbc_cust == 1 )
    {
      fn_userlog(c_ServiceName,"Since you are Attached to a Direct Business Catalyst, this facility has been Disabled");
      fn_errlog( c_ServiceName, "B35018", "", c_err_msg  );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }
  }

  /***  Ver 1.3  Ends  ***/

	if(c_sub_rqst_typ != CANCEL)   /*** if condition added in Ver 2.8 ***/
	{
  /***  Ver 1.2 Starts  ***/

  if( strcmp(c_ds_channel,"WEB") != 0 )
  {
    i_returncode  = fn_lmt_excd_qty_rt  ( c_ServiceName,
                                          ptr_fml_Ibuf,
                                          &c_trdng_psswrd_flg,
                                          &st_usr_prfl,
                                          i_noof_rec,
                                          c_err_msg
                                        );

    if ( i_returncode !=  0 )
    {
      fn_errlog( c_ServiceName, "S31075", LIBMSG , c_err_msg );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }
  }
	}

  /***  Ver 1.2 Ends  ***/

  SETLEN ( c_usr_usr_psswrd );

  if(DEBUG_MSG_LVL_5)
  {
    fn_userlog( c_ServiceName, "Operation type :%c:",c_opn_typ );
    fn_userlog( c_ServiceName, "Channel is :%s:",c_ds_channel );
  }

  if ( c_trdng_psswrd_flg == YES )      /***  Ver 1.2 If Condition Added  ***/
  {
    strcpy( c_temp_psswrd, (char *)c_usr_usr_psswrd.arr );
  }

  /**** c_trdng_psswrd_flg = YES; Commented in Ver 1.2 ****/

	/*** Commented for Ver 2.5 ****
  i_returncode =  fn_check_user ( c_ServiceName,
   	                              &st_usr_prfl ,
     	                            c_temp_psswrd,
       	                          c_trdng_psswrd_flg,
         	                        &st_err_msg );
	*** Ver 2.5 ****/
  /*** Added for Ver 2.5 ****/
  i_returncode =  fn_check_user_ip ( c_ServiceName,
                                    &st_usr_prfl ,
                                    c_temp_psswrd,
                                    c_trdng_psswrd_flg,
                                    c_ip_address,
                                    c_txn_flg,
                                    &st_err_msg );
  /*** End for Ver 2.5 ***/

	if ( i_returncode == -1 )
  {
   	fn_errlog( c_ServiceName, "S31080", LIBMSG , c_err_msg );
   	Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, st_err_msg.c_err_msg, 0 );
   	i_actn_id = 1;
   	Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );  
    Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
    Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  if(DEBUG_MSG_LVL_5)
  {
    fn_userlog(c_ServiceName,"INSIDE 2L AREA");
		fn_userlog(c_ServiceName,"c_ip_address :%s:",c_ip_address);   /*** Ver 2.8 ***/
  }
	
  i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

  if ( i_trnsctn == -1 )
  {
    fn_errlog( c_ServiceName, "S31085", LIBMSG , c_err_msg );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
    Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 ); 
    Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
    Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  i_returncode = fn_lock_usr( c_ServiceName, st_usr_prfl.c_cln_mtch_accnt );

  if ( i_returncode == -1 )
  {
    fn_errlog( c_ServiceName, "S31090", LIBMSG , c_err_msg );
    fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
    Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
    Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
    Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
	
  EXEC SQL
    SELECT to_char( exg_nxt_trd_dt, 'DD-Mon-YYYY' ),
           to_char( exg_nxt_trd_dt, 'YYYYMMDD' ),
           exg_crrnt_stts
    INTO   :c_trd_dt,
           :c_date,
           :c_exg_stts
    FROM   exg_xchng_mstr
    WHERE  exg_xchng_cd = :st_ordbook.c_xchng_cd
    AND    exg_mkt_typ  = 'D';

  if ( SQLCODE != 0 )
  {
    fn_errlog( c_ServiceName, "S31095",SQLMSG,c_err_msg);
    fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
    Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
    Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
    Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  SETNULL ( c_trd_dt );
  SETNULL ( c_date );

	strcpy( st_s_sequence.c_trd_dt, (char *) c_trd_dt.arr ); 

	if( c_opn_typ != 'S' )		/*** 'if' condition added in Ver 2.8 ***/
	{

	if( c_exg_stts != EXCHANGE_OPEN )
  {
    fn_errlog( c_ServiceName, "S31100","Rollover Orders can be placed only when Exchange is open",c_err_msg);
		strcpy(c_err_msg,"Rollover orders can be placed only when the Exchange is open");
    fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
    Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
    Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
    Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

	} /*** 'if' end in Ver 2.8 **/

	c_usr_flg = 'W'; /*** Ver 2.8 ***/

	if ( c_opn_typ == 'R' )
  {
    i_tot_rec = 2;
    c_spl_flg = ROLLOVER;
		c_sprd_ord_ind = L2_ORDER;
  }
  else if( c_opn_typ == 'S' )   /*** else if added in Ver 2.8 ***/
  {
    i_tot_rec = 2;
    c_spl_flg = ROLLOVER_WITH_SPREAD;
    c_sprd_ord_ind = 'P';

    if(DEBUG_MSG_LVL_3)
    {
      fn_userlog(c_ServiceName,"Operation type |%c|",c_opn_typ);
      fn_userlog(c_ServiceName,"Sub_request type|%c|",c_sub_rqst_typ);
      fn_userlog(c_ServiceName,"c_spl_flg |%c|",c_spl_flg);
      fn_userlog(c_ServiceName,"c_sprd_ord_ind |%c|",c_sprd_ord_ind);
    }
  }
  else
  {
    strcpy( c_err_msg, "Invalid operation type");

    if(DEBUG_MSG_LVL_3)
    {
      fn_userlog( c_ServiceName, "Invalid operation type :%c:",c_opn_typ);
    }

    fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
    Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 ); 
    Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
    Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/ 
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    
  }

  ptr_fml_Sbuf = (FBFR32 *)tpalloc( "FML32", NULL, MIN_FML_BUF_LEN*3 );

  if ( ptr_fml_Sbuf == NULL )
  {
    fn_errlog( c_ServiceName, "S31105", TPMSG, c_err_msg  );
    fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
    Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 ); 
    Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
    Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  i_returncode = Fvstof32( ptr_fml_Sbuf, (char *) &st_usr_prfl, FUPDATE, "vw_usr_prfl" );

  if ( i_returncode == -1 )
  {
    fn_errlog( c_ServiceName, "S31110", FMLMSG, c_err_msg  );
    fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
    Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
    Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
    Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

	ptr_fml_Rbuf = (FBFR32 *)tpalloc( "FML32", NULL, MIN_FML_BUF_LEN*3 );

  if ( ptr_fml_Rbuf == NULL )
  {
    fn_errlog( c_ServiceName, "S31115", TPMSG, c_err_msg  );
    fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
    tpfree ( ( char * ) ptr_fml_Sbuf );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
    Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
    Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
    Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  ptr_fml_Obuf = (FBFR32 *)tpalloc( "FML32", NULL, MIN_FML_BUF_LEN*3 );

  if ( ptr_fml_Obuf == NULL )
  {
    fn_errlog( c_ServiceName, "S31120", TPMSG, c_err_msg  );
    fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
    tpfree ( ( char * ) ptr_fml_Sbuf );
    tpfree ( ( char * ) ptr_fml_Rbuf );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
    Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
    Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
    Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

	/*** Order Placement Starts ***/
  if( c_opn_typ == 'R' || ( c_opn_typ == 'S' && c_sub_rqst_typ == NEW ))  /**if condition added in Ver 2.8 **/
  {
	for( i_cnt=0; i_cnt < i_tot_rec; i_cnt++)
  {
    i_err[0]= Fget32(ptr_fml_Ibuf, FFO_XCHNG_CD,i_cnt, (char *)st_ordbook.c_xchng_cd, 0);
    i_ferr [ 0 ] = Ferror32;

    i_err[1]= Fget32(ptr_fml_Ibuf, FFO_PRDCT_TYP,i_cnt, (char *)&st_ordbook.c_prd_typ, 0);
    i_ferr [ 1 ] = Ferror32;

    i_err[2]= Fget32(ptr_fml_Ibuf, FFO_UNDRLYNG,i_cnt, (char *)st_ordbook.c_undrlyng, 0);
    i_ferr [ 2 ] = Ferror32;

    i_err[3]= Fget32(ptr_fml_Ibuf, FFO_EXPRY_DT,i_cnt, (char *)c_exp_dt.arr, 0);
    i_ferr [ 3 ] = Ferror32;

    i_err[4]= Fget32(ptr_fml_Ibuf, FFO_EXER_TYP,i_cnt, (char *)&st_ordbook.c_exrc_typ, 0);
    i_ferr [ 4 ] = Ferror32;

    i_err[5]= Fget32(ptr_fml_Ibuf, FFO_OPT_TYP,i_cnt, (char *)&st_ordbook.c_opt_typ, 0);
    i_ferr [ 5 ] = Ferror32;

    i_err[6]= Fget32(ptr_fml_Ibuf, FFO_STRK_PRC,i_cnt, (char *)&st_ordbook.l_strike_prc, 0);
    i_ferr [ 6 ] = Ferror32;

    i_err[7]= Fget32(ptr_fml_Ibuf, FFO_CTGRY_INDSTK,i_cnt, (char *)&st_ordbook.c_ctgry_indstk, 0);
    i_ferr [ 7 ] = Ferror32;

    i_err[8]= Fget32(ptr_fml_Ibuf, FFO_ORDR_FLW,i_cnt, (char *)&st_ordbook.c_ordr_flw, 0);
    i_ferr [ 8 ] = Ferror32;

    i_err[9]= Fget32(ptr_fml_Ibuf, FFO_LMT_MKT_SL_FLG,i_cnt, (char *)&st_ordbook.c_slm_flg, 0);
    i_ferr [ 9 ] = Ferror32;

    i_err[10]= Fget32(ptr_fml_Ibuf, FFO_ORD_TOT_QTY,i_cnt, (char *)&st_ordbook.l_ord_tot_qty, 0);
    i_ferr [ 10 ] = Ferror32;

    i_err[11]= Fget32(ptr_fml_Ibuf, FFO_LMT_RT,i_cnt, (char *)&st_ordbook.l_ord_lmt_rt, 0);
    i_ferr [ 11 ] = Ferror32;

    i_err[12]= Fget32(ptr_fml_Ibuf, FFO_CHANNEL,i_cnt, (char *)st_ordbook.c_channel, 0); 
    i_ferr [ 12 ] = Ferror32;

    for(i=0; i < 14; i++)
    {
      if ( (i_err[ i ] == -1 ) )
      {
        fn_errlog( c_ServiceName, "S31125", Fstrerror32(i_ferr[i]),c_err_msg);
        fn_userlog(c_ServiceName,"Error in field %d in record no %d",i,i_cnt );
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
		}

     /*** Ver 2.6 Starts ***/ /** Ver 3.3 comment starts as same covered in order placement service ****
     if(DEBUG_MSG_LVL_0)
     {
      fn_userlog(c_ServiceName, "st_ordbook.c_undrlyng is :%s:",st_ordbook.c_undrlyng );
     }
      i_returncode = fn_chk_und_insider(c_ServiceName,
                                        st_usr_prfl,
                                        st_ordbook.c_undrlyng,
                                      &insider_exist);
      if (i_returncode == -1)
      {
        	fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        	tpfree ( ( char * ) ptr_fml_Sbuf );
        	tpfree ( ( char * ) ptr_fml_Rbuf );
        	tpfree ( ( char * ) ptr_fml_Obuf );
          fn_errlog( c_ServiceName, "S31130", "Error in Function fn_chk_und_insider", c_err_msg);
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        	Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
        	Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); 
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      if (insider_exist == 1)
      {
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        fn_errlog( c_ServiceName, "B21042", DEFMSG, c_err_msg  );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      } **** Ver 3.3comment ends **/
      /*** Ver 2.6 Ends ***/



    if(st_usr_prfl.c_user_id[0] == BPID)
    {
      if(Fget32(ptr_fml_Ibuf,FFO_ALIAS,i_cnt,(char *)c_alias,0) == -1)
      {
        fn_errlog( c_ServiceName, "S31135", FMLMSG, c_err_msg  );
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }

    SETLEN(c_exp_dt);

    strcpy ( st_ordbook.c_expry_dt, ( char * ) c_exp_dt.arr );

		/***	Added In Ver 1.8	***/

		fn_userlog(c_ServiceName,"Source Flag :%c:",c_source_flag);

		if ( c_source_flag == 'Y' )
		{
			strcpy(st_ordbook.c_channel,"NET");
		}
		else if ( c_source_flag == 'Z' )
		{
			strcpy(st_ordbook.c_channel,"CN2");
		}

		/***	Ver 1.8 Ends 	***/

    if(DEBUG_MSG_LVL_0)
    {
      fn_userlog( c_ServiceName, "Input Data for order no :%d:",i_cnt);
      fn_userlog( c_ServiceName, "Exchange code :%s:", st_ordbook.c_xchng_cd );
      fn_userlog( c_ServiceName, "Product Type  :%c:", st_ordbook.c_prd_typ );
      fn_userlog( c_ServiceName, "Underlyng     :%s:", st_ordbook.c_undrlyng );
      fn_userlog( c_ServiceName, "Expiry date   :%s:", st_ordbook.c_expry_dt);
      fn_userlog( c_ServiceName, "Excercise Type:%c:", st_ordbook.c_exrc_typ );
      fn_userlog( c_ServiceName, "Option type   :%c:", st_ordbook.c_opt_typ );
      fn_userlog( c_ServiceName, "Strike price  :%ld:", st_ordbook.l_strike_prc );
      fn_userlog( c_ServiceName, "Category      :%c:", st_ordbook.c_ctgry_indstk );
      fn_userlog( c_ServiceName, "Order flow B/S:%c:", st_ordbook.c_ordr_flw );
      fn_userlog( c_ServiceName, "Lmt/Mkt/StpLss:%c:", st_ordbook.c_slm_flg );
      fn_userlog( c_ServiceName, "Order Qty     :%ld:", st_ordbook.l_ord_tot_qty );
      fn_userlog( c_ServiceName, "Limit rate    :%ld:", st_ordbook.l_ord_lmt_rt );
      fn_userlog( c_ServiceName, "CHANNEL   :%s:", st_ordbook.c_channel);
      fn_userlog( c_ServiceName, "ALIAS   :%s:", c_alias);
    }

		if ( st_ordbook.l_ord_tot_qty <= 0 )      /***  Ver 1.2 ***/
    {
      fn_userlog( c_ServiceName,"Quantity cannot be Zero.");
      fn_errlog( c_ServiceName, "B14012",DEFMSG,c_err_msg);
      fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
      tpfree ( ( char * ) ptr_fml_Sbuf );
      tpfree ( ( char * ) ptr_fml_Rbuf );
      tpfree ( ( char * ) ptr_fml_Obuf );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

		strcpy ( st_pstn_action.c_cln_mtch_accnt,st_usr_prfl.c_cln_mtch_accnt);
  	strcpy ( st_pstn_action.c_xchng_cd, st_ordbook.c_xchng_cd );
		strcpy ( ptr_st_pstn_actn_mn.c_cln_mtch_accnt,st_usr_prfl.c_cln_mtch_accnt);
  	strcpy ( ptr_st_pstn_actn_mn.c_xchng_cd, st_ordbook.c_xchng_cd );
	  /*** ver 3.5 starts *************/
    if( c_opn_typ == 'R' && st_ordbook.c_slm_flg == 'M' ) 	
    {
            fn_userlog( c_ServiceName,"pls try limit order or rollover using spread");  
            MEMSET(c_err_msg);
            strcpy(c_err_msg,"Market orders are not allowed.Please try placing limit order or rollover with spread");
            rtrim( c_err_msg );
            /* fn_errlog( c_ServiceName, "B28551",DEFMSG,c_err_msg); */
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            tpfree ( ( char * ) ptr_fml_Sbuf );
            tpfree ( ( char * ) ptr_fml_Rbuf );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); 
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }
    /*** ver 3.5 ends ***/
		if(i_cnt == 0 )
    {
			strcpy(st_first_ordbk.c_cln_mtch_accnt, st_usr_prfl.c_cln_mtch_accnt);
      st_first_ordbk.l_ord_tot_qty = st_ordbook.l_ord_tot_qty;
      strcpy(st_first_ordbk.c_xchng_cd ,st_ordbook.c_xchng_cd);
      st_first_ordbk.c_prd_typ = st_ordbook.c_prd_typ;
      strcpy(st_first_ordbk.c_undrlyng ,st_ordbook.c_undrlyng);
      strcpy(st_first_ordbk.c_expry_dt ,st_ordbook.c_expry_dt);
      st_first_ordbk.c_exrc_typ = st_ordbook.c_exrc_typ;
      st_first_ordbk.c_opt_typ = st_ordbook.c_opt_typ;
      st_first_ordbk.l_strike_prc = st_ordbook.l_strike_prc;
			st_first_ordbk.c_ordr_flw   = st_ordbook.c_ordr_flw;
			st_first_ordbk.l_ord_lmt_rt  = st_ordbook.l_ord_lmt_rt;
			st_first_ordbk.c_ctgry_indstk	=	st_ordbook.c_ctgry_indstk;
      st_first_ordbk.c_slm_flg = st_ordbook.c_slm_flg;
			strcpy(st_first_ordbk.c_pipe_id,st_usr_prfl.c_pipe_id);
      st_first_ordbk.c_spl_flg = c_spl_flg;             /*** Ver 2.8 ***/
      strcpy(c_sprd_exp_dt1,st_first_ordbk.c_expry_dt); /*** Ver 2.8 ***/
    }
    else
    {
			strcpy(st_next_ordbk.c_cln_mtch_accnt, st_usr_prfl.c_cln_mtch_accnt);
      st_next_ordbk.l_ord_tot_qty = st_ordbook.l_ord_tot_qty;
      strcpy(st_next_ordbk.c_xchng_cd ,st_ordbook.c_xchng_cd);
      st_next_ordbk.c_prd_typ = st_ordbook.c_prd_typ;
      strcpy(st_next_ordbk.c_undrlyng ,st_ordbook.c_undrlyng);
      strcpy(st_next_ordbk.c_expry_dt ,st_ordbook.c_expry_dt);
      st_next_ordbk.c_exrc_typ = st_ordbook.c_exrc_typ;
      st_next_ordbk.c_opt_typ = st_ordbook.c_opt_typ;
      st_next_ordbk.l_strike_prc = st_ordbook.l_strike_prc;
			st_next_ordbk.c_ordr_flw   = st_ordbook.c_ordr_flw;
			st_next_ordbk.l_ord_lmt_rt  = st_ordbook.l_ord_lmt_rt;
      st_next_ordbk.c_ctgry_indstk = st_ordbook.c_ctgry_indstk;
      st_next_ordbk.c_slm_flg = st_ordbook.c_slm_flg;
			strcpy(st_next_ordbk.c_pipe_id,st_usr_prfl.c_pipe_id);
      st_next_ordbk.c_spl_flg = c_spl_flg;   						/*** Ver 2.8 ***/
			strcpy(c_sprd_exp_dt2,st_next_ordbk.c_expry_dt);	/*** Ver 2.8 ***/

      if( ( strcmp(st_first_ordbk.c_xchng_cd,st_next_ordbk.c_xchng_cd)==0) &&
          (st_first_ordbk.c_prd_typ == st_next_ordbk.c_prd_typ)            &&
          ( strcmp(st_first_ordbk.c_undrlyng,st_next_ordbk.c_undrlyng)==0) &&
          ( strcmp(st_first_ordbk.c_expry_dt,st_next_ordbk.c_expry_dt)==0) &&
          (st_first_ordbk.c_exrc_typ == st_next_ordbk.c_exrc_typ)          &&
          (st_first_ordbk.c_opt_typ == st_next_ordbk.c_opt_typ)            &&
          (st_first_ordbk.l_strike_prc == st_next_ordbk.l_strike_prc)        )
          {
            fn_errlog( c_ServiceName, "B28551",DEFMSG,c_err_msg);
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            tpfree ( ( char * ) ptr_fml_Sbuf );
            tpfree ( ( char * ) ptr_fml_Rbuf );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
          }

		/*** Commented in Ver 2.3  ***

			EXEC SQL
    		SELECT	fcm_qt_trdng_flg,
       					fcm_act_stts,
       					fcm_mrkt_typ
    		INTO   	:c_qt_trdng_flg,
       					:c_act_stts,
       					:c_fcm_mrkt_typ            
    		FROM   fcm_fo_cntrct_mstr
    		WHERE   fcm_xchng_cd = :st_next_ordbk.c_xchng_cd
    		AND     fcm_prdct_typ ='F' 
    		AND     fcm_undrlyng = :st_next_ordbk.c_undrlyng 
    		AND     fcm_expry_dt = to_date (:st_next_ordbk.c_expry_dt ,'dd-Mon-yyyy' )
    		AND     fcm_exer_typ = :st_next_ordbk.c_exrc_typ
    		AND     fcm_opt_typ  = :st_next_ordbk.c_opt_typ  
    		AND     fcm_strk_prc = :st_next_ordbk.l_strike_prc; 

		*** Ver 2.3 Comment Ends ***/
		/*** Ver 2.8 Starts ***/

    if( c_opn_typ == 'S' )
    {
      i_returncode = fn_chk_sprd_trdng_qt(c_ServiceName,st_first_ordbk,st_next_ordbk,c_sub_rqst_typ,c_err_msg);

      if( i_returncode != 0 )
      {
        fn_userlog( c_ServiceName, "Error inside fn_chk_sprd_trdng_qt");
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        fn_errlog( c_ServiceName, "S28551",LIBMSG,c_err_msg);
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }
    else
    {
		/*** Ver 2.8 Ends ***/

		/*** Ver 2.3 Starts ***/

			EXEC SQL
        SELECT  ftq_qt_trdng_flg,
                ftq_act_stts,
                ftq_mrkt_typ
        INTO    :c_qt_trdng_flg,
                :c_act_stts,
                :c_fcm_mrkt_typ
        FROM    ftq_fo_trd_qt
        WHERE   ftq_xchng_cd = :st_next_ordbk.c_xchng_cd
        AND     ftq_prdct_typ ='F'
        AND     ftq_undrlyng = :st_next_ordbk.c_undrlyng
        AND     ftq_expry_dt = to_date (:st_next_ordbk.c_expry_dt ,'dd-Mon-yyyy' )
        AND     ftq_exer_typ = :st_next_ordbk.c_exrc_typ
        AND     ftq_opt_typ  = :st_next_ordbk.c_opt_typ
        AND     ftq_strk_prc = :st_next_ordbk.l_strike_prc;

		/*** Ver 2.3 Ends ***/

    	if(SQLCODE != 0 && SQLCODE != NO_DATA_FOUND)
    	{
     		fn_errlog( c_ServiceName, "S31140",SQLMSG,c_err_msg); 
    		fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
				tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
     		Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
     	  Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
				Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );    /*** Ver 3.2 ***/
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
       	tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
			}

			/*** Commented in Ver 2.3 ***

    	if(DEBUG_MSG_LVL_5)
    	{
      	fn_userlog( c_ServiceName, "c_fcm_mrkt_typ:%c:", c_fcm_mrkt_typ);
    	}

			*** Ver 2.3 Ends ***/

			if(DEBUG_MSG_LVL_0) /*** added in Ver 2.3 ***/
      {
				fn_userlog( c_ServiceName, "c_fcm_mrkt_typ:%c:", c_fcm_mrkt_typ);
        fn_userlog( c_ServiceName, "c_qt_trdng_flg :%c:", c_qt_trdng_flg);
        fn_userlog( c_ServiceName, "c_act_stts :%c:", c_act_stts);
      }

    	if( ( c_qt_trdng_flg != 'T' ) || ( SQLCODE == NO_DATA_FOUND ) )
    	{
      	fn_errlog( c_ServiceName, "B28514", " ",c_err_msg );
      	fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
				tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
      	Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
				Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );    /*** Ver 3.2 ***/
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
      	tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 ); 
   		} 

			if( c_act_stts != 'A' )
    	{
      	fn_errlog( c_ServiceName, "B28515", " ",c_err_msg );
      	fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
				tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
      	Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
				Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );    /*** Ver 3.2 ***/
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
      	tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 ); 
    	}

			/*** Added in Ver 1.6 ***/

       EXEC SQL
          SELECT  NVL(FUM_BRKR_CLSOUT_FLG,'N'),
                  NVL(FUM_QT_TRDNG_FLG,'Q'),
									NVL(FUM_ROLLOVER_FLAG,'Q')                   /*** Ver 3.0 ***/
          INTO    :c_brkr_clsout_flg,
                  :c_trdqt_flg,
									:c_rollover_flg
          FROM    FUM_FO_UNDRLYNG_MSTR
          WHERE   FUM_UNDRLYNG  = :st_first_ordbk.c_undrlyng
          AND     FUM_PRDCT_TYP = :st_first_ordbk.c_prd_typ
          AND     FUM_XCHNG_CD  = :st_first_ordbk.c_xchng_cd;

					if ( SQLCODE != 0 )
          {
            fn_errlog ( c_ServiceName, "S31145", SQLMSG, c_err_msg );
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            tpfree ( ( char * ) ptr_fml_Sbuf );
            tpfree ( ( char * ) ptr_fml_Rbuf );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
						Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );    /*** Ver 3.2 ***/
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
          }

        if(DEBUG_MSG_LVL_0)
        {
          fn_userlog( c_ServiceName, "Broker closeout flag is :%c:",c_brkr_clsout_flg);
          fn_userlog( c_ServiceName, "Trading quoate  flag is :%c:",c_trdqt_flg);
        }

        if (c_brkr_clsout_flg == 'Y')
        {
            fn_userlog( c_ServiceName, "Broker in closeout for |%s|",st_first_ordbk.c_undrlyng);
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            fn_errlog( c_ServiceName, "B28514", " ",c_err_msg );
            tpfree ( ( char * ) ptr_fml_Sbuf );
            tpfree ( ( char * ) ptr_fml_Rbuf );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
						Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );    /*** Ver 3.2 ***/
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }

																	/*** Ver 3.0 START new check for Rollover flag ***/
				if( c_rollover_flg != 'T')
   			{
            fn_userlog( c_ServiceName, "This contract is not enabled for Rollover.");
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
     				fn_errlog( c_ServiceName, "B11111", " " ,c_err_msg );
            tpfree ( ( char * ) ptr_fml_Sbuf );
            tpfree ( ( char * ) ptr_fml_Rbuf );
            tpfree ( ( char * ) ptr_fml_Obuf );
     				Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
						Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );    /*** Ver 3.2 ***/
						Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 3.2 **/
     				tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   			}
																	/*** Ver 3.0 END ***/

				if ( c_trdqt_flg == 'Q')
        {
				/*** Commented in Ver 2.3  ***			

          EXEC SQL
            SELECT  FCM_LOT_SZ
            INTO :l_lot_sz_near
            FROM  FCM_FO_CNTRCT_MSTR
            WHERE FCM_XCHNG_CD    = :st_first_ordbk.c_xchng_cd
            AND   FCM_PRDCT_TYP   = :st_first_ordbk.c_prd_typ
            AND   FCM_INDSTK      = :st_first_ordbk.c_ctgry_indstk
            AND   FCM_UNDRLYNG    = :st_first_ordbk.c_undrlyng
            AND   FCM_EXPRY_DT    = :st_first_ordbk.c_expry_dt
            AND   FCM_EXER_TYP    = :st_first_ordbk.c_exrc_typ
            AND   FCM_OPT_TYP     = :st_first_ordbk.c_opt_typ
            AND   FCM_STRK_PRC    = :st_first_ordbk.l_strike_prc;

				*** Ver 2.3 Comment Ends ***/

				/*** Ver 2.3 Starts ***/

					EXEC SQL
            SELECT  FTQ_MIN_LOT_QTY
            INTO :l_lot_sz_near
            FROM  FTQ_FO_TRD_QT
            WHERE FTQ_XCHNG_CD    = :st_first_ordbk.c_xchng_cd
            AND   FTQ_PRDCT_TYP   = :st_first_ordbk.c_prd_typ
            AND   FTQ_INDSTK      = :st_first_ordbk.c_ctgry_indstk
            AND   FTQ_UNDRLYNG    = :st_first_ordbk.c_undrlyng
            AND   FTQ_EXPRY_DT    = :st_first_ordbk.c_expry_dt
            AND   FTQ_EXER_TYP    = :st_first_ordbk.c_exrc_typ
            AND   FTQ_OPT_TYP     = :st_first_ordbk.c_opt_typ
            AND   FTQ_STRK_PRC    = :st_first_ordbk.l_strike_prc;	

				/*** Ver 2.3 Ends ***/

          if ( SQLCODE != 0 )
          {
            fn_errlog ( c_ServiceName, "S31150", SQLMSG, c_err_msg );
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            tpfree ( ( char * ) ptr_fml_Sbuf );
            tpfree ( ( char * ) ptr_fml_Rbuf );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
						Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );    /*** Ver 3.2 ***/
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
           
          }

				/*** Commented in Ver 2.3  ***

          EXEC SQL
            SELECT  FCM_LOT_SZ
            INTO :l_lot_sz_far
            FROM  FCM_FO_CNTRCT_MSTR
            WHERE FCM_XCHNG_CD    = :st_next_ordbk.c_xchng_cd
            AND   FCM_PRDCT_TYP   = :st_next_ordbk.c_prd_typ
            AND   FCM_INDSTK      = :st_next_ordbk.c_ctgry_indstk
            AND   FCM_UNDRLYNG    = :st_next_ordbk.c_undrlyng
            AND   FCM_EXPRY_DT    = :st_next_ordbk.c_expry_dt
            AND   FCM_EXER_TYP    = :st_next_ordbk.c_exrc_typ
            AND   FCM_OPT_TYP     = :st_next_ordbk.c_opt_typ
            AND   FCM_STRK_PRC    = :st_next_ordbk.l_strike_prc;

				*** Ver 2.3 Comment Ends ***/

				/*** Ver 2.3 Starts ***/

					EXEC SQL
            SELECT  FTQ_MIN_LOT_QTY
            INTO :l_lot_sz_far
            FROM  FTQ_FO_TRD_QT
            WHERE FTQ_XCHNG_CD    = :st_next_ordbk.c_xchng_cd
            AND   FTQ_PRDCT_TYP   = :st_next_ordbk.c_prd_typ
            AND   FTQ_INDSTK      = :st_next_ordbk.c_ctgry_indstk
            AND   FTQ_UNDRLYNG    = :st_next_ordbk.c_undrlyng
            AND   FTQ_EXPRY_DT    = :st_next_ordbk.c_expry_dt
            AND   FTQ_EXER_TYP    = :st_next_ordbk.c_exrc_typ
            AND   FTQ_OPT_TYP     = :st_next_ordbk.c_opt_typ
            AND   FTQ_STRK_PRC    = :st_next_ordbk.l_strike_prc;

				/*** Ver 2.3 Ends ***/

          if ( SQLCODE != 0 )
          {
            fn_errlog ( c_ServiceName, "S31155", SQLMSG, c_err_msg );
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            tpfree ( ( char * ) ptr_fml_Sbuf );
            tpfree ( ( char * ) ptr_fml_Rbuf );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
						Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );    /*** Ver 3.2 ***/
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
          }

					if(DEBUG_MSG_LVL_0)
          {
            fn_userlog( c_ServiceName, "Lot size for near is :%ld:",l_lot_sz_near);
            fn_userlog( c_ServiceName, "Lot size for far is  :%ld:",l_lot_sz_far);
          }

          if (l_lot_sz_far > l_lot_sz_near)
          {
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            fn_errlog( c_ServiceName, "B28514", " ",c_err_msg );
            tpfree ( ( char * ) ptr_fml_Sbuf );
            tpfree ( ( char * ) ptr_fml_Rbuf );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
						Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );    /*** Ver 3.2 ***/
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
          }
        }
      /*** Ver 1.6 Ends ***/
			} /** else end ** Ver 2.8 **/
   	}

      EXEC SQL
        SELECT  NVL(CLM_SPAN_ALLWD,'N')
        INTO    :c_spn_allwd_flg
        FROM    CLM_CLNT_MSTR
        WHERE   CLM_MTCH_ACCNT  = :st_usr_prfl.c_cln_mtch_accnt;

			if ( SQLCODE  !=  0 )
      {
        fn_errlog( c_ServiceName, "S31160",SQLMSG,c_err_msg);
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
				tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
			  Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );    /*** Ver 3.2 ***/	
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      /** Ver 1.4 Starts Here **/
      c_insuff_flg = 'N';
      d_required_amt = 0.0;
      /** Ver 1.4 Ends Here **/

      strcpy ( st_ordbook.c_cln_mtch_accnt,st_usr_prfl.c_cln_mtch_accnt);     /* Added in Ver 1.9 */
 
		  if ( i_cnt == 1 )
			{	
				if ( c_spn_allwd_flg == 'Y' )
      	{
        	i_returncode = fn_chk_spn_mrgn(c_ServiceName,st_first_ordbk,st_next_ordbk,&st_pstn_action,&d_diff_mrgn,&d_diff_pnl,c_sub_rqst_typ,c_err_msg); /*** 'c_sub_rqst_typ' parameter added in Ver 2.8 ***/
	
        	if ( i_returncode != 0 )
        	{
          	switch( i_returncode )
          	{
            	case INSUFFICIENT_LIMITS  :
							fn_userlog( c_ServiceName, "INSUFFICIENT_LIMITS SPAN");
							fn_userlog( c_ServiceName,"Error Message :%s:",c_err_msg);
							tpfree ( ( char * ) ptr_fml_Sbuf );
        			tpfree ( ( char * ) ptr_fml_Rbuf );
        			tpfree ( ( char * ) ptr_fml_Obuf );
            	fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            	/** fn_errlog( c_ServiceName, "B22003",DEFMSG , c_err_msg ); suchita ***/
							fn_userlog( c_ServiceName,"Error Message :%s:",c_err_msg);
              
            	Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
              strcpy(c_err_msg,strtok(c_err_msg,"<"));
             /** d_required_amt = atof(strtok(NULL,">")); ** suchita ***/
              sscanf(strtok(NULL,">"),"%lf",&d_required_amt); /** suchita ***/ 
            	Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
             
              /******* Ver 1.4 Starts here ****/
              c_insuff_flg = 'Y';
              if(DEBUG_MSG_LVL_2)
              {   
               fn_userlog(c_ServiceName,"c_err_msg :%s:",c_err_msg);
               fn_userlog(c_ServiceName,"d_required_amt :%lf:",d_required_amt);
               fn_userlog(c_ServiceName,"Inside span margin");         /* Added in Ver 1.9 */

              }
              Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT, (char *)&d_required_amt, 0);
              Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
              /******* Ver 1.4 Ends Here *****/
              /*** Ver 1.5 Starts ***/

              c_actn_flg = 'P';

              i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );
              if ( i_trnsctn == -1 )
              {
                fn_errlog( c_ServiceName, "S31165",LIBMSG,c_err_msg);
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID, (char *)&i_actn_id, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }


              i_returncode =  fn_ins_ffl_log_tbl  (  c_ServiceName,
                                                     st_ordbook,
                                                     c_err_msg,
                                                     d_required_amt,
                                                     c_actn_flg
                                                  );
              if ( i_returncode != 0 )
              {
                fn_errlog( c_ServiceName, "S31170", LIBMSG, c_err_msg  );
                fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID , (char *)&i_actn_id , 0 );
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );

             }

             if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
             {
                fn_errlog( c_ServiceName, "S31175",LIBMSG,c_err_msg);
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID, (char *)&i_actn_id, 0 );   
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
             }

             /*** Ver 1.5  Ends   ***/

            	tpreturn(TPFAIL,INSUFFICIENT_LIMITS, (char *)ptr_fml_Ibuf, 0, 0 );
	
            	break;
	
            	default :
							fn_userlog( c_ServiceName, " Inside ERROR for SPAN");
            	fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            	Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            	Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
              Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
              Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
            	tpreturn(TPFAIL,ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
          	}
        	}
      	}
      	else if ( c_spn_allwd_flg == 'N' )
      	{
				  i_returncode = fn_chk_nrml_mrgn(c_ServiceName,st_first_ordbk,st_next_ordbk,&d_diff_mrgn,&d_diff_pnl,c_sub_rqst_typ,c_err_msg);	/*** 'c_sub_rqst_typ' parameter added in Ver 2.8 ***/

          if ( i_returncode != 0 )
          {
            switch( i_returncode )
            {
              case INSUFFICIENT_LIMITS  :
							fn_userlog( c_ServiceName, "INSUFFICIENT_LIMITS_1 Normal");
              
              /** Ver 1.4 **/
              c_insuff_flg = 'Y';
              if(DEBUG_MSG_LVL_2)
              {
               fn_userlog(c_ServiceName,"c_err_msg :%s:",c_err_msg);
               fn_userlog(c_ServiceName,"d_required_amt :%lf:",d_required_amt);
               fn_userlog(c_ServiceName,"Inside normal margin");   /* added in ver 1.9 */

              }
              /** Ver 1.4 **/

              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
							tpfree ( ( char * ) ptr_fml_Sbuf );
        			tpfree ( ( char * ) ptr_fml_Rbuf );
        			tpfree ( ( char * ) ptr_fml_Obuf );
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
              strcpy(c_err_msg,strtok(c_err_msg,"<"));
              d_required_amt = atof(strtok(NULL,">"));
              Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
              Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT, (char *)&d_required_amt, 0); /** Ver 1.4 **/
              Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 1.4 **/
							
							/*** Ver 1.5 Starts ***/
              c_actn_flg = 'P';         /* Change from 'M' to 'P' in Ver 1.9 */

              i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );
              if ( i_trnsctn == -1 )
              {
                fn_errlog( c_ServiceName, "S31180",LIBMSG,c_err_msg);
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID, (char *)&i_actn_id, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }


              i_returncode =  fn_ins_ffl_log_tbl  (  c_ServiceName,
                                                     st_ordbook,
                                                     c_err_msg,
                                                     d_required_amt,
                                                     c_actn_flg
                                                  );
              if ( i_returncode != 0 )
              {
                fn_errlog( c_ServiceName, "S31185", LIBMSG, c_err_msg  );
                fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID , (char *)&i_actn_id , 0 );
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );

              }

              if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
              {
                fn_errlog( c_ServiceName, "S31190",LIBMSG,c_err_msg);
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID, (char *)&i_actn_id, 0 );  
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              /*** Ver 1.5  Ends   ***/
              Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); 			/** Ver 2.8 **/

              tpreturn(TPFAIL, INSUFFICIENT_LIMITS, (char *)ptr_fml_Ibuf, 0, 0 );

              break;

              default :
              fn_userlog( c_ServiceName, " Inside ERROR for Normal"); 
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
							tpfree ( ( char * ) ptr_fml_Sbuf );
        			tpfree ( ( char * ) ptr_fml_Rbuf );
        			tpfree ( ( char * ) ptr_fml_Obuf );	
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
              Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
              Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
              Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
            }
          }	
      	}
      	else
      	{
        	strcpy( c_err_msg, "Invalid User type");
        	fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        	tpfree ( ( char * ) ptr_fml_Sbuf );
        	tpfree ( ( char * ) ptr_fml_Rbuf );
        	tpfree ( ( char * ) ptr_fml_Obuf );
        	Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        	Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        	Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
          Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/ 
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      	}
			}
	}
	  	
		fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg ); /** Transaction aborted ***/
		
		i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );
  
		if ( i_trnsctn == -1 )
  	{
    	fn_errlog( c_ServiceName, "S31195", LIBMSG , c_err_msg );
			tpfree ( ( char * ) ptr_fml_Sbuf );
      tpfree ( ( char * ) ptr_fml_Rbuf );
      tpfree ( ( char * ) ptr_fml_Obuf );
    	Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
    	Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
    	tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  	}

  	i_returncode = fn_lock_usr( c_ServiceName, st_usr_prfl.c_cln_mtch_accnt );

  	if ( i_returncode == -1 )
  	{
    	fn_errlog( c_ServiceName, "S31200", LIBMSG , c_err_msg );
    	fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
    	Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
    	Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
    	tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  	}
    /**** Ver 3.1, Commented adn this patch is shifted below in loop**** 
		strcpy( st_s_sequence.c_pipe_id, st_usr_prfl.c_pipe_id );

  	st_s_sequence.c_rqst_typ = GET_SPRDORD_SEQ;
  	i_ip_len = sizeof ( struct vw_sequence );
  	i_op_len = sizeof ( struct vw_sequence );
  	fn_cpy_ddr ( st_s_sequence.c_rout_crt );
    ********* Comment Ends Here ****************************************/
    /*********** Commented in Ver 2.7 **********
  	i_returncode = fn_call_svc( c_ServiceName,
    	                          c_err_msg,
      	                        &st_s_sequence,
        	                      &st_r_sequence,
          	                    "vw_sequence",
            	                  "vw_sequence",
              	                i_ip_len,
                  	            i_op_len,
                	              0,
                    	          "SFO_GET_SEQ" );
    ********** Comment End in Ver 2.7  **********/
    /*** Added in Ver 2.7 ***/
    if(DEBUG_MSG_LVL_5)
    {
      fn_userlog(c_ServiceName,"Before Calling function fn_get_seq **********");
    }
    /************** Commented in Ver 3.1 *************************
    i_returncode = fn_get_seq(c_ServiceName,c_err_msg,st_s_sequence.c_pipe_id,&st_r_sequence.l_seq_num,st_s_sequence.c_rqst_typ);
    *** Add ended in Ver 2.7 ***
  	if ( i_returncode != 0 )
  	{
    	fn_errlog( c_ServiceName, "S31205", LIBMSG, c_err_msg  );
    	fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
			tpfree ( ( char * ) ptr_fml_Sbuf );
      tpfree ( ( char * ) ptr_fml_Rbuf );
      tpfree ( ( char * ) ptr_fml_Obuf );
    	Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
    	Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); ** Ver 2.1 **
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); ** Ver 2.1 **
    	tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  	}

  	l_sprdord_seq_num = st_r_sequence.l_seq_num;
  	sprintf( c_seq_num, "%08d", l_sprdord_seq_num );
  	strcpy( c_sprdordr_rfrnc, (char *)c_date.arr );
  	strcat( c_sprdordr_rfrnc, st_usr_prfl.c_pipe_id );
  	strcat( c_sprdordr_rfrnc, c_seq_num );
    ******** Ver 3.1 ******************** Comment Ends Here ******/
	
    for( i_cnt=0; i_cnt < i_tot_rec; i_cnt++)
    {
      i_err[0]= Fget32(ptr_fml_Ibuf, FFO_XCHNG_CD,i_cnt, (char *)st_ordbook.c_xchng_cd, 0);
      i_ferr [ 0 ] = Ferror32;

      i_err[1]= Fget32(ptr_fml_Ibuf, FFO_PRDCT_TYP,i_cnt, (char *)&st_ordbook.c_prd_typ, 0);
      i_ferr [ 1 ] = Ferror32;

      i_err[2]= Fget32(ptr_fml_Ibuf, FFO_UNDRLYNG,i_cnt, (char *)st_ordbook.c_undrlyng, 0);
      i_ferr [ 2 ] = Ferror32;

      i_err[3]= Fget32(ptr_fml_Ibuf, FFO_EXPRY_DT,i_cnt, (char *)c_exp_dt.arr, 0);
      i_ferr [ 3 ] = Ferror32;

      i_err[4]= Fget32(ptr_fml_Ibuf, FFO_EXER_TYP,i_cnt, (char *)&st_ordbook.c_exrc_typ, 0);
      i_ferr [ 4 ] = Ferror32;

      i_err[5]= Fget32(ptr_fml_Ibuf, FFO_OPT_TYP,i_cnt, (char *)&st_ordbook.c_opt_typ, 0);
			i_ferr [ 5 ] = Ferror32;

      i_err[6]= Fget32(ptr_fml_Ibuf, FFO_STRK_PRC,i_cnt, (char *)&st_ordbook.l_strike_prc, 0);
      i_ferr [ 6 ] = Ferror32;

      i_err[7]= Fget32(ptr_fml_Ibuf, FFO_CTGRY_INDSTK,i_cnt, (char *)&st_ordbook.c_ctgry_indstk, 0);
      i_ferr [ 7 ] = Ferror32;

      i_err[8]= Fget32(ptr_fml_Ibuf, FFO_ORDR_FLW,i_cnt, (char *)&st_ordbook.c_ordr_flw, 0);
      i_ferr [ 8 ] = Ferror32;

      i_err[9]= Fget32(ptr_fml_Ibuf, FFO_LMT_MKT_SL_FLG,i_cnt, (char *)&st_ordbook.c_slm_flg, 0);
      i_ferr [ 9 ] = Ferror32;

      i_err[10]= Fget32(ptr_fml_Ibuf, FFO_ORD_TOT_QTY,i_cnt, (char *)&st_ordbook.l_ord_tot_qty, 0);
      i_ferr [ 10 ] = Ferror32;

      i_err[11]= Fget32(ptr_fml_Ibuf, FFO_LMT_RT,i_cnt, (char *)&st_ordbook.l_ord_lmt_rt, 0);
      i_ferr [ 11 ] = Ferror32;

      i_err[12]= Fget32(ptr_fml_Ibuf, FFO_CHANNEL,i_cnt, (char *)st_ordbook.c_channel, 0); 
      i_ferr [ 12 ] = Ferror32;

      for(i=0; i < 14; i++)
      {
        if ( (i_err[ i ] == -1 ) )
        {
          fn_errlog( c_ServiceName, "S31210", Fstrerror32(i_ferr[i]),c_err_msg);
          fn_userlog(c_ServiceName,"Error in field %d in record no %d",i,i_cnt );
          fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
          tpfree ( ( char * ) ptr_fml_Sbuf );
          tpfree ( ( char * ) ptr_fml_Rbuf );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
          Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
		
      if(st_usr_prfl.c_user_id[0] == BPID)
      {
        if(Fget32(ptr_fml_Ibuf,FFO_ALIAS,i_cnt,(char *)c_alias,0) == -1)
        {
          fn_errlog( c_ServiceName, "S31215", FMLMSG, c_err_msg  );
          fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
          tpfree ( ( char * ) ptr_fml_Sbuf );
          tpfree ( ( char * ) ptr_fml_Rbuf );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );   
          Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
          Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }

      SETLEN(c_exp_dt);

      strcpy ( st_ordbook.c_expry_dt, ( char * ) c_exp_dt.arr );

		  /***  Added In Ver 1.8  ***/
		 
			fn_userlog(c_ServiceName,"Source Flag :%c:",c_source_flag);

    	if ( c_source_flag == 'Y' )
    	{
      	strcpy(st_ordbook.c_channel,"NET");
    	}
    	else if ( c_source_flag == 'Z' )
    	{
      	strcpy(st_ordbook.c_channel,"CN2");
    	}
	
			/***  Ver 1.8 Ends ***/

      if(DEBUG_MSG_LVL_5)
      {
        fn_userlog( c_ServiceName, "Input Data for order no :%d:",i_cnt);
        fn_userlog( c_ServiceName, "Exchange code :%s:", st_ordbook.c_xchng_cd );
        fn_userlog( c_ServiceName, "Product Type  :%c:", st_ordbook.c_prd_typ );
        fn_userlog( c_ServiceName, "Underlyng     :%s:", st_ordbook.c_undrlyng );
        fn_userlog( c_ServiceName, "Expiry date   :%s:", st_ordbook.c_expry_dt);
        fn_userlog( c_ServiceName, "Excercise Type:%c:", st_ordbook.c_exrc_typ );
        fn_userlog( c_ServiceName, "Option type   :%c:", st_ordbook.c_opt_typ );
        fn_userlog( c_ServiceName, "Strike price  :%ld:", st_ordbook.l_strike_prc );
        fn_userlog( c_ServiceName, "Category      :%c:", st_ordbook.c_ctgry_indstk );
        fn_userlog( c_ServiceName, "Order flow B/S:%c:", st_ordbook.c_ordr_flw );
        fn_userlog( c_ServiceName, "Lmt/Mkt/StpLss:%c:", st_ordbook.c_slm_flg );
        fn_userlog( c_ServiceName, "Order Qty     :%ld:", st_ordbook.l_ord_tot_qty );
        fn_userlog( c_ServiceName, "Limit rate    :%ld:", st_ordbook.l_ord_lmt_rt );
        fn_userlog( c_ServiceName, "CHANNEL   :%s:", st_ordbook.c_channel);
        fn_userlog( c_ServiceName, "ALIAS   :%s:", c_alias); 
			}

      st_ordbook.l_dsclsd_qty = 0 ;
      st_ordbook.l_stp_lss_tgr = 0 ;

      if( c_opn_typ == 'S' ) /*** if condition added in Ver 2.8 ***/
      {
        st_ordbook.c_ord_typ = GOOD_TILL_TODAY;
      }
      else
      {
      	st_ordbook.c_ord_typ = IMMEDIATE_OR_CANCEL ;
			}

		if(i_cnt == 0 )
    {
     	strcpy(st_first_ordbk.c_cln_mtch_accnt, st_usr_prfl.c_cln_mtch_accnt);
     	st_first_ordbk.l_ord_tot_qty = st_ordbook.l_ord_tot_qty;
     	strcpy(st_first_ordbk.c_xchng_cd ,st_ordbook.c_xchng_cd);
     	st_first_ordbk.c_prd_typ = st_ordbook.c_prd_typ;
     	strcpy(st_first_ordbk.c_undrlyng ,st_ordbook.c_undrlyng);
     	strcpy(st_first_ordbk.c_expry_dt ,st_ordbook.c_expry_dt);
     	st_first_ordbk.c_exrc_typ = st_ordbook.c_exrc_typ;
     	st_first_ordbk.c_opt_typ = st_ordbook.c_opt_typ;
     	st_first_ordbk.l_strike_prc = st_ordbook.l_strike_prc;
     	st_first_ordbk.c_ordr_flw   = st_ordbook.c_ordr_flw;
     	st_first_ordbk.l_ord_lmt_rt  = st_ordbook.l_ord_lmt_rt;
     	st_first_ordbk.c_ctgry_indstk = st_ordbook.c_ctgry_indstk;
     	st_first_ordbk.c_slm_flg = st_ordbook.c_slm_flg;
     	strcpy(st_first_ordbk.c_pipe_id,st_usr_prfl.c_pipe_id);
    }
    else
    {
     	strcpy(st_next_ordbk.c_cln_mtch_accnt, st_usr_prfl.c_cln_mtch_accnt);
     	st_next_ordbk.l_ord_tot_qty = st_ordbook.l_ord_tot_qty;
     	strcpy(st_next_ordbk.c_xchng_cd ,st_ordbook.c_xchng_cd);
     	st_next_ordbk.c_prd_typ = st_ordbook.c_prd_typ;
     	strcpy(st_next_ordbk.c_undrlyng ,st_ordbook.c_undrlyng);
     	strcpy(st_next_ordbk.c_expry_dt ,st_ordbook.c_expry_dt);
     	st_next_ordbk.c_exrc_typ = st_ordbook.c_exrc_typ;
     	st_next_ordbk.c_opt_typ = st_ordbook.c_opt_typ;
     	st_next_ordbk.l_strike_prc = st_ordbook.l_strike_prc;
     	st_next_ordbk.c_ordr_flw   = st_ordbook.c_ordr_flw;
     	st_next_ordbk.l_ord_lmt_rt  = st_ordbook.l_ord_lmt_rt;
     	st_next_ordbk.c_ctgry_indstk = st_ordbook.c_ctgry_indstk;
     	st_next_ordbk.c_slm_flg = st_ordbook.c_slm_flg;
      strcpy(st_next_ordbk.c_pipe_id,st_usr_prfl.c_pipe_id);

      if( ( strcmp(st_first_ordbk.c_xchng_cd,st_next_ordbk.c_xchng_cd)==0) &&
       	  (st_first_ordbk.c_prd_typ == st_next_ordbk.c_prd_typ)            &&
         	( strcmp(st_first_ordbk.c_undrlyng,st_next_ordbk.c_undrlyng)==0) &&
         	( strcmp(st_first_ordbk.c_expry_dt,st_next_ordbk.c_expry_dt)==0) &&
         	(st_first_ordbk.c_exrc_typ == st_next_ordbk.c_exrc_typ)          &&
         	(st_first_ordbk.c_opt_typ == st_next_ordbk.c_opt_typ)            &&
         	(st_first_ordbk.l_strike_prc == st_next_ordbk.l_strike_prc)        )
         	{
           	fn_errlog( c_ServiceName, "B28551",DEFMSG,c_err_msg);
           	fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
         	  tpfree ( ( char * ) ptr_fml_Sbuf );
           	tpfree ( ( char * ) ptr_fml_Rbuf );
           	tpfree ( ( char * ) ptr_fml_Obuf );
           	Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
           	Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/   
           	tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
         	}

   		}

      EXEC SQL
       	SELECT  NVL(CLM_SPAN_ALLWD,'N')
       	INTO    :c_spn_allwd_flg
       	FROM    CLM_CLNT_MSTR
       	WHERE   CLM_MTCH_ACCNT  = :st_usr_prfl.c_cln_mtch_accnt;

      if ( SQLCODE  !=  0 )
      {
       	fn_errlog( c_ServiceName, "S31220",SQLMSG,c_err_msg);
       	fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
				tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
       	Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
				Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );    /*** Ver 3.2 ***/
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
       	tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
	

			if(DEBUG_MSG_LVL_0)
    	{	
      	fn_userlog(c_ServiceName,"SPAN ALLWD FLAG IS :%c:",c_spn_allwd_flg);
			}

      if ( c_spn_allwd_flg == 'Y' )
      {
        strcpy(c_srvc_nm,"SFO_SPN_PLC_ORD");
      }
      else if ( c_spn_allwd_flg == 'N' )
      {
        strcpy(c_srvc_nm,"SFO_FUT_PLC_ORD");
      }  
      else
      {
        strcpy( c_err_msg, "Invalid User type");

				fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
				Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );    /*** Ver 3.2 ***/
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      i_err[0] = Fchg32 ( ptr_fml_Sbuf, FFO_XCHNG_CD, 0, (char *)st_ordbook.c_xchng_cd, 0);
      i_ferr [ 0 ] = Ferror32;

      i_err[1] = Fchg32 ( ptr_fml_Sbuf, FFO_PRDCT_TYP, 0, (char *)&st_ordbook.c_prd_typ, 0);
      i_ferr [ 1 ] = Ferror32;

      i_err[2] = Fchg32 ( ptr_fml_Sbuf, FFO_UNDRLYNG, 0, (char *)st_ordbook.c_undrlyng, 0);
      i_ferr [ 2 ] = Ferror32;

      i_err[3] = Fchg32 ( ptr_fml_Sbuf, FFO_EXPRY_DT, 0, (char *)c_exp_dt.arr, 0);
      i_ferr [ 3 ] = Ferror32;

      i_err[4] = Fchg32 ( ptr_fml_Sbuf, FFO_EXER_TYP, 0, (char *)&st_ordbook.c_exrc_typ, 0);
      i_ferr [ 4 ] = Ferror32;

      i_err[5] = Fchg32 ( ptr_fml_Sbuf, FFO_OPT_TYP, 0, (char *)&st_ordbook.c_opt_typ, 0);
      i_ferr [ 5 ] = Ferror32;

      i_err[6] = Fchg32 ( ptr_fml_Sbuf, FFO_STRK_PRC, 0, (char *)&st_ordbook.l_strike_prc, 0);
      i_ferr [ 6 ] = Ferror32;

      i_err[7] = Fchg32 ( ptr_fml_Sbuf, FFO_CTGRY_INDSTK, 0, (char *)&st_ordbook.c_ctgry_indstk, 0);
      i_ferr [ 7 ] = Ferror32;

      i_err[8] = Fchg32 ( ptr_fml_Sbuf, FFO_ORDR_FLW, 0, (char *)&st_ordbook.c_ordr_flw, 0);
      i_ferr [ 8 ] = Ferror32;

      i_err[9] = Fchg32 ( ptr_fml_Sbuf, FFO_LMT_MKT_SL_FLG, 0, (char *)&st_ordbook.c_slm_flg, 0);
      i_ferr [ 9 ] = Ferror32;

      i_err[10] = Fchg32 ( ptr_fml_Sbuf, FFO_ORD_TYP, 0, (char *)&st_ordbook.c_ord_typ, 0);
			i_ferr [ 10 ] = Ferror32;

      i_err[11] = Fchg32 ( ptr_fml_Sbuf, FFO_ORD_TOT_QTY, 0, (char *)&st_ordbook.l_ord_tot_qty, 0);
      i_ferr [ 11 ] = Ferror32;

      i_err[12] = Fchg32 ( ptr_fml_Sbuf, FFO_LMT_RT, 0, (char *)&st_ordbook.l_ord_lmt_rt, 0);
      i_ferr [ 12 ] = Ferror32;

      i_err[13] = Fchg32 ( ptr_fml_Sbuf, FFO_DSCLSD_QTY, 0, (char *)&st_ordbook.l_dsclsd_qty, 0);
      i_ferr [ 13 ] = Ferror32;

      i_err[14] = Fchg32 ( ptr_fml_Sbuf, FFO_STP_LSS_TGR, 0, (char *)&st_ordbook.l_stp_lss_tgr, 0);
      i_ferr [ 14 ] = Ferror32;

      i_err[15] = Fchg32 ( ptr_fml_Sbuf, FFO_CHANNEL, 0, (char *)st_ordbook.c_channel, 0);
      i_ferr [ 15 ] = Ferror32;

      i_err[16] = Fchg32 ( ptr_fml_Sbuf, FFO_ALIAS, 0, (char *)c_alias, 0);
      i_ferr [ 16 ] = Ferror32;

      i_err[17] = Fchg32 ( ptr_fml_Sbuf, FFO_SPL_FLG, 0, (char *)&c_spl_flg, 0);
      i_ferr [ 17 ] = Ferror32;

      i_err[18] = Fchg32 ( ptr_fml_Sbuf, FFO_SVC_NAME, 0, (char *)c_srvc_nm, 0);
      i_ferr [ 18 ] = Ferror32;

      i_err[19] = Fchg32 ( ptr_fml_Sbuf, FFO_SPRD_ORD_IND, 0, (char *)&c_sprd_ord_ind, 0);
      i_ferr [ 19 ] = Ferror32;
      
			for(i=0; i < 20; i++)
      {
        if ( (i_err[ i ] == -1 ) )
        {
          fn_errlog( c_ServiceName, "S31225", Fstrerror32(i_ferr[i]),c_err_msg);
          fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
          tpfree ( ( char * ) ptr_fml_Sbuf );
          tpfree ( ( char * ) ptr_fml_Rbuf );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );    
          Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
          Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/ 
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }

      /*** Ver 2.8 Starts ***/

      i_err[ 0 ] = Fchg32 ( ptr_fml_Sbuf, FFO_OI_INDCTR, 0, (char *)c_ip_address, 0);
      i_ferr [ 0 ] = Ferror32;

      if ( (i_err[ 0 ]  == -1 ) )
      {
          fn_errlog( c_ServiceName, "S31230", Fstrerror32(i_ferr[i]),c_err_msg);
          fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
          tpfree ( ( char * ) ptr_fml_Sbuf );
          tpfree ( ( char * ) ptr_fml_Rbuf );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
          Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      if( c_opn_typ == 'S' )
      {
				if( i_cnt == 0 )
				{
        	i_err[ 1 ] = Fchg32 ( ptr_fml_Sbuf,FFO_EXECN_DT, 0,(char *)c_sprd_exp_dt2, 0);
        	i_ferr [ 1 ] = Ferror32;
				}
				else
				{
					i_err[ 1 ] = Fchg32 ( ptr_fml_Sbuf,FFO_EXECN_DT, 0,(char *)c_sprd_exp_dt1, 0);
          i_ferr [ 1 ] = Ferror32;
				}

        if( i_err[1] == -1 )
        {
          fn_errlog( c_ServiceName, "S31235", Fstrerror32(i_ferr[i]),c_err_msg);
          fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
          tpfree ( ( char * ) ptr_fml_Sbuf );
          tpfree ( ( char * ) ptr_fml_Rbuf );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); 
          Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }

      /*** Ver 2.8 Ends ***/

      i_err[0]= Fget32(ptr_fml_Ibuf, FFO_SETTLOR,i_cnt, (char *)st_ordbook.c_settlor, 0);
      i_ferr [ 0 ] = Ferror32;

      if (( i_err[0] == -1 ) && ( i_ferr[0] != FNOTPRES ))
      {
        fn_errlog( c_ServiceName, "S31240", Fstrerror32(i_ferr[0]),c_err_msg);
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );     
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
      else if ( i_ferr[0] == FNOTPRES )
      {
        c_settlor_flg = NO;
      }

			else
      {
        c_settlor_flg = YES;
        i_returncode = Fchg32 ( ptr_fml_Sbuf, FFO_SETTLOR, 0, (char *)st_ordbook.c_settlor, 0);

        if ( i_returncode == -1 )
        {
          fn_errlog( c_ServiceName, "S31245",FMLMSG,c_err_msg);
          fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
          tpfree ( ( char * ) ptr_fml_Sbuf );
          tpfree ( ( char * ) ptr_fml_Rbuf );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );  
          Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
          Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }

      /**** Ver 3.1 Starts heree ****/
      MEMSET(c_mleg_pipe_id);
      if( i_cnt == 0 )
      {
        strcpy(c_mleg_pipe_id,"NA"); 
      }
      else
      {
        strcpy(c_mleg_pipe_id,c_pipe_id);
      }

      fn_userlog(c_ServiceName,"c_mleg_pipe_id :%s:",c_mleg_pipe_id);
  
      i_returncode = Fchg32 ( ptr_fml_Sbuf, FFO_INDX_CD, 0, (char *)c_mleg_pipe_id, 0);

      if ( i_returncode == -1 )
      {
        fn_errlog( c_ServiceName, "S31250",FMLMSG,c_err_msg);
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); 
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); 
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
      /**** Ver 3.1 Ends Here ****/


			i_returncode = tpcall("SFO_ORD_ROUT", (char *)ptr_fml_Sbuf, 0, (char **)&ptr_fml_Rbuf, &l_recvbuff, 0);

      if (i_returncode == -1)
      {
        if (TPCODE != TPESVCFAIL)
        {
          fn_errlog( c_ServiceName, "S31255",TPMSG,c_err_msg);
          fn_userlog( c_ServiceName, "TP CODE IS    |%d|",TPCODE);
        }
        else
        {
          i_returncode = Fget32(ptr_fml_Rbuf, FFO_ERR_MSG, 0, c_err_msg, 0);

          if (i_returncode == -1)
          {
            fn_errlog( c_ServiceName, "S31260",FMLMSG,c_err_msg);
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            tpfree ( ( char * ) ptr_fml_Sbuf );
            tpfree ( ( char * ) ptr_fml_Rbuf );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 ); 
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
          }
        }

				fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 ); 
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      i_returncode= Fget32(ptr_fml_Rbuf, FFO_ORDR_RFRNC,0, (char *)st_ordbook.c_ordr_rfrnc, 0);

			if (i_returncode == -1)
      {
        fn_errlog( c_ServiceName, "S31265",FMLMSG,c_err_msg);
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );  
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      i_returncode= Fget32(ptr_fml_Rbuf, FFO_PIPE_ID,0, (char *)c_pipe_id, 0);

      if (i_returncode == -1)
      {
        fn_errlog( c_ServiceName, "S31270",FMLMSG,c_err_msg);
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 ); 
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      i_returncode = Fadd32 ( ptr_fml_Obuf, FFO_ORDR_RFRNC, ( char *)st_ordbook.c_ordr_rfrnc, 0 );

      if( i_returncode == -1)
      {
        fn_errlog( c_ServiceName, "S31275",FMLMSG,c_err_msg);
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );   
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      /*** Ver 2.1 Starts ***/

			i_returncode = Fconcat32(ptr_fml_Obuf,ptr_fml_Rbuf);

      if( i_returncode == -1)
      {
       fn_errlog( c_ServiceName, "S31280",FMLMSG,c_err_msg);
       fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
       tpfree ( ( char * ) ptr_fml_Sbuf );
       tpfree ( ( char * ) ptr_fml_Rbuf );
       tpfree ( ( char * ) ptr_fml_Obuf );
       Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
       Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );    
			 Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); 
       Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
       tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
       }

      /*** Ver 2.1 Ends ***/

      i_err[0] = 0 ;
      i_ferr[0] = 0 ;

      if ( Finit32 ( ptr_fml_Rbuf, ( FLDLEN32 ) Fsizeof32 ( ptr_fml_Rbuf ) ) == -1 )
      {
        fn_errlog( c_ServiceName, "S31285",FMLMSG,c_err_msg);
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );    
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      /*** Ver 2.8 Starts ***/

      if( i_cnt == 0 )
      {
        strcpy(st_first_ordbk.c_ordr_rfrnc,st_ordbook.c_ordr_rfrnc);

        if(DEBUG_MSG_LVL_5)
        {
          fn_userlog(c_ServiceName,"st_first_ordbk.c_ordr_rfrnc :%s:",st_first_ordbk.c_ordr_rfrnc);
        }
      }
      else if( i_cnt == 1 )
      {
        strcpy(st_next_ordbk.c_ordr_rfrnc,st_ordbook.c_ordr_rfrnc);

        if(DEBUG_MSG_LVL_5)
        {
          fn_userlog(c_ServiceName,"st_next_ordbk.c_ordr_rfrnc :%s:",st_next_ordbk.c_ordr_rfrnc);
        }

      }
      /*** Ver 2.8 Ends ***/

      /**** Ver 3.1 Starts Here *******/
      if( i_cnt == 0 )
      {
        strcpy( st_s_sequence.c_pipe_id, c_pipe_id);
        st_s_sequence.c_rqst_typ = GET_SPRDORD_SEQ;
        i_ip_len = sizeof ( struct vw_sequence );
        i_op_len = sizeof ( struct vw_sequence );
        fn_cpy_ddr ( st_s_sequence.c_rout_crt );

        i_returncode = fn_get_seq(c_ServiceName,c_err_msg,st_s_sequence.c_pipe_id,&st_r_sequence.l_seq_num,st_s_sequence.c_rqst_typ);
        if ( i_returncode != 0 )
        {
          fn_errlog( c_ServiceName, "S31290", LIBMSG, c_err_msg  );
          fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
          Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }

        l_sprdord_seq_num = st_r_sequence.l_seq_num;
        sprintf( c_seq_num, "%08d", l_sprdord_seq_num );
        strcpy( c_sprdordr_rfrnc, (char *)c_date.arr );
        /** strcat( c_sprdordr_rfrnc, st_usr_prfl.c_pipe_id ); *** Ver 3.4 **/
        strcat( c_sprdordr_rfrnc, c_pipe_id );   /** Ver 3.4 **/
        strcat( c_sprdordr_rfrnc, c_seq_num );
      }
      /**** Ver 3.1 Ends Here ********/

      strcpy( st_spd_ordbk.c_sprd_ord_rfrnc[i_cnt],c_sprdordr_rfrnc );
      strcpy( st_spd_ordbk.c_ordr_rfrnc[i_cnt],st_ordbook.c_ordr_rfrnc );
      st_spd_ordbk.c_sprd_ord_ind[i_cnt] = c_sprd_ord_ind;
      strcpy( st_spd_ordbk.c_pipe_id[i_cnt],c_pipe_id );
      st_spd_ordbk.l_mdfctn_cntr[i_cnt] = 1;
      st_spd_ordbk.l_ord_tot_qty[i_cnt] = st_ordbook.l_ord_tot_qty;
      st_spd_ordbk.c_rqst_typ[i_cnt] = INSERT_ON_ORDER_PLACEMENT;

      if(DEBUG_MSG_LVL_5)
      {
        fn_userlog(c_ServiceName,"Printing Values for Instance:%d:",i_cnt);
        fn_userlog(c_ServiceName,"st_spd_ordbk.c_sprd_ord_rfrnc:%s:",st_spd_ordbk.c_sprd_ord_rfrnc[i_cnt]);
        fn_userlog(c_ServiceName,"st_spd_ordbk.c_ordr_rfrnc[i_cnt]:%s:",st_spd_ordbk.c_ordr_rfrnc[i_cnt]);
        fn_userlog(c_ServiceName,"st_spd_ordbk.c_sprd_ord_ind[i_cnt]:%d:",st_spd_ordbk.c_sprd_ord_ind[i_cnt]);
        fn_userlog(c_ServiceName,"st_spd_ordbk.c_pipe_id[i_cnt]:%s:",st_spd_ordbk.c_pipe_id[i_cnt]);
        fn_userlog(c_ServiceName,"st_spd_ordbk.l_mdfctn_cntr[i_cnt]:%ld:",st_spd_ordbk.l_mdfctn_cntr[i_cnt]);
        fn_userlog(c_ServiceName,"st_spd_ordbk.l_ord_tot_qty[i_cnt]:%ld:",st_spd_ordbk.l_ord_tot_qty[i_cnt]);
      }
    }

    tpfree ( ( char * ) ptr_fml_Rbuf );
    tpfree ( ( char * ) ptr_fml_Sbuf );

    i_ip_len = sizeof ( struct vw_spdordbk );
    i_op_len = sizeof ( struct vw_spdordbk );
		
		fn_cpy_ddr ( st_spd_ordbk.c_rout_crt );

    i_returncode = fn_call_svc( c_ServiceName,
                                c_err_msg,
                                &st_spd_ordbk,
                                &st_spd_ordbk,
                                "vw_spdordbk",
                                "vw_spdordbk",
                                i_ip_len,
                                i_op_len,
                                0,
                                "SFO_UPD_SPDBK" );
    if ( i_returncode != 0 )
    {
      fn_errlog( c_ServiceName, "S31295", LIBMSG, c_err_msg  );
      fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
      tpfree ( ( char * ) ptr_fml_Obuf );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );  
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }
		
		if(DEBUG_MSG_LVL_3)
    {
        fn_userlog(c_ServiceName,"After Spread Book. ");
		}

    /*** Ver 2.8 Starts ***/

    if (c_spl_flg == ROLLOVER_WITH_SPREAD )
    {
      EXEC SQL
        UPDATE  FOD_FO_ORDR_DTLS
        SET     FOD_SLTP_ORDR_RFRNC =:st_next_ordbk.c_ordr_rfrnc
        WHERE   FOD_ORDR_RFRNC =:st_first_ordbk.c_ordr_rfrnc;

      if( SQLCODE != 0 )
      {
        fn_errlog( c_ServiceName, "S31300", LIBMSG, c_err_msg  );
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); 
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      EXEC SQL
        UPDATE  FOD_FO_ORDR_DTLS
        SET     FOD_SLTP_ORDR_RFRNC =:st_first_ordbk.c_ordr_rfrnc
        WHERE   FOD_ORDR_RFRNC =:st_next_ordbk.c_ordr_rfrnc;

      if( SQLCODE != 0 )
      {
        fn_errlog( c_ServiceName, "S31305", LIBMSG, c_err_msg  );
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); 
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }
    /*** Ver 2.8 Ends ***/
			
		c_dr_without_lmt_flg = DEBIT_WHEN_LIMIT;
    if (c_spl_flg == ROLLOVER_WITH_SPREAD ) /*** added in ver 2.8 *****/
    {
     strcpy( c_narration_id , ON_RWS_ORDER_PLACEMENT); 
    }
    else
    {
     strcpy( c_narration_id , ON_ROLLOVER_ORDER_PLACEMENT);/** 2.8 need to handle for roll with sprd ***/
	  }
		if(DEBUG_MSG_LVL_0)
    {
        fn_userlog(c_ServiceName,"c_narration_id .  |%s| ",c_narration_id);
        fn_userlog(c_ServiceName,"d_diff_mrgn1 .  |%lf| ",d_diff_mrgn);
        fn_userlog(c_ServiceName,"st_usr_prfl.c_cln_mtch_accnt .  |%s| ",st_usr_prfl.c_cln_mtch_accnt);
        fn_userlog(c_ServiceName,"st_ordbook.c_xchng_cd .  				|%s| ",st_ordbook.c_xchng_cd);
		}
		if(DEBUG_MSG_LVL_5)
    {
        fn_userlog(c_ServiceName,"ptr_st_pstn_actn_mn.c_cln_mtch_accnt.  |%s| ",ptr_st_pstn_actn_mn.c_cln_mtch_accnt);
        fn_userlog(c_ServiceName,"ptr_st_pstn_actn_mn.c_xchng_cd.  |%s| ",ptr_st_pstn_actn_mn.c_xchng_cd);
		}

    /** Ver 1.4 **/
    c_insuff_flg = 'N';
    d_required_amt = 0.0;
    d_required_diff_mrgn = 0;
    /** Ver 1.4 **/

		if (c_spn_allwd_flg == 'N')
		{

    if ( d_diff_mrgn < 0  )
    {

			c_diff_mrgn_flg = 'Y';  /*** Ver 2.8 ***/

      i_returncode = fn_upd_limits( c_ServiceName,
                                    &ptr_st_pstn_actn_mn,
                                    /** ptr_st_err_msg, ** Ver 1.4 **/
                                    &ptr_st_err_msg,    /** Ver 1.4 **/
                                    c_narration_id,
                                    c_dr_without_lmt_flg,
                                    d_diff_mrgn,
                                    &d_balance_amt);
      if ( i_returncode != 0 )
      {
        switch ( i_returncode )
        {
          case  INSUFFICIENT_LIMITS :
            fn_userlog(c_ServiceName," Inside INSUFFICIENT_LIMITS.");
						fn_userlog(c_ServiceName," After fn_upd_limits call");
						fn_errlog( c_ServiceName, "S31310", LIBMSG, c_err_msg  );
      			fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
      			tpfree ( ( char * ) ptr_fml_Obuf );
      		 /** 	Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 ); ** Ver 1.4 **/
      			Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );

            /*** Ver 1.4 Starts ***/
            if( DEBUG_MSG_LVL_2 )
            {
             fn_userlog(c_ServiceName,"d_diff_mrgn = :%lf:",d_diff_mrgn);
             fn_userlog(c_ServiceName,"d_balance_amt = :%lf:",d_balance_amt);
             fn_userlog(c_ServiceName," Inside INSUFFICIENT_LIMITS for d_diff_mrgn.");
            }

            strcpy(c_err_msg,strtok(ptr_st_err_msg.c_err_msg,"|"));
            d_required_diff_mrgn = atof(strtok(NULL,"|"));
            strcpy(c_err_msg,strtok(c_err_msg,"<"));

            if(DEBUG_MSG_LVL_2)
            {
             fn_userlog(c_ServiceName," d_required_diff_mrgn :%lf:",d_required_diff_mrgn);
             fn_userlog(c_ServiceName," ptr_st_err_msg.c_err_msg :%lf:",ptr_st_err_msg.c_err_msg );

            }
            c_insuff_flg = 'Y';

            if( d_diff_pnl < 0 )
            {
              d_required_amt = d_required_diff_mrgn + ( (-1) * d_diff_pnl / 100 ) ;
            }
            else
            {
              d_required_amt = d_required_diff_mrgn;
            }
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT, (char *)&d_required_amt, 0);
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);

            sprintf(c_err_msg,"%s%lf>",c_err_msg,d_required_amt);
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            /*** Ver 1.4 Ends ***/
						
						/*** Ver 1.5 Starts ***/
              c_actn_flg = 'P';           /* Change from 'M' to 'P' in Ver 1.9 */

              i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );
              if ( i_trnsctn == -1 )
              {
                fn_errlog( c_ServiceName, "S31315",LIBMSG,c_err_msg);
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID, (char *)&i_actn_id, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }


              i_returncode =  fn_ins_ffl_log_tbl  (  c_ServiceName,
                                                     st_ordbook,
                                                     c_err_msg,
                                                     d_required_amt,
                                                     c_actn_flg
                                                  );
              if ( i_returncode != 0 )
              {
                fn_errlog( c_ServiceName, "S31320", LIBMSG, c_err_msg  );
                fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID , (char *)&i_actn_id , 0 );
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );

             }

             if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
             {
                fn_errlog( c_ServiceName, "S31325",LIBMSG,c_err_msg);
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID, (char *)&i_actn_id, 0 );  
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/ 
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
             }

             /*** Ver 1.5  Ends   ***/
      			tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );

         default:
						fn_errlog( c_ServiceName, "S31330", LIBMSG, c_err_msg  );
      			fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
      			tpfree ( ( char * ) ptr_fml_Obuf );
      			Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      			Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
      			tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
			d_total_def = d_total_def + d_diff_mrgn;
    }

		MEMSET(c_narration_id);
    if (c_spl_flg == ROLLOVER_WITH_SPREAD ) /*** added in ver 2.8 *****/
    {
     strcpy( c_narration_id , BLOCK_PNL_ON_RWS_ORDER_PLACEMENT);
    }
    else
    {
		 strcpy( c_narration_id , BLOCK_PNL_ON_ROLLOVER_ORDER_PLACEMENT); /** 2.8 need to handle case ***/
		}

		if(DEBUG_MSG_LVL_0)
    {
        fn_userlog(c_ServiceName,"c_narration_id .  |%s| ",c_narration_id);
        fn_userlog(c_ServiceName,"d_diff_pnl .  |%lf| ",d_diff_pnl);
        fn_userlog(c_ServiceName,"ptr_st_pstn_actn_mn.c_cln_mtch_accnt.  |%s| ",ptr_st_pstn_actn_mn.c_cln_mtch_accnt);
        fn_userlog(c_ServiceName,"ptr_st_pstn_actn_mn.c_xchng_cd.  |%s| ",ptr_st_pstn_actn_mn.c_xchng_cd);
		}

		if ( d_diff_pnl < 0  )
    {
			c_diff_pnl_flg = 'Y';   /*** Ver 2.8 ***/

      i_returncode = fn_upd_limits( c_ServiceName,
                                    &ptr_st_pstn_actn_mn,
                                    /** ptr_st_err_msg, ** Ver 1.4 **/
                                    &ptr_st_err_msg,      /*** Ver 1.4 ***/
                                    c_narration_id,
                                    c_dr_without_lmt_flg,
                                    d_diff_pnl,
                                    &d_balance_amt);
      if ( i_returncode != 0 )
      {
        switch ( i_returncode )
        {
          case  INSUFFICIENT_LIMITS :
            fn_userlog(c_ServiceName," Inside INSUFFICIENT_LIMITS.");
            fn_errlog( c_ServiceName, "S31335", LIBMSG, c_err_msg  );
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );

            /*** Ver 1.4 ***/
            fn_userlog(c_ServiceName," Inside INSUFFICIENT_LIMITS for d_diff_pnl.");
            strcpy(c_err_msg,strtok(ptr_st_err_msg.c_err_msg,"|"));
            d_required_amt = atof(strtok(NULL,"|"));
            strcpy(c_err_msg,strtok(c_err_msg,"<"));
            c_insuff_flg = 'Y';
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT, (char *)&d_required_amt, 0); /** Ver 1.4 **/
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 1.4 **/
            /*** Ver 1.4 ***/
           
						/*** Ver 1.5 Starts ***/
              c_actn_flg = 'P';            /* Change from 'M' to 'P' in Ver 1.9 */

              i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );
              if ( i_trnsctn == -1 )
              {
                fn_errlog( c_ServiceName, "S31340",LIBMSG,c_err_msg);
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID, (char *)&i_actn_id, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }


              i_returncode =  fn_ins_ffl_log_tbl  (  c_ServiceName,
                                                     st_ordbook,
                                                     c_err_msg,
                                                     d_required_amt,
                                                     c_actn_flg
                                                  );
              if ( i_returncode != 0 )
              {
                fn_errlog( c_ServiceName, "S31345", LIBMSG, c_err_msg  );
                fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID , (char *)&i_actn_id , 0 );
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );

              }

              if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
              {
                fn_errlog( c_ServiceName, "S31350",LIBMSG,c_err_msg);
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID, (char *)&i_actn_id, 0 );  
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

            /*** Ver 1.5  Ends   ***/

            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );

         default:
            fn_errlog( c_ServiceName, "S31355", LIBMSG, c_err_msg  );
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/   
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
			d_total_def = d_total_def + d_diff_pnl;
    }	
    /*** Ver 2.8 Starts ***/
    if( c_opn_typ == 'S' || c_opn_typ == 'R' )	/*** c_opn_typ 'R' Added for Live issue ***/
    {
      if(DEBUG_MSG_LVL_5) 
      {
        fn_userlog(c_ServiceName,"Before update margin in NON-SPAN Case :Bhushan");
        fn_userlog(c_ServiceName,"d_diff_mrgn :%lf:",d_diff_mrgn);
        fn_userlog(c_ServiceName,"d_diff_pnl :%lf:",d_diff_pnl);
        fn_userlog(c_ServiceName,"c_diff_mrgn_flg :%c:",c_diff_mrgn_flg);
        fn_userlog(c_ServiceName,"c_diff_pnl_flg :%c:",c_diff_pnl_flg);
				fn_userlog(c_ServiceName,"d_total_def :%lf:",d_total_def);
      }

      EXEC SQL
        UPDATE FOD_FO_ORDR_DTLS
        SET FOD_SROLL_DIFF_AMT = DECODE(:c_diff_mrgn_flg,'Y',:d_diff_mrgn * (-1),FOD_SROLL_DIFF_AMT),
            FOD_SROLL_LSS_AMT =  DECODE(:c_diff_pnl_flg,'Y', :d_diff_pnl * (-1),FOD_SROLL_LSS_AMT)
        WHERE FOD_ORDR_RFRNC = :st_first_ordbk.c_ordr_rfrnc
        AND   FOD_XCHNG_CD = :st_first_ordbk.c_xchng_cd
        AND   FOD_PRDCT_TYP = :st_first_ordbk.c_prd_typ
        AND   FOD_UNDRLYNG = :st_first_ordbk.c_undrlyng
        AND   FOD_EXPRY_DT = :st_first_ordbk.c_expry_dt;

      if ( SQLCODE != 0 )
      {
        fn_errlog( c_ServiceName, "S51330", SQLMSG, c_err_msg  );
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }
		/*** Ver 2.8 Ends ***/
		if (  c_opn_typ == 'R' && d_total_def < 0)  /*** c_opn_typ == 'R' Added in Ver 2.8 ***/
		{
		/*** Commented in Ver 2.3  ***

			EXEC SQL
        SELECT  FCM_CNTRCT_TAG
        INTO    :c_cntrct_tag
        FROM    FCM_FO_CNTRCT_MSTR
        WHERE   FCM_XCHNG_CD        = :st_first_ordbk.c_xchng_cd
        AND     FCM_PRDCT_TYP       = :st_first_ordbk.c_prd_typ
        AND     FCM_UNDRLYNG        = :st_first_ordbk.c_undrlyng
        AND     FCM_EXPRY_DT        = to_date( :st_first_ordbk.c_expry_dt, 'dd-mon-yyyy' )
        AND     FCM_EXER_TYP        = :st_first_ordbk.c_exrc_typ;
	
		*** Ver 2.3 Comment Ends ***/
	
		/*** Ver 2.3 Starts ***/

			EXEC SQL
        SELECT  FTQ_CNTRCT_TAG
        INTO    :c_cntrct_tag
        FROM    FTQ_FO_TRD_QT
        WHERE   FTQ_XCHNG_CD        = :st_first_ordbk.c_xchng_cd
        AND     FTQ_PRDCT_TYP       = :st_first_ordbk.c_prd_typ
        AND     FTQ_UNDRLYNG        = :st_first_ordbk.c_undrlyng
        AND     FTQ_EXPRY_DT        = to_date( :st_first_ordbk.c_expry_dt, 'dd-mon-yyyy' )
        AND     FTQ_EXER_TYP        = :st_first_ordbk.c_exrc_typ;

		/*** Ver 2.3 Ends ***/

			if ( SQLCODE != 0 )
      {
            fn_errlog( c_ServiceName, "S31360", LIBMSG, c_err_msg  );
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        		tpfree ( ( char * ) ptr_fml_Obuf );	
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
						Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );    /*** Ver 3.2 ***/
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
	
		  if(DEBUG_MSG_LVL_0) /*** added in Ver 2.3 ***/	
			{
    		fn_userlog( c_ServiceName, "c_cntrct_tag :%c:", c_cntrct_tag);				
			}

	 	 EXEC SQL
    	  UPDATE  FUP_FUT_UNDRLYNG_PSTN
      	SET FUP_ADD_MRGN_VAL    		= FUP_ADD_MRGN_VAL + :d_total_def * (-1)
				WHERE   FUP_CLM_MTCH_ACCNT  = :st_first_ordbk.c_cln_mtch_accnt
      	AND 	    FUP_XCHNG_CD      = :st_first_ordbk.c_xchng_cd
      	AND   	  FUP_PRDCT_TYP     = :st_first_ordbk.c_prd_typ
      	AND     FUP_UNDRLYNG        = :st_first_ordbk.c_undrlyng
      	AND     FUP_CNTRCT_TAG      = :c_cntrct_tag;	
	
			if ( SQLCODE != 0 )
    	{
						fn_errlog( c_ServiceName, "S31365", LIBMSG, c_err_msg  );
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        		tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    	}
		}
		}
		else
		{
			if ( d_diff_mrgn < 0  )
    	{
				c_diff_mrgn_flg = 'Y';  /*** Ver 2.8 ***/
			
      i_returncode = fn_upd_spnlimits( c_ServiceName,
                                    &st_pstn_action,
                                    ptr_st_err,
                                    c_narration_id,
                                    c_dr_without_lmt_flg,
                                    d_diff_mrgn,
                                    &d_balance_amt);
      if ( i_returncode != 0 )
      {
        switch ( i_returncode )
        {
          case  INSUFFICIENT_LIMITS :
            fn_userlog(c_ServiceName," Inside INSUFFICIENT_LIMITS.");
            fn_errlog( c_ServiceName, "S31370", LIBMSG, c_err_msg  );
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );

            /**** Ver 1.4 Starts Here *****/
            c_insuff_flg = 'Y';
            if(DEBUG_MSG_LVL_2)
            {
             fn_userlog(c_ServiceName,"d_balance_amt :%lf:",d_balance_amt);
             fn_userlog(c_ServiceName," d_diff_mrgn  :%lf:",d_diff_mrgn);
             fn_userlog(c_ServiceName," d_diff_pnl   :%lf:",d_diff_pnl);
            }

            d_required_amt = d_diff_mrgn + d_balance_amt;
            if( d_diff_pnl < 0 )
            {
              d_required_amt = d_required_amt + d_diff_pnl;
            }
 
            if(DEBUG_MSG_LVL_2)
            {
             fn_userlog(c_ServiceName,"d_required_amt ::%lf:",d_required_amt);
            }
            /**** Ver 1.4 Ends Here ******/

            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );

         default:
            fn_errlog( c_ServiceName, "S31375", LIBMSG, c_err_msg  );
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
			d_total_def = d_total_def + d_diff_mrgn; 
    }

    MEMSET(c_narration_id);
    if (c_spl_flg == ROLLOVER_WITH_SPREAD ) /*** added in ver 2.8 *****/
    {
     strcpy( c_narration_id , BLOCK_PNL_ON_RWS_ORDER_PLACEMENT);
    }
    else
    {
     strcpy( c_narration_id , BLOCK_PNL_ON_ROLLOVER_ORDER_PLACEMENT);/*** 2.8 need to handle ***/
    }
    if(DEBUG_MSG_LVL_0)
    {
        fn_userlog(c_ServiceName,"c_narration_id .  |%s| ",c_narration_id);
        fn_userlog(c_ServiceName,"d_diff_pnl .  |%lf| ",d_diff_pnl);
        fn_userlog(c_ServiceName,"ptr_st_pstn_actn_mn.c_cln_mtch_accnt.  |%s| ",ptr_st_pstn_actn_mn.c_cln_mtch_accnt);
        fn_userlog(c_ServiceName,"ptr_st_pstn_actn_mn.c_xchng_cd.  |%s| ",ptr_st_pstn_actn_mn.c_xchng_cd);
    }

		if ( d_diff_pnl < 0  )
    {
			c_diff_pnl_flg = 'Y'; /*** Ver 2.8 ***/

      i_returncode = fn_upd_spnlimits( c_ServiceName,
                                    &st_pstn_action,
                                    ptr_st_err,
                                    c_narration_id,
                                    c_dr_without_lmt_flg,
                                    d_diff_pnl,
                                    &d_balance_amt);
      if ( i_returncode != 0 )
      {
        switch ( i_returncode )
        {
          case  INSUFFICIENT_LIMITS :
            fn_userlog(c_ServiceName," Inside INSUFFICIENT_LIMITS.");
            fn_errlog( c_ServiceName, "S31380", LIBMSG, c_err_msg  );
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        		tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
 
            /**** Ver 1.4 Starts Here *****/
            c_insuff_flg = 'Y';
            if(DEBUG_MSG_LVL_3)
            {
             fn_userlog(c_ServiceName,"d_balance_amt :%lf:",d_balance_amt);
             fn_userlog(c_ServiceName," d_diff_mrgn  :%lf:",d_diff_mrgn);
             fn_userlog(c_ServiceName," d_diff_pnl   :%lf:",d_diff_pnl);
            }

            d_required_amt = d_diff_pnl + d_balance_amt;

            if(DEBUG_MSG_LVL_3)
            {
             fn_userlog(c_ServiceName,"d_required_amt ::%lf:",d_required_amt);
            }
            /**** Ver 1.4 Ends Here ******/
               
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );

         default:
            fn_errlog( c_ServiceName, "S31385", LIBMSG, c_err_msg  );
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
						tpfree ( ( char * ) ptr_fml_Sbuf );
        		tpfree ( ( char * ) ptr_fml_Rbuf );
        		tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
			d_total_def = d_total_def + d_diff_pnl;
    }

    /*** Ver 2.8 Starts ***/
    if( c_opn_typ == 'S' || c_opn_typ == 'R' )	/*** c_opn_typ 'R' Added for Live Issue ***/
    {
      if(DEBUG_MSG_LVL_5) 
      {
        fn_userlog(c_ServiceName,"Before update margin in SPAN Case :Bhushan");
        fn_userlog(c_ServiceName,"d_diff_mrgn :%lf:",d_diff_mrgn);
        fn_userlog(c_ServiceName,"d_diff_pnl :%lf:",d_diff_pnl);
        fn_userlog(c_ServiceName,"c_diff_mrgn_flg :%c:",c_diff_mrgn_flg);
        fn_userlog(c_ServiceName,"c_diff_pnl_flg :%c:",c_diff_pnl_flg);
      }

      EXEC SQL
        UPDATE FOD_FO_ORDR_DTLS
        SET FOD_SROLL_DIFF_AMT = DECODE(:c_diff_mrgn_flg,'Y',:d_diff_mrgn * (-1),FOD_SROLL_DIFF_AMT),
            FOD_SROLL_LSS_AMT = DECODE(:c_diff_pnl_flg,'Y',:d_diff_pnl * (-1),FOD_SROLL_LSS_AMT)
        WHERE FOD_ORDR_RFRNC = :st_first_ordbk.c_ordr_rfrnc
        AND   FOD_XCHNG_CD = :st_first_ordbk.c_xchng_cd
        AND   FOD_PRDCT_TYP = :st_first_ordbk.c_prd_typ
        AND   FOD_UNDRLYNG = :st_first_ordbk.c_undrlyng
        AND   FOD_EXPRY_DT = :st_first_ordbk.c_expry_dt;

      if ( SQLCODE != 0 )
      {
        fn_errlog( c_ServiceName, "S51331", SQLMSG, c_err_msg  );
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }
    /*** Ver 2.8 Ends ***/

    if (d_total_def < 0 && c_opn_typ == 'R' ) /*** 'else if' replaced with 'if' in Ver 2.8 ***/
    {

      EXEC SQL
				UPDATE  FUS_FO_UNDRLYNG_SPN_PSTN
        SET 		FUS_BLCKD_PL        = FUS_BLCKD_PL + :d_total_def * (-1)
        WHERE   FUS_CLM_MTCH_ACCNT  = :st_first_ordbk.c_cln_mtch_accnt
        AND     FUS_XCHNG_CD      = :st_first_ordbk.c_xchng_cd
        AND     FUS_UNDRLYNG        = :st_first_ordbk.c_undrlyng;

      if ( SQLCODE != 0 )
      {
            fn_errlog( c_ServiceName, "S31390", LIBMSG, c_err_msg  );
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }	
		}

    if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
    {
      tpfree ( ( char * ) ptr_fml_Obuf );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); /** Ver 2.1 **/
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); /** Ver 2.1 **/
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }
      /** ver 3.6 start **/
   i_returncode = fn_upd_mrgn_reporting(ptr_st_pstn_actn_mn.c_cln_mtch_accnt,
                                       ptr_st_pstn_actn_mn.c_xchng_cd,
                                       c_ServiceName,
                                       c_err_msg
                                      );
  if( i_returncode != 0 )
  {
    fn_errlog(c_ServiceName, "S31395", LIBMSG, c_err_msg );
      tpfree ( ( char * ) ptr_fml_Obuf );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 }
/** ver 3.6 end **/ 
	}
	/** Ver 2.8 Starts here ***/
	else if( c_opn_typ == 'S' && c_sub_rqst_typ == MODIFY )
  {
		for( i_cnt=0; i_cnt < i_tot_rec; i_cnt++)
		{
      i_err[0]= Fget32(ptr_fml_Ibuf, FFO_XCHNG_CD,i_cnt, (char *)st_ordbook.c_xchng_cd, 0);
      i_ferr [ 0 ] = Ferror32;

      i_err[1]= Fget32(ptr_fml_Ibuf, FFO_ORDR_FLW,i_cnt, (char *)&st_ordbook.c_ordr_flw, 0);
      i_ferr [ 1 ] = Ferror32;

      i_err[2]= Fget32(ptr_fml_Ibuf, FFO_LMT_MKT_SL_FLG,i_cnt, (char *)&st_ordbook.c_slm_flg, 0);
      i_ferr [ 2 ] = Ferror32;

      i_err[3]= Fget32(ptr_fml_Ibuf, FFO_ORD_TOT_QTY,i_cnt, (char *)&st_ordbook.l_ord_tot_qty, 0);
      i_ferr [ 3 ] = Ferror32;

      i_err[4]= Fget32(ptr_fml_Ibuf, FFO_LMT_RT,i_cnt, (char *)&st_ordbook.l_ord_lmt_rt, 0);
      i_ferr [ 4 ] = Ferror32;

      i_err[5]= Fget32(ptr_fml_Ibuf, FFO_ORDR_RFRNC,i_cnt, (char *)st_ordbook.c_ordr_rfrnc, 0);
      i_ferr [ 5 ] = Ferror32;

      i_err[6]= Fget32(ptr_fml_Ibuf, FFO_ORD_VALID_DT,i_cnt, (char *)st_ordbook.c_valid_dt, 0);
      i_ferr [ 6 ] = Ferror32;

      i_err[7]= Fget32(ptr_fml_Ibuf, FFO_UNDRLYNG,i_cnt, (char *)st_ordbook.c_undrlyng, 0);
      i_ferr [ 7 ] = Ferror32;

      i_err[8]= Fget32(ptr_fml_Ibuf, FFO_PRDCT_TYP,i_cnt, (char *)&st_ordbook.c_prd_typ, 0);
      i_ferr [ 8 ] = Ferror32;

      i_err[9]= Fget32(ptr_fml_Ibuf, FFO_EXPRY_DT,i_cnt, (char *)c_exp_dt.arr, 0);
      i_ferr [ 9 ] = Ferror32;

      i_err[10]= Fget32(ptr_fml_Ibuf, FFO_EXER_TYP,i_cnt, (char *)&st_ordbook.c_exrc_typ, 0);
      i_ferr [ 10 ] = Ferror32;

      i_err[ 11 ]= Fget32(ptr_fml_Ibuf, FFO_OPT_TYP,i_cnt, (char *)&st_ordbook.c_opt_typ, 0);
      i_ferr [ 11 ] = Ferror32;

      i_err[12]= Fget32(ptr_fml_Ibuf, FFO_STRK_PRC,i_cnt, (char *)&st_ordbook.l_strike_prc, 0);
      i_ferr [ 12 ] = Ferror32;

      for(i=0; i < 13; i++)
      {
        if ( (i_err[ i ] == -1 ) )
        {
          fn_errlog( c_ServiceName, "S31400", Fstrerror32(i_ferr[i]),c_err_msg);
          fn_userlog(c_ServiceName,"Error in field %d in record no %d",i,i_cnt );
          fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
          tpfree ( ( char * ) ptr_fml_Sbuf );
          tpfree ( ( char * ) ptr_fml_Rbuf );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
          Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
			/** Ver 3.3 comment starts ****
      if(DEBUG_MSG_LVL_0)
      {
        fn_userlog(c_ServiceName, "st_ordbook.c_undrlyng is :%s:",st_ordbook.c_undrlyng );
      }

      i_returncode = fn_chk_und_insider(c_ServiceName,
                                        st_usr_prfl,
                                        st_ordbook.c_undrlyng,
                                        &insider_exist);
      if (i_returncode == -1)
      {
          fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
          tpfree ( ( char * ) ptr_fml_Sbuf );
          tpfree ( ( char * ) ptr_fml_Rbuf );
          tpfree ( ( char * ) ptr_fml_Obuf );
          fn_errlog( c_ServiceName, "S31405", "Error in Function fn_chk_und_insider", c_err_msg);
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
          Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      if (insider_exist == 1)
      {
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        fn_errlog( c_ServiceName, "B21042", DEFMSG, c_err_msg  );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
			****** Ver 3.3 ends ***/
      if(st_usr_prfl.c_user_id[0] == BPID)
      {
        if(Fget32(ptr_fml_Ibuf,FFO_ALIAS,i_cnt,(char *)c_alias,0) == -1)
        {
          fn_errlog( c_ServiceName, "S31410", FMLMSG, c_err_msg  );
          fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
          tpfree ( ( char * ) ptr_fml_Sbuf );
          tpfree ( ( char * ) ptr_fml_Rbuf );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
          Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }

      SETLEN(c_exp_dt);

      strcpy ( st_ordbook.c_expry_dt, ( char * ) c_exp_dt.arr );

      if(DEBUG_MSG_LVL_0)
      {
        fn_userlog( c_ServiceName, "Input Data for order no :%d:",i_cnt);
        fn_userlog( c_ServiceName, "Exchange code :%s:", st_ordbook.c_xchng_cd );
        fn_userlog( c_ServiceName, "Product Type  :%c:", st_ordbook.c_prd_typ );
        fn_userlog( c_ServiceName, "Underlyng     :%s:", st_ordbook.c_undrlyng );
        fn_userlog( c_ServiceName, "Expiry date   :%s:", st_ordbook.c_expry_dt);
        fn_userlog( c_ServiceName, "Excercise Type:%c:", st_ordbook.c_exrc_typ );
        fn_userlog( c_ServiceName, "Option type   :%c:", st_ordbook.c_opt_typ );
        fn_userlog( c_ServiceName, "Strike price  :%ld:", st_ordbook.l_strike_prc );
        fn_userlog( c_ServiceName, "Order flow B/S:%c:", st_ordbook.c_ordr_flw );
        fn_userlog( c_ServiceName, "Lmt/Mkt/StpLss:%c:", st_ordbook.c_slm_flg );
        fn_userlog( c_ServiceName, "Order Qty     :%ld:", st_ordbook.l_ord_tot_qty );
        fn_userlog( c_ServiceName, "Limit rate    :%ld:", st_ordbook.l_ord_lmt_rt );
        fn_userlog( c_ServiceName, "Reference No. :%s:", st_ordbook.c_ordr_rfrnc );
        fn_userlog( c_ServiceName, "Valid Date    :%s:",st_ordbook.c_valid_dt);
      }

      if ( st_ordbook.l_ord_tot_qty <= 0 )
      {
        fn_userlog( c_ServiceName,"Quantity cannot be Zero.");
        fn_errlog( c_ServiceName, "B14012",DEFMSG,c_err_msg);
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      strcpy ( st_pstn_action.c_cln_mtch_accnt,st_usr_prfl.c_cln_mtch_accnt);
      strcpy ( st_pstn_action.c_xchng_cd, st_ordbook.c_xchng_cd );
      strcpy ( ptr_st_pstn_actn_mn.c_cln_mtch_accnt,st_usr_prfl.c_cln_mtch_accnt);
      strcpy ( ptr_st_pstn_actn_mn.c_xchng_cd, st_ordbook.c_xchng_cd );

      if(i_cnt == 0 )
      {
        strcpy(st_first_ordbk.c_cln_mtch_accnt, st_usr_prfl.c_cln_mtch_accnt);
        st_first_ordbk.l_ord_tot_qty = st_ordbook.l_ord_tot_qty;
        strcpy(st_first_ordbk.c_xchng_cd ,st_ordbook.c_xchng_cd);
        st_first_ordbk.c_prd_typ = st_ordbook.c_prd_typ;
        strcpy(st_first_ordbk.c_undrlyng ,st_ordbook.c_undrlyng);
        strcpy(st_first_ordbk.c_expry_dt ,st_ordbook.c_expry_dt);
        st_first_ordbk.c_exrc_typ = st_ordbook.c_exrc_typ;
        st_first_ordbk.c_opt_typ = st_ordbook.c_opt_typ;
        st_first_ordbk.l_strike_prc = st_ordbook.l_strike_prc;
        st_first_ordbk.c_ordr_flw   = st_ordbook.c_ordr_flw;
        st_first_ordbk.l_ord_lmt_rt  = st_ordbook.l_ord_lmt_rt;
        st_first_ordbk.c_ctgry_indstk = st_ordbook.c_ctgry_indstk;
        st_first_ordbk.c_slm_flg = st_ordbook.c_slm_flg;
        strcpy(st_first_ordbk.c_pipe_id,st_usr_prfl.c_pipe_id);
        st_first_ordbk.c_spl_flg = c_spl_flg;
	      strcpy(c_sprd_exp_dt1,st_first_ordbk.c_expry_dt); 
        strcpy( st_first_ordbk.c_ordr_rfrnc,st_ordbook.c_ordr_rfrnc); /*** suchita ***/
      }
      else
      {
        strcpy(st_next_ordbk.c_cln_mtch_accnt, st_usr_prfl.c_cln_mtch_accnt);
        st_next_ordbk.l_ord_tot_qty = st_ordbook.l_ord_tot_qty;
        strcpy(st_next_ordbk.c_xchng_cd ,st_ordbook.c_xchng_cd);
        st_next_ordbk.c_prd_typ = st_ordbook.c_prd_typ;
        strcpy(st_next_ordbk.c_undrlyng ,st_ordbook.c_undrlyng);
        strcpy(st_next_ordbk.c_expry_dt ,st_ordbook.c_expry_dt);
        st_next_ordbk.c_exrc_typ = st_ordbook.c_exrc_typ;
        st_next_ordbk.c_opt_typ = st_ordbook.c_opt_typ;
        st_next_ordbk.l_strike_prc = st_ordbook.l_strike_prc;
        st_next_ordbk.c_ordr_flw   = st_ordbook.c_ordr_flw;
        st_next_ordbk.l_ord_lmt_rt  = st_ordbook.l_ord_lmt_rt;
        st_next_ordbk.c_ctgry_indstk = st_ordbook.c_ctgry_indstk;
        st_next_ordbk.c_slm_flg = st_ordbook.c_slm_flg;
        strcpy(st_next_ordbk.c_pipe_id,st_usr_prfl.c_pipe_id);
        st_next_ordbk.c_spl_flg = c_spl_flg;
				strcpy(c_sprd_exp_dt2,st_next_ordbk.c_expry_dt);  

        if( ( strcmp(st_first_ordbk.c_xchng_cd,st_next_ordbk.c_xchng_cd)==0) &&
          (st_first_ordbk.c_prd_typ == st_next_ordbk.c_prd_typ)            &&
          ( strcmp(st_first_ordbk.c_undrlyng,st_next_ordbk.c_undrlyng)==0) &&
          ( strcmp(st_first_ordbk.c_expry_dt,st_next_ordbk.c_expry_dt)==0) &&
          (st_first_ordbk.c_exrc_typ == st_next_ordbk.c_exrc_typ)          &&
          (st_first_ordbk.c_opt_typ == st_next_ordbk.c_opt_typ)            &&
          (st_first_ordbk.l_strike_prc == st_next_ordbk.l_strike_prc)        )
          {
            fn_errlog( c_ServiceName, "B28551",DEFMSG,c_err_msg);
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            tpfree ( ( char * ) ptr_fml_Sbuf );
            tpfree ( ( char * ) ptr_fml_Rbuf );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
          }

        i_returncode = fn_chk_sprd_trdng_qt(c_ServiceName,st_first_ordbk,st_next_ordbk,c_sub_rqst_typ,c_err_msg);

        if( i_returncode != 0 )
        {
          fn_userlog( c_ServiceName, "Error inside fn_chk_sprd_trdng_qt");
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
          fn_errlog( c_ServiceName, "S28551",DEFMSG,c_err_msg);
          fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
          tpfree ( ( char * ) ptr_fml_Sbuf );
          tpfree ( ( char * ) ptr_fml_Rbuf );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
          Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }

      EXEC SQL
        SELECT  NVL(CLM_SPAN_ALLWD,'N')
        INTO    :c_spn_allwd_flg
        FROM    CLM_CLNT_MSTR
        WHERE   CLM_MTCH_ACCNT  = :st_usr_prfl.c_cln_mtch_accnt;

      if ( SQLCODE  !=  0 )
      {
        fn_errlog( c_ServiceName, "S31415",SQLMSG,c_err_msg);
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
				Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );    /*** Ver 3.2 ***/
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      c_insuff_flg = 'N';
      d_required_amt = 0.0;

      strcpy ( st_ordbook.c_cln_mtch_accnt,st_usr_prfl.c_cln_mtch_accnt);

      if ( i_cnt == 1 )
      {
        if ( c_spn_allwd_flg == 'Y' )
        {
          i_returncode = fn_chk_spn_mrgn(c_ServiceName,st_first_ordbk,st_next_ordbk,&st_pstn_action,&d_diff_mrgn,&d_diff_pnl,c_sub_rqst_typ,c_err_msg);

          if ( i_returncode != 0 )
          {
            switch( i_returncode )
            {
              case INSUFFICIENT_LIMITS  :
              fn_userlog( c_ServiceName, "INSUFFICIENT_LIMITS SPAN");
              fn_userlog( c_ServiceName,"Error Message :%s:",c_err_msg);
              tpfree ( ( char * ) ptr_fml_Sbuf );
              tpfree ( ( char * ) ptr_fml_Rbuf );
              tpfree ( ( char * ) ptr_fml_Obuf );
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
             /**  fn_errlog( c_ServiceName, "B22003",DEFMSG , c_err_msg ); suchita ***/
              fn_userlog( c_ServiceName,"Error Message :%s:",c_err_msg);
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
              strcpy(c_err_msg,strtok(c_err_msg,"<"));
              /** d_required_amt = atof(strtok(NULL,">")); suchita **/
              sscanf(strtok(NULL,">"),"%lf",&d_required_amt); /** suchita ***/
              fn_userlog( c_ServiceName,"SUCHITA d_required_amt :%lf:",d_required_amt);
              Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );

              c_insuff_flg = 'Y';
              if(DEBUG_MSG_LVL_2)
              {
               fn_userlog(c_ServiceName,"c_err_msg :%s:",c_err_msg);
               fn_userlog(c_ServiceName,"d_required_amt :%lf:",d_required_amt);
               fn_userlog(c_ServiceName,"Inside span margin");

              }
              Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT, (char *)&d_required_amt, 0);
              Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
              c_actn_flg = 'P';

              i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );
              if ( i_trnsctn == -1 )
              {
                fn_errlog( c_ServiceName, "S31420",LIBMSG,c_err_msg);
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID, (char *)&i_actn_id, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              i_returncode =  fn_ins_ffl_log_tbl  (  c_ServiceName,
                                                     st_ordbook,
                                                     c_err_msg,
                                                     d_required_amt,
                                                     c_actn_flg
                                                  );
              if ( i_returncode != 0 )
              {
                fn_errlog( c_ServiceName, "S31425", LIBMSG, c_err_msg  );
                fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID , (char *)&i_actn_id , 0 );
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
              {
                fn_errlog( c_ServiceName, "S31430",LIBMSG,c_err_msg);
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID, (char *)&i_actn_id, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              tpreturn(TPFAIL,INSUFFICIENT_LIMITS, (char *)ptr_fml_Ibuf, 0, 0 );

              break;

              default :
              fn_userlog( c_ServiceName, " Inside ERROR for SPAN");
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
              Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
              Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
              Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
              tpreturn(TPFAIL,ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
            }
          }
        }
        else if ( c_spn_allwd_flg == 'N' )
        {
          i_returncode = fn_chk_nrml_mrgn(c_ServiceName,st_first_ordbk,st_next_ordbk,&d_diff_mrgn,&d_diff_pnl,c_sub_rqst_typ,c_err_msg);

          if ( i_returncode != 0 )
          {
            switch( i_returncode )
            {
              case INSUFFICIENT_LIMITS  :
              fn_userlog( c_ServiceName, "INSUFFICIENT_LIMITS_2 Normal");

              c_insuff_flg = 'Y';
              if(DEBUG_MSG_LVL_2)
              {
               fn_userlog(c_ServiceName,"c_err_msg :%s:",c_err_msg);
               fn_userlog(c_ServiceName,"d_required_amt :%lf:",d_required_amt);
               fn_userlog(c_ServiceName,"Inside normal margin");
              }

              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              tpfree ( ( char * ) ptr_fml_Sbuf );
              tpfree ( ( char * ) ptr_fml_Rbuf );
              tpfree ( ( char * ) ptr_fml_Obuf );
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
              Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
              strcpy(c_err_msg,strtok(c_err_msg,"<"));
              d_required_amt = atof(strtok(NULL,">"));  
              Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT, (char *)&d_required_amt, 0);
              Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);

              c_actn_flg = 'P';

              i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );
              if ( i_trnsctn == -1 )
              {
                fn_errlog( c_ServiceName, "S31435",LIBMSG,c_err_msg);
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID, (char *)&i_actn_id, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              i_returncode =  fn_ins_ffl_log_tbl  (  c_ServiceName,
                                                     st_ordbook,
                                                     c_err_msg,
                                                     d_required_amt,
                                                     c_actn_flg
                                                  );

              if ( i_returncode != 0 )
              {
                fn_errlog( c_ServiceName, "S31440", LIBMSG, c_err_msg  );
                fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID , (char *)&i_actn_id , 0 );
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );

              }

              if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
              {
                fn_errlog( c_ServiceName, "S31445",LIBMSG,c_err_msg);
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID, (char *)&i_actn_id, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              tpreturn(TPFAIL, INSUFFICIENT_LIMITS, (char *)ptr_fml_Ibuf, 0, 0 );

              break;

              default :
              fn_userlog( c_ServiceName, " Inside ERROR for Normal");
              fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
              tpfree ( ( char * ) ptr_fml_Sbuf );
              tpfree ( ( char * ) ptr_fml_Rbuf );
              tpfree ( ( char * ) ptr_fml_Obuf );
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
              Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
              Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
              Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
            }
          }
        }
        else
        {
          strcpy( c_err_msg, "Invalid User type");
          fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
          tpfree ( ( char * ) ptr_fml_Sbuf );
          tpfree ( ( char * ) ptr_fml_Rbuf );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
          Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
    }

    fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg ); /** Transaction aborted ***/

    i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

    if ( i_trnsctn == -1 )
    {
      fn_errlog( c_ServiceName, "S31450", LIBMSG , c_err_msg );
      tpfree ( ( char * ) ptr_fml_Sbuf );
      tpfree ( ( char * ) ptr_fml_Rbuf );
      tpfree ( ( char * ) ptr_fml_Obuf );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

    i_returncode = fn_lock_usr( c_ServiceName, st_usr_prfl.c_cln_mtch_accnt );

    if ( i_returncode == -1 )
    {
      fn_errlog( c_ServiceName, "S31455", LIBMSG , c_err_msg );
      fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

    for( i_cnt=0; i_cnt < i_tot_rec; i_cnt++)  /*** Modification Service call ***/
    {

      i_err[0]= Fget32(ptr_fml_Ibuf, FFO_XCHNG_CD,i_cnt, (char *)st_ordbook.c_xchng_cd, 0);
      i_ferr [ 0 ] = Ferror32;

      i_err[1]= Fget32(ptr_fml_Ibuf, FFO_ORDR_FLW,i_cnt, (char *)&st_ordbook.c_ordr_flw, 0);
      i_ferr [ 1 ] = Ferror32;

      i_err[2]= Fget32(ptr_fml_Ibuf, FFO_LMT_MKT_SL_FLG,i_cnt, (char *)&st_ordbook.c_slm_flg, 0);
      i_ferr [ 2 ] = Ferror32;

      i_err[3]= Fget32(ptr_fml_Ibuf, FFO_ORD_TOT_QTY,i_cnt, (char *)&st_ordbook.l_ord_tot_qty, 0);
      i_ferr [ 3 ] = Ferror32;

      i_err[4]= Fget32(ptr_fml_Ibuf, FFO_LMT_RT,i_cnt, (char *)&st_ordbook.l_ord_lmt_rt, 0);
      i_ferr [ 4 ] = Ferror32;

      i_err[5]= Fget32(ptr_fml_Ibuf, FFO_ORDR_RFRNC,i_cnt, (char *)st_ordbook.c_ordr_rfrnc, 0);
      i_ferr [ 5 ] = Ferror32;

      i_err[6]= Fget32(ptr_fml_Ibuf, FFO_ORD_VALID_DT,i_cnt, (char *)st_ordbook.c_valid_dt, 0);
      i_ferr [ 6 ] = Ferror32;

      i_err[7]= Fget32(ptr_fml_Ibuf, FFO_UNDRLYNG,i_cnt, (char *)st_ordbook.c_undrlyng, 0);
      i_ferr [ 7 ] = Ferror32;

      i_err[8]= Fget32(ptr_fml_Ibuf, FFO_PRDCT_TYP,i_cnt, (char *)&st_ordbook.c_prd_typ, 0);
      i_ferr [ 8 ] = Ferror32;

      i_err[9]= Fget32(ptr_fml_Ibuf, FFO_EXPRY_DT,i_cnt, (char *)c_exp_dt.arr, 0);
      i_ferr [ 9 ] = Ferror32;

      i_err[10]= Fget32(ptr_fml_Ibuf, FFO_EXER_TYP,i_cnt, (char *)&st_ordbook.c_exrc_typ, 0);
      i_ferr [ 10 ] = Ferror32;

      i_err[ 11 ]= Fget32(ptr_fml_Ibuf, FFO_OPT_TYP,i_cnt, (char *)&st_ordbook.c_opt_typ, 0);
      i_ferr [ 11 ] = Ferror32;

      i_err[12]= Fget32(ptr_fml_Ibuf, FFO_STRK_PRC,i_cnt, (char *)&st_ordbook.l_strike_prc, 0);
      i_ferr [ 12 ] = Ferror32;

      for(i=0; i < 13; i++)
      {
        if ( (i_err[ i ] == -1 ) )
        {
          fn_errlog( c_ServiceName, "S31460", Fstrerror32(i_ferr[i]),c_err_msg);
          fn_userlog(c_ServiceName,"Error in field %d in record no %d",i,i_cnt );
          fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
          tpfree ( ( char * ) ptr_fml_Sbuf );
          tpfree ( ( char * ) ptr_fml_Rbuf );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
          Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }

      if(st_usr_prfl.c_user_id[0] == BPID)
      {
        if(Fget32(ptr_fml_Ibuf,FFO_ALIAS,i_cnt,(char *)c_alias,0) == -1)
        {
          fn_errlog( c_ServiceName, "S31465", FMLMSG, c_err_msg  );
          fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
          tpfree ( ( char * ) ptr_fml_Sbuf );
          tpfree ( ( char * ) ptr_fml_Rbuf );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
          Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }

      SETLEN(c_exp_dt);

      strcpy ( st_ordbook.c_expry_dt, ( char * ) c_exp_dt.arr );

      if(DEBUG_MSG_LVL_5)
      {
        fn_userlog( c_ServiceName, "Input Data for order no :%d:",i_cnt);
        fn_userlog( c_ServiceName, "Exchange code :%s:", st_ordbook.c_xchng_cd );
        fn_userlog( c_ServiceName, "Product Type  :%c:", st_ordbook.c_prd_typ );
        fn_userlog( c_ServiceName, "Underlyng     :%s:", st_ordbook.c_undrlyng );
        fn_userlog( c_ServiceName, "Expiry date   :%s:", st_ordbook.c_expry_dt);
        fn_userlog( c_ServiceName, "Excercise Type:%c:", st_ordbook.c_exrc_typ );
        fn_userlog( c_ServiceName, "Option type   :%c:", st_ordbook.c_opt_typ );
        fn_userlog( c_ServiceName, "Strike price  :%ld:", st_ordbook.l_strike_prc );
        fn_userlog( c_ServiceName, "Category      :%c:", st_ordbook.c_ctgry_indstk );
        fn_userlog( c_ServiceName, "Order flow B/S:%c:", st_ordbook.c_ordr_flw );
        fn_userlog( c_ServiceName, "Lmt/Mkt/StpLss:%c:", st_ordbook.c_slm_flg );
        fn_userlog( c_ServiceName, "Order Qty     :%ld:", st_ordbook.l_ord_tot_qty );
        fn_userlog( c_ServiceName, "Limit rate    :%ld:", st_ordbook.l_ord_lmt_rt );
        fn_userlog( c_ServiceName, "Reference No. :%s:", st_ordbook.c_ordr_rfrnc );
        fn_userlog( c_ServiceName, "Valid Date    :%s:",st_ordbook.c_valid_dt);
      }

      st_ordbook.l_dsclsd_qty = 0 ;
      st_ordbook.l_stp_lss_tgr = 0 ;
      st_ordbook.c_ord_typ = GOOD_TILL_TODAY;

      if(i_cnt == 0 )
      {
        strcpy(st_first_ordbk.c_cln_mtch_accnt, st_usr_prfl.c_cln_mtch_accnt);
        st_first_ordbk.l_ord_tot_qty = st_ordbook.l_ord_tot_qty;
        strcpy(st_first_ordbk.c_xchng_cd ,st_ordbook.c_xchng_cd);
        st_first_ordbk.c_prd_typ = st_ordbook.c_prd_typ;
        strcpy(st_first_ordbk.c_undrlyng ,st_ordbook.c_undrlyng);
        strcpy(st_first_ordbk.c_expry_dt ,st_ordbook.c_expry_dt);
        st_first_ordbk.c_exrc_typ = st_ordbook.c_exrc_typ;
        st_first_ordbk.c_opt_typ = st_ordbook.c_opt_typ;
        st_first_ordbk.l_strike_prc = st_ordbook.l_strike_prc;
        st_first_ordbk.c_ordr_flw   = st_ordbook.c_ordr_flw;
        st_first_ordbk.l_ord_lmt_rt  = st_ordbook.l_ord_lmt_rt;
        st_first_ordbk.c_ctgry_indstk = st_ordbook.c_ctgry_indstk;
        st_first_ordbk.c_slm_flg = st_ordbook.c_slm_flg;
        strcpy(st_first_ordbk.c_pipe_id,st_usr_prfl.c_pipe_id);
        strcpy(st_first_ordbk.c_ordr_rfrnc,st_ordbook.c_ordr_rfrnc);

        /*** bhushan comment Starts SPREAD_BOOK *** handling for spread book mod and cancle will be done after  ack response *****
        EXEC SQL
          SELECT FSD_SPRD_RFRNC
          INTO   :c_sprdordr_rfrnc
          FROM   FSD_FO_SPRD_DTLS
          WHERE  FSD_ORDR_RFRNC = :st_first_ordbk.c_ordr_rfrnc;

        if ( SQLCODE  !=  0 )
        {
          fn_errlog( c_ServiceName, "S51450",SQLMSG,c_err_msg);
          fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
          tpfree ( ( char * ) ptr_fml_Sbuf );
          tpfree ( ( char * ) ptr_fml_Rbuf );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
          Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
        *****bhushan comment Ends SPREAD_BOOK ****/
      }
      else
      {
        strcpy(st_next_ordbk.c_cln_mtch_accnt, st_usr_prfl.c_cln_mtch_accnt);
        st_next_ordbk.l_ord_tot_qty = st_ordbook.l_ord_tot_qty;
        strcpy(st_next_ordbk.c_xchng_cd ,st_ordbook.c_xchng_cd);
        st_next_ordbk.c_prd_typ = st_ordbook.c_prd_typ;
        strcpy(st_next_ordbk.c_undrlyng ,st_ordbook.c_undrlyng);
        strcpy(st_next_ordbk.c_expry_dt ,st_ordbook.c_expry_dt);
        st_next_ordbk.c_exrc_typ = st_ordbook.c_exrc_typ;
        st_next_ordbk.c_opt_typ = st_ordbook.c_opt_typ;
        st_next_ordbk.l_strike_prc = st_ordbook.l_strike_prc;
        st_next_ordbk.c_ordr_flw   = st_ordbook.c_ordr_flw;
        st_next_ordbk.l_ord_lmt_rt  = st_ordbook.l_ord_lmt_rt;
        st_next_ordbk.c_ctgry_indstk = st_ordbook.c_ctgry_indstk;
        st_next_ordbk.c_slm_flg = st_ordbook.c_slm_flg;
        strcpy(st_next_ordbk.c_pipe_id,st_usr_prfl.c_pipe_id);

      if( ( strcmp(st_first_ordbk.c_xchng_cd,st_next_ordbk.c_xchng_cd)==0) &&
          (st_first_ordbk.c_prd_typ == st_next_ordbk.c_prd_typ)            &&
          ( strcmp(st_first_ordbk.c_undrlyng,st_next_ordbk.c_undrlyng)==0) &&
          ( strcmp(st_first_ordbk.c_expry_dt,st_next_ordbk.c_expry_dt)==0) &&
          (st_first_ordbk.c_exrc_typ == st_next_ordbk.c_exrc_typ)          &&
          (st_first_ordbk.c_opt_typ == st_next_ordbk.c_opt_typ)            &&
          (st_first_ordbk.l_strike_prc == st_next_ordbk.l_strike_prc)        )
          {
            fn_errlog( c_ServiceName, "B28551",DEFMSG,c_err_msg);
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            tpfree ( ( char * ) ptr_fml_Sbuf );
            tpfree ( ( char * ) ptr_fml_Rbuf );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
          }
      }

      EXEC SQL
        SELECT  NVL(CLM_SPAN_ALLWD,'N')
        INTO    :c_spn_allwd_flg
        FROM    CLM_CLNT_MSTR
        WHERE   CLM_MTCH_ACCNT  = :st_usr_prfl.c_cln_mtch_accnt;

      if ( SQLCODE  !=  0 )
      {
        fn_errlog( c_ServiceName, "S31470",SQLMSG,c_err_msg);
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
			  Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );    /*** Ver 3.2 ***/
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      if(DEBUG_MSG_LVL_0)
      {
        fn_userlog(c_ServiceName,"SPAN ALLWD FLAG IS :%c:",c_spn_allwd_flg);
      }

      if ( c_spn_allwd_flg == 'Y' )
      {
        strcpy(c_srvc_nm,"SFO_SPN_MOD_ORD");
      }
      else if ( c_spn_allwd_flg == 'N' )
      {
        strcpy(c_srvc_nm,"SFO_PLCMOD_FUT");
      }
      else
      {
        strcpy( c_err_msg, "Invalid User type");

        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
				Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );    /*** Ver 3.2 ***/
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      i_err[0] = Fchg32 ( ptr_fml_Sbuf, FFO_XCHNG_CD, 0, (char *)st_ordbook.c_xchng_cd, 0);
      i_ferr [ 0 ] = Ferror32;

      i_err[1] = Fchg32 ( ptr_fml_Sbuf, FFO_ORDR_RFRNC, 0, (char *)st_ordbook.c_ordr_rfrnc, 0);
      i_ferr [ 1 ] = Ferror32;

      i_err[2] = Fchg32 ( ptr_fml_Sbuf, FFO_ORDR_FLW, 0, (char *)&st_ordbook.c_ordr_flw, 0);
      i_ferr [ 2 ] = Ferror32;

      i_err[3] = Fchg32 ( ptr_fml_Sbuf, FFO_LMT_MKT_SL_FLG, 0, (char *)&st_ordbook.c_slm_flg, 0);
      i_ferr [ 3 ] = Ferror32;

      i_err[4] = Fchg32 ( ptr_fml_Sbuf, FFO_ORD_TYP, 0, (char *)&st_ordbook.c_ord_typ, 0);
      i_ferr [ 4 ] = Ferror32;

      i_err[5] = Fchg32 ( ptr_fml_Sbuf, FFO_ORD_TOT_QTY, 0, (char *)&st_ordbook.l_ord_tot_qty, 0);
      i_ferr [ 5 ] = Ferror32;

      i_err[6] = Fchg32 ( ptr_fml_Sbuf, FFO_LMT_RT, 0, (char *)&st_ordbook.l_ord_lmt_rt, 0);
      i_ferr [ 6 ] = Ferror32;

      i_err[7] = Fchg32 ( ptr_fml_Sbuf, FFO_DSCLSD_QTY, 0, (char *)&st_ordbook.l_dsclsd_qty, 0);
      i_ferr [ 7 ] = Ferror32;

      i_err[8] = Fchg32 ( ptr_fml_Sbuf, FFO_STP_LSS_TGR, 0, (char *)&st_ordbook.l_stp_lss_tgr, 0);
      i_ferr [ 8 ] = Ferror32;

      i_err[9] = Fchg32 ( ptr_fml_Sbuf, FFO_ALIAS, 0, (char *)c_alias, 0);
      i_ferr [ 9 ] = Ferror32;

      i_err[10] = Fchg32 ( ptr_fml_Sbuf, FFO_SVC_NAME, 0, (char *)c_srvc_nm, 0);
      i_ferr [ 10 ] = Ferror32;

      i_err[11] = Fchg32 ( ptr_fml_Sbuf, FFO_SPL_FLG, 0, (char *)&c_spl_flg, 0);
      i_ferr [ 11 ] = Ferror32;

      i_err[12] = Fchg32 ( ptr_fml_Sbuf, FFO_ORD_VALID_DT, 0, (char *)st_ordbook.c_valid_dt, 0);
      i_ferr [ 12 ] = Ferror32;

      i_err[13] = Fchg32 ( ptr_fml_Sbuf, FFO_SPRD_ORD_IND, 0, (char *)&c_sprd_ord_ind, 0);
      i_ferr [ 13 ] = Ferror32;

      i_err[14] = Fchg32 ( ptr_fml_Sbuf, FFO_OI_INDCTR, 0, (char *)c_ip_address, 0);
      i_ferr [ 14 ] = Ferror32;

      i_err[15] = Fchg32 ( ptr_fml_Sbuf, FFO_CLSR_TYP, 0, (char *)&c_usr_flg, 0);
      i_ferr [ 15 ] = Ferror32;

			if( i_cnt == 0 )
			{
				i_err[ 16 ] = Fchg32 ( ptr_fml_Sbuf,FFO_EXECN_DT, 0,(char *)c_sprd_exp_dt2, 0);
        i_ferr [ 16 ] = Ferror32;
			}
			else
			{
				i_err[ 16 ] = Fchg32 ( ptr_fml_Sbuf,FFO_EXECN_DT, 0,(char *)c_sprd_exp_dt1, 0);
        i_ferr [ 16 ] = Ferror32;
			}

      for(i=0; i < 17; i++)
      {
        if ( (i_err[ i ] == -1 ) )
        {
          fn_errlog( c_ServiceName, "S31475", Fstrerror32(i_ferr[i]),c_err_msg);
          fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
          tpfree ( ( char * ) ptr_fml_Sbuf );
          tpfree ( ( char * ) ptr_fml_Rbuf );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
          Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }

      i_returncode = tpcall("SFO_ORD_ROUT", (char *)ptr_fml_Sbuf, 0, (char **)&ptr_fml_Rbuf, &l_recvbuff, 0);

      if (i_returncode == -1)
      {
        if (TPCODE != TPESVCFAIL)
        {
          fn_errlog( c_ServiceName, "S31480",TPMSG,c_err_msg);
          fn_userlog( c_ServiceName, "TP CODE IS    |%d|",TPCODE);
        }
        else
        {
          i_returncode = Fget32(ptr_fml_Rbuf, FFO_ERR_MSG, 0, c_err_msg, 0);

          if (i_returncode == -1)
          {
            fn_errlog( c_ServiceName, "S31485",FMLMSG,c_err_msg);
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            tpfree ( ( char * ) ptr_fml_Sbuf );
            tpfree ( ( char * ) ptr_fml_Rbuf );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
          }
        }

        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      i_returncode= Fget32(ptr_fml_Rbuf, FFO_ORDR_RFRNC,0, (char *)st_ordbook.c_ordr_rfrnc, 0);

      if (i_returncode == -1)
      {
        fn_errlog( c_ServiceName, "S31490",FMLMSG,c_err_msg);
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      i_returncode= Fget32(ptr_fml_Rbuf, FFO_PIPE_ID,0, (char *)c_pipe_id, 0);

      if (i_returncode == -1)
      {
        fn_errlog( c_ServiceName, "S31495",FMLMSG,c_err_msg);
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      /*** bhushan comment starts SPREAD_BOOK ****

      i_returncode= Fget32(ptr_fml_Rbuf, FFO_MDFCTN_CNTR ,0, (char *)&l_mdfctn_cntr, 0);

      if (i_returncode == -1)
      {
        fn_errlog( c_ServiceName, "S51475",FMLMSG,c_err_msg);
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      **** testing bhushan ****
      fn_userlog(c_ServiceName,"*******bhushan*******");
      fn_userlog(c_ServiceName,"l_mdfctn_cntr - :%ld: for call  :%d:",l_mdfctn_cntr,i_cnt);
      fn_userlog(c_ServiceName,"st_ordbook.c_ordr_rfrnc - :%s:",st_ordbook.c_ordr_rfrnc);
      fn_userlog(c_ServiceName,"c_pipe_id - :%s:",c_pipe_id);

      ***************************

      ****** Bhushan Comment Ends SPREAD_BOOK ***/

      i_returncode = Fadd32 ( ptr_fml_Obuf, FFO_ORDR_RFRNC, ( char *)st_ordbook.c_ordr_rfrnc, 0 );

      if( i_returncode == -1)
      {
        fn_errlog( c_ServiceName, "S31500",FMLMSG,c_err_msg);
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      i_returncode = Fconcat32(ptr_fml_Obuf,ptr_fml_Rbuf);

      if( i_returncode == -1)
      {
       fn_errlog( c_ServiceName, "S31505",FMLMSG,c_err_msg);
       fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
       tpfree ( ( char * ) ptr_fml_Sbuf );
       tpfree ( ( char * ) ptr_fml_Rbuf );
       tpfree ( ( char * ) ptr_fml_Obuf );
       Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
       Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
       Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
       Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
       tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
       }

      i_err[0] = 0 ;
      i_ferr[0] = 0 ;

      if ( Finit32 ( ptr_fml_Rbuf, ( FLDLEN32 ) Fsizeof32 ( ptr_fml_Rbuf ) ) == -1 )
      {
        fn_errlog( c_ServiceName, "S31510",FMLMSG,c_err_msg);
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      /**** bhushan comment start ***

      strcpy( st_spd_ordbk.c_sprd_ord_rfrnc[i_cnt],c_sprdordr_rfrnc );
      strcpy( st_spd_ordbk.c_ordr_rfrnc[i_cnt],st_ordbook.c_ordr_rfrnc );
      st_spd_ordbk.c_sprd_ord_ind[i_cnt] = c_sprd_ord_ind;
      strcpy( st_spd_ordbk.c_pipe_id[i_cnt],c_pipe_id );
      st_spd_ordbk.l_mdfctn_cntr[i_cnt] = l_mdfctn_cntr;
      st_spd_ordbk.l_ord_tot_qty[i_cnt] = st_ordbook.l_ord_tot_qty;
      st_spd_ordbk.c_rqst_typ[i_cnt] = UPDATE_ORDER_MODIFICATION;

      if(DEBUG_MSG_LVL_5)
      {
        fn_userlog(c_ServiceName,"Printing Values for Instance:%d:",i_cnt);
        fn_userlog(c_ServiceName,"st_spd_ordbk.c_sprd_ord_rfrnc:%s:",st_spd_ordbk.c_sprd_ord_rfrnc[i_cnt]);
        fn_userlog(c_ServiceName,"st_spd_ordbk.c_ordr_rfrnc[i_cnt]:%s:",st_spd_ordbk.c_ordr_rfrnc[i_cnt]);
        fn_userlog(c_ServiceName,"st_spd_ordbk.c_sprd_ord_ind[i_cnt]:%d:",st_spd_ordbk.c_sprd_ord_ind[i_cnt]);
        fn_userlog(c_ServiceName,"st_spd_ordbk.c_pipe_id[i_cnt]:%s:",st_spd_ordbk.c_pipe_id[i_cnt]);
        fn_userlog(c_ServiceName,"st_spd_ordbk.l_mdfctn_cntr[i_cnt]:%ld:",st_spd_ordbk.l_mdfctn_cntr[i_cnt]);
        fn_userlog(c_ServiceName,"st_spd_ordbk.l_ord_tot_qty[i_cnt]:%ld:",st_spd_ordbk.l_ord_tot_qty[i_cnt]);
      }
      ***** bhushan Comment Ends ****/
    }

    tpfree ( ( char * ) ptr_fml_Rbuf );
    tpfree ( ( char * ) ptr_fml_Sbuf );

    /**** bhushan comment Stasrt ****

    i_ip_len = sizeof ( struct vw_spdordbk );
    i_op_len = sizeof ( struct vw_spdordbk );

    fn_cpy_ddr ( st_spd_ordbk.c_rout_crt );

    i_returncode = fn_call_svc( c_ServiceName,
                                c_err_msg,
                                &st_spd_ordbk,
                                &st_spd_ordbk,
                                "vw_spdordbk",
                                "vw_spdordbk",
                                i_ip_len,
                                i_op_len,
                                0,
                                "SFO_UPD_SPDBK" );
    if ( i_returncode != 0 )
    {
      fn_errlog( c_ServiceName, "S31515", LIBMSG, c_err_msg  );
      fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
      tpfree ( ( char * ) ptr_fml_Obuf );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

    if(DEBUG_MSG_LVL_3)
    {
        fn_userlog(c_ServiceName,"After Spread Book. ");
    }

      ****** bhushan comment End***/

    c_dr_without_lmt_flg = DEBIT_WHEN_LIMIT;
    if (c_spl_flg == ROLLOVER_WITH_SPREAD ) /*** added in ver 2.8 *****/
    {
     strcpy( c_narration_id , ON_RWS_ORDER_PLACEMENT); 
    }
    else
    {
     strcpy( c_narration_id , ON_ROLLOVER_ORDER_PLACEMENT);/** 2.8 need to handle for roll with sprd ***/
    }
    if(DEBUG_MSG_LVL_0)
    {
        fn_userlog(c_ServiceName,"c_narration_id .  |%s| ",c_narration_id);
        fn_userlog(c_ServiceName,"d_diff_mrgn1 .  |%lf| ",d_diff_mrgn);
        fn_userlog(c_ServiceName,"st_usr_prfl.c_cln_mtch_accnt .  |%s| ",st_usr_prfl.c_cln_mtch_accnt);
        fn_userlog(c_ServiceName,"st_ordbook.c_xchng_cd .         |%s| ",st_ordbook.c_xchng_cd);
    }
    if(DEBUG_MSG_LVL_5)
    {
        fn_userlog(c_ServiceName,"ptr_st_pstn_actn_mn.c_cln_mtch_accnt.  |%s| ",ptr_st_pstn_actn_mn.c_cln_mtch_accnt);
        fn_userlog(c_ServiceName,"ptr_st_pstn_actn_mn.c_xchng_cd.  |%s| ",ptr_st_pstn_actn_mn.c_xchng_cd);
    }

    c_insuff_flg = 'N';
    d_required_amt = 0.0;
    d_required_diff_mrgn = 0;

    EXEC SQL
      SELECT nvl(FOD_SROLL_DIFF_AMT,0) * (-1),
             nvl(FOD_SROLL_LSS_AMT,0) * (-1)
      INTO  :d_old_diff_mrgn,
            :d_old_diff_pnl
      FROM  FOD_FO_ORDR_DTLS
      WHERE FOD_ORDR_RFRNC = :st_first_ordbk.c_ordr_rfrnc
      AND   FOD_XCHNG_CD = :st_first_ordbk.c_xchng_cd
      AND   FOD_PRDCT_TYP =:st_first_ordbk.c_prd_typ
      AND   FOD_UNDRLYNG = :st_first_ordbk.c_undrlyng
      AND   FOD_EXPRY_DT = :st_first_ordbk.c_expry_dt;

    if ( SQLCODE != 0 )
    {
      fn_errlog( c_ServiceName, "S31520", SQLMSG, c_err_msg  );
      fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
      tpfree ( ( char * ) ptr_fml_Obuf );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

    if(DEBUG_MSG_LVL_3)  /*** testing ***/
    {
      fn_userlog(c_ServiceName,":bhushan: Margin Updation in Modification Case -");
      fn_userlog(c_ServiceName,"d_old_diff_mrgn :%lf:",d_old_diff_mrgn);
      fn_userlog(c_ServiceName,"d_old_diff_pnl  :%lf:",d_old_diff_pnl);
      fn_userlog(c_ServiceName,"d_diff_mrgn     :%lf:",d_diff_mrgn);
      fn_userlog(c_ServiceName,"d_diff_pnl      :%lf:",d_diff_pnl);
    }

    if (c_spn_allwd_flg == 'N') /*** Margin Updation ***/
    {

    if ( d_diff_mrgn < 0 )
    {
      d_new_diff_mrgn = d_diff_mrgn -  d_old_diff_mrgn;

      if(DEBUG_MSG_LVL_3)
      {
        fn_userlog(c_ServiceName,"d_new_diff_mrgn :%lf:",d_new_diff_mrgn);
      }

      if ( d_new_diff_mrgn < 0  )
      {

        c_diff_mrgn_flg = 'Y';

        i_returncode = fn_upd_limits( c_ServiceName,
                                      &ptr_st_pstn_actn_mn,
                                      &ptr_st_err_msg,
                                      c_narration_id,
                                      c_dr_without_lmt_flg,
                                      d_new_diff_mrgn,
                                      &d_balance_amt);

      if ( i_returncode != 0 )
      {
        switch ( i_returncode )
        {
          case  INSUFFICIENT_LIMITS :
            fn_userlog(c_ServiceName," Inside INSUFFICIENT_LIMITS.");
            fn_userlog(c_ServiceName," After fn_upd_limits call");
            fn_errlog( c_ServiceName, "S31525", LIBMSG, c_err_msg  );
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );

            if( DEBUG_MSG_LVL_2 )
            {
             fn_userlog(c_ServiceName,"d_new_diff_mrgn = :%lf:",d_new_diff_mrgn);
             fn_userlog(c_ServiceName,"d_balance_amt = :%lf:",d_balance_amt);
             fn_userlog(c_ServiceName," Inside INSUFFICIENT_LIMITS for d_new_diff_mrgn.");
            }

            strcpy(c_err_msg,strtok(ptr_st_err_msg.c_err_msg,"|"));
            d_required_diff_mrgn = atof(strtok(NULL,"|"));
            strcpy(c_err_msg,strtok(c_err_msg,"<"));

            if(DEBUG_MSG_LVL_2)
            {
             fn_userlog(c_ServiceName," d_required_diff_mrgn :%lf:",d_required_diff_mrgn);
             fn_userlog(c_ServiceName," ptr_st_err_msg.c_err_msg :%lf:",ptr_st_err_msg.c_err_msg );

            }
            c_insuff_flg = 'Y';

            if( d_new_diff_pnl < 0 )
            {
              d_required_amt = d_required_diff_mrgn + ( (-1) * d_new_diff_pnl / 100 ) ;
            }
            else
            {
              d_required_amt = d_required_diff_mrgn;
            }
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT, (char *)&d_required_amt, 0);
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);

            sprintf(c_err_msg,"%s%lf>",c_err_msg,d_required_amt);
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );

              c_actn_flg = 'P';

              i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );
              if ( i_trnsctn == -1 )
              {
                fn_errlog( c_ServiceName, "S31530",LIBMSG,c_err_msg);
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID, (char *)&i_actn_id, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              i_returncode =  fn_ins_ffl_log_tbl  (  c_ServiceName,
                                                     st_ordbook,
                                                     c_err_msg,
                                                     d_required_amt,
                                                     c_actn_flg
                                                  );
              if ( i_returncode != 0 )
              {
                fn_errlog( c_ServiceName, "S31535", LIBMSG, c_err_msg  );
                fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID , (char *)&i_actn_id , 0 );
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );

             }

             if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
             {
                fn_errlog( c_ServiceName, "S31540",LIBMSG,c_err_msg);
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID, (char *)&i_actn_id, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
             }

            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );


         default:
            fn_errlog( c_ServiceName, "S31545", LIBMSG, c_err_msg  );
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
      d_total_def = d_total_def + d_new_diff_mrgn;
    }
    }

    MEMSET(c_narration_id);

	  if (c_spl_flg == ROLLOVER_WITH_SPREAD ) /*** added in ver 2.8 *****/
    {
     strcpy( c_narration_id ,BLOCK_PNL_ON_RWS_ORDER_PLACEMENT); 
    }
    else
    {
    strcpy( c_narration_id , BLOCK_PNL_ON_ROLLOVER_ORDER_PLACEMENT); /** 2.8 need to handle case ***/
    }

    if(DEBUG_MSG_LVL_0)
    {
        fn_userlog(c_ServiceName,"c_narration_id .  |%s| ",c_narration_id);
        fn_userlog(c_ServiceName,"d_new_diff_pnl .  |%lf| ",d_new_diff_pnl);
        fn_userlog(c_ServiceName,"ptr_st_pstn_actn_mn.c_cln_mtch_accnt.  |%s| ",ptr_st_pstn_actn_mn.c_cln_mtch_accnt);
        fn_userlog(c_ServiceName,"ptr_st_pstn_actn_mn.c_xchng_cd.  |%s| ",ptr_st_pstn_actn_mn.c_xchng_cd);
    }

    if ( d_diff_pnl < 0 )
    {

      d_new_diff_pnl  = d_diff_pnl  - d_old_diff_pnl;

      if(DEBUG_MSG_LVL_3)
      {
        fn_userlog(c_ServiceName,"d_new_diff_pnl  :%lf:",d_new_diff_pnl);
      }

    if ( d_new_diff_pnl < 0  )
    {
      c_diff_pnl_flg = 'Y';

      i_returncode = fn_upd_limits( c_ServiceName,
                                    &ptr_st_pstn_actn_mn,
                                    &ptr_st_err_msg,
                                    c_narration_id,
                                    c_dr_without_lmt_flg,
                                    d_new_diff_pnl,
                                    &d_balance_amt);

      if ( i_returncode != 0 )
      {
        switch ( i_returncode )
        {
          case  INSUFFICIENT_LIMITS :
            fn_userlog(c_ServiceName," Inside INSUFFICIENT_LIMITS.");
            fn_errlog( c_ServiceName, "S31550", LIBMSG, c_err_msg  );
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );

            fn_userlog(c_ServiceName," Inside INSUFFICIENT_LIMITS for d_new_diff_pnl.");
            strcpy(c_err_msg,strtok(ptr_st_err_msg.c_err_msg,"|"));
            d_required_amt = atof(strtok(NULL,"|"));
            strcpy(c_err_msg,strtok(c_err_msg,"<"));
            c_insuff_flg = 'Y';
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT, (char *)&d_required_amt, 0);
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);

              c_actn_flg = 'P';

              i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );
              if ( i_trnsctn == -1 )
              {
                fn_errlog( c_ServiceName, "S31555",LIBMSG,c_err_msg);
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID, (char *)&i_actn_id, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

              i_returncode =  fn_ins_ffl_log_tbl  (  c_ServiceName,
                                                     st_ordbook,
                                                     c_err_msg,
                                                     d_required_amt,
                                                     c_actn_flg
                                                  );

              if ( i_returncode != 0 )
              {
                fn_errlog( c_ServiceName, "S31560", LIBMSG, c_err_msg  );
                fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID , (char *)&i_actn_id , 0 );
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );

              }

              if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
              {
                fn_errlog( c_ServiceName, "S31565",LIBMSG,c_err_msg);
                Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID, (char *)&i_actn_id, 0 );
                Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
                Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
                tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
              }

            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );

         default:
            fn_errlog( c_ServiceName, "S31570", LIBMSG, c_err_msg  );
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
      d_total_def = d_total_def + d_new_diff_pnl;
    }
    }

    EXEC SQL
      UPDATE FOD_FO_ORDR_DTLS
      SET 	FOD_SROLL_DIFF_AMT = DECODE(:c_diff_mrgn_flg,'Y',FOD_SROLL_DIFF_AMT + ( :d_new_diff_mrgn * (-1)),FOD_SROLL_DIFF_AMT),
             FOD_SROLL_LSS_AMT = DECODE(:c_diff_pnl_flg,'Y',FOD_SROLL_LSS_AMT  + ( :d_new_diff_pnl  * (-1)),FOD_SROLL_LSS_AMT)
      WHERE  FOD_ORDR_RFRNC = :st_first_ordbk.c_ordr_rfrnc
      AND    FOD_XCHNG_CD = :st_first_ordbk.c_xchng_cd
      AND    FOD_PRDCT_TYP = :st_first_ordbk.c_prd_typ
      AND    FOD_UNDRLYNG = :st_first_ordbk.c_undrlyng
      AND    FOD_EXPRY_DT = :st_first_ordbk.c_expry_dt;

     if ( SQLCODE != 0 )
     {
      fn_errlog( c_ServiceName, "S51332", SQLMSG, c_err_msg  );
      fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
      tpfree ( ( char * ) ptr_fml_Obuf );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
     }
    }
    else
    {
      if ( d_diff_mrgn < 0 )
      {
        d_new_diff_mrgn = d_diff_mrgn -  d_old_diff_mrgn;

        if(DEBUG_MSG_LVL_3)
        {
          fn_userlog(c_ServiceName,"d_new_diff_mrgn :%lf:",d_new_diff_mrgn);
        }

      if ( d_new_diff_mrgn < 0  )
      {

        c_diff_mrgn_flg = 'Y';

      i_returncode = fn_upd_spnlimits( c_ServiceName,
                                    &st_pstn_action,
                                    ptr_st_err,
                                    c_narration_id,
                                    c_dr_without_lmt_flg,
                                    d_new_diff_mrgn,
                                    &d_balance_amt);

      if ( i_returncode != 0 )
      {
        switch ( i_returncode )
        {
          case  INSUFFICIENT_LIMITS :
            fn_userlog(c_ServiceName," Inside INSUFFICIENT_LIMITS.");
            fn_errlog( c_ServiceName, "S31575", LIBMSG, c_err_msg  );
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );

            c_insuff_flg = 'Y';
            if(DEBUG_MSG_LVL_2)
            {
             fn_userlog(c_ServiceName,"d_balance_amt :%lf:",d_balance_amt);
             fn_userlog(c_ServiceName," d_new_diff_mrgn  :%lf:",d_new_diff_mrgn);
             fn_userlog(c_ServiceName," d_new_diff_pnl   :%lf:",d_new_diff_pnl);
            }

            d_required_amt = d_new_diff_mrgn + d_balance_amt;
            if( d_new_diff_pnl < 0 )
            {
              d_required_amt = d_required_amt + d_new_diff_pnl;
            }

            if(DEBUG_MSG_LVL_2)
            {
             fn_userlog(c_ServiceName,"d_required_amt ::%lf:",d_required_amt);
            }

            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );

         default:
            fn_errlog( c_ServiceName, "S31580", LIBMSG, c_err_msg  );
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
      d_total_def = d_total_def + d_new_diff_mrgn;
    }
    }

    MEMSET(c_narration_id);
	  if (c_spl_flg == ROLLOVER_WITH_SPREAD ) /*** added in ver 2.8 *****/
    {
     strcpy( c_narration_id ,BLOCK_PNL_ON_RWS_ORDER_PLACEMENT); 
    }
    else
    {
    strcpy( c_narration_id , BLOCK_PNL_ON_ROLLOVER_ORDER_PLACEMENT); /*** 2.8 need to handle ***/
    }

    if(DEBUG_MSG_LVL_0)
    {
        fn_userlog(c_ServiceName,"c_narration_id .  |%s| ",c_narration_id);
        fn_userlog(c_ServiceName,"d_new_diff_pnl .  |%lf| ",d_new_diff_pnl);
        fn_userlog(c_ServiceName,"ptr_st_pstn_actn_mn.c_cln_mtch_accnt.  |%s| ",ptr_st_pstn_actn_mn.c_cln_mtch_accnt);
        fn_userlog(c_ServiceName,"ptr_st_pstn_actn_mn.c_xchng_cd.  |%s| ",ptr_st_pstn_actn_mn.c_xchng_cd);
    }

    if ( d_diff_pnl < 0 )
    {
      d_new_diff_pnl  = d_diff_pnl  - d_old_diff_pnl;

      if(DEBUG_MSG_LVL_3)
      {
       fn_userlog(c_ServiceName,"d_new_diff_pnl  :%lf:",d_new_diff_pnl);
      }

    if ( d_new_diff_pnl < 0  )
    {

      c_diff_pnl_flg = 'Y';

      i_returncode = fn_upd_spnlimits( c_ServiceName,
                                    &st_pstn_action,
                                    ptr_st_err,
                                    c_narration_id,
                                    c_dr_without_lmt_flg,
                                    d_new_diff_pnl,
                                    &d_balance_amt);

      if ( i_returncode != 0 )
      {
        switch ( i_returncode )
        {
          case  INSUFFICIENT_LIMITS :
            fn_userlog(c_ServiceName," Inside INSUFFICIENT_LIMITS.");
            fn_errlog( c_ServiceName, "S31585", LIBMSG, c_err_msg  );
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );

            c_insuff_flg = 'Y';
            if(DEBUG_MSG_LVL_3)
            {
             fn_userlog(c_ServiceName,"d_balance_amt :%lf:",d_balance_amt);
             fn_userlog(c_ServiceName," d_new_diff_mrgn  :%lf:",d_new_diff_mrgn);
             fn_userlog(c_ServiceName," d_new_diff_pnl   :%lf:",d_new_diff_pnl);
            }

            d_required_amt = d_new_diff_pnl + d_balance_amt;

            if(DEBUG_MSG_LVL_3)
            {
             fn_userlog(c_ServiceName,"d_required_amt ::%lf:",d_required_amt);
            }

            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );

         default:
            fn_errlog( c_ServiceName, "S31590", LIBMSG, c_err_msg  );
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            tpfree ( ( char * ) ptr_fml_Sbuf );
            tpfree ( ( char * ) ptr_fml_Rbuf );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
      d_total_def = d_total_def + d_new_diff_pnl;
    }
    }

    EXEC SQL
      UPDATE FOD_FO_ORDR_DTLS
      SET FOD_SROLL_DIFF_AMT  = DECODE(:c_diff_mrgn_flg,'Y',FOD_SROLL_DIFF_AMT + ( :d_new_diff_mrgn * (-1)),FOD_SROLL_DIFF_AMT),
             FOD_SROLL_LSS_AMT   = DECODE(:c_diff_pnl_flg,'Y',FOD_SROLL_LSS_AMT  + ( :d_new_diff_pnl  * (-1)),FOD_SROLL_LSS_AMT)
      WHERE  FOD_ORDR_RFRNC = :st_first_ordbk.c_ordr_rfrnc
      AND    FOD_XCHNG_CD = :st_first_ordbk.c_xchng_cd
      AND    FOD_PRDCT_TYP = :st_first_ordbk.c_prd_typ
      AND    FOD_UNDRLYNG = :st_first_ordbk.c_undrlyng
      AND    FOD_EXPRY_DT = :st_first_ordbk.c_expry_dt;

     if ( SQLCODE != 0 )
     {
      fn_errlog( c_ServiceName, "S51333", SQLMSG, c_err_msg  );
      fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
      tpfree ( ( char * ) ptr_fml_Obuf );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
     }
    }

    if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
    {
      tpfree ( ( char * ) ptr_fml_Obuf );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }
     /** ver 3.6 start **/
    i_returncode = fn_upd_mrgn_reporting(ptr_st_pstn_actn_mn.c_cln_mtch_accnt,
                                         ptr_st_pstn_actn_mn.c_xchng_cd,
                                       c_ServiceName,
                                       c_err_msg
                                      );
  if( i_returncode != 0 )
  {
    fn_errlog(c_ServiceName, "S31595", LIBMSG, c_err_msg );
      tpfree ( ( char * ) ptr_fml_Obuf );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 }
 /** ver 3.6 end **/
	}
	/*** Order Cancellation Starts ***/
  else if( c_opn_typ == 'S' && c_sub_rqst_typ == CANCEL )
  {

    /*** i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );  *** Commented bhushan***

    if ( i_trnsctn == -1 )
    {
      fn_errlog( c_ServiceName, "S31600", LIBMSG , c_err_msg );
      tpfree ( ( char * ) ptr_fml_Sbuf );
      tpfree ( ( char * ) ptr_fml_Rbuf );
      tpfree ( ( char * ) ptr_fml_Obuf );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

    i_returncode = fn_lock_usr( c_ServiceName, st_usr_prfl.c_cln_mtch_accnt );

    if ( i_returncode == -1 )
    {
      fn_errlog( c_ServiceName, "S31605", LIBMSG , c_err_msg );
      fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

    bhushan comment ends******/

		if(Fget32(ptr_fml_Ibuf, FFO_XCHNG_RMRKS,0,(char *)c_xchng_rmrks,0) == -1)
		{
			if(Ferror32 != FNOTPRES)
			{
				fn_errlog( c_ServiceName, "S31610", FMLMSG, c_err_msg  );
				fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
      	Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      	Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      	Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
      	Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
      	tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
			}

			if(Ferror32 == FNOTPRES)
			{
				if(DEBUG_MSG_LVL_3)
				{
					fn_userlog(c_ServiceName,"Exchange Remarks FML not present.");
				}
			}
		}

		if( (strstr(c_xchng_rmrks,"Physical Settlement EOS")) || (strstr(c_xchng_rmrks,"System placed Cancellation")) )
		{
			strcpy(st_ordbook.c_channel,"SYS");
			strcpy(c_alias,"*");
			strcpy(c_sys_msg,"EOS");		
		}

    for( i_cnt=0; i_cnt < i_tot_rec; i_cnt++)  /*** Call to Order Cancellation Service ***/
    {
      i_err[0]= Fget32(ptr_fml_Ibuf, FFO_XCHNG_CD,i_cnt, (char *)st_ordbook.c_xchng_cd, 0);
      i_ferr [ 0 ] = Ferror32;

      i_err[1]= Fget32(ptr_fml_Ibuf, FFO_DAM_TRNSCTN,i_cnt, (char *)&st_ordbook.c_pro_cli_ind, 0);
      i_ferr [ 1 ] = Ferror32;

      i_err[2]= Fget32(ptr_fml_Ibuf, FFO_ORDR_RFRNC ,i_cnt, (char *)st_ordbook.c_ordr_rfrnc, 0);
      i_ferr [ 2 ] = Ferror32;


      for(i=0; i < 3; i++)
      {
        if ( (i_err[ i ] == -1 ) )
        {
          fn_errlog( c_ServiceName, "S31615", Fstrerror32(i_ferr[i]),c_err_msg);
          fn_userlog(c_ServiceName,"Error in field %d in record no %d",i,i_cnt );
          fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
          tpfree ( ( char * ) ptr_fml_Sbuf );
          tpfree ( ( char * ) ptr_fml_Rbuf );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); 
          Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); 
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }

      if(st_usr_prfl.c_user_id[0] == BPID)
      {
        if(Fget32(ptr_fml_Ibuf,FFO_ALIAS,i_cnt,(char *)c_alias,0) == -1)
        {
          fn_errlog( c_ServiceName, "S31620", FMLMSG, c_err_msg  );
          fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
          tpfree ( ( char * ) ptr_fml_Sbuf );
          tpfree ( ( char * ) ptr_fml_Rbuf );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
          Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }

      if(DEBUG_MSG_LVL_5)
      {
        fn_userlog( c_ServiceName, "Input Data for order no :%d:",i_cnt);
        fn_userlog( c_ServiceName, "Exchange code :%s:", st_ordbook.c_xchng_cd );
        fn_userlog( c_ServiceName, "Reference No. :%s:",st_ordbook.c_ordr_rfrnc);
        fn_userlog( c_ServiceName, "DAM Transaction :%c:", st_ordbook.c_pro_cli_ind);
        fn_userlog( c_ServiceName, "ALIAS   :%s:", c_alias);
      }

      EXEC SQL
        SELECT  NVL(CLM_SPAN_ALLWD,'N')
        INTO    :c_spn_allwd_flg
        FROM    CLM_CLNT_MSTR
        WHERE   CLM_MTCH_ACCNT  = :st_usr_prfl.c_cln_mtch_accnt;

      if ( SQLCODE  !=  0 )
      {
        fn_errlog( c_ServiceName, "S31625",SQLMSG,c_err_msg);
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
				Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );    /*** Ver 3.2 ***/
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      if(DEBUG_MSG_LVL_0)
      {
        fn_userlog(c_ServiceName,"SPAN ALLWD FLAG IS :%c:",c_spn_allwd_flg);
      }

      if ( c_spn_allwd_flg == 'Y' )
      {
        strcpy(c_srvc_nm,"SFO_SPN_CANCEL");
      }
      else if ( c_spn_allwd_flg == 'N' )
      {
        strcpy(c_srvc_nm,"SFO_CANCEL_FUT");
      }
      else
      {
        strcpy( c_err_msg, "Invalid User type");

        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
				Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );    /*** Ver 3.2 ***/
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

			if( strstr(c_xchng_rmrks,"Physical Settlement EOS") || strstr(c_xchng_rmrks,"System placed Cancellation"))
			{
				i_err[0] = Fchg32 ( ptr_fml_Sbuf,FFO_XCHNG_RMRKS, 0,(char *)c_xchng_rmrks, 0);
				i_ferr [ 0 ] = Ferror32;

				i_err[1] = Fchg32 ( ptr_fml_Sbuf,FFO_CHANNEL, 0, (char *)st_ordbook.c_channel, 0);
				i_ferr [1] = Ferror32;

				i_err[2] = Fchg32 ( ptr_fml_Sbuf,FFO_SYS_MSG, 0, (char *)c_sys_msg, 0);
				i_ferr [2];

      	for(i=0; i < 3; i++)
      	{
        	if ( (i_err[ i ] == -1 ) )
        	{
          	fn_errlog( c_ServiceName, "S31630", Fstrerror32(i_ferr[i]),c_err_msg);
          	fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
          	tpfree ( ( char * ) ptr_fml_Sbuf );
          	tpfree ( ( char * ) ptr_fml_Rbuf );
          	tpfree ( ( char * ) ptr_fml_Obuf );
          	Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
          	Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
          	Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); 
          	Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0); 
          	tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        	}
     	 }
			}

      i_err[0] = Fchg32 ( ptr_fml_Sbuf, FFO_XCHNG_CD, 0, (char *)st_ordbook.c_xchng_cd, 0);
      i_ferr [ 0 ] = Ferror32;

      i_err[ 1 ] = Fchg32 ( ptr_fml_Sbuf, FFO_ORDR_RFRNC , 0, (char *)st_ordbook.c_ordr_rfrnc, 0);
      i_ferr [ 1 ] = Ferror32;

      i_err[2] = Fchg32 ( ptr_fml_Sbuf, FFO_ALIAS, 0, (char *)c_alias, 0);
      i_ferr [ 2 ] = Ferror32;

      i_err[3] = Fchg32 ( ptr_fml_Sbuf, FFO_DAM_TRNSCTN, 0, (char *)&st_ordbook.c_pro_cli_ind, 0);
      i_ferr [ 3 ] = Ferror32;

      i_err[4] = Fchg32 ( ptr_fml_Sbuf, FFO_SVC_NAME, 0, (char *)c_srvc_nm, 0);
      i_ferr [ 4 ] = Ferror32;

      i_err[ 5 ] = Fchg32 ( ptr_fml_Sbuf, FFO_SPL_FLG, 0, (char *)&c_spl_flg, 0);
      i_ferr [ 5 ] = Ferror32;

      i_err[ 6 ] = Fchg32 ( ptr_fml_Sbuf, FFO_SPRD_ORD_IND, 0, (char *)&c_sprd_ord_ind, 0);
      i_ferr [ 6] = Ferror32;

      i_err[ 7 ] = Fchg32 ( ptr_fml_Sbuf, FFO_OI_INDCTR, 0, (char *)c_ip_address, 0);
      i_ferr [ 7 ] = Ferror32;

      i_err[ 8 ] = Fchg32 ( ptr_fml_Sbuf, FFO_CLSR_TYP, 0, (char *)&c_usr_flg, 0);
      i_ferr [ 8 ] = Ferror32;

      for(i=0; i < 7; i++)
      {
        if ( (i_err[ i ] == -1 ) )
        {
          fn_errlog( c_ServiceName, "S31635", Fstrerror32(i_ferr[i]),c_err_msg);
          fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
          tpfree ( ( char * ) ptr_fml_Sbuf );
          tpfree ( ( char * ) ptr_fml_Rbuf );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
          Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
          Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }

      i_returncode = tpcall("SFO_ORD_ROUT", (char *)ptr_fml_Sbuf, 0, (char **)&ptr_fml_Rbuf, &l_recvbuff, 0);

      if (i_returncode == -1)
      {
        if (TPCODE != TPESVCFAIL)
        {
          fn_errlog( c_ServiceName, "S31640",TPMSG,c_err_msg);
          fn_userlog( c_ServiceName, "TP CODE IS    |%d|",TPCODE);
        }
        else
        {
          i_returncode = Fget32(ptr_fml_Rbuf, FFO_ERR_MSG, 0, c_err_msg, 0);

          if (i_returncode == -1)
          {
            fn_errlog( c_ServiceName, "S31645",FMLMSG,c_err_msg);
            fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
            tpfree ( ( char * ) ptr_fml_Sbuf );
            tpfree ( ( char * ) ptr_fml_Rbuf );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
            Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); 
            Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
          }
        }

        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); 
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      i_returncode = Fconcat32(ptr_fml_Obuf,ptr_fml_Rbuf);

      if( i_returncode == -1)
      {
       fn_errlog( c_ServiceName, "S31650",FMLMSG,c_err_msg);
       fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
       tpfree ( ( char * ) ptr_fml_Sbuf );
       tpfree ( ( char * ) ptr_fml_Rbuf );
       tpfree ( ( char * ) ptr_fml_Obuf );
       Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
       Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
       Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
       Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
       tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
       }

      i_err[0] = 0 ;
      i_ferr[0] = 0 ;

      if ( Finit32 ( ptr_fml_Rbuf, ( FLDLEN32 ) Fsizeof32 ( ptr_fml_Rbuf ) ) == -1 )
      {
        fn_errlog( c_ServiceName, "S31655",FMLMSG,c_err_msg);
        fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
        tpfree ( ( char * ) ptr_fml_Sbuf );
        tpfree ( ( char * ) ptr_fml_Rbuf );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
        Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
        Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }

    tpfree ( ( char * ) ptr_fml_Rbuf );
    tpfree ( ( char * ) ptr_fml_Sbuf );

    if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
    {
      tpfree ( ( char * ) ptr_fml_Obuf );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0); 
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }
     /** ver 3.6 start **/
    i_returncode = fn_upd_mrgn_reporting(st_usr_prfl.c_cln_mtch_accnt,
                                       st_ordbook.c_xchng_cd,
                                       c_ServiceName,
                                       c_err_msg
                                      );
  if( i_returncode != 0 )
  {
    fn_errlog(c_ServiceName, "S31660", LIBMSG, c_err_msg );
      tpfree ( ( char * ) ptr_fml_Obuf );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
      Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
      Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }
  /** ver 3.6 end **/
  }
  else
  {
    strcpy(c_err_msg,"Invalid Operation type");
    fn_errlog( c_ServiceName, "S41040", "Invalid Operation type", c_err_msg);
    fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
    tpfree ( ( char * ) ptr_fml_Sbuf );
    tpfree ( ( char * ) ptr_fml_Rbuf );
    tpfree ( ( char * ) ptr_fml_Obuf );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
    Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID,(char *)&i_actn_id, 0 );
    Fadd32( ptr_fml_Ibuf, FFO_BAL_AMT,(char *)&d_required_amt, 0);
    Fadd32( ptr_fml_Ibuf,FFO_MOD_CAN_FLG,(char *)&c_insuff_flg,0);
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
	/** Ver 2.8 Ends **/

	strcpy ( c_fno_dmn_nm, "FNO" );
  strcpy ( c_fno_trg_nm, "TRG_LOOK_TAB" );
  strcpy ( c_fno_trg_dat, "TRG_LOOK_TAB" );

  fn_userlog( c_ServiceName,"c_sub_rqst_typ :%c:",c_sub_rqst_typ);

	if(strcpy(c_sys_msg,"EOS") != 0 && c_sub_rqst_typ != CANCEL)  /*** if condition added in Ver 2.8 ***/
	{
  i_returncode = fn_call_svc_fml ( c_ServiceName,
                                   c_err_msg,
                                   "SFO_FOS_TRG",
                                   0,
                                   4,
                                   0,
                                   FFO_DMN_NM, (char *)c_fno_dmn_nm,
                                   FFO_TRG_NM, (char *)c_fno_trg_nm,
                                   FFO_ABT_TRG_DATA, (char *)c_fno_trg_dat,
                                   FFO_ABT_FILTER, (char *)c_pipe_id);

  if ( i_returncode != SUCC_BFR )
  {
    fn_userlog( c_ServiceName,"ERROR IN FOS_TRG");
    fn_errlog( c_ServiceName, "S31665", LIBMSG, c_err_msg  );
  }
	}

  /********************************************************/
  /****Changes for Tux4 Triggers ends**********************/
  /********************************************************/

  tpreturn( TPSUCCESS, 0, (char *)ptr_fml_Obuf, 0 , 0 );	

}

/*** Commented in Ver 2.8 *****

int fn_chk_spn_mrgn (char *c_ServiceName,
										 struct vw_orderbook st_first_ordbk,
										 struct vw_orderbook st_next_ordbk,
										 struct st_pstn_actn *ptr_st_pstn_actn,	
										 double *d_total_diff,	
										 double *d_total_pnl,	
                     char *c_err_msg
										)
{
		
	FBFR32 *ptr_fml_ibuf;
  FBFR32 *ptr_fml_obuf;

  char c_narration_id[4];
  char c_dr_without_lmt_flg;
	char c_prmum_dr_without_lmt_flg;
  char c_pos_avl;
  char c_tmp_rmrks [ 133 ] ;
  char c_inp_strng1[ 8000 ];
  char c_inp_strng11[ 8000 ];
  char c_inp_strng2[ 8000 ];
  char c_inp_strng22[ 8000 ];
  char c_inp_strng[ 16000 ];
  char c_op_strng[ 16000 ];
  char c_op_strng1[ 16000 ];
  char c_op_strng2[ 16000 ];
	char c_seq_num1[12000];
	char c_seq_num2[12000];
	char c_max_opn_qty[200];
	char c_min_opn_qty[200];
	char c_ltp[2000];
	char c_strk_prc[20];
	char c_mrgn_indctr[3];
	char c_opseq_num1[20];
	char c_opseq_num2[20];
	char c_mtch_accnt1[11];
	char c_mtch_accnt2[11];
	char c_spn_mrgn1[20];
	char c_spn_mrgn2[20];
	char c_nov1[20];
	char c_nov2[20];
	char c_total_mrgn1[20];
	char c_total_mrgn2[20];
	char c_expry_dt[10];
  char c_xchng_cd1[3];     
  char c_frst_opnpstn_flw='\0';	

	char *null_ptr	=	0;

	int i_returncode;
	int	i_rtrn_cd1;
	int i_expsr_rtrn;
	int i_cntrct_cnt = 0;

	long	l_max_opn_qty	= 0;
	long	l_min_opn_qty	= 0;
	long	l_temp_qty		= 0;
	long	l_prtfl_seq1	= 0;
	long	l_prtfl_seq2	= 0;
	long	li_len_tobuf	= 0;
	long	l_length1			= 0;
	long	l_length2			= 0;
	long	l_cntr				=	0;
	long  l_prmum_qty		= 0;
	long	l_basket_id		=	0;
	long	l_mrgnbl_qty	= 0;
	long  l_buy_qty			= 0;
	long	l_sell_qty		= 0;
	
	long l_ose_qty				= 0;
	long l_obe_qty				= 0;
	long l_ibuy_qty				= 0;
	long l_ebuy_qty				= 0;
	long l_isell_qty			= 0;
	long l_esell_qty			= 0;
	long l_total_buy_qty	= 0;
	long l_total_sell_qty = 0;
	long l_cover_qty			= 0;
	long l_open_pos_qty		= 0;
	long l_rem_qty				= 0;
	long l_no_of_lot			= 0;
	long l_opnpstn_qty  	= 0;
	long l_pending_qty  	= 0;

  double d_opnpstn_val  = 0.0;
  double d_open_pos_val = 0.0;
  double d_base_rate    = 0.0;
  double d_diff_mrgn    = 0.0;
  double d_balance_amt  = 0.0;
  double d_bal_to_apply = 0.0 ;
	double d_first_ltp    = 0.0;
  double d_next_ltp     = 0.0;	
	double d_spn_mrgn     = 0.0;
	double d_spn_mrgn1    = 0.0;
	double d_spn_mrgn2    = 0.0;
	double d_nov1         = 0.0;
	double d_nov2         = 0.0;
	double d_nov	        = 0.0;
	double d_total_mrgn1  = 0.0;
	double d_total_mrgn2  = 0.0;
	double d_total_mrgn  	= 0.0;
	double d_cntrct_pl		=	0.0;
	double d_ntnl_pl			=	0.0;
	double d_blckd_amnt		=	0.0;
  double d_mrgn_blkd 		= 0.0;
  double d_expsr_prcntg = 0.0;
  double d_minexpsr_prcntg = 0.0;
	double d_expsr_mrgn			=	0.0;
	double d_min_expsr_mrgn	=	0.0;
	double d_expsr					=	0.0;
	double d_min_expsr			=	0.0;
	double d_mltplr					=	0.0;
	double d_upd_amount     =	0.0;
	double d_intl_mrgn    	= 0.0;
	double d_min_mrgn     	= 0.0;
	double d_undrlyng_pl		=	0.0;
	double d_ltp						= 0.0;
	double d_clsng_prc			=	0.0;
	double d_oblckd_amnt		=	0.0;
	double d_strike_prc		  =	0.0;

  EXEC SQL BEGIN DECLARE SECTION;
    sql_cursor     sys_cursor;      
    char  sql_cln_mtch_accnt[11];
    char  sql_xchng_cd[4];
    char  sql_prd_typ;
    char  sql_undrlyng[7];
    varchar c_exp_dt[LEN_DATE];
    varchar c_trd_dt[12];          
		varchar c_stock_cd [20];
	
  struct st_fcp_cntrct_pstn	st_cntrct_pstn_crrnt	;
  struct st_fcp_cntrct_pstn	st_cntrct_pstn_old	;
  struct st_fcp_cntrct_pstn	st_cntrct_pstn_md_rc;
  struct st_fcp_cntrct_pstn st_cntrct_pstn_prmum_sqroff;
	struct st_fus_undrlyng_pstn st_undpstn_tobe;
	struct st_fus_undrlyng_pstn st_undpstn_crrnt;
  struct st_err_msg *ptr_st_err_msg;

  EXEC SQL END DECLARE SECTION;

	ptr_fml_obuf = (FBFR32*)tpalloc("FML32",NULL,MIN_FML_BUF_LEN);

  if ( ptr_fml_obuf == NULL )
  {
    fn_errlog(c_ServiceName, "S31670", TPMSG, c_err_msg);
		return -1;
  }

  ptr_fml_ibuf = (FBFR32*)tpalloc("FML32",NULL,MIN_FML_BUF_LEN*10);

  if ( ptr_fml_ibuf == NULL )
  {
    fn_errlog(c_ServiceName, "S31675", TPMSG, c_err_msg);
    tpfree((char *)ptr_fml_obuf);
		return -1;
  }

  strcpy( sql_cln_mtch_accnt,st_first_ordbk.c_cln_mtch_accnt);
  strcpy( sql_xchng_cd,st_first_ordbk.c_xchng_cd);
  strcpy( sql_undrlyng,st_first_ordbk.c_undrlyng);

	sql_prd_typ 		= st_first_ordbk.c_prd_typ;

	if(DEBUG_MSG_LVL_5)
	{
  	fn_userlog ( c_ServiceName, "Building new underlying position" );
  	fn_userlog ( c_ServiceName, "st_first_ordbk.c_cln_mtch_accnt				|%s|",st_first_ordbk.c_cln_mtch_accnt );
  	fn_userlog ( c_ServiceName, "st_first_ordbk.c_xchng_cd							|%s|",st_first_ordbk.c_xchng_cd );
  	fn_userlog ( c_ServiceName, "st_first_ordbk.c_undrlyng							|%s|",st_first_ordbk.c_undrlyng );
  	fn_userlog ( c_ServiceName, "st_first_ordbk.c_expry_dt							|%s|",st_first_ordbk.c_expry_dt );
  	fn_userlog ( c_ServiceName, "st_first_ordbk.c_prd_typ								|%c|",st_first_ordbk.c_prd_typ );
  	fn_userlog ( c_ServiceName, "st_first_ordbk.c_ordr_flw							|%c|",st_first_ordbk.c_ordr_flw );
  	fn_userlog ( c_ServiceName, "st_first_ordbk.l_ord_tot_qty						|%ld|",st_first_ordbk.l_ord_tot_qty );
  	fn_userlog ( c_ServiceName, "st_next_ordbk.c_cln_mtch_accnt					|%s|",st_next_ordbk.c_cln_mtch_accnt );
  	fn_userlog ( c_ServiceName, "st_next_ordbk.c_xchng_cd								|%s|",st_next_ordbk.c_xchng_cd );
  	fn_userlog ( c_ServiceName, "st_next_ordbk.c_undrlyng								|%s|",st_next_ordbk.c_undrlyng );
  	fn_userlog ( c_ServiceName, "st_next_ordbk.c_expry_dt								|%s|",st_next_ordbk.c_expry_dt );
  	fn_userlog ( c_ServiceName, "st_next_ordbk.c_prd_typ								|%c|",st_next_ordbk.c_prd_typ );
  	fn_userlog ( c_ServiceName, "st_next_ordbk.c_exrc_typ								|%c|",st_next_ordbk.c_exrc_typ );
	}

		int i_pos_avl = 0;

		EXEC SQL
				SELECT FCP_OPNPSTN_QTY,
							 FCP_OPNPSTN_VAL,
							 FCP_OPNPSTN_FLW,
							 DECODE(:st_first_ordbk.c_ordr_flw,'B',GREATEST(ABS(FCP_IBUY_QTY),ABS(FCP_EXBUY_QTY)),GREATEST(ABS(FCP_ISELL_QTY),ABS(FCP_EXSELL_QTY)))
				INTO   :l_open_pos_qty,
							 :d_open_pos_val,
							 :c_frst_opnpstn_flw,
							 :l_pending_qty
				FROM   FCP_FO_SPN_CNTRCT_PSTN
				WHERE  FCP_CLM_MTCH_ACCNT  = :st_first_ordbk.c_cln_mtch_accnt
        AND    FCP_XCHNG_CD        = :st_first_ordbk.c_xchng_cd
      	AND    FCP_PRDCT_TYP       = :st_first_ordbk.c_prd_typ
      	AND    FCP_UNDRLYNG        = :st_first_ordbk.c_undrlyng
      	AND    FCP_EXPRY_DT        = :st_first_ordbk.c_expry_dt
      	AND    FCP_EXER_TYP        = :st_first_ordbk.c_exrc_typ;

      if ( SQLCODE != 0 )
      {
        fn_errlog( c_ServiceName, "S31680",FMLMSG,c_err_msg);
        tpfree ( ( char * ) ptr_fml_obuf );
        tpfree ( ( char * ) ptr_fml_ibuf );
				return -1;
      }			

	 if ( labs(l_open_pos_qty) < (labs(st_first_ordbk.l_ord_tot_qty) + labs (l_pending_qty)) )
	 {
			fn_userlog ( c_ServiceName, "Rollover quantity greater than open position quantity.");
			strcpy(c_err_msg,"Rollover quantity can not be greater than open position quantity.");
			tpfree ( ( char * ) ptr_fml_obuf );
      tpfree ( ( char * ) ptr_fml_ibuf );
			return -1;
	 }		

		EXEC SQL
     SELECT  FTQ_LST_TRD_PRC
        INTO    :d_first_ltp
        FROM    FTQ_FO_TRD_QT
        WHERE   FTQ_XCHNG_CD  = :st_first_ordbk.c_xchng_cd
        AND     FTQ_PRDCT_TYP = :st_first_ordbk.c_prd_typ
        AND     FTQ_UNDRLYNG  = :st_first_ordbk.c_undrlyng
        AND     FTQ_EXPRY_DT  = :st_first_ordbk.c_expry_dt
        AND     FTQ_EXER_TYP  = :st_first_ordbk.c_exrc_typ;

      if(SQLCODE  !=  0 )
      {
        fn_errlog ( c_ServiceName, "S31685", SQLMSG, c_err_msg );
				tpfree ( ( char * ) ptr_fml_obuf );
        tpfree ( ( char * ) ptr_fml_ibuf );
        return FAILURE;
      }

  EXEC SQL
     SELECT  FTQ_LST_TRD_PRC
        INTO    :d_next_ltp
        FROM    FTQ_FO_TRD_QT
        WHERE   FTQ_XCHNG_CD  = :st_next_ordbk.c_xchng_cd
        AND     FTQ_PRDCT_TYP = :st_next_ordbk.c_prd_typ
        AND     FTQ_UNDRLYNG  = :st_next_ordbk.c_undrlyng
        AND     FTQ_EXPRY_DT  = :st_next_ordbk.c_expry_dt
        AND     FTQ_EXER_TYP  = :st_next_ordbk.c_exrc_typ;

      if(SQLCODE  !=  0 )
      {
        fn_errlog ( c_ServiceName, "S31690", SQLMSG, c_err_msg );
				tpfree ( ( char * ) ptr_fml_obuf );
        tpfree ( ( char * ) ptr_fml_ibuf );
        return FAILURE;
      }

      if( DEBUG_MSG_LVL_3 )
      {
        fn_userlog ( c_ServiceName, " d_first_ltp                   |%lf|",d_first_ltp);
        fn_userlog ( c_ServiceName, " d_next_ltp                    |%lf|",d_next_ltp);
			}

		if (st_first_ordbk.c_slm_flg == 'M')
    {
      st_first_ordbk.l_ord_lmt_rt = d_first_ltp;
    }

    if (st_next_ordbk.c_slm_flg == 'M')
    {
      st_next_ordbk.l_ord_lmt_rt = d_next_ltp;
    }

		if ( c_frst_opnpstn_flw == 'S' )
    {	
			l_rem_qty 	= l_open_pos_qty + st_first_ordbk.l_ord_tot_qty;
		}
		else
    {
      l_rem_qty   =	l_open_pos_qty  - st_first_ordbk.l_ord_tot_qty;
    }

		d_base_rate = d_open_pos_val / (double)l_open_pos_qty;

		EXEC SQL
      UPDATE  FCP_FO_SPN_CNTRCT_PSTN
			SET	FCP_BUY_EXCTD_QTY = DECODE(:st_first_ordbk.c_ordr_flw,'B',FCP_BUY_EXCTD_QTY + :st_first_ordbk.l_ord_tot_qty,FCP_BUY_EXCTD_QTY + 0),
					FCP_SELL_EXCTD_QTY= DECODE(:st_first_ordbk.c_ordr_flw,'S',FCP_SELL_EXCTD_QTY + (:st_first_ordbk.l_ord_tot_qty * -1 ) ,FCP_SELL_EXCTD_QTY + 0),
					FCP_OPNPSTN_QTY	=	FCP_OPNPSTN_QTY	+ DECODE(:st_first_ordbk.c_ordr_flw,'S',(:st_first_ordbk.l_ord_tot_qty * -1),:st_first_ordbk.l_ord_tot_qty),
					FCP_OPNPSTN_VAL	= :l_rem_qty * :d_base_rate,
					FCP_MTM_OPN_VAL	=	:l_rem_qty * :d_base_rate	
			WHERE FCP_CLM_MTCH_ACCNT  	= :st_first_ordbk.c_cln_mtch_accnt
      AND     FCP_XCHNG_CD        = :st_first_ordbk.c_xchng_cd
      AND     FCP_PRDCT_TYP       = :st_first_ordbk.c_prd_typ
      AND     FCP_UNDRLYNG        = :st_first_ordbk.c_undrlyng
      AND     FCP_EXPRY_DT        = :st_first_ordbk.c_expry_dt
      AND     FCP_EXER_TYP        = :st_first_ordbk.c_exrc_typ;

      if ( SQLCODE != 0 )
      {
				fn_errlog( c_ServiceName, "S31695",FMLMSG,c_err_msg);
				tpfree ( ( char * ) ptr_fml_obuf );
        tpfree ( ( char * ) ptr_fml_ibuf );
				return -1;
			}

		EXEC SQL 
			SELECT 1
			INTO  :i_pos_avl
			FROM  FCP_FO_SPN_CNTRCT_PSTN
			WHERE FCP_CLM_MTCH_ACCNT    = :st_next_ordbk.c_cln_mtch_accnt
      AND     FCP_XCHNG_CD        = :st_next_ordbk.c_xchng_cd
      AND     FCP_PRDCT_TYP       = :st_next_ordbk.c_prd_typ
      AND     FCP_UNDRLYNG        = :st_next_ordbk.c_undrlyng
      AND     FCP_EXPRY_DT        = :st_next_ordbk.c_expry_dt
      AND     FCP_EXER_TYP        = :st_next_ordbk.c_exrc_typ;
			
			if ( SQLCODE != 0 && SQLCODE != NO_DATA_FOUND )
      {
        fn_errlog( c_ServiceName, "S31700",FMLMSG,c_err_msg);
				tpfree ( ( char * ) ptr_fml_obuf );
        tpfree ( ( char * ) ptr_fml_ibuf );
        return -1;
      }

		if ( i_pos_avl == 1 )
		{

		EXEC SQL
			UPDATE  FCP_FO_SPN_CNTRCT_PSTN
      SET   FCP_BUY_EXCTD_QTY     = DECODE (:st_next_ordbk.c_ordr_flw ,'B',FCP_BUY_EXCTD_QTY + :st_next_ordbk.l_ord_tot_qty,
                                            FCP_BUY_EXCTD_QTY + 0),
            FCP_SELL_EXCTD_QTY    = DECODE (:st_next_ordbk.c_ordr_flw ,'S',FCP_SELL_EXCTD_QTY +(:st_next_ordbk.l_ord_tot_qty * -1),FCP_SELL_EXCTD_QTY + 0),
  					FCP_OPNPSTN_QTY = FCP_OPNPSTN_QTY + DECODE(:st_next_ordbk.c_ordr_flw,'S',(:st_next_ordbk.l_ord_tot_qty * -1),:st_next_ordbk.l_ord_tot_qty),
  					FCP_OPNPSTN_VAL = FCP_OPNPSTN_VAL + (:st_next_ordbk.l_ord_lmt_rt * DECODE (:st_next_ordbk.c_ordr_flw ,'S',:st_next_ordbk.l_ord_tot_qty * (-1),:st_next_ordbk.l_ord_tot_qty)),
						FCP_MTM_OPN_VAL = FCP_MTM_OPN_VAL + (:st_next_ordbk.l_ord_lmt_rt * DECODE (:st_next_ordbk.c_ordr_flw,'S',:st_next_ordbk.l_ord_tot_qty * (-1),:st_next_ordbk.l_ord_tot_qty))  
			WHERE FCP_CLM_MTCH_ACCNT    = :st_next_ordbk.c_cln_mtch_accnt
      AND     FCP_XCHNG_CD        = :st_next_ordbk.c_xchng_cd
      AND     FCP_PRDCT_TYP       = :st_next_ordbk.c_prd_typ
      AND     FCP_UNDRLYNG        = :st_next_ordbk.c_undrlyng
      AND     FCP_EXPRY_DT        = :st_next_ordbk.c_expry_dt
      AND     FCP_EXER_TYP        = :st_next_ordbk.c_exrc_typ;
			
			if ( SQLCODE != 0 )
      {
        fn_errlog(c_ServiceName, "S31705", SQLMSG, c_err_msg );
				tpfree ( ( char * ) ptr_fml_obuf );
        tpfree ( ( char * ) ptr_fml_ibuf );
        return -1;
      }

		}
		else
		{
		EXEC SQL
      INSERT INTO FCP_FO_SPN_CNTRCT_PSTN
      (
        FCP_CLM_MTCH_ACCNT,
        FCP_XCHNG_CD,
        FCP_PRDCT_TYP,
        FCP_INDSTK,
        FCP_UNDRLYNG,
        FCP_EXPRY_DT,
        FCP_EXER_TYP,
				FCP_STRK_PRC,
				FCP_OPT_TYP,	
        FCP_BUY_EXCTD_QTY,
        FCP_SELL_EXCTD_QTY,
        FCP_OPNPSTN_FLW,
				FCP_OPNPSTN_QTY,
				FCP_OPNPSTN_VAL,
				FCP_MTM_OPN_VAL
      )
      VALUES
      (
				:st_next_ordbk.c_cln_mtch_accnt,
        :st_next_ordbk.c_xchng_cd,
        :st_next_ordbk.c_prd_typ,
        :st_next_ordbk.c_ctgry_indstk,
        :st_next_ordbk.c_undrlyng,
        to_date(:st_next_ordbk.c_expry_dt,'DD-Mon-YYYY'),
        :st_next_ordbk.c_exrc_typ,
				:st_next_ordbk.l_strike_prc,
				:st_next_ordbk.c_opt_typ,
        DECODE (:st_next_ordbk.c_ordr_flw ,'B',:st_next_ordbk.l_ord_tot_qty, 0),
        DECODE (:st_next_ordbk.c_ordr_flw ,'S',:st_next_ordbk.l_ord_tot_qty * -1, 0),
        :st_next_ordbk.c_ordr_flw,
				DECODE (:st_next_ordbk.c_ordr_flw ,'S',(:st_next_ordbk.l_ord_tot_qty * -1 ),:st_next_ordbk.l_ord_tot_qty),
				DECODE(:st_next_ordbk.c_ordr_flw ,'S',(:st_next_ordbk.l_ord_lmt_rt * :st_next_ordbk.l_ord_tot_qty * -1), :st_next_ordbk.l_ord_lmt_rt * :st_next_ordbk.l_ord_tot_qty),
				DECODE(:st_next_ordbk.c_ordr_flw ,'S',(:st_next_ordbk.l_ord_lmt_rt * :st_next_ordbk.l_ord_tot_qty * -1), :st_next_ordbk.l_ord_lmt_rt * :st_next_ordbk.l_ord_tot_qty)
      );

    	if ( SQLCODE != 0 )
    	{
      	fn_errlog(c_ServiceName, "S31710", SQLMSG, c_err_msg );
				tpfree ( ( char * ) ptr_fml_obuf );
        tpfree ( ( char * ) ptr_fml_ibuf );
      	return -1;
    	}
	 } 
		
	EXEC SQL
   SELECT  FUS_CLM_MTCH_ACCNT,
           FUS_XCHNG_CD,
           FUS_INDSTK,
           FUS_UNDRLYNG,
           FUS_UIBUY_QTY,
           FUS_UIBUY_VAL,
           FUS_UISELL_QTY,
           FUS_UISELL_VAL,
           FUS_UEXBUY_QTY,
           FUS_UEXBUY_VAL,
           FUS_UEXSELL_QTY,
           FUS_UEXSELL_VAL,
           FUS_UBUY_EXCTD_QTY,
           FUS_USELL_EXCTD_QTY,
           FUS_UOPNPSTN_FLW,
           FUS_UOPNPSTN_QTY,
           FUS_UOPNPSTN_VAL,
           FUS_UMTM_OPN_VAL,
           FUS_INITIAL_MRGN,
           FUS_SPAN_WEMULT_MRGN,
           FUS_EBA_EXPR_MRGN,
           FUS_USPAN_WENOV_MRGN,
           FUS_MULTIPLIER,
           FUS_USPAN_NENOV_MRGN,
           FUS_NET_OPTN_VAL,
           NVL(FUS_MIN_MRGN,0),
           NVL(FUS_MTM_FLG,'O'),
           FUS_BLCKD_PL,
           FUS_REQD_INITIAL_MRGN
   INTO    :st_undpstn_crrnt.c_cln_mtch_accnt,
           :st_undpstn_crrnt.c_xchng_cd,
           :st_undpstn_crrnt.c_indstk,
           :st_undpstn_crrnt.c_undrlyng,
           :st_undpstn_crrnt.l_uibuy_qty,
           :st_undpstn_crrnt.d_uibuy_val,
           :st_undpstn_crrnt.l_uisell_qty,
           :st_undpstn_crrnt.d_uisell_val,
           :st_undpstn_crrnt.l_uexbuy_qty,
           :st_undpstn_crrnt.d_uexbuy_val,
           :st_undpstn_crrnt.l_uexsell_qty,
           :st_undpstn_crrnt.d_uexsell_val,
           :st_undpstn_crrnt.l_ubuy_exctd_qty,
           :st_undpstn_crrnt.l_usell_exctd_qty,
           :st_undpstn_crrnt.c_uopnpstn_flw,
           :st_undpstn_crrnt.l_uopnpstn_qty,
           :st_undpstn_crrnt.d_uopnpstn_val,
           :st_undpstn_crrnt.d_umtm_opn_val,
           :st_undpstn_crrnt.d_initial_mrgn,
           :st_undpstn_crrnt.d_span_wemult_mrgn,
           :st_undpstn_crrnt.d_eba_expr_mrgn,
	  			 :st_undpstn_crrnt.d_uspan_wenov_mrgn,
           :st_undpstn_crrnt.d_multpr,
           :st_undpstn_crrnt.d_uspan_nenov_mrgn,
           :st_undpstn_crrnt.d_net_optn_val,
           :st_undpstn_crrnt.d_min_mrgn,
           :st_undpstn_crrnt.c_mtm_flg,
           :st_undpstn_crrnt.d_blckd_pl,
           :st_undpstn_crrnt.d_reqd_initial_mrgn
   FROM    FUS_FO_UNDRLYNG_SPN_PSTN
   WHERE   FUS_CLM_MTCH_ACCNT  = :st_first_ordbk.c_cln_mtch_accnt
   AND     FUS_XCHNG_CD        = :st_first_ordbk.c_xchng_cd
   AND     FUS_UNDRLYNG        = :st_first_ordbk.c_undrlyng;

   if ( ( SQLCODE != 0 ) && ( SQLCODE != NO_DATA_FOUND ) )
   {
     fn_errlog ( c_ServiceName, "S31715", SQLMSG, c_err_msg );
		 tpfree ( ( char * ) ptr_fml_obuf );
     tpfree ( ( char * ) ptr_fml_ibuf );	
     return -1;
   }

   if(DEBUG_MSG_LVL_3)
   {
     fn_userlog(c_ServiceName, "1. st_undpstn_crrnt.c_mtm_flg = :%c:", st_undpstn_crrnt.c_mtm_flg );
   }
	
  **** If a position doesnot exists, initialise the position values to default ****

  if ( SQLCODE == NO_DATA_FOUND )
  {
    strcpy( st_undpstn_crrnt.c_cln_mtch_accnt, st_first_ordbk.c_cln_mtch_accnt );
    strcpy( st_undpstn_crrnt.c_xchng_cd, st_first_ordbk.c_xchng_cd );
    strcpy( st_undpstn_crrnt.c_undrlyng, st_first_ordbk.c_undrlyng );
    st_undpstn_crrnt.c_indstk  = st_first_ordbk.c_ctgry_indstk;
    st_undpstn_crrnt.l_uibuy_qty= 0;
    st_undpstn_crrnt.d_uibuy_val= 0;
    st_undpstn_crrnt.l_uisell_qty= 0;
    st_undpstn_crrnt.d_uisell_val= 0;
    st_undpstn_crrnt.l_uexbuy_qty= 0;
    st_undpstn_crrnt.d_uexbuy_val= 0;
    st_undpstn_crrnt.l_uexsell_qty= 0;
    st_undpstn_crrnt.d_uexsell_val= 0;
    st_undpstn_crrnt.l_ubuy_exctd_qty= 0;
    st_undpstn_crrnt.l_usell_exctd_qty = 0;
    st_undpstn_crrnt.c_uopnpstn_flw = 'N';
    st_undpstn_crrnt.l_uopnpstn_qty = 0;
    st_undpstn_crrnt.d_uopnpstn_val = 0;
    st_undpstn_crrnt.d_umtm_opn_val = 0;
    st_undpstn_crrnt.d_initial_mrgn = 0;
    st_undpstn_crrnt.d_span_wemult_mrgn = 0;
    st_undpstn_crrnt.d_eba_expr_mrgn  = 0;
    st_undpstn_crrnt.d_uspan_wenov_mrgn = 0;
    st_undpstn_crrnt.d_multpr = 0;
    st_undpstn_crrnt.d_uspan_nenov_mrgn = 0;
    st_undpstn_crrnt.d_net_optn_val = 0;
    st_undpstn_crrnt.d_min_mrgn = 0;
    st_undpstn_crrnt.d_blckd_pl = 0;
    st_undpstn_crrnt.d_reqd_initial_mrgn  = 0;
    st_undpstn_crrnt.d_umtm_opn_val= 0;
  }
	
	if(DEBUG_MSG_LVL_3)
  {
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.c_cln_mtch_accnt					|%s|",st_undpstn_crrnt.c_cln_mtch_accnt);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.c_xchng_cd								|%s|",st_undpstn_crrnt.c_xchng_cd);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.c_undrlyng								|%s|",st_undpstn_crrnt.c_undrlyng);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.c_indstk									|%c|",st_undpstn_crrnt.c_indstk);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.l_uibuy_qty								|%ld|",st_undpstn_crrnt.l_uibuy_qty);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.d_uibuy_val								|%lf|",st_undpstn_crrnt.d_uibuy_val);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.l_uisell_qty							|%ld|",st_undpstn_crrnt.l_uisell_qty);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.d_uisell_val							|%lf|",st_undpstn_crrnt.d_uisell_val);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.l_uexbuy_qty							|%ld|",st_undpstn_crrnt.l_uexbuy_qty);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.d_uexbuy_val							|%lf|",st_undpstn_crrnt.d_uexbuy_val);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.l_uexsell_qty							|%ld|",st_undpstn_crrnt.l_uexsell_qty);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.d_uexsell_val							|%lf|",st_undpstn_crrnt.d_uexsell_val);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.l_ubuy_exctd_qty					|%ld|",st_undpstn_crrnt.l_ubuy_exctd_qty);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.l_usell_exctd_qty					|%ld|",st_undpstn_crrnt.l_usell_exctd_qty);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.c_uopnpstn_flw						|%c|",st_undpstn_crrnt.c_uopnpstn_flw);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.l_uopnpstn_qty						|%ld|",st_undpstn_crrnt.l_uopnpstn_qty);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.d_uopnpstn_val						|%lf|",st_undpstn_crrnt.d_uopnpstn_val);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.d_umtm_opn_val						|%lf|",st_undpstn_crrnt.d_umtm_opn_val);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.d_initial_mrgn						|%lf|",st_undpstn_crrnt.d_initial_mrgn);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.d_span_wemult_mrgn				|%lf|",st_undpstn_crrnt.d_span_wemult_mrgn);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.d_eba_expr_mrgn						|%lf|",st_undpstn_crrnt.d_eba_expr_mrgn);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.d_uspan_wenov_mrgn				|%lf|",st_undpstn_crrnt.d_uspan_wenov_mrgn);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.d_multpr									|%lf|",st_undpstn_crrnt.d_multpr);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.d_uspan_nenov_mrgn				|%lf|",st_undpstn_crrnt.d_uspan_nenov_mrgn);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.d_net_optn_val						|%lf|",st_undpstn_crrnt.d_net_optn_val);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.d_min_mrgn								|%lf|",st_undpstn_crrnt.d_min_mrgn);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.d_blckd_pl								|%lf|",st_undpstn_crrnt.d_blckd_pl);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.d_reqd_initial_mrgn				|%lf|",st_undpstn_crrnt.d_reqd_initial_mrgn);
		fn_userlog(c_ServiceName, "st_undpstn_crrnt.d_umtm_opn_val						|%lf|",st_undpstn_crrnt.d_umtm_opn_val);
	}
	
	EXEC	SQL
		SELECT	SPN_PRTFL1_SEQ.nextval
		INTO		:l_prtfl_seq1
		FROM		DUAL;

	if ( SQLCODE	!=	0	)
	{
		fn_userlog(c_ServiceName,"Error While Fetching	Sequence Number 1.");
    fn_errlog(c_ServiceName,"S31720",SQLMSG, c_err_msg);
    tpfree ( ( char * ) ptr_fml_ibuf );
    tpfree((char *)ptr_fml_obuf);
		return	-1;
	}

	EXEC  SQL
  	SELECT  SPN_PRTFL1_SEQ.nextval
    INTO    :l_prtfl_seq2
    FROM    DUAL;

  if ( SQLCODE  !=  0 )
  {
    fn_userlog(c_ServiceName,"Error While Fetching  Sequence Number 1.");
    fn_errlog(c_ServiceName,"S31725",SQLMSG, c_err_msg);
		tpfree ( ( char * ) ptr_fml_ibuf );
    tpfree((char *)ptr_fml_obuf);
    return  -1;
  }

	MEMSET(c_inp_strng);    
	MEMSET(c_inp_strng11); 
	MEMSET(c_inp_strng1); 
	MEMSET(c_inp_strng2);  
	MEMSET(c_inp_strng22);

	strcpy(c_inp_strng1,"1^");
  strcpy(c_inp_strng2,"|");

	 ***	Ver	1.1	Satrts	*** 
	if(strcmp(sql_xchng_cd,"NFO") == 0)
  {
    strcat(c_inp_strng1,"NSE^");
  }
  else if(strcmp(sql_xchng_cd,"BFO") == 0)
  {
    strcat(c_inp_strng1,"BSE^");
  }
	***	Ver	1.1	Ends	***

	sprintf(c_seq_num1,"%ld",l_prtfl_seq1);
	sprintf(c_seq_num2,"%ld",l_prtfl_seq2);

	strcat( c_inp_strng1 , c_seq_num1 );
	strcat( c_inp_strng2 , c_seq_num2 );

	strcat(c_inp_strng1,"^");
	strcat(c_inp_strng2,"^");

	EXEC SQL
   	SELECT  FCB_UNDRLYNG_BSKT_ID
   	INTO    :l_basket_id
   	FROM    FCB_FO_CLN_BSKT_ALLTD
   	WHERE   FCB_CLN_LVL = ( SELECT  CLM_CLNT_LVL
                            FROM    CLM_CLNT_MSTR
                            WHERE   CLM_MTCH_ACCNT = :sql_cln_mtch_accnt);
  if ( SQLCODE != 0 )
  {
		fn_userlog(c_ServiceName,"Error While Fetching  Sequence Number 1.");
    fn_errlog(c_ServiceName,"S31730",SQLMSG, c_err_msg);
		tpfree ( ( char * ) ptr_fml_ibuf );
    tpfree((char *)ptr_fml_obuf);
    return  -1;
  }

	** Prepare a list of contracts from contract position table **

	EXEC SQL ALLOCATE :sys_cursor;

	EXEC SQL EXECUTE
    BEGIN
    	OPEN 		:sys_cursor FOR
			SELECT	FCP_CLM_MTCH_ACCNT,
 							FCP_XCHNG_CD,
 							FCP_PRDCT_TYP,
 							FCP_INDSTK,
 							FCP_UNDRLYNG,
 							TO_CHAR(FCP_EXPRY_DT,'DD-Mon-YYYY'),
 							FCP_EXER_TYP,
							FCP_STRK_PRC,
							FCP_OPT_TYP,
 							FCP_IBUY_QTY,
 							FCP_IBUY_ORD_VAL,
 							FCP_ISELL_QTY,
 							FCP_ISELL_ORD_VAL,
 							FCP_EXBUY_QTY,
 							FCP_EXBUY_ORD_VAL,
 							FCP_EXSELL_QTY,
 							FCP_EXSELL_ORD_VAL,
 							FCP_BUY_EXCTD_QTY,
 							FCP_SELL_EXCTD_QTY,
 							FCP_OPNPSTN_FLW,
 							FCP_OPNPSTN_QTY,
 							FCP_OPNPSTN_VAL,
 							FCP_MTM_OPN_VAL
				FROM	FCP_FO_SPN_CNTRCT_PSTN
				WHERE	FCP_CLM_MTCH_ACCNT	= :sql_cln_mtch_accnt
       	AND   FCP_XCHNG_CD       	= :sql_xchng_cd
       	AND   FCP_UNDRLYNG       	= :sql_undrlyng
       	ORDER BY FCP_EXPRY_DT ASC;
     	END;
    END-EXEC;

  	if ( SQLCODE != 0 )
  	{
    	EXEC SQL FREE :sys_cursor;
    	fn_errlog ( c_ServiceName, "S31735", SQLMSG, c_err_msg );
		  tpfree ( ( char * ) ptr_fml_ibuf );
    	tpfree((char *)ptr_fml_obuf);
    	return -1;
  	}

  	c_pos_avl = 'N';		
	
		** Fetch one contract at a time from the list. If the fetched  **
  	** contract is the one we need to apply the change apply it.   **
  	** Else simply add the contract to  underlying level position  **
		
		while ( 1 )
		{
			d_expsr_mrgn			=	0.0;
			d_min_expsr_mrgn	=	0.0;
			d_cntrct_pl       = 0.0;
			d_ltp							=	0.0;
			d_clsng_prc				=	0.0;
			d_strike_prc			=	0.0;
			st_cntrct_pstn_crrnt.l_ibuy_qty = 0;
			st_cntrct_pstn_crrnt.d_ibuy_ord_val = 0.0;
			st_cntrct_pstn_crrnt.l_isell_qty = 0;
			st_cntrct_pstn_crrnt.d_isell_ord_val= 0.0;
			st_cntrct_pstn_crrnt.l_exbuy_qty = 0;
			st_cntrct_pstn_crrnt.d_exbuy_ord_val= 0.0;
			st_cntrct_pstn_crrnt.l_exsell_qty = 0;
			st_cntrct_pstn_crrnt.d_exsell_ord_val = 0.0;
			st_cntrct_pstn_crrnt.l_buy_exctd_qty = 0;
			st_cntrct_pstn_crrnt.l_sell_exctd_qty=0;
			st_cntrct_pstn_crrnt.l_opnpstn_qty=0;
			st_cntrct_pstn_crrnt.d_opnpstn_val = 0.0;
			st_cntrct_pstn_crrnt.d_mtm_opn_val = 0.0;

			MEMSET(c_exp_dt);

			EXEC SQL FETCH	:sys_cursor
               INTO  	:st_cntrct_pstn_crrnt.c_cln_mtch_accnt,
                      :st_cntrct_pstn_crrnt.c_xchng_cd,
                      :st_cntrct_pstn_crrnt.c_prd_typ,
                      :st_cntrct_pstn_crrnt.c_ctgry_indstk,
                      :st_cntrct_pstn_crrnt.c_undrlyng,
                      :c_exp_dt,
                      :st_cntrct_pstn_crrnt.c_exer_typ,
                      :st_cntrct_pstn_crrnt.l_strike_prc,
                      :st_cntrct_pstn_crrnt.c_opt_typ,
                      :st_cntrct_pstn_crrnt.l_ibuy_qty,
                      :st_cntrct_pstn_crrnt.d_ibuy_ord_val,
                      :st_cntrct_pstn_crrnt.l_isell_qty,
                      :st_cntrct_pstn_crrnt.d_isell_ord_val,
                      :st_cntrct_pstn_crrnt.l_exbuy_qty,
                      :st_cntrct_pstn_crrnt.d_exbuy_ord_val,
                      :st_cntrct_pstn_crrnt.l_exsell_qty,
                      :st_cntrct_pstn_crrnt.d_exsell_ord_val,
                      :st_cntrct_pstn_crrnt.l_buy_exctd_qty,
                      :st_cntrct_pstn_crrnt.l_sell_exctd_qty,
                      :st_cntrct_pstn_crrnt.c_opnpstn_flw,
                      :st_cntrct_pstn_crrnt.l_opnpstn_qty,
                      :st_cntrct_pstn_crrnt.d_opnpstn_val,
                      :st_cntrct_pstn_crrnt.d_mtm_opn_val;

			if ( SQLCODE != 0 )
    	{
    		if ( SQLCODE == NO_DATA_FOUND )
        {
					fn_userlog(c_ServiceName," Inside NO_DATA_FOUND .");
          break;
        }

        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        fn_errlog ( c_ServiceName, "S31740", SQLMSG, c_err_msg );
				tpfree ( ( char * ) ptr_fml_ibuf );
				tpfree((char *)ptr_fml_obuf);
        return -1;
      }
			
			if(DEBUG_MSG_LVL_3)
      {
				fn_userlog(c_ServiceName,"SPAN	st_cntrct_pstn_crrnt.c_cln_mtch_accnt	|%s|",st_cntrct_pstn_crrnt.c_cln_mtch_accnt);
				fn_userlog(c_ServiceName,"SPAN	st_cntrct_pstn_crrnt.c_xchng_cd     	|%s|",st_cntrct_pstn_crrnt.c_xchng_cd);
				fn_userlog(c_ServiceName,"SPAN  st_cntrct_pstn_crrnt.c_undrlyng				|%s|",st_cntrct_pstn_crrnt.c_undrlyng);
				fn_userlog(c_ServiceName,"SPAN	c_exp_dt															|%s|",c_exp_dt.arr);
        fn_userlog(c_ServiceName,"SPAN  st_cntrct_pstn_crrnt.l_buy_exctd_qty:%ld:",st_cntrct_pstn_crrnt.l_buy_exctd_qty);
        fn_userlog(c_ServiceName,"SPAN  st_cntrct_pstn_crrnt.l_sel_exctd_qty%ld:",st_cntrct_pstn_crrnt.l_sell_exctd_qty);
        fn_userlog(c_ServiceName,"SPAN  st_cntrct_pstn_crrnt.l_ibuy_qty     :%ld:",st_cntrct_pstn_crrnt.l_ibuy_qty);
        fn_userlog(c_ServiceName,"SPAN  st_cntrct_pstn_crrnt.l_isell_qty    :%ld:",st_cntrct_pstn_crrnt.l_isell_qty);
        fn_userlog(c_ServiceName,"SPAN  st_cntrct_pstn_crrnt.l_exbuy_qty    :%ld:",st_cntrct_pstn_crrnt.l_exbuy_qty);
        fn_userlog(c_ServiceName,"SPAN  st_cntrct_pstn_crrnt.l_exsell_qty   :%ld:",st_cntrct_pstn_crrnt.l_exsell_qty);
        fn_userlog(c_ServiceName,"SPAN  st_cntrct_pstn_crrnt.d_ibuy_ord_val :%lf:",st_cntrct_pstn_crrnt.d_ibuy_ord_val);
        fn_userlog(c_ServiceName,"SPAN  st_cntrct_pstn_crrnt.d_isell_ord_val :%lf:",st_cntrct_pstn_crrnt.d_isell_ord_val);
        fn_userlog(c_ServiceName,"SPAN  st_cntrct_pstn_crrnt.d_exbuy_ord_val:%lf:",st_cntrct_pstn_crrnt.d_exbuy_ord_val);
        fn_userlog(c_ServiceName,"SPAN  st_cntrct_pstn_crrnt.d_exsell_ord_val:%lf:",st_cntrct_pstn_crrnt.d_exsell_ord_val);
        fn_userlog(c_ServiceName,"SPAN  st_cntrct_pstn_crrnt.d_opnpstn_val   :%lf:",st_cntrct_pstn_crrnt.d_opnpstn_val);
        fn_userlog(c_ServiceName,"SPAN  st_cntrct_pstn_crrnt.d_mtm_opn_val   :%lf:",st_cntrct_pstn_crrnt.d_mtm_opn_val);
			  fn_userlog(c_ServiceName,"SPAN st_cntrct_pstn_crrnt.c_opnpstn_flw		 |%c|",st_cntrct_pstn_crrnt.c_opnpstn_flw);		
			}

			SETNULL( c_exp_dt );
      strcpy ( st_cntrct_pstn_crrnt.c_expry_dt, (char *) c_exp_dt.arr );
      rtrim(st_cntrct_pstn_crrnt.c_xchng_cd);
      rtrim(st_cntrct_pstn_crrnt.c_undrlyng);
      rtrim(st_cntrct_pstn_crrnt.c_expry_dt);

			if(DEBUG_MSG_LVL_3)
    	{
				fn_userlog(c_ServiceName,"ROLLOVER st_cntrct_pstn_crrnt.l_opnpstn_qty is :%ld:",st_cntrct_pstn_crrnt.l_opnpstn_qty);
				fn_userlog(c_ServiceName,"ROLLOVER st_cntrct_pstn_crrnt.l_ibuy_qty is :%ld:",st_cntrct_pstn_crrnt.l_ibuy_qty);
				fn_userlog(c_ServiceName,"ROLLOVER st_cntrct_pstn_crrnt.l_exbuy_qty is :%ld:",st_cntrct_pstn_crrnt.l_exbuy_qty);
				fn_userlog(c_ServiceName,"ROLLOVER st_cntrct_pstn_crrnt.l_isell_qty is :%ld:",st_cntrct_pstn_crrnt.l_isell_qty);
				fn_userlog(c_ServiceName,"ROLLOVER st_cntrct_pstn_crrnt.l_exsell_qty  is :%ld:",st_cntrct_pstn_crrnt.l_exsell_qty);
			}

			l_max_opn_qty	=	st_cntrct_pstn_crrnt.l_opnpstn_qty	+	 fn_maxl(st_cntrct_pstn_crrnt.l_ibuy_qty,st_cntrct_pstn_crrnt.l_exbuy_qty) ;

			l_min_opn_qty	=	st_cntrct_pstn_crrnt.l_opnpstn_qty	+	 fn_maxl(abs(st_cntrct_pstn_crrnt.l_isell_qty),abs(st_cntrct_pstn_crrnt.l_exsell_qty)) * -1 	;

			if(DEBUG_MSG_LVL_3)
    	{
				fn_userlog(c_ServiceName,"ROLLOVER l_max_opn_qty is :%ld:",l_max_opn_qty);
				fn_userlog(c_ServiceName,"ROLLOVER l_min_opn_qty is :%ld:",l_min_opn_qty);
			}

			i_expsr_rtrn	=	fn_cal_expsr	(	c_ServiceName,
																			st_cntrct_pstn_crrnt,
																			l_basket_id,
																			&d_expsr_mrgn,
																			&d_min_expsr_mrgn,
																			&d_mltplr,
																			c_err_msg
																		);

			if ( i_expsr_rtrn != 0 )
			{
				 fn_errlog(c_ServiceName, "S31745", LIBMSG, c_err_msg );
         EXEC SQL CLOSE :sys_cursor;
         tpfree((char *)ptr_fml_obuf);
         tpfree((char *)ptr_fml_ibuf);
         return -1;
			}
			
			EXEC SQL
        SELECT  NVL(FTQ_LST_TRD_PRC,0), 
                NVL(FTQ_CLS_PRC,0)     
        INTO    :d_ltp,
                :d_clsng_prc
        FROM    FTQ_FO_TRD_QT
        WHERE   FTQ_XCHNG_CD  = :st_cntrct_pstn_crrnt.c_xchng_cd
        AND     FTQ_PRDCT_TYP = :st_cntrct_pstn_crrnt.c_prd_typ
        AND     FTQ_UNDRLYNG  = :st_cntrct_pstn_crrnt.c_undrlyng
        AND     FTQ_EXPRY_DT  = :c_exp_dt
        AND     FTQ_EXER_TYP  = :st_cntrct_pstn_crrnt.c_exer_typ
        AND     FTQ_OPT_TYP   = :st_cntrct_pstn_crrnt.c_opt_typ
        AND     FTQ_STRK_PRC  = :st_cntrct_pstn_crrnt.l_strike_prc;
			
			if(SQLCODE  !=  0 && SQLCODE != NO_DATA_FOUND )
      {
        fn_errlog ( c_ServiceName, "S31750", SQLMSG, c_err_msg );
        EXEC SQL CLOSE :sys_cursor;
        tpfree((char *)ptr_fml_obuf);
        tpfree((char *)ptr_fml_ibuf);
        return -1;
      }

      if( SQLCODE == NO_DATA_FOUND ) 
      {
        d_ltp = 0.0;
        d_clsng_prc = 0.0;
      }
		
			if(DEBUG_MSG_LVL_3)
    	{	
				fn_userlog(c_ServiceName,"SPAN - d_ltp |%lf|",d_ltp);
      	fn_userlog(c_ServiceName,"SPAN - st_cntrct_pstn_crrnt.l_opnpstn_qty |%ld|",st_cntrct_pstn_crrnt.l_opnpstn_qty);
      	fn_userlog(c_ServiceName,"SPAN - st_cntrct_pstn_crrnt.d_opnpstn_val |%lf|",st_cntrct_pstn_crrnt.d_opnpstn_val);
			}

			if ( st_cntrct_pstn_crrnt.l_opnpstn_qty != 0 )
      {
        if ( st_cntrct_pstn_crrnt.c_prd_typ == 'O')
        {
          if( st_cntrct_pstn_crrnt.l_opnpstn_qty < 0 )
          {
            if(DEBUG_MSG_LVL_3)
            {
              fn_userlog(c_ServiceName,"SPAN - Inside Option Profit / Loss Case.");
            }
        		d_cntrct_pl = (double) abs(st_cntrct_pstn_crrnt.l_opnpstn_qty)  * ( d_clsng_prc - d_ltp);
          }

        }
        else		
				{
          if (  st_cntrct_pstn_crrnt.c_prd_typ  ==  'F' )
          {
            if(DEBUG_MSG_LVL_3)
            {
              fn_userlog(c_ServiceName,"SPAN - Inside Option Profit / Loss Case.");
            }

            if( st_cntrct_pstn_crrnt.l_opnpstn_qty  > 0 )
            {

              d_cntrct_pl = ( d_ltp * (double) st_cntrct_pstn_crrnt.l_opnpstn_qty ) - st_cntrct_pstn_crrnt.d_opnpstn_val;

            }
            else if ( st_cntrct_pstn_crrnt.l_opnpstn_qty < 0 )
            {
              d_cntrct_pl = fabs(st_cntrct_pstn_crrnt.d_opnpstn_val)  -  ( d_ltp * (double) abs(st_cntrct_pstn_crrnt.l_opnpstn_qty) );
            }
          }
        }
      }

      d_ltp = d_ltp / 100;


			EXEC SQL
				SELECT	SEM_MAP_VL
				INTO		:c_stock_cd
				FROM		SEM_STCK_MAP
				WHERE		SEM_STCK_CD	=	:st_cntrct_pstn_crrnt.c_undrlyng
        AND     SEM_ENTTY   = decode(:sql_xchng_cd,'NFO',3,'BFO',14)  ;

			if ( SQLCODE  !=  0 )
      {
        fn_errlog ( c_ServiceName, "S31755", SQLMSG, c_err_msg );
        EXEC SQL CLOSE :sys_cursor;
        tpfree((char *)ptr_fml_obuf);
        tpfree((char *)ptr_fml_ibuf);
        return -1;
      }

			SETNULL(c_stock_cd);


			EXEC SQL
      	SELECT to_char(to_date(:st_cntrct_pstn_crrnt.c_expry_dt,'DD-Mon-YYYY'),'dd-Mon-YY')
      	INTO  :c_expry_dt
      	FROM  DUAL;

    	if ( SQLCODE  !=  0 )
    	{
      	fn_errlog ( c_ServiceName, "S31760", SQLMSG, c_err_msg );
        EXEC SQL CLOSE :sys_cursor;
        tpfree((char *)ptr_fml_obuf);
        tpfree((char *)ptr_fml_ibuf);
      	return -1;
    	}

		  d_strike_prc  = (double) st_cntrct_pstn_crrnt.l_strike_prc / 100.00  ;
			sprintf(c_strk_prc,"%lf",d_strike_prc);
			fn_spn_rtrim(c_strk_prc,'0');
      fn_spn_rtrim(c_strk_prc,'.');

			if(	l_cntr	==	0	)
			{
				if(DEBUG_MSG_LVL_3)
				{
					fn_userlog(c_ServiceName,"SPAN	-	l_cntr Is :%ld:",l_cntr);
				}

				if(st_cntrct_pstn_crrnt.c_prd_typ	==	'F')
				{
		  		sprintf(c_inp_strng11,"%s^%s~%c:%s^%ld^%lf",st_cntrct_pstn_crrnt.c_cln_mtch_accnt,c_stock_cd.arr,st_cntrct_pstn_crrnt.c_prd_typ,c_expry_dt,l_max_opn_qty,d_first_ltp);

      	strcat(c_inp_strng1,c_inp_strng11);

      	sprintf(c_inp_strng22,"%s^%s~%c:%s^%ld^%lf",st_cntrct_pstn_crrnt.c_cln_mtch_accnt,c_stock_cd.arr,st_cntrct_pstn_crrnt.c_prd_typ,c_expry_dt,l_min_opn_qty,d_first_ltp);

      	strcat(c_inp_strng2,c_inp_strng22);

				}
				else
				{
      		sprintf(c_inp_strng11,"%s^%s~%c:%s:%c%c:%s^%ld^%lf",st_cntrct_pstn_crrnt.c_cln_mtch_accnt,c_stock_cd.arr,st_cntrct_pstn_crrnt.c_prd_typ,c_expry_dt,st_cntrct_pstn_crrnt.c_opt_typ,st_cntrct_pstn_crrnt.c_exer_typ,c_strk_prc,l_max_opn_qty,d_first_ltp);	

      		strcat(c_inp_strng1,c_inp_strng11);


      		sprintf(c_inp_strng22,"%s^%s~%c:%s:%c%c:%s^%ld^%lf",st_cntrct_pstn_crrnt.c_cln_mtch_accnt,c_stock_cd.arr,st_cntrct_pstn_crrnt.c_prd_typ,c_expry_dt,st_cntrct_pstn_crrnt.c_opt_typ,st_cntrct_pstn_crrnt.c_exer_typ,c_strk_prc,l_min_opn_qty,d_first_ltp); 

      		strcat(c_inp_strng2,c_inp_strng22);

				}
			}
			else
			{
				if(st_cntrct_pstn_crrnt.c_prd_typ  ==  'F')
        {
        	sprintf(c_inp_strng11,"%s~%c:%s^%ld^%lf",c_stock_cd.arr,st_cntrct_pstn_crrnt.c_prd_typ,c_expry_dt,l_max_opn_qty,d_first_ltp);

        	strcat(c_inp_strng1,c_inp_strng11);

        	sprintf(c_inp_strng22,"%s~%c:%s^%ld^%lf",c_stock_cd.arr,st_cntrct_pstn_crrnt.c_prd_typ,c_expry_dt,l_min_opn_qty,d_first_ltp);

        	strcat(c_inp_strng2,c_inp_strng22);

        }
        else
        {
          sprintf(c_inp_strng11,"%s~%c:%s:%c%c:%s^%ld^%lf",c_stock_cd.arr,st_cntrct_pstn_crrnt.c_prd_typ,c_expry_dt,st_cntrct_pstn_crrnt.c_opt_typ,st_cntrct_pstn_crrnt.c_exer_typ,c_strk_prc,l_max_opn_qty,d_first_ltp); 

          strcat(c_inp_strng1,c_inp_strng11);

          sprintf(c_inp_strng22,"%s~%c:%s:%c%c:%s^%ld^%lf",c_stock_cd.arr,st_cntrct_pstn_crrnt.c_prd_typ,c_expry_dt,st_cntrct_pstn_crrnt.c_opt_typ,st_cntrct_pstn_crrnt.c_exer_typ,c_strk_prc,l_min_opn_qty,d_first_ltp);

          strcat(c_inp_strng2,c_inp_strng22);

        }
			}

			if(DEBUG_MSG_LVL_5)
      {
				fn_userlog(c_ServiceName," Input String c_inp_strng11 is :%s:",c_inp_strng11);
				fn_userlog(c_ServiceName," Input String c_inp_strng22 is :%s:",c_inp_strng22);
        fn_userlog ( c_ServiceName, "Expiry date       :%s:", c_exp_dt.arr );
        fn_userlog ( c_ServiceName, "IWTL buy qty      :%ld:", st_cntrct_pstn_crrnt.l_ibuy_qty );
        fn_userlog ( c_ServiceName, "IWTL buy val      :%lf:", st_cntrct_pstn_crrnt.d_ibuy_ord_val);
        fn_userlog ( c_ServiceName, "IWTL sell qty     :%ld:", st_cntrct_pstn_crrnt.l_isell_qty );
        fn_userlog ( c_ServiceName, "IWTL sell val     :%lf:", st_cntrct_pstn_crrnt.d_isell_ord_val );
        fn_userlog ( c_ServiceName, "EXCH buy qty      :%ld:", st_cntrct_pstn_crrnt.l_exbuy_qty );
        fn_userlog ( c_ServiceName, "EXCH buy val      :%lf:", st_cntrct_pstn_crrnt.d_exbuy_ord_val );
        fn_userlog ( c_ServiceName, "EXCH sell qty     :%ld:", st_cntrct_pstn_crrnt.l_exsell_qty );
        fn_userlog ( c_ServiceName, "EXCH sell val     :%lf:", st_cntrct_pstn_crrnt.d_exsell_ord_val );
        fn_userlog ( c_ServiceName, "Buy exctd qty     :%ld:", st_cntrct_pstn_crrnt.l_buy_exctd_qty );
        fn_userlog ( c_ServiceName, "Sell exctd qty    :%ld:", st_cntrct_pstn_crrnt.l_sell_exctd_qty );
        fn_userlog ( c_ServiceName, "Open qty          :%ld:", st_cntrct_pstn_crrnt.l_opnpstn_qty );
        fn_userlog ( c_ServiceName, "Original open val :%lf:", st_cntrct_pstn_crrnt.d_opnpstn_val);
        fn_userlog ( c_ServiceName, "MTMed open val    :%lf:", st_cntrct_pstn_crrnt.d_mtm_opn_val );
        fn_userlog ( c_ServiceName, "d_undrlyng_pl val    :%lf:", d_undrlyng_pl );
        fn_userlog ( c_ServiceName, "d_cntrct_pl val    :%lf:", d_cntrct_pl );
    	}

	  strcat(c_inp_strng1,",");
	  strcat(c_inp_strng2,",");
	
		l_cntr++;
		d_undrlyng_pl = d_undrlyng_pl + d_cntrct_pl ;
		d_expsr			=	d_expsr_mrgn	+	d_expsr	;
		d_min_expsr	=	d_min_expsr_mrgn	+	d_min_expsr	;
	} *** END of while loop ***

	EXEC SQL CLOSE :sys_cursor;
  EXEC SQL FREE :sys_cursor;

 	l_length1 = strlen(c_inp_strng1);

  if( c_inp_strng1[l_length1  - 1 ] == ',')
  {
  	c_inp_strng1[l_length1 -1]  ='\0';
 	}

  l_length2 = strlen(c_inp_strng2);

  if( c_inp_strng2[l_length2  - 1 ] == ',')
  {
    c_inp_strng2[l_length2 -1]  ='\0';
  }

	if ( st_cntrct_pstn_md_rc.l_opnpstn_qty > 0 )
  {
    st_cntrct_pstn_md_rc.c_opnpstn_flw = BUY;
  }
  else if ( st_cntrct_pstn_md_rc.l_opnpstn_qty < 0 )
  {
    st_cntrct_pstn_md_rc.c_opnpstn_flw = SELL;
  }
  else
  {
    st_cntrct_pstn_md_rc.c_opnpstn_flw = NEUTRAL;
  }

	strcpy(c_inp_strng,c_inp_strng1);
	strcat(c_inp_strng,c_inp_strng2);
	strcat(c_inp_strng,"\n");		

	if(DEBUG_MSG_LVL_5)
  {
    fn_userlog(c_ServiceName,"Input String |%s|",c_inp_strng);
  }

	if ( Fadd32 (ptr_fml_ibuf,FFO_PIPE_ID,(char *)st_first_ordbk.c_pipe_id,0)	==	-1 )
	{
		fn_errlog( c_ServiceName, "S31765",FMLMSG , c_err_msg );
		EXEC SQL CLOSE :sys_cursor;
		tpfree((char *)ptr_fml_obuf);
		tpfree((char *)ptr_fml_ibuf);
		return -1;
	}

	if ( Fadd32 (ptr_fml_ibuf,FFO_REMARKS,(char *)c_inp_strng,0)	==	-1 )
	{
		fn_errlog( c_ServiceName, "S31770",FMLMSG , c_err_msg );
		EXEC SQL CLOSE :sys_cursor;
		tpfree((char *)ptr_fml_obuf);
		tpfree((char *)ptr_fml_ibuf);
		return -1;
	}
		
	if(DEBUG_MSG_LVL_3)
	{
		fn_userlog(c_ServiceName,"Before Call To Service For Margin Calculation.");
	}

	i_rtrn_cd1	=	tpcall("SFO_SPAN_MRGN",(char*)ptr_fml_ibuf,0,(char **)&ptr_fml_obuf,&li_len_tobuf,0);

	if(	i_rtrn_cd1 != 0	)
	{
		fn_errlog( c_ServiceName, "S31775",TPMSG , c_err_msg );
		EXEC SQL CLOSE :sys_cursor;
		EXEC SQL FREE :sys_cursor;
		tpfree((char *)ptr_fml_obuf);
		tpfree((char *)ptr_fml_ibuf);
		return -1;
	}

	if ( Fget32 (ptr_fml_obuf,FFO_ABT_TRG_DATA,0,(char *)c_op_strng,0)  ==  -1 )
	{	
		fn_errlog( c_ServiceName, "S31780",FMLMSG , c_err_msg );
		EXEC SQL CLOSE :sys_cursor;
		tpfree((char *)ptr_fml_obuf);
		tpfree((char *)ptr_fml_ibuf);
		return -1;
	}

	if(DEBUG_MSG_LVL_3)
	{
		fn_userlog(c_ServiceName,"Output String Is :%s:",c_op_strng);
	}

	strcpy(c_op_strng1,strtok(c_op_strng,"|"));
	strcpy(c_op_strng2,strtok(null_ptr,"|"));

	strcpy(c_mrgn_indctr,strtok(c_op_strng1,"^"));
	strcpy(c_seq_num1,strtok(null_ptr,"^"));
  strcpy(c_xchng_cd1,strtok(null_ptr,"^"));			***	Ver	1.1	***
	strcpy(c_mtch_accnt1,strtok(null_ptr,"^"));
	strcpy(c_spn_mrgn1,strtok(null_ptr,"^"));
	strcpy(c_nov1,strtok(null_ptr,"^"));
	strcpy(c_total_mrgn1,strtok(null_ptr,"^"));

	strcpy(c_seq_num2,strtok(c_op_strng2,"^"));
	strcpy(c_mtch_accnt2,strtok(null_ptr,"^"));
	strcpy(c_spn_mrgn2,strtok(null_ptr,"^"));
	strcpy(c_nov2,strtok(null_ptr,"^"));
	strcpy(c_total_mrgn2,strtok(null_ptr,"^"));

	if(DEBUG_MSG_LVL_5)
	{
		fn_userlog(c_ServiceName,"SPAN c_mtch_accnt1 Is :%s:",c_mtch_accnt1);
	}

	if ( c_mtch_accnt1[0] == '1' || c_mtch_accnt1[0] == '2' || c_mtch_accnt1[0] == '3' )
	{	
		fn_errlog( c_ServiceName, "S31785",LIBMSG , c_err_msg );
		fn_userlog(c_ServiceName,"Service Return Error.");
   	EXEC SQL CLOSE :sys_cursor;
   	tpfree((char *)ptr_fml_obuf);
   	tpfree((char *)ptr_fml_ibuf);
		return -1	;
	}

	if(DEBUG_MSG_LVL_5)
	{
		fn_userlog(c_ServiceName,"c_total_mrgn1 Is :%s:",c_total_mrgn1);
		fn_userlog(c_ServiceName,"c_total_mrgn2 Is :%s:",c_total_mrgn2);
	}

		d_spn_mrgn1		=	atof(c_spn_mrgn1);
		d_spn_mrgn2 	= atof(c_spn_mrgn2);
		d_nov1				=	atof(c_nov1);
		d_nov2				=	atof(c_nov2);
		d_total_mrgn1	=	atof(c_total_mrgn1);
		d_total_mrgn2	=	atof(c_total_mrgn2);

		if(DEBUG_MSG_LVL_5)
		{
			fn_userlog(c_ServiceName,"d_total_mrgn1 Is :%lf:",d_total_mrgn1);
			fn_userlog(c_ServiceName,"d_total_mrgn2 Is :%lf:",d_total_mrgn2);
		}

		st_undpstn_tobe.d_uspan_nenov_mrgn	=	fn_maxd(d_spn_mrgn1,d_spn_mrgn2) * 100;
		st_undpstn_tobe.d_net_optn_val			=	fn_maxd(d_nov1,d_nov2) * 100;
		st_undpstn_tobe.d_uspan_wenov_mrgn	=	fn_maxd(d_total_mrgn1,d_total_mrgn2) * 100 ;

		d_spn_mrgn		=	st_undpstn_tobe.d_uspan_nenov_mrgn		;		
		d_nov					=	st_undpstn_tobe.d_net_optn_val				;	
		d_total_mrgn	=	st_undpstn_tobe.d_uspan_wenov_mrgn		;

		if(DEBUG_MSG_LVL_5)
		{
			fn_userlog(c_ServiceName,"SPAN - SPAN MARGIN Is :%lf:",d_spn_mrgn);
			fn_userlog(c_ServiceName,"SPAN - SPAN MARGIN Is :%lf:",st_undpstn_tobe.d_uspan_wenov_mrgn);
		}

		i_returncode	=	fn_cal_mrgn ( c_ServiceName,
     		           								d_total_mrgn,
       		          							d_mltplr,
         		       								d_expsr,
																	d_min_expsr,
           		      							&d_min_mrgn,
             		    							&d_intl_mrgn,
               		  							c_err_msg
               									);

		if ( i_returncode	!=	0	)
		{
			fn_errlog( c_ServiceName, "S31790",LIBMSG , c_err_msg );
   		fn_userlog(c_ServiceName,"Service Return Error.");
   		EXEC SQL CLOSE :sys_cursor;
   		tpfree((char *)ptr_fml_obuf);
   		tpfree((char *)ptr_fml_ibuf);
   		return -1 ;
		}

		if(DEBUG_MSG_LVL_3)
		{
			fn_userlog(c_ServiceName,"SPAN	-	SPAN MARGIN IS :%lf:",d_spn_mrgn);
			fn_userlog(c_ServiceName,"SPAN	-	NOV	IS :%lf:",d_nov);
			fn_userlog(c_ServiceName,"SPAN	-	Total Margin	IS :%lf:",d_total_mrgn);
			fn_userlog(c_ServiceName,"SPAN	-	Exposure	IS :%lf:",d_expsr);
			fn_userlog(c_ServiceName,"SPAN	-	Min. Margin	IS :%lf:",d_min_mrgn);
			fn_userlog(c_ServiceName,"SPAN	-	Initial Margin IS :%lf:",d_intl_mrgn);
		}

		st_undpstn_tobe.d_multpr						=	d_mltplr			;
		st_undpstn_tobe.d_eba_expr_mrgn			=	(long long)d_expsr		;
		st_undpstn_tobe.d_span_wemult_mrgn	= (long long)d_total_mrgn * d_mltplr ;
		st_undpstn_tobe.d_min_mrgn					=	d_min_mrgn ;
		st_undpstn_tobe.d_reqd_initial_mrgn	=	(long long)d_intl_mrgn ;

    strcpy( c_narration_id , ON_ROLLOVER_ORDER_PLACEMENT);
    c_dr_without_lmt_flg = DEBIT_WHEN_LIMIT;

		if(DEBUG_MSG_LVL_3)
		{
    	fn_userlog ( c_ServiceName, "NEW ORDER REQUEST");
			fn_userlog ( c_ServiceName,"st_undpstn_tobe.d_reqd_initial_mrgn |%lf|",st_undpstn_tobe.d_reqd_initial_mrgn);
		}

		EXEC SQL
      SELECT  NVL(FUS_BLCKD_PL,0)
      INTO    :d_oblckd_amnt
      FROM    FUS_FO_UNDRLYNG_SPN_PSTN
      WHERE   FUS_CLM_MTCH_ACCNT  = :sql_cln_mtch_accnt
      AND     FUS_UNDRLYNG        = :sql_undrlyng
      AND     FUS_XCHNG_CD        = :sql_xchng_cd;

      if ( SQLCODE != 0 && SQLCODE  !=  NO_DATA_FOUND)
      {
        fn_errlog( c_ServiceName, "S31795",SQLMSG , c_err_msg );
        EXEC SQL CLOSE :sys_cursor;
        tpfree((char *)ptr_fml_obuf);
        tpfree((char *)ptr_fml_ibuf);
        return -1;
      }
      
			if(DEBUG_MSG_LVL_3)
      {
        fn_userlog(c_ServiceName,"SPAN  - d_undrlyng_pl Is :%lf:",d_undrlyng_pl);
        fn_userlog(c_ServiceName,"SPAN  - d_oblckd_amnt Is :%lf:",d_oblckd_amnt);
        fn_userlog(c_ServiceName,"SPAN  - st_undpstn_crrnt.d_initial_mrgn Is :%lf:",st_undpstn_crrnt.d_initial_mrgn);
        fn_userlog(c_ServiceName,"SPAN  - st_undpstn_tobe.d_reqd_initial_mrgn Is :%lf:",st_undpstn_tobe.d_reqd_initial_mrgn);
      }

      d_undrlyng_pl = d_oblckd_amnt + d_undrlyng_pl ;

      if( d_undrlyng_pl >= 0 )
      {
    		*d_total_diff = st_undpstn_crrnt.d_initial_mrgn - st_undpstn_tobe.d_reqd_initial_mrgn + d_undrlyng_pl;
      }
      else
      {
        *d_total_diff = st_undpstn_crrnt.d_initial_mrgn - st_undpstn_tobe.d_reqd_initial_mrgn ;
      }

      if(DEBUG_MSG_LVL_0)
      {
        fn_userlog(c_ServiceName,"SPAN  - d_undrlyng_pl Is :%lf:",d_undrlyng_pl);
        fn_userlog(c_ServiceName,"SPAN  - d_oblckd_amnt Is :%lf:",d_oblckd_amnt);
      }

		*d_total_pnl  = d_undrlyng_pl;
 
  	if(DEBUG_MSG_LVL_0)
  	{
    	fn_userlog ( c_ServiceName, "Difference in MRGN :%lf:", *d_total_diff );
  	}

    d_required_amt = 0.0 ;     ** Ver 1.4 ***

		if ( *d_total_diff < 0  )
    {
			d_balance_amt  = 0.0;  

      i_returncode = fn_upd_spnlimits( c_ServiceName,
                                    ptr_st_pstn_actn,
                                    ptr_st_err_msg,
                                    c_narration_id,
                                    c_dr_without_lmt_flg,
                                    *d_total_diff,
                                    &d_balance_amt);
      if ( i_returncode != 0 )
      {
				switch ( i_returncode )
        {
          case  INSUFFICIENT_LIMITS :

            fn_errlog( c_ServiceName, "B22003",DEFMSG , c_err_msg );
            EXEC SQL CLOSE :sys_cursor;
            tpfree((char *)ptr_fml_obuf);
            tpfree((char *)ptr_fml_ibuf);

            ****** Ver 1.4 Starts Here ******
            fn_userlog(c_ServiceName,"The Balance amount :%lf:",d_balance_amt);

            d_required_amt = *d_total_diff + d_balance_amt ;
            if( *d_total_pnl < 0 )
            {
             d_required_amt = d_required_amt + *d_total_pnl;
            }

            d_required_amt = ( (-1) * d_required_amt ) / 100 ;

            ****** Ver 1.4 ends Here *******

            return INSUFFICIENT_LIMITS  ;

         default:

            fn_errlog( c_ServiceName, "S31800",LIBMSG , c_err_msg );
            EXEC SQL CLOSE :sys_cursor;
            tpfree((char *)ptr_fml_obuf);
            tpfree((char *)ptr_fml_ibuf);
            return -1;
        }
      }
		}

		if ( *d_total_pnl < 0 )
    {
		 MEMSET(c_narration_id);	
     strcpy( c_narration_id , BLOCK_PNL_ON_ROLLOVER_ORDER_PLACEMENT );

			d_balance_amt  = 0.0; 

     	i_returncode = fn_upd_spnlimits(  c_ServiceName,
       	                            ptr_st_pstn_actn,
         	                          ptr_st_err_msg,
           	                        c_narration_id,
             	                      c_dr_without_lmt_flg,
               	                    *d_total_pnl,
                 	                  &d_balance_amt);
      	if ( i_returncode != 0 )
      	{
        	switch ( i_returncode )
        	{
          	  case  INSUFFICIENT_LIMITS :
	
								strcpy(c_err_msg,ptr_st_err_msg->c_err_msg);
    	          EXEC SQL CLOSE :sys_cursor;
      	        tpfree((char *)ptr_fml_obuf);
        	      tpfree((char *)ptr_fml_ibuf);

                **** Ver 1.4 Starts Here ****
                fn_userlog(c_ServiceName,"The Balance amount :%lf:",d_balance_amt);
                d_required_amt = *d_total_pnl + d_balance_amt ;
                d_required_amt = ( (-1) * d_required_amt ) / 100;
                **** Ver 1.4 Ends Here *****

          	    return INSUFFICIENT_LIMITS  ;

         			 default:

              	fn_errlog( c_ServiceName, "S31805",LIBMSG , c_err_msg );
              	EXEC SQL CLOSE :sys_cursor;
              	tpfree((char *)ptr_fml_obuf);
              	tpfree((char *)ptr_fml_ibuf);
              	return -1;
        	}
      	}

				if(DEBUG_MSG_LVL_3)
				{
					fn_userlog(c_ServiceName,"SPAN  - d_total_pnl :%lf:",*d_total_pnl);
      		fn_userlog(c_ServiceName,"SPAN  - d_balance_amt Is :%lf:",d_balance_amt);
				}
   	 	}
	
		if(DEBUG_MSG_LVL_3)
		{		
			fn_userlog(c_ServiceName,"SPAN  - d_total_pnl :%lf:",*d_total_pnl);
	  	fn_userlog(c_ServiceName, "End of function.");
		}

	tpfree((char *)ptr_fml_obuf);
  tpfree((char *)ptr_fml_ibuf);

	return 0;
		
}	

int fn_chk_nrml_mrgn (char *c_ServiceName,
                     struct vw_orderbook st_first_ordbk,
                     struct vw_orderbook st_next_ordbk,
										 double *d_total_diff,
										 double *d_total_pnl,
                     char *c_err_msg	 
                    )
{

	int i_returncode;
  int i_pos_avl = 0;

  double d_pl_amt;
  double d_diff_UTM;
  double d_diff_UOM;
  double d_diff_AMV;
  double d_total_diff_UTM = 0.0;
  double d_total_diff_UOM = 0.0;
  double d_total_diff_AMV = 0.0;
  double d_UTM_amt				=	0.0;
  double d_balance_amt		=	0.0;
  double d_bal_to_apply	 	=	0.0;
  double d_cntrct_pl   		= 0.0;
  double d_qty_pnl				= 0.0;			***	Ver 2.0	***
	double d_first_ltp 	 		= 0.0;
	double d_frst_ltp 	 		= 0.0;
	double d_next_ltp 	 		= 0.0;
	double d_nxt_ltp 		 		= 0.0;
	double d_org_opn_val 		= 0.0;
	double d_mtm_opn_val 		= 0.0;			***	Ver 2.0	***
	double d_base_rate	 		= 0.0;
	double d_mtm_base_rate	= 0.0;      ***  Ver 2.0 ***
	double d_opn_val_frst		= 0.0;
	double d_mtmopn_val_frst= 0.0;
	double d_opn_val_scnd		= 0.0;
	double d_mtmopn_val_scnd= 0.0;

	long int l_opnpstn_qty 	= 0;
	long int l_no_of_lot 		= 0;
	long int l_rem_qty	 		= 0;	
	long int l_frst_opn_qty	=	0;
	long int l_nxt_opn_qty	=	0;
	long int l_buy_exe_qty_frst  = 0;
	long int l_sell_exe_qty_frst = 0;
	long int l_opn_qty_frst			 = 0;
	long int l_buy_exe_qty_scnd  = 0;
	long int l_sell_exe_qty_scnd = 0;
	long int l_opn_qty_scnd			 = 0;
	long int l_pending_qty  = 0;          

  char c_narration_id [4];
  char c_dr_without_lmt_flg;
  char c_pos_avl;
  char c_mtm_flag;
	char c_cntrct_tag1;
	char c_cntrct_tag2;
	char c_frst_sgn;
	char c_nxt_sgn;
	char c_frst_opnpstn_flw='\0';
  char c_tmp_rmrks [ 133 ] ;
  char c_reason_cd [ 2000 ];

  *** Ver 1.4 ***
  double d_required_total_pnl = 0.0;
  double d_required_total_diff = 0.0;
  *** Ver 1.4 ***

  EXEC SQL BEGIN DECLARE SECTION;
    sql_cursor     sys_cursor;
    char  sql_cln_mtch_accnt[11];
    char  sql_xchng_cd[4];
    char  sql_prd_typ;
    char  sql_cntrct_tag;
    char  sql_undrlyng[7];
    varchar c_exp_dt[LEN_DATE];
    varchar c_trd_dt[12];
    double d_mrgn_blkd = 0.0;
    struct vw_undfut_pos st_undfut_pos_crrnt;
		struct vw_undfut_pos ptr_st_undfut_pos_to_be;
		struct vw_pstn_actn ptr_st_pstn_action;
		struct vw_err_msg ptr_st_err_msg;
  EXEC SQL END DECLARE SECTION;

  strcpy( sql_cln_mtch_accnt,st_first_ordbk.c_cln_mtch_accnt);
  strcpy( sql_xchng_cd,st_first_ordbk.c_xchng_cd);
  strcpy( sql_undrlyng,st_first_ordbk.c_undrlyng);
  sql_prd_typ = st_first_ordbk.c_prd_typ;

  FBFR32 *ptr_fml_ibuf;
  FBFR32 *ptr_fml_obuf;

	MEMSET(st_undfut_pos_crrnt);
	MEMSET(ptr_st_undfut_pos_to_be);
	MEMSET(ptr_st_pstn_action);

	if(DEBUG_MSG_LVL_5)
  {
    fn_userlog ( c_ServiceName, "Building new underlying position" );
    fn_userlog ( c_ServiceName, "st_first_ordbk.c_cln_mtch_accnt        |%s|",st_first_ordbk.c_cln_mtch_accnt );
    fn_userlog ( c_ServiceName, "st_first_ordbk.c_xchng_cd              |%s|",st_first_ordbk.c_xchng_cd );
    fn_userlog ( c_ServiceName, "st_first_ordbk.c_undrlyng              |%s|",st_first_ordbk.c_undrlyng );
    fn_userlog ( c_ServiceName, "st_first_ordbk.c_expry_dt              |%s|",st_first_ordbk.c_expry_dt );
    fn_userlog ( c_ServiceName, "st_first_ordbk.c_prd_typ               |%c|",st_first_ordbk.c_prd_typ );
    fn_userlog ( c_ServiceName, "st_first_ordbk.c_ordr_flw              |%c|",st_first_ordbk.c_ordr_flw );
    fn_userlog ( c_ServiceName, "st_first_ordbk.l_ord_tot_qty           |%ld|",st_first_ordbk.l_ord_tot_qty );
    fn_userlog ( c_ServiceName, "st_next_ordbk.c_cln_mtch_accnt         |%s|",st_next_ordbk.c_cln_mtch_accnt );
    fn_userlog ( c_ServiceName, "st_next_ordbk.c_xchng_cd               |%s|",st_next_ordbk.c_xchng_cd );
    fn_userlog ( c_ServiceName, "st_next_ordbk.c_undrlyng               |%s|",st_next_ordbk.c_undrlyng );
    fn_userlog ( c_ServiceName, "st_next_ordbk.c_expry_dt               |%s|",st_next_ordbk.c_expry_dt );
    fn_userlog ( c_ServiceName, "st_next_ordbk.c_prd_typ                |%c|",st_next_ordbk.c_prd_typ );
    fn_userlog ( c_ServiceName, "st_next_ordbk.c_exrc_typ               |%c|",st_next_ordbk.c_exrc_typ );
  }

	*** Commented in Ver 2.3  ***

	EXEC SQL
        SELECT  FCM_CNTRCT_TAG
        INTO    :c_cntrct_tag1
        FROM    FCM_FO_CNTRCT_MSTR
        WHERE   FCM_XCHNG_CD        = :st_first_ordbk.c_xchng_cd
        AND     FCM_PRDCT_TYP       = :st_first_ordbk.c_prd_typ
        AND     FCM_UNDRLYNG        = :st_first_ordbk.c_undrlyng
        AND     FCM_EXPRY_DT        = to_date( :st_first_ordbk.c_expry_dt, 'dd-mon-yyyy' )
        AND     FCM_EXER_TYP        = :st_first_ordbk.c_exrc_typ;

    if ( SQLCODE != 0 )
    {
      fn_errlog ( c_ServiceName, "S31810", SQLMSG, c_err_msg );
      return FAILURE;
    }

    EXEC SQL
        SELECT  FCM_CNTRCT_TAG
        INTO    :c_cntrct_tag2
        FROM    FCM_FO_CNTRCT_MSTR
        WHERE   FCM_XCHNG_CD        = :st_next_ordbk.c_xchng_cd
        AND     FCM_PRDCT_TYP       = :st_next_ordbk.c_prd_typ
        AND     FCM_UNDRLYNG        = :st_next_ordbk.c_undrlyng
        AND     FCM_EXPRY_DT        = to_date( :st_next_ordbk.c_expry_dt, 'dd-mon-yyyy' )
        AND     FCM_EXER_TYP        = :st_next_ordbk.c_exrc_typ;

    if ( SQLCODE != 0 )
    {
      fn_errlog ( c_ServiceName, "S31815", SQLMSG, c_err_msg );
      return FAILURE;
    }

    if(DEBUG_MSG_LVL_5)
    {
      fn_userlog ( c_ServiceName, "c_cntrct_tag1 |%c|",c_cntrct_tag1 );
      fn_userlog ( c_ServiceName, "c_cntrct_tag2 |%c|",c_cntrct_tag2 );
    }	

	*** Ver 2.3 Comment Ends ***

		EXEC SQL
      SELECT FFP_OPNPSTN_QTY,
             FFP_OPNPSTN_VAL,
						 FFP_OPNPSTN_FLW,
						 DECODE(:st_first_ordbk.c_ordr_flw,'B',GREATEST(ABS(FFP_IBUY_QTY),ABS(FFP_EXBUY_QTY)),GREATEST(ABS(FFP_ISELL_QTY),ABS(FFP_EXSELL_QTY))),
						 FFP_MTM_OPN_VAL			***	Ver 2.0	***
      INTO  :l_opnpstn_qty,
            :d_org_opn_val,
						:c_frst_opnpstn_flw,
						:l_pending_qty,
						:d_mtm_opn_val				***  Ver 2.0 ***
      FROM FFP_FO_FUTURES_PSTN
      WHERE FFP_CLM_MTCH_ACCNT    = :st_first_ordbk.c_cln_mtch_accnt
      AND     FFP_XCHNG_CD        = :st_first_ordbk.c_xchng_cd
      AND     FFP_PRDCT_TYP       = :st_first_ordbk.c_prd_typ
      AND     FFP_UNDRLYNG        = :st_first_ordbk.c_undrlyng
      AND     FFP_EXPRY_DT        = :st_first_ordbk.c_expry_dt
      AND     FFP_EXER_TYP        = :st_first_ordbk.c_exrc_typ;

      if(SQLCODE  !=  0 )
      {
        fn_errlog ( c_ServiceName, "S31820", SQLMSG, c_err_msg );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        return FAILURE;
      }

			if ( labs(l_opnpstn_qty) < ( labs(st_first_ordbk.l_ord_tot_qty) + labs(l_pending_qty) ))
   		{
      	fn_userlog ( c_ServiceName, "Rollover quantity greater than open position quantity.");
      	strcpy(c_err_msg,"Rollover quantity can not be greater than open position quantity.");
      	return -1;
   		}

  	EXEC SQL
     SELECT  FTQ_LST_TRD_PRC,
						 FTQ_CNTRCT_TAG                    *** Added in Ver 2.3 ***
        INTO    :d_first_ltp,    
								:c_cntrct_tag1                 *** Added in Ver 2.3 ***
        FROM    FTQ_FO_TRD_QT
        WHERE   FTQ_XCHNG_CD  = :st_first_ordbk.c_xchng_cd
        AND     FTQ_PRDCT_TYP = :st_first_ordbk.c_prd_typ
        AND     FTQ_UNDRLYNG  = :st_first_ordbk.c_undrlyng
        AND     FTQ_EXPRY_DT  = :st_first_ordbk.c_expry_dt
        AND     FTQ_EXER_TYP  = :st_first_ordbk.c_exrc_typ;
	
			if(SQLCODE  !=  0 )
      {
        fn_errlog ( c_ServiceName, "S31825", SQLMSG, c_err_msg );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        return FAILURE;
      }

		EXEC SQL
     SELECT  FTQ_LST_TRD_PRC,
						 FTQ_CNTRCT_TAG  								*** Added in Ver 2.3 ***
        INTO    :d_next_ltp,
								:c_cntrct_tag2              *** Added in Ver 2.3 ***
        FROM    FTQ_FO_TRD_QT
        WHERE   FTQ_XCHNG_CD  = :st_next_ordbk.c_xchng_cd
        AND     FTQ_PRDCT_TYP = :st_next_ordbk.c_prd_typ
        AND     FTQ_UNDRLYNG  = :st_next_ordbk.c_undrlyng
        AND     FTQ_EXPRY_DT  = :st_next_ordbk.c_expry_dt
        AND     FTQ_EXER_TYP  = :st_next_ordbk.c_exrc_typ;

      if(SQLCODE  !=  0 )
      {
        fn_errlog ( c_ServiceName, "S31830", SQLMSG, c_err_msg );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        return FAILURE;
      }

      if( DEBUG_MSG_LVL_3 )
      {
        fn_userlog ( c_ServiceName, " d_first_ltp                   |%lf|",d_first_ltp);
        fn_userlog ( c_ServiceName, " d_next_ltp                    |%lf|",d_next_ltp);
        fn_userlog ( c_ServiceName, " st_first_ordbk.l_ord_tot_qty  |%ld|",st_first_ordbk.l_ord_tot_qty);
				fn_userlog ( c_ServiceName, "c_cntrct_tag1 |%c|",c_cntrct_tag1 ); *** Added in Ver 2.3 ***
        fn_userlog ( c_ServiceName, "c_cntrct_tag2 |%c|",c_cntrct_tag2 ); *** Added in Ver 2.3 ***
      }

			if (st_first_ordbk.c_slm_flg == 'M')
			{
				st_first_ordbk.l_ord_lmt_rt = d_first_ltp;		
			}
			
			if (st_next_ordbk.c_slm_flg == 'M')
			{
				st_next_ordbk.l_ord_lmt_rt = d_next_ltp;		
			}

     if( l_opnpstn_qty  > 0 )
      {
				*** Commented in Ver 2.0 ***

         d_cntrct_pl = ( d_first_ltp * (double) l_opnpstn_qty ) - d_org_opn_val; 

				*******************
 
         d_cntrct_pl = ( d_first_ltp * (double) l_opnpstn_qty ) - d_mtm_opn_val;	*** Ver 2.0 *** 	
      }
      else if ( l_opnpstn_qty < 0 )
      {
				*** Commented in Ver 2.0 ***

         d_cntrct_pl = fabs(d_org_opn_val) - (d_first_ltp * (double)abs(l_opnpstn_qty));

 				*******************

         d_cntrct_pl = fabs(d_mtm_opn_val) - (d_first_ltp * (double)abs(l_opnpstn_qty)); *** Ver 2.0 ***
      }

      if( DEBUG_MSG_LVL_3 )
      {
        fn_userlog(c_ServiceName,"Contract Level PNL  |%lf|",d_cntrct_pl);
        fn_userlog(c_ServiceName,"Exchange code is |%s|",ptr_st_pstn_action.c_xchng_cd);
      }
		
		***	Commented In Ver 2.0

    l_no_of_lot = abs(l_opnpstn_qty) / st_first_ordbk.l_ord_tot_qty;

    d_cntrct_pl = d_cntrct_pl / l_no_of_lot;

		***********************

		***	Added in Ver 2.0 Calculating PNL/Quantity and then multiplying by total rollover qty for notional PNL	***

		d_qty_pnl		=	d_cntrct_pl	/	(double)(abs(l_opnpstn_qty));

		d_cntrct_pl	=	d_qty_pnl	*	st_first_ordbk.l_ord_tot_qty;


		***	Ver 2.0	Ends	***
		

    if( DEBUG_MSG_LVL_3 )
    {
       fn_userlog(c_ServiceName,"Quantity Level PNL  |%lf|",d_qty_pnl);			***	Ver 2.0	***
       fn_userlog(c_ServiceName,"Order Level PNL  |%lf|",d_cntrct_pl);
       ***fn_userlog(c_ServiceName," number of lot is |%ld|",l_no_of_lot);	Commented In Ver 2.0	***
    }

		if ( c_frst_opnpstn_flw == 'S' ) 
		{
			l_rem_qty	=	l_opnpstn_qty + st_first_ordbk.l_ord_tot_qty;
		}
		else
		{
			l_rem_qty   = l_opnpstn_qty - st_first_ordbk.l_ord_tot_qty;
		}

    d_base_rate = d_org_opn_val / (double)l_opnpstn_qty;
    d_mtm_base_rate = d_mtm_opn_val / (double)l_opnpstn_qty;   **** Ver 2.0 ***

		if(DEBUG_MSG_LVL_3)
    {
			fn_userlog(c_ServiceName,"l_rem_qty is :%ld:",l_rem_qty);
			fn_userlog(c_ServiceName,"d_base_rate d_base_rate is :%lf:",d_base_rate);
			fn_userlog(c_ServiceName,"d_mtm_base_rate d_mtm_base_rate is :%lf:",d_mtm_base_rate);
		}

    EXEC SQL
      UPDATE  FFP_FO_FUTURES_PSTN
      SET FFP_BUY_EXCTD_QTY = DECODE(:st_first_ordbk.c_ordr_flw,'B',FFP_BUY_EXCTD_QTY + :st_first_ordbk.l_ord_tot_qty,FFP_BUY_EXCTD_QTY + 0),
          FFP_SELL_EXCTD_QTY= DECODE(:st_first_ordbk.c_ordr_flw,'S',FFP_SELL_EXCTD_QTY + :st_first_ordbk.l_ord_tot_qty * -1 ,FFP_SELL_EXCTD_QTY + 0),
			FFP_OPNPSTN_QTY = FFP_OPNPSTN_QTY + DECODE(:st_first_ordbk.c_ordr_flw,'S',(:st_first_ordbk.l_ord_tot_qty * -1),:st_first_ordbk.l_ord_tot_qty),
			FFP_OPNPSTN_VAL = :l_rem_qty * :d_base_rate,
 *** FFP_MTM_OPN_VAL = :l_rem_qty * :d_base_rate     ****   Comment In Ver 2.0 ***
			FFP_MTM_OPN_VAL = :l_rem_qty * :d_mtm_base_rate     *** Ver 2.0 ***
      WHERE FFP_CLM_MTCH_ACCNT    = :st_first_ordbk.c_cln_mtch_accnt
      AND     FFP_XCHNG_CD        = :st_first_ordbk.c_xchng_cd
      AND     FFP_PRDCT_TYP       = :st_first_ordbk.c_prd_typ
      AND     FFP_UNDRLYNG        = :st_first_ordbk.c_undrlyng
      AND     FFP_EXPRY_DT        = :st_first_ordbk.c_expry_dt
      AND     FFP_EXER_TYP        = :st_first_ordbk.c_exrc_typ;

      if ( SQLCODE != 0 )
      {
        fn_errlog( c_ServiceName, "S31835",FMLMSG,c_err_msg);
        return -1;
      }

    EXEC SQL
      SELECT 1
      INTO  :i_pos_avl
      FROM  FFP_FO_FUTURES_PSTN
      WHERE FFP_CLM_MTCH_ACCNT    = :st_next_ordbk.c_cln_mtch_accnt
      AND     FFP_XCHNG_CD        = :st_next_ordbk.c_xchng_cd
      AND     FFP_PRDCT_TYP       = :st_next_ordbk.c_prd_typ
      AND     FFP_UNDRLYNG        = :st_next_ordbk.c_undrlyng
      AND     FFP_EXPRY_DT        = :st_next_ordbk.c_expry_dt
      AND     FFP_EXER_TYP        = :st_next_ordbk.c_exrc_typ;

      if ( SQLCODE != 0 && SQLCODE != NO_DATA_FOUND )
      {
        fn_errlog( c_ServiceName, "S31840",SQLMSG,c_err_msg);
        return -1;
      }
			
		if ( i_pos_avl == 1 )
    {

    EXEC SQL
      UPDATE  FFP_FO_FUTURES_PSTN
      SET   FFP_BUY_EXCTD_QTY     = DECODE (:st_next_ordbk.c_ordr_flw ,'B',FFP_BUY_EXCTD_QTY + :st_next_ordbk.l_ord_tot_qty,
                                            FFP_BUY_EXCTD_QTY + 0),
            FFP_SELL_EXCTD_QTY    = DECODE (:st_next_ordbk.c_ordr_flw ,'S',FFP_SELL_EXCTD_QTY + :st_next_ordbk.l_ord_tot_qty,
                                            FFP_SELL_EXCTD_QTY + 0),
						FFP_OPNPSTN_QTY 			= FFP_OPNPSTN_QTY + DECODE(:st_next_ordbk.c_ordr_flw,'S',(:st_next_ordbk.l_ord_tot_qty * -1),:st_next_ordbk.l_ord_tot_qty),
						FFP_OPNPSTN_VAL       = FFP_OPNPSTN_VAL + (:st_next_ordbk.l_ord_lmt_rt * DECODE (:st_next_ordbk.c_ordr_flw ,'S',:st_next_ordbk.l_ord_tot_qty * (-1),:st_next_ordbk.l_ord_tot_qty)),
						FFP_MTM_OPN_VAL				= FFP_MTM_OPN_VAL + (:st_next_ordbk.l_ord_lmt_rt * DECODE (:st_next_ordbk.c_ordr_flw ,'S',:st_next_ordbk.l_ord_tot_qty * (-1),:st_next_ordbk.l_ord_tot_qty))   
      WHERE FFP_CLM_MTCH_ACCNT    = :st_next_ordbk.c_cln_mtch_accnt
      AND     FFP_XCHNG_CD        = :st_next_ordbk.c_xchng_cd
      AND     FFP_PRDCT_TYP       = :st_next_ordbk.c_prd_typ
      AND     FFP_UNDRLYNG        = :st_next_ordbk.c_undrlyng
      AND     FFP_EXPRY_DT        = :st_next_ordbk.c_expry_dt
      AND     FFP_EXER_TYP        = :st_next_ordbk.c_exrc_typ;

      if ( SQLCODE != 0 )
      {
        fn_errlog(c_ServiceName, "S31845", SQLMSG, c_err_msg );
        return -1;
      }

    }
    else
    {


    EXEC SQL
      INSERT INTO FFP_FO_FUTURES_PSTN
      (
        FFP_CLM_MTCH_ACCNT,
        FFP_XCHNG_CD,
        FFP_PRDCT_TYP,
        FFP_INDSTK,
        FFP_UNDRLYNG,
        FFP_EXPRY_DT,
        FFP_EXER_TYP,
				FFP_CNTRCT_TAG,
        FFP_BUY_EXCTD_QTY,
        FFP_SELL_EXCTD_QTY,
        FFP_OPNPSTN_FLW,
				FFP_OPNPSTN_QTY,
				FFP_OPNPSTN_VAL,
				FFP_MTM_OPN_VAL
      )
      VALUES
      (
        :st_next_ordbk.c_cln_mtch_accnt,
        :st_next_ordbk.c_xchng_cd,
        :st_next_ordbk.c_prd_typ,
        :st_next_ordbk.c_ctgry_indstk,
        :st_next_ordbk.c_undrlyng,
        to_date(:st_next_ordbk.c_expry_dt,'DD-Mon-YYYY'),
        :st_next_ordbk.c_exrc_typ,
				:c_cntrct_tag2,
        DECODE (:st_next_ordbk.c_ordr_flw ,'B',:st_next_ordbk.l_ord_tot_qty, 0),
        DECODE (:st_next_ordbk.c_ordr_flw ,'S',:st_next_ordbk.l_ord_tot_qty * (-1), 0),
				:st_next_ordbk.c_ordr_flw,
				DECODE (:st_next_ordbk.c_ordr_flw ,'S',(:st_next_ordbk.l_ord_tot_qty * -1 ),:st_next_ordbk.l_ord_tot_qty),
				DECODE (:st_next_ordbk.c_ordr_flw ,'S',(:st_next_ordbk.l_ord_lmt_rt * :st_next_ordbk.l_ord_tot_qty * -1),:st_next_ordbk.l_ord_lmt_rt * :st_next_ordbk.l_ord_tot_qty),
 				DECODE(:st_next_ordbk.c_ordr_flw ,'S',(:st_next_ordbk.l_ord_lmt_rt * :st_next_ordbk.l_ord_tot_qty * -1), :st_next_ordbk.l_ord_lmt_rt * :st_next_ordbk.l_ord_tot_qty)
      );

      if ( SQLCODE != 0 )
      {
        fn_errlog(c_ServiceName, "S31850", SQLMSG, c_err_msg );
        return -1;
      }
		}	

		EXEC SQL
      SELECT SUM(FFP_BUY_EXCTD_QTY),
						 SUM(FFP_SELL_EXCTD_QTY),
						 SUM(FFP_OPNPSTN_QTY),
						 SUM(FFP_OPNPSTN_VAL),
             SUM(FFP_MTM_OPN_VAL)
      INTO   :l_buy_exe_qty_frst,
						 :l_sell_exe_qty_frst,
						 :l_opn_qty_frst,
						 :d_opn_val_frst,
             :d_mtmopn_val_frst
      FROM   FFP_FO_FUTURES_PSTN
      WHERE FFP_CLM_MTCH_ACCNT    = :st_first_ordbk.c_cln_mtch_accnt
      AND     FFP_XCHNG_CD        = :st_first_ordbk.c_xchng_cd
      AND     FFP_PRDCT_TYP       = :st_first_ordbk.c_prd_typ
      AND     FFP_UNDRLYNG        = :st_first_ordbk.c_undrlyng
			AND			FFP_CNTRCT_TAG		  = :c_cntrct_tag1 
      AND     FFP_EXER_TYP        = :st_first_ordbk.c_exrc_typ;

    if ( SQLCODE != 0 )
    {
      fn_errlog(c_ServiceName, "S31855", SQLMSG, c_err_msg );
      return -1;
    }

		
		EXEC SQL
      SELECT SUM(FFP_BUY_EXCTD_QTY),
						 SUM(FFP_SELL_EXCTD_QTY),
						 SUM(FFP_OPNPSTN_QTY),
						 SUM(FFP_OPNPSTN_VAL),
             SUM(FFP_MTM_OPN_VAL)
      INTO   :l_buy_exe_qty_scnd,
						 :l_sell_exe_qty_scnd,
						 :l_opn_qty_scnd,
						 :d_opn_val_scnd,
             :d_mtmopn_val_scnd
      FROM   FFP_FO_FUTURES_PSTN
      WHERE FFP_CLM_MTCH_ACCNT    = :st_next_ordbk.c_cln_mtch_accnt
      AND     FFP_XCHNG_CD        = :st_next_ordbk.c_xchng_cd
      AND     FFP_PRDCT_TYP       = :st_next_ordbk.c_prd_typ
      AND     FFP_UNDRLYNG        = :st_next_ordbk.c_undrlyng
			AND			FFP_CNTRCT_TAG		  = :c_cntrct_tag2 
      AND     FFP_EXER_TYP        = :st_next_ordbk.c_exrc_typ;

    if ( SQLCODE != 0 )
    {
      fn_errlog(c_ServiceName, "S31860", SQLMSG, c_err_msg );
      return -1;
    }

		EXEC SQL
      UPDATE  FUP_FUT_UNDRLYNG_PSTN
      SET FUP_UBUY_EXCTD_QTY  = :l_buy_exe_qty_frst, 
          FUP_USELL_EXCTD_QTY = :l_sell_exe_qty_frst,
					FUP_UOPNPSTN_QTY	  =	:l_opn_qty_frst,
					FUP_UOPNPSTN_VAL	  = :d_opn_val_frst,
					FUP_UMTM_OPN_VAL	  =	:d_mtmopn_val_frst
      WHERE FUP_CLM_MTCH_ACCNT    = :st_first_ordbk.c_cln_mtch_accnt
      AND     FUP_XCHNG_CD        = :st_first_ordbk.c_xchng_cd
      AND     FUP_PRDCT_TYP       = :st_first_ordbk.c_prd_typ
      AND     FUP_UNDRLYNG        = :st_first_ordbk.c_undrlyng
      AND     FUP_CNTRCT_TAG      = :c_cntrct_tag1;

      if ( SQLCODE != 0 )
      {
        fn_errlog( c_ServiceName, "S31865",SQLMSG,c_err_msg);
        return -1;
      }

    EXEC SQL
      SELECT 1
      INTO  :i_pos_avl
      FROM  FUP_FUT_UNDRLYNG_PSTN
      WHERE FUP_CLM_MTCH_ACCNT    = :st_next_ordbk.c_cln_mtch_accnt
      AND     FUP_XCHNG_CD        = :st_next_ordbk.c_xchng_cd
      AND     FUP_PRDCT_TYP       = :st_next_ordbk.c_prd_typ
      AND     FUP_UNDRLYNG        = :st_next_ordbk.c_undrlyng
      AND     FUP_CNTRCT_TAG      = :c_cntrct_tag2;

      if ( SQLCODE != 0 && SQLCODE != NO_DATA_FOUND )
      {
        fn_errlog( c_ServiceName, "S31870",FMLMSG,c_err_msg);
        return -1;
      }

		if ( i_pos_avl == 1 )
    {

    EXEC SQL
      UPDATE  FUP_FUT_UNDRLYNG_PSTN
      SET   FUP_UBUY_EXCTD_QTY     = :l_buy_exe_qty_scnd, 
            FUP_USELL_EXCTD_QTY    = :l_sell_exe_qty_scnd,
						FUP_UOPNPSTN_QTY			 = :l_opn_qty_scnd,
						FUP_UOPNPSTN_VAL			 = :d_opn_val_scnd, 
						FUP_UMTM_OPN_VAL			 = :d_mtmopn_val_scnd
      WHERE FUP_CLM_MTCH_ACCNT    = :st_next_ordbk.c_cln_mtch_accnt
      AND     FUP_XCHNG_CD        = :st_next_ordbk.c_xchng_cd
      AND     FUP_PRDCT_TYP       = :st_next_ordbk.c_prd_typ
      AND     FUP_UNDRLYNG        = :st_next_ordbk.c_undrlyng
      AND     FUP_CNTRCT_TAG      = :c_cntrct_tag2;

      if ( SQLCODE != 0 )
      {
        fn_errlog(c_ServiceName, "S31875", SQLMSG, c_err_msg );
        return -1;
      }

    }
    else
    {
			if(DEBUG_MSG_LVL_5)
    	{
				fn_userlog(c_ServiceName,"ROLLOVER st_next_ordbk.c_cln_mtch_accnt Is :%s:",st_next_ordbk.c_cln_mtch_accnt);
				fn_userlog(c_ServiceName,"ROLLOVER	st_next_ordbk.c_xchng_cd Is :%s:",st_next_ordbk.c_xchng_cd);
				fn_userlog(c_ServiceName,"ROLLOVER st_next_ordbk.c_prd_typ Is :%c:",st_next_ordbk.c_prd_typ);
				fn_userlog(c_ServiceName,"ROLLOVER st_next_ordbk.c_ctgry_indstk Is :%c:",st_next_ordbk.c_ctgry_indstk);
				fn_userlog(c_ServiceName,"ROLLOVER st_next_ordbk.c_undrlyng Is :%s:",st_next_ordbk.c_undrlyng);
				fn_userlog(c_ServiceName,"ROLLOVER st_next_ordbk.c_ordr_flw Is :%c:",st_next_ordbk.c_ordr_flw);
				fn_userlog(c_ServiceName,"ROLLOVER st_next_ordbk.l_ord_tot_qty Is :%ld:",st_next_ordbk.l_ord_tot_qty);
			}

    EXEC SQL
      INSERT INTO FUP_FUT_UNDRLYNG_PSTN
      (
        FUP_CLM_MTCH_ACCNT,
        FUP_XCHNG_CD,
        FUP_PRDCT_TYP,
        FUP_INDSTK,
        FUP_UNDRLYNG,
        FUP_UBUY_EXCTD_QTY,
        FUP_USELL_EXCTD_QTY,
				FUP_UOPNPSTN_QTY,
        FUP_UOPNPSTN_FLW,
				FUP_UOPNPSTN_VAL,
				FUP_UMTM_OPN_VAL,
				FUP_CNTRCT_TAG
      )
      VALUES
      (
        :st_next_ordbk.c_cln_mtch_accnt,
        :st_next_ordbk.c_xchng_cd,
        :st_next_ordbk.c_prd_typ,
        :st_next_ordbk.c_ctgry_indstk,
        :st_next_ordbk.c_undrlyng,
				:l_buy_exe_qty_scnd,
				:l_sell_exe_qty_scnd,
				:l_opn_qty_scnd,
        :st_next_ordbk.c_ordr_flw,
				:d_opn_val_scnd,
				:d_mtmopn_val_scnd,
				:c_cntrct_tag2
      );
			
			if ( SQLCODE != 0 )
      {
        fn_errlog(c_ServiceName, "S31880", SQLMSG, c_err_msg );
        return -1;
      }
    }

		if ( c_cntrct_tag1	==	c_cntrct_tag2 )
		{
			EXEC SQL
				SELECT	FFP_OPNPSTN_QTY
				INTO		:l_frst_opn_qty
				FROM		FFP_FO_FUTURES_PSTN
				WHERE		FFP_CLM_MTCH_ACCNT	=	:st_first_ordbk.c_cln_mtch_accnt	
			  AND			FFP_XCHNG_CD				= :st_first_ordbk.c_xchng_cd						
				AND			FFP_PRDCT_TYP				= :st_first_ordbk.c_prd_typ
				AND			FFP_UNDRLYNG				= :st_first_ordbk.c_undrlyng
				AND			FFP_EXPRY_DT				= :st_first_ordbk.c_expry_dt
				AND			FFP_CNTRCT_TAG			= :c_cntrct_tag1;
			
			if ( SQLCODE != 0 )
      {
        fn_errlog(c_ServiceName, "S31885", SQLMSG, c_err_msg );
        return -1;
      }

			if ( l_frst_opn_qty > 0 )
			{
				c_frst_sgn	=	'+';
			}
			else
			{
				c_frst_sgn	=	'-';
			}

			EXEC SQL
        SELECT  FFP_OPNPSTN_QTY
        INTO    :l_nxt_opn_qty
        FROM    FFP_FO_FUTURES_PSTN
        WHERE   FFP_CLM_MTCH_ACCNT  =	:st_next_ordbk.c_cln_mtch_accnt
        AND     FFP_XCHNG_CD        =	:st_next_ordbk.c_xchng_cd
        AND     FFP_PRDCT_TYP       = :st_next_ordbk.c_prd_typ
        AND     FFP_UNDRLYNG        = :st_next_ordbk.c_undrlyng
        AND     FFP_EXPRY_DT        = :st_next_ordbk.c_expry_dt
        AND     FFP_CNTRCT_TAG      = :c_cntrct_tag2;

			if ( SQLCODE != 0 )
      {
        fn_errlog(c_ServiceName, "S31890", SQLMSG, c_err_msg );
        return -1;
      }

			if ( l_nxt_opn_qty > 0 )
			{
				c_nxt_sgn	=	'+';
			}
			else
			{
				c_nxt_sgn	=	'-';
			}
		
		}

		EXEC SQL ALLOCATE :sys_cursor;

    EXEC SQL EXECUTE
      BEGIN
      OPEN :sys_cursor FOR
    SELECT  FUP_CLM_MTCH_ACCNT,
            FUP_XCHNG_CD,
            FUP_PRDCT_TYP,
            FUP_INDSTK,
            FUP_UNDRLYNG,
            FUP_CNTRCT_TAG,
            FUP_UIBUY_QTY,
            FUP_UIBUY_VAL,
            FUP_UISELL_QTY,
            FUP_UISELL_VAL,
            FUP_UEXBUY_QTY,
            FUP_UEXBUY_VAL,
            FUP_UEXSELL_QTY,
            FUP_UEXSELL_VAL,
            FUP_UBUY_EXCTD_QTY,
            FUP_USELL_EXCTD_QTY,
            FUP_UOPNPSTN_FLW,
            FUP_UOPNPSTN_QTY,
            FUP_UOPNPSTN_VAL,
            FUP_UMTM_OPN_VAL,
            FUP_ADD_MRGN_VAL,
            FUP_UORDR_MRGN,
            FUP_UEXCTD_MRGN,
            FUP_USPREAD_MRGN,
            FUP_USPREAD_PNL,
            FUP_UTRD_MRGN,
            NVL(FUP_MTM_FLG,'O'),
            NVL(FUP_UMIN_TRD_MRGN,0)
    FROM    FUP_FUT_UNDRLYNG_PSTN
    WHERE FUP_CLM_MTCH_ACCNT  = :sql_cln_mtch_accnt
    AND   FUP_XCHNG_CD        = :sql_xchng_cd
    AND   FUP_PRDCT_TYP       = :sql_prd_typ
    AND   FUP_UNDRLYNG        = :sql_undrlyng;

	END;
      END-EXEC;
	
  if ( ( SQLCODE != 0 ) && ( SQLCODE != NO_DATA_FOUND ) )
  {
    fn_errlog ( c_ServiceName, "S31895", SQLMSG, c_err_msg );
		return -1;
  }

	if(DEBUG_MSG_LVL_3)
  {
    fn_userlog ( c_ServiceName, "Building new underlying position" );
  }

  c_pos_avl = 'N';

	while ( 1 )
  {
			d_diff_UTM = 0.0;
			d_diff_UOM = 0.0;	
			d_diff_AMV = 0.0;
			st_undfut_pos_crrnt.l_ibuy_qty		 = 0;
			st_undfut_pos_crrnt.d_ibuy_ord_vl	 = 0.0;
			st_undfut_pos_crrnt.l_isell_qty		 = 0;	
			st_undfut_pos_crrnt.d_isell_ord_vl = 0.0;
			st_undfut_pos_crrnt.l_exbuy_qty		 = 0;
			st_undfut_pos_crrnt.d_exbuy_ord_vl = 0.0;
			st_undfut_pos_crrnt.l_exsell_qty	 = 0;
			st_undfut_pos_crrnt.d_exsell_ord_vl= 0.0;
			st_undfut_pos_crrnt.d_org_opn_val  = 0.0;
			st_undfut_pos_crrnt.d_mtm_opn_val  = 0.0;	
			st_undfut_pos_crrnt.d_add_mrgn_val = 0.0;
		  st_undfut_pos_crrnt.d_ordr_mrgn    = 0.0;
			st_undfut_pos_crrnt.d_exctd_mrgn   = 0.0;
			st_undfut_pos_crrnt.d_sprd_mrgn    = 0.0;
			st_undfut_pos_crrnt.d_sprd_pl			 = 0.0;
			st_undfut_pos_crrnt.d_trd_mrgn		 = 0.0;
			st_undfut_pos_crrnt.d_mm_trd_mrgn	 = 0.0;		


      EXEC SQL  
			FETCH :sys_cursor
      INTO  :st_undfut_pos_crrnt.c_cln_mtch_accnt,
            :st_undfut_pos_crrnt.c_xchng_cd,
            :st_undfut_pos_crrnt.c_prd_typ,
            :st_undfut_pos_crrnt.c_ctgry_indstk,
            :st_undfut_pos_crrnt.c_undrlyng,
            :st_undfut_pos_crrnt.c_cntrct_tag,
            :st_undfut_pos_crrnt.l_ibuy_qty,
            :st_undfut_pos_crrnt.d_ibuy_ord_vl,
            :st_undfut_pos_crrnt.l_isell_qty,
            :st_undfut_pos_crrnt.d_isell_ord_vl,
            :st_undfut_pos_crrnt.l_exbuy_qty,
            :st_undfut_pos_crrnt.d_exbuy_ord_vl,
            :st_undfut_pos_crrnt.l_exsell_qty,
            :st_undfut_pos_crrnt.d_exsell_ord_vl,
            :st_undfut_pos_crrnt.l_buy_exctd_qty,
            :st_undfut_pos_crrnt.l_sell_exctd_qty,
            :st_undfut_pos_crrnt.c_opnpstn_flw,
            :st_undfut_pos_crrnt.l_opnpstn_qty,
            :st_undfut_pos_crrnt.d_org_opn_val,
            :st_undfut_pos_crrnt.d_mtm_opn_val,
            :st_undfut_pos_crrnt.d_add_mrgn_val,
            :st_undfut_pos_crrnt.d_ordr_mrgn,
            :st_undfut_pos_crrnt.d_exctd_mrgn,
            :st_undfut_pos_crrnt.d_sprd_mrgn,
            :st_undfut_pos_crrnt.d_sprd_pl,
            :st_undfut_pos_crrnt.d_trd_mrgn,
            :c_mtm_flag,
            :st_undfut_pos_crrnt.d_mm_trd_mrgn; 

      if ( SQLCODE != 0 )
      {
        if ( SQLCODE == NO_DATA_FOUND )
        {
          break;
        }

        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        fn_errlog ( c_ServiceName, "S31900", SQLMSG, c_err_msg );
        return FAILURE;
      }

			memcpy(&ptr_st_undfut_pos_to_be,&st_undfut_pos_crrnt,sizeof(st_undfut_pos_crrnt));

			if ( c_frst_sgn != c_nxt_sgn )
			{
				ptr_st_undfut_pos_to_be.l_opn_buyqty	= l_frst_opn_qty;
				ptr_st_undfut_pos_to_be.l_opn_sellqty	= l_nxt_opn_qty;
			}

			strcpy( ptr_st_pstn_action.c_cln_mtch_accnt,st_undfut_pos_crrnt.c_cln_mtch_accnt);
      strcpy( ptr_st_pstn_action.c_xchng_cd,st_undfut_pos_crrnt.c_xchng_cd);
      strcpy( ptr_st_pstn_action.c_undrlyng,st_undfut_pos_crrnt.c_undrlyng);
      ptr_st_pstn_action.c_prd_typ  =st_undfut_pos_crrnt.c_prd_typ;
      ptr_st_pstn_action.c_ctgry_indstk  =st_undfut_pos_crrnt.c_ctgry_indstk;
      ptr_st_pstn_action.c_cntrct_tag = st_undfut_pos_crrnt.c_cntrct_tag;
	
			
			if(DEBUG_MSG_LVL_3)
  		{
				fn_userlog(c_ServiceName," Exchange code is |%s|",ptr_st_pstn_action.c_xchng_cd);
    		fn_userlog ( c_ServiceName, "Calcualted underlying level position" );
				fn_userlog(c_ServiceName, "ptr_st_undfut_pos_to_be.c_cln_mtch_accnt|%s|",ptr_st_undfut_pos_to_be.c_cln_mtch_accnt);
				fn_userlog ( c_ServiceName, "ptr_st_undfut_pos_to_be.c_xchng_cd    |%s|",ptr_st_undfut_pos_to_be.c_xchng_cd);
				fn_userlog ( c_ServiceName, "ptr_st_undfut_pos_to_be.c_undrlyng    |%s|",ptr_st_undfut_pos_to_be.c_undrlyng);
				fn_userlog ( c_ServiceName, "ptr_st_undfut_pos_to_be.c_prd_typ			|%s|",ptr_st_undfut_pos_to_be.c_prd_typ);
    		fn_userlog ( c_ServiceName, "IWTL buy qty      :%ld:", ptr_st_undfut_pos_to_be.l_ibuy_qty );
    		fn_userlog ( c_ServiceName, "IWTL buy val      :%lf:", ptr_st_undfut_pos_to_be.d_ibuy_ord_vl );
    		fn_userlog ( c_ServiceName, "IWTL sell qty     :%ld:", ptr_st_undfut_pos_to_be.l_isell_qty );
    		fn_userlog ( c_ServiceName, "IWTL sell val     :%lf:", ptr_st_undfut_pos_to_be.d_isell_ord_vl );
    		fn_userlog ( c_ServiceName, "EXCH buy qty      :%ld:", ptr_st_undfut_pos_to_be.l_exbuy_qty );
    		fn_userlog ( c_ServiceName, "EXCH buy val      :%lf:", ptr_st_undfut_pos_to_be.d_exbuy_ord_vl );
    		fn_userlog ( c_ServiceName, "EXCH sell qty     :%ld:", ptr_st_undfut_pos_to_be.l_exsell_qty );
    		fn_userlog ( c_ServiceName, "EXCH sell val     :%lf:", ptr_st_undfut_pos_to_be.d_exsell_ord_vl );
    		fn_userlog ( c_ServiceName, "Buy exctd qty     :%ld:", ptr_st_undfut_pos_to_be.l_buy_exctd_qty );
    		fn_userlog ( c_ServiceName, "Sell exctd qty    :%ld:", ptr_st_undfut_pos_to_be.l_sell_exctd_qty );
    		fn_userlog ( c_ServiceName, "Open qty          :%ld:", ptr_st_undfut_pos_to_be.l_opnpstn_qty );
    		fn_userlog ( c_ServiceName, "Original open val :%lf:", ptr_st_undfut_pos_to_be.d_org_opn_val );
    		fn_userlog ( c_ServiceName, "MTMed open val    :%lf:", ptr_st_undfut_pos_to_be.d_mtm_opn_val );
    		fn_userlog ( c_ServiceName, "Add Margin val    :%lf:", ptr_st_undfut_pos_to_be.d_add_mrgn_val );
  		}

			i_returncode = fn_upd_mrgn ( c_ServiceName,
                               &ptr_st_pstn_action,
                               st_undfut_pos_crrnt,
                               &ptr_st_undfut_pos_to_be,
                               &ptr_st_err_msg );

  		if ( i_returncode != 0 )
  		{
    		return FAILURE;
  		}

			if(DEBUG_MSG_LVL_3)
  		{
				fn_userlog(c_ServiceName,"2 Exchange code is |%s|",ptr_st_pstn_action.c_xchng_cd);
				fn_userlog(c_ServiceName,"ptr_st_pstn_actn.c_cln_mtch_accnt is |%s|",ptr_st_pstn_action.c_cln_mtch_accnt);
    		fn_userlog ( c_ServiceName, "st_undfut_pos_crrnt.d_ordr_mrgn :%lf:",st_undfut_pos_crrnt.d_ordr_mrgn );
				fn_userlog ( c_ServiceName, "ptr_st_undfut_pos_to_be.d_ordr_mrgn |%lf|",ptr_st_undfut_pos_to_be.d_ordr_mrgn);
				fn_userlog ( c_ServiceName, "st_undfut_pos_crrnt.d_add_mrgn_val |%lf|",st_undfut_pos_crrnt.d_add_mrgn_val);
				fn_userlog ( c_ServiceName, "ptr_st_undfut_pos_to_be.d_add_mrgn_val|%lf|",ptr_st_undfut_pos_to_be.d_add_mrgn_val);
				fn_userlog ( c_ServiceName, "st_undfut_pos_crrnt.d_trd_mrgn				|%lf|",st_undfut_pos_crrnt.d_trd_mrgn);
				fn_userlog ( c_ServiceName, "ptr_st_undfut_pos_to_be.d_trd_mrgn  |%lf|",ptr_st_undfut_pos_to_be.d_trd_mrgn);
  		}

			d_diff_UOM = st_undfut_pos_crrnt.d_ordr_mrgn - ptr_st_undfut_pos_to_be.d_ordr_mrgn ;

  		if(DEBUG_MSG_LVL_0)
  		{
    		fn_userlog ( c_ServiceName, "Difference in UOM :%lf:", d_diff_UOM );
  		}
			
			d_diff_AMV = st_undfut_pos_crrnt.d_add_mrgn_val - ptr_st_undfut_pos_to_be.d_add_mrgn_val;

			if(DEBUG_MSG_LVL_0)
      {
        fn_userlog ( c_ServiceName, "Difference in UAMV :%lf:", d_diff_AMV );
      }

			if(DEBUG_MSG_LVL_0)
    	{	
				fn_userlog(c_ServiceName,"RollOver st_undfut_pos_crrnt.d_trd_mrgn is :%lf:",st_undfut_pos_crrnt.d_trd_mrgn);
				fn_userlog(c_ServiceName,"RollOver ptr_st_undfut_pos_to_be.d_trd_mrgn is :%lf:",ptr_st_undfut_pos_to_be.d_trd_mrgn);
			}

			d_diff_UTM = st_undfut_pos_crrnt.d_trd_mrgn - ptr_st_undfut_pos_to_be.d_trd_mrgn;

			if(DEBUG_MSG_LVL_0)
    	{
      	fn_userlog ( c_ServiceName, "Difference in UTM :%lf:", d_diff_UTM );
    	}

			d_total_diff_UOM = d_diff_UOM + d_total_diff_UOM;
			d_total_diff_AMV = d_diff_AMV + d_total_diff_AMV;
			
			if(DEBUG_MSG_LVL_0)
    	{
				fn_userlog(c_ServiceName,"RollOver d_total_diff_UTM is :%lf:",d_total_diff_UTM);
				fn_userlog(c_ServiceName,"RollOver d_diff_UTM is :%lf:",d_diff_UTM);
			}

			d_total_diff_UTM = d_total_diff_UTM	+ d_diff_UTM ;

			if(DEBUG_MSG_LVL_0)
    	{
				fn_userlog(c_ServiceName,"RollOver d_total_diff_UTM is :%lf:",d_total_diff_UTM);
			}
  }*** END of while loop ***

		if( DEBUG_MSG_LVL_5 )
    { 
       fn_userlog(c_ServiceName,"Order Level PNL  |%lf|",d_cntrct_pl);
       fn_userlog(c_ServiceName," number of lot is |%ld|",l_no_of_lot);
    }

		if ( d_cntrct_pl > 0 )
		{
			*d_total_diff = d_total_diff_UOM + d_total_diff_AMV + d_total_diff_UTM + d_cntrct_pl; 
		}
		else
		{	
			*d_total_diff = d_total_diff_UOM + d_total_diff_AMV + d_total_diff_UTM ; 
  	}
		
    *d_total_pnl  = d_cntrct_pl;
  
			if( DEBUG_MSG_LVL_0 )
      {
        fn_userlog(c_ServiceName,"d_total_diff				|%lf|",*d_total_diff);
        fn_userlog(c_ServiceName,"d_total_pnl					|%lf|",*d_total_pnl);
			}

		c_dr_without_lmt_flg = DEBIT_WHEN_LIMIT;
		strcpy( c_narration_id , ON_ROLLOVER_ORDER_PLACEMENT);

		if ( *d_total_diff < 0  )
    {

      i_returncode = fn_upd_limits( c_ServiceName,
                                    &ptr_st_pstn_action,
                                    &ptr_st_err_msg,
                                    c_narration_id,
                                    c_dr_without_lmt_flg,
                                    *d_total_diff,
                                    &d_balance_amt);
      if ( i_returncode != 0 )
      {
        switch ( i_returncode )
        {
          case  INSUFFICIENT_LIMITS :
            *** Ver 1.4 **** starts
            fn_userlog(c_ServiceName," Inside INSUFFICIENT_LIMITS.");
						strcpy(c_err_msg,ptr_st_err_msg.c_err_msg);
						EXEC SQL CLOSE :sys_cursor;
            tpfree((char *)ptr_fml_obuf);
            tpfree((char *)ptr_fml_ibuf);
            return INSUFFICIENT_LIMITS  ;
            **** Ver 1.4 Ends *******

            *** Ver 1.4 Starts Here ***
            fn_userlog(c_ServiceName," Inside INSUFFICIENT_LIMITS for d_total_diff.");
            strcpy(c_err_msg,ptr_st_err_msg.c_err_msg);
            strcpy(c_err_msg,strtok(c_err_msg,"|"));
            d_required_total_diff = atof(strtok(NULL,"|"));
            fn_userlog(c_ServiceName,"d_required_total_diff = %lf",d_required_total_diff);
            strcpy(c_err_msg,strtok(c_err_msg,"<"));
            fn_userlog(c_ServiceName," d_total_pnl = %lf", *d_total_pnl);

            if(*d_total_pnl < 0)
              d_required_amt = d_required_total_diff + ( ((-1) * (*d_total_pnl)) / 100 );
            else
              d_required_amt = d_required_total_diff;


            fn_userlog(c_ServiceName,"d_required_amt = :%lf:",d_required_amt);
            sprintf(c_err_msg,"%s < %0.2lf >",c_err_msg,d_required_amt);
            EXEC SQL CLOSE :sys_cursor;
            tpfree((char *)ptr_fml_obuf);
            tpfree((char *)ptr_fml_ibuf);
            return INSUFFICIENT_LIMITS  ;
            *** Ver 1.4 ***

         default:

            fn_errlog( c_ServiceName, "S31905",LIBMSG , c_err_msg );
            EXEC SQL CLOSE :sys_cursor;
            tpfree((char *)ptr_fml_obuf);
            tpfree((char *)ptr_fml_ibuf);
            return -1;
        }
      }
		}
	
		MEMSET( c_narration_id );	
		strcpy( c_narration_id , BLOCK_PNL_ON_ROLLOVER_ORDER_PLACEMENT);

    if ( *d_total_pnl < 0  )
    {

      i_returncode = fn_upd_limits( c_ServiceName,
                                    &ptr_st_pstn_action,
                                    &ptr_st_err_msg,
                                    c_narration_id,
                                    c_dr_without_lmt_flg,
                                    *d_total_pnl,
                                    &d_balance_amt);
      if ( i_returncode != 0 )
      {
        switch ( i_returncode )
        {
          case  INSUFFICIENT_LIMITS :
            **** Ver 1.4 Starts ****
            fn_userlog(c_ServiceName," Inside INSUFFICIENT_LIMITS.");
            strcpy(c_err_msg,ptr_st_err_msg.c_err_msg);
            EXEC SQL CLOSE :sys_cursor;
            tpfree((char *)ptr_fml_obuf);
            tpfree((char *)ptr_fml_ibuf);
            return INSUFFICIENT_LIMITS  ;
            **** Ver 1.4 ****

            *** Ver 1.4 Starts ***
            fn_userlog(c_ServiceName," Inside INSUFFICIENT_LIMITS for d_total_pnl.");
            strcpy(c_err_msg,ptr_st_err_msg.c_err_msg);
            strcpy(c_err_msg,strtok(c_err_msg,"|"));
            d_required_total_pnl = atof(strtok(NULL,"|"));
            d_required_amt = d_required_total_pnl;

            EXEC SQL CLOSE :sys_cursor;
            tpfree((char *)ptr_fml_obuf);
            tpfree((char *)ptr_fml_ibuf);
            return INSUFFICIENT_LIMITS  ;
            *** Ver 1.4 Ends ***

         default:

            fn_errlog( c_ServiceName, "S31910",LIBMSG , c_err_msg );
            EXEC SQL CLOSE :sys_cursor;
            tpfree((char *)ptr_fml_obuf);
            tpfree((char *)ptr_fml_ibuf);
            return -1;
        }
      }
    }

  EXEC SQL CLOSE :sys_cursor;
  EXEC SQL FREE :sys_cursor;
	
	return 0;
}

int fn_upd_mrgn( char *c_ServiceName,
                  struct vw_pstn_actn *ptr_st_pstn_actn,
                  struct vw_undfut_pos st_undfut_pos_crrnt,
                  struct vw_undfut_pos *ptr_st_undfut_pos,
                  struct vw_err_msg *ptr_st_err_msg)
{

  int   i_returncode;

  long int  li_ose_qty	=	0;
  long int  li_ibm_qty	=	0;
  long int  li_ebm_qty	=	0;
  long int  li_obe_qty	=	0;
  long int  li_ism_qty	=	0;
  long int  li_esm_qty	=	0;
  long int  li_opn_qty	=	0;
  long int  li_unmtchd_qty	=	0;
  long int  li_sum_CUOQ	=	0;
  long int  li_spd_qty	=	0;

  double d_initial_mrgn	=	0;
  double d_spread_mrgn	=	0;
  double d_min_mrgn			=	0;
  double d_min_spread_mrgn	=	0;
  double d_i_exp = 0.0	;
  double d_e_exp = 0.0	;
  double d_sum_CUOV			=	0;
  double d_sum_CUOV_cmp	=	0;
  double d_diff_AMV			=	0;
  double d_und_opn_val_imtm	=	0;

  char  c_pos_opn;

  struct vw_cntfut_pos st_cntfut_pos;

  EXEC SQL BEGIN DECLARE SECTION;
    sql_cursor     sys_cursor;        
    char  sql_cntrct_tag;
    char  sql_cln_mtch_accnt[11];
    char  sql_xchng_cd[4];
    char  sql_prd_typ;
    char  sql_undrlyng[7];
    double d_far_mtm_opn_val;
    long int  li_far_opnpstn_qty;
  EXEC SQL END DECLARE SECTION;

  strcpy( sql_cln_mtch_accnt,ptr_st_pstn_actn->c_cln_mtch_accnt);
  strcpy( sql_xchng_cd,ptr_st_pstn_actn->c_xchng_cd);
  strcpy( sql_undrlyng,ptr_st_pstn_actn->c_undrlyng);
	sql_prd_typ = ptr_st_pstn_actn->c_prd_typ;
  sql_cntrct_tag = ptr_st_undfut_pos->c_cntrct_tag;

  i_returncode = fn_get_im_prcntg( c_ServiceName,
                                   ptr_st_pstn_actn,
                                   ptr_st_err_msg,
                                   &d_initial_mrgn,
                                   &d_spread_mrgn,
                                   &d_min_mrgn,
                                   &d_min_spread_mrgn,
                                   ptr_st_undfut_pos->c_cntrct_tag );

  if ( i_returncode == -1 )
  {
		fn_errlog( c_ServiceName, "S31915",LIBMSG , c_err_msg );
    return ( -1 );
  }

  if(DEBUG_MSG_LVL_3)
  {
    fn_userlog ( c_ServiceName, " Initial Margin is        |%lf|",d_initial_mrgn );   
    fn_userlog ( c_ServiceName, " Spread Margin Is         |%lf|",d_spread_mrgn );   
    fn_userlog ( c_ServiceName, " Minimum Margin Is        |%lf|",d_min_mrgn );      
    fn_userlog ( c_ServiceName, " Minimum Spread Margin Is |%lf|",d_min_spread_mrgn );
  }

	if ( ptr_st_undfut_pos->l_ibuy_qty != 0 )
  {

    li_ose_qty = fn_maxl( ( ptr_st_undfut_pos->l_sell_exctd_qty * (-1)) - ptr_st_undfut_pos->l_buy_exctd_qty, 0 );

    li_ibm_qty = fn_maxl( (ptr_st_undfut_pos->l_ibuy_qty - li_ose_qty), 0 );

    ptr_st_undfut_pos->d_ibuy_mrgn = li_ibm_qty * (ptr_st_undfut_pos->d_ibuy_ord_vl / ptr_st_undfut_pos->l_ibuy_qty) *
                                      d_initial_mrgn / 100.0 ;
  }
  else
  {
    ptr_st_undfut_pos->d_ibuy_mrgn = 0;
  }

  if ( ptr_st_undfut_pos->l_exbuy_qty != 0 )
  {

    li_ose_qty = fn_maxl( (ptr_st_undfut_pos->l_sell_exctd_qty * (-1)) - ptr_st_undfut_pos->l_buy_exctd_qty,
                          0 );
    li_ebm_qty = fn_maxl( (ptr_st_undfut_pos->l_exbuy_qty - li_ose_qty), 0 );

    ptr_st_undfut_pos->d_exbuy_mrgn = li_ebm_qty * (ptr_st_undfut_pos->d_exbuy_ord_vl / ptr_st_undfut_pos->l_exbuy_qty) *
                                      d_initial_mrgn / 100.0 ;
  }
  else
  {
    ptr_st_undfut_pos->d_exbuy_mrgn = 0;
  }

	if ( ptr_st_undfut_pos->l_isell_qty != 0 )
  {

    li_obe_qty = fn_maxl( ptr_st_undfut_pos->l_buy_exctd_qty - (ptr_st_undfut_pos->l_sell_exctd_qty * (-1) ), 0 );

    li_ism_qty = fn_maxl( ( ( ptr_st_undfut_pos->l_isell_qty * (-1)) - li_obe_qty), 0 );

    ptr_st_undfut_pos->d_isell_mrgn = li_ism_qty * (ptr_st_undfut_pos->d_isell_ord_vl / ptr_st_undfut_pos->l_isell_qty) *
                                    d_initial_mrgn / 100.0 ;
  }
  else
  {
    ptr_st_undfut_pos->d_isell_mrgn = 0;
  }

  if ( ptr_st_undfut_pos->l_exsell_qty != 0 )
  {

    li_obe_qty = fn_maxl( ptr_st_undfut_pos->l_buy_exctd_qty - ( ptr_st_undfut_pos->l_sell_exctd_qty * (-1) ), 0 );

    li_esm_qty = fn_maxl( ( ( ptr_st_undfut_pos->l_exsell_qty * (-1)) - li_obe_qty), 0 );

    ptr_st_undfut_pos->d_exsell_mrgn = li_esm_qty * (ptr_st_undfut_pos->d_exsell_ord_vl / ptr_st_undfut_pos->l_exsell_qty) *
                                      d_initial_mrgn / 100.0 ;
  }
  else
  {
    ptr_st_undfut_pos->d_exsell_mrgn = 0;
  }

	d_i_exp = fn_maxd(ptr_st_undfut_pos->d_ibuy_mrgn, ptr_st_undfut_pos->d_isell_mrgn);

  d_e_exp = fn_maxd(ptr_st_undfut_pos->d_exbuy_mrgn, ptr_st_undfut_pos->d_exsell_mrgn);

  ptr_st_undfut_pos->d_ordr_mrgn = fn_maxd( d_i_exp, d_e_exp );

  if(DEBUG_MSG_LVL_5)
  {
    fn_userlog ( c_ServiceName, "Total order level margin" );
    fn_userlog ( c_ServiceName, "IWTL buy exposure   :%lf:", ptr_st_undfut_pos->d_ibuy_mrgn );
    fn_userlog ( c_ServiceName, "IWTL sell exposure  :%lf:", ptr_st_undfut_pos->d_isell_mrgn );
    fn_userlog ( c_ServiceName, "IWTL total exposure :%lf:", d_i_exp );
    fn_userlog ( c_ServiceName, "EXCH buy exposure   :%lf:", ptr_st_undfut_pos->d_exbuy_mrgn );
    fn_userlog ( c_ServiceName, "EXCH sell exposure  :%lf:", ptr_st_undfut_pos->d_exsell_mrgn );
    fn_userlog ( c_ServiceName, "EXCH total exposure :%lf:", d_e_exp );
    fn_userlog ( c_ServiceName, "Final exposure      :%lf:", ptr_st_undfut_pos->d_ordr_mrgn );
    fn_userlog ( c_ServiceName, "sql_cln_mtch_accnt  :%s:",  sql_cln_mtch_accnt );
    fn_userlog ( c_ServiceName, "sql_xchng_cd  			 :%s:",  sql_xchng_cd );
    fn_userlog ( c_ServiceName, "sql_undrlyng  			 :%s:",  sql_undrlyng );
    fn_userlog ( c_ServiceName, "sql_cntrct_tag  		 :%c:",  sql_cntrct_tag );
    fn_userlog ( c_ServiceName, "sql_prd_typ  		 	 :%c:",  sql_prd_typ );
  }

  ** Calculate the Executed margin, Spread margin and Spread PL.        **
  ** They need to be recalculated only if the executed position changes **
	

	li_spd_qty = fn_minl( ptr_st_undfut_pos->l_opn_buyqty,labs(ptr_st_undfut_pos->l_opn_sellqty) );

	if(DEBUG_MSG_LVL_5)
  {
		fn_userlog(c_ServiceName,"li_spd_qty is :%ld:",li_spd_qty);
	}	
			EXEC SQL
      SELECT  FFP_MTM_OPN_VAL,
              FFP_OPNPSTN_QTY
      INTO    :d_far_mtm_opn_val,
              :li_far_opnpstn_qty
      FROM    FFP_FO_FUTURES_PSTN
      WHERE   FFP_CLM_MTCH_ACCNT = :sql_cln_mtch_accnt
      AND     FFP_XCHNG_CD       = :sql_xchng_cd
      AND     FFP_PRDCT_TYP      = :sql_prd_typ
      AND     FFP_UNDRLYNG       = :sql_undrlyng
      AND     FFP_CNTRCT_TAG     = :sql_cntrct_tag
      AND     FFP_EXPRY_DT       =
              ( SELECT  MAX(FFP_EXPRY_DT)
              FROM    FFP_FO_FUTURES_PSTN
              WHERE   FFP_CLM_MTCH_ACCNT = :sql_cln_mtch_accnt
              AND     FFP_XCHNG_CD       = :sql_xchng_cd
              AND     FFP_PRDCT_TYP      = :sql_prd_typ
              AND     FFP_UNDRLYNG       = :sql_undrlyng
              AND     FFP_CNTRCT_TAG     = :sql_cntrct_tag
              AND     FFP_OPNPSTN_QTY    != 0 );

    if ( ( SQLCODE != 0 ) &&
         ( SQLCODE != NO_DATA_FOUND ) )
    {
      fn_errlog( c_ServiceName, "S31920", SQLMSG, ptr_st_err_msg->c_err_msg );
      return FAILURE;
    }

    if(DEBUG_MSG_LVL_3)
    {
      fn_userlog(c_ServiceName," d_far_mtm_opn_val     |%lf| ",d_far_mtm_opn_val);    
      fn_userlog(c_ServiceName," li_far_opnpstn_qty    |%ld| ",li_far_opnpstn_qty);  
      fn_userlog(c_ServiceName," li_spd_qty    				 |%ld| ",li_spd_qty);  
      fn_userlog(c_ServiceName," ptr_st_undfut_pos->l_opnpstn_qty    |%ld| ",ptr_st_undfut_pos->l_opnpstn_qty);  
    }

    if ( SQLCODE == 0 )
    {
      ptr_st_undfut_pos->d_sprd_mrgn = li_spd_qty * ( d_far_mtm_opn_val / li_far_opnpstn_qty ) * d_spread_mrgn / 100.0;

      ptr_st_undfut_pos->d_imtm_sprd_mrgn = ptr_st_undfut_pos->d_sprd_mrgn;

      ptr_st_undfut_pos->d_mm_sprd_mrgn =li_spd_qty * (d_far_mtm_opn_val / li_far_opnpstn_qty) * d_min_spread_mrgn / 100.0;
    
			if(DEBUG_MSG_LVL_3)
    	{
      	fn_userlog(c_ServiceName," ptr_st_undfut_pos->d_sprd_mrgn     	|%lf| ",ptr_st_undfut_pos->d_sprd_mrgn);    
      	fn_userlog(c_ServiceName," ptr_st_undfut_pos->d_imtm_sprd_mrgn  |%lf| ",ptr_st_undfut_pos->d_imtm_sprd_mrgn);    
      	fn_userlog(c_ServiceName," ptr_st_undfut_pos->d_mm_sprd_mrgn    |%lf| ",ptr_st_undfut_pos->d_mm_sprd_mrgn);    
			}
    }
    else
    {
      ptr_st_undfut_pos->d_sprd_mrgn = 0;
      ptr_st_undfut_pos->d_imtm_sprd_mrgn = 0;
      ptr_st_undfut_pos->d_mm_sprd_mrgn = 0;
    }
		
		c_pos_opn = 'Y';

    EXEC SQL ALLOCATE :sys_cursor;

    if( ptr_st_undfut_pos->l_opnpstn_qty > 0)
    {
			fn_userlog(c_ServiceName,"Inside l_opnpstn_qty > 0.");
		
      EXEC SQL EXECUTE
        BEGIN
          OPEN :sys_cursor FOR
            SELECT  FFP_MTM_OPN_VAL,
                    FFP_OPNPSTN_QTY,
                    FFP_IMTM_OPN_VAL
            FROM    FFP_FO_FUTURES_PSTN
            WHERE   FFP_CLM_MTCH_ACCNT = :sql_cln_mtch_accnt
            AND     FFP_XCHNG_CD       = :sql_xchng_cd
            AND     FFP_PRDCT_TYP      = :sql_prd_typ
            AND     FFP_UNDRLYNG       = :sql_undrlyng
            AND     FFP_CNTRCT_TAG     = :sql_cntrct_tag
            AND     FFP_OPNPSTN_QTY    > 0
            ORDER BY FFP_EXPRY_DT Desc;
          END;
        END-EXEC;

    }
    else if( ptr_st_undfut_pos->l_opnpstn_qty < 0)
    {
      EXEC SQL EXECUTE
        BEGIN
          OPEN :sys_cursor FOR
            SELECT  FFP_MTM_OPN_VAL,
                    FFP_OPNPSTN_QTY,
                    FFP_IMTM_OPN_VAL
            FROM    ffp_fo_futures_pstn
            WHERE   FFP_CLM_MTCH_ACCNT = :sql_cln_mtch_accnt
            AND     FFP_XCHNG_CD       = :sql_xchng_cd
            AND     FFP_PRDCT_TYP      = :sql_prd_typ
            AND     FFP_UNDRLYNG       = :sql_undrlyng
            AND     FFP_CNTRCT_TAG     = :sql_cntrct_tag
            AND     FFP_OPNPSTN_QTY    < 0
            ORDER BY FFP_EXPRY_DT desc;
          END;
        END-EXEC;

    }
    else
    {
      fn_userlog(c_ServiceName,"Inside Else Condition.");
	
      d_sum_CUOV = 0;
      d_sum_CUOV_cmp = 0;
      ptr_st_undfut_pos->d_sprd_pl = (-1) * ptr_st_undfut_pos->d_mtm_opn_val;
      ptr_st_undfut_pos->d_imtm_sprd_pl = (-1) * ptr_st_undfut_pos->d_imtm_opn_val;
      ptr_st_undfut_pos->d_mm_sprd_pl = ptr_st_undfut_pos->d_sprd_pl;
	
			ptr_st_undfut_pos->d_exctd_mrgn = 0;
      ptr_st_undfut_pos->d_imtm_exctd_mrgn = 0;
      ptr_st_undfut_pos->d_mm_exctd_mrgn = 0;
      c_pos_opn = 'N';

      *** Set add margin amount to 0 ***
      ptr_st_undfut_pos->d_add_mrgn_val = 0;

      SQLCODE = 0;
    }

    if ( SQLCODE != 0 )
    {
      fn_errlog( c_ServiceName, "S31925", SQLMSG, ptr_st_err_msg->c_err_msg  );
      EXEC SQL FREE :sys_cursor;
      return ( -1 );
    }

    if ( c_pos_opn == 'Y' )
    {
      li_opn_qty = ptr_st_undfut_pos->l_opnpstn_qty;
      li_unmtchd_qty = li_opn_qty;
      li_sum_CUOQ = 0;
      d_sum_CUOV = 0;
      d_sum_CUOV_cmp = 0;

			fn_userlog(c_ServiceName,"inside c_pos_opn condition :::::li_opn_qty is   :%ld:",li_opn_qty);

      while ( li_unmtchd_qty != 0)
      {
        EXEC SQL FETCH :sys_cursor
                INTO :st_cntfut_pos.d_mtm_opn_val,
                     :st_cntfut_pos.l_opnpstn_qty,
                     :st_cntfut_pos.d_imtm_opn_val;

        if ( SQLCODE != 0 )
        {
          fn_errlog( c_ServiceName, "S31930", SQLMSG,
                                          ptr_st_err_msg->c_err_msg  );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          return ( -1 );
        }

				if(DEBUG_MSG_LVL_3)
    		{
        	fn_userlog(c_ServiceName,"st_cntfut_pos.d_mtm_opn_val	is :%lf:",st_cntfut_pos.d_mtm_opn_val);
        	fn_userlog(c_ServiceName,"st_cntfut_pos.d_imtm_opn_val	is :%lf:",st_cntfut_pos.d_imtm_opn_val);
        	fn_userlog(c_ServiceName,"li_unmtchd_qty	is 							:%ld:",li_unmtchd_qty);
        	fn_userlog(c_ServiceName,"st_cntfut_pos.l_opnpstn_qty is 	:%ld:",st_cntfut_pos.l_opnpstn_qty);
					
				}

        if ( li_opn_qty > 0 )
        {
          st_cntfut_pos.l_und_opn_qty = fn_minl( st_cntfut_pos.l_opnpstn_qty, li_unmtchd_qty );
        }
        else
        {
          st_cntfut_pos.l_und_opn_qty = fn_maxl( st_cntfut_pos.l_opnpstn_qty, li_unmtchd_qty );
        }

				st_cntfut_pos.d_und_opn_val=st_cntfut_pos.l_und_opn_qty *(st_cntfut_pos.d_mtm_opn_val / st_cntfut_pos.l_opnpstn_qty);

        d_und_opn_val_imtm = st_cntfut_pos.l_und_opn_qty * (st_cntfut_pos.d_imtm_opn_val / st_cntfut_pos.l_opnpstn_qty);

        li_sum_CUOQ = li_sum_CUOQ + st_cntfut_pos.l_und_opn_qty;
				
				if(DEBUG_MSG_LVL_3)
    		{
					fn_userlog(c_ServiceName,"Before d_sum_CUOV is :%lf:",d_sum_CUOV);
					fn_userlog(c_ServiceName,"Before li_sum_CUOQ is :%lf:",li_sum_CUOQ);
					fn_userlog(c_ServiceName,"Before st_cntfut_pos.d_und_opn_val is :%lf:",st_cntfut_pos.d_und_opn_val);
				}

        d_sum_CUOV = d_sum_CUOV + st_cntfut_pos.d_und_opn_val;
				
				if(DEBUG_MSG_LVL_3)
    		{
					fn_userlog(c_ServiceName,"After d_sum_CUOV is :%lf:",d_sum_CUOV);
					fn_userlog(c_ServiceName,"After d_sum_CUOV_cmp is :%lf:",d_sum_CUOV_cmp);
				}

        d_sum_CUOV_cmp = d_sum_CUOV_cmp + d_und_opn_val_imtm;

        li_unmtchd_qty = li_unmtchd_qty - st_cntfut_pos.l_und_opn_qty;
      }

      EXEC SQL CLOSE :sys_cursor;
      EXEC SQL FREE :sys_cursor;

      ** Calculation of Executed margin **
      ** Executed margin = d_sum_CUOV * IM / 100 **

			if(DEBUG_MSG_LVL_3)
    	{
				fn_userlog(c_ServiceName,"d_sum_CUOV is :%lf:",d_sum_CUOV);
				fn_userlog(c_ServiceName,"ptr_st_undfut_pos->d_mtm_opn_val is :%lf:",ptr_st_undfut_pos->d_mtm_opn_val);
			}

      ptr_st_undfut_pos->d_sprd_pl = d_sum_CUOV - ptr_st_undfut_pos->d_mtm_opn_val;

      ptr_st_undfut_pos->d_imtm_sprd_pl = d_sum_CUOV_cmp - ptr_st_undfut_pos->d_imtm_opn_val;

      ptr_st_undfut_pos->d_mm_sprd_pl = ptr_st_undfut_pos->d_sprd_pl;

      if ( li_opn_qty > 0 )
      {
				fn_userlog(c_ServiceName,"Inside li_opn_qty > 0.");
				fn_userlog(c_ServiceName,"d_sum_CUOV is :%lf:",d_sum_CUOV);
				fn_userlog(c_ServiceName,"d_initial_mrgn is :%lf:",d_initial_mrgn);

        ptr_st_undfut_pos->d_exctd_mrgn = d_sum_CUOV * d_initial_mrgn / 100.0;

        ptr_st_undfut_pos->d_imtm_exctd_mrgn = d_sum_CUOV_cmp * d_initial_mrgn / 100.0;

        ptr_st_undfut_pos->d_mm_exctd_mrgn = d_sum_CUOV * d_min_mrgn / 100.0;

      }
      else if ( li_opn_qty < 0 )
      {

        ptr_st_undfut_pos->d_exctd_mrgn = ( (-1) * d_sum_CUOV )* d_initial_mrgn / 100.0;

        ptr_st_undfut_pos->d_imtm_exctd_mrgn = ( (-1) * d_sum_CUOV_cmp )* d_initial_mrgn / 100.0;

        ptr_st_undfut_pos->d_mm_exctd_mrgn = ( (-1) * d_sum_CUOV )* d_min_mrgn / 100.0;

      }

      if ( ( ptr_st_undfut_pos->l_opnpstn_qty == 0 ) ||
           ( ( ptr_st_undfut_pos->l_opnpstn_qty > 0 ) &&
             ( st_undfut_pos_crrnt.l_opnpstn_qty < 0 ) ) ||
           ( ( ptr_st_undfut_pos->l_opnpstn_qty < 0 ) &&
             ( st_undfut_pos_crrnt.l_opnpstn_qty > 0 ) ) )
      {
        ptr_st_undfut_pos->d_add_mrgn_val = 0;
      }

    }
    else
    {
      EXEC SQL CLOSE :sys_cursor;
      EXEC SQL FREE :sys_cursor;
    }

		if(DEBUG_MSG_LVL_3)
    {
			fn_userlog(c_ServiceName,"ptr_st_undfut_pos->d_exctd_mrgn Is :%lf:",ptr_st_undfut_pos->d_exctd_mrgn);
			fn_userlog(c_ServiceName,"ptr_st_undfut_pos->d_sprd_mrgn Is :%lf:",ptr_st_undfut_pos->d_sprd_mrgn);
			fn_userlog(c_ServiceName,"ptr_st_undfut_pos->d_sprd_pl Is :%lf:", ptr_st_undfut_pos->d_sprd_pl);
		}

    if ( ( ptr_st_undfut_pos->d_exctd_mrgn + ptr_st_undfut_pos->d_sprd_mrgn ) <= ptr_st_undfut_pos->d_sprd_pl )
    {
      ptr_st_undfut_pos->d_trd_mrgn = 0;
    }
    else
    {
			if(DEBUG_MSG_LVL_3)
    	{
				fn_userlog(c_ServiceName,"ptr_st_undfut_pos->d_trd_mrgn :%lf:",ptr_st_undfut_pos->d_trd_mrgn);
				fn_userlog(c_ServiceName,"ptr_st_undfut_pos->d_exctd_mrgn :%lf:",ptr_st_undfut_pos->d_exctd_mrgn);
				fn_userlog(c_ServiceName,"ptr_st_undfut_pos->d_sprd_mrgn :%lf:",ptr_st_undfut_pos->d_sprd_mrgn);
				fn_userlog(c_ServiceName,"ptr_st_undfut_pos->d_sprd_pl :%lf:",ptr_st_undfut_pos->d_sprd_pl);
			}
	
      ptr_st_undfut_pos->d_trd_mrgn = ptr_st_undfut_pos->d_exctd_mrgn + ptr_st_undfut_pos->d_sprd_mrgn - ptr_st_undfut_pos->d_sprd_pl;
    }

    if((ptr_st_undfut_pos->d_imtm_exctd_mrgn + ptr_st_undfut_pos->d_imtm_sprd_mrgn ) <= ptr_st_undfut_pos->d_imtm_sprd_pl )
    {
      ptr_st_undfut_pos->d_imtm_trd_mrgn = 0;
    }
    else
    {
      ptr_st_undfut_pos->d_imtm_trd_mrgn =
                                    ptr_st_undfut_pos->d_imtm_exctd_mrgn +
                                    ptr_st_undfut_pos->d_imtm_sprd_mrgn -
                                    ptr_st_undfut_pos->d_imtm_sprd_pl;
    }
		
		if ( ( ptr_st_undfut_pos->d_mm_exctd_mrgn + ptr_st_undfut_pos->d_mm_sprd_mrgn ) <= ptr_st_undfut_pos->d_mm_sprd_pl )
    {
      ptr_st_undfut_pos->d_mm_trd_mrgn = 0;
    }
    else
    {
      ptr_st_undfut_pos->d_mm_trd_mrgn = ptr_st_undfut_pos->d_mm_exctd_mrgn +
                                      ptr_st_undfut_pos->d_mm_sprd_mrgn -
                                      ptr_st_undfut_pos->d_mm_sprd_pl;
    }

    if(DEBUG_MSG_LVL_3)
    {
      fn_userlog ( c_ServiceName, "Actual net open value  :%lf:", d_sum_CUOV );
      fn_userlog ( c_ServiceName, "MTMed open val         :%lf:", ptr_st_undfut_pos->d_mtm_opn_val );
      fn_userlog ( c_ServiceName, "Spread PL              :%lf:", ptr_st_undfut_pos->d_sprd_pl );
      fn_userlog ( c_ServiceName, "Executed Margin        :%lf:", ptr_st_undfut_pos->d_exctd_mrgn );
      fn_userlog ( c_ServiceName, "Total Trade Margin     :%lf:", ptr_st_undfut_pos->d_trd_mrgn );
      fn_userlog ( c_ServiceName, "Act net open value -CMP:%lf:", d_sum_CUOV_cmp );
      fn_userlog ( c_ServiceName, "Spread PL at IMTM      :%lf:", ptr_st_undfut_pos->d_imtm_sprd_pl );
      fn_userlog ( c_ServiceName, "Executed Margin at IMTM:%lf:", ptr_st_undfut_pos->d_imtm_exctd_mrgn );
      fn_userlog ( c_ServiceName, "Total IMTM Trade Margin:%lf:", ptr_st_undfut_pos->d_imtm_trd_mrgn );
      fn_userlog ( c_ServiceName, "Spread PL at MM        :%lf:", ptr_st_undfut_pos->d_mm_sprd_pl );
      fn_userlog ( c_ServiceName, "Executed Margin at MM  :%lf:", ptr_st_undfut_pos->d_mm_exctd_mrgn );
      fn_userlog ( c_ServiceName, "Total Trade Mrgn at MM :%lf:", ptr_st_undfut_pos->d_mm_trd_mrgn );
    }
  return SUCCESS;
}

**** Ver 2.8 Comment Ended ****/

/*** Ver 2.8 Started ***/

int fn_chk_sprd_trdng_qt( char *c_ServiceName,
                          struct vw_orderbook st_first_ordbk,
                          struct vw_orderbook st_next_ordbk,
                          char c_sub_rqst_typ,
                          char *c_err_msg
                        )
{

  int i_returncode;
	int i;

  char c_first_qt_trdng_flg ='\0';
  char c_next_qt_trdng_flg ='\0';
  char c_first_act_stts ='\0';
  char c_next_act_stts ='\0';
  char c_brkr_clsout_flg ='\0';
  char c_undqt_flg ='\0';
  char c_first_sprd_allwd_flg ='\0';
  char c_next_sprd_allwd_flg ='\0';
  char c_undsprd_allwd_flg ='\0';
  double d_cum_opnord_val = 0;

  long l_lot_sz_near = 0;
  long l_lot_sz_far = 0;
	long  l_cnt_loop = 0;  
	long  l_temp_sprd_rate = 0;  
	long  l_sprd_rate = 0;  
	long  l_sprd_hprc = 0;  
	long  l_sprd_lprc = 0;  
	double d_lim_rate_temp =  0;   
	double d_final_val =  0;   

  double d_lst_trd_prc1 = 0;
  double d_lst_trd_prc2 = 0;
  double d_ordr_val = 0;   
  double d_ord_max_lim_val = 0;
  double d_tot_open_val = 0;
  double d_lim_rate1 = 0.0;
  double d_lim_rate2 = 0.0;

 sql_cursor  sys_cursor_snd;

  char  c_fod_sprd_ref[20]="\0";
  char  c_exp_dt[20]="\0";
  char  c_undrlng[30]="\0";
	char c_fod_ordr_ref[20]="\0";
	char c_exrc_typ='\0';
	long l_lim_rt = 0;
	long l_ordr_tot_qty = 0;
	double d_temp_trd_prc = 0;
	double d_temp_sltp_trd_prc = 0; 
  char    c_msg[100] = "\0";
  char c_match_id[20] = "\0";
  strcpy(c_match_id,st_first_ordbk.c_cln_mtch_accnt);

  fn_userlog ( c_ServiceName,"Inside function fn_chk_trdng_qt");

  if(DEBUG_MSG_LVL_3)
  {
    fn_userlog( c_ServiceName, "st_first_ordbk.c_cln_mtch_accnt        |%s|",st_first_ordbk.c_cln_mtch_accnt );
    fn_userlog ( c_ServiceName, "st_first_ordbk.c_xchng_cd              |%s|",st_first_ordbk.c_xchng_cd );
    fn_userlog ( c_ServiceName, "st_first_ordbk.c_undrlyng              |%s|",st_first_ordbk.c_undrlyng );
    fn_userlog ( c_ServiceName, "st_first_ordbk.c_expry_dt              |%s|",st_first_ordbk.c_expry_dt );
    fn_userlog ( c_ServiceName, "st_first_ordbk.c_prd_typ               |%c|",st_first_ordbk.c_prd_typ );
    fn_userlog ( c_ServiceName, "st_first_ordbk.c_ordr_flw              |%c|",st_first_ordbk.c_ordr_flw );
    fn_userlog ( c_ServiceName, "st_first_ordbk.l_ord_tot_qty           |%ld|",st_first_ordbk.l_ord_tot_qty );
    fn_userlog ( c_ServiceName, "st_next_ordbk.c_cln_mtch_accnt         |%s|",st_next_ordbk.c_cln_mtch_accnt );
    fn_userlog ( c_ServiceName, "st_next_ordbk.c_xchng_cd               |%s|",st_next_ordbk.c_xchng_cd );
    fn_userlog ( c_ServiceName, "st_next_ordbk.c_undrlyng               |%s|",st_next_ordbk.c_undrlyng );
    fn_userlog ( c_ServiceName, "st_next_ordbk.c_expry_dt               |%s|",st_next_ordbk.c_expry_dt );
    fn_userlog ( c_ServiceName, "st_next_ordbk.c_prd_typ                |%c|",st_next_ordbk.c_prd_typ );
    fn_userlog ( c_ServiceName, "st_next_ordbk.c_exrc_typ               |%c|",st_next_ordbk.c_exrc_typ );
  }

  EXEC SQL
    SELECT  FTQ_QT_TRDNG_FLG,
            FTQ_ACT_STTS,
            NVL(FUM_QT_TRDNG_FLG,'Q'),
            NVL(FUM_BRKR_CLSOUT_FLG,'N'),
            NVL(FUM_ROLLOVER_SPRD_ALLWD_FLG,'N'),
            NVL(FTQ_LST_TRD_PRC,0.0)
    INTO    :c_first_qt_trdng_flg,
            :c_first_act_stts,
            :c_undqt_flg,
            :c_brkr_clsout_flg,
            :c_undsprd_allwd_flg,
            :d_lst_trd_prc1
    FROM    FTQ_FO_TRD_QT,FUM_FO_UNDRLYNG_MSTR
    WHERE   FTQ_XCHNG_CD = :st_first_ordbk.c_xchng_cd
    AND     FTQ_PRDCT_TYP ='F'
    AND     FTQ_UNDRLYNG = :st_first_ordbk.c_undrlyng
    AND     FTQ_EXPRY_DT = to_date (:st_first_ordbk.c_expry_dt ,'dd-Mon-yyyy' )
    AND     FTQ_EXER_TYP = :st_first_ordbk.c_exrc_typ
    AND     FTQ_UNDRLYNG = FUM_UNDRLYNG
    AND     FTQ_PRDCT_TYP = FUM_PRDCT_TYP
    AND     FTQ_XCHNG_CD = FUM_XCHNG_CD;

    if(SQLCODE != 0 && SQLCODE != NO_DATA_FOUND)
    {
      fn_errlog( c_ServiceName, "S31935",SQLMSG,c_err_msg);
      return FAILURE;
    }

    if(DEBUG_MSG_LVL_0)
    {
      fn_userlog( c_ServiceName, "c_first_qt_trdng_flg :%c:", c_first_qt_trdng_flg);
      fn_userlog( c_ServiceName, "c_first_act_stts :%c:", c_first_act_stts);
      fn_userlog( c_ServiceName, "c_brkr_clsout_flg :%c:",c_brkr_clsout_flg);
      fn_userlog( c_ServiceName, "c_undqt_flg :%c:",c_undqt_flg);
      fn_userlog( c_ServiceName, "c_undsprd_allwd_flg :%c:", c_undsprd_allwd_flg);
    }

    if((c_first_qt_trdng_flg != 'T') || ( SQLCODE == NO_DATA_FOUND ) )
    {
      fn_errlog( c_ServiceName, "B28514", " ",c_err_msg );
      return FAILURE;
    }

    if(c_undqt_flg != 'T' )
    {

      EXEC SQL
            SELECT  FTQ_MIN_LOT_QTY
            INTO :l_lot_sz_near
            FROM  FTQ_FO_TRD_QT
            WHERE FTQ_XCHNG_CD    = :st_first_ordbk.c_xchng_cd
            AND   FTQ_PRDCT_TYP   = :st_first_ordbk.c_prd_typ
            AND   FTQ_INDSTK      = :st_first_ordbk.c_ctgry_indstk
            AND   FTQ_UNDRLYNG    = :st_first_ordbk.c_undrlyng
            AND   FTQ_EXPRY_DT    = :st_first_ordbk.c_expry_dt
            AND   FTQ_EXER_TYP    = :st_first_ordbk.c_exrc_typ
            AND   FTQ_OPT_TYP     = :st_first_ordbk.c_opt_typ
            AND   FTQ_STRK_PRC    = :st_first_ordbk.l_strike_prc;

       if(SQLCODE != 0 && SQLCODE != NO_DATA_FOUND)
       {
         fn_errlog( c_ServiceName, "S31940",SQLMSG,c_err_msg);
         return FAILURE;
       } 

       EXEC SQL
            SELECT  FTQ_MIN_LOT_QTY
            INTO :l_lot_sz_far
            FROM  FTQ_FO_TRD_QT
            WHERE FTQ_XCHNG_CD    = :st_next_ordbk.c_xchng_cd
            AND   FTQ_PRDCT_TYP   = :st_next_ordbk.c_prd_typ
            AND   FTQ_INDSTK      = :st_next_ordbk.c_ctgry_indstk
            AND   FTQ_UNDRLYNG    = :st_next_ordbk.c_undrlyng
            AND   FTQ_EXPRY_DT    = :st_next_ordbk.c_expry_dt
            AND   FTQ_EXER_TYP    = :st_next_ordbk.c_exrc_typ
            AND   FTQ_OPT_TYP     = :st_next_ordbk.c_opt_typ
            AND   FTQ_STRK_PRC    = :st_next_ordbk.l_strike_prc;

       if(SQLCODE != 0 && SQLCODE != NO_DATA_FOUND)
       {
         fn_errlog( c_ServiceName, "S31945",SQLMSG,c_err_msg);
         return FAILURE;
       }

       if(DEBUG_MSG_LVL_0)
          {
            fn_userlog( c_ServiceName, "Lot size for near is :%ld:",l_lot_sz_near);
            fn_userlog( c_ServiceName, "Lot size for far is  :%ld:",l_lot_sz_far);
          }

      if (l_lot_sz_far > l_lot_sz_near)
          {
            fn_errlog( c_ServiceName, "B28514", " ",c_err_msg );
            return FAILURE; 
          }
    }
 
    if(c_first_act_stts != 'A')
    {
      fn_errlog( c_ServiceName, "B28515", " ",c_err_msg );
      return FAILURE;
    }

    if(c_brkr_clsout_flg == 'Y')
    {
      fn_errlog ( c_ServiceName, "S31950","Broker in Closeout.",c_err_msg );
      return FAILURE;
    }

    EXEC SQL
      SELECT  FTQ_QT_TRDNG_FLG,
              FTQ_ACT_STTS,
              NVL(FTQ_LST_TRD_PRC,0.0)
      INTO    :c_next_qt_trdng_flg,
              :c_next_act_stts,
              :d_lst_trd_prc2
      FROM    FTQ_FO_TRD_QT
      WHERE   FTQ_XCHNG_CD = :st_next_ordbk.c_xchng_cd
      AND     FTQ_PRDCT_TYP ='F'
      AND     FTQ_UNDRLYNG = :st_next_ordbk.c_undrlyng
      AND     FTQ_EXPRY_DT = to_date (:st_next_ordbk.c_expry_dt ,'dd-Mon-yyyy' )
      AND     FTQ_EXER_TYP = :st_next_ordbk.c_exrc_typ;

    if(SQLCODE != 0 && SQLCODE != NO_DATA_FOUND)
    {
      fn_errlog( c_ServiceName, "S31955",SQLMSG,c_err_msg);
      return FAILURE;
    }

    if(DEBUG_MSG_LVL_0)
    {
      fn_userlog( c_ServiceName, "c_next_qt_trdng_flg :%c:", c_next_qt_trdng_flg);
      fn_userlog( c_ServiceName, "c_next_act_stts :%c:", c_next_act_stts);
    }

    if((c_next_qt_trdng_flg != 'T') || ( SQLCODE == NO_DATA_FOUND ) )
    {
      fn_errlog( c_ServiceName, "B28514", " ",c_err_msg );
      return FAILURE;
    }

    if(c_next_act_stts != 'A')
    {
      fn_errlog( c_ServiceName, "B28515", " ",c_err_msg );
      return FAILURE;
    }

    EXEC SQL
      SELECT  FTQ_ROLLOVER_SPRD_ALLWD_FLG,
							FTQ_HGH_PRC_RNG,							/*** mrk 16-Oct-2019 ***/
							FTQ_LOW_PRC_RNG								/*** mrk 16-Oct-2019 ***/
      INTO    :c_first_sprd_allwd_flg,
							:l_sprd_hprc,									/*** mrk 16-Oct-2019 ***/
							:l_sprd_lprc									/*** mrk 16-Oct-2019 ***/
      FROM    FTQ_FO_TRD_QT
      WHERE   FTQ_XCHNG_CD = :st_first_ordbk.c_xchng_cd
      AND     FTQ_PRDCT_TYP ='S'
      AND     FTQ_UNDRLYNG = :st_first_ordbk.c_undrlyng
      AND     FTQ_EXPRY_DT = to_date (:st_first_ordbk.c_expry_dt ,'dd-Mon-yyyy' )
			AND			FTQ_EXPRY_DT2 = to_date (:st_next_ordbk.c_expry_dt ,'dd-Mon-yyyy' )
      AND     FTQ_EXER_TYP = :st_first_ordbk.c_exrc_typ;

    if(SQLCODE != 0 && SQLCODE != NO_DATA_FOUND)
    {
      fn_errlog( c_ServiceName, "S31960",SQLMSG,c_err_msg);
      return FAILURE;
    }
    if(DEBUG_MSG_LVL_0)
    {
      fn_userlog( c_ServiceName, "c_first_sprd_allwd_flg :%c:", c_first_sprd_allwd_flg);
    }

    if((c_first_sprd_allwd_flg != 'Y') || (c_undsprd_allwd_flg != 'Y') || (SQLCODE == NO_DATA_FOUND))
    {
      fn_errlog( c_ServiceName, "B28514", " ",c_err_msg );
      return FAILURE;
    }
		/*** mrk 16-Oct-2019 ***/
		l_sprd_rate = st_first_ordbk.l_ord_lmt_rt;
    fn_userlog( c_ServiceName, "l_sprd_hprc:%ld: l_sprd_lprc:%ld: l_sprd_rate:%ld:", l_sprd_hprc,l_sprd_lprc,l_sprd_rate); 
		if ((l_sprd_rate > l_sprd_hprc) || (l_sprd_rate < l_sprd_lprc))
		{
      fn_errlog( c_ServiceName, "B28006", " ",c_err_msg );
      return FAILURE;
		}
		/*** mrk 16-Oct-2019 ***/

   EXEC SQL
   SELECT NVL(EXG_LMT_MAX_VAL,0) * 100 ,
          NVL(EXG_MAX_CUM_OPNORD_VAL,0) * 100
   INTO  :d_ord_max_lim_val,
         :d_cum_opnord_val
   FROM  EXG_XCHNG_MSTR
   WHERE EXG_XCHNG_CD = :st_first_ordbk.c_xchng_cd ;

  if ( SQLCODE != 0 )
  {
      fn_errlog( c_ServiceName,"S31965",SQLMSG,c_err_msg );
      return FAILURE;
  }

        EXEC SQL
        SELECT  NVL(SUM(DECODE(FOD_PRDCT_TYP,'O',(FOD_LMT_RT+FOD_STRK_PRC),'I',(FOD_LMT_RT+FOD_STRK_PRC),FOD_LMT_RT)*(FOD_ORDR_TOT_QTY - NVL(FOD_EXEC_QTY,0) - NVL(FOD_CNCL_QTY,0))),0)
         INTO    :d_tot_open_val
         FROM    FOD_FO_ORDR_DTLS , EXG_XCHNG_MSTR
         WHERE   FOD_TRD_DT = EXG_NXT_TRD_DT
         AND     FOD_XCHNG_CD = EXG_XCHNG_CD
         AND     EXG_XCHNG_CD = :st_first_ordbk.c_xchng_cd
         AND     FOD_ORDR_STTS IN ('R','O','Q','P')
         AND     FOD_SPL_FLAG NOT IN ('O')
         AND     FOD_CLM_MTCH_ACCNT = :st_first_ordbk.c_cln_mtch_accnt ;

   if ( SQLCODE != 0 && SQLCODE != NO_DATA_FOUND )
   {
      fn_errlog ( c_ServiceName, "L31200", SQLMSG, c_err_msg );
      return FAILURE;
   }

      l_sprd_rate = st_first_ordbk.l_ord_lmt_rt;
 
      if( l_sprd_rate >= 0)
      {
           d_lim_rate1 = d_lst_trd_prc1;
           d_lim_rate2 = d_lst_trd_prc2 + (double)l_sprd_rate;
      }
      else
      {
           d_lim_rate1 = d_lst_trd_prc1;
           if ( d_lst_trd_prc1 > d_lst_trd_prc2 )
           {
              d_lim_rate2 = d_lst_trd_prc1;
           }
           else
           {
              d_lim_rate2 = d_lst_trd_prc2;
           }
      }

      d_ordr_val = ((double)st_first_ordbk.l_ord_tot_qty * d_lim_rate1) + ((double)st_next_ordbk.l_ord_tot_qty* d_lim_rate2 );

    if(DEBUG_MSG_LVL_0)
    {
      fn_userlog( c_ServiceName, "d_ordr_val :%lf: and d_ord_max_lim_val :%lf:", d_ordr_val,d_ord_max_lim_val );
      fn_userlog( c_ServiceName, "d_lst_trd_prc1 :%lf: d_lst_trd_prc2 :%lf:",d_lst_trd_prc1,d_lst_trd_prc2);
      fn_userlog( c_ServiceName, "ord tot qty1 :%ld: ord tot qty2 :%ld:",st_first_ordbk.l_ord_tot_qty,st_next_ordbk.l_ord_tot_qty );
    }

  if( d_ordr_val > d_ord_max_lim_val )
  {
    fn_userlog( c_ServiceName, "Order value Exceeding Max Market/Limit value allowed.");
    sprintf(c_msg," (Max val:%.2lf)",d_ord_max_lim_val/100);
    fn_errlog( c_ServiceName, "B23035", "DEFMSG", c_err_msg  );
    strcat(c_err_msg ,c_msg);
    fn_userlog( c_ServiceName,"c_err_msg is :%s: c_msg is :%s:",c_err_msg,c_msg);
    return FAILURE;
  }


  EXEC SQL ALLOCATE :sys_cursor_snd;
  EXEC SQL EXECUTE
  BEGIN
  OPEN :sys_cursor_snd FOR
         SELECT FOD_ORDR_RFRNC,
                FOD_SLTP_ORDR_RFRNC, 
                FOD_EXPRY_DT,
                FOD_UNDRLYNG,
                FOD_EXER_TYP,
                FOD_LMT_RT,
                FOD_ORDR_TOT_QTY  
           FROM FOD_FO_ORDR_DTLS
          WHERE FOD_XCHNG_CD  = 'NFO' 
            AND FOD_ORDR_STTS IN ('R','O','Q','P')
            AND FOD_SPL_FLAG  = 'O'
            AND FOD_CLM_MTCH_ACCNT = :c_match_id;

  END;
  END-EXEC;

   if ( SQLCODE != 0 && SQLCODE != NO_DATA_FOUND )
   {
      fn_errlog ( c_ServiceName, "L31200", SQLMSG, c_err_msg );
      EXEC SQL CLOSE :sys_cursor_snd;
      EXEC SQL FREE  :sys_cursor_snd;
      return FAILURE;
   }

  
  while(1)
  {
    MEMSET(c_fod_ordr_ref);
    MEMSET(c_fod_sprd_ref);
    MEMSET(c_exp_dt);
    MEMSET(c_undrlng);
    c_exrc_typ='\0';
    l_lim_rt = 0;
    l_ordr_tot_qty =0;

        EXEC SQL
        FETCH  :sys_cursor_snd
           INTO :c_fod_ordr_ref,
                :c_fod_sprd_ref,
                :c_exp_dt,
                :c_undrlng,
                :c_exrc_typ,
                :l_lim_rt,
                :l_ordr_tot_qty;

  if( ( SQLCODE != 0 ) && ( SQLCODE != NO_DATA_FOUND ) )
  {
   fn_errlog ( c_ServiceName, "L31200", SQLMSG, c_err_msg ); 
   EXEC SQL CLOSE :sys_cursor_snd ;
   return FAILURE;
  }

  if( SQLCODE == NO_DATA_FOUND )
  {
   fn_userlog(c_ServiceName,"All records fetched or Inside No data found for Match Account");
    EXEC SQL CLOSE :sys_cursor_snd;
  EXEC SQL FREE  :sys_cursor_snd;
   break;
  }

     rtrim(c_fod_ordr_ref);  
     rtrim(c_fod_sprd_ref);

      fn_userlog( c_ServiceName, "c_sub_rqst_typ :%c: c_fod_ordr_ref :%s: st_first_ordbk.c_ordr_rfrnc :%s: c_fod_sprd_ref :%s:",c_sub_rqst_typ,c_fod_ordr_ref,st_first_ordbk.c_ordr_rfrnc,c_fod_sprd_ref);
     if( c_sub_rqst_typ == 'M' )
     {
          rtrim(st_first_ordbk.c_ordr_rfrnc);
      if( ( strcmp(c_fod_ordr_ref,st_first_ordbk.c_ordr_rfrnc) == 0 ) || ( strcmp( c_fod_sprd_ref,st_first_ordbk.c_ordr_rfrnc) == 0 ) )
      {
          fn_userlog( c_ServiceName, "MODIFICATION SKIPPING FOR :%s:",c_fod_ordr_ref);
          continue;
      }
     }

    fn_userlog( c_ServiceName, "SUCHITA c_exp_dt :%s",c_exp_dt);

    EXEC SQL
      SELECT  NVL(FTQ_LST_TRD_PRC,0.0)
      INTO    :d_temp_trd_prc
      FROM    FTQ_FO_TRD_QT
      WHERE   FTQ_XCHNG_CD = :st_next_ordbk.c_xchng_cd
      AND     FTQ_PRDCT_TYP ='F'
      AND     FTQ_UNDRLYNG = :c_undrlng
      AND     FTQ_EXPRY_DT = to_date (:c_exp_dt ,'dd-Mon-yyyy' )
      AND     FTQ_EXER_TYP = :c_exrc_typ;

    if ( SQLCODE != 0 && SQLCODE != NO_DATA_FOUND )
    {
      fn_errlog ( c_ServiceName, "L31200", SQLMSG, c_err_msg );
  EXEC SQL CLOSE :sys_cursor_snd;
  EXEC SQL FREE  :sys_cursor_snd;
      return FAILURE;
    }

   EXEC SQL
         SELECT NVL(FTQ_LST_TRD_PRC,0.0)
         INTO :d_temp_sltp_trd_prc
         FROM    FTQ_FO_TRD_QT,FOD_FO_ORDR_DTLS
      WHERE   FTQ_XCHNG_CD = :st_next_ordbk.c_xchng_cd
      AND     FTQ_PRDCT_TYP = FOD_PRDCT_TYP
      AND      FTQ_UNDRLYNG = FOD_UNDRLYNG
      AND       FTQ_EXPRY_DT = FOD_EXPRY_DT
      AND      FTQ_EXER_TYP = FOD_EXER_TYP
      AND    FOD_ORDR_RFRNC = :c_fod_sprd_ref;

    if ( SQLCODE != 0 && SQLCODE != NO_DATA_FOUND )
    {
      fn_errlog ( c_ServiceName, "L31200", SQLMSG, c_err_msg );
  EXEC SQL CLOSE :sys_cursor_snd;
  EXEC SQL FREE  :sys_cursor_snd;
      return FAILURE;
    }

     l_temp_sprd_rate = l_lim_rt;
     fn_userlog( c_ServiceName, "d_temp_trd_prc :%lf: d_temp_sltp_trd_prc :%lf: l_temp_sprd_rate :%ld:",d_temp_trd_prc,d_temp_sltp_trd_prc,l_temp_sprd_rate);  

     if(  atoll(c_fod_ordr_ref) > atoll(c_fod_sprd_ref) )
     {
          fn_userlog( c_ServiceName, "SKIPPING SLTP :%s:",c_fod_ordr_ref);
          continue;
     }

      if( l_temp_sprd_rate > 0 )
      {
           d_lim_rate_temp = d_temp_trd_prc + (double)l_sprd_rate;
      }
      else
      {
           if ( d_temp_trd_prc > d_temp_sltp_trd_prc )
           {
              d_lim_rate_temp = d_temp_trd_prc;
           }
           else
           {
              d_lim_rate_temp = d_temp_sltp_trd_prc;
           }
      } 
      fn_userlog( c_ServiceName, "l_ordr_tot_qty :%ld: d_lim_rate_temp :%lf: d_final_val :%lf:",l_ordr_tot_qty,d_lim_rate_temp,d_final_val);

      d_final_val = d_final_val + ( d_lim_rate_temp * l_ordr_tot_qty ); 
   }
  fn_userlog( c_ServiceName, "d_tot_open_val :%lf: d_ordr_val :%lf: d_final_val :%lf:",d_tot_open_val,d_ordr_val,d_final_val);

   if((d_tot_open_val + d_ordr_val +  d_final_val) > d_cum_opnord_val )
   {
     fn_userlog( c_ServiceName, "Order value Exceeding Max Market/Limit value allowed.");
     sprintf(c_msg," (Max val:%.2lf)",d_cum_opnord_val/100);
     fn_errlog( c_ServiceName, "B21077", "DEFMSG", c_err_msg  );
     strcat(c_err_msg ,c_msg);
     fn_userlog( c_ServiceName,"c_err_msg is :%s: c_msg is :%s:",c_err_msg,c_msg);
     return FAILURE;
  }

  return 0;
}

/*** Ver 2.8 Ends ***/
