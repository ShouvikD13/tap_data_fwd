/******************************************************************************/
/*  Program           : SFO_FOPK_DRCR                                          */
/*                                                                             */
/*                                                                             */
/*  Description      :This service is called from website and batch process to */
/*                      debit/credit peak margin amount                        */
/*                                                                             */
/*  Log               : 1.0  Akash Balasubramanian   01-Jul-2021               */
/*  Log               : 1.1  Ravi Malla							 09-Mar-2023	             */
/*  Log               : 1.2  RQ3117  Sahcin Birje	   24-Jun-2023	             */
/*  Log               : TOL  Tux on Linux            09-Aug-2023               */
/*******************************************************************************/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <atmi.h>
#include <fml32.h>
#include <sqlca.h>
#include <fo.h>
#include <fo_fml_def.h>
#include <fo_view_def.h>
#include <fn_session.h>
#include <fn_tuxlib.h>
#include <fn_ddr.h>
#include <fn_log.h>
#include <fn_read_debug_lvl.h>
#include <fn_get_gst_amt.h>
#include <fn_pp_card.h>
#include <fn_pos.h>
#include <fo_bank.h>

char c_err_msg[256];
char c_ServiceName[33];
int i_trnsctn=0; 
int i_rc=0;
int i_ret_val=0;
int i_ret_state=0;
int fn_ins_mbs(char *,char *,char *,char *,char *,char *,long ,char *,double,char *,char *,char,char *,char,char *,char *,char *,char *,char, char *,char *,char *,char *,char);
int fn_peak_flr_tbl( char *, char *, char *, long, char *, char *, char, int , char, double ,double,double, char, char,char, char*, char* ,char* ,char,char *);
int fn_pkupd_alloc_dtls ( char *,char *,char *,char *,char *,char*,char*,double,double,double,long,double *,double *);
int fn_ins_pkdtls( char *,char *,char *,double ,double ,double ,double ,double ,char *,long ,double ,char ,double ,char ,char *,double ,double ,double ,double ,char,char * );
int fn_insrt_peak_rpt_tbl(  char *,char *,char *,char *,double ,double , double ,double ,double ,double ,double ,double ,long  ,double ,double ,char *,char,char *  );

void SFO_FOPK_DRCR(  TPSVCINFO *rqst )
{
 FBFR32 *ptr_fml_Ibuf;
 
 struct vw_usr_prfl st_usr_prfl;

 char c_mtch_accnt[11];

 char c_payout_pool_acc_nse[21];
 char c_payin_pool_acc_nse[21];
 char c_payin_pool_nse_ac[21];
 char c_payout_pool_nse_ac[21];
 char c_payin_pool_acc_bse[21];
 char c_payout_pool_acc_bse[21];
 char c_trd_dt[12];
 char c_rqst_typ='\0';
 char c_xchng_cd[4];
 char c_blk_deposit_flg='\0';
 char c_dr_cr_flg='\0';
 char c_run_dt[12];
 char c_tag [ 256 ];              
 char c_msg [ 256 ];              
 char c_bnk_narration[51];        
 char c_reference[16];            
 char c_ServiceName[33];
 char c_timestamp [ 14 + 1 ];                                
 char c_bill_no[18];
 char c_narration[101];        
 char c_prdct_cd[20+1];        
 char c_pipo_src[20+1];        
 char c_accntng_typ[20+1];     
 char c_trace[13];             
 char c_bnk_acct_nmbr[21];     
 char c_sgmnt_cd[20+1];        
 char c_instrument_nmbr[20+1]; 
 char c_mdc_crdt_nmbr[20+1];   
 char c_mtch_series[20+1];     
 char c_class_svc[20+1];       
 char c_src_rowid[20+1];       
 char c_run_nmbr[20+1];
 char c_tran_date[23];
 char c_accntng_for;
 char c_xchng_input[10];  

 double d_val_bal= 0.0;
 double d_fcb_peak_amt=0.0;
 double d_alctd_amt=0.0;
 double d_bft_amt=0.0;
 double d_isec_mrgn=0.0;
 double d_fd_amt=0.0;
 double d_plg_amt=0.0;
 double d_payout_amt=0.0;  
 double d_blk4trd_amt=0.0; 
 double d_intadj_amt=0.0;  
 double d_bnk_pipo_amt=0.0;
 double d_eba_pipo_amt=0.0;
 double d_bnk_bft_amt=0.0; 
 double d_eba_bft_amt=0.0; 
 double d_peak_mrgn_debit=0.0;
 double d_pending_amt=0.0;
 double dd_debit_amt=0.0;
 double d_amount=0.0;
 double d_payin_amt=0.0;
 double d_final_amt=0.0;
 double d_debit_amt=0.0;
 double d_final_cr_amt=0.0;
 double d_new_alctd_amt=0.0;
 double d_new_bft_amt=0.0;
 double d_amt_dbt_frm_alctn=0.0;
 double d_amt_dbt_frm_bft =0.0;
 double d_amt_dbt_frm_alctn_s=0.0;
 double d_amt_dbt_frm_bft_s =0.0;
 double d_credit_amt=0.0;
 double d_final_dbamt=0;
 double d_trnsctn_amt=0.0;
 double d_alct_stts_amt=0;
 double d_bft_stts_amt=0;
 double d_nwb_amt=0.0;
 double d_undebited_amount=0.0;
 double d_fcb_peak_mrgn_debit=0;

 char c_bnk_accnt[21];
 char c_cln_mtch_accnt[11];
char c_peak_enblflg = 'N';	
 
 long li_run_no=0;

 int i_returncode;
 int i_trnsctn;
 int i_ch_val;
 int i_pending_flr_record=0;
  
 MEMSET(c_xchng_input);
 MEMSET(c_bnk_accnt);
 MEMSET(c_cln_mtch_accnt);
 MEMSET(c_mtch_accnt);
 MEMSET(c_payout_pool_acc_nse);
 MEMSET(c_payin_pool_acc_nse);
 MEMSET(c_payin_pool_nse_ac);
 MEMSET(c_payout_pool_nse_ac);
 MEMSET(c_payin_pool_acc_bse);
 MEMSET(c_payout_pool_acc_bse);
 MEMSET(c_trd_dt);
 MEMSET(c_xchng_cd);
 MEMSET(c_run_dt);
 MEMSET(c_tag);
 MEMSET(c_msg );
 MEMSET(c_bnk_narration);
 MEMSET(c_reference);
 MEMSET(c_ServiceName);
 MEMSET(c_timestamp);
 MEMSET(c_bill_no);
 MEMSET(c_narration);
 MEMSET(c_prdct_cd);
 MEMSET(c_pipo_src);
 MEMSET(c_accntng_typ);
 MEMSET(c_trace);
 MEMSET(c_bnk_acct_nmbr);
 MEMSET(c_sgmnt_cd);
 MEMSET(c_instrument_nmbr);
 MEMSET(c_mdc_crdt_nmbr);
 MEMSET(c_mtch_series);
 MEMSET(c_class_svc);
 MEMSET(c_src_rowid);
 MEMSET(c_run_nmbr);
 MEMSET(c_tran_date);



 
 ptr_fml_Ibuf = (FBFR32 *)rqst->data;
 strcpy( c_ServiceName,rqst->name );

 i_returncode = fn_unpack_fmltovar_dflt ( c_ServiceName,
                                     c_err_msg,
                                     ptr_fml_Ibuf,
                                     4,
                                     FFO_EBA_MTCH_ACT_NO, ( char * )c_cln_mtch_accnt,NULL,
                                     FFO_ORD_VALID_DT, ( char * )c_trd_dt,NULL,
                                     FFO_AMOUNT,( char * )&d_amount,NULL,
                                     FFO_RQST_TYP,( char *)&c_rqst_typ,NULL
                                     );

 if ( i_returncode == -1 )
 {
  fn_errlog( c_ServiceName, "S31005", FMLMSG, c_err_msg  );
  Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );  /** Ver 1.1 **/
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 }

 if(DEBUG_MSG_LVL_3)
 {	
 	 fn_userlog(c_ServiceName,"Match Account :%s:",c_cln_mtch_accnt);
 	 fn_userlog(c_ServiceName,"Trade Date :%s:",c_trd_dt);
 	 fn_userlog(c_ServiceName,"Amount :%lf:",d_amount);
 }
 strcpy(c_run_dt,c_trd_dt);
 rtrim(c_run_dt);
 rtrim(c_trd_dt);


 EXEC SQL
 SELECT NVL(USR_FUND_MODEL_FLG,'N')
 INTO  :c_blk_deposit_flg
 from USR_USER_MASTER,UAC_USR_ACCNTS
 where USR_USR_ID=UAC_USR_ID
 and UAC_CLM_MTCH_ACCNT=:c_cln_mtch_accnt;

 if (SQLCODE != 0)
 {
  fn_errlog( c_ServiceName, "S31010", SQLMSG, c_err_msg );
  Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 ); 
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 }

 if ( c_blk_deposit_flg != 'B')
 {
  fn_errlog( c_ServiceName, "S31015",LIBMSG,c_err_msg);
  /**strcpy(c_err_msg,"Skipping . Valid only for block  Customers.");**/
  strcpy(c_err_msg,"Skipping : Valid only for Bill to Bill Settlement Customers .");
  Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 ); 
 }

/* Find count of failure records for rerurn*/
if( c_rqst_typ =='S' )
{
  MEMSET(c_trd_dt);	
	EXEC SQL
	SELECT EXG_NXT_TRD_DT
	INTO  :c_trd_dt
	FROM  EXG_XCHNG_MSTR
	WHERE	EXG_XCHNG_CD = 'NFO';

	if ( SQLCODE != 0 )
  {
     fn_errlog( c_ServiceName, "S31020",SQLMSG,c_err_msg);
     fn_userlog(c_ServiceName,"Error in fetching exchange trade date from EXG_XCHNG_MSTR.");
     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

	strcpy(c_run_dt,c_trd_dt);
 	rtrim(c_run_dt);
 	rtrim(c_trd_dt);	

  EXEC SQL
  select NVL(FSP_PEAKMRGN_ENBLFLG,'N')
  INTO :c_peak_enblflg
  FROM FSP_FO_SYSTM_PRMTR;
	
  if ( SQLCODE != 0 )
  {
     fn_errlog( c_ServiceName, "S31025",SQLMSG,c_err_msg);
      fn_userlog(c_ServiceName,"Error in fetching data");
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
  if( c_peak_enblflg != 'Y')
  {
    strcpy(c_err_msg,"This feature is currently not enabled.");
    fn_userlog(c_ServiceName,"ERROR........ :%s:",c_err_msg);
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

	EXEC SQL
 	SELECT COUNT(*)
 	INTO :i_pending_flr_record
 	FROM FPD_FO_PEAKMRGN_DTLS
 	WHERE FPD_CLM_MTCH_ACCNT=:c_cln_mtch_accnt
 	AND FPD_TRD_DT=:c_trd_dt 
 	AND FPD_BATCH_SITE_IND='S'
 	AND FPD_STATUS_FLG='N';

 	if (SQLCODE != 0)
 	{
  	fn_errlog( c_ServiceName, "S31030", SQLMSG, c_err_msg );
  	Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
  	tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 	} 

 	if ( i_pending_flr_record > 0 )
 	{
  	fn_userlog(c_ServiceName,"Pending un-confirmed failure exist.Rerun required");\
  	strcpy(c_err_msg,"Status of your Previous transaction is still under process. Please try after some time.");
  	Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
  	tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 	}
}

 i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

 if ( i_trnsctn == -1 )
 {
  fn_errlog(c_ServiceName, "L31325", LIBMSG, c_err_msg);
  strcpy ( c_msg, "System error. Contact system support" );
  fn_userlog(c_ServiceName,"Error in begin tran of fn_upd_adm_alloc_dtls");
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 }

 i_returncode = fn_lock_usr( c_ServiceName, c_cln_mtch_accnt );

 if ( i_returncode != 0 )
 {
  fn_errlog(c_ServiceName, "L31330",LIBMSG,c_err_msg);
  fn_userlog(c_ServiceName,"Error in lock of fn_upd_adm_alloc_dtls");
  fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 }

	/* Ver 1.1 start */
 i_returncode = fn_lock_fno( c_ServiceName, c_cln_mtch_accnt );

 if ( i_returncode != 0 )
 {
  fn_errlog(c_ServiceName, "L31331",LIBMSG,c_err_msg);
  fn_userlog(c_ServiceName,"Error in lock of fn_upd_adm_alloc_dtls");
  fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 }
	/* Ver 1.1 end */


/* Find peak Margin for a particular user on trade date */
  d_fcb_peak_mrgn_debit=0;
  EXEC SQL 
  SELECT  NVL(FCB_DAY_PEAK_MARGIN,0),
          NVL(FCB_PEAK_MARGIN_DEBIT,0)
  INTO    :d_fcb_peak_amt,
          :d_fcb_peak_mrgn_debit
  FROM  fcb_fo_clnt_blncs
  WHERE fcb_xchng_cd = 'NFO'
  AND fcb_trd_dt  = :c_trd_dt 
  AND fcb_grp_id  = '1'
  AND fcb_clm_mtch_accnt=:c_cln_mtch_accnt;

  if (SQLCODE != 0)
  {
   fn_errlog( c_ServiceName, "S31035", SQLMSG, c_err_msg );
   fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
   Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }


 if ( d_fcb_peak_amt == 0 )
 {
  strcpy(c_err_msg,"Peak Margin amount is zero");
  fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
  Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 ); 
 }



/* Selecting allocated amount,bft amnt,isec margin,fd amount,pledge amount,bank amount,nwb amount from FAB table */
 EXEC SQL
 SELECT NVL(FAB_ALCTD_AMT,0),
      	NVL(FAB_BFT_AMT,0),
       	NVL(FAB_ISEC_MRGN_AMT,0),
       	NVL(FAB_FDR_AMT,0),
       	NVL(FAB_PLG_AMT,0),
        FAB_BNK_ACCNT,
        NVL(FAB_NWB_AMT,0)
 INTO  :d_alctd_amt,
       :d_bft_amt,
       :d_isec_mrgn,
       :d_fd_amt,
       :d_plg_amt,
       :c_bnk_accnt,
       :d_nwb_amt
 FROM FAB_FO_ALC_BFT_SMRY , CLB_BNK_ACCTS
 WHERE FAB_CLM_MTCH_ACCNT = :c_cln_mtch_accnt
 AND CLB_CLM_MTCH_ACCNT = FAB_CLM_MTCH_ACCNT;

 if (SQLCODE != 0)
 {
  fn_errlog( c_ServiceName, "S31040", SQLMSG, c_err_msg );
  fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
  fn_userlog(c_ServiceName,"Error in fetching data");
  Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 }

 rtrim(c_bnk_accnt);
 strcpy(st_usr_prfl.c_user_id,"system");
 strcpy(st_usr_prfl.c_cln_mtch_accnt,c_cln_mtch_accnt);
 strcpy(st_usr_prfl.c_bnk_accnt_nmbr[0],c_bnk_accnt);
 st_usr_prfl.l_session_id = 0;

 rtrim(st_usr_prfl.c_bnk_accnt_nmbr[0]);
 if(DEBUG_MSG_LVL_3)
 {
 	 fn_userlog(c_ServiceName,"st_usr_prfl.c_user_id :%s:",st_usr_prfl.c_user_id);
 	 fn_userlog(c_ServiceName,"st_usr_prfl.c_cln_mtch_accnt :%s:",st_usr_prfl.c_cln_mtch_accnt);
 	 fn_userlog(c_ServiceName,"st_usr_prfl.c_bnk_accnt_nmbr[0] :%s:",st_usr_prfl.c_bnk_accnt_nmbr[0]);
 	 fn_userlog(c_ServiceName,"d_alctd_amt :%lf:",d_alctd_amt);
   fn_userlog(c_ServiceName,"d_bft_amt :%lf:",d_bft_amt);
   fn_userlog(c_ServiceName,"d_isec_mrgn :%lf:",d_isec_mrgn);
   fn_userlog(c_ServiceName,"d_fd_amt :%lf:",d_fd_amt);
   fn_userlog(c_ServiceName,"d_plg_amt :%lf:",d_plg_amt);
   fn_userlog(c_ServiceName,"d_fcb_peak_amt :%lf:",d_fcb_peak_amt);
 } 

 d_peak_mrgn_debit = d_fcb_peak_amt - ( d_isec_mrgn + d_fd_amt + d_plg_amt );

 fn_userlog(c_ServiceName,"d_peak_mrgn_debit :%lf:",d_peak_mrgn_debit);

 if( d_peak_mrgn_debit <= 0 )
 {
  fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
  fn_userlog(c_ServiceName,"Nothing to Debit, so skiping");
  tpreturn ( TPSUCCESS, SUCC_BFR, ( char * )ptr_fml_Ibuf, 0, 0 );
 }

 if( d_peak_mrgn_debit <= d_fcb_peak_mrgn_debit )
 {
  fn_userlog(c_ServiceName,"  Required peak margin already Debited, So skiping");
  fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
  fn_userlog(c_ServiceName,"Nothing to Debit, so skiping");
  tpreturn ( TPSUCCESS, SUCC_BFR, ( char * )ptr_fml_Ibuf, 0, 0 ); 
 }

 if ( d_peak_mrgn_debit <  d_alctd_amt )
 {
   d_amt_dbt_frm_alctn = d_peak_mrgn_debit; 
   d_amt_dbt_frm_bft = 0;
 }
 else
 {
   d_amt_dbt_frm_alctn = d_alctd_amt;
	 if( d_bft_amt > 0 )
   {
   	d_amt_dbt_frm_bft = d_peak_mrgn_debit - d_amt_dbt_frm_alctn; 
 
    if( d_amt_dbt_frm_bft >  d_bft_amt )
    {
      d_amt_dbt_frm_bft = d_bft_amt;
    } 
    
 	 }
} 

 strcpy(c_xchng_cd,"NFO");
 if(DEBUG_MSG_LVL_3)
 {
 		fn_userlog(c_ServiceName,"d_amt_dbt_frm_alctn :%lf:",d_amt_dbt_frm_alctn);
 		fn_userlog(c_ServiceName,"d_amt_dbt_frm_bft :%lf:",d_amt_dbt_frm_bft);
 }	
 /***** Fetch Run No ***********/

 EXEC SQL
 SELECT FRC_RUN_NO
 INTO :li_run_no
 FROM FRC_FNOPK_RUNNO_CALC
 WHERE FRC_TRD_DT = :c_trd_dt;
 
 if ( SQLCODE != 0 && SQLCODE!= NO_DATA_FOUND)
 {
  fn_errlog( c_ServiceName, "L31335",SQLMSG,c_err_msg);
  fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
  fn_userlog(c_ServiceName,"Error in fetching run no");
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 }

 if ( SQLCODE == NO_DATA_FOUND )
 {
   EXEC SQL
   SELECT fno_peakno_seq.nextval
   INTO :li_run_no
   FROM DUAL;
   
   if ( SQLCODE != 0 ) 
   {
    fn_errlog( c_ServiceName, "S31045",SQLMSG,c_err_msg);
    fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
    fn_userlog(c_ServiceName,"Error in in Selecting sequence");
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }
  
   EXEC SQL
   INSERT INTO FRC_FNOPK_RUNNO_CALC (FRC_TRD_DT,FRC_RUN_NO)
   VALUES (:c_trd_dt,:li_run_no);
 
   if ( SQLCODE != 0 )
   {
    fn_errlog( c_ServiceName, "S31050",SQLMSG,c_err_msg);
    fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
    fn_userlog(c_ServiceName,"Error in insert Run no");
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }
 
/***
	 if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
 	{
  	fn_errlog( c_ServiceName, "L31345",LIBMSG,c_err_msg);
  	fn_userlog(c_ServiceName,"Error in commit tran");
  	fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
  	tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 	}
***/

}

 /****** Insert Match Account Details in FPD Table ********/
	
	EXEC SQL
  SELECT 'ADM'||to_char(sysdate,'YYYYMMDD')||LPAD(pipoadmseq.nextval,6,0)
  INTO :c_bill_no
  FROM   DUAL;
	
 if ( SQLCODE != 0 && SQLCODE!= NO_DATA_FOUND)
 {
  fn_errlog( c_ServiceName, "S31055",SQLMSG,c_err_msg);
  fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
  fn_userlog(c_ServiceName,"Error in fetching run no");
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 }


 i_returncode =  fn_ins_pkdtls( c_cln_mtch_accnt, 
 							                  c_bnk_accnt, 
              	 	    		      c_trd_dt,
   								              d_fcb_peak_amt, 
             								    d_plg_amt,
                                d_alctd_amt, 
                                d_bft_amt, 
                                d_isec_mrgn, 
             								    c_trd_dt, 
          									    li_run_no, 
       													d_peak_mrgn_debit, 
     														'D', 
                                d_nwb_amt, 
																c_rqst_typ,
               								  c_xchng_cd,
           								      d_amt_dbt_frm_alctn, 
                                d_amt_dbt_frm_bft, 
 																d_fd_amt,  /** old and new fd amount passed same **/ 
																d_fd_amt,              
															  c_blk_deposit_flg,
																c_bill_no  
           										  );

 if ( i_returncode != 0 )
 {
  fn_errlog( c_ServiceName, "S31060",LIBMSG,c_err_msg);
  fn_userlog(c_ServiceName,"Error in insert OF FPD");
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 }

if( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
 {
  fn_errlog( c_ServiceName, "L31345",LIBMSG,c_err_msg);
  fn_userlog(c_ServiceName,"Error in commit tran");
  fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 }

 strcat(c_xchng_input,c_xchng_cd);
 strcat(c_xchng_input,"PKM");
 rtrim(c_xchng_input);
 	
 /****** Unblock Debit from Allocation Starts  **********/ 
 
 if ( d_amt_dbt_frm_alctn > 0 )
 {
 i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

 if ( i_trnsctn == -1 )
 {
  fn_errlog(c_ServiceName, "L31325", LIBMSG, c_err_msg);
  strcpy ( c_msg, "System error. Contact system support" );
  fn_userlog(c_ServiceName,"Error in begin tran of fn_upd_adm_alloc_dtls");
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 }

 i_returncode = fn_lock_usr( c_ServiceName, c_cln_mtch_accnt );

 if ( i_returncode != 0 )
 {
  fn_errlog(c_ServiceName, "L31330",LIBMSG,c_err_msg);
  fn_userlog(c_ServiceName,"Error in lock of fn_upd_adm_alloc_dtls");
  fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 ); 
 }
	/* Ver 1.1 start */
 i_returncode = fn_lock_fno( c_ServiceName, c_cln_mtch_accnt );

 if ( i_returncode != 0 )
 {
  fn_errlog(c_ServiceName, "L31331",LIBMSG,c_err_msg);
  fn_userlog(c_ServiceName,"Error in lock of fn_upd_adm_alloc_dtls");
  fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 }
	/* Ver 1.1 end */

 /****** Sending Unblock Debit Mesaage to bank ************/

 strcpy( c_timestamp, "01-Jan-1980" );
 c_dr_cr_flg = UD ;
 sprintf(c_bnk_narration,"FNOPEAKMG%s",c_run_dt);
 i_ch_val =  fn_send_bnk_msg ( &st_usr_prfl,
                               c_dr_cr_flg,
                               FO_BLK_CD,
                               d_amt_dbt_frm_alctn, 
                               BACKOFFICE,
                               c_ServiceName,
                               c_err_msg,
                               &d_val_bal,
                               c_reference,
                               c_timestamp,
                               c_bnk_narration, 
                               c_xchng_input,    
                               li_run_no);   


 switch ( i_ch_val )
 {
  case SUCCESS :
  fn_userlog(c_ServiceName,"In bank Success");
  d_amt_dbt_frm_alctn_s = d_amt_dbt_frm_alctn;
  rtrim(c_bnk_narration); 

  i_returncode =  fn_pkupd_alloc_dtls ( c_ServiceName,
                                    c_err_msg,
                                    c_cln_mtch_accnt,
                                    c_xchng_cd,
                                    c_run_dt,
                                    c_bnk_accnt,
                                    c_tag,
                                    0, 
                                    d_amt_dbt_frm_alctn * (-1), 
                                    d_amt_dbt_frm_alctn, 
                                    li_run_no,
                                    &d_new_alctd_amt,
																		&d_new_bft_amt);

  if ( i_returncode != 0 )
  {
   fn_errlog(c_ServiceName, "S31065",LIBMSG,c_err_msg);
   fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg ); 

   i_ret_val = fn_peak_flr_tbl( c_ServiceName,
                               c_xchng_cd,
                               c_cln_mtch_accnt,
                               li_run_no,
                               c_run_dt,
                               c_bnk_accnt,
                               UNBLOCK_DEBIT,
                               ALLOCATION_DEBIT_ON_PAYIN, 
                               DEBIT, /* ignore */
                               d_amt_dbt_frm_alctn, 
                               d_amt_dbt_frm_alctn,
														 	 d_amt_dbt_frm_bft, 
                               UPDATED, 
                               NOT_UPDATED,
                               NOT_UPDATED,     
                               c_reference,
                               c_timestamp,
                               c_bnk_narration,  
                               c_blk_deposit_flg,
                               c_bill_no ); 


   if ( i_ret_val != 0 )
   {
    strcpy ( c_msg, "System error. Contact system support" );
    d_payout_amt = 0;
    d_intadj_amt = 0;
    d_blk4trd_amt = d_bft_amt; 
    d_bnk_bft_amt = d_bft_amt;
    d_eba_bft_amt = d_bft_amt;
    d_bnk_pipo_amt = 0; 
    d_eba_pipo_amt = 0;
  
    fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    i_rc  = fn_insrt_peak_rpt_tbl(  c_ServiceName,
                                    c_xchng_cd,
                                    c_cln_mtch_accnt,
                                    c_run_dt,
                                    d_payout_amt,
                                    d_blk4trd_amt,
                                    d_amt_dbt_frm_alctn, 
                                    d_intadj_amt,
                                    d_bnk_pipo_amt,
                                    d_eba_pipo_amt,
                                    d_bnk_bft_amt,
                                    d_eba_bft_amt,
                                    li_run_no,
                                    0, 
                                    0, 
                                    c_bnk_narration,  
                                    c_blk_deposit_flg,
                                    c_bill_no); 


     if ( i_rc != 0 )
     {
      fn_errlog(c_ServiceName, "S31070",LIBMSG,c_err_msg);
      strcpy( c_msg, "System error. Contact system support" );
      fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
     }
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
 
  if(DEBUG_MSG_LVL_3)
  {
  	fn_userlog(c_ServiceName,"Updating FPD table");
  	fn_userlog(c_ServiceName,"Bill No :%s:",c_bill_no);
  	fn_userlog(c_ServiceName,"d_amt_dbt_frm_alctn :%lf:",d_amt_dbt_frm_alctn);
  	fn_userlog(c_ServiceName,"d_new_alctd_amt :%lf:",d_new_alctd_amt);
  	fn_userlog(c_ServiceName,"d_new_bft_amt :%lf:",d_new_bft_amt); 
		fn_userlog(c_ServiceName,"c_rqst_typ :%c:",c_rqst_typ);
	}

  EXEC SQL
  UPDATE FPD_FO_PEAKMRGN_DTLS
  SET FPD_BILL_NO = :c_bill_no,
      FPD_DBCR_CD = 'D',
     FPD_NEW_ISEC_MRGN_AMT = NVL(FPD_NEW_ISEC_MRGN_AMT,0) + :d_amt_dbt_frm_alctn ,
     FPD_PEAK_MARGIN_DEBITED = NVL(FPD_PEAK_MARGIN_DEBITED,0) + :d_amt_dbt_frm_alctn,
     FPD_ALCT_DB_AMT = :d_amt_dbt_frm_alctn,
     FPD_STATUS_FLG ='Y',
     FPD_NEW_ALCTD_AMT=:d_new_alctd_amt,
     FPD_NEW_BFT_AMT=:d_new_bft_amt 
  WHERE FPD_CLM_MTCH_ACCNT =:c_cln_mtch_accnt
  AND FPD_TRD_DT =:c_trd_dt
  AND FPD_RUN_NO =:li_run_no
  AND FPD_BATCH_SITE_IND =:c_rqst_typ
  AND FPD_STATUS_FLG!='F'
	AND FPD_BILL_NO = :c_bill_no;
 /***	 AND FPD_BILL_NO is NULL;	***/

 if ( SQLCODE != 0 )
 {
  fn_errlog( c_ServiceName, "S31075",SQLMSG,c_err_msg);
  fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
  i_ret_val = fn_peak_flr_tbl( c_ServiceName,
                               c_xchng_cd,
                               c_cln_mtch_accnt,
                               li_run_no,
                               c_run_dt,
                               c_bnk_accnt,
                               UNBLOCK_DEBIT,
                               ALLOCATION_DEBIT_ON_PAYIN,
                               DEBIT, /* ignore */
                               d_amt_dbt_frm_alctn,
                               d_amt_dbt_frm_alctn,
                               d_amt_dbt_frm_bft,
                               UPDATED,
                               NOT_UPDATED,
                               NOT_UPDATED,
                               c_reference,
                               c_timestamp,
                               c_bnk_narration,
                               c_blk_deposit_flg,
                               c_bill_no );

  fn_userlog(c_ServiceName,"Error in updating data");
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 } 

  d_payout_amt = 0;
  d_intadj_amt = 0;
  d_blk4trd_amt = d_new_bft_amt;
  d_bnk_bft_amt = d_new_bft_amt;
  d_eba_bft_amt = d_new_bft_amt;
  d_bnk_pipo_amt = d_amt_dbt_frm_alctn;
  d_eba_pipo_amt = d_amt_dbt_frm_alctn ;

  i_rc  = fn_insrt_peak_rpt_tbl(  c_ServiceName,
                                  c_xchng_cd,
                                  c_cln_mtch_accnt,
                                  c_run_dt,
                                  d_payout_amt,
                                  d_blk4trd_amt,
                                  d_amt_dbt_frm_alctn, 
                                  d_intadj_amt,
                                  d_bnk_pipo_amt,
                                  d_eba_pipo_amt,
                                  d_bnk_bft_amt,
                                  d_eba_bft_amt,
                                  li_run_no,
                                  d_amt_dbt_frm_alctn,  
                                  d_amt_dbt_frm_alctn,
                                  c_bnk_narration,     
                                  c_blk_deposit_flg,
                                  c_bill_no); 

  if ( i_rc != 0 )
  {
   fn_errlog(c_ServiceName, "S31080",LIBMSG,c_err_msg);
   strcpy( c_msg, "System error. Contact system support" );
   fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
   fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
   i_ret_val = fn_peak_flr_tbl( c_ServiceName,
                               c_xchng_cd,
                               c_cln_mtch_accnt,
                               li_run_no,
                               c_run_dt,
                               c_bnk_accnt,
                               UNBLOCK_DEBIT,
                               ALLOCATION_DEBIT_ON_PAYIN,
                               DEBIT, /* ignore */
                               d_amt_dbt_frm_alctn,
                               d_amt_dbt_frm_alctn,
                               d_amt_dbt_frm_bft,
                               UPDATED,
                               NOT_UPDATED,
                               NOT_UPDATED,
                               c_reference,
                               c_timestamp,
                               c_bnk_narration,
                               c_blk_deposit_flg,
                               c_bill_no );
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  strcpy(c_pipo_src,"DEBIT");
  strcpy(c_prdct_cd,"NFOPKMI");
  strcpy(c_class_svc,"SFO_ADM_UPLD");
  c_accntng_for='I';
  d_trnsctn_amt=d_amt_dbt_frm_alctn/100;
  sprintf(c_narration,"Being Cash Margin Debited Against Open Position in NSE %s",c_trd_dt);
  strcpy(c_trace,c_reference);
  strcpy(c_mtch_series,c_bill_no);
  rtrim(c_src_rowid);
  rtrim(c_pipo_src);
  sprintf(c_run_nmbr, "%lu" ,li_run_no);

	MEMSET(c_xchng_cd);
  strcpy(c_xchng_cd,"NFO");

  i_rc =  fn_ins_mbs(c_ServiceName,
	                   c_cln_mtch_accnt,
	        	      	 c_xchng_cd,
			               c_prdct_cd,
	              		 c_pipo_src,
			               c_sgmnt_cd,
			               0,
			               c_tran_date,
	              		 d_trnsctn_amt,
			               c_run_nmbr,
			               c_instrument_nmbr,
	              		 '\0',                   /* \0 Added in Ver TOL */
			               c_mdc_crdt_nmbr,
			               c_accntng_for, 
		               	 c_accntng_typ,
		               	 c_trace,
			               c_bnk_acct_nmbr, 
			               c_narration,
	              		 'D', 
		              	 c_mtch_series,
			               c_class_svc,
			               c_src_rowid,
		              	 c_err_msg,
			               c_blk_deposit_flg);
  
 if ( i_rc != 0 ) 
 {
  fn_errlog(c_ServiceName, "S31085",LIBMSG,c_err_msg);
  fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );

  i_ret_val = fn_peak_flr_tbl( c_ServiceName,
                               c_xchng_cd,
                               c_cln_mtch_accnt,
                               li_run_no,
                               c_run_dt,
                               c_bnk_accnt,
                               UNBLOCK_DEBIT,
                               ALLOCATION_DEBIT_ON_PAYIN,
                               DEBIT, /* ignore */
                               d_amt_dbt_frm_alctn,
                               d_amt_dbt_frm_alctn,
                               d_amt_dbt_frm_bft,
                               UPDATED,
                               NOT_UPDATED,
                               NOT_UPDATED,
                               c_reference,
                               c_timestamp,
                               c_bnk_narration,
                               c_blk_deposit_flg,
                               c_bill_no);


  if ( i_ret_val != 0 )
  {
   d_blk4trd_amt = d_bft_amt;
   d_bnk_bft_amt = d_bft_amt;
   d_eba_bft_amt = d_bft_amt;
   d_bnk_pipo_amt = 0; 
   d_eba_pipo_amt = 0;
   
   strcpy ( c_msg, "System error. Contact system support" );
   fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
   i_rc  = fn_insrt_peak_rpt_tbl(  c_ServiceName,
                                   c_xchng_cd,
                                   c_cln_mtch_accnt,
                                   c_run_dt,
                                   d_payout_amt,
                                   d_blk4trd_amt,
                                   d_amt_dbt_frm_alctn,
                                   d_intadj_amt,
                                   d_bnk_pipo_amt,
                                   d_eba_pipo_amt,
                                   d_bnk_bft_amt,
                                   d_eba_bft_amt,
                                   li_run_no,
                                   0,
                                   0,
                                   c_bnk_narration,
                                   c_blk_deposit_flg,
                                   c_bill_no);


    if ( i_rc != 0 )
    {
     fn_errlog(c_ServiceName, "S31090",LIBMSG,c_err_msg);
     strcpy( c_msg, "System error. Contact system support" );
     fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 }

 fn_userlog(c_ServiceName,"Updating fcb");

  EXEC SQL
  UPDATE FCB_FO_CLNT_BLNCS
  SET FCB_PEAK_MARGIN_DEBIT = :d_amt_dbt_frm_alctn 
  WHERE FCB_GRP_ID ='1'
  AND FCB_TRD_DT = :c_trd_dt
  AND FCB_XCHNG_CD ='NFO'
  AND FCB_CLM_MTCH_ACCNT=:c_cln_mtch_accnt;

  if ( SQLCODE != 0 )
  {
   fn_errlog( c_ServiceName, "L31335",SQLMSG,c_err_msg);
   fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
   strcpy( c_msg, "System error. Contact system support" );
   fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
   i_ret_val = fn_peak_flr_tbl( c_ServiceName,
                               c_xchng_cd,
                               c_cln_mtch_accnt,
                               li_run_no,
                               c_run_dt,
                               c_bnk_accnt,
                               UNBLOCK_DEBIT,
                               ALLOCATION_DEBIT_ON_PAYIN,
                               DEBIT, /* ignore */
                               d_amt_dbt_frm_alctn,
                               d_amt_dbt_frm_alctn,
                               d_amt_dbt_frm_bft,
                               UPDATED,
                               NOT_UPDATED,
                               NOT_UPDATED,
                               c_reference,
                               c_timestamp,
                               c_bnk_narration,
                               c_blk_deposit_flg,
                               c_bill_no );
   fn_userlog(c_ServiceName,"Error in updating data");
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

 
  if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
  {
   fn_errlog( c_ServiceName, "L31345",LIBMSG,c_err_msg);
   fn_userlog(c_ServiceName,"Error in commit tran");
   fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
 
  fn_userlog(c_ServiceName,"Unblock debit success from Allocation");

  break;

  case GENERAL_FAILURE :
  case INSUF_FUNDS :
  fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
  fn_userlog(c_ServiceName,"In General Failure and Insufficient funds");
  fn_errlog(c_ServiceName, "S31095",LIBMSG,c_err_msg);
  
  sprintf(c_msg,"Error sending BFT debit message on Pay in to bank for %s",c_cln_mtch_accnt);
  fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
   rtrim(c_bnk_narration);

  i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

  if ( i_trnsctn == -1 )
  {
   fn_errlog(c_ServiceName, "L31325", LIBMSG, c_err_msg);
   strcpy ( c_msg, "System error. Contact system support" );
   fn_userlog(c_ServiceName,"Error in begin tran of fn_upd_adm_alloc_dtls");
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  EXEC SQL
  UPDATE FPD_FO_PEAKMRGN_DTLS
  SET       FPD_STATUS_FLG ='F'
  WHERE FPD_CLM_MTCH_ACCNT =:c_cln_mtch_accnt
  AND FPD_TRD_DT =:c_trd_dt
  AND FPD_RUN_NO =:li_run_no
  AND FPD_BATCH_SITE_IND =:c_rqst_typ
	AND FPD_BILL_NO=:c_bill_no;

  if ( SQLCODE != 0 )
  {
   fn_errlog( c_ServiceName, "L31335",SQLMSG,c_err_msg);
   fn_userlog(c_ServiceName,"Error in fetching data");
   fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
  {
   fn_errlog( c_ServiceName, "L31345",LIBMSG,c_err_msg);
   fn_userlog(c_ServiceName,"Error in commit tran");
   fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  d_blk4trd_amt = d_bft_amt;
  d_bnk_bft_amt = d_bft_amt;
  d_eba_bft_amt = d_bft_amt;
  d_bnk_pipo_amt = 0;
  d_eba_pipo_amt = 0;

  i_rc  = fn_insrt_peak_rpt_tbl(  c_ServiceName,
                                  c_xchng_cd,
                                  c_cln_mtch_accnt,
                                  c_run_dt,
                                  d_payout_amt,
                                  d_blk4trd_amt,
                                  d_amt_dbt_frm_alctn, 
                                  d_intadj_amt,
                                  d_bnk_pipo_amt,
                                  d_eba_pipo_amt,
                                  d_bnk_bft_amt,
                                  d_eba_bft_amt,
                                  li_run_no,
                                  0,
                                  0, 
                                  c_bnk_narration,    
                                  c_blk_deposit_flg,
                                  c_bill_no); 


  if ( i_rc != 0 )
  {
   fn_errlog(c_ServiceName, "S31100",LIBMSG,c_err_msg);
   strcpy( c_msg, "System error. Contact system support" );
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  break;
    
  case BLOCK_NOT_EXISTING :
  case 100:
  fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
  fn_userlog(c_ServiceName,"In Block not existing and case 100");
  sprintf (c_msg,"Error sending BFT debit message on Pay in to bank for %s",c_cln_mtch_accnt);
   rtrim(c_bnk_narration);

  i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

  if ( i_trnsctn == -1 )
  {
   fn_errlog(c_ServiceName, "L31325", LIBMSG, c_err_msg);
   strcpy ( c_msg, "System error. Contact system support" );
   fn_userlog(c_ServiceName,"Error in begin tran of fn_upd_adm_alloc_dtls");
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
 
  EXEC SQL
  UPDATE FPD_FO_PEAKMRGN_DTLS
  SET    FPD_STATUS_FLG ='F'
  WHERE FPD_CLM_MTCH_ACCNT =:c_cln_mtch_accnt
  AND FPD_TRD_DT =:c_trd_dt
  AND FPD_RUN_NO =:li_run_no
  AND FPD_BATCH_SITE_IND =:c_rqst_typ
	AND FPD_BILL_NO=:c_bill_no;

  if ( SQLCODE != 0 )
  {
   fn_errlog( c_ServiceName, "L31335",SQLMSG,c_err_msg);
   fn_userlog(c_ServiceName,"Error in fetching data");
   fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
  {
   fn_errlog( c_ServiceName, "L31345",LIBMSG,c_err_msg);
   fn_userlog(c_ServiceName,"Error in commit tran");
   fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }


  d_blk4trd_amt = d_bft_amt;
  d_bnk_bft_amt = d_bft_amt;
  d_eba_bft_amt = d_bft_amt;
  d_bnk_pipo_amt = 0;
  d_eba_pipo_amt = 0;

  i_rc  = fn_insrt_peak_rpt_tbl(  c_ServiceName,
                                  c_xchng_cd,
                                  c_cln_mtch_accnt,
                                  c_run_dt,
                                  d_payout_amt,
                                  d_blk4trd_amt,
                                  d_amt_dbt_frm_alctn, 
                                  d_intadj_amt,
                                  d_bnk_pipo_amt,
                                  d_eba_pipo_amt,
                                  d_bnk_bft_amt,
                                  d_eba_bft_amt,
                                  li_run_no,
                                  0,
                                  0,
                                  c_bnk_narration,
                                  c_blk_deposit_flg,
                                  c_bill_no);


  if ( i_rc != 0 )
  {
   fn_errlog(c_ServiceName, "S31105",LIBMSG,c_err_msg);
   strcpy( c_msg, "System error. Contact system support" );
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
 
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  break;


  case INDERMINATE_FAILURE :
  case RERUN_FAILURE :
  default :
  fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
  fn_userlog(c_ServiceName,"In Indet failure,Rerun ,default case");
  rtrim(c_bnk_narration);

  i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

  if ( i_trnsctn == -1 )
  {
   fn_errlog(c_ServiceName, "L31325", LIBMSG, c_err_msg);
   strcpy ( c_msg, "System error. Contact system support" );
   fn_userlog(c_ServiceName,"Error in begin tran of fn_upd_adm_alloc_dtls");
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  EXEC SQL
  UPDATE FPD_FO_PEAKMRGN_DTLS
  SET    FPD_STATUS_FLG ='N'
  WHERE FPD_CLM_MTCH_ACCNT =:c_cln_mtch_accnt
  AND FPD_TRD_DT =:c_trd_dt
  AND FPD_RUN_NO =:li_run_no
  AND FPD_BATCH_SITE_IND =:c_rqst_typ
	AND FPD_BILL_NO=:c_bill_no;

  if ( SQLCODE != 0 )
  {
   fn_errlog( c_ServiceName, "L31335",SQLMSG,c_err_msg);
   fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
   fn_userlog(c_ServiceName,"Error in fetching data");
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
  {
   fn_errlog( c_ServiceName, "L31345",LIBMSG,c_err_msg);
   fn_userlog(c_ServiceName,"Error in commit tran");
   fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  d_blk4trd_amt = d_bft_amt;
  d_bnk_bft_amt = d_bft_amt;
  d_eba_bft_amt = d_bft_amt;
  d_bnk_pipo_amt = 0;
  d_eba_pipo_amt = 0;

  i_ret_val = fn_peak_flr_tbl( c_ServiceName,
                              c_xchng_cd,
                              c_cln_mtch_accnt,
                              li_run_no,
                              c_run_dt,
                              c_bnk_accnt,
                              UNBLOCK_DEBIT,
                              ALLOCATION_DEBIT_ON_PAYIN, 
                              DEBIT, /* ignore */
                              d_amt_dbt_frm_alctn,
                              d_amt_dbt_frm_alctn,
															d_amt_dbt_frm_bft, 
                              NOT_UPDATED,
                              NOT_UPDATED,
                              NOT_UPDATED,        
                              c_reference,
                              c_timestamp,
                              c_bnk_narration,    
                              c_blk_deposit_flg,
                              c_bill_no); 

  if ( i_ret_val != 0 )
  {
   strcpy ( c_msg, "System error. Contact system support" );
   fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
   fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
   i_rc  = fn_insrt_peak_rpt_tbl(  c_ServiceName,
                                   c_xchng_cd,
                                   c_cln_mtch_accnt,
                                   c_run_dt,
                                   d_payout_amt,
                                   d_blk4trd_amt,
                                   d_amt_dbt_frm_alctn, 
                                   d_intadj_amt,
                                   d_bnk_pipo_amt,
                                   d_eba_pipo_amt,
                                   d_bnk_bft_amt,
                                   d_eba_bft_amt,
                                   li_run_no,
                                   0,
                                   0,
                                   c_bnk_narration,  
                                   c_blk_deposit_flg,
                                   c_bill_no); 

   if ( i_rc != 0 )
   {
    fn_errlog(c_ServiceName, "S31110",LIBMSG,c_err_msg);
    strcpy( c_msg, "System error. Contact system support" );
    fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  sprintf(c_msg,"Indet. failure for %s at  BFT debit  on Pay in to bank",c_cln_mtch_accnt);
  fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
  i_rc  = fn_insrt_peak_rpt_tbl(  c_ServiceName,
                                  c_xchng_cd,
                                  c_cln_mtch_accnt,
                                  c_run_dt,
                                  d_payout_amt,
                                  d_blk4trd_amt,
                                  d_amt_dbt_frm_alctn, 
                                  d_intadj_amt,
                                  d_bnk_pipo_amt,
                                  d_eba_pipo_amt,
                                  d_bnk_bft_amt,
                                  d_eba_bft_amt,
                                  li_run_no,
                                  0,
                                  0,
                                  c_bnk_narration,    
                                  c_blk_deposit_flg,
                                  c_bill_no); 

   if ( i_rc != 0 )
   {
    fn_errlog(c_ServiceName, "S31115",LIBMSG,c_err_msg);
    strcpy( c_msg, "System error. Contact system support" );
    fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }

  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 }
 
 d_alct_stts_amt=d_new_alctd_amt;
 d_bft_stts_amt=d_new_bft_amt;

 }

  /****** Unblock Debit from BFT  Starts  **********/ 

 if ( d_amt_dbt_frm_bft > 0 )
 {

   i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

   if ( i_trnsctn == -1 )
   {
    fn_errlog(c_ServiceName, "L31325", LIBMSG, c_err_msg);
    strcpy ( c_msg, "System error. Contact system support" );
    fn_userlog(c_ServiceName,"Error in begin tran of fn_upd_adm_alloc_dtls");
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }

   i_returncode = fn_lock_usr( c_ServiceName, c_cln_mtch_accnt );

   if ( i_returncode != 0 )
   {
    fn_errlog(c_ServiceName, "L31330",LIBMSG,c_err_msg);
    fn_userlog(c_ServiceName,"Error in lock of fn_upd_adm_alloc_dtls");
    fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }
		/* Ver 1.1 start */
 		i_returncode = fn_lock_fno( c_ServiceName, c_cln_mtch_accnt );

 		if ( i_returncode != 0 )
 		{
  		fn_errlog(c_ServiceName, "L31331",LIBMSG,c_err_msg);
  		fn_userlog(c_ServiceName,"Error in lock of fn_upd_adm_alloc_dtls");
  		fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
  		tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 		}
		/* Ver 1.1 end */

    d_payout_amt = 0;
    d_intadj_amt = 0;
    d_blk4trd_amt = d_bft_stts_amt; 
    d_bnk_bft_amt = d_bft_stts_amt;
    d_eba_bft_amt = d_bft_stts_amt; 
    d_bnk_pipo_amt = 0;
    d_eba_pipo_amt = 0;


   strcpy( c_timestamp, "01-Jan-1980" );
   c_dr_cr_flg = UD ;
   sprintf(c_bnk_narration,"FNOPEAKMG%s",c_run_dt);
   i_ch_val =  fn_send_bnk_msg (&st_usr_prfl,
                                c_dr_cr_flg,
                                FO_BFT_BLK_CD, 
                                d_amt_dbt_frm_bft, 
                                BACKOFFICE,
                                c_ServiceName,
                                c_err_msg,
                                &d_val_bal,
                                c_reference,
                                c_timestamp,
                                c_bnk_narration,  
                                c_xchng_input,     
                                li_run_no); 
 

   switch ( i_ch_val )
   {
    case SUCCESS : 
    fn_userlog(c_ServiceName,"In Bank Success");
    d_amt_dbt_frm_bft_s = d_amt_dbt_frm_bft;
     rtrim(c_bnk_narration);
 
    i_returncode =  fn_pkupd_alloc_dtls ( c_ServiceName,
                                          c_err_msg,
                                          c_cln_mtch_accnt,
                                          c_xchng_cd,
                                          c_run_dt,
                                          c_bnk_accnt,
                                          c_tag,
                                          d_amt_dbt_frm_bft * (-1),
                                          0, 
                                          d_amt_dbt_frm_bft, 
                                          li_run_no,
 																					&d_new_alctd_amt,
																					&d_new_bft_amt);


   if ( i_returncode != 0 )
   {
    fn_errlog(c_ServiceName, "S31120",LIBMSG,c_err_msg);
    fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
    strcpy ( c_msg, "System error. Contact system support" );
    fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
            
    i_ret_val = fn_peak_flr_tbl( c_ServiceName,
                                c_xchng_cd,
                                c_cln_mtch_accnt,
                                li_run_no,
                                c_run_dt,
                                c_bnk_accnt,
                                UNBLOCK_DEBIT,
                                BFT_DEBIT_ON_PAYIN, 
                                DEBIT, /* ignore */
                                d_amt_dbt_frm_bft, 
 															  d_amt_dbt_frm_alctn,
															  d_amt_dbt_frm_bft,
                                UPDATED,       
                                NOT_UPDATED,
                                NOT_UPDATED,       
                                c_reference,
                                c_timestamp,
                                c_bnk_narration,    
                                c_blk_deposit_flg,
                                c_bill_no);  


    if ( i_ret_val != 0 )
    {
     strcpy ( c_msg, "System error. Contact system support" );
     fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
     i_rc  = fn_insrt_peak_rpt_tbl(  c_ServiceName,
                                     c_xchng_cd,
                                     c_cln_mtch_accnt,
                                     c_run_dt,
                                     d_payout_amt,
                                     d_blk4trd_amt,
                                     d_amt_dbt_frm_bft, 
                                     d_intadj_amt,
                                     d_bnk_pipo_amt,
                                     d_eba_pipo_amt,
                                     d_bnk_bft_amt,
                                     d_eba_bft_amt,
                                     li_run_no,
                                     0,
                                     0,
                                     c_bnk_narration,  
                                     c_blk_deposit_flg,
                                     c_bill_no); 
                                          
    if ( i_rc != 0 )
    {
     fn_errlog(c_ServiceName, "S31125",LIBMSG,c_err_msg);
     strcpy( c_msg, "System error. Contact system support" );
     fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }

   i_rc  = fn_insrt_peak_rpt_tbl(  c_ServiceName,
                                   c_xchng_cd,
                                   c_cln_mtch_accnt,
                                   c_run_dt,
                                   d_payout_amt,
                                   d_blk4trd_amt,
                                   d_amt_dbt_frm_bft, 
                                   d_intadj_amt,
                                   d_bnk_pipo_amt,
                                   d_eba_pipo_amt,
                                   d_bnk_bft_amt,
                                   d_eba_bft_amt,
                                   li_run_no,
                                   0,
                                   0,
                                   c_bnk_narration,    
                                   c_blk_deposit_flg,
 																	 c_bill_no);

    if ( i_rc != 0 )
    {
     fn_errlog(c_ServiceName, "S31130",LIBMSG,c_err_msg);
     strcpy( c_msg, "System error. Contact system support" );
     fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }

   d_blk4trd_amt = d_new_bft_amt;
   d_bnk_bft_amt = d_new_bft_amt;
   d_eba_bft_amt = d_new_bft_amt;
   d_bnk_pipo_amt = d_amt_dbt_frm_bft;
   d_eba_pipo_amt = d_amt_dbt_frm_bft;


   if ( d_amt_dbt_frm_alctn_s == 0)
   {
    /**** No UD from Allocation so generate new Bill number *******/

     EXEC SQL
     UPDATE FPD_FO_PEAKMRGN_DTLS
     SET FPD_DBCR_CD = 'D',
         FPD_NEW_ISEC_MRGN_AMT = NVL(FPD_NEW_ISEC_MRGN_AMT,0) + :d_amt_dbt_frm_bft,
         FPD_PEAK_MARGIN_DEBITED = NVL(FPD_PEAK_MARGIN_DEBITED,0) + :d_amt_dbt_frm_bft,
         FPD_BFT_DB_AMT  = :d_amt_dbt_frm_bft,
         FPD_STATUS_FLG ='Y',
         FPD_NEW_ALCTD_AMT=:d_new_alctd_amt,
         FPD_NEW_BFT_AMT=:d_new_bft_amt
     WHERE FPD_CLM_MTCH_ACCNT =:c_cln_mtch_accnt
     AND FPD_TRD_DT =:c_trd_dt
     AND FPD_RUN_NO =:li_run_no
     AND FPD_BATCH_SITE_IND =:c_rqst_typ
     AND FPD_STATUS_FLG!='F'
		 AND FPD_BILL_NO =:c_bill_no;

     if ( SQLCODE != 0 )
     {
      fn_errlog( c_ServiceName, "L31335",SQLMSG,c_err_msg);
      fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
      fn_userlog(c_ServiceName,"Error in fetching data");
      strcpy( c_msg, "System error. Contact system support" );
      fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
      i_ret_val = fn_peak_flr_tbl( c_ServiceName,
                                c_xchng_cd,
                                c_cln_mtch_accnt,
                                li_run_no,
                                c_run_dt,
                                c_bnk_accnt,
                                UNBLOCK_DEBIT,
                                BFT_DEBIT_ON_PAYIN,
                                DEBIT, /* ignore */
                                d_amt_dbt_frm_bft,
                                d_amt_dbt_frm_alctn,
                                d_amt_dbt_frm_bft,
                                UPDATED,
                                NOT_UPDATED,
                                NOT_UPDATED,
                                c_reference,
                                c_timestamp,
                                c_bnk_narration,
                                c_blk_deposit_flg,
                                c_bill_no);
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
     }

     EXEC SQL
     UPDATE FCB_FO_CLNT_BLNCS
        SET FCB_PEAK_MARGIN_DEBIT = :d_amt_dbt_frm_bft
      WHERE FCB_GRP_ID ='1'
        AND FCB_TRD_DT = :c_trd_dt
        AND FCB_XCHNG_CD ='NFO'
        AND FCB_CLM_MTCH_ACCNT=:c_cln_mtch_accnt;

     if ( SQLCODE != 0 )
     {
       fn_errlog( c_ServiceName, "L31335",SQLMSG,c_err_msg);
       fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
       fn_userlog(c_ServiceName,"Error in updating data");
       strcpy( c_msg, "System error. Contact system support" );
       fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
       i_ret_val = fn_peak_flr_tbl( c_ServiceName,
                                c_xchng_cd,
                                c_cln_mtch_accnt,
                                li_run_no,
                                c_run_dt,
                                c_bnk_accnt,
                                UNBLOCK_DEBIT,
                                BFT_DEBIT_ON_PAYIN,
                                DEBIT, /* ignore */
                                d_amt_dbt_frm_bft,
                                d_amt_dbt_frm_alctn,
                                d_amt_dbt_frm_bft,
                                UPDATED,
                                NOT_UPDATED,
                                NOT_UPDATED,
                                c_reference,
                                c_timestamp,
                                c_bnk_narration,
                                c_blk_deposit_flg,
                                c_bill_no);
       tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
     }
    }
    else
    {
     /***** Updating on the bill number of UD from Allocation ******/

      EXEC SQL
      UPDATE FPD_FO_PEAKMRGN_DTLS
      SET FPD_NEW_ISEC_MRGN_AMT = NVL(FPD_NEW_ISEC_MRGN_AMT,0) + :d_amt_dbt_frm_bft,
          FPD_PEAK_MARGIN_DEBITED = NVL(FPD_PEAK_MARGIN_DEBITED,0) + :d_amt_dbt_frm_bft,
          FPD_BFT_DB_AMT = :d_amt_dbt_frm_bft,
          FPD_STATUS_FLG = 'Y',
           FPD_NEW_ALCTD_AMT=:d_new_alctd_amt,
           FPD_NEW_BFT_AMT=:d_new_bft_amt
      where FPD_CLM_MTCH_ACCNT =:c_cln_mtch_accnt
      AND FPD_TRD_DT =:c_trd_dt
      AND FPD_RUN_NO =:li_run_no
      AND FPD_BATCH_SITE_IND =:c_rqst_typ
      AND FPD_BILL_NO =:c_bill_no;

      if ( SQLCODE != 0 )
      {
       fn_errlog( c_ServiceName, "L31335",SQLMSG,c_err_msg);
       fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
       fn_userlog(c_ServiceName,"Error in fetching data");
       strcpy( c_msg, "System error. Contact system support" );
       fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
       i_ret_val = fn_peak_flr_tbl( c_ServiceName,
                                c_xchng_cd,
                                c_cln_mtch_accnt,
                                li_run_no,
                                c_run_dt,
                                c_bnk_accnt,
                                UNBLOCK_DEBIT,
                                BFT_DEBIT_ON_PAYIN,
                                DEBIT, /* ignore */
                                d_amt_dbt_frm_bft,
                                d_amt_dbt_frm_alctn,
                                d_amt_dbt_frm_bft,
                                UPDATED,
                                NOT_UPDATED,
                                NOT_UPDATED,
                                c_reference,
                                c_timestamp,
                                c_bnk_narration,
                                c_blk_deposit_flg,
                                c_bill_no);
       tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      EXEC SQL
      UPDATE FCB_FO_CLNT_BLNCS
         SET FCB_PEAK_MARGIN_DEBIT = NVL(FCB_PEAK_MARGIN_DEBIT,0) + :d_amt_dbt_frm_bft
       WHERE FCB_GRP_ID ='1'
         AND FCB_TRD_DT = :c_trd_dt
         AND FCB_XCHNG_CD ='NFO'
         AND FCB_CLM_MTCH_ACCNT=:c_cln_mtch_accnt;

     if ( SQLCODE != 0 )
     {
      fn_errlog( c_ServiceName, "L31335",SQLMSG,c_err_msg);
      fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
      fn_userlog(c_ServiceName,"Error in updating data");
      strcpy( c_msg, "System error. Contact system support" );
      fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
      i_ret_val = fn_peak_flr_tbl( c_ServiceName,
                                c_xchng_cd,
                                c_cln_mtch_accnt,
                                li_run_no,
                                c_run_dt,
                                c_bnk_accnt,
                                UNBLOCK_DEBIT,
                                BFT_DEBIT_ON_PAYIN,
                                DEBIT, /* ignore */
                                d_amt_dbt_frm_bft,
                                d_amt_dbt_frm_alctn,
                                d_amt_dbt_frm_bft,
                                UPDATED,
                                NOT_UPDATED,
                                NOT_UPDATED,
                                c_reference,
                                c_timestamp,
                                c_bnk_narration,
                                c_blk_deposit_flg,
                                c_bill_no);
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
     } 

    }

   i_rc  = fn_insrt_peak_rpt_tbl(  c_ServiceName,
                                   c_xchng_cd,
                                   c_cln_mtch_accnt,
                                   c_run_dt,
                                   d_payout_amt,
                                   d_blk4trd_amt,
                                   d_amt_dbt_frm_bft, 
                                   d_intadj_amt,
                                   d_bnk_pipo_amt,
                                   d_eba_pipo_amt,
                                   d_bnk_bft_amt,
                                   d_eba_bft_amt,
                                   li_run_no,
                                   d_amt_dbt_frm_bft, 
                                   d_amt_dbt_frm_bft, 
                                   c_bnk_narration,
                                   c_blk_deposit_flg,
                                   c_bill_no);

   if ( i_rc != 0 )
   {
    fn_errlog(c_ServiceName, "S31135",LIBMSG,c_err_msg);
    strcpy( c_msg, "System error. Contact system support" );
    fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
    i_ret_val = fn_peak_flr_tbl( c_ServiceName,
                                c_xchng_cd,
                                c_cln_mtch_accnt,
                                li_run_no,
                                c_run_dt,
                                c_bnk_accnt,
                                UNBLOCK_DEBIT,
                                BFT_DEBIT_ON_PAYIN,
                                DEBIT, /* ignore */
                                d_amt_dbt_frm_bft,
                                d_amt_dbt_frm_alctn,
                                d_amt_dbt_frm_bft,
                                UPDATED,
                                NOT_UPDATED,
                                NOT_UPDATED,
                                c_reference,
                                c_timestamp,
                                c_bnk_narration,
                                c_blk_deposit_flg,
                                c_bill_no);
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }
 
   strcpy(c_pipo_src,"DEBIT");                                                
   strcpy(c_prdct_cd,"NFOPKMI");                                              
   c_accntng_for='I'; 
   strcpy(c_class_svc,"SFO_ADM_UPLD");                                                        
   d_trnsctn_amt=d_amt_dbt_frm_bft/100;                                       
    sprintf(c_narration,"Being Cash Margin Debited Against Open Position in NSE %s",c_trd_dt);
   strcpy(c_trace,c_reference);                                               
   strcpy(c_mtch_series,c_bill_no);                                           
   rtrim(c_src_rowid);                                                        
   rtrim(c_pipo_src);                                                         
   sprintf(c_run_nmbr, "%lu" ,li_run_no);  
	 MEMSET(c_xchng_cd);                                   
 	 strcpy(c_xchng_cd,"NFO");
                                                                            
   i_rc =  fn_ins_mbs(c_ServiceName,                                          
                      c_cln_mtch_accnt,                                       
                      c_xchng_cd,                                             
                      c_prdct_cd,                                             
                      c_pipo_src,                                             
                      c_sgmnt_cd,                                             
                      0,                                                      
                      c_tran_date,                                            
                      d_trnsctn_amt,                                          
                      c_run_nmbr,                                             
                      c_instrument_nmbr,                                      
                      '\0',                     /* \0 Added in Ver TOL */                                  
                      c_mdc_crdt_nmbr,                                        
                      c_accntng_for,                                          
                      c_accntng_typ,                                          
                      c_trace,                                                
                      c_bnk_acct_nmbr,                                        
                       c_narration,                                            
                      'D',                                                    
                      c_mtch_series,                                          
                      c_class_svc,                                            
                      c_src_rowid,                                            
                      c_err_msg,                                              
                      c_blk_deposit_flg);                                     
                                                                              
  if ( i_rc != 0 )                                                            
  {                                                                           
   fn_errlog(c_ServiceName, "S31140",LIBMSG,c_err_msg);                       
   fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );                        
   d_bnk_pipo_amt = 0;
   d_eba_pipo_amt = 0;
   d_bnk_bft_amt = d_bft_stts_amt; 
   d_eba_bft_amt = d_bft_stts_amt; 
                                                                         
   i_ret_val = fn_peak_flr_tbl( c_ServiceName,                                
                                c_xchng_cd,                                   
                                c_cln_mtch_accnt,                             
                                li_run_no,                                    
                                c_run_dt,                                     
                                 c_bnk_accnt,                                  
                                UNBLOCK_DEBIT,                                
                                BFT_DEBIT_ON_PAYIN,                           
                                DEBIT, /* ignore */                           
                                d_amt_dbt_frm_bft,                            
                                d_amt_dbt_frm_alctn,                          
                                d_amt_dbt_frm_bft,                            
                                UPDATED,                                      
                                NOT_UPDATED,                                  
                                NOT_UPDATED,                                  
                                c_reference,                                  
                                c_timestamp,                                  
                                c_bnk_narration,                              
                                c_blk_deposit_flg,
                                c_bill_no);                           
                                                                               
                                                                             
   if ( i_ret_val != 0 )                                                      
   {                                                                          
    strcpy ( c_msg, "System error. Contact system support" );                 
    fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );                           
    i_rc  = fn_insrt_peak_rpt_tbl(  c_ServiceName,                            
                                    c_xchng_cd,                               
                                    c_cln_mtch_accnt,                         
                                    c_run_dt,                                 
                                    d_payout_amt,                             
                                    d_blk4trd_amt,                            
                                    d_amt_dbt_frm_bft,                        
                                    d_intadj_amt,                             
                                     d_bnk_pipo_amt,                           
                                    d_eba_pipo_amt,                           
                                    d_bnk_bft_amt,                            
                                    d_eba_bft_amt,                            
                                    li_run_no,                                
                                    0,                                        
                                    0,                                        
                                    c_bnk_narration,                          
                                    c_blk_deposit_flg,
 																	  c_bill_no);                       
                                                                              
                                                                              
     if ( i_rc != 0 )                                                         
     {                                                                        
      fn_errlog(c_ServiceName, "S31145",LIBMSG,c_err_msg);                    
      strcpy( c_msg, "System error. Contact system support" );                
      fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );                         
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );                 
     } 
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );                   
   }

   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );

  }                                                                           

   if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
   {
    fn_errlog( c_ServiceName, "L31345",LIBMSG,c_err_msg);
    fn_userlog(c_ServiceName,"Error in commit tran");
    fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }

   fn_userlog(c_ServiceName,"Unblock debit success from BFT");
   break;

   case GENERAL_FAILURE :
   case INSUF_FUNDS :
   fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
   fn_userlog(c_ServiceName,"In General Failure and Insufficient funds");
   rtrim(c_bnk_narration);
   fn_errlog(c_ServiceName, "S31150",LIBMSG,c_err_msg);

   i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

   if ( i_trnsctn == -1 )
   {
    fn_errlog(c_ServiceName, "L31325", LIBMSG, c_err_msg);
    strcpy ( c_msg, "System error. Contact system support" );
    fn_userlog(c_ServiceName,"Error in begin tran of fn_upd_adm_alloc_dtls");
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }

   EXEC SQL
   UPDATE FPD_FO_PEAKMRGN_DTLS
   SET    FPD_STATUS_FLG ='F'
   WHERE FPD_CLM_MTCH_ACCNT =:c_cln_mtch_accnt
   AND FPD_TRD_DT =:c_trd_dt
   AND FPD_RUN_NO =:li_run_no
   AND FPD_BATCH_SITE_IND =:c_rqst_typ
   AND FPD_BILL_NO = :c_bill_no;
	 /*** AND NVL(FPD_BILL_NO,'NA') = DECODE(:d_amt_dbt_frm_alctn,0,'NA',:c_bill_no);	***/

   if ( SQLCODE != 0 )
   {
    fn_errlog( c_ServiceName, "L31335",SQLMSG,c_err_msg);
    fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );   
    fn_userlog(c_ServiceName,"Error in fetching data");
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }
 
   if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
   {
    fn_errlog( c_ServiceName, "L31345",LIBMSG,c_err_msg);
    fn_userlog(c_ServiceName,"Error in commit tran");
    fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }



    d_bnk_pipo_amt = 0;
    d_eba_pipo_amt = 0;
    d_bnk_bft_amt = d_bft_stts_amt;
    d_eba_bft_amt = d_bft_stts_amt;

   i_rc  = fn_insrt_peak_rpt_tbl(  c_ServiceName,
                                   c_xchng_cd,
                                   c_cln_mtch_accnt,
                                   c_run_dt,
                                   d_payout_amt,
                                   d_blk4trd_amt,
                                   d_amt_dbt_frm_bft, 
                                   d_intadj_amt,
                                   d_bnk_pipo_amt,
                                   d_eba_pipo_amt,
                                   d_bnk_bft_amt,
                                   d_eba_bft_amt,
                                   li_run_no,
                                   0,
                                   0,
                                   c_bnk_narration,  
                                   c_blk_deposit_flg,
                                   c_bill_no); 

    if ( i_rc != 0 )
    {
     fn_errlog(c_ServiceName, "S31155",LIBMSG,c_err_msg);
     strcpy( c_msg, "System error. Contact system support" );
     fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

    /***** Exiting if confirmed failure when only UD from BFT is present ****/

    if ( d_amt_dbt_frm_alctn == 0 )
    {
     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
     break;
    }
    else
    {
     /*******  Not Exiting as Credit for Allocation amount to be done ******/

     break;
    }   

     case 100 :
     case BLOCK_NOT_EXISTING :
     fn_userlog(c_ServiceName,"In Block not existing and case 100");
     sprintf(c_msg,"Error sending allocation debit on Pay in to bank for %s",c_cln_mtch_accnt);
     fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
      rtrim(c_bnk_narration);

     EXEC SQL
     UPDATE FPD_FO_PEAKMRGN_DTLS
      SET   FPD_STATUS_FLG ='F'
     WHERE FPD_CLM_MTCH_ACCNT =:c_cln_mtch_accnt
     AND FPD_TRD_DT =:c_trd_dt
     AND FPD_RUN_NO =:li_run_no
     AND FPD_BATCH_SITE_IND =:c_rqst_typ
		 AND FPD_BILL_NO = :c_bill_no;
    /*** AND NVL(FPD_BILL_NO,'NA') = DECODE(:d_amt_dbt_frm_alctn,0,'NA',:c_bill_no);	***/

   if ( SQLCODE != 0 )
   {
    fn_errlog( c_ServiceName, "L31335",SQLMSG,c_err_msg);
    fn_userlog(c_ServiceName,"Error in fetching data");
    fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }

    d_bnk_pipo_amt = 0;
    d_eba_pipo_amt = 0;
    d_bnk_bft_amt = d_bft_stts_amt;
    d_eba_bft_amt = d_bft_stts_amt;


   i_rc  = fn_insrt_peak_rpt_tbl(  c_ServiceName,
                                   c_xchng_cd,
                                   c_cln_mtch_accnt,
                                   c_run_dt,
                                   d_payout_amt,
                                   d_blk4trd_amt,
                                   d_amt_dbt_frm_bft,
                                   d_intadj_amt,
                                   d_bnk_pipo_amt,
                                   d_eba_pipo_amt,
                                   d_bnk_bft_amt,
                                   d_eba_bft_amt,
                                   li_run_no,
                                   0,
                                   0,
                                   c_bnk_narration,
                                   c_blk_deposit_flg,
 																	 c_bill_no);

    if ( i_rc != 0 )
    {
     fn_errlog(c_ServiceName, "S31160",LIBMSG,c_err_msg);
     strcpy( c_msg, "System error. Contact system support" );
     fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

    if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
    {
     fn_errlog( c_ServiceName, "L31345",LIBMSG,c_err_msg);
     fn_userlog(c_ServiceName,"Error in commit tran");
     fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    break;
      

     case INDERMINATE_FAILURE :
     case RERUN_FAILURE :                  
     default :
     fn_userlog(c_ServiceName,"In Indet failure,Rerun ,default case");
     fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
     rtrim(c_bnk_narration);

     i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

     if ( i_trnsctn == -1 )
     {
      fn_errlog(c_ServiceName, "L31325", LIBMSG, c_err_msg);
      strcpy ( c_msg, "System error. Contact system support" );
      fn_userlog(c_ServiceName,"Error in begin tran of fn_upd_adm_alloc_dtls");
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
     }


     EXEC SQL
     UPDATE FPD_FO_PEAKMRGN_DTLS
     SET     FPD_STATUS_FLG ='N'
     WHERE FPD_CLM_MTCH_ACCNT =:c_cln_mtch_accnt
     AND FPD_TRD_DT =:c_trd_dt
     AND FPD_RUN_NO =:li_run_no
     AND FPD_BATCH_SITE_IND =:c_rqst_typ
     AND FPD_BILL_NO = :c_bill_no; 

     if ( SQLCODE != 0 )
     {
      fn_errlog( c_ServiceName, "L31335",SQLMSG,c_err_msg);
      fn_userlog(c_ServiceName,"Error in fetching data");
      fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }
 
    if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
    {
     fn_errlog( c_ServiceName, "L31345",LIBMSG,c_err_msg);
     fn_userlog(c_ServiceName,"Error in commit tran");
     fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

     d_bnk_pipo_amt = 0;
     d_eba_pipo_amt = 0;
     d_bnk_bft_amt = d_bft_stts_amt;
     d_eba_bft_amt = d_bft_stts_amt;

     /*** Insert into Failure table ***/
     i_ret_val = fn_peak_flr_tbl( c_ServiceName,
                                 c_xchng_cd,
                                 c_cln_mtch_accnt,
                                 li_run_no,
                                 c_run_dt,
                                 c_bnk_accnt,
                                 UNBLOCK_DEBIT,
                                 BFT_DEBIT_ON_PAYIN,
                                 DEBIT, /* ignore */
                                 d_amt_dbt_frm_bft, 
															   d_amt_dbt_frm_alctn,
															   d_amt_dbt_frm_bft,
                                 NOT_UPDATED,
                                 NOT_UPDATED,
                                 NOT_UPDATED,       
                                 c_reference,
                                 c_timestamp,
                                 c_bnk_narration,  
                                 c_blk_deposit_flg,
													 			 c_bill_no); 

      if ( i_ret_val != 0 )
      {
       strcpy ( c_msg, "System error. Contact system support" );
       fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
       i_rc  = fn_insrt_peak_rpt_tbl(  c_ServiceName,
                                       c_xchng_cd,
                                       c_cln_mtch_accnt,
                                       c_run_dt,
                                       d_payout_amt,
                                       d_blk4trd_amt,
                                       d_amt_dbt_frm_bft, 
                                       d_intadj_amt,
                                       d_bnk_pipo_amt,
                                       d_eba_pipo_amt,
                                       d_bnk_bft_amt,
                                       d_eba_bft_amt,
                                       li_run_no,
                                       0,
                                       0,
                                       c_bnk_narration,    
                                       c_blk_deposit_flg,
 														    			 c_bill_no); 

       if ( i_rc != 0 )
       {
        fn_errlog(c_ServiceName, "S31165",LIBMSG,c_err_msg);
        strcpy( c_msg, "System error. Contact system support" );
        fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
       }
     
       tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
      sprintf(c_msg,"Indet failure for %s in BFT debit on Payin to bank",c_cln_mtch_accnt);
      fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
      i_rc  = fn_insrt_peak_rpt_tbl(  c_ServiceName,
                                      c_xchng_cd,
                                      c_cln_mtch_accnt,
                                      c_run_dt,
                                      d_payout_amt,
                                      d_amt_dbt_frm_bft, 
                                      d_payin_amt,
                                      d_intadj_amt,
                                      d_bnk_pipo_amt,
                                      d_eba_pipo_amt,
                                      d_bnk_bft_amt,
                                      d_eba_bft_amt,
                                      li_run_no,
                                      0,
                                      0,
                                      c_bnk_narration,      
                                      c_blk_deposit_flg,
																	    c_bill_no); 

       if ( i_rc != 0 )
       {
        fn_errlog(c_ServiceName, "S31170",LIBMSG,c_err_msg);
        strcpy( c_msg, "System error. Contact system support" );
        fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
       }

       tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
       break;
      
     }
 
   } 

   fn_userlog(c_ServiceName,"BFT Debited  Amount :%lf:",d_amt_dbt_frm_bft);
   fn_userlog(c_ServiceName,"Allocation Debited Amount :%lf:",d_amt_dbt_frm_alctn);

   d_final_dbamt = d_amt_dbt_frm_bft_s + d_amt_dbt_frm_alctn_s ; 

   fn_userlog(c_ServiceName,"Final Debited Amount :%lf:",d_final_dbamt);

   d_undebited_amount =0;

   if( d_final_dbamt < d_peak_mrgn_debit )
   {
    fn_userlog(c_ServiceName,"Peak margin debited is less than peak margin to be debited");
    d_undebited_amount = d_peak_mrgn_debit - d_final_dbamt;

    i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

    if ( i_trnsctn == -1 )
    {
     fn_errlog(c_ServiceName, "L31325", LIBMSG, c_err_msg);
     strcpy ( c_msg, "System error. Contact system support" );
     fn_userlog(c_ServiceName,"Error in begin tran of fn_upd_adm_alloc_dtls");
     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }
    
    EXEC SQL
     UPDATE FCB_FO_CLNT_BLNCS
        SET FCB_PEAK_MARGIN_DEBIT = NVL(FCB_PEAK_MARGIN_DEBIT,0) + :d_undebited_amount
      WHERE FCB_GRP_ID ='1'
        AND FCB_TRD_DT = :c_trd_dt
        AND FCB_XCHNG_CD ='NFO'
        AND FCB_CLM_MTCH_ACCNT=:c_cln_mtch_accnt;

   if ( SQLCODE != 0 )
   {
    fn_errlog( c_ServiceName, "L31335",SQLMSG,c_err_msg);
    fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
    fn_userlog(c_ServiceName,"Error in updating data");
    strcpy( c_msg, "System error. Contact system support" );
    fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    i_ret_val = fn_peak_flr_tbl( c_ServiceName,
                                c_xchng_cd,
                                c_cln_mtch_accnt,
                                li_run_no,
                                c_run_dt,
                                c_bnk_accnt,
                                UNBLOCK_DEBIT,
                                BFT_DEBIT_ON_PAYIN,
                                DEBIT, /* ignore */
                                d_amt_dbt_frm_bft,
                                d_amt_dbt_frm_alctn,
                                d_amt_dbt_frm_bft,
                                UPDATED,
                                NOT_UPDATED,
                                NOT_UPDATED,
                                c_reference,
                                c_timestamp,
                                c_bnk_narration,
                                c_blk_deposit_flg,
                                c_bill_no);
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }


   if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
   {
     fn_errlog( c_ServiceName, "L31345",LIBMSG,c_err_msg);
     fn_userlog(c_ServiceName,"Error in commit tran");
     fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }

 } 


 if( d_final_dbamt !=0 )
 {
  if ( c_rqst_typ == 'S')
  {
   d_credit_amt = d_final_dbamt ;
   fn_userlog(c_ServiceName,"Credit Amount :%lf:",d_credit_amt);
   
  /***** Credit operation for site call ********/

  i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

  if ( i_trnsctn == -1 )
  {
   fn_errlog(c_ServiceName, "L31325", LIBMSG, c_err_msg);
   strcpy ( c_msg, "System error. Contact system support" );
   fn_userlog(c_ServiceName,"Error in begin tran of fn_upd_adm_alloc_dtls");
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  i_returncode = fn_lock_usr( c_ServiceName, c_cln_mtch_accnt );

  if ( i_returncode != 0 )
  {
   fn_errlog(c_ServiceName, "L31330",LIBMSG,c_err_msg);
   fn_userlog(c_ServiceName,"Error in lock of fn_upd_adm_alloc_dtls");
   fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }	
	/* Ver 1.1 start */
 	i_returncode = fn_lock_fno( c_ServiceName, c_cln_mtch_accnt );

 	if ( i_returncode != 0 )
 	{
 		fn_errlog(c_ServiceName, "L31331",LIBMSG,c_err_msg);
 		fn_userlog(c_ServiceName,"Error in lock of fn_upd_adm_alloc_dtls");
 		fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
 		tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 	}
	/* Ver 1.1 end */

  c_dr_cr_flg = CR ;   
  d_payin_amt = 0;
  d_bnk_pipo_amt=0;
  d_eba_pipo_amt=0;
  d_eba_bft_amt=d_bft_stts_amt;
  d_blk4trd_amt=d_bft_stts_amt;
  d_intadj_amt=0;

                               
  strcpy( c_timestamp, "01-Jan-1980" );                            
  i_returncode =  fn_send_bnk_msg (&st_usr_prfl,                   
                                 c_dr_cr_flg,                    
                                 "  ",                           
                                 d_credit_amt, 
                                 BACKOFFICE,                     
                                 c_ServiceName,                  
                                 c_err_msg,                      
                                 &d_val_bal,                     
                                 c_reference,                    
                                 c_timestamp,                    
                                 c_bnk_narration,                
                                 c_xchng_input,                     
                                 li_run_no);                     
                                                                 

 
  
 /** switch ( i_ch_val ) ** Ver 1.2 **/
 switch ( i_returncode ) /** Ver 1.2 **/
 {
  case SUCCESS :
  fn_userlog(c_ServiceName,"In Bank Success");
   rtrim(c_bnk_narration);
 
  i_returncode =  fn_pkupd_alloc_dtls ( c_ServiceName,
                                    c_err_msg,
                                    c_cln_mtch_accnt,
                                    c_xchng_cd,
                                    c_run_dt,
                                    c_bnk_accnt,
                                    c_tag,
                                    0, 
                                    0,
                                    d_credit_amt * (-1), 
                                    li_run_no,
																		&d_new_alctd_amt,
																		&d_new_bft_amt);




  if ( i_returncode != 0 )
  {
   fn_errlog(c_ServiceName, "S31175",LIBMSG,c_err_msg);
   fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );

   i_ret_val = fn_peak_flr_tbl( c_ServiceName,
                                         c_xchng_cd,
                                         c_cln_mtch_accnt,
                                         li_run_no,
                                         c_run_dt,
                                         c_bnk_accnt,
                                         CREDIT,
                                         CREDIT_ON_PAYOUT,
                                         CREDIT,
                                         d_credit_amt,
                                         d_amt_dbt_frm_alctn,
																	       d_amt_dbt_frm_bft,  
                                         UPDATED,                      
                                         NOT_UPDATED,
                                        NOT_UPDATED,                     
                                        c_reference,
                                        c_timestamp,
                                        c_bnk_narration,     
                                        c_blk_deposit_flg,
																				c_bill_no);

    if ( i_ret_val != 0 )
    {
     strcpy ( c_msg, "System error. Contact system support" );
     fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
     i_rc  = fn_insrt_peak_rpt_tbl(  c_ServiceName,
                                     c_xchng_cd,
                                     c_cln_mtch_accnt,
                                     c_run_dt,
                                     d_credit_amt, 
                                     d_blk4trd_amt,
                                     d_payin_amt,
                                     d_intadj_amt,
                                     d_bnk_pipo_amt,
                                     d_eba_pipo_amt,
                                     d_bnk_bft_amt,
                                     d_eba_bft_amt,
                                     li_run_no,
                                     0,
                                     0,
                                     c_bnk_narration,      
                                     c_blk_deposit_flg,
																	   c_bill_no); 

     if ( i_rc != 0 )
     {
      fn_errlog(c_ServiceName, "S31180",LIBMSG,c_err_msg);
      strcpy( c_msg, "System error. Contact system support" );
      fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
     }
     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  EXEC SQL
   UPDATE FPD_FO_PEAKMRGN_DTLS
   set 
       FPD_STATUS_FLG = 'Y',
       FPD_NEW_ALCTD_AMT=:d_new_alctd_amt,
       FPD_NEW_BFT_AMT=:d_new_bft_amt,
			 FPD_PEAK_MARGIN_CREDITED=:d_credit_amt
   where FPD_CLM_MTCH_ACCNT =:c_cln_mtch_accnt
   AND FPD_TRD_DT =:c_trd_dt
   AND FPD_RUN_NO =:li_run_no
   AND FPD_BATCH_SITE_IND =:c_rqst_typ
   AND FPD_BILL_NO =:c_bill_no;

   if ( SQLCODE != 0 )
   {
    fn_errlog( c_ServiceName, "L31335",SQLMSG,c_err_msg);
    fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
    fn_userlog(c_ServiceName,"Error in fetching data");
    strcpy( c_msg, "System error. Contact system support" );
     fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    i_ret_val = fn_peak_flr_tbl( c_ServiceName,
                                         c_xchng_cd,
                                         c_cln_mtch_accnt,
                                         li_run_no,
                                         c_run_dt,
                                         c_bnk_accnt,
                                         CREDIT,
                                         CREDIT_ON_PAYOUT,
                                         CREDIT,
                                         d_credit_amt,
                                         d_amt_dbt_frm_alctn,
                                         d_amt_dbt_frm_bft,
                                         UPDATED,
                                         NOT_UPDATED,
                                        NOT_UPDATED,
                                        c_reference,
                                        c_timestamp,
                                        c_bnk_narration,
                                        c_blk_deposit_flg,
                                        c_bill_no);
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }

  d_bnk_bft_amt = d_new_bft_amt; 
  d_eba_bft_amt = d_new_bft_amt;
  d_bnk_pipo_amt = d_credit_amt; 
  d_eba_pipo_amt = d_credit_amt;


  i_rc  = fn_insrt_peak_rpt_tbl(  c_ServiceName,
                                  c_xchng_cd,
                                  c_cln_mtch_accnt,
                                  c_run_dt,
                                  d_credit_amt, 
                                  d_blk4trd_amt,
                                  d_payin_amt,
                                  d_intadj_amt,
                                  d_bnk_pipo_amt,
                                  d_eba_pipo_amt,
                                  d_bnk_bft_amt,
                                  d_eba_bft_amt,
                                  li_run_no,
                                  0,  
                                  0, 
                                  c_bnk_narration,
                                  c_blk_deposit_flg,
																  c_bill_no);

  if ( i_rc != 0 )
  {
   fn_errlog(c_ServiceName, "S31185",LIBMSG,c_err_msg);
   strcpy( c_msg, "System error. Contact system support" );
   fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
   i_ret_val = fn_peak_flr_tbl( c_ServiceName,
                                         c_xchng_cd,
                                         c_cln_mtch_accnt,
                                         li_run_no,
                                         c_run_dt,
                                         c_bnk_accnt,
                                         CREDIT,
                                         CREDIT_ON_PAYOUT,
                                         CREDIT,
                                         d_credit_amt,
                                         d_amt_dbt_frm_alctn,
                                         d_amt_dbt_frm_bft,
                                         UPDATED,
                                         NOT_UPDATED,
                                        NOT_UPDATED,
                                        c_reference,
                                        c_timestamp,
                                        c_bnk_narration,
                                        c_blk_deposit_flg,
                                        c_bill_no);
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  strcpy(c_pipo_src,"CLEAR_BAL");                                                                        
  strcpy(c_prdct_cd,"NFOPKMO");                                                                          
  c_accntng_for='O'; 
  strcpy(c_class_svc,"SFO_ADM_UPLD");                                                                                    
  d_trnsctn_amt=d_credit_amt/100;                                                                            
  sprintf(c_narration,"Being Cash Margin Credited Against Open Position in NSE %s",c_run_dt);            
  strcpy(c_trace,c_reference);                                                                           
  strcpy(c_mtch_series,c_bill_no);                                                                       
  sprintf(c_run_nmbr, "%lu" ,li_run_no);                                                                 
  rtrim(c_src_rowid);                                                                                    
  rtrim(c_pipo_src);                                                                                     
 
	MEMSET(c_xchng_cd);
  strcpy(c_xchng_cd,"NFO");
                                                                                                      
  i_rc =  fn_ins_mbs(c_ServiceName,                                                                     
                     c_cln_mtch_accnt,                                                                  
                     c_xchng_cd,                                                                        
                     c_prdct_cd,                                                                        
                     c_pipo_src,                                                                        
                     c_sgmnt_cd,                                                                        
                     0,                                                                                 
                     c_tran_date,                                                                       
                     d_trnsctn_amt,                                                                     
                     c_run_nmbr,                                                                        
                     c_instrument_nmbr,                                                                 
                     '\0',                    /* \0 Added in Ver TOL */                                                              
                     c_mdc_crdt_nmbr,                                                                   
                     c_accntng_for,                                                                     
                     c_accntng_typ,                                                                     
                     c_trace,                                                                           
                     c_bnk_acct_nmbr,                                                                   
                     c_narration,                                                                       
                     'C',                                                                               
                     c_mtch_series,                                                                     
                     c_class_svc,                                                                       
                     c_src_rowid,                                                                       
                     c_err_msg,                                                                         
                     c_blk_deposit_flg);                                                                

  if ( i_rc != 0 )
  {
   fn_errlog(c_ServiceName, "S31190",LIBMSG,c_err_msg);
   fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
   d_bnk_bft_amt = d_bft_stts_amt; 
   d_eba_bft_amt = d_bft_stts_amt; 
   d_bnk_pipo_amt = 0; 
   d_eba_pipo_amt = 0; 

   i_ret_val = fn_peak_flr_tbl( c_ServiceName,
                                         c_xchng_cd,
                                         c_cln_mtch_accnt,
                                         li_run_no,
                                         c_run_dt,
                                         c_bnk_accnt,
                                         CREDIT,
                                         CREDIT_ON_PAYOUT,
                                         CREDIT,
                                         d_credit_amt,
                                         d_amt_dbt_frm_alctn,
                                         d_amt_dbt_frm_bft,
                                         UPDATED,
                                         NOT_UPDATED,
                                        NOT_UPDATED,
                                        c_reference,
                                        c_timestamp,
                                        c_bnk_narration,
                                        c_blk_deposit_flg,
																			  c_bill_no);

    if ( i_ret_val != 0 )
    {
     strcpy ( c_msg, "System error. Contact system support" );
     fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
     i_rc  = fn_insrt_peak_rpt_tbl(  c_ServiceName,
                                     c_xchng_cd,
                                     c_cln_mtch_accnt,
                                     c_run_dt,
                                     d_credit_amt,
                                     d_blk4trd_amt,
                                     d_payin_amt,
                                     d_intadj_amt,
                                     d_bnk_pipo_amt,
                                     d_eba_pipo_amt,
                                     d_bnk_bft_amt,
                                     d_eba_bft_amt,
                                     li_run_no,
                                     0,
                                     0,
                                     c_bnk_narration,
                                     c_blk_deposit_flg,
															       c_bill_no);

     if ( i_rc != 0 )
     {
      fn_errlog(c_ServiceName, "S31195",LIBMSG,c_err_msg);
      strcpy( c_msg, "System error. Contact system support" );
      fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
     }
     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }

  if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
  {
   fn_errlog( c_ServiceName, "L31345",LIBMSG,c_err_msg);
   fn_userlog(c_ServiceName,"Error in commit tran");
   fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }


  break;

  case GENERAL_FAILURE :                                                                          
  case INSUF_FUNDS :                                                                           
  case BLOCK_NOT_EXISTING :                                                                    
  i_ret_state = FROM_CREDIT_FAILURE ;      
  fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
  fn_errlog(c_ServiceName, "S31200",LIBMSG,c_err_msg);                                       
  sprintf ( c_msg,                                                                           
            "Error while sending credit message to bank for %s",                             
            c_cln_mtch_accnt);                                                               
 
  fn_userlog(c_ServiceName,"In General Failure and Insufficient funds");
 fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );    
  rtrim(c_bnk_narration);

  i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

  if ( i_trnsctn == -1 )
  {
   fn_errlog(c_ServiceName, "L31325", LIBMSG, c_err_msg);
   strcpy ( c_msg, "System error. Contact system support" );
   fn_userlog(c_ServiceName,"Error in begin tran of fn_upd_adm_alloc_dtls");
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  EXEC SQL
   UPDATE FPD_FO_PEAKMRGN_DTLS
   SET    FPD_STATUS_FLG ='F'
   WHERE FPD_CLM_MTCH_ACCNT =:c_cln_mtch_accnt
   AND FPD_TRD_DT =:c_trd_dt
   AND FPD_RUN_NO =:li_run_no
   AND FPD_BATCH_SITE_IND =:c_rqst_typ
   AND FPD_BILL_NO = :c_bill_no;

   if ( SQLCODE != 0 )
   {
    fn_errlog( c_ServiceName, "L31335",SQLMSG,c_err_msg);
    fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
    fn_userlog(c_ServiceName,"Error in fetching data");
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }

   if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
   {
    fn_errlog( c_ServiceName, "L31345",LIBMSG,c_err_msg);
    fn_userlog(c_ServiceName,"Error in commit tran");
    fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }


  i_rc  = fn_insrt_peak_rpt_tbl(  c_ServiceName,                                             
                                  c_xchng_cd,                                                
                                  c_cln_mtch_accnt,                                          
                                  c_run_dt,                                                  
                                  d_credit_amt, 
                                  d_blk4trd_amt,                                             
                                  d_payin_amt,                                               
                                  d_intadj_amt,                                              
                                  d_bnk_pipo_amt,                                            
                                  d_eba_pipo_amt,                                            
                                  d_bnk_bft_amt,                                             
                                  d_eba_bft_amt,                                             
                                  li_run_no, 
                                  0,
                                  0,                                                
                                  c_bnk_narration,                                           
                                  c_blk_deposit_flg,
															    c_bill_no );                                       
                                                                                                       
  if ( i_rc != 0 )                                                                           
  {                                                                                          
   fn_errlog(c_ServiceName, "S31205",LIBMSG,c_err_msg);                                     
   strcpy( c_msg, "System error. Contact system support" );                                 
   fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );                                          
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );                                  
  }                                                                                          
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );                                    
  break;                                                                                     
                                                                                                       
  case INDERMINATE_FAILURE :                                                                   
  case RERUN_FAILURE :                                                                         
  default :                                                                                    
  i_ret_state = FROM_CREDIT_INDERMINATE_FAILURE ; 
  fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
  sprintf(c_msg,"Indet. failure for %s while sending credit messageto bank",c_cln_mtch_accnt);
  fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );     
   fn_userlog(c_ServiceName,"In Indet failure,Rerun ,default case");
    rtrim(c_bnk_narration);
 
  i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

  if ( i_trnsctn == -1 )
  {
   fn_errlog(c_ServiceName, "L31325", LIBMSG, c_err_msg);
   strcpy ( c_msg, "System error. Contact system support" );
   fn_userlog(c_ServiceName,"Error in begin tran of fn_upd_adm_alloc_dtls");
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
 
  EXEC SQL
  UPDATE FPD_FO_PEAKMRGN_DTLS
  SET    FPD_STATUS_FLG ='N'
  WHERE FPD_CLM_MTCH_ACCNT =:c_cln_mtch_accnt
  AND FPD_TRD_DT =:c_trd_dt
  AND FPD_RUN_NO =:li_run_no
  AND FPD_BATCH_SITE_IND =:c_rqst_typ
  AND FPD_BILL_NO = :c_bill_no;

  if ( SQLCODE != 0 )
  {
   fn_errlog( c_ServiceName, "L31335",SQLMSG,c_err_msg);
   fn_userlog(c_ServiceName,"Error in fetching data");
   fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
  {
   fn_errlog( c_ServiceName, "L31345",LIBMSG,c_err_msg);
   fn_userlog(c_ServiceName,"Error in commit tran");
   fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

                                       
  i_ret_val = fn_peak_flr_tbl( c_ServiceName,                                                 
                              c_xchng_cd,                                                      
                              c_cln_mtch_accnt,                                                
                              li_run_no,                                                       
                              c_run_dt,                                                        
                              c_bnk_accnt,                                                     
                              CREDIT,                                                          
                              CREDIT_ON_PAYOUT,                                                
                              CREDIT,                                                          
                              d_credit_amt,
                              d_amt_dbt_frm_alctn,
													  	d_amt_dbt_frm_bft, 
                              NOT_UPDATED,                                                     
                              NOT_UPDATED,                                                     
                              NOT_UPDATED,                                                     
                              c_reference,                                                     
                              c_timestamp,                                                     
                              c_bnk_narration,                                                 
                              c_blk_deposit_flg,
										          c_bill_no);                                              
                                                                                                       
  if ( i_ret_val != 0 )                                                                        
  {                                                                                            
   strcpy ( c_msg, "System error. Contact system support" );                                  
   fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );                                            
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );                                    
  }
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );                                                                                            
 }
 
 d_bnk_bft_amt = d_bft_stts_amt;
 d_eba_bft_amt = d_bft_stts_amt;
 d_payin_amt = 0;
 d_bnk_pipo_amt=0;
 d_eba_pipo_amt=0;

 /******* Blocking Amount ********************/

 i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

 if ( i_trnsctn == -1 )
 {
  fn_errlog(c_ServiceName, "L31325", LIBMSG, c_err_msg);
  strcpy ( c_msg, "System error. Contact system support" );
  fn_userlog(c_ServiceName,"Error in begin tran of fn_upd_adm_alloc_dtls");
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 }

 i_returncode = fn_lock_usr( c_ServiceName, c_cln_mtch_accnt );

 if ( i_returncode != 0 )
 { 
  fn_errlog(c_ServiceName, "L31330",LIBMSG,c_err_msg);
  fn_userlog(c_ServiceName,"Error in lock of fn_upd_adm_alloc_dtls");
  fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 }	
 /* Ver 1.1 start */
 i_returncode = fn_lock_fno( c_ServiceName, c_cln_mtch_accnt );

 if ( i_returncode != 0 )
 {
 		fn_errlog(c_ServiceName, "L31331",LIBMSG,c_err_msg);
 		fn_userlog(c_ServiceName,"Error in lock of fn_upd_adm_alloc_dtls");
 		fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
 		tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 }
 /* Ver 1.1 end */

 c_dr_cr_flg = BK ;                                                                         
 strcpy( c_timestamp, "01-Jan-1980" );                                                      
 i_returncode =  fn_send_bnk_msg (&st_usr_prfl,                                             
                                   c_dr_cr_flg,                                            
                                   FO_BLK_CD,                                          
                                   d_credit_amt, 
                                   BACKOFFICE,                                             
                                   c_ServiceName,                                          
                                   c_err_msg,                                              
                                   &d_val_bal,                                             
                                   c_reference,                                            
                                   c_timestamp,                                            
                                   c_bnk_narration, 
                                   c_xchng_input,     
						                     	 li_run_no); 


 switch ( i_returncode )
 {
  case SUCCESS :
  fn_userlog(c_ServiceName,"In Bank Success"); 
   rtrim(c_bnk_narration);

  i_returncode =  fn_pkupd_alloc_dtls ( c_ServiceName,
                                    c_err_msg,
                                    c_cln_mtch_accnt,
                                    c_xchng_cd,
                                    c_run_dt,
                                    c_bnk_accnt,
                                    c_tag,
                                    0, 
                                    d_credit_amt, 
                                    0, 
                                    li_run_no,
																		&d_new_alctd_amt,
																		&d_new_bft_amt);




  if ( i_returncode != 0 )
  {
   fn_errlog(c_ServiceName, "S31210",LIBMSG,c_err_msg);
   fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );

   i_ret_val = fn_peak_flr_tbl( c_ServiceName,
                                         c_xchng_cd,
                                         c_cln_mtch_accnt,
                                         li_run_no,
                                         c_run_dt,
                                         c_bnk_accnt,
                                         BLOCK, 
                                         ALLC_FOR_ADM, 
                                         CREDIT,
                                         d_credit_amt,
                                         d_amt_dbt_frm_alctn,
																			   d_amt_dbt_frm_bft, 
                                         UPDATED,
                                         NOT_UPDATED,
                                        NOT_UPDATED,
                                        c_reference,
                                        c_timestamp,
                                        c_bnk_narration,
                                        c_blk_deposit_flg,
																				c_bill_no);

    if ( i_ret_val != 0 )
    {
     strcpy ( c_msg, "System error. Contact system support" );
     fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
     i_rc  = fn_insrt_peak_rpt_tbl(  c_ServiceName,
                                     c_xchng_cd,
                                     c_cln_mtch_accnt,
                                     c_run_dt,
                                     d_credit_amt, 
                                     d_blk4trd_amt,
                                     d_payin_amt,
                                     d_intadj_amt,
                                     d_bnk_pipo_amt,
                                     d_eba_pipo_amt,
                                     d_bnk_bft_amt,
                                     d_eba_bft_amt,
                                     li_run_no,
                										 0,
																		 0, 
                                     c_bnk_narration,
                                     c_blk_deposit_flg,
																		 c_bill_no);

     if ( i_rc != 0 )
     {
      fn_errlog(c_ServiceName, "S31215",LIBMSG,c_err_msg);
      strcpy( c_msg, "System error. Contact system support" );
      fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
     }
     tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  EXEC SQL
  UPDATE FPD_FO_PEAKMRGN_DTLS
  SET  FPD_TO_CR_ALCTD_AMT = :d_credit_amt,
       FPD_STATUS_FLG = 'Y',
       FPD_NEW_ALCTD_AMT=:d_new_alctd_amt,
       FPD_NEW_BFT_AMT=:d_new_bft_amt  
  where FPD_CLM_MTCH_ACCNT =:c_cln_mtch_accnt
  AND FPD_TRD_DT =:c_trd_dt
  AND FPD_RUN_NO =:li_run_no
  AND FPD_BATCH_SITE_IND =:c_rqst_typ
  AND FPD_BILL_NO =:c_bill_no;

  if ( SQLCODE != 0 )
  {
   fn_errlog( c_ServiceName, "L31335",SQLMSG,c_err_msg);
   fn_aborttran(c_ServiceName, i_trnsctn, c_err_msg );
   fn_userlog(c_ServiceName,"Error in fetching data");
   strcpy( c_msg, "System error. Contact system support" );
   fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
   i_ret_val = fn_peak_flr_tbl( c_ServiceName,
                                         c_xchng_cd,
                                         c_cln_mtch_accnt,
                                         li_run_no,
                                         c_run_dt,
                                         c_bnk_accnt,
                                         BLOCK,
                                         ALLC_FOR_ADM,
                                         CREDIT,
                                         d_credit_amt,
                                         d_amt_dbt_frm_alctn,
                                         d_amt_dbt_frm_bft,
                                         UPDATED,
                                         NOT_UPDATED,
                                        NOT_UPDATED,
                                        c_reference,
                                        c_timestamp,
                                        c_bnk_narration,
                                        c_blk_deposit_flg,
                                        c_bill_no);
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }

   d_bnk_bft_amt = d_new_bft_amt; 
   d_eba_bft_amt = d_new_bft_amt; 
   d_bnk_pipo_amt = d_credit_amt ;
   d_eba_pipo_amt = d_credit_amt;

 if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
 {
  fn_errlog( c_ServiceName, "L31345",LIBMSG,c_err_msg);
  fn_userlog(c_ServiceName,"Error in commit tran");
  fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 }
 
 break;

  case INSUF_FUNDS :
    fn_userlog(c_ServiceName,"Inside insufficient funds to block in Allocation");
    fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
    break;

  case GENERAL_FAILURE :
  case BLOCK_NOT_EXISTING :
  case INDERMINATE_FAILURE :
  case RERUN_FAILURE :                       
  default :
   fn_userlog(c_ServiceName,"In Indet failure,Rerun ,default case");
   fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );

    rtrim(c_bnk_narration); 

  i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

  if ( i_trnsctn == -1 )
  {
   fn_errlog(c_ServiceName, "L31325", LIBMSG, c_err_msg);
   strcpy ( c_msg, "System error. Contact system support" );
   fn_userlog(c_ServiceName,"Error in begin tran of fn_upd_adm_alloc_dtls");
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  EXEC SQL
  UPDATE FPD_FO_PEAKMRGN_DTLS
  SET       FPD_STATUS_FLG ='N'
  WHERE FPD_CLM_MTCH_ACCNT =:c_cln_mtch_accnt
  AND FPD_TRD_DT =:c_trd_dt
  AND FPD_RUN_NO =:li_run_no
  AND FPD_BATCH_SITE_IND =:c_rqst_typ
  AND FPD_BILL_NO = :c_bill_no;

  if ( SQLCODE != 0 )
  {
   fn_errlog( c_ServiceName, "L31335",SQLMSG,c_err_msg);
   fn_userlog(c_ServiceName,"Error in fetching data");
   fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
  {
   fn_errlog( c_ServiceName, "L31345",LIBMSG,c_err_msg);
   fn_userlog(c_ServiceName,"Error in commit tran");
   fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }


  d_bnk_bft_amt = d_bft_stts_amt;
  d_eba_bft_amt = d_bft_stts_amt;
  
  fn_errlog(c_ServiceName, "S31220",LIBMSG,c_err_msg);
  /*** Insert into Failure table ***/
  i_ret_val = fn_peak_flr_tbl( c_ServiceName,
                              c_xchng_cd,
                              c_cln_mtch_accnt,
                              li_run_no,
                              c_run_dt,
                              c_bnk_accnt,
                              BLOCK,
                              ALLC_FOR_ADM, 
                              CREDIT, /* ignore */
                              d_credit_amt,
                              d_amt_dbt_frm_alctn,
                              d_amt_dbt_frm_bft, 
                              NOT_UPDATED,
                              NOT_UPDATED,
                              NOT_UPDATED,              
                              c_reference,
                              c_timestamp,
                              c_bnk_narration,         
                              c_blk_deposit_flg,
														  c_bill_no); 

  if ( i_ret_val != 0 )
  {
   strcpy ( c_msg, "System error. Contact system support" );
   fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
   i_rc  = fn_insrt_peak_rpt_tbl(  c_ServiceName,
                                   c_xchng_cd,
                                   c_cln_mtch_accnt,
                                   c_run_dt,
                                   d_payout_amt,
                                   d_blk4trd_amt,
                                   d_payin_amt,
                                   d_intadj_amt,
                                   d_bnk_pipo_amt,
                                   d_eba_pipo_amt,
                                   d_bnk_bft_amt,
                                   d_eba_bft_amt,
                                   li_run_no,
                                   0,
                                   0,
                                   c_bnk_narration,     
                                   c_blk_deposit_flg,
																	 c_bill_no); 

   if ( i_rc != 0 )
   {
    fn_errlog(c_ServiceName, "S31225",LIBMSG,c_err_msg);
    strcpy( c_msg, "System error. Contact system support" );
    fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
  sprintf (c_msg,"Error sending BFT message on payout to bank for %s", c_cln_mtch_accnt);
  fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
  i_rc  = fn_insrt_peak_rpt_tbl(  c_ServiceName,
                                  c_xchng_cd,
                                  c_cln_mtch_accnt,
                                  c_run_dt,
                                  d_payout_amt,
                                  d_blk4trd_amt,
                                  d_payin_amt,
                                  d_intadj_amt,
                                  d_bnk_pipo_amt,
                                  d_eba_pipo_amt,
                                  d_bnk_bft_amt,
                                  d_eba_bft_amt,
                                  li_run_no,
                                  0,
 					                        0,
 													        c_bnk_narration,  
                                  c_blk_deposit_flg,
												          c_bill_no); 

  if ( i_rc != 0 )
  {
   fn_errlog(c_ServiceName, "S31230",LIBMSG,c_err_msg);
   strcpy( c_msg, "System error. Contact system support" );
   fn_bat_pst_msg_fno ( c_ServiceName, c_msg, c_tag );
   tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  break;
  }   
 }
 }  /*** End of Final Amount ***/

 tpreturn ( TPSUCCESS, SUCC_BFR, ( char * )ptr_fml_Ibuf, 0, 0 );

}


int fn_pkupd_alloc_dtls ( char *c_ServiceName,
                  char *c_err_msg,
                  char *c_cln_mtch_accnt,
                  char *c_xchng_cd,
                  char *c_run_dt,
                  char *c_bnk_accnt,
                  char *c_tag,
                  double d_bft_amt,
                  double d_alc_amt,
                  double d_isec_mrgn, 
                  long li_run_no,
                  double *d_tot_alct_amt,
                  double *d_tot_bft_amt)
{
 char c_narration[61];
 double d_temp_new_alcamt=0.0;
 double d_temp_new_bftamt=0.0;
 
 MEMSET(c_narration);

 if ( d_alc_amt < 0 && d_isec_mrgn > 0 )
 {
  strcpy(c_narration,"UD from Allocation and Add to NSE Isec Margin Amount");
 }
 else if ( d_bft_amt < 0 && d_isec_mrgn > 0 )
 {
  strcpy(c_narration,"UD from BFT and Add to NSE Isec Margin Amount"); 
 }

 fn_userlog(c_ServiceName,"Inside fn_pkupd_alloc_dtls"); 
 fn_userlog(c_ServiceName,"d_bft_amt :%lf:",d_bft_amt);
 fn_userlog(c_ServiceName,"d_alc_amt :%lf:",d_alc_amt);
 fn_userlog(c_ServiceName,"d_isec_mrgn :%lf:",d_isec_mrgn);

 EXEC SQL
 INSERT INTO FAL_FO_ALCBFT_LOG
 (
  FAL_CLM_MTCH_ACCNT,
  FAL_BNK_ACCNT,
  FAL_ALCTD_AMT,
  FAL_BFT_AMT,
  FAL_ISEC_MRGN_AMT,
  FAL_TRN_DT,
  FAL_NARRATION,
  FAL_ISEC_MRGN_AMT_BSE   
 )
 VALUES
 (
  :c_cln_mtch_accnt,
  :c_bnk_accnt,
  :d_alc_amt,
  :d_bft_amt,
  :d_isec_mrgn,
  to_date(:c_run_dt,'DD-Mon-YYYY'),//SYSDATE,
  :c_narration,
   0 
  );

  if ( SQLCODE != 0 )
  {
    fn_errlog( c_ServiceName, "L31335",SQLMSG,c_err_msg);
    fn_userlog(c_ServiceName,"Error in insert in FAL");
    return ( -1 );
  }

  EXEC SQL
    UPDATE FAB_FO_ALC_BFT_SMRY
    SET    FAB_BFT_AMT = NVL(FAB_BFT_AMT,0) + :d_bft_amt,
           FAB_ALCTD_AMT = NVL(FAB_ALCTD_AMT,0) + :d_alc_amt,
           FAB_ISEC_MRGN_AMT = nvl(FAB_ISEC_MRGN_AMT,0) + :d_isec_mrgn
    WHERE  FAB_CLM_MTCH_ACCNT = :c_cln_mtch_accnt
    AND    FAB_BNK_ACCNT = :c_bnk_accnt
    RETURNING FAB_BFT_AMT,
              FAB_ALCTD_AMT
    INTO :d_temp_new_bftamt,
         :d_temp_new_alcamt;

  if( SQLCODE != 0 )
  {
    fn_errlog( c_ServiceName, "L31340",SQLMSG,c_err_msg);
    fn_userlog(c_ServiceName,"Error in updating FAB");
    return(-1);
  }

  *d_tot_alct_amt = d_temp_new_alcamt; 
  *d_tot_bft_amt = d_temp_new_bftamt;
 
 if(DEBUG_MSG_LVL_3)
 {
   fn_userlog(c_ServiceName,"d_tot_bft_amt :%lf:",d_tot_bft_amt);
   fn_userlog(c_ServiceName,"d_tot_alct_amt :%lf:",d_tot_alct_amt);
 }	

  return 0 ;


}


int fn_insrt_peak_rpt_tbl( char *c_ServiceName,
                               char *c_xchng_cd,
                               char *c_cln_mtch_accnt,
                               char *c_run_dt,
                               double d_payout_amt,
                               double d_blk4trd_amt,
                               double d_payin_amt,
                               double d_intadj_amt,
                               double d_bnk_pipo_amt,
                               double d_eba_pipo_amt,
                               double d_bnk_bft_amt,
                               double d_eba_bft_amt,
                               long  li_run_no,
                               double d_bnk_adm_allc_amt,
                               double d_eba_adm_allc_amt,
                               char *c_bnk_narration,
                               char c_blk_deposit_flg,
                               char *c_bill_number
                             )
{

  int i_trnsctn ;
  char c_err_msg[256];
  char c_msg [ 256 ];
  char c_tag[256]; 
  int i_returncode;


  i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );
  if ( i_trnsctn == -1 )
  {
   fn_errlog(c_ServiceName, "S31235",LIBMSG,c_err_msg);
   return ( FAILURE );
  }

 if(DEBUG_MSG_LVL_3)
 {
   fn_userlog(c_ServiceName,"After begin  in ptr");
	 fn_userlog("c_bill_number :%s:",c_bill_number);
 }
  EXEC SQL
    INSERT INTO PTR_PFO_TRNSCTN_RCRD
    (
     PTR_CLM_MTCH_ACCNT,
     PTR_XCHNG_CD,
     PTR_PIPO_DT,
     PTR_PO_AMT,
     PTR_BFT_AMT,
     PTR_PI_AMT,
     PTR_INT_ADJ_AMT,
     PTR_BNK_AMT,
     PTR_EBA_AMT,
     PTR_BFT_BNK_AMT,
     PTR_BFT_EBA_AMT,
     PTR_RUN_NO,
     PTR_PRDCT_CD,
     PTR_PEAK_BNK_ALLC_AMT,
     PTR_PEAK_EBA_ALLC_AMT,
     PTR_NARRATION,
     PTR_FUND_MODEL_FLG,
     PTR_BILL_NO      
    )
    VALUES
    (
      :c_cln_mtch_accnt,
      :c_xchng_cd,
      to_date(:c_run_dt,'DD-Mon-YYYY'),
      :d_payout_amt,
      :d_blk4trd_amt,
      :d_payin_amt,
      :d_intadj_amt,
      :d_bnk_pipo_amt,
      :d_eba_pipo_amt,
      :d_bnk_bft_amt,
      :d_eba_bft_amt,
      :li_run_no,
      'ADM',
      :d_bnk_adm_allc_amt,
      :d_eba_adm_allc_amt,
      :c_bnk_narration,   
      :c_blk_deposit_flg,
      :c_bill_number  
    );

   if ( SQLCODE != 0 )
   {
      fn_errlog( c_ServiceName, "S31240",SQLMSG,c_err_msg);
      fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
      return ( FAILURE );
   }

   if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
   {
    fn_errlog( c_ServiceName, "S31245",LIBMSG,c_err_msg);
    fn_userlog(c_ServiceName,"Error in commit tran for FBM insert ");
    fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
    return ( -1 );
   }
   
   fn_userlog(c_ServiceName,"After commit in ptr");

   return ( SUCCESS );
}


int fn_peak_flr_tbl( char *c_ServiceName,
                    char *c_xchng_cd,
                    char *c_cln_mtch_accnt,
                    long  li_run_no,
                    char *c_run_dt,
                    char *c_bnk_accnt_no,
                    char  c_trn_typ,
                    int   i_block_cd,
                    char  c_dr_cr_flg,
                    double d_amount,
                    double d_amt_from_alloc,
                    double d_amt_from_bft,
                    char  c_bank_status,
                    char  c_eba_status,
                    char  c_process_status,
                    char  *c_reference,
                    char  *c_time,
                    char  *c_bnk_narration,
                    char  c_blk_deposit_flg,
                    char *c_bill_number)
{

  int i_trnsctn ;
  char c_err_msg[256];
  int i_returncode;
  char c_msg [ 256 ];
  char c_tag[256];
  char c_remarks[101];
 
  rtrim(c_reference);
  rtrim(c_bill_number);
 
 if(DEBUG_MSG_LVL_3)
 {
  fn_userlog(c_ServiceName,"INSIDE Failure function........Start");
  fn_userlog(c_ServiceName,"c_xchng_cd [%s]",c_xchng_cd);
  fn_userlog(c_ServiceName,"c_cln_mtch_accnt [%s]",c_cln_mtch_accnt);
  fn_userlog(c_ServiceName,"li_run_no [%d]",li_run_no);
  fn_userlog(c_ServiceName,"c_run_dt [%s]",c_run_dt);
  fn_userlog(c_ServiceName,"c_bnk_accnt_no [%s]",c_bnk_accnt_no);
  fn_userlog(c_ServiceName,"c_trn_typ [%c]",c_trn_typ);
  fn_userlog(c_ServiceName,"i_block_cd [%d]",i_block_cd);
  fn_userlog(c_ServiceName,"c_dr_cr_flg [%c]",c_dr_cr_flg);
  fn_userlog(c_ServiceName,"d_amount [%lf]",d_amount);
  fn_userlog(c_ServiceName,"c_bank_status [%c]",c_bank_status);
  fn_userlog(c_ServiceName,"c_eba_status [%c]",c_eba_status);
  fn_userlog(c_ServiceName,"c_process_status [%c]",c_process_status);
  fn_userlog(c_ServiceName,"c_reference [%s]",c_reference);
  fn_userlog(c_ServiceName,"c_time [%s]",c_time);
  fn_userlog(c_ServiceName,"c_bnk_narration [%s]",c_bnk_narration);
  fn_userlog(c_ServiceName,"c_blk_deposit_flg [%c]",c_blk_deposit_flg); 
  fn_userlog(c_ServiceName,"c_bill_number :%s:",c_bill_number);
  fn_userlog(c_ServiceName,"INSIDE Failure function........End");
 }

  i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );
  if ( i_trnsctn == -1 )
  {
   fn_errlog(c_ServiceName, "S31250",LIBMSG,c_err_msg);
   return ( FAILURE );
  }

   MEMSET(c_remarks);
   rtrim(c_bnk_narration);

    EXEC SQL
    INSERT INTO PBM_PFO_BNK_FLR_MSG
    (
     PBM_XCHNG_CD,
     PBM_CLM_MTCH_ACCNT,
     PBM_RUN_NO,
     PBM_RUN_DT,
     PBM_BNK_ACCNT_NMBR,
     PBM_TRNSCTN_TYP,
     PBM_BLK_CD,
     PBM_DC_FLG,
     PBM_AMT,
     PBM_AMT_DBFRM_ALLOC,
     PBM_AMT_DBFRM_BFT,
     PBM_STTS,
     PBM_BNK_STTS,
     PBM_TRACE,
     PBM_TIMESTAMP,
     PBM_RMRKS,
     PBM_PRDCT_CD,
     PBM_NARRATION,
     PBM_FUND_MODEL_FLG,
     PBM_BILL_NO
    )
    VALUES
    (
      :c_xchng_cd, 
      :c_cln_mtch_accnt, 
      :li_run_no, 
      :c_run_dt, 
      :c_bnk_accnt_no, 
      :c_trn_typ,
      :i_block_cd,
      :c_dr_cr_flg,
      :d_amount ,
      :d_amt_from_alloc,
      :d_amt_from_bft,
      :c_process_status,
      :c_bank_status,
      :c_reference, 
      to_date(:c_time,'yyyymmddhh24miss'), 
      :c_remarks,  
      'PK',
      :c_bnk_narration, 
      :c_blk_deposit_flg, 
      :c_bill_number 
    );


   if ( SQLCODE != 0 )
   {
      fn_errlog( c_ServiceName, "S31255",SQLMSG,c_err_msg);
      fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
      return ( FAILURE );
   }

   if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
   {
    fn_errlog( c_ServiceName, "S31260",LIBMSG,c_err_msg);
    fn_userlog(c_ServiceName,"Error in commit tran for FBM insert ");
    fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
    return ( -1 );
   }
   
   fn_userlog(c_ServiceName,"After commit in flr");

  return ( SUCCESS );
}



int fn_ins_pkdtls( char *c_mtch_acc,
                   char *c_bnk_acc,
                   char *c_trd_dt,
                   double d_tot_pk_mrgn,
                   double d_plg_amt,
                   double d_old_alctd_amt,
                   double d_old_bft_amt,
                   double d_old_isec_mrgn,
                   char *c_run_dt,
                   long l_run_no,
                   double d_pk_mrgn_todebited,
                   char c_dr_cr_flg,
                   double d_nwb_amt,
                   char c_call_flg,
                   char *c_xchng_cd,
                   double d_alct_tobe_dbt,
                   double d_bft_tobe_dbt,
                   double d_old_fdr,
                   double d_new_fdr,
                   char c_fund_flg,
									 char *c_bill_no                                                  
                  )

{

  double d_temp_cr_amt =0;
/*** 
  i_trnsctn = fn_begintran( c_ServiceName, c_err_msg );

  if ( i_trnsctn == -1 )
  {
   fn_errlog(c_ServiceName, "S31265",LIBMSG,c_err_msg);
   return ( FAILURE );
  }
***/
  d_temp_cr_amt = d_alct_tobe_dbt + d_bft_tobe_dbt ;
 if(DEBUG_MSG_LVL_3)
 {
  fn_userlog(c_ServiceName,"c_mtch_acc :%s:",c_mtch_acc);        
  fn_userlog(c_ServiceName,"c_bnk_acc :%s:",c_bnk_acc);      
  fn_userlog(c_ServiceName,"c_trd_dt :%s:",c_trd_dt);       
  fn_userlog(c_ServiceName,"d_tot_pk_mrgn :%lf:",d_tot_pk_mrgn);   
  fn_userlog(c_ServiceName,"d_plg_amt :%lf:",d_plg_amt);    
  fn_userlog(c_ServiceName,"d_old_alctd_amt :%lf:",d_old_alctd_amt);    
  fn_userlog(c_ServiceName,"d_old_bft_amt :%lf:",d_old_bft_amt);       
  fn_userlog(c_ServiceName,"d_old_isec_mrgn :%lf:",d_old_isec_mrgn);      
  fn_userlog(c_ServiceName,"c_run_dt :%s:",c_run_dt);   
  fn_userlog(c_ServiceName,"l_run_no :%ld:",l_run_no);    
  fn_userlog(c_ServiceName,"c_dr_cr_flg :%c:",c_dr_cr_flg);   
  fn_userlog(c_ServiceName,"d_nwb_amt :%lf:",d_nwb_amt);         
  fn_userlog(c_ServiceName,"c_call_flg :%c:",c_call_flg);   
  fn_userlog(c_ServiceName,"c_xchng_cd :%s:",c_xchng_cd);       
  fn_userlog(c_ServiceName,"d_bft_tobe_dbt :%lf:",d_bft_tobe_dbt); 
  fn_userlog(c_ServiceName,"d_alct_tobe_dbt :%lf:",d_alct_tobe_dbt); 
  fn_userlog(c_ServiceName,"d_old_fdr :%lf:",d_old_fdr);  
  fn_userlog(c_ServiceName,"d_new_fdr :%lf:",d_new_fdr); 
  fn_userlog(c_ServiceName,"c_fund_flg :%c:",c_fund_flg);     
  fn_userlog(c_ServiceName,"d_temp_cr_amt :%lf:",d_temp_cr_amt);
	fn_userlog(c_ServiceName,"c_bill_no :%s:",c_bill_no);
 }

  EXEC SQL
  INSERT INTO FPD_FO_PEAKMRGN_DTLS
  (
   FPD_CLM_MTCH_ACCNT,
   FPD_BNK_ACCNT,
   FPD_TRD_DT,
   FPD_TOTAL_PEAK_MARGIN,
   FPD_OLD_PLG_AMT,
   FPD_OLD_ALCTD_AMT,
   FPD_OLD_BFT_AMT,
   FPD_OLD_ISEC_MRGN_AMT,
   FPD_RUN_DT,
   FPD_RUN_NO,
   FPD_DBCR_CD,
   FPD_BILL_PST_FLG,
   FPD_BILL_PST_DT,
   FPD_NWB_AMT,
   FPD_BATCH_SITE_IND,
   FPD_XCHNG_CD,
   FPD_TO_DB_BFT_AMT,
   FPD_TO_DB_ALCTD_AMT,
   FPD_TO_CR_ALCTD_AMT, 
   FPD_OLD_FDR_AMT,
   FPD_NEW_FDR_AMT,
   FPD_NEW_PLG_AMT,
   FPD_PEAK_MARGIN_TOBE_DEBITED,
   FPD_FUND_MODEL_FLG,
   FPD_STATUS_FLG,
	 FPD_BILL_NO
  )
  VALUES
  (
   :c_mtch_acc,
   :c_bnk_acc,
   :c_trd_dt,
   :d_tot_pk_mrgn,
   :d_plg_amt,
   :d_old_alctd_amt,
   :d_old_bft_amt,
   :d_old_isec_mrgn,
   SYSDATE, 
   :l_run_no,
   :c_dr_cr_flg,
   'N', 
   null,
   :d_nwb_amt,
   :c_call_flg,
   :c_xchng_cd,
   :d_bft_tobe_dbt,
   :d_alct_tobe_dbt,
    DECODE(:c_call_flg,'S',:d_temp_cr_amt,0), 
   :d_old_fdr,
   :d_new_fdr,
   :d_plg_amt,
   :d_pk_mrgn_todebited,
	 :c_fund_flg,
   'N',
	 :c_bill_no
  ); 
       
  if ( SQLCODE != 0 )
  {
   fn_errlog( c_ServiceName, "S31270",SQLMSG,c_err_msg);
   fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
   return ( FAILURE );
  }
/***
  if ( fn_committran( c_ServiceName, i_trnsctn, c_err_msg ) == -1 )
  {
   fn_errlog( c_ServiceName, "S31275",LIBMSG,c_err_msg);
   fn_userlog(c_ServiceName,"Error in commit tran for FBM insert ");
   fn_aborttran( c_ServiceName, i_trnsctn, c_err_msg );
   return ( -1 );
  }
***/
  return 0;
}

