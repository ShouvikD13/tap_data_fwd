/*******************************************************************************/
/*	Program	    			:	SFO_GET_CNTRCT                                        */
/*                                                                            */
/*  Input             : FFO_USR_ID                                            */
/*                      FFO_SSSN_ID                                           */
/*                      FFO_XCHNG_CD                                          */
/*                      FFO_PRDCT_TYP                                         */
/*                      FFO_UNDRLYNG                                          */
/*                      FFO_OPT_TYP                                           */
/*                      FFO_RQST_TYP                                          */
/*                      FFO_ROUT_CRT                                          */
/*                                                                            */
/*  Output            : FFO_XCHNG_CD                                          */
/*                      FFO_PRDCT_TYP                                         */
/*                      FFO_UNDRLYNG                                          */
/*                      FFO_OPT_TYP                                           */
/*                      FFO_EXPRY_DT                                          */
/*                      FFO_EXER_TYP                                          */
/*                      FFO_STRK_PRC                                          */
/*                      FFO_CTGRY_INDSTK                                      */
/*                      FFO_LST_TRD_PRC                                       */
/*                      FFO_ERR_MSG                                           */
/*                      FFO_SYS_MSG                                           */
/*                                                                            */
/*  Description       : To fetch the contract details for a given             */
/*                      request type                                          */
/*                      F - FAVOURITE_CONTRACTS                               */
/*                      O - FOR_QUOTES_ORDERS                                 */
/*                      U - FROM_UNDERLYING                                   */
/*                      A - FROM_STOCKLST_ENABLED                             */
/*                      B - FROM_STOCKLST_DISABLED                            */
/*                      R - FROM_ROLLOVER         ver 2.0                     */
/*                      C - CLOUD_ORDERS          Ver 3.2                     */
/*                      M - FOR_QUOTES_MONEY_TYPE         Ver 4.0             */
/*                      P - FROM_SPREAD_CNTRCTS   Ver 4.2                     */
/*                      K - GET_CNT_R_SPD_CNTRCT  Ver 4.2                     */
/*                      E - ALL_EXPIRY_DATES Ver 5.1                          */
/*																																						*/
/*  Log               : 1.0   19-Sep-2001   Vinod Banjan                      */
/*										: 1.1   03-Mar-2008   Sandeep Patil											*/
/*										: 1.2   19-Mar-2008   Smitha Nuti												*/
/*                    : 1.3   28-May-2009		Indrajit Bhadange                 */
/*                    : 1.4   22-Jan-2010		sangeet 					                */
/*                    : 1.5   22-May-2010		Venture M					                */
/*                    : 1.6   30-Dec-2010   Shailesh H                        */
/*                    : 1.7   21-Jan-2011   Sangeet S                         */
/*                    : 1.8   15-Feb-2011   Shailesh H                        */
/*                    : 1.9   27-Jun-2011   Swati Bharankar                   */
/*										: 2.0   17-Oct-2012   Vishnu Nair												*/
/*                    : 2.1   22-Mar-2013   Sandip T                          */
/*										: 2.2   21-Nov-2012   Navina D       										*/
/*                    : 2.3   20-Jan-2014   Vishnu Nair		                    */
/*										:	2.4		10-Sep-2013		Swati A.B									        */ 
/*                    : 2.5   12-Feb-2014   Sachin Birje                      */
/*                    : 2.6   27-Feb-2014   Mahesh Shinde											*/
/*                    : 2.7   13-feb-2015   Anand Dhopte                      */ 
/*										:	2.8		22-Jul-2015		Tanmay Warkhade										*/
/*										: 3.0 	06-Oct-2015		Kishor Borkar											*/						
/*                    : 3.1   03-Nov-2015   Anand Dhopte                      */
/*                    : 3.2   15-Dec-2015   Kishor Borkar                     */
/*										: 3.3		18-Dec-2015		Kishor Borkar											*/
/*										: 3.4		14-Mar-2016		Sachin Birje 											*/
/*                    : 3.5   17-Aug-2016   Bhupendra Malik                   */
/*                    : 3.6   05-Apr-2017   Navina D.                         */
/*										: VQC   11-Sep-2017 	Afzal K.													*/	
/*                    : 3.7   25-Oct-2017   Tanmay Patel                      */
/*										:	3.8		14-Aug-2018		Parag Kanojia											*/
/*                    : 3.9   07-AUG-2018   Suchita Dabir.                    */
/*                    : 4.0   11-Dec-2018   Parag Kanojia                     */
/*                    : 4.1   27-Feb-2019   Parag Kanojia	                    */
/*                    : 4.2   30-Nov-2017   MRINAL KISHORE                    */
/*                    : 4.3   10-Oct-2020   Suchita Dabir                     */
/*                    : 4.5   22-Apr-2021   Suchita Dabir                     */
/*										:	4.6		11-Jan-2022		Shlok Ghan												*/
/*										:	4.7   22-Jul-2022   Naveena R 												*/
/*										:	4.8   13-Oct-2022   Ravi Malla 												*/
/*										:	4.9   29-Nov-2022   Kunwar Prashant 									*/
/*										:	5.0   15-Dec-2022   Kunwar Prashant                   */
/*                    : 5.1   15-Mar-2023   Tanweer Alam and Kunwar Prashant  */
/*                    : 5.2   21-Mar-2023   Kunwar Prashant                   */
/*                    : 5.3   17-May-2023   Ravi Malla                        */
/******************************************************************************/
/*  1.0  -  New release                                                       */
/*  1.1  -  IBM MIGRATION CHANGES																							*/
/*  1.2  -  FP CHANGES                                                        */
/*  1.3  -  CRCSN2815 Open Position Update																		*/
/*  1.4  -  Removing Session check																						*/
/*  1.5  -  Common Quote CR changes																						*/
/*  1.6  -  Optimization of FCM select and sfo_get_qt                         */
/*  1.7  -  To send only enabled or only disabled data												*/
/*  1.8  -  Common Quote CR changes re-applied																*/
/*  1.9  -  SPAN Changes- Lot Size to be Sent                                 */
/*	2.0  -  Changes for ROLLOVER																							*/
/*  2.1  -  FNO_BSE_SPAN Changes                                              */
/*  2.2  -  SLTP FuturePLUS Handling		                                      */
/*  2.3  -  Spot Price Selection Introduced                                   */
/*	2.4	 -	Changes for OptionPlus 																						*/	
/*  2.5  -  View Change for storing total val traded in exchnage              */
/*  2.6  -  Handling of INDIA VIX (CR_ISEC14_48665) Mahesh Shinde							*/ 
/*  2.7  -  FCM_FO_CNTRCT_MSTR and FTQ_FO_TRD_QT merger changes               */
/*	2.8	 -  Market to Limit in FP SLTP																				*/
/*	3.0	 -	Market to Limit in OPTION PLUS																		*/
/*  3.1  -  FFO_LST_TRD_TM FML added in output                                */
/*  3.2  -  Cloud Order Changes                                               */
/*	3.3	 -	Bussiness Error code added.																				*/	 
/*	3.4	 -  Display only FP SLTP Enabled contracts         										*/	 
/*  3.5  -  Future Trail                                                      */
/*  3.6  -  Limit option for FPSLTP orders placed through Fut,FutPls view mrgn*/
/*  VQC	 -  Version Quality Control changes 							 										*/
/*  3.7  -  Hard coding                                                       */
/*	3.8	 -	Physical Settlement of Stock Derivative Phase 2 Changes						*/
/*  3.9  -  Allow rollover for both the values of trading allowed flag        */
/*  4.0  -  Provision for filtering option strike (CR-ISEC10-116714)          */
/*  4.1  -  CR-ISEC14-120203 Option Plus Place order through Get Quote        */
/*  4.2  -  Rollover with Spread CR                                           */
/*  4.3  -  Oplus changes ( Suchita )                                         */
/*  4.4  -  ELM% for Deep OTM Option for SPAN and Non SPAN CR-ISEC14-141383   */
/*  4.5  -  View Margin link in Option and option plus product (Suchita Dabir)*/
/*	4.6	 -  CR-ISEC14-162076 for enhancements in Existing Equity Derivative Order Journey */
/*  4.7  -  CR-ISEC14-170021 Revision of Margin logic : Margin Req on order plc*/ 
/*  4.8  -  CR-ISEC10-CR-ISEC10-170548 - FNO i-Alert 													*/
/*  4.9  -  FNO i-Alert Minor Changes for ITM																	*/
/*  5.0  -  FNO i-Alert OTM i-alert from 95% to 90%														*/
/*  5.1  -  WatchList Expiry Date for OptionChain                                              */
/*  5.2  -  CR-ISEC14-182394_ Pop-up message for contract under surveillance in Equity Derivatives Segment. */
/*  5.3  -  Adding debug levels 																							*/
/******************************************************************************/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sqlca.h>
#include <atmi.h>
#include <fml32.h>
#include <fo.h>
#include <fo_fml_def.h>
#include <fo_view_def.h>
#include <fml_def.h> /** ver 4.6 ***/
/****commented in Ver VQC**
#include <fn_session.h>
****/
#include <fn_tuxlib.h>    /*** Uncommented in Ver 4.0 ***/

#include <fn_ddr.h>
#include <fn_log.h>
#include <fn_read_debug_lvl.h>			/*** Ver 1.1 ***/
/**Ver VQC** #include <time.h>					**Ver 1.6 **   **/

#include <math.h> /** Ver 4.8 **/

/****************** 1.5 ******************/
/**Commented in Ver 1.8 #define ALL 'Z'
*******/

#define ALL_CNTRCTS 'N'		/**Ver 1.8**/
#define FROM_ROLLOVER 'R' /** Ver 2.0 **/
#define FOR_QUOTES_MONEY_TYPE 'M'   /** Ver 4.0 **/
#define TOTAL_FTQ_RECS  1500       /** Ver 4.0 **/
#define FROM_SPREAD_CNTRCTS 'P'    /** Ver 4.2 **/
#define GET_CNT_R_SPD_CNTRCT 'K'   /** Ver 4.2 **/
#define OTM_ALERT 0.1 /*** Ver 4.8 ***/

#define ALL_EXPIRY_DATES 'E'       /** Ver 5.1 **/
#define STK_SURV 'S'	/* Ver 5.2 */
EXEC SQL INCLUDE "table/sim_surv_indctr_mstr.h";     /*** Ver 5.2 ***/


int fn_call_get_qt(char *c_ServiceName,
                   struct vw_contract *ptr_st_contract,
                   struct vw_cntrct_qt *ptr_st_cntrct_qt,
                   char *c_err_msg
                  );

/*** 4.8 Start ***/

double vol_ecall(char* c_ServiceName,double spot, double strike, double maturity, double interest, double mktprice);
double vol_eput(char* c_ServiceName,double spot, double strike, double maturity, double interest, double mktprice);
double delta_eurpcall(char* c_ServiceName,double spot, double strike, double maturity, double vol, double interest);
double delta_eurpput(char* c_ServiceName,double spot, double strike, double maturity, double vol, double interest);

/*** 4.8 End ***/

/***ver VQC***

void fn_gettime(void); 

char c_time[12]; ****/

struct st_ftq_records      /*** Structure Added in Ver 4.0 ***/
{
  char  c_xchng_cd[4];
  char  c_prd_typ;
  char  c_undrlyng[7];
  char  c_expiry_dt[21];
  char  c_exrc_typ;
  char  c_opt_typ;
  long  l_strike_prc;
  long l_lot_sz;
  char  c_ctgry_indstk;
  char c_trading_flg;
  long  l_lst_trdd_prc;
  char  c_lst_trdd_time[23];
  char c_trail_flag;
  char c_setlmnt_flg_tmp;
  char  c_money_typ;
	double d_otm_oth_expsr;	/*** ver 4.6 ***/
	double d_spn_per_lot;	/*** ver 4.6 ***/
	double d_spn_multplr;	/*** ver 4.6 ***/
  double d_somc_prcnt; /** ver 4.6 ***/
  double d_otm_oth_prcnt; /*** ver 4.6 **/
  double d_init_mrgn_prcnt; /*** ver 4.6 ***/
  double d_sebi_buy_opls_prcnt; /** ver 4.6 ***/
  double d_opls_flat_rate; /** ver 4.6 ***/
  double d_sebi_sell_opls_prcnt; /*** ver 4.6 ***/
  double d_sell_pls_exp_prcnt; /*** ver 4.6 ***/
  double d_spn_per_lot_b; /** ver 4.6 **/
};
struct ft_und_expiry         /*** Structure Added in Ver 5.1 ***/
{
 char  c_prod_typ;
 char  c_expiry_date[21];
 char  c_undrlying[7];
};

void SFO_GET_CNTRCT( TPSVCINFO *rqst )
{
	FBFR32 *ptr_fml_Ibuf;
	FBFR32 *ptr_fml_Obuf;

	char c_ServiceName[33];
	varchar c_err_msg[256];  /*** VQC Changed data type from char to varchar ***/
	varchar c_alert_msg[256];  /*** Ver 4.8 ***/
	double d_prob=0.0; /*** Ver 4.8 ***/
  double d_expr_prcnt=0.0; /** ver 4.5 **/
	
  /** char c_msg[256]; **commented in  VQC**/

	char c_allwd_flg = '\0';  /***  Ver 2.8 ***/
  char c_xchng_cd [4];      /***  Ver 2.3 ***/
  char c_lmt_mktsl_flg='\0'; /*** Ver 3.2 ***/
  char c_trail_flag='N';    /*** Ver 3.5 ***/
  char c_trail_flag_und='N'; /** Ver 3.5 **/
  char c_qt_trdng_flg = 'T';  /** Ver 3.7 **/ 
	char c_prdct_flg = '\0';    /** Ver 3.7 **/
  char c_rqst_type = '\0';    /** Ver 3.7 **/
  char c_rollov_flg = '\0';   /** Ver 3.7 **/
	char c_setlmnt_flg_tmp = 'C';	/** Ver 3.8 **/
	char c_setlmnt_flg = 'N';		/** Ver 3.8 **/
  char c_oth_otm_flg = '\0';  /** ver 4.4 **/
  int i_returncode;
  int i_err[10];	/*** ver 4.6 change from 2 to 5 ***/
  int i_cnt;
  double d_span_per_lot = 0.0; /** ver 4.3 **/
	double d_exposure = 0.00;	/*** ver 4.6 ***/
	double d_spn_per_lot = 0.00; /*** ver 4.6 ***/
	double d_spn_per_lot_b = 0.00; /*** ver 4.6 ***/
	double d_spn_multplr = 0.00;	/*** ver 4.6 ***/
 double d_span_init_prcnt = 0.00;  /*** ver 4.6 ***/
  double d_init_mrgn_prcnt = 0.0; /*** ver 4.6 ***/
	double d_otm_oth_expsr = 0.00; /*** ver 4.6 ***/ 
  double d_somc_prcnt = 0.0; /** ver 4.6 ***/
  double d_otm_oth_prcnt=0.0; /*** ver 4.6 ***/
  double d_sebi_buy_opls_prcnt = 0.0; /** ver 4.6 ***/
  double d_opls_flat_rate= 0.0; /** ver 4.6 ***/
  double d_fmm_fpsl_spn_mrgn_prcnt= 0.0;/** ver 4.6 ***/
  /** commented in  VQC*
	int i_ferr[2];
  int i_ip_en;
	int i_op_len; 
	long	l_record_cnt ;***/

	long	l_strike_prc = 0 ;  /**** Initialized in ver VQC***/
  long  l_lst_trdd_prc = 0; /*** Ver 2.7 ***/
  long  l_ordr_qty=0;       /*** Ver 3.2 ***/
  long  l_trail_amt=0;    /*** Ver 3.5 ***/
	int 	i_counter = 1;
/**	int 	i_counter1 = 1; **commented in  VQC**/
	int   i_rec_count=0;                      /*** Ver 2.1 ***/
	int    i_buf_len=0;												/*** Ver 2.3	***/
	double d_spot_prc = 0.0;      						/***  Ver 2.3 ***/
	double d_prev_spot_prc = 0.0;      						/***  Ver 2.3 ***/
	double d_max_spot_prc = 0.0;      						/***  Ver 4.7 ***/
  double d_cvr_sltp_diff=0.0;               /*** Ver 3.2 ***/
	char  c_money_typ='\0';                   /*** Ver 4.0 ***/
  struct st_ftq_records st_ftq_recs[TOTAL_FTQ_RECS];            /*** Ver 4.0 ***/
  struct ft_und_expiry st_und_expiry[TOTAL_FTQ_RECS];                       /*** Ver 5.1 ***/
  MEMSET(st_ftq_recs);          /*** Ver 4.0 ***/
  int i_row_count=0;            /*** Ver 4.0 ***/
	char c_spn_flg = '\0';        /*** Ver 4.7 ***/
  MEMSET(st_und_expiry);        /*** Ver 5.1 ***/

	/*** Ver 4.8 Start ***/
	FBFR32 *ptr_fml_Rbuf;
	FBFR32 *ptr_fml_Sbuf;
	ptr_fml_Rbuf=NULL;ptr_fml_Sbuf=NULL;
	char c_user_id_tmp[7]="\0";
	char c_exer_typ = 'E';
	char c_loss_alrt_flg='N',c_prft_alrt_flg='N';
	char c_otm_alrt_flg='N',c_mwpl_ban_alrt_flg='N',c_mwpl_alrt_flg='N';	
	char c_err_flag='N';	/* B - Ban , N - None , O - OTM Ver 5.2 */
	char c_err_type='N';	/* P - Popup , M - Message , N - None */
	
	int i_count=0;
	int ban_cnt=0;
	long d_prft_lmt=0;
	long d_loss_lmt=0;
	long l_session_id_tmp=0;
	long l_bufferlength=0;

	double d_dividend = 0.25;
	double d_interest_rt = 0.10;
	double d_undrlyng_val_rupee = 0.00;
	double d_delta=0.00;
	double d_imp_vol=0.00;

	double d_strike=0;
	double d_lsttrd_prc = 0;

	double d_days_to_exp=0,d_days_to_exp_temp=0;


	int i_ferr[4];	/* 3 Changed to 4 in Ver 5.2 */
	 
	/*** Ver 4.8 End ***/

	EXEC SQL BEGIN DECLARE SECTION;
    sql_cursor     sys_cursor;             /* a cursor variable */
		sql_cursor	sys_cursor1;		/*** ver 4.6 ***/ 
		struct vw_contract st_i_cntrct;
		struct vw_contract *ptr_o_st_cntrct;
		struct vw_contract st_contract;
		struct vw_cntrct_qt st_cntrct_qt;
	
   /**	long l_mac_cnt; **commented in VQC**/

		long l_lot_sz = 0;  /**Initialized in ver VQC***/
		char c_usrid[9];   
		char c_exchange_code[4]; 

	  char c_underlying[7];
	  char c_product_type;
	  char c_option_type;
	  char c_trading_flg;
		char c_roll_flg; /* Ver 2.0 */
    varchar c_expiry_dt [ LEN_DATE ];
		varchar c_expry_dt[LEN_DATE]; /* Ver 2.0 */
    char  c_lst_trdd_time[23];   /*** Ver 3.1 ***/ 
    char  c_expry_dt1[ LEN_DATE ]; /*** Ver 3.2 ***/ 
    char  c_spd_roll_flg = '\0';        /*** Ver 4.2 ***/
    char  c_sprd_expry_dt[LEN_DATE];    /*** Ver 4.2 ***/
    varchar c_s_exp_dt1 [ LEN_DATE ];   /*** Ver 4.2 ***/
    varchar c_s_exp_dt2 [ LEN_DATE ];   /*** Ver 4.2 ***/

    /** Ver 5.2 Start **/
    long sql_xsm_surv_ind ;             
    varchar sql_sim_desc[100] ;      
    varchar sql_sim_short_cd[50] ;  
    char c_msg[500];        
    /** Ver 5.2 End **/
	
   EXEC SQL END DECLARE SECTION;

   /***Added in Ver VQC***/
   ptr_fml_Ibuf = NULL;
   ptr_fml_Obuf = NULL;
   /****Ver VQC***/

   /** ver 4.6 starts ***/
  double d_fmm_sltp_diff = 0.0;
  double d_fmm_sltp_sebi = 0.0;
  double d_fmm_sltp_prcnt = 0.0;
 /*** ver 4.6 ends **/

		struct vw_usr_prfl st_usr_prfl;
/**		struct vw_err_msg st_err_msg; **commented in VQC**/

	ptr_fml_Ibuf = (FBFR32 *)rqst->data;
	strcpy( c_ServiceName, rqst->name );

	INITDBGLVL(c_ServiceName);			 /*** Ver 1.1 ***/

  MEMSET(c_lst_trdd_time);         /*** Ver 3.1 ***/
	MEMSET(c_alert_msg.arr);				/** Added in 5.2 **/

	MEMSET(c_err_msg); /**Added in ver VQC**/

  ptr_o_st_cntrct = ( struct vw_contract * ) tpalloc ( "VIEW32",
                                                       "vw_contract",
                                               sizeof ( struct vw_contract ) );
  if ( ptr_o_st_cntrct == NULL )
	{
		fn_errlog( c_ServiceName, "S31005", TPMSG, c_err_msg.arr  );  
		Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
		tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
	}	
	memset ( ptr_o_st_cntrct, 0, sizeof ( struct vw_contract ) );

	i_returncode = Fvftos32( ptr_fml_Ibuf, 
                           (char *) &st_i_cntrct, 
                           "vw_contract" );
	if ( i_returncode == -1 )
	{
		fn_errlog( c_ServiceName, "S31010", FMLMSG, c_err_msg.arr  ); 
		tpfree ( ( char * ) ptr_o_st_cntrct );
		Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
		tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
	}

  rtrim(st_i_cntrct.c_undrlyng);

	i_returncode = Fvftos32( ptr_fml_Ibuf, 
                           (char *) &st_usr_prfl, 
                           "vw_usr_prfl" );
	if ( i_returncode == -1 )
	{
		fn_errlog( c_ServiceName, "S31015", FMLMSG, c_err_msg.arr  ); 
		tpfree ( ( char * ) ptr_o_st_cntrct );
		Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
		tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
	}

  /*** Added for Order Routing ***/
  fn_init_ddr_val ( st_i_cntrct.c_rout_crt );
/**** Ver 1.4 *****/
/*****  i_returncode = fn_chk_sssn( c_ServiceName, &st_usr_prfl,
																						 &st_err_msg ) ;

  if ( i_returncode == -1 )
  {
	  tpfree ( ( char * ) ptr_o_st_cntrct );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, st_err_msg.c_err_msg, 0 );
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
*****/
/**** Ver 1.4 ends *****/

 /*** ver 4.6 starts ***/
 if(DEBUG_MSG_LVL_2)
 {
  fn_userlog( c_ServiceName, "Order Journey PRINT :%s: strkr :%ld:",st_i_cntrct.c_expry_dt,st_i_cntrct.l_strike_prc);
 }
 /** ver 4.6 ends ***/ 
 
	strcpy( c_usrid,st_usr_prfl.c_user_id) ;  
	strcpy( c_exchange_code,st_i_cntrct.c_xchng_cd) ;  
	strcpy( c_underlying,st_i_cntrct.c_undrlyng) ; 
	c_product_type= st_i_cntrct.c_prd_typ ;
	c_option_type= st_i_cntrct.c_opt_typ ;
  if(st_i_cntrct.c_rqst_typ == CLOUD_ORDERS) /** Ver 3.2 **/
  {
    strcpy( c_expry_dt1,st_i_cntrct.c_expry_dt); 
    l_strike_prc = st_i_cntrct.l_strike_prc;
  }

/** ver 4.6 starts ***/
 if ( st_i_cntrct.c_rqst_typ == FROM_UNDERLYING || st_i_cntrct.c_rqst_typ == FOR_QUOTES_ORDERS || st_i_cntrct.c_rqst_typ == FOR_QUOTES_MONEY_TYPE)
  {
    strcpy( c_expry_dt1,st_i_cntrct.c_expry_dt);
    l_strike_prc = st_i_cntrct.l_strike_prc;
  }
/*** ver 4.6 ends ****/

 if(DEBUG_MSG_LVL_2) 
 {	
  fn_userlog( c_ServiceName, "SH-Common Get Quote:Request type is :%c",st_i_cntrct.c_rqst_typ);
  fn_userlog( c_ServiceName, "SUCHITA c_cln_mtch_accnt :%s:",st_usr_prfl.c_cln_mtch_accnt); /** ver 4.5 **/	
	
	/*** Ver 2.4 ***/
  fn_userlog( c_ServiceName, "User is :%s",c_usrid);  
  fn_userlog( c_ServiceName, "c_exchange_code is :%s",c_exchange_code); 
  fn_userlog( c_ServiceName, "c_underlying is :%s",c_underlying);
  fn_userlog( c_ServiceName, "c_product_type is :%c",c_product_type);
  fn_userlog( c_ServiceName, "c_option_type is :%c",c_option_type);
	/*** Ver 2.4 ***/
 }

  EXEC SQL ALLOCATE :sys_cursor;
  
  /****************** 1.5 ******************/

	/*** Ver 4.0 Starts ***/

  if(DEBUG_MSG_LVL_3)
  {
    fn_userlog(c_ServiceName," Input Exchange Code Is :%s:",c_exchange_code);
    fn_userlog(c_ServiceName," Input Exchange Underlying Is :%s:",c_underlying);
  }

  if ( strcmp(c_exchange_code,"NFO") == 0 )
  {
    strcpy( c_xchng_cd ,"NSE");
  }
  else if ( strcmp(c_exchange_code,"BFO") == 0 )
  {
    strcpy( c_xchng_cd ,"BSE");
  }

  EXEC SQL
    SELECT  NVL(LTQ_RT,0.0),
						NVL(LTQ_PREV_CLS_PRC,0.0) /*** Ver 4.7 ***/
    INTO    :d_spot_prc,
						:d_prev_spot_prc	  /*** Ver 4.7 ***/
    FROM    LTQ_TRD_QT
    WHERE   LTQ_XCHNG_CD  = :c_xchng_cd
    AND     LTQ_STCK_CD   = :c_underlying;

  if ( SQLCODE  !=  0 && SQLCODE  != NO_DATA_FOUND)
  {
    fn_errlog( c_ServiceName, "S31020", SQLMSG, c_err_msg.arr  );
    EXEC SQL FREE :sys_cursor;
    tpfree ( ( char * ) ptr_o_st_cntrct );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
  if( SQLCODE == NO_DATA_FOUND)
	{
    fn_errlog( c_ServiceName, "B21000"," " , c_err_msg.arr );
    EXEC SQL FREE :sys_cursor;
    tpfree ( ( char * ) ptr_o_st_cntrct );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

	if (strcmp(c_underlying,"INDVIX") == 0)
  {
    d_spot_prc = d_spot_prc/100;
    d_prev_spot_prc = d_prev_spot_prc/100; /*** Ver 4.7 ***/
  }

  /*** Ver 4.0 Ends ***/
/*** Ver 5.1 Starts ***/
 if(st_i_cntrct.c_rqst_typ == ALL_EXPIRY_DATES)
 {
    EXEC SQL
    SELECT * into :st_und_expiry FROM
    (
     SELECT A.* FROM (
              SELECT distinct FTQ_PRDCT_TYP,
                               TO_CHAR(FTQ_EXPRY_DT,'DD-Mon-YYYY'),
                               FTQ_UNDRLYNG
              FROM  FTQ_FO_TRD_QT
              WHERE
                    FTQ_XCHNG_CD = :c_exchange_code
                AND FTQ_UNDRLYNG = :c_underlying AND FTQ_QT_TRDNG_FLG = :c_qt_trdng_flg
                      )A
         );
    i_row_count=sqlca.sqlerrd[2];
    if (SQLCODE != 0)
    {
        if ( SQLCODE == NO_DATA_FOUND )
        {
         fn_userlog(c_ServiceName,"No more data to process");
        }
				else
				{
        fn_errlog( c_ServiceName, "S31025", SQLMSG, c_err_msg.arr);
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
				}
    }
  for ( i_cnt=0; i_cnt<i_row_count; i_cnt++ )
    {
   i_returncode = fn_pack_vartofml ( c_ServiceName,
                                  c_err_msg.arr,
                                  &ptr_fml_Obuf,
                                  3,
    FFO_PRDCT_TYP,    (char *)&st_und_expiry[i_cnt].c_prod_typ,
    FFO_UNDRLYNG,     (char *)st_und_expiry[i_cnt].c_undrlying,
    FFO_EXPRY_DT,     (char *)st_und_expiry[i_cnt].c_expiry_date
   );
      if ( i_returncode == -1 )
      {
        fn_errlog ( c_ServiceName, "S22222", LIBMSG, c_err_msg.arr );
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }   
		tpreturn( TPSUCCESS, 0, (char *)ptr_fml_Obuf, 0 , 0 );
  }
 /*** Ver 5.1 Ends ***/

	if ( st_i_cntrct.c_rqst_typ == FAVOURITE_CONTRACTS )
	{
		c_rqst_type='F';        /*** Ver 3.7 ***/
   /* Ver 1.3 Start */
		if(DEBUG_MSG_LVL_3) 
		{	
			fn_userlog( c_ServiceName, "Request type is FAVOURITE_CONTRACTS :%c",st_i_cntrct.c_rqst_typ);
    }
		/* Ver 1.3 End */
		EXEC SQL EXECUTE
      BEGIN
          OPEN :sys_cursor FOR 
						SELECT	FFC_XCHNG_CD,
									  FFC_PRDCT_TYP,
                    FFC_UNDRLYNG,               
                    TO_CHAR(FFC_EXPRY_DT,'DD-Mon-YYYY'),                        
                    FFC_EXER_TYP,                             
                    FFC_OPT_TYP,                                   
                    FFC_STRK_PRC,                                       
                    FFC_LOT_SZ,								
                  	FFC_INDSTK,	
										'*'   /* Ver 1.3 */
						FROM		FFC_FO_FVRT_CNTRCT_LST 
						WHERE		FFC_USR_ID 		=	:c_usrid
						AND			FFC_XCHNG_CD  = :c_exchange_code
            AND     FFC_RQST_TYP  = :c_rqst_type                 /**** Ver 3.2 ****/  /*** Ver 3.7 ***/
            ORDER BY FFC_PRDCT_TYP,FFC_UNDRLYNG, 
                     FFC_EXPRY_DT, FFC_STRK_PRC  ASC;
      END;
    END-EXEC;

	}
	else if ( st_i_cntrct.c_rqst_typ == FOR_QUOTES_ORDERS )
	{
		/* Ver 1.3 Start */
		if(DEBUG_MSG_LVL_3)
		{
			fn_userlog( c_ServiceName, "Request type is FOR_QUOTES_ORDERS:%c",st_i_cntrct.c_rqst_typ);
    }
		/* Ver 1.3 End */
    /*** Commented in Ver 2.7 ***
		EXEC SQL EXECUTE
      BEGIN
          OPEN :sys_cursor FOR 
						SELECT	fcm_xchng_cd,
										fcm_prdct_typ,
										fcm_undrlyng,
										to_char(fcm_expry_dt,'DD-Mon-YYYY'),
										fcm_exer_typ,
										fcm_opt_typ,
										fcm_strk_prc,
										fcm_lot_sz,
										fcm_indstk,
										fcm_qt_trdng_flg    * Ver 1.3 *
						FROM		fcm_fo_cntrct_mstr
						WHERE		fcm_xchng_cd	=	:c_exchange_code
						AND			fcm_undrlyng	= :c_underlying
						* AND			fcm_prdct_typ	=	decode(:c_product_type,'P','F',:c_product_type) *Ver 1.2*  *** Commented in Ver 2.2 ***
					  ** AND			fcm_prdct_typ	=	decode(:c_product_type,'P','F','U','F',:c_product_type) * Ver 2.2 com in Ver 2.4 *
					  AND			fcm_prdct_typ	=  (  case																*** Ver 2.4 *** 
																				when :c_product_type = 'P'  THEN  'F'
																				when :c_product_type = 'U'  THEN  'F'
																				when :c_product_type = 'I'  THEN  'O'
																				ELSE :c_product_type
																				END 
																		 )
						AND			fcm_opt_typ		=	:c_option_type
            AND			fcm_qt_trdng_flg = 'T' 				
						AND 		NVL(fcm_sltp_fp_qt_trdng_flg,'*') =  *** Ver 2.4 ***
									  DECODE (:c_product_type,'I','T',NVL(fcm_sltp_fp_qt_trdng_flg,'*'))   
            ORDER BY fcm_prdct_typ, fcm_undrlyng, 
                     fcm_expry_dt, fcm_strk_prc ASC;
      END;
    END-EXEC;
    *** Ver 2.7 Comment Ends ***/
    /*** Ver 2.7 Starts ***/
             EXEC SQL EXECUTE
             BEGIN
              OPEN :sys_cursor FOR
            SELECT FTQ_XCHNG_CD,
                   FTQ_PRDCT_TYP,
                   FTQ_UNDRLYNG,
                   TO_CHAR(FTQ_EXPRY_DT,'DD-Mon-YYYY'),
                   FTQ_EXER_TYP,
                   FTQ_OPT_TYP,
                   FTQ_STRK_PRC,
                   FTQ_MIN_LOT_QTY,
                   FTQ_INDSTK,
                   FTQ_QT_TRDNG_FLG,
                   FTQ_LST_TRD_PRC,
                   TO_CHAR ( FTQ_LST_TRD_TM, 'dd-Mon-yyyy hh24:mi:ss' ),   /*** Ver 3.1 ***/
                   NVL(FTQ_TRAIL_FLG,'N'),   /*** Ver 3.5 ***/
									 NVL(FTQ_SETLMNT_FLG,'C'),		/*** Added in Ver 3.8 ***/
									 decode(NVL(FTQ_OTM_FLG,'N'),'N',FMM_EXPSR,FMM_DEEP_OTM_EXPSR), /*** ver 4.6 ***/ 
  						 		 NVL(FTQ_SPN_PER_LOT,0),/*** ver 4.6 ***/
  							 	 NVL(FMM_SPN_MULTPLR,0),/*** ver 4.6 ***/
                   nvl(fmm_somc_prcnt,0), /** ver 4.6 **/
                   decode(NVL(FTQ_OTM_FLG,'N'),'Y',nvl(fmm_deep_otm_im_prcnt,0),nvl(fmm_init_mrgn_prcnt,0)), /** ver 4.6 ***/
                   NVL(FMM_INIT_MRGN_PRCNT,0.0), /** ver 4.6 ***/
                   NVL(FMM_OPLUS_SEBI_PRCNT_B,0.0), /*** opls ver 4.6 ***/
                   NVL(FMM_OPLUS_FLAT_RT, 0.0 ),/*** opls buy 4.6 ***/
                   NVL(FMM_SLTP_DIFF_PRCNT,0.0), /** ver 4.6 ***/
                   NVL(FMM_SLTP_SEBI_PRCNT,0), /** ver 4.6 ***/
                   NVL(FMM_SLTP_PRCNT,0.0), /*** ver 4.6 ***/
                   NVL(fmm_span_mrgn_prcnt,0)*NVL(fmm_fp_multplr,0),  /*** ver 4.6 ***/
                   NVL(FTQ_SPN_PER_LOT_B,0)/*** ver 4.6 ***/
             FROM  FTQ_FO_TRD_QT,FMM_FO_MRGN_MSTR 	/*** ver 4.6 ***/
            WHERE  FTQ_XCHNG_CD = :c_exchange_code /*** ver 4.6 ***/
						 AND FMM_XCHNG_CD = FTQ_XCHNG_CD /*** ver 4.6 ***/
              AND  FTQ_UNDRLYNG = :c_underlying
						 AND FMM_UNDRLYNG = FTQ_UNDRLYNG /*** ver 4.6 ***/
              AND  FTQ_PRDCT_TYP = ( CASE
                                     WHEN :c_product_type = 'P'  THEN  'F'
                                     WHEN :c_product_type = 'U'  THEN  'F'
                                     WHEN :c_product_type = 'I'  THEN  'O'
                                     ELSE :c_product_type
                                     END
                                   )
							AND FMM_PRDCT_TYP = FTQ_PRDCT_TYP	/*** ver 4.6 ***/
  						AND FMM_UNDRLYNG_BSKT_ID = 1	/*** ver 4.6 ***/
							AND  FTQ_EXPRY_DT like DECODE(:c_expry_dt1,'*','%',:c_expry_dt1) /*** ver 4.6 ***/
              AND  FTQ_STRK_PRC like DECODE(:l_strike_prc,-1,'%',:l_strike_prc) /*** ver 4.6 ***/
              AND FTQ_OPT_TYP = :c_option_type
              AND FTQ_QT_TRDNG_FLG = :c_qt_trdng_flg  /** Ver 3.7 **/ 
              AND NVL(FTQ_SLTP_FP_QT_TRDNG_FLG,'*') =
                  DECODE (:c_product_type,'I','T','U','T',NVL(FTQ_SLTP_FP_QT_TRDNG_FLG,'*'))  /** Ver 3.2 For 'U' **/ 
         ORDER BY FTQ_PRDCT_TYP,FTQ_UNDRLYNG,FTQ_EXPRY_DT,FTQ_STRK_PRC ASC;
             END;
        END-EXEC;


    /*** Ver 2.7 Ends   ***/ 
	}
	else if ( st_i_cntrct.c_rqst_typ == FROM_UNDERLYING )
	{
		/* Ver 1.3 Start */
		if(DEBUG_MSG_LVL_3)
		{
			fn_userlog( c_ServiceName, "Request type is FROM_UNDERLYING :%c",st_i_cntrct.c_rqst_typ);
    }
		/* Ver 1.3 End */
    /*** Ver 2.7 Comment Starts ***
		EXEC SQL EXECUTE
      BEGIN
          OPEN :sys_cursor FOR 
						SELECT	fcm_xchng_cd,
										fcm_prdct_typ,
										fcm_undrlyng,
										to_char(fcm_expry_dt,'DD-Mon-YYYY'),
										fcm_exer_typ,
										fcm_opt_typ,
										fcm_strk_prc,
										fcm_lot_sz,
										fcm_indstk,
										fcm_qt_trdng_flg  * Ver 1.3 *
						FROM		fcm_fo_cntrct_mstr
						WHERE		fcm_xchng_cd	=	:c_exchange_code
						AND			fcm_undrlyng	= :c_underlying
						* AND			fcm_prdct_typ	=	decode(:c_product_type,'P','F',:c_product_type) *Ver 1.2 *  *** Commented in Ver 2.2 ***
					  *	AND			fcm_prdct_typ	=	decode(:c_product_type,'P','F','U','F',:c_product_type) * Ver 2.2 Com In Ver 2.4 **
						AND     fcm_prdct_typ =  (  case                                *** Ver 2.4 ***
                                        when :c_product_type = 'P'  THEN  'F'
                                        when :c_product_type = 'U'  THEN  'F'
                                        when :c_product_type = 'I'  THEN  'O'
                                        ELSE :c_product_type
                                        END
                                     )
            AND			fcm_qt_trdng_flg = 'T' 			
						AND     NVL(fcm_sltp_fp_qt_trdng_flg,'*') =    *** Ver 2.4 ***
										DECODE (:c_product_type,'I','T',NVL(fcm_sltp_fp_qt_trdng_flg,'*')) 
            ORDER BY fcm_prdct_typ, fcm_undrlyng, 
                     fcm_expry_dt, fcm_strk_prc ASC;
      END;
    END-EXEC;
    *** Ver 2.7 comment ends ***/
    /*** Ver 2.7 Starts ***/
             EXEC SQL EXECUTE
             BEGIN
              OPEN :sys_cursor FOR
            SELECT FTQ_XCHNG_CD,
                   FTQ_PRDCT_TYP,
                   FTQ_UNDRLYNG,
                   TO_CHAR(FTQ_EXPRY_DT,'DD-Mon-YYYY'),
                   FTQ_EXER_TYP,
                   FTQ_OPT_TYP,
                   FTQ_STRK_PRC,
                   FTQ_MIN_LOT_QTY,
                   FTQ_INDSTK,
                   FTQ_QT_TRDNG_FLG,
                   FTQ_LST_TRD_PRC,
                   TO_CHAR ( FTQ_LST_TRD_TM, 'dd-Mon-yyyy hh24:mi:ss' ),   /*** Ver 3.1 ***/
                   NVL(FTQ_TRAIL_FLG,'N'),   /*** Ver 3.5 ***/
									 NVL(FTQ_SETLMNT_FLG,'C'),   /*** Added in Ver 3.8 ***/
									 decode(FTQ_OTM_FLG,'N',FMM_EXPSR,FMM_DEEP_OTM_EXPSR),	/*** ver 4.6 ***/
									 NVL(FTQ_SPN_PER_LOT,0),/*** ver 4.6 ***/
									 NVL(FMM_SPN_MULTPLR,0),	 /*** ver 4.6 ***/
                   nvl(fmm_somc_prcnt,0), /** ver 4.6 **/
                   decode(NVL(FTQ_OTM_FLG,'N'),'Y',nvl(fmm_deep_otm_im_prcnt,0),nvl(fmm_init_mrgn_prcnt,0)), /** ver 4.6 ***/
                   NVL(FMM_INIT_MRGN_PRCNT,0.0), /** ver 4.6 ***/
                   NVL(FMM_OPLUS_SEBI_PRCNT_B,0.0), /*** opls ver 4.6 ***/
                   NVL(FMM_OPLUS_FLAT_RT, 0.0 ),/*** opls buy 4.6 ***/
                   NVL(FMM_SLTP_DIFF_PRCNT,0.0), /** ver 4.6 ***/
                   NVL(FMM_SLTP_SEBI_PRCNT,0), /** ver 4.6 ***/
                   NVL(FMM_SLTP_PRCNT,0.0 ), /*** ver 4.6 ***/
                   NVL(fmm_span_mrgn_prcnt,0.0)*NVL(fmm_fp_multplr,0),  /*** ver 4.6 ***/
                   NVL(FTQ_SPN_PER_LOT_B,0)/*** ver 4.6 ***/
             FROM  FTQ_FO_TRD_QT,FMM_FO_MRGN_MSTR /*** ver 4.6 FMM_FO_MRGN_MSTR ***/
            WHERE  FTQ_XCHNG_CD = :c_exchange_code /*** ver 4.6 **/
              AND  FTQ_UNDRLYNG = :c_underlying
              AND  FTQ_EXPRY_DT like DECODE(:c_expry_dt1,'*','%',:c_expry_dt1) /*** ver 4.6 ***/
              AND  FTQ_STRK_PRC like DECODE(:l_strike_prc,-1,'%',:l_strike_prc) /*** ver 4.6 ***/
							AND	 FMM_UNDRLYNG = FTQ_UNDRLYNG /*** ver 4.6 ***/ 
              AND  FTQ_PRDCT_TYP = ( CASE
                                     WHEN :c_product_type = 'P'  THEN  'F'
                                     WHEN :c_product_type = 'U'  THEN  'F'
                                     WHEN :c_product_type = 'I'  THEN  'O'
                                     ELSE :c_product_type
                                     END
                                   )
						  AND FMM_PRDCT_TYP = FTQ_PRDCT_TYP/*** ver 4.6 ***/
							AND FMM_UNDRLYNG_BSKT_ID = 1 /*** ver 4.6 ***/
              AND FTQ_QT_TRDNG_FLG = :c_qt_trdng_flg  /** Ver 3.7 **/ 
              AND NVL(FTQ_SLTP_FP_QT_TRDNG_FLG,'*') =
                  DECODE (:c_product_type,'I','T',NVL(FTQ_SLTP_FP_QT_TRDNG_FLG,'*'))
         ORDER BY FTQ_PRDCT_TYP,FTQ_UNDRLYNG,FTQ_EXPRY_DT,FTQ_STRK_PRC ASC;
             END;
        END-EXEC;
   

    /*** Ver 2.7 Ends   ***/
	}/**************************************** Ver 1.3 Starts *************************************/
	else if ( st_i_cntrct.c_rqst_typ == FROM_STOCKLST_ENABLED ) /**** Ver 1.6 ***/
  {
		if(DEBUG_MSG_LVL_3)
		{
    	fn_userlog( c_ServiceName, "Request type is FROM_STOCKLST :%c",st_i_cntrct.c_rqst_typ);
    	fn_userlog( c_ServiceName, "Option type is :%c", c_option_type);
		}
  /*************** Commented in Ver 2.7 *********************
    EXEC SQL EXECUTE
      BEGIN
          OPEN :sys_cursor FOR
            SELECT  fcm_xchng_cd,
                    fcm_prdct_typ,
                    fcm_undrlyng,
                    to_char(fcm_expry_dt,'DD-Mon-YYYY'),
                    fcm_exer_typ,
                    fcm_opt_typ,
                    fcm_strk_prc,
                    fcm_lot_sz,
                    fcm_indstk,
                    fcm_qt_trdng_flg  
            FROM    fcm_fo_cntrct_mstr
            WHERE   fcm_xchng_cd  = :c_exchange_code
            AND     fcm_undrlyng  = :c_underlying
            * AND     fcm_prdct_typ = decode(:c_product_type,'P','F',:c_product_type) Commented in Ver 2.2 ***
						* AND			fcm_prdct_typ	=	decode(:c_product_type,'P','F','U','F',:c_product_type) * Ver 2.2 Com in Ver 2.4 *
						AND     fcm_prdct_typ =  (  case                                *** Ver 2.4 ***
                                        when :c_product_type = 'P'  THEN  'F'
                                        when :c_product_type = 'U'  THEN  'F'
                                        when :c_product_type = 'I'  THEN  'O'
                                        ELSE :c_product_type
                                        END
                                     )
						AND			fcm_opt_typ		like 	decode(:c_option_type,'P','P','C','C','%')
            AND     fcm_qt_trdng_flg = 'T'   ***1.6***
						AND     NVL(fcm_sltp_fp_qt_trdng_flg,'*') =    *** Ver 2.4 ***
                    DECODE (:c_product_type,'I','T',NVL(fcm_sltp_fp_qt_trdng_flg,'*'))
            ORDER BY fcm_qt_trdng_flg	,fcm_prdct_typ,fcm_undrlyng,fcm_expry_dt,fcm_strk_prc ASC; 
      END;
    END-EXEC;
    ******************* Ver 2.7 Comment Ends ***********************/
    /****************** Ver 2.7 Starts *****************************/
          EXEC SQL EXECUTE
             BEGIN
              OPEN :sys_cursor FOR
            SELECT FTQ_XCHNG_CD,
                   FTQ_PRDCT_TYP,
                   FTQ_UNDRLYNG,
                   TO_CHAR(FTQ_EXPRY_DT,'DD-Mon-YYYY'),
                   FTQ_EXER_TYP,
                   FTQ_OPT_TYP,
                   FTQ_STRK_PRC, 
                   FTQ_MIN_LOT_QTY,
                   FTQ_INDSTK,
                   FTQ_QT_TRDNG_FLG,
                   FTQ_LST_TRD_PRC,
                   NVL(FTQ_TRAIL_FLG,'N'),  /*** Ver 3.5 ***/
									 NVL(FTQ_SETLMNT_FLG,'C'),   /*** Added in Ver 3.8 ***/
                   NVL(FTQ_SPN_PER_LOT,0.0 ), /** ver 4.3 **/
                   NVL(FTQ_OTM_FLG,'N')       /** ver 4.4 **/
             FROM  FTQ_FO_TRD_QT
            WHERE  FTQ_XCHNG_CD = :c_exchange_code
              AND  FTQ_UNDRLYNG = :c_underlying
              AND  FTQ_PRDCT_TYP = ( CASE
                                     WHEN :c_product_type = 'P'  THEN  'F'
                                     WHEN :c_product_type = 'U'  THEN  'F'
                                     WHEN :c_product_type = 'I'  THEN  'O'
                                     ELSE :c_product_type
                                     END
                                   )
              AND FTQ_OPT_TYP LIKE  DECODE(:c_option_type,'P','P','C','C','%')
              AND FTQ_QT_TRDNG_FLG = :c_qt_trdng_flg  /** Ver 3.7 **/
              AND NVL(FTQ_SLTP_FP_QT_TRDNG_FLG,'*') = 
                  DECODE (:c_product_type,'I','T','U','T',NVL(FTQ_SLTP_FP_QT_TRDNG_FLG,'*'))  /** Ver 3.4 , U added **/
         ORDER BY FTQ_QT_TRDNG_FLG,FTQ_PRDCT_TYP,FTQ_UNDRLYNG,FTQ_EXPRY_DT,FTQ_STRK_PRC ASC; 
           END;
      END-EXEC;                                 
  
    /****************** Ver 2.7 Ends   *****************************/
  }	
	else if ( st_i_cntrct.c_rqst_typ == FROM_STOCKLST_DISABLED ) /**** Ver 1.6 to add a new else if ***/
  {
		if(DEBUG_MSG_LVL_3)
		{
    	fn_userlog( c_ServiceName, "Request type is FROM_STOCKLST_DISABLED :%c",st_i_cntrct.c_rqst_typ);
    	fn_userlog( c_ServiceName, "Option type is :%c", c_option_type);
		}
    /*** Commented in Ver 2.7 ***
    EXEC SQL EXECUTE
      BEGIN
          OPEN :sys_cursor FOR
            SELECT  fcm_xchng_cd,
                    fcm_prdct_typ,
                    fcm_undrlyng,
                    to_char(fcm_expry_dt,'DD-Mon-YYYY'),
                    fcm_exer_typ,
                    fcm_opt_typ,
                    fcm_strk_prc,
                    fcm_lot_sz,
                    fcm_indstk,
                    fcm_qt_trdng_flg  
            FROM    fcm_fo_cntrct_mstr
            WHERE   fcm_xchng_cd  = :c_exchange_code
            AND     fcm_undrlyng  = :c_underlying
            * AND     fcm_prdct_typ = decode(:c_product_type,'P','F',:c_product_type) Commented in Ver 2.2 ***
					  * AND			fcm_prdct_typ	=	decode(:c_product_type,'P','F','U','F',:c_product_type) * Ver 2.2 Comm In Ver 2.4 *
						AND     fcm_prdct_typ =  (  case                                *** Ver 2.4 ***
                                        when :c_product_type = 'P'  THEN  'F'
                                        when :c_product_type = 'U'  THEN  'F'
                                        when :c_product_type = 'I'  THEN  'O'
                                        ELSE :c_product_type
                                        END
                                     )
						AND			fcm_opt_typ		like 	decode(:c_option_type,'P','P','C','C','%')
            *** AND     fcm_qt_trdng_flg <> 'T' Commented In Ver 2.4 ***
            AND     fcm_qt_trdng_flg <> DECODE (:c_product_type,'I','*','T')   *** Ver 2.4 *** 
					  AND     NVL(fcm_sltp_fp_qt_trdng_flg,'*') =  *** Ver 2.4 ***
                    DECODE (:c_product_type,'I','Q',NVL(fcm_sltp_fp_qt_trdng_flg,'*'))
            ** ORDER BY fcm_qt_trdng_flg	,fcm_prdct_typ,fcm_undrlyng,fcm_expry_dt,fcm_strk_prc ASC; Commented In Ver 2.4 **
            ORDER BY fcm_prdct_typ,fcm_undrlyng,fcm_expry_dt,fcm_strk_prc,fcm_qt_trdng_flg,fcm_sltp_fp_qt_trdng_flg ASC; 
																																																	*** Ver 2.4 *** 
      END;
    END-EXEC;
    *** Ver 2.7 Comment Ends ***/
    /*** Ver 2.7 Starts ***/
 
           EXEC SQL EXECUTE
              BEGIN
               OPEN :sys_cursor FOR
             SELECT FTQ_XCHNG_CD,
                    FTQ_PRDCT_TYP,
                    FTQ_UNDRLYNG,
                    TO_CHAR(FTQ_EXPRY_DT,'DD-Mon-YYYY'),
                    FTQ_EXER_TYP,
                    FTQ_OPT_TYP,
                    FTQ_STRK_PRC,
                    FTQ_MIN_LOT_QTY,
                    FTQ_INDSTK,
                    FTQ_QT_TRDNG_FLG,
                    FTQ_LST_TRD_PRC,
                    NVL(FTQ_TRAIL_FLG,'N'),  /*** Ver 3.5 ***/
										NVL(FTQ_SETLMNT_FLG,'C'),   /*** Added in Ver 3.8 ***/
                    NVL(FTQ_SPN_PER_LOT,0.0 ), /** ver 4.3 **/
                    NVL(FTQ_OTM_FLG,'N')       /** ver 4.4 **/
               FROM FTQ_FO_TRD_QT
              WHERE FTQ_XCHNG_CD  = :c_exchange_code
               AND  FTQ_UNDRLYNG = :c_underlying
               AND  FTQ_PRDCT_TYP =  ( CASE                                /*** Ver 2.4 ***/
                                        WHEN :c_product_type = 'P'  THEN  'F'
                                        WHEN :c_product_type = 'U'  THEN  'F'
                                        WHEN :c_product_type = 'I'  THEN  'O'
                                        ELSE :c_product_type
                                        END
                                     )
               AND FTQ_OPT_TYP LIKE DECODE (:c_option_type,'P','P','C','C','%')
               AND FTQ_QT_TRDNG_FLG <> DECODE (:c_product_type,'I','*','U','*','T')   /** Ver 3.2 For 'U' **/
               AND NVL(FTQ_SLTP_FP_QT_TRDNG_FLG,'*') =
                   DECODE (:c_product_type,'I','Q','U','Q',NVL(FTQ_SLTP_FP_QT_TRDNG_FLG,'*')) /** Ver 3.2 For 'U' **/
          ORDER BY FTQ_PRDCT_TYP,FTQ_UNDRLYNG,FTQ_EXPRY_DT,FTQ_STRK_PRC,FTQ_QT_TRDNG_FLG,FTQ_SLTP_FP_QT_TRDNG_FLG ASC;
              END;
         END-EXEC;

    /*** Ver 2.7 Ends   ***/
  }	
	/**************************************** Ver 1.3 Ends **************************************/
	/**************************************** Ver 1.3 Ends **************************************/
	
	/******Comemnted for ver 1.8
	*************************************** Ver 1.5 Starts ********************************
	else if ( st_i_cntrct.c_rqst_typ == ALL_CNTRCTS )
  {
		if(DEBUG_MSG_LVL_3)
		{
    	fn_userlog( c_ServiceName, "Request type is ALL_CNTRCTS :%c",st_i_cntrct.c_rqst_typ);
    	fn_userlog( c_ServiceName, "Exchng Code is :%c", c_exchange_code);
    	fn_userlog( c_ServiceName, "Underlying is :%c", c_underlying); 
		}
    EXEC SQL EXECUTE
      BEGIN
          OPEN :sys_cursor FOR
            SELECT  fcm_xchng_cd,
                    fcm_prdct_typ,
                    fcm_undrlyng,
                    to_char(fcm_expry_dt,'DD-Mon-YYYY'),
                    fcm_exer_typ,
                    fcm_opt_typ,
                    fcm_strk_prc,
                    fcm_lot_sz,
                    fcm_indstk,
                    fcm_qt_trdng_flg  
            FROM    fcm_fo_cntrct_mstr
            WHERE   fcm_xchng_cd  = :c_exchange_code
            AND     fcm_undrlyng  = :c_underlying
            AND			fcm_qt_trdng_flg = 'T'
            ORDER BY fcm_qt_trdng_flg	,fcm_prdct_typ,fcm_undrlyng,fcm_expry_dt,fcm_strk_prc ASC; 
      END;
    END-EXEC;

  }
**************************************** Ver 1.8 Ends **************************************/

/*************************************** Ver 2.0 Starts************************************/

  else if ( st_i_cntrct.c_rqst_typ == FROM_ROLLOVER )
  {
    c_prdct_flg ='F';  /** Ver 3.7 **/
  if(DEBUG_MSG_LVL_3)
    {
      fn_userlog( c_ServiceName, "Request type is FROM_ROLLOVER :%c",st_i_cntrct.c_rqst_typ);

    }
		
	EXEC SQL 
		SELECT NVL(FUM_ROLLOVER_FLAG,'Q')
		INTO :c_roll_flg
		FROM FUM_FO_UNDRLYNG_MSTR
		WHERE FUM_XCHNG_CD = :c_exchange_code
		AND FUM_UNDRLYNG = :c_underlying
		AND FUM_PRDCT_TYP = :c_prdct_flg;     /** Ver 3.7 **/
	
		if(SQLCODE != 0 )
 	 {
    fn_errlog( c_ServiceName, "S31030", SQLMSG, c_err_msg.arr  );
    tpfree ( ( char * ) ptr_o_st_cntrct );                        /*****added in Ver VQC*****/ 
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
 	 }

	 if( c_roll_flg != 'T')
   {
		 fn_errlog( c_ServiceName, "S31035", "This contract is not enabled for Rollover.",c_err_msg.arr );
		 strcpy(c_err_msg.arr,"This contract is not enabled for Rollover.");	
		 tpfree ( ( char * ) ptr_o_st_cntrct );                           /*****added in Ver VQC*****/	
		 Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
 		 tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
   }	
		 
   /*** Commented in Ver 2.7 ***
   EXEC SQL
    SELECT MIN(fcm_expry_dt)
    INTO  :c_expry_dt
    FROM  fcm_fo_cntrct_mstr
    WHERE fcm_xchng_cd  = :c_exchange_code
    AND   fcm_undrlyng  = :c_underlying
    AND   fcm_prdct_typ = 'F'
		AND		fcm_qt_trdng_flg	=	'T'
		AND   fcm_rollover_flag = 'T'
    ORDER BY fcm_expry_dt;
   *** Ver 2.7 Comment Ends ***/
   /*** Ver 2.7 Starts ***/
  c_rollov_flg ='T';   /** Ver 3.7 **/
   EXEC SQL
   SELECT MIN(FTQ_EXPRY_DT)
     INTO :c_expry_dt
     FROM FTQ_FO_TRD_QT
    WHERE FTQ_XCHNG_CD = :c_exchange_code
      AND FTQ_UNDRLYNG = :c_underlying
      AND FTQ_PRDCT_TYP = :c_prdct_flg  /** Ver 3.7 **/ 
			/** commented in ver 3.9 AND FTQ_QT_TRDNG_FLG = :c_qt_trdng_flg  ** Ver 3.7 **/
			AND FTQ_QT_TRDNG_FLG in ('T','Q') /*** added in ver 3.9 ***/
      AND FTQ_ROLLOVER_FLAG= :c_rollov_flg    /** Ver 3.7 **/
 ORDER BY FTQ_EXPRY_DT; 
   /*** Ver 2.7 Ends   ***/
  if(SQLCODE != 0 )
  {
    fn_errlog( c_ServiceName, "S31040", SQLMSG, c_err_msg.arr  );
		tpfree ( ( char * ) ptr_o_st_cntrct );                        /*****added in Ver VQC*****/ 
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );  
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

	if(DEBUG_MSG_LVL_3)
    {
		/** commented in ver 3.9
      fn_userlog( c_ServiceName, "Expiry date of near month is :%s:",c_expry_dt);
		***/
			 fn_userlog( c_ServiceName, "Expiry date of near month is :%s:",c_expry_dt.arr); /*** ver 3.9 ***/
   }

	 /**** Addded in ver 2.6 ****/
		
	 if (strcmp(c_underlying,"INDVIX" ) == 0)	
	 {
    c_prdct_flg ='F';  /** Ver 3.7 **/ 
   
   /*** Commented in Ver 2.7 ***
			EXEC SQL EXECUTE
      BEGIN
          OPEN :sys_cursor FOR
            SELECT  fcm_xchng_cd,
                    fcm_prdct_typ,
                    fcm_undrlyng,
                    to_char(fcm_expry_dt,'DD-Mon-YYYY'),
                    fcm_exer_typ,
                    fcm_opt_typ,
                    fcm_strk_prc,
                    fcm_lot_sz,
                    fcm_indstk,
                    fcm_qt_trdng_flg
            FROM    fcm_fo_cntrct_mstr
            WHERE   fcm_xchng_cd  =:c_exchange_code
            AND     fcm_undrlyng  =:c_underlying
            AND     fcm_prdct_typ =  'F'
            AND     fcm_expry_dt > :c_expry_dt
            ORDER BY fcm_expry_dt ;
        END;
      END-EXEC;
     *** Ver 2.7 Comment Ends ***/
     /*** Ver 2.7 Starts ***/

      EXEC SQL EXECUTE
         BEGIN
          OPEN :sys_cursor FOR
        SELECT FTQ_XCHNG_CD,
               FTQ_PRDCT_TYP,
               FTQ_UNDRLYNG,
               TO_CHAR(FTQ_EXPRY_DT,'DD-Mon-YYYY'),
               FTQ_EXER_TYP,
               FTQ_OPT_TYP,
               FTQ_STRK_PRC,
               FTQ_MIN_LOT_QTY,
               FTQ_INDSTK,
               FTQ_QT_TRDNG_FLG,
               FTQ_LST_TRD_PRC,
               NVL(FTQ_TRAIL_FLG,'N'),  /*** Ver 3.5 ***/
							 NVL(FTQ_SETLMNT_FLG,'C')   /*** Added in Ver 3.8 ***/
         FROM  FTQ_FO_TRD_QT
        WHERE  FTQ_XCHNG_CD =:c_exchange_code
          AND  FTQ_UNDRLYNG =:c_underlying
          AND  FTQ_PRDCT_TYP = :c_prdct_flg    /** Ver 3.7 **/ 
          AND  FTQ_EXPRY_DT > :c_expry_dt
     ORDER BY  FTQ_EXPRY_DT;
         END;
    END-EXEC;
     /*** Ver 2.7 Ends   ***/
	 }	
	 /**** End of ver 2.6 ****/
	 else
	 {
    c_prdct_flg ='F';  /** Ver 3.7 **/
     /*** Commented in Ver 2.7 ***		
    	EXEC SQL EXECUTE
      BEGIN
          OPEN :sys_cursor FOR
            SELECT  fcm_xchng_cd,
                    fcm_prdct_typ,
                    fcm_undrlyng,
                    to_char(fcm_expry_dt,'DD-Mon-YYYY'),
                    fcm_exer_typ,
                    fcm_opt_typ,
                    fcm_strk_prc,
                    fcm_lot_sz,
                    fcm_indstk,
                    fcm_qt_trdng_flg
            FROM    fcm_fo_cntrct_mstr
            WHERE   fcm_xchng_cd  =:c_exchange_code
            AND     fcm_undrlyng  =:c_underlying
            AND     fcm_prdct_typ =  'F'
            AND     fcm_expry_dt > :c_expry_dt
    		AND     ( to_char(fcm_expry_dt,'Mon-yyyy')  = to_char(add_months((:c_expry_dt),1),'Mon-yyyy')
        OR   to_char(fcm_expry_dt,'Mon-yyyy')  = to_char(add_months((:c_expry_dt),2),'Mon-yyyy')
            )

            ORDER BY fcm_expry_dt ;
      	END;
    	END-EXEC;
     *** Ver 2.7 Comment Ends ***/
     /*** Ver 2.7 Starts ***/
     EXEC SQL EXECUTE
        BEGIN
         OPEN :sys_cursor FOR 
       SELECT FTQ_XCHNG_CD,
              FTQ_PRDCT_TYP,
              FTQ_UNDRLYNG,
              TO_CHAR(FTQ_EXPRY_DT,'DD-Mon-YYYY'),
              FTQ_EXER_TYP,
              FTQ_OPT_TYP,
              FTQ_STRK_PRC,
              FTQ_MIN_LOT_QTY,
              FTQ_INDSTK,
              FTQ_QT_TRDNG_FLG,
              FTQ_LST_TRD_PRC,
              NVL(FTQ_TRAIL_FLG,'N'),   /*** Ver 3.5 ***/
							NVL(FTQ_SETLMNT_FLG,'C')   /*** Added in Ver 3.8 ***/
        FROM  FTQ_FO_TRD_QT
       WHERE  FTQ_XCHNG_CD =:c_exchange_code
         AND  FTQ_UNDRLYNG =:c_underlying
         AND  FTQ_PRDCT_TYP = :c_prdct_flg   /** Ver 3.7 **/ 
         AND  FTQ_EXPRY_DT > :c_expry_dt
         AND  (
              TO_CHAR(FTQ_EXPRY_DT,'Mon-yyyy')  = TO_CHAR(ADD_MONTHS((:c_expry_dt),1),'Mon-yyyy')
         OR   TO_CHAR(FTQ_EXPRY_DT,'Mon-yyyy')  = TO_CHAR(ADD_MONTHS((:c_expry_dt),2),'Mon-yyyy')
              )
  ORDER BY  FTQ_EXPRY_DT;
      END;
 END-EXEC; 
     /*** Ver 2.7 Ends   ***/
		}
  }

/***************************************** Ver 2.0 Ends *********************************/

/***************************************** Ver 3.2 Starts *********************************/
  else if( st_i_cntrct.c_rqst_typ == CLOUD_ORDERS )
  {
   c_rqst_type ='C';  /*** Ver 3.7  ***/
    if(DEBUG_MSG_LVL_3)
    {
      fn_userlog( c_ServiceName, "Request type is CLOUD_ORDERS :%c",st_i_cntrct.c_rqst_typ);
      fn_userlog( c_ServiceName, "c_usrid*************************:%s",c_usrid); 
      fn_userlog( c_ServiceName, "c_exchange_code*****************:%s",c_exchange_code); 
      fn_userlog( c_ServiceName, "c_product_type******************:%c",c_product_type);
      fn_userlog( c_ServiceName, "c_underlying********************:%s",c_underlying);
      fn_userlog( c_ServiceName, "c_expry_dt1**********************:%s",c_expry_dt1);
      fn_userlog( c_ServiceName, "c_option_type*******************:%c",c_option_type);
      fn_userlog( c_ServiceName, "l_strike_prc********************:%ld",l_strike_prc);
    }

    EXEC SQL EXECUTE
      BEGIN
          OPEN :sys_cursor FOR
            SELECT  FFC_XCHNG_CD,
                    FFC_PRDCT_TYP,
                    FFC_UNDRLYNG,
                    TO_CHAR(FFC_EXPRY_DT,'DD-Mon-YYYY'),
                    FFC_EXER_TYP,
                    FFC_OPT_TYP,
                    FFC_STRK_PRC,
                    FFC_LOT_SZ,
                    FFC_INDSTK, 
                    '*',
                    FFC_ORDR_QTY,
                    FFC_LMT_MRKT_FLG,
                    FFC_CVR_SLTP_DIFF
            FROM   FFC_FO_FVRT_CNTRCT_LST 
            WHERE   FFC_USR_ID     = :c_usrid
            AND     FFC_XCHNG_CD   = :c_exchange_code
            AND     FFC_RQST_TYP   = :c_rqst_type           /** Ver 3.7 ***/
            AND     FFC_PRDCT_TYP  = :c_product_type
            AND     FFC_UNDRLYNG   = :c_underlying
            AND     FFC_EXPRY_DT   = :c_expry_dt1
            AND     FFC_OPT_TYP    = :c_option_type
            AND     FFC_STRK_PRC   = :l_strike_prc
						AND     ROWNUM < 2
            ORDER BY FFC_PRDCT_TYP,FFC_UNDRLYNG, 
                     FFC_EXPRY_DT, FFC_STRK_PRC ASC;
      END;
    END-EXEC;
  }
/***************************************** Ver 3.2 Ends *********************************/

/***************************************** Ver 4.2 Starts *********************************/
  else if( st_i_cntrct.c_rqst_typ == FROM_SPREAD_CNTRCTS)
  {
    c_rqst_type ='P';
    c_prdct_flg ='S';
    MEMSET(c_sprd_expry_dt);
    if(Fget32( ptr_fml_Ibuf,FFO_EXPRY_DT,0,(char *)c_sprd_expry_dt,0 ) == -1)
    {
      fn_userlog( c_ServiceName, "c_sprd_expry_dt not found");
      fn_errlog( c_ServiceName, "S31045", FMLMSG, c_err_msg.arr  );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }
    rtrim(c_sprd_expry_dt);

    if(DEBUG_MSG_LVL_3)
    {
      fn_userlog( c_ServiceName, "Request type is FROM_SPREAD_CNTRCTS :%c:",st_i_cntrct.c_rqst_typ);
      fn_userlog( c_ServiceName, "c_usrid*************************:%s:",c_usrid);
      fn_userlog( c_ServiceName, "c_exchange_code*****************:%s:",c_exchange_code);
      fn_userlog( c_ServiceName, "c_product_type******************:%c:",c_product_type);
      fn_userlog( c_ServiceName, "c_prdct_flg******************:%c:",c_prdct_flg);
      fn_userlog( c_ServiceName, "c_underlying********************:%s:",c_underlying);
      fn_userlog( c_ServiceName, "c_sprd_expry_dt**********************:%s:",c_sprd_expry_dt);
      fn_userlog( c_ServiceName, "c_option_type*******************:%c:",c_option_type);
      fn_userlog( c_ServiceName, "l_strike_prc********************:%ld:",l_strike_prc);
    }
    EXEC SQL
    SELECT NVL(FUM_ROLLOVER_FLAG,'Q')
    INTO :c_roll_flg
    FROM FUM_FO_UNDRLYNG_MSTR
    WHERE FUM_XCHNG_CD = :c_exchange_code
    AND FUM_UNDRLYNG = :c_underlying
    AND FUM_PRDCT_TYP = :c_product_type;
    fn_userlog( c_ServiceName, "c_roll_flg********************:%c",c_roll_flg);
    if(SQLCODE != 0 )
    {
      fn_errlog( c_ServiceName, "S31050", SQLMSG, c_err_msg.arr  );
      tpfree ( ( char * ) ptr_o_st_cntrct );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

    if( c_roll_flg != 'T')
    {
      fn_errlog( c_ServiceName, "S31055", "This contract is not enabled for Rollover.",c_err_msg.arr );
      strcpy(c_err_msg.arr,"This contract is not enabled for Rollover.");
      tpfree ( ( char * ) ptr_o_st_cntrct );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

    EXEC SQL EXECUTE
      BEGIN
          OPEN :sys_cursor FOR
               SELECT FTQ_XCHNG_CD,
                      FTQ_PRDCT_TYP,
                      FTQ_UNDRLYNG,
                      TO_CHAR(FTQ_EXPRY_DT2,'DD-Mon-YYYY'),
                      FTQ_EXER_TYP,
                      FTQ_OPT_TYP,
                      FTQ_STRK_PRC,
                      FTQ_MIN_LOT_QTY,
                      FTQ_INDSTK,
                      FTQ_QT_TRDNG_FLG,
                      FTQ_LST_TRD_PRC,
                      NVL(FTQ_TRAIL_FLG,'N'),
											NVL(FTQ_SETLMNT_FLG,'C')
                FROM  FTQ_FO_TRD_QT
                WHERE  FTQ_XCHNG_CD =:c_exchange_code
                AND  FTQ_UNDRLYNG =:c_underlying
                AND  FTQ_PRDCT_TYP = :c_prdct_flg
                AND  FTQ_EXPRY_DT = TO_DATE ( :c_sprd_expry_dt,'dd-Mon-yyyy' )
                AND  NVL(FTQ_ROLLOVER_SPRD_ALLWD_FLG,'N') = 'Y'
               ORDER BY  FTQ_EXPRY_DT,FTQ_EXPRY_DT2;
      END;
    END-EXEC;
		if(DEBUG_MSG_LVL_3)	/** Added debug in Ver 5.3 **/
		{
    fn_userlog( c_ServiceName, "End of request type --> rollover with spread");
		}
  }
  else if(st_i_cntrct.c_rqst_typ == GET_CNT_R_SPD_CNTRCT)
  {
    c_rqst_type ='K';
    c_prdct_flg ='S';
    c_qt_trdng_flg = 'Y';
    if(DEBUG_MSG_LVL_3)
    {
      fn_userlog( c_ServiceName, "Inside GET_CNT_R_SPD_CNTRCT case");
      fn_userlog( c_ServiceName, "c_prdct_flg = :%c:: c_rqst_type = :%c:",c_prdct_flg,c_rqst_type);
    }
    EXEC SQL EXECUTE
      BEGIN
          OPEN :sys_cursor FOR
          SELECT FTQ_EXPRY_DT,
                 FTQ_EXPRY_DT2,
                 FTQ_MIN_LOT_QTY
          FROM FTQ_FO_TRD_QT
          WHERE FTQ_XCHNG_CD = :c_exchange_code
          AND  FTQ_UNDRLYNG = :c_underlying
          AND  FTQ_ROLLOVER_SPRD_ALLWD_FLG = :c_qt_trdng_flg
          AND  FTQ_PRDCT_TYP = :c_prdct_flg
          ORDER BY FTQ_EXPRY_DT, FTQ_EXPRY_DT2 ;
          END;
      END-EXEC;
    if (SQLCODE != 0)
      {
        fn_errlog( c_ServiceName, "S31060", SQLMSG, c_err_msg.arr  );
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_fml_Obuf );   /*** Added in Ver VQC**/
        tpfree ( ( char * ) ptr_o_st_cntrct );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
  }
/***************************************** Ver 4.2 Ends *********************************/

 if ( SQLCODE != 0 && st_i_cntrct.c_rqst_typ != ALL_CNTRCTS)		/**Ver 1.8 **/
  {
		fn_errlog( c_ServiceName, "S31065", SQLMSG, c_err_msg.arr  );  
  	EXEC SQL FREE :sys_cursor;
		tpfree ( ( char * ) ptr_o_st_cntrct );
		Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
		tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

	if ( st_i_cntrct.c_rqst_typ!= FOR_QUOTES_MONEY_TYPE )     /*** Condition Added in Ver 4.0 ***/
	{
	ptr_fml_Obuf = (FBFR32 *)tpalloc( "FML32", NULL, MIN_FML_BUF_LEN*20 );
	
	if ( ptr_fml_Obuf == NULL )
	{
		fn_errlog( c_ServiceName, "S31070", TPMSG, c_err_msg.arr  ); 
  	EXEC SQL CLOSE :sys_cursor;
  	EXEC SQL FREE :sys_cursor;
		tpfree ( ( char * ) ptr_o_st_cntrct );
		Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
		tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
	}
	}           /*** Ver 4.0 ***/

	i_counter = 1 ;
/**	i_counter1 = 1 ; **commented in  VQC**/

/*** Ver 4.0 Starts ***/
/* if(st_i_cntrct.c_rqst_typ != ALL_CNTRCTS)      **Ver 1.8 ** Commented in Ver 4.2 **/
if(st_i_cntrct.c_rqst_typ != ALL_CNTRCTS && st_i_cntrct.c_rqst_typ != GET_CNT_R_SPD_CNTRCT)     /** Ver 4.2 **/
  {
    if( c_product_type == 'U' || c_product_type == 'I' || c_product_type == 'F' || c_product_type == 'P' )
    {
      if (DEBUG_MSG_LVL_3)
      {
        fn_userlog(c_ServiceName, "c_product_type :%c:",c_product_type);
      }
      EXEC SQL
      SELECT NVL(FUM_SLTPFP_LMT_ALLWD_FLG,'N')
      INTO  :c_allwd_flg
      FROM  FUM_FO_UNDRLYNG_MSTR
      WHERE FUM_XCHNG_CD    = :c_exchange_code
      AND   FUM_UNDRLYNG    = :c_underlying
      AND   FUM_PRDCT_TYP   = DECODE(:c_product_type,'U','F','I','O','P','F',:c_product_type);

      if(SQLCODE != 0 )
      {
        fn_errlog ( c_ServiceName, "B21000", DEFMSG, c_err_msg.arr );
        if ( st_i_cntrct.c_rqst_typ != FOR_QUOTES_MONEY_TYPE )
        {
          EXEC SQL CLOSE :sys_cursor;
          tpfree ( ( char * ) ptr_fml_Obuf );
        }
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      if (DEBUG_MSG_LVL_3)
			{
        fn_userlog(c_ServiceName, "Limit Allowed Flag SLTP F+ is :%c:",c_allwd_flg);
      }
    }
  }

	/**** Ver 4.8 Start ****/
	if(st_i_cntrct.c_rqst_typ == FOR_QUOTES_MONEY_TYPE || st_i_cntrct.c_rqst_typ == FOR_QUOTES_ORDERS || st_i_cntrct.c_rqst_typ ==FROM_UNDERLYING)
	{
    EXEC SQL
     SELECT  NVL(CLM_SPAN_ALLWD,'N')
     INTO    :c_spn_flg
     FROM    CLM_CLNT_MSTR
     WHERE   CLM_MTCH_ACCNT  = (select UAC_CLM_MTCH_ACCNT FROM UAC_USR_ACCNTS WHERE UAC_USR_ID = :st_usr_prfl.c_user_id);
    if ( SQLCODE != 0 && SQLCODE != NO_DATA_FOUND )
    {
			if (SQLCODE == -1427 )
			{
			 EXEC SQL
			  SELECT  NVL(CLM_SPAN_ALLWD,'N')
			  INTO    :c_spn_flg
        FROM    ICD_INFO_CLIENT_DTLS,
                IAI_INFO_ACCOUNT_INFO,
				        UAC_USR_ACCNTS,
      				  CLM_CLNT_MSTR
        WHERE   ICD_SERIAL_NO = IAI_SERIAL_NO
	      and UAC_CLM_MTCH_ACCNT = IAI_MATCH_ACCOUNT_NO
	      and CLM_MTCH_ACCNT = UAC_CLM_MTCH_ACCNT
	      and UAC_USR_ID = :st_usr_prfl.c_user_id 
	      AND IAI_TYPE = 'NRO_NON_PINS';

			if ( SQLCODE != 0 && SQLCODE != NO_DATA_FOUND)
			{
    	  fn_errlog ( c_ServiceName, "S11120", SQLMSG, c_err_msg.arr );
      	EXEC SQL FREE :sys_cursor;
      	tpfree ( ( char * ) ptr_o_st_cntrct );
      	Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
      	tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
			}
		 }
		 else
		 {
        fn_errlog ( c_ServiceName, "S11121", SQLMSG, c_err_msg.arr );
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
		 }
		}

			if(c_spn_flg =='Y')
			{
			EXEC SQL SELECT
					FI_LOSS_ALRT_FLG,FI_LOSS_ALRT_AMT*-1,FI_PRFT_ALRT_FLG,FI_PRFT_ALRT_AMT
			INTO
					:c_loss_alrt_flg,:d_loss_lmt,:c_prft_alrt_flg,:d_prft_lmt
			FROM FNO_IALERT
			WHERE FI_USR_ID=:st_usr_prfl.c_user_id;
			if ( SQLCODE != 0 && SQLCODE != NO_DATA_FOUND)
			{
    	  fn_errlog ( c_ServiceName, "S11112", SQLMSG, c_err_msg.arr );
      	EXEC SQL FREE :sys_cursor;
      	tpfree ( ( char * ) ptr_o_st_cntrct );
      	Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
      	tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
			}
			if(SQLCODE == NO_DATA_FOUND)
			{
					c_loss_alrt_flg='Y';d_loss_lmt=-10000;
					c_prft_alrt_flg='Y';d_prft_lmt=10000;
			}

			/* MWPL Ban script alert start*/
				ban_cnt=0;
				EXEC SQL SELECT COUNT(*) into :ban_cnt from FUM_FO_UNDRLYNG_MSTR 
						WHERE FUM_UNDRLYNG=:c_underlying and FUM_QT_TRDNG_FLG='Q' and rownum=1;
					if( SQLCODE != 0 && SQLCODE != NO_DATA_FOUND)
					{
						fn_errlog ( c_ServiceName, "S11112", SQLMSG, c_err_msg.arr );
						EXEC SQL FREE :sys_cursor;
						tpfree ( ( char * ) ptr_o_st_cntrct );
						Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
						tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
					}
					if(ban_cnt>0)
					{
						c_err_flag='B';
						c_err_type='P';
						MEMSET(c_alert_msg.arr);
						sprintf(c_alert_msg.arr,"The Market Wide Position Limit (MWPL) for %s has crossed 95%% limit and is currently in Ban period. You are not allowed to make any fresh position. Only square-off is allowed.",c_underlying);
						SETLEN(c_alert_msg);
					}
			/* MWPL Ban script alert end*/
			}	
	}
	/**** Ver 4.8 End ****/

	/** Ver 5.2 starts **/
	if ( st_i_cntrct.c_rqst_typ == STK_SURV || st_i_cntrct.c_rqst_typ == FOR_QUOTES_MONEY_TYPE ||  st_i_cntrct.c_rqst_typ == FROM_UNDERLYING || st_i_cntrct.c_rqst_typ == FROM_STOCKLST_ENABLED || st_i_cntrct.c_rqst_typ == FOR_QUOTES_ORDERS ) 
	{

			MEMSET(sql_sim_desc); 
			MEMSET(sql_sim_short_cd); 
			MEMSET(c_msg); 

        EXEC SQL
        SELECT  NVL(XSM_SURV_IND, 0 )
        INTO    :sql_xsm_surv_ind
        FROM    XSM_XCHNG_STK_MSTR
        WHERE   XSM_XCHNG_CD  = 'NSE'
        AND     XSM_STCK_CD   = :c_underlying;

				if(SQLCODE !=0 && SQLCODE != NO_DATA_FOUND)
				{
					fn_errlog ( c_ServiceName, "S11111", SQLMSG, c_err_msg.arr );
					Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
					tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    		}

        if(sql_xsm_surv_ind > 0)
        {
           c_err_type = 'P';

					 if(DEBUG_MSG_LVL_4)  /* Added in Ver 5.3 */
					 {
           fn_userlog(c_ServiceName,"Message for surveillance action");
					 }

           EXEC SQL
            SELECT  NVL(SIM_DESC, '' ),
            NVL(SIM_SHORT_CD, '' )
            INTO    :sql_sim_desc,
                    :sql_sim_short_cd
            FROM    SIM_SURV_INDCTR_MSTR
            WHERE   SIM_SURV_IND  = :sql_xsm_surv_ind;
          
						SETNULL(sql_sim_desc);
						SETNULL(sql_sim_short_cd);

           if(DEBUG_MSG_LVL_3)
					 {
						 fn_userlog(c_ServiceName,"Err_type |%c| Surv msg desc |%s| Short code |%s|",c_err_type,sql_sim_desc.arr,sql_sim_short_cd.arr);
					 }
  
           if(SQLCODE != 0)
           {
               if(SQLCODE == NO_DATA_FOUND)
               {
                 fn_userlog(c_ServiceName,"No description found for surveillance action indicator |%ld|.",sql_xsm_surv_ind);
               }
               else
               {
                  fn_userlog(c_ServiceName,"Error while getting surveillance action details.");
                  fn_errlog(c_ServiceName, "S31075", SQLMSG, c_err_msg.arr);
        	  	  	Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0);
        				  tpfree ( ( char * ) ptr_o_st_cntrct );
        				  tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
      					}
    			  }        
	        	
						/*sprintf(c_msg,"This Security is under surveillance Measure by the exchange.Surveillance Reason is : %s[%s]",sql_sim_desc.arr,sql_sim_short_cd.arr);*/
						sprintf(c_msg,"%s[%s]",sql_sim_desc.arr,sql_sim_short_cd.arr);
            
						rtrim(c_msg);
				}
				else if(ban_cnt!=0)
				{
						c_err_type='N';
				}

				if(st_i_cntrct.c_rqst_typ == STK_SURV || st_i_cntrct.c_rqst_typ == FROM_STOCKLST_ENABLED)
				{

					i_err[0] = Fadd32(ptr_fml_Obuf,FFO_SYS_MSG,(char *)c_msg,0);
					i_ferr[0]=Ferror32;
					i_err[1] = Fadd32(ptr_fml_Obuf,FFO_STLMNT_TYP,(char *)&c_err_type,0);
					i_ferr[1]=Ferror32;

					for( i_cnt = 0; i_cnt < 2; i_cnt++ )
					{
							if( i_err[i_cnt] == -1 )
							{
								fn_errlog( c_ServiceName, "S31080", SQLMSG, c_err_msg.arr  );
								tpfree ( ( char * ) ptr_fml_Obuf );
								Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
								tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
							} 
					}
				
					if(st_i_cntrct.c_rqst_typ == STK_SURV)
					{
						tpreturn( TPSUCCESS, 0, (char *)ptr_fml_Obuf, 0 , 0 );
					}
				}
	 }
	 /** Ver 5.2 ends **/		

  if(st_i_cntrct.c_rqst_typ == FOR_QUOTES_MONEY_TYPE)
  {
    if(DEBUG_MSG_LVL_3)
    {
      fn_userlog( c_ServiceName, "Request type is FOR_QUOTES_MONEY_TYPE:%c",st_i_cntrct.c_rqst_typ);
    }

    EXEC SQL
    SELECT * into :st_ftq_recs FROM
    (
    SELECT A.* FROM (
            SELECT FTQ_XCHNG_CD,
                   FTQ_PRDCT_TYP,
                   FTQ_UNDRLYNG,
                   TO_CHAR(FTQ_EXPRY_DT,'DD-Mon-YYYY'),
                   FTQ_EXER_TYP,
                   FTQ_OPT_TYP,
                   FTQ_STRK_PRC,
                   NVL(FTQ_MIN_LOT_QTY,0),
                   FTQ_INDSTK,
                   FTQ_QT_TRDNG_FLG,
                   NVL(FTQ_LST_TRD_PRC,0),
                   NVL(TO_CHAR ( FTQ_LST_TRD_TM, 'dd-Mon-yyyy hh24:mi:ss' ),' '),
                   NVL(FTQ_TRAIL_FLG,'N'),
                   DECODE(NVL(FTQ_SETLMNT_FLG,'C'),'P','Y','N'),
                   DECODE(FTQ_OPT_TYP,'C',decode(sign(:d_spot_prc*100-FTQ_STRK_PRC),1,'I',-1,'O','A'),'P',decode(sign(:d_spot_prc*100-FTQ_STRK_PRC),1,'O',-1,'I','A'),FTQ_OPT_TYP),
									 NVL(decode(FTQ_OTM_FLG,'N',FMM_EXPSR,FMM_DEEP_OTM_EXPSR),0),	/*** ver 4.6 ***/ 
                  NVL(FTQ_SPN_PER_LOT,0),		/*** ver 4.6 ***/
                  NVL(FMM_SPN_MULTPLR,0),		/*** ver 4.6 ***/
                   nvl(fmm_somc_prcnt,0), /** ver 4.6 **/
                   decode(NVL(FTQ_OTM_FLG,'N'),'Y',nvl(fmm_deep_otm_im_prcnt,0),nvl(fmm_init_mrgn_prcnt,0)), /** ver 4.6 ***/
                  NVL(FMM_INIT_MRGN_PRCNT,0.0), /*** ver 4.6 ***/
                   NVL(FMM_OPLUS_SEBI_PRCNT_B,0.0), /*** opls ver 4.6 ***/
                   NVL(FMM_OPLUS_FLAT_RT, 0.0 ),/*** opls buy 4.6 ***/
                   NVL(FMM_OPLUS_SEBI_PRCNT_S, 0.0 ), /*** ver 4.6 ***/
                   decode(NVL(FTQ_OTM_FLG,'N'),'Y',NVL(FMM_DEEP_OTM_EXPSR,0),NVL(FMM_EXPSR,0)), /*** ver 4.6 **/
                   NVL(FTQ_SPN_PER_LOT_B,0)/*** ver 4.6 ***/
             FROM  FTQ_FO_TRD_QT,FMM_FO_MRGN_MSTR	/*** ver 4.6 ***/
						WHERE  FTQ_XCHNG_CD = :c_exchange_code /*** ver 4.6 ***/
							AND FMM_XCHNG_CD = FTQ_XCHNG_CD			/*** ver 4.6 ***/
              AND  FTQ_UNDRLYNG = :c_underlying
              AND  FTQ_EXPRY_DT like DECODE(:c_expry_dt1,'*','%',:c_expry_dt1)  /*** ver 4.6 ***/
              AND  FTQ_STRK_PRC like DECODE(:l_strike_prc,-1,'%',:l_strike_prc) /*** ver 4.6 ***/
							AND FMM_UNDRLYNG = FTQ_UNDRLYNG	/*** ver 4.6 ***/
              AND  FTQ_PRDCT_TYP = ( CASE
                                     WHEN :c_product_type = 'P'  THEN  'F'
                                     WHEN :c_product_type = 'U'  THEN  'F'
                                     WHEN :c_product_type = 'I'  THEN  'O'
                                     ELSE :c_product_type
                                     END
                                   )
						  AND FMM_PRDCT_TYP = FTQ_PRDCT_TYP	/*** ver 4.6 ***/
						  AND FMM_UNDRLYNG_BSKT_ID = 1  	/*** ver 4.6 ***/
              AND FTQ_OPT_TYP = :c_option_type
              AND FTQ_QT_TRDNG_FLG = :c_qt_trdng_flg
              AND NVL(FTQ_SLTP_FP_QT_TRDNG_FLG,'*') =
                  DECODE (:c_product_type,'I','T','U','T',NVL(FTQ_SLTP_FP_QT_TRDNG_FLG,'*'))
         ORDER BY FTQ_PRDCT_TYP,FTQ_UNDRLYNG,FTQ_EXPRY_DT,FTQ_STRK_PRC ASC) A
        UNION ALL
          SELECT B.* FROM
          (
          SELECT  FTQ_XCHNG_CD,
                  FTQ_PRDCT_TYP,
                  FTQ_UNDRLYNG,
                  TO_CHAR(FTQ_EXPRY_DT,'DD-Mon-YYYY'),
                  FTQ_EXER_TYP,
                  FTQ_OPT_TYP,
                  FTQ_STRK_PRC,
                  NVL(FTQ_MIN_LOT_QTY,0),
                  FTQ_INDSTK,
                  FTQ_QT_TRDNG_FLG,
                  NVL(FTQ_LST_TRD_PRC,0),
                  NVL(TO_CHAR ( FTQ_LST_TRD_TM, 'dd-Mon-yyyy hh24:mi:ss' ),' '),
                  NVL(FTQ_TRAIL_FLG,'N'),
                  DECODE(NVL(FTQ_SETLMNT_FLG,'C'),'P','Y','N'),
                  'D',     /*** Descending Order Contracts for In the Money Call and Out of the Money Put ***/
									NVL(decode(FTQ_OTM_FLG,'N',FMM_EXPSR,FMM_DEEP_OTM_EXPSR),0),		/*** ver 4.6 ***/ 
                  NVL(FTQ_SPN_PER_LOT,0),	/*** ver 4.6 ***/
                  NVL(FMM_SPN_MULTPLR,0) 	/*** ver 4.6 ***/,
                   nvl(fmm_somc_prcnt,0), /** ver 4.6 **/
                   decode(NVL(FTQ_OTM_FLG,'N'),'Y',nvl(fmm_deep_otm_im_prcnt,0),nvl(fmm_init_mrgn_prcnt,0)), /** ver 4.6 ***/
                  NVL(FMM_INIT_MRGN_PRCNT,0.0), /*** ver 4.6 ***/
                   NVL(FMM_OPLUS_SEBI_PRCNT_B,0.0), /*** opls ver 4.6 ***/
                   NVL(FMM_OPLUS_FLAT_RT, 0.0 ),/*** opls buy 4.6 ***/
                   NVL(FMM_OPLUS_SEBI_PRCNT_S, 0.0 ), /*** ver 4.6 ***/
                   decode(NVL(FTQ_OTM_FLG,'N'),'Y',NVL(FMM_DEEP_OTM_EXPSR,0),NVL(FMM_EXPSR,0)), /*** ver 4.6 **/
                   NVL(FTQ_SPN_PER_LOT_B,0)/*** ver 4.6 ***/
             FROM FTQ_FO_TRD_QT,FMM_FO_MRGN_MSTR	/*** ver 4.6 ***/
						WHERE FTQ_XCHNG_CD = :c_exchange_code /*** ver 4.6 ***/
							AND FMM_XCHNG_CD = FTQ_XCHNG_CD		/*** ver 4.6 ***/
              AND FTQ_UNDRLYNG = :c_underlying
              AND  FTQ_EXPRY_DT like DECODE(:c_expry_dt1,'*','%',:c_expry_dt1) /*** ver 4.6 ***/
              AND  FTQ_STRK_PRC like DECODE(:l_strike_prc,-1,'%',:l_strike_prc) /*** ver 4.6 ***/
							AND FMM_UNDRLYNG = FTQ_UNDRLYNG			/*** ver 4.6 ***/
              AND FTQ_PRDCT_TYP = ( CASE
                                    WHEN :c_product_type = 'P'  THEN  'F'
                                    WHEN :c_product_type = 'U'  THEN  'F'
                                    WHEN :c_product_type = 'I'  THEN  'O'
                                    ELSE :c_product_type
                                    END
                                  )
		          AND FMM_PRDCT_TYP = FTQ_PRDCT_TYP		/*** ver 4.6 ***/
							AND FMM_UNDRLYNG_BSKT_ID = 1  		/*** ver 4.6 ***/
              AND FTQ_OPT_TYP = :c_option_type
              AND FTQ_QT_TRDNG_FLG = :c_qt_trdng_flg
              AND NVL(FTQ_SLTP_FP_QT_TRDNG_FLG,'*') =
                  DECODE (:c_product_type,'I','T','U','T',NVL(FTQ_SLTP_FP_QT_TRDNG_FLG,'*'))
              AND :d_spot_prc*100-FTQ_STRK_PRC>0
         ORDER BY FTQ_PRDCT_TYP,FTQ_UNDRLYNG,FTQ_EXPRY_DT,FTQ_STRK_PRC DESC
          ) B
    );

    i_row_count=sqlca.sqlerrd[2];

    if(SQLCODE !=0 && SQLCODE != NO_DATA_FOUND)
    {
      fn_errlog ( c_ServiceName, "S11111", SQLMSG, c_err_msg.arr );
      EXEC SQL FREE :sys_cursor;
      tpfree ( ( char * ) ptr_o_st_cntrct );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

    if(SQLCODE == NO_DATA_FOUND)
    {
      fn_userlog(c_ServiceName,"No more data to process");
    }

		if(DEBUG_MSG_LVL_3)
    {
      fn_userlog( c_ServiceName, "i_row_count is :%d",i_row_count);
    }

		/*** Ver 4.7 starts ***/
    EXEC SQL
     SELECT  NVL(CLM_SPAN_ALLWD,'N')
     INTO    :c_spn_flg
     FROM    CLM_CLNT_MSTR
     WHERE   CLM_MTCH_ACCNT  =(select UAC_CLM_MTCH_ACCNT FROM UAC_USR_ACCNTS WHERE UAC_USR_ID = :st_usr_prfl.c_user_id);
    if ( SQLCODE != 0 && SQLCODE != NO_DATA_FOUND )
    {
			if (SQLCODE == -1427 )
			{
			 EXEC SQL
			  SELECT  NVL(CLM_SPAN_ALLWD,'N')
			  INTO    :c_spn_flg
        FROM    ICD_INFO_CLIENT_DTLS,
                IAI_INFO_ACCOUNT_INFO,
				        UAC_USR_ACCNTS,
      				  CLM_CLNT_MSTR
        WHERE   ICD_SERIAL_NO = IAI_SERIAL_NO
	      and UAC_CLM_MTCH_ACCNT = IAI_MATCH_ACCOUNT_NO
	      and CLM_MTCH_ACCNT = UAC_CLM_MTCH_ACCNT
	      and UAC_USR_ID = :st_usr_prfl.c_user_id 
	      AND IAI_TYPE = 'NRO_NON_PINS';

			if ( SQLCODE != 0 && SQLCODE != NO_DATA_FOUND)
			{
    	  fn_errlog ( c_ServiceName, "S11112", SQLMSG, c_err_msg.arr );
      	EXEC SQL FREE :sys_cursor;
      	tpfree ( ( char * ) ptr_o_st_cntrct );
      	Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
      	tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
			}
		 }
		 else
		 {
        fn_errlog ( c_ServiceName, "S11113", SQLMSG, c_err_msg.arr );
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
		 }
		}

		if(DEBUG_MSG_LVL_4) /* Added in 5.3 */
		{
		fn_userlog(c_ServiceName,"User:%s: Span flg:%c: c_product_type:%c:",st_usr_prfl.c_user_id,c_spn_flg,c_product_type);
		}
 

		if ( (c_product_type == 'O' && c_spn_flg == 'Y') || c_product_type == 'I')
		{
			d_max_spot_prc = fn_maxd(d_spot_prc,d_prev_spot_prc); 
		}
		else
		{
			d_max_spot_prc = d_spot_prc;
		}
		/*** Ver 4.7 ends ***/

    for ( i_cnt=0; i_cnt<i_row_count; i_cnt++ )
    {
    /*** ver 4.6 starts ***/
    if(DEBUG_MSG_LVL_3)
    {
		fn_userlog(c_ServiceName,"d_otm_oth_expsr :%lf:",st_ftq_recs[i_cnt].d_otm_oth_expsr);
		fn_userlog(c_ServiceName,"d_spn_per_lot :%lf:",st_ftq_recs[i_cnt].d_spn_per_lot);
		fn_userlog(c_ServiceName,"d_spn_multplr :%lf:",st_ftq_recs[i_cnt].d_spn_multplr);
		fn_userlog(c_ServiceName,".d_otm_oth_prcnt :%lf:",st_ftq_recs[i_cnt].d_otm_oth_prcnt);
		fn_userlog(c_ServiceName,"d_spn_per_lot_b :%lf:",st_ftq_recs[i_cnt].d_spn_per_lot_b);
		fn_userlog(c_ServiceName,"d_max_spot_prc:%lf:",d_max_spot_prc); /*** Ver 4.7 ***/
		fn_userlog(c_ServiceName,"Expiry date:%s:",st_ftq_recs[i_cnt].c_expiry_dt); /*** Ver 4.7 ***/
    }
    /*** ver 4.6 ***/
		/* Ver 4.8  OTM Alert Start*/
			d_days_to_exp=0;d_days_to_exp_temp=0;d_undrlyng_val_rupee=0;
			if(c_spn_flg == 'Y')
			{

				/**** 
				ptr_fml_Sbuf = (FBFR32 *)tpalloc( "FML32", NULL, MIN_FML_BUF_LEN );
				ptr_fml_Rbuf = (FBFR32 *)tpalloc( "FML32", NULL, MIN_FML_BUF_LEN );
				if ( ptr_fml_Sbuf == NULL || ptr_fml_Rbuf == NULL)
				{
					fn_errlog( c_ServiceName, "S31085", TPMSG, c_err_msg.arr  );
					EXEC SQL FREE :sys_cursor;
					tpfree ( ( char * ) ptr_o_st_cntrct );
					Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
					tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
				}****/

				EXEC SQL
				SELECT NVL((to_date(:st_ftq_recs[i_cnt].c_expiry_dt,'dd-Mon-YYYY') - to_date(sysdate,'dd-Mon-YYYY') + 1 ),1),
							 NVL(to_date(:st_ftq_recs[i_cnt].c_expiry_dt,'dd-Mon-YYYY') - to_date(sysdate,'dd-Mon-YYYY') ,0),
							 nvl(ltq_rt,0)	
				INTO   :d_days_to_exp,
							 :d_days_to_exp_temp,
							 :d_undrlyng_val_rupee
				FROM   ltq_trd_qt WHERE ltq_xchng_cd = 'NSE' and ltq_stck_cd=:c_underlying;
				if ( SQLCODE != 0 && SQLCODE != NO_DATA_FOUND)
				{
					fn_errlog ( c_ServiceName, "S11120", SQLMSG, c_err_msg.arr );
					EXEC SQL FREE :sys_cursor;
					tpfree ( ( char * ) ptr_o_st_cntrct );
					Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
					tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
				}

				if(d_days_to_exp_temp != 0 )
						d_days_to_exp = d_days_to_exp_temp;

				d_strike=(double)st_ftq_recs[i_cnt].l_strike_prc/100;
				d_lsttrd_prc=(double)st_ftq_recs[i_cnt].l_lst_trdd_prc/100;
				
				/*if(st_ftq_recs[i_cnt].c_opt_typ == 'C') {
					i_err[2] = Fadd32(ptr_fml_Sbuf, FFO_EFF_LMT_RT,(char *)&ptr_st_cntct->d_imp_vol, 0); } 
				else { i_err[2] = Fadd32(ptr_fml_Sbuf, FFO_EFF_LTP,(char *)&d_lsttrd_prc, 0); }*/

				/***** 
				i_err[0] = Fadd32(ptr_fml_Sbuf, FFO_USR_ID,(char *)c_user_id_tmp, 0 );
				i_err[1] = Fadd32(ptr_fml_Sbuf, FFO_SSSN_ID,(char *)&l_session_id_tmp, 0 );
				i_err[2] = Fadd32(ptr_fml_Sbuf, FFO_EFF_LTP,			 (char *)&d_lsttrd_prc, 0);
				i_err[3] = Fadd32(ptr_fml_Sbuf, FFO_STCK_PRICE,    (char *)&d_undrlyng_val_rupee, 0);
				i_err[4] = Fadd32(ptr_fml_Sbuf, FFO_STRIKE_PRC,    (char *)&d_strike, 0);
				i_err[5] = Fadd32(ptr_fml_Sbuf, FFO_OPT_TYP,       (char *)&st_ftq_recs[i_cnt].c_opt_typ, 0);
				i_err[6] = Fadd32(ptr_fml_Sbuf, FFO_EXER_TYP,      (char *)&st_ftq_recs[i_cnt].c_exrc_typ, 0);
				i_err[7] = Fadd32(ptr_fml_Sbuf, FFO_INTRST_RT,     (char *)&d_interest_rt, 0 );
				i_err[8] = Fadd32(ptr_fml_Sbuf, FFO_PLG_RT,        (char *)&d_dividend, 0 );
				i_err[9] = Fadd32(ptr_fml_Sbuf, FFO_DAY_TO_EXP,    (char *)&d_days_to_exp, 0 );

				for( i_count = 0; i_count < 10; i_count++ )
				{
					 if( i_err[i_count] == -1 )
					 { 
						fn_userlog(c_ServiceName,"error whicking variable at position :%d:",i_cnt);
						fn_errlog( c_ServiceName, "S31090",FMLMSG, c_err_msg.arr);
						EXEC SQL FREE :sys_cursor;
						tpfree ( ( char * ) ptr_o_st_cntrct );
						tpfree ( ( char * ) ptr_fml_Sbuf );
						tpfree ( ( char * ) ptr_fml_Rbuf );
						Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
						tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
					 }
				}
				********/

				/* l_bufferlength = Fsizeof32(ptr_fml_Sbuf) + MIN_FML_BUF_LEN ;*/


				/*************

				i_returncode=tpcall("SFO_CAL_GREEKS",(char*)ptr_fml_Sbuf,0,(char **)&ptr_fml_Rbuf,&l_bufferlength,0);

				if( i_returncode== -1 )
				{
					fn_userlog(c_ServiceName,"Error while calling service sfo_cal_greeks.");
					fn_userlog( c_ServiceName," Call to service for fetching implied volatility failed " );
					fn_errlog( c_ServiceName, "S31095",FMLMSG, c_err_msg.arr);
					EXEC SQL FREE :sys_cursor;
					tpfree ( ( char * )ptr_fml_Sbuf);
					tpfree ( ( char * )ptr_fml_Rbuf);
					Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
					tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
				}

				tpfree ( ( char * ) ptr_fml_Sbuf );

				i_err[0] = Fget32( ptr_fml_Rbuf, FFO_INIT_MRGN_PRCNT,0,(char *)&d_delta, 0);
				if(i_err[0] == -1 )
				{
						fn_errlog( c_ServiceName, "S31100",FMLMSG, c_err_msg.arr);
						EXEC SQL FREE :sys_cursor;
						tpfree ( ( char * ) ptr_o_st_cntrct );
						tpfree ( ( char * ) ptr_fml_Sbuf );
						tpfree ( ( char * ) ptr_fml_Rbuf );
						Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
						tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
				}
				*********/


				d_imp_vol=0.00;
				d_delta=0.00;
								if(st_ftq_recs[i_cnt].c_opt_typ == 'C')
								{

									if(DEBUG_MSG_LVL_4) /* Added in 5.3 */
									{
									fn_userlog(c_ServiceName," In Call to greek computation");
									}
									d_imp_vol=vol_ecall(c_ServiceName,d_undrlyng_val_rupee,d_strike,d_days_to_exp,d_interest_rt,d_lsttrd_prc);
									d_delta=delta_eurpcall(c_ServiceName,d_undrlyng_val_rupee, d_strike, d_days_to_exp, d_imp_vol, d_interest_rt);
								}
								else if(st_ftq_recs[i_cnt].c_opt_typ == 'P')
								{
									if(DEBUG_MSG_LVL_4) /* Added in 5.3 */
									{
									fn_userlog(c_ServiceName," In Put to greek computation");
									}
									d_imp_vol=vol_eput(c_ServiceName,d_undrlyng_val_rupee,d_strike,d_days_to_exp,d_interest_rt,d_lsttrd_prc);
									d_delta=delta_eurpput(c_ServiceName,d_undrlyng_val_rupee, d_strike, d_days_to_exp, d_imp_vol, d_interest_rt);
								}
						
								if(DEBUG_MSG_LVL_4) /* Added in 5.3 */
								{	
								fn_userlog(c_ServiceName,"GREEKS Val OprType:%c:d_days_to_exp:%lf:d_lsttrd_prc:%lf:d_strike:%lf:d_undrlyng_val_rupee:%lf:d_imp_vol:%lf:DELTA:%lf:",st_ftq_recs[i_cnt].c_opt_typ,d_days_to_exp,d_lsttrd_prc,d_strike,d_undrlyng_val_rupee,d_imp_vol,d_delta);
								}
				       /* Ver 4.9 Start */ 
								if(c_err_type!='P')
          	    {
                 c_err_flag='N';
                 c_err_type='N';
                 MEMSET(c_alert_msg.arr);
                 d_prob=0;
                }
				       /* Ver 4.9 End */ 

								if(fabs(d_delta)<=OTM_ALERT && c_err_type!='P')
								{
									c_err_flag='O';
													c_err_type='M';
													MEMSET(c_alert_msg.arr);
													d_prob=(1-fabs(d_delta))*100;
													sprintf(c_alert_msg.arr," This option price has a %.2lf%% chance of becoming 0.",d_prob);
													SETLEN(c_alert_msg);
												}
								/*tpfree ( ( char * ) ptr_fml_Rbuf );*/
							}
						/* Ver 4.8 OTM Alert End */

						i_returncode = fn_pack_vartofml ( c_ServiceName,
																					c_err_msg.arr,
																					&ptr_fml_Obuf,
                                  		31,			/*** ver 4.6 16 to 20 ***/ /*** ver 4.6 changed to 27 ***/ /**Ver 4.8 Changed to 30**//**Ver 5.2 Changed to 31 from 30**/
						FFO_XCHNG_CD,     (char *)st_ftq_recs[i_cnt].c_xchng_cd,
						FFO_PRDCT_TYP,    (char *)&c_product_type,
						FFO_UNDRLYNG,     (char *)st_ftq_recs[i_cnt].c_undrlyng,
						FFO_EXPRY_DT,     (char *)st_ftq_recs[i_cnt].c_expiry_dt,
						FFO_EXER_TYP,     (char *)&st_ftq_recs[i_cnt].c_exrc_typ,
						FFO_OPT_TYP,      (char *)&st_ftq_recs[i_cnt].c_opt_typ,
						FFO_STRK_PRC,     (char *)&st_ftq_recs[i_cnt].l_strike_prc,
						FFO_MIN_LOT_QTY,  (char *)&st_ftq_recs[i_cnt].l_lot_sz,
						FFO_CTGRY_INDSTK, (char *)&st_ftq_recs[i_cnt].c_ctgry_indstk,
						FFO_STATUS_FLG,   (char *)&st_ftq_recs[i_cnt].c_trading_flg,
						FFO_LST_TRD_PRC,  (char *)&st_ftq_recs[i_cnt].l_lst_trdd_prc,
						FFO_LST_TRD_TM,   (char *)st_ftq_recs[i_cnt].c_lst_trdd_time,
						FFO_BK_UBK_FLG,   (char *)&st_ftq_recs[i_cnt].c_setlmnt_flg_tmp,
						FFO_IS_FLG,       (char *)&st_ftq_recs[i_cnt].c_money_typ,
						FFO_STCK_PRICE,   (char *)&d_max_spot_prc, /*** Ver 4.7 changed from d_spot_prc to d_max_spot_prc ***/
						FFO_DLVRY_ALLWD,  (char *)&c_allwd_flg,
						FFO_THRS_VAR_PRCNT,(char *)&st_ftq_recs[i_cnt].d_otm_oth_expsr,			/*** ver 4.6 ***/
						FFO_NEW_EFF_RT,			(char *)&st_ftq_recs[i_cnt].d_spn_per_lot,			/*** ver 4.6 ***/
						FFO_OLD_EFF_RT,		(char *)&st_ftq_recs[i_cnt].d_spn_multplr,			/*** ver 4.6 ***/	
						FFO_STKOPT_EXRC	,		(char *)&st_ftq_recs[i_cnt].d_somc_prcnt,			/*** ver 4.6 ***/	
						FFO_U_SPRD_PL,		(char *)&st_ftq_recs[i_cnt].d_otm_oth_prcnt,			/*** ver 4.6 ***/	
						FFO_C_UND_OPN_VAL,		(char *)&st_ftq_recs[i_cnt].d_init_mrgn_prcnt,			/*** ver 4.6 ***/	
						FFO_ORD_AMT_BLKD,   (char *)&st_ftq_recs[i_cnt].d_sebi_buy_opls_prcnt, /*** ver 4.6 ***/
						FFO_CE_BUY_ORD_VL,  (char *)&st_ftq_recs[i_cnt].d_opls_flat_rate, /*** ver 4.6 ***/
						FFO_UE_SELL_MRGN,  (char *)&st_ftq_recs[i_cnt].d_sebi_sell_opls_prcnt, /*** ver 4.6 ***/
						FFO_INDOPT_EXRC,    (char *)&st_ftq_recs[i_cnt].d_otm_oth_prcnt,      /*** ver 4.6 ***/
						FFO_EX_EXCTD_VL,    (char *)&st_ftq_recs[i_cnt].d_spn_per_lot_b,      /*** ver 4.6 ***/
						FFO_REMARKS,				(char *)c_alert_msg.arr,													/*** Ver 4.8 ***/
						FFO_CLSR_TYP,			(char *)&c_err_flag,  /*** Ver 4.8 ***/
						FFO_STLMNT_TYP,			(char *)&c_err_type,		/*** Ver 4.8 ***/
						FFO_SYS_MSG,(char *)c_msg	/** Ver 5.2 **/
    );

      if ( i_returncode == -1 )
      {
        fn_errlog ( c_ServiceName, "S22222", LIBMSG, c_err_msg.arr );
				EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

    }

  EXEC SQL FREE :sys_cursor;
  tpfree ( ( char * ) ptr_o_st_cntrct );
  tpreturn( TPSUCCESS, 0, (char *)ptr_fml_Obuf, 0 , 0 );
  }
/*** Ver 4.0 Ends ***/

/* if(st_i_cntrct.c_rqst_typ != ALL_CNTRCTS)			*Ver 1.8 **commented in Ver 4.2 **/
if(st_i_cntrct.c_rqst_typ != ALL_CNTRCTS && st_i_cntrct.c_rqst_typ != GET_CNT_R_SPD_CNTRCT)			/**Ver 4.2**/
{
	/*** Commented in Ver 4.0 Starts as Query moved above ***
 	*** Added in Ver 2.8 *** 
	if(c_product_type == 'U' || c_product_type == 'I' || c_product_type == 'F' || c_product_type == 'P')	*** Product type "I" added in Ver 3.0 *** *** FUT,FUTPLS View mrgn  added in Ver 3.6 *** 
  {	

   if (DEBUG_MSG_LVL_3)  **** Debug level added in Ver VQC**
		{
   		fn_userlog(c_ServiceName, "c_product_type :%c:",c_product_type);
		}

    EXEC SQL
    SELECT NVL(FUM_SLTPFP_LMT_ALLWD_FLG,'N')
    INTO  :c_allwd_flg
    FROM  FUM_FO_UNDRLYNG_MSTR
    WHERE FUM_XCHNG_CD    = :c_exchange_code
    AND   FUM_UNDRLYNG    = :c_underlying
    AND   FUM_PRDCT_TYP   = DECODE(:c_product_type,'U','F','I','O','P','F',:c_product_type); *** Ver 3.6 ***
   *** AND   FUM_PRDCT_TYP   = decode(:c_product_type,'U','F','I','O','P','F',:ptr_o_st_cntrct->c_prd_typ); commented in ver 3.6 ***

    if(SQLCODE != 0 )
    {
     *** fn_errlog( c_ServiceName, "S31105", SQLMSG, c_err_msg  ); ***
      fn_errlog ( c_ServiceName, "B21000", DEFMSG, c_err_msg.arr );	
      EXEC SQL CLOSE :sys_cursor;
      EXEC SQL FREE :sys_cursor;
      tpfree ( ( char * ) ptr_o_st_cntrct );
      tpfree ( ( char * ) ptr_fml_Obuf );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

    fn_userlog(c_ServiceName, "Limit Allowed Flag SLTP F+ is :%c:",c_allwd_flg);
  }
	*** Commented in Ver 4.0 Ends ***/
	/*** Ver 2.8 Ends Here ***/
  for (;;)
  {
    if ( st_i_cntrct.c_rqst_typ == FAVOURITE_CONTRACTS ) /*** Ver 2.7 if-else added ***/
    {
     EXEC SQL FETCH :sys_cursor
             INTO :ptr_o_st_cntrct->c_xchng_cd,
                  :ptr_o_st_cntrct->c_prd_typ,
                  :ptr_o_st_cntrct->c_undrlyng,
                  :c_expiry_dt,
                  :ptr_o_st_cntrct->c_exrc_typ,
                  :ptr_o_st_cntrct->c_opt_typ,
                  :ptr_o_st_cntrct->l_strike_prc,
                  :l_lot_sz,
                  :ptr_o_st_cntrct->c_ctgry_indstk,
                  :c_trading_flg; /* Ver 1.3 */
    }
    else if ( st_i_cntrct.c_rqst_typ == FROM_UNDERLYING || st_i_cntrct.c_rqst_typ == FOR_QUOTES_ORDERS ) /*** Ver 3.1 ***/
    {
     EXEC SQL FETCH :sys_cursor
             INTO :ptr_o_st_cntrct->c_xchng_cd,
                  :ptr_o_st_cntrct->c_prd_typ,
                  :ptr_o_st_cntrct->c_undrlyng,
                  :c_expiry_dt,
                  :ptr_o_st_cntrct->c_exrc_typ,
                  :ptr_o_st_cntrct->c_opt_typ,
                  :ptr_o_st_cntrct->l_strike_prc,
                  :l_lot_sz,
                  :ptr_o_st_cntrct->c_ctgry_indstk,
                  :c_trading_flg,
                  :l_lst_trdd_prc,
                  :c_lst_trdd_time,
                  :c_trail_flag,  /*** Ver 3.5 ***/
									:c_setlmnt_flg_tmp,		/*** Added in Ver 3.8 ***/
									:d_exposure, /*** ver 4.6 ***/
									:d_spn_per_lot, /*** ver 4.6 ***/
									:d_spn_multplr,			/*** ver 4.6 ***/
                  :d_somc_prcnt,/*** ver 4.6 ***/
                  :d_otm_oth_prcnt,/*** ver 4.6 ***/
                  :d_init_mrgn_prcnt, /*** ver 4.6 ***/ 
                  :d_sebi_buy_opls_prcnt, /*** ver 4.6 ***/
                  :d_opls_flat_rate, /** ver 4.6 **/
                  :d_fmm_sltp_diff,/*** ver 4.6 ***/
                  :d_fmm_sltp_sebi,/*** ver 4.6 ***/
                  :d_fmm_sltp_prcnt, /*** ver 4.6 ***/
                  :d_fmm_fpsl_spn_mrgn_prcnt, /*** ver 4.6 ***/ 
                  :d_spn_per_lot_b; /*** ver 4.6 ***/ 

    /****** ver 4.6 starts ***********/
  if (DEBUG_MSG_LVL_3)     
  {
			fn_userlog(c_ServiceName,"d_spn_per_lot :%lf:",d_spn_per_lot);
			fn_userlog(c_ServiceName,"d_spn_per_lot_b :%lf:",d_spn_per_lot_b);
			fn_userlog(c_ServiceName,"d_spn_multplr :%lf:",d_spn_multplr);
  		fn_userlog(c_ServiceName,"d_exposure :%lf:",d_exposure);  
  		fn_userlog(c_ServiceName,"FPSLTP d_fmm_sltp_diff :%lf: d_fmm_sltp_sebi  :%lf: d_fmm_sltp_prcnt :%lf:",d_fmm_sltp_diff,d_fmm_sltp_sebi,d_fmm_sltp_prcnt);  
			fn_userlog(c_ServiceName,"d_init_mrgn_prcnt :%lf:",d_init_mrgn_prcnt);
			fn_userlog(c_ServiceName,"d_sebi_buy_opls_prcnt :%lf:",d_sebi_buy_opls_prcnt);
			fn_userlog(c_ServiceName,"d_opls_flat_rate :%lf:",d_opls_flat_rate);
			fn_userlog(c_ServiceName,"d_span_init_prcnt :%lf:",d_span_init_prcnt);
   } 
     /***** ver 4.6 ends **************/
	}
    else if( st_i_cntrct.c_rqst_typ == CLOUD_ORDERS )     /*** Ver 3.2 ***/
    {

			if(DEBUG_MSG_LVL_4) /* Added in 5.3 */
			{
      fn_userlog( c_ServiceName, "Request type is CLOUD_ORDERS ********  :%c",st_i_cntrct.c_rqst_typ);
			}

     EXEC SQL FETCH :sys_cursor
             INTO   :ptr_o_st_cntrct->c_xchng_cd,
                    :ptr_o_st_cntrct->c_prd_typ,
                    :ptr_o_st_cntrct->c_undrlyng,
                    :c_expiry_dt,
                    :ptr_o_st_cntrct->c_exrc_typ,
                    :ptr_o_st_cntrct->c_opt_typ,
                    :ptr_o_st_cntrct->l_strike_prc,
                    :l_lot_sz,
                    :ptr_o_st_cntrct->c_ctgry_indstk,
                    :c_trading_flg,
                    :l_ordr_qty,
                    :c_lmt_mktsl_flg,
                    :d_cvr_sltp_diff;
    }
    else if( st_i_cntrct.c_rqst_typ == FROM_STOCKLST_ENABLED || st_i_cntrct.c_rqst_typ == FROM_STOCKLST_DISABLED) /*** ver 4.3 ****/
    {
		if(DEBUG_MSG_LVL_4) /* Added in 5.3 */
		{
    fn_userlog( c_ServiceName, "suchita Request type is ********  :%c",st_i_cntrct.c_rqst_typ); 
		}
    EXEC SQL FETCH :sys_cursor
             INTO :ptr_o_st_cntrct->c_xchng_cd,
                  :ptr_o_st_cntrct->c_prd_typ,
                  :ptr_o_st_cntrct->c_undrlyng,
                  :c_expiry_dt,
                  :ptr_o_st_cntrct->c_exrc_typ,
                  :ptr_o_st_cntrct->c_opt_typ,
                  :ptr_o_st_cntrct->l_strike_prc,
                  :l_lot_sz,
                  :ptr_o_st_cntrct->c_ctgry_indstk,
                  :c_trading_flg,
                  :l_lst_trdd_prc,
                  :c_trail_flag, 
                  :c_setlmnt_flg_tmp,
                  :d_span_per_lot,
                  :c_oth_otm_flg;      /** ver 4.4 **/

    }/** ver 4.3 ends **/
    else 
    {

		if(DEBUG_MSG_LVL_4) /* Added in 5.3 */
		{
    fn_userlog( c_ServiceName, "Request type is ********  :%c",st_i_cntrct.c_rqst_typ); /* Ver 4.2 */
		}
    EXEC SQL FETCH :sys_cursor 
						 INTO :ptr_o_st_cntrct->c_xchng_cd,
						 		  :ptr_o_st_cntrct->c_prd_typ,
						 		  :ptr_o_st_cntrct->c_undrlyng,
									:c_expiry_dt,
						 		  :ptr_o_st_cntrct->c_exrc_typ,
						 		  :ptr_o_st_cntrct->c_opt_typ,
						 		  :ptr_o_st_cntrct->l_strike_prc, 
                  :l_lot_sz,
						 		  :ptr_o_st_cntrct->c_ctgry_indstk,
									:c_trading_flg, /* Ver 1.3 */
                  :l_lst_trdd_prc, /*** Ver 2.7 ***/
                  :c_trail_flag, /*** Ver 3.5 ***/
									:c_setlmnt_flg_tmp;   /*** Added in Ver 3.8 ***/
    }
    if ( SQLCODE != 0 )
    {
      if ( SQLCODE == NO_DATA_FOUND )
      {
        /*** Ver 2.1 starts **/

        if(st_i_cntrct.c_rqst_typ == FROM_UNDERLYING && i_rec_count == 0 )
        {
          fn_errlog ( c_ServiceName, "B21000", DEFMSG, c_err_msg.arr);  
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }

        /*** Ver 2.1 ends **/
        break;
      }

			fn_errlog( c_ServiceName, "S31110", SQLMSG, c_err_msg.arr); 
  		EXEC SQL CLOSE :sys_cursor;
  		EXEC SQL FREE :sys_cursor;
			tpfree ( ( char * ) ptr_o_st_cntrct );
			tpfree ( ( char * ) ptr_fml_Obuf );
			Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
			tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }
		i_rec_count = i_rec_count +1;           /*** Ver 2.1 ***/

		SETNULL (c_expiry_dt);  
		rtrim ( ptr_o_st_cntrct->c_undrlyng );

  	strcpy ( ptr_o_st_cntrct->c_expry_dt , ( char * ) c_expiry_dt.arr);
		if(DEBUG_MSG_LVL_4) /* Added in 5.3 */
		{
    fn_userlog(c_ServiceName,"d_span_per_lot suchita :%lf:",d_span_per_lot); /*** ver 4.3 **/
		}

 


    /*** Ver 3.5 Starts ****/
    if ( c_product_type == 'F' )
    {
      EXEC SQL
        SELECT NVL(FUM_TRAIL_AMT,0)*100,
               NVL(FUM_SLTP_TRAIL_FLG,'N')
        INTO   :l_trail_amt,
               :c_trail_flag_und
        FROM   FUM_FO_UNDRLYNG_MSTR
        WHERE  FUM_XCHNG_CD=:c_exchange_code
        AND    FUM_UNDRLYNG =:c_underlying
        AND    FUM_PRDCT_TYP=:c_product_type;

      if ( SQLCODE != 0 )
      {
        fn_errlog( c_ServiceName, "S31115", SQLMSG, c_err_msg.arr  ); 
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        free((char *) ptr_o_st_cntrct);
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      if( c_trail_flag_und != 'Y' )
      {
        c_trail_flag=c_trail_flag_und;
      }

       i_err[0] = Fadd32 ( ptr_fml_Obuf, FFO_STLMNT_PRC, (char *)&l_trail_amt,0);
       i_err[1] = Fadd32 ( ptr_fml_Obuf, FFO_NEW_CNTRCT_TAG, (char *)&c_trail_flag,0);
		/*** ver 4.6 starts ***/	
			i_err[2] = Fadd32 ( ptr_fml_Obuf, FFO_THRS_VAR_PRCNT, (char *)&d_otm_oth_prcnt,0);
      i_err[3] = Fadd32 ( ptr_fml_Obuf, FFO_NEW_EFF_RT, (char *)&d_spn_per_lot,0);
			i_err[4] = Fadd32 ( ptr_fml_Obuf, FFO_OLD_EFF_RT, (char *)&d_spn_multplr,0);
      i_err[5] = Fadd32 ( ptr_fml_Obuf,FFO_STKOPT_EXRC  ,   (char *)&d_somc_prcnt,0);     /*** ver 4.6 ***/
      i_err[6] = Fadd32 ( ptr_fml_Obuf, FFO_U_SPRD_PL,   (char *)&d_otm_oth_prcnt,0);      /*** ver 4.6 ***/
   /* i_err[7] = Fadd32 ( ptr_fml_Obuf, FFO_C_UND_OPN_VAL,   (char *)&d_span_init_prcnt,0);      *** ver 4.6 ***/
      i_err[7] = Fadd32 ( ptr_fml_Obuf, FFO_C_UND_OPN_VAL,   (char *)&d_init_mrgn_prcnt,0);      /*** ver 4.6 ***/
	    i_err[8] = Fadd32 ( ptr_fml_Obuf, FFO_PLG_RT,   (char *)&d_exposure,0); /*** Ver 4.6 ***/
	    i_err[9] = Fadd32 ( ptr_fml_Obuf, FFO_EX_EXCTD_VL,   (char *)&d_spn_per_lot_b,0); /*** Ver 4.6 ***/

	/*** ver 4.6ends  ***/
			if(DEBUG_MSG_LVL_4) /* Added in 5.3 */
			{
			fn_userlog(c_ServiceName,"Adding New FML's.........."); /** ver 4.6 **/
			}
       for( i_cnt = 0; i_cnt < 10; i_cnt++ )	/*** ver 4.6 change from 2 to 9 ***/
      {
         if( i_err[i_cnt] == -1 )
        {
          fn_errlog( c_ServiceName, "S31120", SQLMSG, c_err_msg.arr  ); 
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          free((char *) ptr_o_st_cntrct);
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
    }
    /******************* Ver 3.5 Ends *******************/

/*****************************************************************************/

		strcpy( st_contract.c_xchng_cd,	 ptr_o_st_cntrct->c_xchng_cd );
		st_contract.c_prd_typ	=	ptr_o_st_cntrct->c_prd_typ;
		strcpy( st_contract.c_undrlyng, ptr_o_st_cntrct->c_undrlyng );
		strcpy( st_contract.c_expry_dt, ptr_o_st_cntrct->c_expry_dt );
		st_contract.c_exrc_typ	=	ptr_o_st_cntrct->c_exrc_typ;
		st_contract.c_opt_typ	=	ptr_o_st_cntrct->c_opt_typ;
		st_contract.l_strike_prc	=	ptr_o_st_cntrct->l_strike_prc;
		st_contract.c_ctgry_indstk	=	ptr_o_st_cntrct->c_ctgry_indstk;

	if (DEBUG_MSG_LVL_3)			/*** Ver 1.1 ***/ 
	{
		fn_userlog( c_ServiceName, "c_xchng_cd=%s", st_contract.c_xchng_cd ); 
		fn_userlog( c_ServiceName, "c_prd_typ=%c", st_contract.c_prd_typ );
		fn_userlog( c_ServiceName, "c_undrlyng=%s", st_contract.c_undrlyng );
		fn_userlog( c_ServiceName, "c_expry_dt=%s", st_contract.c_expry_dt );
		fn_userlog( c_ServiceName, "c_exrc_typ=%c", st_contract.c_exrc_typ );
		fn_userlog( c_ServiceName, "c_opt_typ=%c", st_contract.c_opt_typ );
		fn_userlog( c_ServiceName, "l_strike_prc=%ld", st_contract.l_strike_prc );  
		fn_userlog( c_ServiceName, "c_ctgry_indstk=%c",st_contract.c_ctgry_indstk );
		fn_userlog( c_ServiceName, "c_trading_flg=%c",c_trading_flg ); /* Ver 1.3 */
    fn_userlog( c_ServiceName, "l_lst_trdd_prc=%ld",l_lst_trdd_prc); /*** Ver 2.7 ***/
    fn_userlog( c_ServiceName, "c_lst_trdd_time=%s",c_lst_trdd_time); /*** Ver 3.1 ***/
    fn_userlog( c_ServiceName, "c_oth_otm_flg=%c",c_oth_otm_flg); /*** Ver 4.4 ***/
	}

	/**Commented for Ver 1.6 *****
		i_ip_len	=	sizeof( struct vw_contract );
		i_op_len	=	sizeof( struct vw_cntrct_qt );

		i_returncode	=	fn_call_svc ( c_ServiceName,
																	c_err_msg,
																	&st_contract,
																	&st_cntrct_qt,
																	"vw_contract",
																	"vw_cntrct_qt",
																	i_ip_len,
																	i_op_len,
																	0,
																	"SFO_GET_QT" );
		if ( i_returncode	!= SUCC_BFR )
		{
			fn_errlog( c_ServiceName, "S31125", LIBMSG, c_err_msg );
			Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
			tpreturn( TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
		}
***Comment ends Ver 1.6 **/
  /*** Commented in Ver 2.7 ***
	i_returncode = fn_call_get_qt(c_ServiceName,
																&st_contract,
																&st_cntrct_qt,
																c_err_msg);
	if ( i_returncode	!= SUCC_BFR  && i_returncode != -2)
	{
		fn_errlog( c_ServiceName, "S31130", LIBMSG, c_err_msg );
		Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
		tpreturn( TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
	}
	if (i_returncode == -2 )
	{
  	fn_errlog ( c_ServiceName, "B28510", DEFMSG, c_err_msg );
		Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
		tpreturn( TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
	}
 
	if (DEBUG_MSG_LVL_3)			*** Ver 1.1 *** 
	{
	 fn_userlog(c_ServiceName,"l_lst_trdd_prc=%ld",st_cntrct_qt.l_lst_trdd_prc ); *** Ver 1.5 ***
	}
 *** Ver 2.7 Comment Ends ***/
/*****************************************************************************/

	/*Ver 1.2 add */ 
	/* Fixed bug for 1.5 */
	
	if( (  c_product_type =='P') && ( st_i_cntrct.c_rqst_typ != ALL_CNTRCTS ) )
	{
		ptr_o_st_cntrct->c_prd_typ ='P';
	}	

	/*Ver 1.2 add ends*/

	/*** Ver 2.2 Starts ***/
	else if( (  c_product_type =='U') && ( st_i_cntrct.c_rqst_typ != ALL_CNTRCTS ) ) 
	{
		ptr_o_st_cntrct->c_prd_typ ='U';
	}	
	/*** Ver 2.2 Ends ***/

	
	/*** Ver 2.4 Starts ***/
  else if( (  c_product_type =='I') && ( st_i_cntrct.c_rqst_typ != ALL_CNTRCTS ) )
  {
    ptr_o_st_cntrct->c_prd_typ ='I';

    /*** ver 4.5 starts ***/
    if( st_i_cntrct.c_rqst_typ == FROM_STOCKLST_ENABLED || st_i_cntrct.c_rqst_typ == FROM_STOCKLST_DISABLED)
    {
    EXEC SQL
         SELECT decode(:c_oth_otm_flg,'Y',NVL(FMM_DEEP_OTM_EXPSR,0),NVL(FMM_EXPSR,0))       
         INTO   :d_expr_prcnt
         FROM   FMM_FO_MRGN_MSTR
         WHERE  FMM_PRDCT_TYP='O'
         AND    FMM_UNDRLYNG = :st_contract.c_undrlyng
         AND    FMM_XCHNG_CD = :st_contract.c_xchng_cd
         AND    FMM_UNDRLYNG_BSKT_ID =(SELECT  FCB_UNDRLYNG_BSKT_ID
         FROM   FCB_FO_CLN_BSKT_ALLTD
         WHERE  FCB_CLN_LVL =(SELECT CLM_CLNT_LVL
         FROM   CLM_CLNT_MSTR
         WHERE  CLM_MTCH_ACCNT = :st_usr_prfl.c_cln_mtch_accnt));

      if ( SQLCODE != 0 )
      {
        fn_errlog( c_ServiceName, "S31135", SQLMSG, c_err_msg.arr  );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        free((char *) ptr_o_st_cntrct);
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
      if (DEBUG_MSG_LVL_3)
      {
      fn_userlog(c_ServiceName,"d_expr_prcnt :%lf:",d_expr_prcnt);
      }
    }
   /*** ver 4.5 ends ***/
  }
  /*** Ver 2.4 Ends ***/


    i_returncode = Fvstof32( ptr_fml_Obuf, (char *) ptr_o_st_cntrct, 
															FCONCAT, "vw_contract" );
    if ( i_returncode == -1 )
    {
			if( Ferror32 == FNOSPACE )
			{
        i_counter++;
        ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,
                            ( i_counter * MIN_FML_BUF_LEN * 20 ) );			/***  Ver 3.1 Bufferlength Multiplied by 20 ***/
				if ( ptr_fml_Obuf == NULL )
				{
					fn_errlog( c_ServiceName, "S31140", TPMSG, c_err_msg.arr  ); 
  				EXEC SQL CLOSE :sys_cursor;
  				EXEC SQL FREE :sys_cursor;
					tpfree ( ( char * ) ptr_o_st_cntrct );
					tpfree ( ( char * ) ptr_fml_Obuf );
					Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
					tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
				}


    		i_returncode = Fvstof32( ptr_fml_Obuf, (char *) ptr_o_st_cntrct, 
															FCONCAT, "vw_contract" );
    		if ( i_returncode == -1 )
    		{
					fn_errlog( c_ServiceName, "S31145", FMLMSG, c_err_msg.arr  ); 
  				EXEC SQL CLOSE :sys_cursor;
  				EXEC SQL FREE :sys_cursor;
					tpfree ( ( char * ) ptr_o_st_cntrct );
					tpfree ( ( char * ) ptr_fml_Obuf );
					Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );  
					tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
				}
			}
			else
			{
				fn_errlog( c_ServiceName, "S31150", FMLMSG, c_err_msg.arr  );
  			EXEC SQL CLOSE :sys_cursor;
  			EXEC SQL FREE :sys_cursor;
				tpfree ( ( char * ) ptr_o_st_cntrct );
				tpfree ( ( char * ) ptr_fml_Obuf );
				Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
				tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
			}
    }

		if ( Fadd32( ptr_fml_Obuf, FFO_MIN_LOT_QTY, ( char *)&l_lot_sz, 0 ) == -1 )
		{
			if( Ferror32 == FNOSPACE )
			{
        i_counter++;
        ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,
                            ( i_counter * MIN_FML_BUF_LEN * 20 ) );			/***	Ver 3.1 Bufferlength Multiplied by 20 ***/
				if ( ptr_fml_Obuf == NULL )
				{
					fn_errlog( c_ServiceName, "S31155", TPMSG, c_err_msg.arr  ); 
  				EXEC SQL CLOSE :sys_cursor;
  				EXEC SQL FREE :sys_cursor;
					tpfree ( ( char * ) ptr_o_st_cntrct );
					tpfree ( ( char * ) ptr_fml_Obuf );
					Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
					tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
				}

				if ( Fadd32( ptr_fml_Obuf, FFO_MIN_LOT_QTY, ( char *)&l_lot_sz, 0 ) == -1 ) 
				{
					fn_errlog( c_ServiceName, "S31160", FMLMSG, c_err_msg.arr );
  				EXEC SQL CLOSE :sys_cursor;
  				EXEC SQL FREE :sys_cursor;
					tpfree ( ( char * ) ptr_o_st_cntrct );
					tpfree ( ( char * ) ptr_fml_Obuf );
					Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
					tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
				}
			}
			else
			{
				fn_errlog( c_ServiceName, "S31165", FMLMSG, c_err_msg.arr ); 
  			EXEC SQL CLOSE :sys_cursor;
  			EXEC SQL FREE :sys_cursor;
				tpfree ( ( char * ) ptr_o_st_cntrct );
				tpfree ( ( char * ) ptr_fml_Obuf );
				Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
				tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );	
			}
		}

   /*** ver 4.5 starts ***/
   if ( Fadd32( ptr_fml_Obuf, FFO_MKT_CPTLTN, ( char *)&d_expr_prcnt, 0 ) == -1 )
    {
      if( Ferror32 == FNOSPACE )
      {
        i_counter++;
        ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,
                            ( i_counter * MIN_FML_BUF_LEN * 20 ) );    
        if ( ptr_fml_Obuf == NULL )
        {
          fn_errlog( c_ServiceName, "S31170", TPMSG, c_err_msg.arr  );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }

        if ( Fadd32( ptr_fml_Obuf, FFO_MKT_CPTLTN, ( char *)&d_expr_prcnt, 0 ) == -1 )
        {
          fn_errlog( c_ServiceName, "S31175", FMLMSG, c_err_msg.arr );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
      else
      {
        fn_errlog( c_ServiceName, "S31180", FMLMSG, c_err_msg.arr );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }
   /*** ver 4.5 ends ***/
/****************Ver 1.3 Start************************************************/
    if ( Fadd32( ptr_fml_Obuf, FFO_STATUS_FLG, ( char *)&c_trading_flg, 0 ) == -1 )
    {
      if( Ferror32 == FNOSPACE )
      {
        i_counter++;
        ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,
                            ( i_counter * MIN_FML_BUF_LEN * 20 ) );			/***  Ver 3.1 Bufferlength Multiplied by 20 ***/
        if ( ptr_fml_Obuf == NULL )
        {
          fn_errlog( c_ServiceName, "S31185", TPMSG, c_err_msg.arr  ); 
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }

        if ( Fadd32( ptr_fml_Obuf, FFO_STATUS_FLG, ( char *)&c_trading_flg, 0 ) ==
               -1 )
        {
          fn_errlog( c_ServiceName, "S31190", FMLMSG, c_err_msg.arr );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );  
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
      else
      {
        fn_errlog( c_ServiceName, "S31195", FMLMSG, c_err_msg.arr  ); 
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }

/****************Ver 1.3 End**************************************************/

/****************Ver 3.2 Start************************************************/
    if ( Fadd32( ptr_fml_Obuf, FFO_ORD_TOT_QTY, ( char *)&l_ordr_qty, 0 ) == -1 )
    {
      if( Ferror32 == FNOSPACE )
      {
        i_counter++;
        ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,
                            ( i_counter * MIN_FML_BUF_LEN * 20 ) );
        if ( ptr_fml_Obuf == NULL )
        {
          fn_errlog( c_ServiceName, "S31200", TPMSG, c_err_msg.arr  );  
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }

        if ( Fadd32( ptr_fml_Obuf, FFO_ORD_TOT_QTY, ( char *)&l_ordr_qty, 0 ) ==
               -1 )
        {
          fn_errlog( c_ServiceName, "S31205", FMLMSG, c_err_msg.arr  );  
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
      else
      {
        fn_errlog( c_ServiceName, "S31210", FMLMSG, c_err_msg.arr ); 
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }

    if ( Fadd32( ptr_fml_Obuf, FFO_LMT_MKT_SL_FLG, ( char *)&c_lmt_mktsl_flg, 0 ) == -1 )
    {
      if( Ferror32 == FNOSPACE )
      {
        i_counter++;
        ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,
                            ( i_counter * MIN_FML_BUF_LEN * 20 ) );
        if ( ptr_fml_Obuf == NULL )
        {
          fn_errlog( c_ServiceName, "S31215", TPMSG, c_err_msg.arr ); 
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );  
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }

        if ( Fadd32( ptr_fml_Obuf, FFO_LMT_MKT_SL_FLG, ( char *)&c_lmt_mktsl_flg, 0 ) ==
               -1 )
        {
          fn_errlog( c_ServiceName, "S31220", FMLMSG, c_err_msg.arr); 
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
      else
      {
        fn_errlog( c_ServiceName, "S31225", FMLMSG, c_err_msg.arr  );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }

  if( c_product_type =='P') /*** ver 4.6 starts ***/
  {
    if ( Fadd32( ptr_fml_Obuf, FFO_C_UND_OPN_VAL, ( char *)&d_fmm_fpsl_spn_mrgn_prcnt, 0 ) == -1 )
    {
      if( Ferror32 == FNOSPACE )
      {
        i_counter++;
        ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,
                            ( i_counter * MIN_FML_BUF_LEN * 20 ) );
        if ( ptr_fml_Obuf == NULL )
        {
          fn_errlog( c_ServiceName, "S31230", TPMSG, c_err_msg.arr );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }

        if ( Fadd32( ptr_fml_Obuf, FFO_C_UND_OPN_VAL, ( char *)&d_fmm_fpsl_spn_mrgn_prcnt, 0 ) ==
               -1 )
        {
          fn_errlog( c_ServiceName, "S31235", FMLMSG, c_err_msg.arr);
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
      else
      {
        fn_errlog( c_ServiceName, "S31240", FMLMSG, c_err_msg.arr  );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }
  }

  if( c_product_type =='U') 
  {
		/*** Ver 4.7 starts ***/
    if ( Fadd32( ptr_fml_Obuf, FFO_PLG_RT,( char *)&d_exposure, 0 ) == -1 )
    {
      if( Ferror32 == FNOSPACE )
      {
        i_counter++;
        ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,
                            ( i_counter * MIN_FML_BUF_LEN * 20 ) );
        if ( ptr_fml_Obuf == NULL )
        {
          fn_errlog( c_ServiceName, "S31245", TPMSG, c_err_msg.arr );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }

        if ( Fadd32( ptr_fml_Obuf, FFO_PLG_RT,( char *)&d_exposure, 0 ) == -1 )
        {
          fn_errlog( c_ServiceName, "S31250", FMLMSG, c_err_msg.arr);
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
			}
      else
      {
        fn_errlog( c_ServiceName, "S31255", FMLMSG, c_err_msg.arr  );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
			}
		}
    if ( Fadd32( ptr_fml_Obuf, FFO_EX_EXCTD_VL,( char *)&d_spn_per_lot_b, 0 ) == -1 )
    {
      if( Ferror32 == FNOSPACE )
      {
        i_counter++;
        ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,
                            ( i_counter * MIN_FML_BUF_LEN * 20 ) );
        if ( ptr_fml_Obuf == NULL )
        {
          fn_errlog( c_ServiceName, "S31260", TPMSG, c_err_msg.arr );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }

        if ( Fadd32( ptr_fml_Obuf, FFO_EX_EXCTD_VL,( char *)&d_spn_per_lot_b, 0 ) == -1 )
        {
          fn_errlog( c_ServiceName, "S31265", FMLMSG, c_err_msg.arr);
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
			}
      else
      {
        fn_errlog( c_ServiceName, "S31270", FMLMSG, c_err_msg.arr  );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
			}
		}

    if ( Fadd32( ptr_fml_Obuf, FFO_NEW_EFF_RT,( char *)&d_spn_per_lot, 0 ) == -1 )
    {
      if( Ferror32 == FNOSPACE )
      {
        i_counter++;
        ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,
                            ( i_counter * MIN_FML_BUF_LEN * 20 ) );
        if ( ptr_fml_Obuf == NULL )
        {
          fn_errlog( c_ServiceName, "S31275", TPMSG, c_err_msg.arr );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }

        if ( Fadd32( ptr_fml_Obuf, FFO_NEW_EFF_RT,( char *)&d_spn_per_lot, 0 ) == -1 )
        {
          fn_errlog( c_ServiceName, "S31280", FMLMSG, c_err_msg.arr);
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
      else
      {
        fn_errlog( c_ServiceName, "S31285", FMLMSG, c_err_msg.arr  );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }
		/*** Ver 4.7 ends ***/

    if ( Fadd32( ptr_fml_Obuf, FFO_EFF_CLS_PRC,( char *)&d_fmm_sltp_prcnt, 0 ) == -1 )
    {
      if( Ferror32 == FNOSPACE )
      {
        i_counter++;
        ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,
                            ( i_counter * MIN_FML_BUF_LEN * 20 ) );
        if ( ptr_fml_Obuf == NULL )
        {
          fn_errlog( c_ServiceName, "S31290", TPMSG, c_err_msg.arr );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }

        if ( Fadd32( ptr_fml_Obuf, FFO_EFF_CLS_PRC,( char *)&d_fmm_sltp_prcnt, 0 ) ==
               -1 )
        {
          fn_errlog( c_ServiceName, "S31295", FMLMSG, c_err_msg.arr);
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
      else
      {
        fn_errlog( c_ServiceName, "S31300", FMLMSG, c_err_msg.arr  );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }
    if ( Fadd32( ptr_fml_Obuf, FFO_EFF_LTP,( char *)&d_fmm_sltp_sebi, 0 ) == -1 )
    {
      if( Ferror32 == FNOSPACE )
      {
        i_counter++;
        ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,
                            ( i_counter * MIN_FML_BUF_LEN * 20 ) );
        if ( ptr_fml_Obuf == NULL )
        {
          fn_errlog( c_ServiceName, "S31305", TPMSG, c_err_msg.arr );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }

        if ( Fadd32( ptr_fml_Obuf, FFO_EFF_LTP,( char *)&d_fmm_sltp_sebi, 0 ) ==
               -1 )
        {
          fn_errlog( c_ServiceName, "S31310", FMLMSG, c_err_msg.arr);
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
      else
      {
        fn_errlog( c_ServiceName, "S31315", FMLMSG, c_err_msg.arr  );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }


 if ( Fadd32( ptr_fml_Obuf, FFO_PLG_ORD_VAL,( char *)&d_fmm_sltp_diff, 0 ) == -1 )
    {
      if( Ferror32 == FNOSPACE )
      {
        i_counter++;
        ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,
                            ( i_counter * MIN_FML_BUF_LEN * 20 ) );
        if ( ptr_fml_Obuf == NULL )
        {
          fn_errlog( c_ServiceName, "S31320", TPMSG, c_err_msg.arr );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }

        if ( Fadd32( ptr_fml_Obuf, FFO_PLG_ORD_VAL,( char *)&d_fmm_sltp_diff, 0 ) ==
               -1 )
        {
          fn_errlog( c_ServiceName, "S31325", FMLMSG, c_err_msg.arr);
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
      else
      {
        fn_errlog( c_ServiceName, "S31330", FMLMSG, c_err_msg.arr  );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }

  }
  /*** ver 4.6 ends *************/

    if ( Fadd32( ptr_fml_Obuf, FFO_INTRST_RT, ( char *)&d_cvr_sltp_diff, 0 ) == -1 )
    {
      if( Ferror32 == FNOSPACE )
      {
        i_counter++;
        ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,
                            ( i_counter * MIN_FML_BUF_LEN * 20 ) );
        if ( ptr_fml_Obuf == NULL )
        {
          fn_errlog( c_ServiceName, "S31335", TPMSG, c_err_msg.arr ); 
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }

        if ( Fadd32( ptr_fml_Obuf, FFO_INTRST_RT, ( char *)&d_cvr_sltp_diff, 0 ) ==
               -1 )
        {
          fn_errlog( c_ServiceName, "S31340", FMLMSG, c_err_msg.arr  );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
      else
      {
        fn_errlog( c_ServiceName, "S31345", FMLMSG, c_err_msg.arr  ); 
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }

/****************Ver 3.2 End**************************************************/

/************** ver 4.3 starts **************/
    if( d_span_per_lot != 0 )
    {
        d_span_per_lot=d_span_per_lot/100;
    }

    if ( Fadd32( ptr_fml_Obuf, FFO_C_ADD_MRGN_VAL, ( char *)&d_span_per_lot, 0 ) == -1 )
    {
      if( Ferror32 == FNOSPACE )
      {
        i_counter++;
        ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,
                            ( i_counter * MIN_FML_BUF_LEN * 20 ) );
        if ( ptr_fml_Obuf == NULL )
        {
          fn_errlog( c_ServiceName, "S31350", TPMSG, c_err_msg.arr );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }

        if ( Fadd32( ptr_fml_Obuf, FFO_C_ADD_MRGN_VAL, ( char *)&d_span_per_lot, 0 ) ==
               -1 )
        {
          fn_errlog( c_ServiceName, "S31355", FMLMSG, c_err_msg.arr  );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
      else
      {
        fn_errlog( c_ServiceName, "S31360", FMLMSG, c_err_msg.arr  );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }
 /********* ver 4.3 ends *************/
 
   /** ver 4.4 starts **/
    if ( Fadd32( ptr_fml_Obuf, FFO_UPLD_MTCH_FLG, ( char *)&c_oth_otm_flg, 0 ) == -1 )
    {
      if( Ferror32 == FNOSPACE )
      {
        i_counter++;
        ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,
                            ( i_counter * MIN_FML_BUF_LEN * 20 ) );
        if ( ptr_fml_Obuf == NULL )
        {
          fn_errlog( c_ServiceName, "S31365", TPMSG, c_err_msg.arr );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }

        if ( Fadd32( ptr_fml_Obuf, FFO_UPLD_MTCH_FLG, ( char *)&c_oth_otm_flg, 0 ) ==
               -1 )
        {
          fn_errlog( c_ServiceName, "S31370", FMLMSG, c_err_msg.arr  );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
      else
      {
        fn_errlog( c_ServiceName, "S31375", FMLMSG, c_err_msg.arr  );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    } 
 
   /** ver 4.4 ends **/

/*****************************************************************************/
	/*** Commented in Ver 2.7 ***	if ( Fadd32( ptr_fml_Obuf, FFO_LST_TRD_PRC, 
                             ( char *)&st_cntrct_qt.l_lst_trdd_prc, 0 ) == -1 ) ***/
    if ( Fadd32( ptr_fml_Obuf, FFO_LST_TRD_PRC,( char *)&l_lst_trdd_prc, 0 ) == -1 ) /*** Ver 2.7 ***/
		{
			if( Ferror32 == FNOSPACE )
			{
        i_counter++;
        ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,
                            ( i_counter * MIN_FML_BUF_LEN * 20 ) );		/***  Ver 3.1 Bufferlength Multiplied by 20 ***/
				if ( ptr_fml_Obuf == NULL )
				{
					fn_errlog( c_ServiceName, "S31380", TPMSG, c_err_msg.arr  ); 
  				EXEC SQL CLOSE :sys_cursor;
  				EXEC SQL FREE :sys_cursor;
					tpfree ( ( char * ) ptr_o_st_cntrct );
					tpfree ( ( char * ) ptr_fml_Obuf );
					Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );  
					tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
				}
    /***** Commented in Ver 2.7 ******
				if ( Fadd32( ptr_fml_Obuf, FFO_LST_TRD_PRC, 
                     ( char *)&st_cntrct_qt.l_lst_trdd_prc, 0 ) == 
               -1 ) ***** Ver 2.7 Comment Ends *****/
        if ( Fadd32( ptr_fml_Obuf, FFO_LST_TRD_PRC, ( char *)&l_lst_trdd_prc, 0 ) == -1 ) /*** Ver 2.7 ***/
				{
					fn_errlog( c_ServiceName, "S31385", FMLMSG, c_err_msg.arr  );
  				EXEC SQL CLOSE :sys_cursor;
  				EXEC SQL FREE :sys_cursor;
					tpfree ( ( char * ) ptr_o_st_cntrct );
					tpfree ( ( char * ) ptr_fml_Obuf );
					Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
					tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
				}
			}
			else
			{
				fn_errlog( c_ServiceName, "S31390", FMLMSG, c_err_msg.arr  ); 
  			EXEC SQL CLOSE :sys_cursor;
  			EXEC SQL FREE :sys_cursor;
				tpfree ( ( char * ) ptr_o_st_cntrct );
				tpfree ( ( char * ) ptr_fml_Obuf );
				Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
				tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );	
			}
		}

    /*** Added in Ver 3.1 ***/

    if ( Fadd32( ptr_fml_Obuf, FFO_LST_TRD_TM,( char *)&(c_lst_trdd_time), 0 ) == -1 )
    {
      if( Ferror32 == FNOSPACE )
      {
        i_counter++;
        ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,
                            ( i_counter * MIN_FML_BUF_LEN * 20 ) );			/***  Ver 3.1 Bufferlength Multiplied by 20 ***/
        if ( ptr_fml_Obuf == NULL )
        {
          fn_errlog( c_ServiceName, "S31395", TPMSG, c_err_msg.arr  );  
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }

      if ( Fadd32( ptr_fml_Obuf, FFO_LST_TRD_TM, ( char *)&(c_lst_trdd_time), 0 ) == -1 )
        {
          fn_errlog( c_ServiceName, "S31400", FMLMSG, c_err_msg.arr  ); 
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
      else
      {
        fn_errlog( c_ServiceName, "S31405", FMLMSG, c_err_msg.arr  ); 
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }
 
      /** Added in Ver 2.8 Starts **/
 if(c_product_type == 'U' || c_product_type == 'I' || c_product_type == 'F' || c_product_type == 'P')		/*** Product type "I" added in Ver 3.0 ***/ /*** Fut & FutPls added in Ver 3.6 ***/
  {	
		if(DEBUG_MSG_LVL_3)	/*** Debug level added in Ver 4.1 ***/
		{
			fn_userlog(c_ServiceName, "Limit Allowed Flag SLTP F+ is :%c:",c_allwd_flg);	
		}
		if ( Fadd32( ptr_fml_Obuf, FFO_DLVRY_ALLWD, ( char *)&c_allwd_flg, 0 ) == -1 )
  	{
			/*** Ver 4.1 starts ***/
			if( Ferror32 == FNOSPACE )
      {
        i_counter++;
        ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,( i_counter * MIN_FML_BUF_LEN * 20 ) );	
        if ( ptr_fml_Obuf == NULL )
        {
          fn_errlog( c_ServiceName, "S31410", TPMSG, c_err_msg.arr  );  
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }

      if ( Fadd32( ptr_fml_Obuf, FFO_DLVRY_ALLWD, ( char *)&c_allwd_flg, 0 ) == -1 )
        {
          fn_errlog( c_ServiceName, "S31415", FMLMSG, c_err_msg.arr  ); 
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
      else
			{
			/*** Ver 4.1 ends ***/
    	fn_errlog( c_ServiceName, "S31420", FMLMSG, c_err_msg.arr  ); 
    	EXEC SQL CLOSE :sys_cursor;
    	EXEC SQL FREE :sys_cursor;
    	tpfree ( ( char * ) ptr_o_st_cntrct );
    	tpfree ( ( char * ) ptr_fml_Obuf );
    	Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
    	tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
			} /*** Ver 4.1 bracket closed ***/
  	}
	}
  /** Added in Ver 2.8 Ends **/
/*****************************************************************************/
	/*** Ver 3.8 Starts ***/
    if ( c_setlmnt_flg_tmp == 'P' )
    {
      c_setlmnt_flg = 'Y';
    }
    else
    {
      c_setlmnt_flg = 'N';
    }

		if ( Fadd32( ptr_fml_Obuf, FFO_BK_UBK_FLG,( char *)&(c_setlmnt_flg), 0 ) == -1 )
		{
			if( Ferror32 == FNOSPACE )
      {
        i_counter++;
        ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,
                            ( i_counter * MIN_FML_BUF_LEN * 20 ) );
        if ( ptr_fml_Obuf == NULL )
        {
          fn_errlog( c_ServiceName, "S31425", TPMSG, c_err_msg.arr  );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }

      	if ( Fadd32( ptr_fml_Obuf, FFO_BK_UBK_FLG, ( char *)&(c_setlmnt_flg), 0 ) == -1 )
        {
          fn_errlog( c_ServiceName, "S31430", FMLMSG, c_err_msg.arr  );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
      else
      {
        fn_errlog( c_ServiceName, "S31435", FMLMSG, c_err_msg.arr  );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
		}
	/*** Ver 3.8 Ends ***/
	/**** Ver 4.8 Start ****/
	if(st_i_cntrct.c_rqst_typ == FOR_QUOTES_ORDERS || st_i_cntrct.c_rqst_typ ==FROM_UNDERLYING)
	{

		if(DEBUG_MSG_LVL_4) /* Added in 5.3 */
		{
     fn_userlog( c_ServiceName, "Inside %c to setup ialert ",st_i_cntrct.c_rqst_typ);
		}

		i_err[0] = Fadd32 ( ptr_fml_Obuf, FFO_CLSR_TYP, (char *)&c_err_flag,0);
		i_ferr[0]=Ferror32;
		i_err[1] = Fadd32 ( ptr_fml_Obuf, FFO_STLMNT_TYP, (char *)&c_err_type,0);
		i_ferr[1]=Ferror32;
		i_err[2] = Fadd32 ( ptr_fml_Obuf, FFO_REMARKS, (char *)c_alert_msg.arr,0);
		i_ferr[2]=Ferror32;
		i_err[3] = Fadd32 ( ptr_fml_Obuf, FFO_SYS_MSG, (char *)c_msg,0);
		i_ferr[3]=Ferror32;
		for( i_cnt = 0; i_cnt < 4; i_cnt++ )	/* Changed from 3 to 4 in ver 5.2 */
		{
			if(i_ferr[i_cnt] == FNOSPACE)
			{
        i_counter++;
        ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,( i_counter * MIN_FML_BUF_LEN * 20 ) );
        if ( ptr_fml_Obuf == NULL )
        {
          fn_errlog( c_ServiceName, "S31440", TPMSG, c_err_msg.arr  );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }

				/* i_cnt number changed in Ver 5.2 */
				if (i_cnt==0)
      	i_err[4]=Fadd32( ptr_fml_Obuf, FFO_CLSR_TYP, ( char *)&c_err_flag, 0 );
				else if(i_cnt==1)
      	i_err[4]=Fadd32( ptr_fml_Obuf, FFO_STLMNT_TYP, ( char *)&c_err_type, 0 );
				else if(i_cnt==2)
      	i_err[4]=Fadd32( ptr_fml_Obuf, FFO_REMARKS, ( char *)c_alert_msg.arr, 0 );
				else if(i_cnt==3)			/* Added in ver 5.2 */
      	i_err[4]=Fadd32( ptr_fml_Obuf, FFO_SYS_MSG, ( char *)c_msg, 0 );	/* Added in ver 5.2 */

				if(i_err[4] == -1)
        {
          fn_errlog( c_ServiceName, "S31445", FMLMSG, c_err_msg.arr  );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }

			}
			else if( i_err[i_cnt] == -1 )
			{
				fn_errlog( c_ServiceName, "S31450", SQLMSG, c_err_msg.arr  );
				EXEC SQL CLOSE :sys_cursor;
				EXEC SQL FREE :sys_cursor;
				free((char *) ptr_o_st_cntrct);
				tpfree ( ( char * ) ptr_fml_Obuf );
				Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
				tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
			}  
  	}
	}	
  }
}		/**Ver 1.8 **/

  /*** Add start for Ver 4.2 ***/
  if( st_i_cntrct.c_rqst_typ == GET_CNT_R_SPD_CNTRCT)
  {
    if(DEBUG_MSG_LVL_3)
    {
      fn_userlog( c_ServiceName, "Inside GET_CNT_R_SPD_CNTRCT Fetch case");
    }
    for(;;)
    {
      if(DEBUG_MSG_LVL_3)
      {
        fn_userlog( c_ServiceName, "Inside GET_CNT_R_SPD_CNTRCT for case of Fetch");
      }

      EXEC SQL FETCH :sys_cursor
               INTO :c_s_exp_dt1,
                    :c_s_exp_dt2,
                    :l_lot_sz;
      if ( SQLCODE != 0 )
      {
        if ( SQLCODE == NO_DATA_FOUND )
        {
          if(st_i_cntrct.c_rqst_typ == GET_CNT_R_SPD_CNTRCT && i_rec_count == 0 )
          {
            fn_errlog ( c_ServiceName, "B21000", DEFMSG, c_err_msg.arr );
            EXEC SQL CLOSE :sys_cursor;
            EXEC SQL FREE :sys_cursor;
            tpfree ( ( char * ) ptr_o_st_cntrct );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
          }
          break;
          fn_errlog( c_ServiceName, "S31455", SQLMSG, c_err_msg.arr  );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
      i_rec_count = i_rec_count +1;
      SETNULL ( c_s_exp_dt1 );
      SETNULL ( c_s_exp_dt2 );
      if ( Fadd32( ptr_fml_Obuf, FFO_EXPRY_DT, c_s_exp_dt1.arr, 0 ) == -1 )
      {
        fn_errlog( c_ServiceName, "S31460", FMLMSG, c_err_msg.arr  );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
      if ( Fadd32( ptr_fml_Obuf, FFO_TO_DT, c_s_exp_dt2.arr, 0 ) == -1 )
      {
        fn_errlog( c_ServiceName, "S31465", FMLMSG, c_err_msg.arr  );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
      if ( Fadd32( ptr_fml_Obuf, FFO_MIN_LOT_QTY, ( char *)&l_lot_sz, 0 ) == -1 )
      {
        fn_errlog( c_ServiceName, "S31470", FMLMSG, c_err_msg.arr  );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_o_st_cntrct );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }
  }
  /*** Add Ends for Ver 4.2 ***/

/** Ver 1.8 starts **/
if(st_i_cntrct.c_rqst_typ == ALL_CNTRCTS)
{
 if(DEBUG_MSG_LVL_3)
    {
			fn_userlog( c_ServiceName, "Inside Version 1.8 for ALL_CNTRCTS case");
		}
    c_prdct_flg ='O';  /** Ver 3.7 **/
 /*** Commented in Ver 2.7 ***
	EXEC SQL EXECUTE
				BEGIN
						OPEN :sys_cursor FOR
							** SELECT  distinct to_char(fcm_expry_dt,'DD-Mon-YYYY'), Ver 1.9 **
							SELECT  distinct fcm_expry_dt,                          *** Ver 1.9 ***
											fcm_lot_sz                                      *** Ver 1.9 ***
							FROM    fcm_fo_cntrct_mstr
							WHERE   fcm_xchng_cd  = :c_exchange_code
							AND     fcm_undrlyng  = :c_underlying
							AND     fcm_qt_trdng_flg ='T' 
							ORDER BY fcm_expry_dt ;        *** Ver 1.9 ***
				END;
	  		END-EXEC;
  *** Ver 2.7 Comment Ends ***/
  /*** Ver 2.7 Starts ***/
  EXEC SQL EXECUTE
        BEGIN
            OPEN :sys_cursor FOR
          SELECT DISTINCT FTQ_EXPRY_DT,
                 FTQ_MIN_LOT_QTY
            FROM FTQ_FO_TRD_QT
           WHERE FTQ_XCHNG_CD = :c_exchange_code
            AND  FTQ_UNDRLYNG = :c_underlying
            AND  FTQ_QT_TRDNG_FLG = :c_qt_trdng_flg  /** Ver 3.7 **/ 
        ORDER BY FTQ_EXPRY_DT ; 
            END;
       END-EXEC; 
  /*** Ver 2.7 Ends   ***/
			 if (SQLCODE != 0) 
				{
					fn_errlog( c_ServiceName, "S31475", SQLMSG, c_err_msg.arr  ); 
					EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_fml_Obuf );   /*** Added in Ver VQC**/
					tpfree ( ( char * ) ptr_o_st_cntrct );
					Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );  
					tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
				}
			for(;;)
			{
				EXEC SQL FETCH :sys_cursor
								 INTO :c_expiry_dt,
										  :l_lot_sz;
				if ( SQLCODE != 0 )
				{
					if ( SQLCODE == NO_DATA_FOUND )
					{
           /*** Ver 2.1 starts **/

            if(st_i_cntrct.c_rqst_typ == ALL_CNTRCTS && i_rec_count == 0 )
            {
              fn_errlog ( c_ServiceName, "B21000", DEFMSG, c_err_msg.arr ); 
              EXEC SQL CLOSE :sys_cursor;
              EXEC SQL FREE :sys_cursor;
              tpfree ( ( char * ) ptr_o_st_cntrct );
              tpfree ( ( char * ) ptr_fml_Obuf );
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );  
              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
            }

            /*** Ver 2.1 Ends **/
						break;
					}
					fn_errlog( c_ServiceName, "S31480", SQLMSG, c_err_msg.arr  );
					EXEC SQL CLOSE :sys_cursor;
					EXEC SQL FREE :sys_cursor;
					tpfree ( ( char * ) ptr_o_st_cntrct );
					tpfree ( ( char * ) ptr_fml_Obuf );
					Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );  
					tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
				}
        i_rec_count = i_rec_count +1;           /*** Ver 2.1 ***/

				SETNULL ( c_expiry_dt );
				Fadd32( ptr_fml_Obuf, FFO_EXPRY_DT, c_expiry_dt.arr, 0 );

				 if ( Fadd32( ptr_fml_Obuf, FFO_MIN_LOT_QTY, ( char *)&l_lot_sz, 0 ) == -1 )   /*** Ver 1.9 ***/
        {
          fn_errlog( c_ServiceName, "S31485", FMLMSG, c_err_msg.arr  );  
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_o_st_cntrct );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }


			}
  /*** Ver 2.7 Comment Starts ***
	EXEC SQL EXECUTE
				BEGIN
						OPEN :sys_cursor FOR
							SELECT  distinct fcm_strk_prc
							FROM    fcm_fo_cntrct_mstr
							WHERE   fcm_xchng_cd  = :c_exchange_code
							AND     fcm_undrlyng  = :c_underlying
							AND     fcm_prdct_typ ='O'
							AND     fcm_qt_trdng_flg = 'T'
							ORDER BY fcm_strk_prc;        *** Ver 1.9 ***
				END;
	  		END-EXEC;
  *** Ver 2.7 Comment Ends ***/
  /*** Ver 2.7 Starts ***/
        EXEC SQL EXECUTE
           BEGIN
            OPEN :sys_cursor FOR
          SELECT DISTINCT FTQ_STRK_PRC
            FROM FTQ_FO_TRD_QT
           WHERE FTQ_XCHNG_CD = :c_exchange_code
             AND FTQ_UNDRLYNG = :c_underlying
             AND FTQ_PRDCT_TYP = :c_prdct_flg  /** Ver 3.7 **/
             AND FTQ_QT_TRDNG_FLG = :c_qt_trdng_flg  /** Ver 3.7 **/ 
        ORDER BY FTQ_STRK_PRC;
            END;
       END-EXEC;   

  /*** Ver 2.7 Ends   ***/
			 if (SQLCODE != 0) 
				{
					fn_errlog( c_ServiceName, "S31490", SQLMSG, c_err_msg.arr  );  
					EXEC SQL CLOSE :sys_cursor;
					EXEC SQL FREE :sys_cursor;
					tpfree ( ( char * ) ptr_fml_Obuf );
					tpfree ( ( char * ) ptr_o_st_cntrct );
					Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
					tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
				}
			for(;;)
			{
				EXEC SQL FETCH :sys_cursor
								 INTO :l_strike_prc;
				if ( SQLCODE != 0 )
				{
					if ( SQLCODE == NO_DATA_FOUND )
					{
            /*** Ver 2.1 starts **/

            if(st_i_cntrct.c_rqst_typ == ALL_CNTRCTS && i_rec_count == 0 )
            {
              fn_errlog ( c_ServiceName, "B21000", DEFMSG, c_err_msg.arr ); 

              EXEC SQL CLOSE :sys_cursor;
              EXEC SQL FREE :sys_cursor;
              tpfree ( ( char * ) ptr_o_st_cntrct );
              tpfree ( ( char * ) ptr_fml_Obuf );
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
            }

            /*** Ver 2.1 Ends **/
						break;
					}
					fn_errlog( c_ServiceName, "S31495", SQLMSG, c_err_msg.arr );  
					EXEC SQL CLOSE :sys_cursor;
					EXEC SQL FREE :sys_cursor;
					tpfree ( ( char * ) ptr_o_st_cntrct );
					tpfree ( ( char * ) ptr_fml_Obuf );
					Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );  
					tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
				}
        i_rec_count = i_rec_count +1;           /*** Ver 2.1 ***/

				Fadd32( ptr_fml_Obuf, FFO_STRK_PRC, (char*)&l_strike_prc, 0 );
			}
		/*** Ver 4.1 Starts ***/

		EXEC SQL
    SELECT NVL(FUM_SLTPFP_LMT_ALLWD_FLG,'N')
    INTO  :c_allwd_flg
    FROM  FUM_FO_UNDRLYNG_MSTR
    WHERE FUM_XCHNG_CD    = :c_exchange_code
    AND   FUM_UNDRLYNG    = :c_underlying
    AND   FUM_PRDCT_TYP   = :c_prdct_flg;

		if (SQLCODE != 0)
    {
      fn_errlog( c_ServiceName, "S31500", SQLMSG, c_err_msg.arr  );
      EXEC SQL CLOSE :sys_cursor;
      EXEC SQL FREE :sys_cursor;
      tpfree ( ( char * ) ptr_fml_Obuf );
      tpfree ( ( char * ) ptr_o_st_cntrct );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

		if(DEBUG_MSG_LVL_4) /*** Ver 4.1 ***/	/** Changes debug from 0 to 4  in ver 5.3 **/
	  {
			fn_userlog(c_ServiceName,"FUM_SLTPFP_LMT_ALLWD_FLG in Request type ALL_CNTRCTS :%c:",c_allwd_flg);
		}
		if ( Fadd32( ptr_fml_Obuf, FFO_DLVRY_ALLWD, ( char *)&c_allwd_flg, 0 ) == -1 )
    {
      fn_errlog( c_ServiceName, "S31505", FMLMSG, c_err_msg.arr  );
      EXEC SQL CLOSE :sys_cursor;
      EXEC SQL FREE :sys_cursor;
      tpfree ( ( char * ) ptr_o_st_cntrct );
      tpfree ( ( char * ) ptr_fml_Obuf );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

		/*** Ver 4.1 Ends ***/

}
/**Ver 1.8 ends **/

	/***  Ver 2.3 Starts  ***/

	/*** Ver 4.0 Comment Starts ***
	if(DEBUG_MSG_LVL_3)
  {
		fn_userlog(c_ServiceName," Input Exchange Code Is :%s:",c_exchange_code); 
  	fn_userlog(c_ServiceName," Input Exchange Underlying Is :%s:",c_underlying); 
	}

  if ( strcmp(c_exchange_code,"NFO") == 0 )
  {
    strcpy( c_xchng_cd ,"NSE");
  }
  else if ( strcmp(c_exchange_code,"BFO") == 0 )
  {
    strcpy( c_xchng_cd ,"BSE");
  }
	*** Ver 4.0 Comment Ends ***/


	i_buf_len = sizeof(d_spot_prc) + 512;

	/*** Ver 4.0 Comment Starts (Query Moved Above) ***
  EXEC SQL
    SELECT  NVL(LTQ_RT,0.0)
    INTO    :d_spot_prc
    FROM    LTQ_TRD_QT
    WHERE   LTQ_XCHNG_CD  = :c_xchng_cd
    AND     LTQ_STCK_CD   = :c_underlying;

  if ( SQLCODE  !=  0 && SQLCODE	!= NO_DATA_FOUND)
  {
    fn_errlog( c_ServiceName, "S31510", SQLMSG, c_err_msg.arr  );  
    EXEC SQL CLOSE :sys_cursor;
    EXEC SQL FREE :sys_cursor;
    tpfree ( ( char * ) ptr_o_st_cntrct );
    tpfree ( ( char * ) ptr_fml_Obuf );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 ); 
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
	if( SQLCODE == NO_DATA_FOUND)
	{
		fn_errlog( c_ServiceName, "B21000"," " , c_err_msg.arr );  
    EXEC SQL CLOSE :sys_cursor;
    EXEC SQL FREE :sys_cursor;
    tpfree ( ( char * ) ptr_o_st_cntrct );
    tpfree ( ( char * ) ptr_fml_Obuf );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );  
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
	}

	**** Added in ver 2.6 ***

	if (strcmp(c_underlying,"INDVIX") == 0)
	{
		d_spot_prc = d_spot_prc/100;
	}

	**** End of ver 2.6 ***

	 *** Ver 4.0 Comment Ends ***/
	
	
	if(Fneeded32(1,i_buf_len) > Funused32(ptr_fml_Obuf))
  {
  	ptr_fml_Obuf = (FBFR32 *)tprealloc((char *)ptr_fml_Obuf,
                                      (Fsizeof32(ptr_fml_Obuf) + MIN_FML_BUF_LEN));
    if(ptr_fml_Obuf == NULL)
    {
    	fn_errlog(c_ServiceName,"S31515",TPMSG,c_err_msg.arr);  
			EXEC SQL CLOSE :sys_cursor;
    	EXEC SQL FREE :sys_cursor;
    	tpfree ( ( char * ) ptr_o_st_cntrct );
    	tpfree ( ( char * ) ptr_fml_Obuf );
      Fadd32( ptr_fml_Ibuf,FFO_ERR_MSG, c_err_msg.arr, 0 );  
      tpreturn(TPFAIL, 0L, (char *)ptr_fml_Ibuf, 0L, 0);
    }
  }

  if ( Fadd32( ptr_fml_Obuf,FFO_STCK_PRICE, ( char *)&d_spot_prc, 0 ) == -1 )
  {

    fn_errlog( c_ServiceName, "S31520", FMLMSG, c_err_msg.arr  ); 
    EXEC SQL CLOSE :sys_cursor;
    EXEC SQL FREE :sys_cursor;
    tpfree ( ( char * ) ptr_o_st_cntrct );
    tpfree ( ( char * ) ptr_fml_Obuf );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg.arr, 0 );
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

	if(DEBUG_MSG_LVL_3)
  {
  	fn_userlog(c_ServiceName,"Spot Price for Underlying %s Is :%lf:",c_underlying,d_spot_prc);
	}
  /***  Ver 2.3 Ends    ***/

  EXEC SQL CLOSE :sys_cursor;
  EXEC SQL FREE :sys_cursor;
	tpfree ( ( char * ) ptr_o_st_cntrct );
	tpreturn( TPSUCCESS, 0, (char *)ptr_fml_Obuf, 0 , 0 );
}

/**Function added in Ver 1.6 **/
int fn_call_get_qt(char *c_ServiceName,
									 struct vw_contract *ptr_st_contract,
									 struct vw_cntrct_qt *ptr_st_cntrct_qt,
									 char *c_err_msg
									)
{

  char  c_errmsg[256];

  EXEC SQL BEGIN DECLARE SECTION;
    varchar c_expiry_dt [ LEN_DATE ];
    varchar c_exp_dt [ LEN_DATE ];
    varchar c_lst_trd_dt [ LEN_DATE ];
    short i_trd_tm;
  EXEC SQL END DECLARE SECTION;

  rtrim ( ptr_st_contract->c_expry_dt );
  strcpy ( ( char * )c_expiry_dt.arr, ptr_st_contract->c_expry_dt );
  SETLEN ( c_expiry_dt );
 if(DEBUG_MSG_LVL_3)
    {
			fn_userlog( c_ServiceName, " INSIDE function fn_call_get_qt");
			fn_userlog( c_ServiceName, "c_xchng_cd=%s", ptr_st_contract->c_xchng_cd );
  		fn_userlog( c_ServiceName, "c_prd_typ=%c", ptr_st_contract->c_prd_typ);
  		fn_userlog( c_ServiceName, "c_undrlyng=%s",ptr_st_contract->c_undrlyng );
  		fn_userlog( c_ServiceName, "c_expry_dt=%s", c_expiry_dt.arr );
  		fn_userlog( c_ServiceName, "c_exrc_typ=%c", ptr_st_contract->c_exrc_typ);
  		fn_userlog( c_ServiceName, "c_opt_typ=%c", ptr_st_contract->c_opt_typ );
  		fn_userlog( c_ServiceName, "l_strike_prc=%ld",ptr_st_contract->l_strike_prc );
		}

EXEC SQL
      SELECT   FTQ_XCHNG_CD,
                FTQ_PRDCT_TYP,
                FTQ_INDSTK,
                TO_CHAR (FTQ_EXPRY_DT, 'dd-Mon-yyyy' ),
                FTQ_EXER_TYP,
                FTQ_OPT_TYP,
                NVL( FTQ_STRK_PRC, 0 ),
                FTQ_INDSTK,
                NVL(  FTQ_LST_TRD_PRC, 0 ),
                TO_CHAR ( FTQ_LST_TRD_TM, 'dd-Mon-yyyy hh24:mi:ss' ),
                NVL( FTQ_LST_TRD_QTY, 0 ),
                NVL( FTQ_BST1_BID_PRC, 0 ),
                NVL( FTQ_BST1_BID_QTY, 0 ),
                NVL( FTQ_BST1_OFFR_PRC, 0 ),
                NVL( FTQ_BST1_OFFR_QTY, 0 ),
                NVL( FTQ_CLS_PRC, 0 ),
                NVL( FTQ_OPN_PRC, 0 ),
                NVL( FTQ_HGH_PRC, 0 ),
                NVL( FTQ_LOW_PRC, 0 ),
                NVL( FTQ_PRVS_CLS_PRC, 0 ),
                NVL( FTQ_CHNG_PRVS_CLS, 0 ),
                NVL( FTQ_INDCTR,'+'),
                NVL( FTQ_HGH_PRC_RNG, 0 ),
                NVL( FTQ_LOW_PRC_RNG, 0 ),
                NVL( FTQ_AVRG_TRD_PRC, 0 ),
                NVL( FTQ_TOT_QTY_TRDD, 0 ),
                NVL( FTQ_TOT_VAL_TRDD, 0 ),
                NVL( FTQ_BASE_PRC, 0 ),
                NVL( FTQ_CRNT_OI, 0 ),
                NVL( FTQ_CHNG_OI, 0 ),
                NVL( FTQ_OI_HIGH, 0 ),
                NVL( FTQ_OI_LOW, 0 ),
                NVL( FTQ_OI_INDCTR,'+' ),
                '*',
                NVL(  FTQ_MIN_LOT_QTY,'0') /* Ver 1.3 */
      INTO      :ptr_st_cntrct_qt->c_xchng_cd,
                :ptr_st_cntrct_qt->c_prd_typ,
                :ptr_st_cntrct_qt->c_undrlyng,
                :c_exp_dt,
                :ptr_st_cntrct_qt->c_exrc_typ,
                :ptr_st_cntrct_qt->c_opt_typ,
                :ptr_st_cntrct_qt->l_strike_prc,
                :ptr_st_cntrct_qt->c_ctgry_indstk,
                :ptr_st_cntrct_qt->l_lst_trdd_prc,
                :c_lst_trd_dt:i_trd_tm,
                :ptr_st_cntrct_qt->l_lst_trdd_qty,
                :ptr_st_cntrct_qt->l_bst_bid_prc,
                :ptr_st_cntrct_qt->l_bst_bid_qty,
                :ptr_st_cntrct_qt->l_bst_offr_prc,
                :ptr_st_cntrct_qt->l_bst_offr_qty,
                :ptr_st_cntrct_qt->l_close_prc,
                :ptr_st_cntrct_qt->l_open_prc,
                :ptr_st_cntrct_qt->l_high_prc,
                :ptr_st_cntrct_qt->l_low_prc,
                :ptr_st_cntrct_qt->l_prev_close_prc,
                :ptr_st_cntrct_qt->l_chng_prvs_close_prc,
                :ptr_st_cntrct_qt->c_indctr,
                :ptr_st_cntrct_qt->l_high_prc_rng,
                :ptr_st_cntrct_qt->l_low_prc_rng,
                :ptr_st_cntrct_qt->l_avg_trdd_prc,
                :ptr_st_cntrct_qt->l_tot_qty_trdd,
                /** :ptr_st_cntrct_qt->l_tot_val_trdd, ** Ver 2.5 **/
                :ptr_st_cntrct_qt->d_tot_val_trdd,   /** ver 2.5 **/
                :ptr_st_cntrct_qt->l_base_prc,
                :ptr_st_cntrct_qt->d_crnt_oi,
                :ptr_st_cntrct_qt->d_chng_oi,
                :ptr_st_cntrct_qt->d_oi_high,
                :ptr_st_cntrct_qt->d_oi_low,
                :ptr_st_cntrct_qt->c_oi_indctr,
                :ptr_st_cntrct_qt->c_rqst_typ,
                :ptr_st_cntrct_qt->l_min_lot_qty  /* Ver 1.3 */
      FROM      FTQ_FO_TRD_QT 
     WHERE      FTQ_XCHNG_CD   = :ptr_st_contract->c_xchng_cd
       AND      FTQ_PRDCT_TYP  = DECODE (:ptr_st_contract->c_prd_typ,'P','F',:ptr_st_contract->c_prd_typ) /*Ver 1.2*/
       AND      FTQ_UNDRLYNG  = :ptr_st_contract->c_undrlyng
       AND      FTQ_EXPRY_DT  = TO_DATE ( :c_expiry_dt,'dd-Mon-yyyy' )
       AND      FTQ_EXER_TYP   = :ptr_st_contract->c_exrc_typ
       AND      FTQ_OPT_TYP    = :ptr_st_contract->c_opt_typ
       AND      FTQ_STRK_PRC   = :ptr_st_contract->l_strike_prc;
  if ( SQLCODE != 0 && SQLCODE != NO_DATA_FOUND )
  {
    fn_userlog( c_ServiceName, "SQLCODE != 0 && SQLCODE != NO_DATA_FOUND");
		fn_errlog( c_ServiceName, "S31525", SQLMSG, c_err_msg);
		return -1;
  }
  else if ( SQLCODE == NO_DATA_FOUND )
  {
		return -2;
  }

  SETNULL ( c_exp_dt );
  SETNULL ( c_lst_trd_dt );

  strcpy ( ptr_st_cntrct_qt->c_expry_dt , ( char * ) c_exp_dt.arr );
  strcpy ( ptr_st_cntrct_qt->c_lst_trdd_time , ( char * ) c_lst_trd_dt.arr );

	return 0;
}

/**** Ver VQC**

void fn_gettime()
{
  int i_mili_sec = 0;
  struct timeval tv;
  struct timezone tz;
  struct tm *tm;

  gettimeofday(&tv, &tz);
  tm=localtime(&tv.tv_sec);
  i_mili_sec= tv.tv_usec/1000;
  sprintf(c_time,"%d:%d:%d:%d",tm->tm_hour, tm->tm_min, tm->tm_sec, i_mili_sec);
	fn_userlog("Time:%s:",c_time);
  return;
}
****/
