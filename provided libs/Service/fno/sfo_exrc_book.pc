/******************************************************************************/
/*  Program           : SFO_EXRC_BOOK                                         */
/*                                                                            */
/*  Input             : FFO_PRDCT_TYP                                         */
/*                      FFO_UNDRLYNG                                          */
/*                      FFO_EXPRY_DT                                          */
/*                      FFO_EXER_TYP                                          */
/*                      FFO_OPT_TYP                                           */
/*                      FFO_STRK_PRC                                          */
/*                      FFO_EXRC_STTS                                         */
/*                      FFO_FROM_DT                                           */
/*                      FFO_TO_DT                                             */
/*                      FFO_ROUT_CRT                                          */
/*                                                                            */
/*  Output            : FFO_XCHNG_CD                                          */
/*                      FFO_PRDCT_TYP                                         */
/*                      FFO_UNDRLYNG                                          */
/*                      FFO_EXPRY_DT                                          */
/*                      FFO_EXER_TYP                                          */
/*                      FFO_OPT_TYP                                           */
/*                      FFO_STRK_PRC                                          */
/*                      FFO_ORDR_RFRNC                                        */
/*                      FFO_PIPE_ID                                           */
/*                      FFO_EX_ORDR_TYP                                       */
/*                      FFO_ORD_TOT_QTY                                       */
/*                      FFO_EXRC_STTS                                         */
/*                      FFO_TRD_DT                                            */
/*                      FFO_SETTLOR                                           */
/*                      FFO_ACK_NMBR                                          */
/*                                                                            */
/*  Description       : This service retrieves the values of the entire       */
/*                      exercise book given different input parameters        */
/*                      based on different needs. The different needs are     */
/*                      described as different operation types:               */
/*                      A - Contract as Input                                 */
/*                      B - Contract and Date as Input                        */
/*                      C - Underlying as Input                               */
/*                      D - Underlying and Date as Input                      */
/*                      E - Status and Product as Input                       */
/*                      F - Status, Product and Date as Input                 */
/*                                                                            */
/*  Log               : 1.0 09-Oct-2001 S. Swaminathan                        */
/*  Log               : 1.1 19-Jul-2002 Infotec|Sangeet                       */
/*  Log               : 1.2 20-Jan-2003 Infotec|Sonali                        */
/*  Log               : 1.3 16-Mar-2006 Infotec|Firoz                         */
/*  Log               : 1.4 22-Aug-2006 Infotec|Abhishek                      */
/*  Log               : 1.5 20-Sep-2006 Infotec|SH/AA/Vikash                  */
/*  Log               : 1.6 20-Dec-2007 Infotech|Ranjit                       */
/*  Log               : 1.7 06-Jul-2009 Infotech|Venture                      */
/*	Log								:	1.8	16-Nov-2010	Infotech|Sandeep											*/
/*  Log               : 1.9 31-Mar-2011 Infotech|Swati                        */
/*  Log								: 2.0 12-Jan-2012 Infotech|Sandip												*/
/*  Log								: 2.1 01-Sep-2014 Infotech|Samip M											*/
/*  Log								: 2.2 14-Nov-2015 Infotech|Sachin Birje     						*/
/******************************************************************************/
/*  1.0     -  New Release                                                    */
/*  1.1     -  Bp  Release                                                    */
/*  1.2     -  CR1038 To identify Super User channel as CNT                   */
/*  1.3     -  Changes for CTCL pipe id                                       */
/*  1.4     -  Changes for CTCL pipe id rectified                             */  
/*  1.5     -  DL Bulk Call changes                                           */  
/*  1.6     -  IBM Migration                                                  */
/*  1.7     -  Added brokerage to display                                     */
/*	1.8			-	 Silver Light Changes																						*/
/*  1.9     -  CRCSN44510 Derivative Restructuring (Removal of FDM_DT_MTCH )  */
/*  2.0			-  FNO BSE Changes for handling of exchange code as ALL						*/
/*  2.1			-  View to FML changes																						*/
/*  2.2			-  tpfree commected    																						*/
/******************************************************************************/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <atmi.h>
#include <fml32.h>
#include <sqlca.h>
#include <fo.h>
#include <fo_fml_def.h>
/** #include <fo_view_def.h> **/	/** Commented for Ver 2.1 **/
#include <fml_rout.h>							/** Added for Ver 2.1 **/
#include <fo_view_def.h>				/** Added for Ver 2.1 **/
#include <fn_tuxlib.h>
#include <fn_ddr.h>
#include <fn_log.h>     /** Ver 1.6 **/
#include <fn_getref.h>  /** Ver 1.6 **/
#include <fn_session.h> /** Ver 1.6 **/
#include <fn_read_debug_lvl.h>  /* ver 1.6 */

#define MAX 1
#define MIN 0



void SFO_EXRC_BOOK( TPSVCINFO *rqst )
{
  FBFR32 *ptr_fml_Ibuf;
  FBFR32 *ptr_fml_Obuf;

  ptr_fml_Obuf = (FBFR32 *)NULL;  /** Ver 2.2 **/

  char c_ServiceName[33];
  char c_errmsg[256];
  char c_option_type;
  char c_mod_can_flg = 'N';
  char c_spl_flg;             /***  Ver 1.5 **/
  char c_err_msg [ 256 ];     /***  Ver 1.5**/
	char c_ordr_rfrnc[19];			/***	Ver	1.8	***/
  char c_user_id[ 15 ];       /***  Ver 1.9 ***/

  varchar c_frm_dt[ LEN_DATE ];
  varchar c_to_dt[ LEN_DATE ];

  int  i_returncode;
  int  i_err[5];			/***	Ver	1.8	***/
  int  i_ferr[5];			/***	Ver	1.8	***/
  int  i_cnt;
  int  i_counter = 1;
  int  i_rec_count;           /**Ver 1.5 **/
  int  i_count=50;                /**Ver 1.5 **/
  int  k;                     /**Ver 1.5 **/
  int  i_mtch_cnt=0;          /**Ver 1.5 **/

  long li_rec_cnt_contract_date;
  long li_rec_cnt_undrlyng_dt;
  long li_rec_cnt_status_date;
  long li_rec_cnt_conf_date;
  long l_acnt_id;             /**Ver 1.5 **/
  long l_bufferlength;        /**Ver 1.5 **/  
  long l_actn_id;             /**Ver 1.5 **/

  EXEC SQL BEGIN DECLARE SECTION;
    struct vw_contract st_cntrct;
    struct vw_exrcbook *ptr_st_exrcbook;
    struct vw_usr_prfl st_usr_prfl;
    sql_cursor  sys_cursor;
    varchar c_expiry_dt[ LEN_DATE ];
    varchar c_exp_date[ LEN_DATE ];
    varchar c_trd_date[ LEN_DATE ];
    varchar c_request_tm[ LEN_DATE ];   /***Ver 1.5 **/
    varchar c_ack_time[ LEN_DATE ];     /***Ver 1.5 **/
    varchar c_remarks[ 257 ];           /***Ver 1.5 **/
    char c_opr_typ;
    char c_exrc_stts;
    char c_exercise_stts;
    char c_date_flag = 'Y';
    char c_mtch_accnt_no[11];
    char c_exchange_cd[4];
    char c_product_typ;
    char c_underlying[7];
    char c_exercise_type;
    char c_min_ref_num[19];
    char c_max_ref_num[19];
    char c_rqst_typ;
    char c_plcd_stts;
    long li_strike_price;
  EXEC SQL END DECLARE SECTION;

  struct vw_err_msg st_err_msg;

  ptr_fml_Ibuf = (FBFR32 *)rqst->data;
  strcpy( c_ServiceName, rqst->name );
  INITDBGLVL(c_ServiceName);  /* ver 1.6 */


	/**** Commented for Ver 2.1 *******
  i_returncode = Fvftos32( ptr_fml_Ibuf,
                           (char *) &st_usr_prfl,
                           "vw_usr_prfl" );

	*************/

	/***** Added for Ver 2.1 ****/

  i_returncode = fn_unpack_fmltovar_dflt ( c_ServiceName,
                                      c_errmsg,
                                      ptr_fml_Ibuf,
																			12,
																	FFO_EBA_MTCH_ACT_NO, (char*)st_usr_prfl.c_cln_mtch_accnt, "NULL",
																	FFO_ROUT_CRT, (char*)st_usr_prfl.c_rout_crt, "NULL",
																	FFO_USR_FLG, (char*)&st_usr_prfl.l_usr_flg, "0",
																	FFO_USR_ID, (char*)st_usr_prfl.c_user_id, "NULL",
																	FFO_SSSN_ID, (char*)&st_usr_prfl.l_session_id, "NULL",
																	FFO_XCHNG_CD, (char*)st_cntrct.c_xchng_cd, "NULL",
																	FFO_UNDRLYNG, (char*)st_cntrct.c_undrlyng, "*",
																	FFO_EXPRY_DT, (char*)st_cntrct.c_expry_dt, "*",
																	FFO_EXER_TYP, (char*)&st_cntrct.c_exrc_typ, "*",
																	FFO_OPT_TYP, (char*)&st_cntrct.c_opt_typ, "-",
																	FFO_STRK_PRC, (char*)&st_cntrct.l_strike_prc, "-1",
																	FFO_PRDCT_TYP, (char*)&st_cntrct.c_prd_typ, "NULL");

  if ( i_returncode == -1 )
  {
   	fn_errlog( c_ServiceName, "S31005", FMLMSG, c_errmsg  );
   	Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
   	tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
	/**** Ver 2.1 ****/

  strcpy ( ( char * )c_mtch_accnt_no, st_usr_prfl.c_cln_mtch_accnt );

  /*** Added for Order Routing ***/
  fn_init_ddr_val ( st_usr_prfl.c_rout_crt );


if(DEBUG_MSG_LVL_3)
{
  fn_userlog( c_ServiceName,"c_mtch_accnt_no        :%s:", c_mtch_accnt_no );
}

  if ( st_usr_prfl.l_usr_flg != 1 )
  {
    i_returncode = fn_chk_sssn( c_ServiceName, 
                                &st_usr_prfl,
                                &st_err_msg ) ;

    if ( i_returncode == -1 )
    {
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, st_err_msg.c_err_msg, 0 );
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }
    else
    {
      st_usr_prfl.l_usr_flg = 1;
    }

  }

	/********** Commented for Ver 2.1 *********
  i_returncode = Fvftos32( ptr_fml_Ibuf,
                           (char *) &st_cntrct,
                           "vw_contract" );

  if ( i_returncode == -1 )
  {
    fn_errlog( c_ServiceName, "S31010", FMLMSG, c_errmsg  );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
	************* Ver 2.1 *****/
  
  strcpy ( ( char * )c_exchange_cd, st_cntrct.c_xchng_cd );
  strcpy ( ( char * )c_underlying, st_cntrct.c_undrlyng );
  strcpy ( ( char * )c_expiry_dt.arr, st_cntrct.c_expry_dt );
  SETLEN ( c_expiry_dt );
  c_exercise_type  = st_cntrct.c_exrc_typ; 
  c_option_type    = st_cntrct.c_opt_typ; 
  li_strike_price  = st_cntrct.l_strike_prc;

  i_err[0] = Fget32( ptr_fml_Ibuf, FFO_OPERATION_TYP, 0,
                                   (char *)&c_opr_typ, 0 );
  i_ferr [0] = Ferror32;

  if ( i_err[0] == -1 )
  {
    fn_errlog( c_ServiceName, "S31015", FMLMSG, c_errmsg  );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }


if(DEBUG_MSG_LVL_3)
{
  fn_userlog( c_ServiceName,"c_opr_typ   :%c:", c_opr_typ );
}

  i_err[1] = Fget32( ptr_fml_Ibuf, FFO_EXRC_STTS, 0,
                                   (char *)&c_exercise_stts, 0 );
  i_ferr [1] = Ferror32;

  i_err[2] = Fget32( ptr_fml_Ibuf, FFO_FROM_DT, 0,
                                   (char *)c_frm_dt.arr, 0 );
  i_ferr [2] = Ferror32;

  i_err[3] = Fget32( ptr_fml_Ibuf, FFO_TO_DT, 0,
                                   (char *)c_to_dt.arr, 0 );
  i_ferr [3] = Ferror32;

  for ( i_cnt = 1;  i_cnt <= 3; i_cnt++ )
  {
    if ( i_err[i_cnt] == -1 && i_ferr[i_cnt] != FNOTPRES )
    {
      fn_errlog( c_ServiceName, "S31020", Fstrerror32( i_ferr[i_cnt] ), 
                 c_errmsg  );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }
    else if ( i_err[i_cnt] == -1 && i_ferr[i_cnt] == FNOTPRES )
    {
      switch ( i_cnt )
      {
        case 1:
          c_exercise_stts = '%';
          break;
        case 2:
        case 3:
          c_date_flag = 'N';
          break;
      }
    }
  }

	/***	Ver	1.8	Starts	***/

	if ( c_opr_typ ==	ORDER_RFRNC_IP )
	{
		
		i_err[4] 		= Fget32( ptr_fml_Ibuf,FFO_ORDR_RFRNC, 0,(char *)c_ordr_rfrnc, 0 );
  	i_ferr [4] 	= Ferror32;

  	if ( i_err[4] == -1 )
  	{
    	fn_errlog( c_ServiceName, "S31025", FMLMSG, c_errmsg  );
    	Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
    	tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  	}
		
		fn_userlog(c_ServiceName,"Order Reference No. Is :%s:",c_ordr_rfrnc);

	}

	/***	Ver	1.8	Ends	***/
  
  SETLEN( c_frm_dt );
  SETLEN( c_to_dt );

  if ( c_date_flag == 'Y' )
  {
      strcpy ( c_min_ref_num, (char *)fn_getref ( c_ServiceName,
                                                  c_frm_dt.arr, 
                                                  "00", 
                                                  MIN,
                                                  c_errmsg ) );
      strcpy ( c_max_ref_num, (char *)fn_getref ( c_ServiceName, 
                                                  c_to_dt.arr, 
                                                  "00", 
                                                  MAX,
                                                  c_errmsg ) );

  }

  fn_userlog(c_ServiceName,"c_min_ref_num :%s:",c_min_ref_num);
  fn_userlog(c_ServiceName,"c_max_ref_num :%s:",c_max_ref_num);
/*  userlog ("c_min_ref_num : %s",c_min_ref_num);
  userlog ("c_max_ref_num : %s",c_max_ref_num); */

  if ( st_cntrct.c_prd_typ == ALL )
  {
    c_product_typ = '%';
  }
  else
  {
    c_product_typ = st_cntrct.c_prd_typ;
  }

  if ( c_exercise_stts == ALL )
  {
    c_exrc_stts = '%';
  }
  else
  {
    c_exrc_stts = c_exercise_stts;
  }
			/***** Ver 2.0 new code starts ***********/ 
	 if ( strcmp(st_cntrct.c_xchng_cd,"ALL") == 0 )
  {
		memset(c_exchange_cd,'\0',sizeof(c_exchange_cd));
		strcpy(c_exchange_cd,"%");
		rtrim(c_exchange_cd);
  }
	/********** Ver 2.0 new code ends ********/
if(DEBUG_MSG_LVL_3)
{
  fn_userlog(c_ServiceName,"c_mtch_accnt_no :%s:",c_mtch_accnt_no);
  fn_userlog(c_ServiceName,"c_exchange_cd :%s:",c_exchange_cd);
  fn_userlog(c_ServiceName,"c_product_typ :%c:",c_product_typ);
  fn_userlog(c_ServiceName,"c_underlying :%s:",c_underlying);
  fn_userlog(c_ServiceName,"c_expiry_dt :%s:",c_expiry_dt);
  fn_userlog(c_ServiceName,"c_exercise_type :%c:",c_exercise_type);
  fn_userlog(c_ServiceName,"c_option_type :%c:",c_option_type);
  fn_userlog(c_ServiceName,"li_strike_price :%ld:",li_strike_price);
  fn_userlog(c_ServiceName,"c_exrc_stts :%c:",c_exrc_stts);
}

  /******* Ver 1.5 Starts ************/

	/**** Following commented for Ver 1.9 
  if(tpbegin( TRAN_TIMEOUT, 0 ) == -1)
  {
    fn_errlog( c_ServiceName, "S31030", SQLMSG, c_errmsg  );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

	commented for Ver 1.9 Ends ****/

    fn_userlog(c_ServiceName,"i_count:%d:",i_count);  

  EXEC SQL ALLOCATE :sys_cursor;
	
	strcpy ( c_user_id, st_usr_prfl.c_user_id);  /*** Ver 1.9 ***/

  if( strcmp( c_mtch_accnt_no, "*" ) == 0 )
  {

		/**** Following commented for Ver 1.9

    if( st_usr_prfl.c_user_id[0] == BPID )
    {
     ** insert into fdm all acounts for this bpid **
      EXEC SQL
      INSERT INTO
      FDM_DT_MTCH
      SELECT CLM_MTCH_ACCNT FROM CLM_CLNT_MSTR
      WHERE CLM_BP_ID = :st_usr_prfl.c_user_id;
      if( SQLCODE != 0 )
      {
        fn_errlog( c_ServiceName, "S31035", SQLMSG, c_errmsg );
        Fadd32(ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
        tpcommit(0);
        tpreturn( TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0);
      }
    }
    else
    {
      EXEC SQL
      INSERT  INTO  FDM_DT_MTCH
      SELECT  UAC_CLM_MTCH_ACCNT FROM uac_usr_accnts
      WHERE   UAC_USR_ID = :st_usr_prfl.c_user_id ;
      if ( SQLCODE != 0 )
      {
        fn_errlog( c_ServiceName, "S31040", SQLMSG, c_errmsg  );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
        tpcommit(0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }     
    }


    EXEC SQL
    SELECT  count(*)
    INTO :i_count
    FROM    FDM_DT_MTCH ;
    if ( SQLCODE != 0 )
    {
      fn_errlog( c_ServiceName, "S31045", SQLMSG, c_errmsg  );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
      tpcommit(0);
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }
    fn_userlog(c_ServiceName,"i_count:%d:",i_count);  
    fn_userlog(c_ServiceName,"Inside All mtch accnnt's");
 
	  Commented Ver 1.9 Ends ****/
  
    if ( c_date_flag == 'N' )
    {
      /** tpcommit(0); commented for Ver 1.9 **/
      fn_userlog( c_ServiceName,"From/To Dates are not Found in the Buffer" );
      strcpy(c_errmsg,"From/To Dates are not Found in the Buffer");
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

    li_rec_cnt_status_date = 0;

	  /**** Following commented for Ver 1.9
    EXEC SQL
        SELECT    1
          INTO    :li_rec_cnt_status_date
        FROM      dual
        WHERE     EXISTS
        (
        SELECT    1
          FROM    feb_fo_exrc_rqst_book_hstry,FDM_DT_MTCH
        ** WHERE   feb_clm_mtch_accnt = :c_mtch_accnt_no **
         WHERE    feb_clm_mtch_accnt = FDM_CLM_MTCH_ACCNT
           AND    feb_xchng_cd       = :c_exchange_cd
           AND    feb_prdct_typ   LIKE :c_product_typ
           AND    feb_exrc_stts   LIKE :c_exrc_stts 
           AND    feb_exrc_rfrnc_no >=    :c_min_ref_num 
           AND    feb_exrc_rfrnc_no <     :c_max_ref_num
        ); 

    if ( ( SQLCODE !=0 ) && ( SQLCODE != NO_DATA_FOUND ) )
    { 
      fn_errlog( c_ServiceName, "S31050", SQLMSG, c_errmsg  );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
      tpcommit(0);
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

	  commented ends for ver 1.9 ****/

	  /**** Ver 1.9 Starts ****/

    if( st_usr_prfl.c_user_id[0] == BPID )
    {
    EXEC SQL
          SELECT    1
          INTO      :li_rec_cnt_status_date
          FROM      dual
          WHERE     EXISTS
         (
           SELECT    1
           FROM     feb_fo_exrc_rqst_book_hstry,CLM_CLNT_MSTR
           WHERE    feb_clm_mtch_accnt =   clm_mtch_accnt
          /* AND      feb_xchng_cd       =   :c_exchange_cd ***	Ver 2.0 Comment**/
           AND      feb_xchng_cd       LIKE   :c_exchange_cd  /*** Ver 2.0 ****/

           AND      feb_prdct_typ   LIKE   :c_product_typ
           AND      feb_exrc_stts   LIKE   :c_exrc_stts
           AND      feb_exrc_rfrnc_no >=   :c_min_ref_num
           AND      feb_exrc_rfrnc_no  <   :c_max_ref_num
           AND      clm_bp_id          =   :c_user_id
        );
    }
    else
    {
    EXEC SQL
          SELECT    1
          INTO      :li_rec_cnt_status_date
          FROM      dual
          WHERE     EXISTS
          (
           SELECT    1
           FROM     feb_fo_exrc_rqst_book_hstry,uac_usr_accnts
           WHERE    feb_clm_mtch_accnt =   uac_clm_mtch_accnt
           /*AND      feb_xchng_cd       =   :c_exchange_cd  **** Ver 2.0 Comment *****/
           AND      feb_xchng_cd    LIKE   :c_exchange_cd			/** Ver 2.0 ****/
           AND      feb_prdct_typ   LIKE   :c_product_typ
           AND      feb_exrc_stts   LIKE   :c_exrc_stts
           AND      feb_exrc_rfrnc_no >=   :c_min_ref_num
           AND      feb_exrc_rfrnc_no <    :c_max_ref_num
           AND      uac_usr_id         =   :c_user_id
          );

    }

    if ( ( SQLCODE !=0 ) && ( SQLCODE != NO_DATA_FOUND ) )
    {
      fn_errlog( c_ServiceName, "S31055", SQLMSG, c_errmsg  );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
      /**  tpcommit(0); commented for Ver 1.9 **/
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

    /**** Ver 1.9 Ends ****/

    li_rec_cnt_conf_date = 0;

    /**** Following commented For Ver 1.9	
    EXEC SQL
        SELECT    1
        INTO    :li_rec_cnt_conf_date
        FROM      dual
        WHERE     EXISTS
        (
        SELECT    1
          FROM fec_fo_exrc_conf_hstry,FDM_DT_MTCH
        ** WHERE   fec_clm_mtch_accnt = :c_mtch_accnt_no **
          where fec_clm_mtch_accnt = FDM_CLM_MTCH_ACCNT
            AND fec_xchng_cd = :c_exchange_cd
            AND fec_prdct_typ LIKE :c_product_typ
            AND fec_exrc_init = 'E'
            AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
            AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')
        ); 

    if ( ( SQLCODE !=0 ) && ( SQLCODE != NO_DATA_FOUND ) )
    { 
      fn_errlog( c_ServiceName, "S31060", SQLMSG, c_errmsg  );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
      tpcommit(0);
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

		 Commented Ends for Ver 1.9 ****/

		/**** Ver 1.9 Starts ****/

    if( st_usr_prfl.c_user_id[0] == BPID )
    {
     EXEC SQL
          SELECT    1
          INTO      :li_rec_cnt_conf_date
          FROM      dual
          WHERE     EXISTS
          (
            SELECT  1
            FROM    fec_fo_exrc_conf_hstry,CLM_CLNT_MSTR
            WHERE   fec_clm_mtch_accnt =  clm_mtch_accnt
            /*AND     fec_xchng_cd       =  :c_exchange_cd **** Ver 2.0 Comment ***/
            AND     fec_xchng_cd       LIKE  :c_exchange_cd   /**** Ver 2.0 ****/
            AND     fec_prdct_typ LIKE    :c_product_typ
            AND     fec_exrc_init      =  'E'
            AND     fec_exrc_dt       >=  to_date(:c_frm_dt, 'dd-Mon-yyyy')
            AND     fec_exrc_dt       <=  to_date(:c_to_dt , 'dd-Mon-yyyy')
            AND     clm_bp_id          =  :c_user_id
          );
    }
    else
    {
     EXEC SQL
          SELECT    1
          INTO      :li_rec_cnt_conf_date
          FROM      dual
          WHERE     EXISTS
          (
            SELECT  1
            FROM    fec_fo_exrc_conf_hstry,uac_usr_accnts
            WHERE   fec_clm_mtch_accnt =  uac_clm_mtch_accnt
            /**AND     fec_xchng_cd       =  :c_exchange_cd   *** Ver 2.0 Comment ***/
            AND     fec_xchng_cd       LIKE  :c_exchange_cd   /*** Ver 2.0 ****/
            AND     fec_prdct_typ LIKE    :c_product_typ
            AND     fec_exrc_init      =  'E'
            AND     fec_exrc_dt       >=  to_date(:c_frm_dt, 'dd-Mon-yyyy')
            AND     fec_exrc_dt       <=  to_date(:c_to_dt , 'dd-Mon-yyyy')
            AND     uac_usr_id         =  :c_user_id
          );

    }


    if ( ( SQLCODE !=0 ) && ( SQLCODE != NO_DATA_FOUND ) )
    {
      fn_errlog( c_ServiceName, "S31065", SQLMSG, c_errmsg  );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
      /**  tpcommit(0);  commented for Ver 1.9 **/
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

    /**** Ver 1.9 Ends ****/
     
    fn_userlog( c_ServiceName,"1226 : li_rec_cnt_status_date : %d",li_rec_cnt_status_date );

    fn_userlog( c_ServiceName,"1228 :li_rec_cnt_conf_date : %d",li_rec_cnt_conf_date );

    if ( ( li_rec_cnt_status_date != 1 ) && ( li_rec_cnt_conf_date != 1 ) )
    {
		/**** Following commented for Ver 1.9
      
      EXEC SQL  EXECUTE
        BEGIN
          OPEN  :sys_cursor FOR
              SELECT  feb_clm_mtch_accnt,                                     **Ver 1.5***
                      feb_exrc_rfrnc_no, 
                      feb_xchng_cd, 
                      feb_prdct_typ,
                      feb_indstk,
                      feb_undrlyng, 
                      to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                      feb_exer_typ, 
                      feb_opt_typ, 
                      feb_strk_prc,
                      feb_exrc_rqst_typ, 
                      NVL( feb_exrc_qty, 0 ), 
                      feb_exrc_stts,
                      to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                      NVL( feb_ack_nmbr, ' ' ),
                      NVL( feb_curr_mkt_prc, 0 ),
                      NVL( feb_channel , '*'),                                  ***1.1***
                      NVL( feb_bp_id , ' '),                                    ***1.1***
                      feb_pipe_id,                                              ***1.4***
											0.00			***	Ver	1.8	***
                FROM  feb_fo_exrc_rqst_book,FDM_DT_MTCH 
                WHERE  feb_clm_mtch_accnt = FDM_CLM_MTCH_ACCNT
             **  WHERE feb_clm_mtch_accnt = :c_mtch_accnt_no **
                 AND  feb_xchng_cd       = :c_exchange_cd
                 AND  feb_prdct_typ   LIKE :c_product_typ
                 AND  feb_exrc_stts   LIKE :c_exrc_stts 
                 AND  feb_exrc_rfrnc_no >=    :c_min_ref_num 
                 AND  feb_exrc_rfrnc_no <     :c_max_ref_num 
      UNION ALL

        SELECT fec_clm_mtch_accnt,                                            *** Ver 1.5 **
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                              ***1.1***
               ' ',                                                     ***1.1***
               ' ',                                                     ***1.1***
               '*' ,                                                    ***1.4***
							(	NVL(fec_brkg_val,0)			***	Ver	1.8	***
                + NVL(fec_stt,0)
                + NVL(fec_src_tx,0)
                + NVL(fec_sebi_tt,0)
                + NVL(fec_tran_chrg,0)
                + NVL(fec_stamp_duty,0)
                + NVL(fec_other_chrg,0)
               )
        FROM fec_fo_exrc_conf,FDM_DT_MTCH
        WHERE  fec_clm_mtch_accnt = FDM_CLM_MTCH_ACCNT
        ** where fec_clm_mtch_accnt = :c_mtch_accnt_no **
          AND fec_xchng_cd = :c_exchange_cd
          AND fec_prdct_typ LIKE :c_product_typ
          AND fec_exrc_init = 'E'
          AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
          AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')
          ***order by 13,14 desc;***
          order by 1;
        END;
      END-EXEC;
			Commented Ends For  Ver 1.9  ****/

			
			/**** Ver 1.9 Starts ****/

	    if( st_usr_prfl.c_user_id[0] == BPID )
      {

	     EXEC SQL  EXECUTE
              BEGIN
              OPEN    :sys_cursor FOR
              SELECT  feb_clm_mtch_accnt,                                      /***Ver 1.5***/
                      feb_exrc_rfrnc_no,
                      feb_xchng_cd,
                      feb_prdct_typ,
                      feb_indstk,
                      feb_undrlyng,
                      to_char ( feb_expry_dt, 'dd-Mon-yyyy' ),
                      feb_exer_typ,
                      feb_opt_typ,
                      feb_strk_prc,
                      feb_exrc_rqst_typ,
                      NVL( feb_exrc_qty, 0 ),
                      feb_exrc_stts,
                      to_char ( feb_trd_dt, 'dd-Mon-yyyy' ),
                      NVL( feb_ack_nmbr, ' ' ),
                      NVL( feb_curr_mkt_prc, 0 ),
                      NVL( feb_channel , '*'),                                 /***1.1***/
                      NVL( feb_bp_id , ' '),                                   /***1.1***/
                      feb_pipe_id,                                             /***1.4***/
										  0.00                                                     /***1.8***/
              FROM   feb_fo_exrc_rqst_book,CLM_CLNT_MSTR
              WHERE  feb_clm_mtch_accnt = clm_mtch_accnt
              /**  WHERE feb_clm_mtch_accnt = :c_mtch_accnt_no 							*Ver 2.0 comment**/
             /* AND  feb_xchng_cd       LIKE :c_exchange_cd											 /** Ver 2.0 **/
              AND  feb_xchng_cd       = :c_exchange_cd
              AND  feb_prdct_typ   LIKE :c_product_typ
              AND  feb_exrc_stts   LIKE :c_exrc_stts
              AND  feb_exrc_rfrnc_no >= :c_min_ref_num
              AND  feb_exrc_rfrnc_no <  :c_max_ref_num
		          AND  clm_bp_id          = :c_user_id 
       UNION ALL
              SELECT fec_clm_mtch_accnt,                                        /*** Ver 1.5 **/
                     fec_exrc_rfrnc_no,
                     fec_xchng_cd,
                     fec_prdct_typ,
                     fec_indstk,
                     fec_undrlyng,
                     to_char ( fec_expry_dt, 'dd-Mon-yyyy' ),
                     fec_exer_typ,
                     fec_opt_typ,
                     fec_strk_prc,
                     'E',
                     NVL( fec_exrc_qty, 0 ),
                     'E',
                     to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ),
                     'Exchange Initiated',
                     NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
                     ' ',                                                     /***1.1***/
                     ' ',                                                     /***1.1***/
                     '*',                                                     /***1.4***/
								     ( NVL(fec_brkg_val,0)                                    /***  Ver 1.8 ***/
                       + NVL(fec_stt,0)
                       + NVL(fec_src_tx,0)
                			 + NVL(fec_sebi_tt,0)
                       + NVL(fec_tran_chrg,0)
                       + NVL(fec_stamp_duty,0)
                       + NVL(fec_other_chrg,0)
                     )		
              FROM fec_fo_exrc_conf,CLM_CLNT_MSTR
              WHERE  fec_clm_mtch_accnt = clm_mtch_accnt
              /** where fec_clm_mtch_accnt = :c_mtch_accnt_no **/
              /**AND fec_xchng_cd     =  :c_exchange_cd **** Ver 2.0 comment *******/
              AND fec_xchng_cd     LIKE  :c_exchange_cd				/*** Ver 2.0 **/
              AND fec_prdct_typ LIKE  :c_product_typ
              AND fec_exrc_init    =  'E'
              AND fec_exrc_dt      >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
              AND fec_exrc_dt      <= to_date(:c_to_dt , 'dd-Mon-yyyy')
	            AND clm_bp_id        =  :c_user_id 
              /***order by 13,14 desc;***/
              order by 1;
       END;
       END-EXEC;
    }
    else
    {

	     EXEC SQL  EXECUTE
              BEGIN
              OPEN  :sys_cursor FOR
              SELECT  feb_clm_mtch_accnt,                                     /***Ver 1.5***/
                      feb_exrc_rfrnc_no,
                      feb_xchng_cd,
                      feb_prdct_typ,
                      feb_indstk,
                      feb_undrlyng,
                      to_char ( feb_expry_dt, 'dd-Mon-yyyy' ),
                      feb_exer_typ,
                      feb_opt_typ,
                      feb_strk_prc,
                      feb_exrc_rqst_typ,
                      NVL( feb_exrc_qty, 0 ),
                      feb_exrc_stts,
                      to_char ( feb_trd_dt, 'dd-Mon-yyyy' ),
                      NVL( feb_ack_nmbr, ' ' ),
                      NVL( feb_curr_mkt_prc, 0 ),
                      NVL( feb_channel , '*'),                                 /***1.1***/
                      NVL( feb_bp_id , ' '),                                   /***1.1***/
                      feb_pipe_id,                                             /***1.4***/
									    0.00      /***  Ver 1.8 ***/
                FROM  feb_fo_exrc_rqst_book,uac_usr_accnts
                WHERE  feb_clm_mtch_accnt = uac_clm_mtch_accnt
					    	/**  WHERE feb_clm_mtch_accnt = :c_mtch_accnt_no **/
                /**AND  feb_xchng_cd       = :c_exchange_cd         **** Ver 2.0 comment***/
                AND  feb_xchng_cd       LIKE :c_exchange_cd					/** Ver 2.0***/
                AND  feb_prdct_typ   LIKE :c_product_typ
                AND  feb_exrc_stts   LIKE :c_exrc_stts
                AND  feb_exrc_rfrnc_no >= :c_min_ref_num
                AND  feb_exrc_rfrnc_no <  :c_max_ref_num
		            AND  uac_usr_id         = :c_user_id 
       UNION ALL
                SELECT fec_clm_mtch_accnt,                                      /*** Ver 1.5 **/
                      fec_exrc_rfrnc_no,
                      fec_xchng_cd,
            			    fec_prdct_typ,
                      fec_indstk,
                      fec_undrlyng,
                      to_char ( fec_expry_dt, 'dd-Mon-yyyy' ),
                      fec_exer_typ,
                      fec_opt_typ,
                      fec_strk_prc,
                      'E',
                      NVL( fec_exrc_qty, 0 ),
                      'E',
                      to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ),
                      'Exchange Initiated',
                      NVL( fec_curr_mkt_prc, 0 ),                               /***1.1***/
                      ' ',                                                      /***1.1***/
                      ' ',                                                      /***1.1***/
                      '*',                                                      /***1.4***/
											( NVL(fec_brkg_val,0)                                     /***  Ver 1.8 ***/
                        + NVL(fec_stt,0)
                        + NVL(fec_src_tx,0)
                        + NVL(fec_sebi_tt,0)
                        + NVL(fec_tran_chrg,0)
                        + NVL(fec_stamp_duty,0)
                        + NVL(fec_other_chrg,0)
                      )
                      FROM fec_fo_exrc_conf,uac_usr_accnts
                      WHERE  fec_clm_mtch_accnt = uac_clm_mtch_accnt
							        /**  WHERE feb_clm_mtch_accnt = :c_mtch_accnt_no **/
                      /**AND fec_xchng_cd          = :c_exchange_cd					**Ver 2.0 comment**/
                      AND fec_xchng_cd          LIKE :c_exchange_cd					/**Ver 2.0 **/
                      AND fec_prdct_typ      LIKE :c_product_typ
                      AND fec_exrc_init         = 'E'
                      AND fec_exrc_dt          >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
                      AND fec_exrc_dt          <= to_date(:c_to_dt , 'dd-Mon-yyyy')
	                    AND uac_usr_id            = :c_user_id
          /***order by 13,14 desc;***/
          order by 1;
        END;
        END-EXEC;

    }
		/**** Ver 1.9 Ends ****/	

    }
    else if ( ( li_rec_cnt_status_date != 1 ) && ( li_rec_cnt_conf_date == 1 ) )
    {

			/***** Following Commented for Ver 1.9
        EXEC SQL  EXECUTE
        BEGIN
        OPEN  :sys_cursor FOR
              SELECT  feb_clm_mtch_accnt,                                   ***Ver 1.5***
                      feb_exrc_rfrnc_no, 
                      feb_xchng_cd, 
                      feb_prdct_typ,
                      feb_indstk,
                      feb_undrlyng, 
                      to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                      feb_exer_typ, 
                      feb_opt_typ, 
                      feb_strk_prc,
                      feb_exrc_rqst_typ, 
                      NVL( feb_exrc_qty, 0 ), 
                      feb_exrc_stts,
                      to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                      NVL( feb_ack_nmbr, ' ' ),
                      NVL( feb_curr_mkt_prc, 0 ), 
                      NVL( feb_channel , '*'),                                 ***1.1***
                      NVL( feb_bp_id , ' '),                                   ***1.1***
                      feb_pipe_id,                                             ***1.4***
                      0.00      ***  Ver 1.8 ***
                FROM  feb_fo_exrc_rqst_book,FDM_DT_MTCH 
             ***  WHERE  feb_clm_mtch_accnt = :c_mtch_accnt_no ***
               WHERE  feb_clm_mtch_accnt = FDM_CLM_MTCH_ACCNT
                 AND  feb_xchng_cd       = :c_exchange_cd
                 AND  feb_prdct_typ   LIKE :c_product_typ
                 AND  feb_exrc_stts   LIKE :c_exrc_stts 
                 AND  feb_exrc_rfrnc_no >=    :c_min_ref_num 
                 AND  feb_exrc_rfrnc_no <     :c_max_ref_num 
      UNION ALL

        SELECT fec_clm_mtch_accnt,                                            *** Ver 1.5 **
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                              ***1.1***
               ' ',                                                     ***1.1***
               ' ',                                                     ***1.1***
               '*',                                                     ***1.4***
							( NVL(fec_brkg_val,0)     ***  Ver 1.8 ***
                + NVL(fec_stt,0)
                + NVL(fec_src_tx,0)
                + NVL(fec_sebi_tt,0)
                + NVL(fec_tran_chrg,0)
                + NVL(fec_stamp_duty,0)
                + NVL(fec_other_chrg,0)
               )
        FROM fec_fo_exrc_conf,FDM_DT_MTCH
        WHERE  fec_clm_mtch_accnt = FDM_CLM_MTCH_ACCNT
       ***  where fec_clm_mtch_accnt = :c_mtch_accnt_no ***
          AND fec_xchng_cd = :c_exchange_cd
          AND fec_prdct_typ LIKE :c_product_typ
          AND fec_exrc_init = 'E'
          AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
          AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')

      UNION ALL

        SELECT fec_clm_mtch_accnt,                                        *** Ver 1.5 **
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                              ***1.1***
               ' ',                                                     ***1.1***
               ' ',                                                     ***1.1***
               '*',                                                     ***1.4***
							 ( NVL(fec_brkg_val,0)     ***  Ver 1.8 ***
                + NVL(fec_stt,0)
                + NVL(fec_src_tx,0)
                + NVL(fec_sebi_tt,0)
                + NVL(fec_tran_chrg,0)
                + NVL(fec_stamp_duty,0)
                + NVL(fec_other_chrg,0)
               )
        FROM fec_fo_exrc_conf_hstry,FDM_DT_MTCH
        WHERE  fec_clm_mtch_accnt = FDM_CLM_MTCH_ACCNT
       ***  where fec_clm_mtch_accnt = :c_mtch_accnt_no ***
          AND fec_xchng_cd = :c_exchange_cd
          AND fec_prdct_typ LIKE :c_product_typ
          AND fec_exrc_init = 'E'
          AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
          AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')
          ***order by 13,14 desc; ***
          order by 1;
        END;
      END-EXEC;
		Commented for Ver 1.9 Ends *****/

		/**** Ver 1.9 Starts *****/
		if( st_usr_prfl.c_user_id[0] == BPID )
    {
		   EXEC SQL  EXECUTE
       BEGIN
       OPEN   :sys_cursor FOR
              SELECT  feb_clm_mtch_accnt,                                   /***Ver 1.5***/
                      feb_exrc_rfrnc_no, 
                      feb_xchng_cd, 
                      feb_prdct_typ,
                      feb_indstk,
                      feb_undrlyng, 
                      to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                      feb_exer_typ, 
                      feb_opt_typ, 
                      feb_strk_prc,
                      feb_exrc_rqst_typ, 
                      NVL( feb_exrc_qty, 0 ), 
                      feb_exrc_stts,
                      to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                      NVL( feb_ack_nmbr, ' ' ),
                      NVL( feb_curr_mkt_prc, 0 ), 
                      NVL( feb_channel , '*'),                              /***1.1***/
                      NVL( feb_bp_id , ' '),                                /***1.1***/
                      feb_pipe_id,                                          /***1.4***/
                      0.00                                                  /***  Ver 1.8 ***/
                 /**  FROM  feb_fo_exrc_rqst_book,FDM_DT_MTCH     
                 WHERE      feb_clm_mtch_accnt   = FDM_CLM_MTCH_ACCNT **/
							   FROM       feb_fo_exrc_rqst_book,CLM_CLNT_MSTR
								 WHERE      feb_clm_mtch_accnt   = clm_mtch_accnt
                 /*AND        feb_xchng_cd         = :c_exchange_cd			*** Ver 2.0 comment ***/
                 AND        feb_xchng_cd         LIKE :c_exchange_cd		/*** Ver 2.0 ***/
                 AND        feb_prdct_typ   LIKE   :c_product_typ
                 AND        feb_exrc_stts   LIKE   :c_exrc_stts 
                 AND        feb_exrc_rfrnc_no   >= :c_min_ref_num 
                 AND        feb_exrc_rfrnc_no   <  :c_max_ref_num
								 AND        clm_bp_id            = :c_user_id 
      UNION ALL

        SELECT fec_clm_mtch_accnt,                                           /*** Ver 1.5 **/
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                                   /***1.1***/
               ' ',                                                          /***1.1***/
               ' ',                                                          /***1.1***/
               '*',                                                          /***1.4***/
							( NVL(fec_brkg_val,0)                                          /***  Ver 1.8 ***/
                + NVL(fec_stt,0)
                + NVL(fec_src_tx,0)
                + NVL(fec_sebi_tt,0)
                + NVL(fec_tran_chrg,0)
                + NVL(fec_stamp_duty,0)
                + NVL(fec_other_chrg,0)
               )
          /***  FROM fec_fo_exrc_conf,FDM_DT_MTCH
          WHERE  fec_clm_mtch_accnt = FDM_CLM_MTCH_ACCNT   
          where fec_clm_mtch_accnt  = :c_mtch_accnt_no ***/
					FROM fec_fo_exrc_conf,CLM_CLNT_MSTR
          WHERE  fec_clm_mtch_accnt =  clm_mtch_accnt
          /**AND fec_xchng_cd          =  :c_exchange_cd			**** Ver 2.0 comment **/
          AND fec_xchng_cd          LIKE  :c_exchange_cd			/** Ver 2.0 **/
          AND fec_prdct_typ LIKE       :c_product_typ
          AND fec_exrc_init         =  'E'
          AND fec_exrc_dt          >=  to_date(:c_frm_dt, 'dd-Mon-yyyy')
          AND fec_exrc_dt          <=  to_date(:c_to_dt , 'dd-Mon-yyyy')
					AND clm_bp_id             =  :c_user_id

      UNION ALL

        SELECT fec_clm_mtch_accnt,                                           /*** Ver 1.5 **/
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                                   /***1.1***/
               ' ',                                                          /***1.1***/
               ' ',                                                          /***1.1***/
               '*',                                                          /***1.4***/
							 ( NVL(fec_brkg_val,0)     /***  Ver 1.8 ***/
                + NVL(fec_stt,0)
                + NVL(fec_src_tx,0)
                + NVL(fec_sebi_tt,0)
                + NVL(fec_tran_chrg,0)
                + NVL(fec_stamp_duty,0)
                + NVL(fec_other_chrg,0)
               )
          /***  FROM fec_fo_exrc_conf_hstry,FDM_DT_MTCH
          WHERE  fec_clm_mtch_accnt = FDM_CLM_MTCH_ACCNT   
          where fec_clm_mtch_accnt = :c_mtch_accnt_no ***/
					FROM fec_fo_exrc_conf_hstry,CLM_CLNT_MSTR
          WHERE  fec_clm_mtch_accnt = clm_mtch_accnt
          /**AND fec_xchng_cd          = :c_exchange_cd		**** Ver 2.0 comment****/
          AND fec_xchng_cd          LIKE :c_exchange_cd		/**** Ver 2.0 ***/
          AND fec_prdct_typ LIKE      :c_product_typ
          AND fec_exrc_init         = 'E'
          AND fec_exrc_dt          >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
          AND fec_exrc_dt          <= to_date(:c_to_dt , 'dd-Mon-yyyy')
					AND clm_bp_id             = :c_user_id
          /***order by 13,14 desc; ***/
          order by 1;
      END;
      END-EXEC;	

		
			}
		else
			{
			  EXEC SQL  EXECUTE
        BEGIN
        OPEN  :sys_cursor FOR
              SELECT  feb_clm_mtch_accnt,                                   /***Ver 1.5***/
                      feb_exrc_rfrnc_no, 
                      feb_xchng_cd, 
                      feb_prdct_typ,
                      feb_indstk,
                      feb_undrlyng, 
                      to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                      feb_exer_typ, 
                      feb_opt_typ, 
                      feb_strk_prc,
                      feb_exrc_rqst_typ, 
                      NVL( feb_exrc_qty, 0 ), 
                      feb_exrc_stts,
                      to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                      NVL( feb_ack_nmbr, ' ' ),
                      NVL( feb_curr_mkt_prc, 0 ), 
                      NVL( feb_channel , '*'),                               /***1.1***/
                      NVL( feb_bp_id , ' '),                                 /***1.1***/
                      feb_pipe_id,                                           /***1.4***/
                      0.00      /***  Ver 1.8 ***/
                 /***   FROM  feb_fo_exrc_rqst_book,FDM_DT_MTCH       
                 WHERE  feb_clm_mtch_accnt = :c_mtch_accnt_no  
                 WHERE  feb_clm_mtch_accnt = FDM_CLM_MTCH_ACCNT ***/
								 FROM   feb_fo_exrc_rqst_book,uac_usr_accnts
								 WHERE  feb_clm_mtch_accnt =  uac_clm_mtch_accnt
                 /**AND    feb_xchng_cd       = :c_exchange_cd			*** Ver 2.0 Comment ****/
                 AND    feb_xchng_cd    LIKE    :c_exchange_cd			/*** Ver 2.0 ****/
                 AND    feb_prdct_typ   LIKE :c_product_typ
                 AND    feb_exrc_stts   LIKE :c_exrc_stts 
                 AND    feb_exrc_rfrnc_no >= :c_min_ref_num 
                 AND    feb_exrc_rfrnc_no <  :c_max_ref_num
								 AND    uac_usr_id         = :c_user_id 
      UNION ALL

        SELECT fec_clm_mtch_accnt,                                            /*** Ver 1.5 **/
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
               ' ',                                                     /***1.1***/
               ' ',                                                     /***1.1***/
               '*',                                                     /***1.4***/
							( NVL(fec_brkg_val,0)                                     /***  Ver 1.8 ***/
                + NVL(fec_stt,0)
                + NVL(fec_src_tx,0)
                + NVL(fec_sebi_tt,0)
                + NVL(fec_tran_chrg,0)
                + NVL(fec_stamp_duty,0)
                + NVL(fec_other_chrg,0)
               )
          /***  FROM fec_fo_exrc_conf,FDM_DT_MTCH
          WHERE  fec_clm_mtch_accnt = FDM_CLM_MTCH_ACCNT   
          where  fec_clm_mtch_accnt  = :c_mtch_accnt_no ***/
					FROM   fec_fo_exrc_conf,uac_usr_accnts
          WHERE  fec_clm_mtch_accnt = uac_clm_mtch_accnt
          /***AND    fec_xchng_cd       = :c_exchange_cd			*** Ver 2.0 comment *****/
          AND    fec_xchng_cd       LIKE :c_exchange_cd				/*** Ver 2.0 ***/
          AND    fec_prdct_typ   LIKE :c_product_typ
          AND    fec_exrc_init      = 'E'
          AND    fec_exrc_dt       >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
          AND    fec_exrc_dt       <= to_date(:c_to_dt , 'dd-Mon-yyyy')
					AND    uac_usr_id         = :c_user_id

        UNION ALL

        SELECT fec_clm_mtch_accnt,                                        /*** Ver 1.5 **/
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
               ' ',                                                     /***1.1***/
               ' ',                                                     /***1.1***/
               '*',                                                     /***1.4***/
							 ( NVL(fec_brkg_val,0)                                    /***  Ver 1.8 ***/
                + NVL(fec_stt,0)
                + NVL(fec_src_tx,0)
                + NVL(fec_sebi_tt,0)
                + NVL(fec_tran_chrg,0)
                + NVL(fec_stamp_duty,0)
                + NVL(fec_other_chrg,0)
               )
          /***  FROM fec_fo_exrc_conf_hstry,FDM_DT_MTCH
          WHERE  fec_clm_mtch_accnt = FDM_CLM_MTCH_ACCNT   
          where  fec_clm_mtch_accnt = :c_mtch_accnt_no ***/
					FROM   fec_fo_exrc_conf_hstry, uac_usr_accnts
          WHERE  fec_clm_mtch_accnt = uac_clm_mtch_accnt
          /**AND    fec_xchng_cd       = :c_exchange_cd		*** Ver 2.0 comment **/
          AND    fec_xchng_cd       LIKE :c_exchange_cd		/** Ver 2.0***/
          AND    fec_prdct_typ   LIKE :c_product_typ
          AND    fec_exrc_init      = 'E'
          AND    fec_exrc_dt       >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
          AND    fec_exrc_dt       <= to_date(:c_to_dt , 'dd-Mon-yyyy')
					AND    uac_usr_id         = :c_user_id
          /***order by 13,14 desc; ***/
          order by 1;
          END;
          END-EXEC;

	
			}
	
		/**** Ver 1.9 Ends  ****/
		
    }
    else
    {
		
		/*** Following Commented For Ver 1.9
      EXEC SQL  EXECUTE
        BEGIN
          OPEN  :sys_cursor FOR
              SELECT  feb_clm_mtch_accnt,                                 ***Ver 1.5***
                      feb_exrc_rfrnc_no, 
                      feb_xchng_cd, 
                      feb_prdct_typ,
                      feb_indstk,
                      feb_undrlyng, 
                      to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                      feb_exer_typ, 
                      feb_opt_typ, 
                      feb_strk_prc,
                      feb_exrc_rqst_typ, 
                      NVL( feb_exrc_qty, 0 ), 
                      feb_exrc_stts,
                      to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                      NVL( feb_ack_nmbr, ' ' ),
                      NVL( feb_curr_mkt_prc, 0 ),
                      NVL( feb_channel , '*'),                                 ***1.1***
                      NVL( feb_bp_id , ' '),                                   ***1.1***
                      feb_pipe_id,                                             ***1.4***
                      0.00      ***  Ver 1.8 ***
                FROM  feb_fo_exrc_rqst_book,FDM_DT_MTCH 
               WHERE  feb_clm_mtch_accnt = FDM_CLM_MTCH_ACCNT
               *** WHERE feb_clm_mtch_accnt = :c_mtch_accnt_no ***
                 AND  feb_xchng_cd       = :c_exchange_cd
                 AND  feb_prdct_typ   LIKE :c_product_typ
                 AND  feb_exrc_stts   LIKE :c_exrc_stts 
                 AND  feb_exrc_rfrnc_no >=    :c_min_ref_num 
                 AND  feb_exrc_rfrnc_no <     :c_max_ref_num 
  
               UNION ALL
  
              SELECT  feb_clm_mtch_accnt,                                     ***Ver 1.5***
                      feb_exrc_rfrnc_no, 
                      feb_xchng_cd, 
                      feb_prdct_typ,
                      feb_indstk,
                      feb_undrlyng, 
                      to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                      feb_exer_typ, 
                      feb_opt_typ, 
                      feb_strk_prc,
                      feb_exrc_rqst_typ, 
                      NVL( feb_exrc_qty, 0 ), 
                      feb_exrc_stts,
                      to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                      NVL( feb_ack_nmbr, ' ' ),
                      NVL( feb_curr_mkt_prc, 0 ),
                      NVL( feb_channel , '*'),                                 ***1.1***
                      NVL( feb_bp_id , ' '),                                   ***1.1***
                      feb_pipe_id,                                             ***1.4***
                      0.00      ***  Ver 1.8 ***
                FROM  feb_fo_exrc_rqst_book_hstry,FDM_DT_MTCH 
               WHERE  feb_clm_mtch_accnt = FDM_CLM_MTCH_ACCNT
              *** WHERE  feb_clm_mtch_accnt = :c_mtch_accnt_no ****
                 AND  feb_xchng_cd       = :c_exchange_cd
                 AND  feb_prdct_typ   LIKE :c_product_typ
                 AND  feb_exrc_stts   LIKE :c_exrc_stts 
                 AND  feb_exrc_rfrnc_no >=    :c_min_ref_num 
                 AND  feb_exrc_rfrnc_no <     :c_max_ref_num
      UNION ALL

        SELECT fec_clm_mtch_accnt,                                      ***Ver 1.5***
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                              ***1.1***
               ' ',                                                     ***1.1***
               ' ',                                                     ***1.1***
               '*',                                                     ***1.4***
							( NVL(fec_brkg_val,0)     ***  Ver 1.8 ***
                + NVL(fec_stt,0)
                + NVL(fec_src_tx,0)
                + NVL(fec_sebi_tt,0)
                + NVL(fec_tran_chrg,0)
                + NVL(fec_stamp_duty,0)
                + NVL(fec_other_chrg,0)
               )
        FROM fec_fo_exrc_conf,FDM_DT_MTCH
        WHERE  fec_clm_mtch_accnt = FDM_CLM_MTCH_ACCNT
        *** where  fec_clm_mtch_accnt = :c_mtch_accnt_no ***
          AND fec_xchng_cd = :c_exchange_cd
          AND fec_prdct_typ LIKE :c_product_typ
          AND fec_exrc_init = 'E'
          AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
          AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')

      UNION ALL

        SELECT fec_clm_mtch_accnt,                                    ***Ver 1.5***
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                              ***1.1***
               ' ',                                                     ***1.1**
               ' ',                                                     ***1.1***
               '*',                                                     ***1.4***
							 ( NVL(fec_brkg_val,0)     ***  Ver 1.8 ***
                + NVL(fec_stt,0)
                + NVL(fec_src_tx,0)
                + NVL(fec_sebi_tt,0)
                + NVL(fec_tran_chrg,0)
                + NVL(fec_stamp_duty,0)
                + NVL(fec_other_chrg,0)
               )
        FROM fec_fo_exrc_conf_hstry,FDM_DT_MTCH
        WHERE  fec_clm_mtch_accnt = FDM_CLM_MTCH_ACCNT
       ***  where fec_clm_mtch_accnt = :c_mtch_accnt_no ***
          AND fec_xchng_cd = :c_exchange_cd
          AND fec_prdct_typ LIKE :c_product_typ
          AND fec_exrc_init = 'E'
          AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
          AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')
          ****order by 13,14 desc;****
          order by 1 desc;
        END;
      END-EXEC;

		Commented For Ver 1.9 Ends ****/
		
		/*** Ver 1.9 Starts ***/
		if( st_usr_prfl.c_user_id[0] == BPID )
		{
			  EXEC SQL  EXECUTE
        BEGIN
        OPEN  :sys_cursor FOR
              SELECT  feb_clm_mtch_accnt,                                 /***Ver 1.5***/
                      feb_exrc_rfrnc_no, 
                      feb_xchng_cd, 
                      feb_prdct_typ,
                      feb_indstk,
                      feb_undrlyng, 
                      to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                      feb_exer_typ, 
                      feb_opt_typ, 
                      feb_strk_prc,
                      feb_exrc_rqst_typ, 
                      NVL( feb_exrc_qty, 0 ), 
                      feb_exrc_stts,
                      to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                      NVL( feb_ack_nmbr, ' ' ),
                      NVL( feb_curr_mkt_prc, 0 ),
                      NVL( feb_channel , '*'),                                  /***1.1***/
                      NVL( feb_bp_id , ' '),                                    /***1.1***/
                      feb_pipe_id,                                              /***1.4***/
                      0.00                                                      /***  Ver 1.8 ***/
                 /***  FROM  feb_fo_exrc_rqst_book,FDM_DT_MTCH 
                 WHERE  feb_clm_mtch_accnt   = FDM_CLM_MTCH_ACCNT  
                 WHERE  feb_clm_mtch_accnt   = :c_mtch_accnt_no ***/
								 FROM   feb_fo_exrc_rqst_book, CLM_CLNT_MSTR
                 WHERE  feb_clm_mtch_accnt   =  clm_mtch_accnt
                /* AND    feb_xchng_cd         = :c_exchange_cd			*** Ver 2.0 comment***/
                 AND    feb_xchng_cd         LIKE :c_exchange_cd		/*** Ver 2.0***/
                 AND    feb_prdct_typ     LIKE :c_product_typ
                 AND    feb_exrc_stts     LIKE :c_exrc_stts 
                 AND    feb_exrc_rfrnc_no   >= :c_min_ref_num 
                 AND    feb_exrc_rfrnc_no   <  :c_max_ref_num 
								 AND    clm_bp_id            = :c_user_id
  
               UNION ALL
  
               SELECT feb_clm_mtch_accnt,                                     /***Ver 1.5***/
                      feb_exrc_rfrnc_no, 
                      feb_xchng_cd, 
                      feb_prdct_typ,
                      feb_indstk,
                      feb_undrlyng, 
                      to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                      feb_exer_typ, 
                      feb_opt_typ, 
                      feb_strk_prc,
                      feb_exrc_rqst_typ, 
                      NVL( feb_exrc_qty, 0 ), 
                      feb_exrc_stts,
                      to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                      NVL( feb_ack_nmbr, ' ' ),
                      NVL( feb_curr_mkt_prc, 0 ),
                      NVL( feb_channel , '*'),                                  /***1.1***/
                      NVL( feb_bp_id , ' '),                                    /***1.1***/
                      feb_pipe_id,                                              /***1.4***/
                      0.00                                                      /***  Ver 1.8 ***/
               /***    FROM  feb_fo_exrc_rqst_book_hstry,FDM_DT_MTCH 
               WHERE  feb_clm_mtch_accnt = FDM_CLM_MTCH_ACCNT   ***/
							 FROM   feb_fo_exrc_rqst_book_hstry, CLM_CLNT_MSTR
               WHERE  feb_clm_mtch_accnt = clm_mtch_accnt
               /*** WHERE  feb_clm_mtch_accnt = :c_mtch_accnt_no ****/
               /***AND    feb_xchng_cd       = :c_exchange_cd					*** Ver 2.0 comment****/
               AND    feb_xchng_cd       = :c_exchange_cd							/** Ver 2.0***/
               AND    feb_prdct_typ   LIKE :c_product_typ
               AND    feb_exrc_stts   LIKE :c_exrc_stts 
               AND    feb_exrc_rfrnc_no >= :c_min_ref_num 
               AND    feb_exrc_rfrnc_no <  :c_max_ref_num
						   AND    clm_bp_id          = :c_user_id

      UNION ALL

        SELECT fec_clm_mtch_accnt,                                      /***Ver 1.5***/
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
               ' ',                                                     /***1.1***/
               ' ',                                                     /***1.1***/
               '*',                                                     /***1.4***/
							( NVL(fec_brkg_val,0)     /***  Ver 1.8 ***/
                + NVL(fec_stt,0)
                + NVL(fec_src_tx,0)
                + NVL(fec_sebi_tt,0)
                + NVL(fec_tran_chrg,0)
                + NVL(fec_stamp_duty,0)
                + NVL(fec_other_chrg,0)
               )
          /***  FROM fec_fo_exrc_conf,FDM_DT_MTCH
          WHERE  fec_clm_mtch_accnt = FDM_CLM_MTCH_ACCNT
          where  fec_clm_mtch_accnt = :c_mtch_accnt_no ***/
					FROM   fec_fo_exrc_conf, CLM_CLNT_MSTR
          WHERE  fec_clm_mtch_accnt = clm_mtch_accnt
          /**AND    fec_xchng_cd       = :c_exchange_cd					*** Ver 2.0 comment ****/
          AND    fec_xchng_cd       LIKE :c_exchange_cd						/** Ver 2.0 ***/
          AND    fec_prdct_typ LIKE   :c_product_typ
          AND    fec_exrc_init      = 'E'
          AND    fec_exrc_dt       >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
          AND    fec_exrc_dt       <= to_date(:c_to_dt , 'dd-Mon-yyyy')
					AND    clm_bp_id          = :c_user_id

      UNION ALL

        SELECT fec_clm_mtch_accnt,                                     /***Ver 1.5***/
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
               ' ',                                                     /***1.1***/
               ' ',                                                     /***1.1***/
               '*',                                                     /***1.4***/
							 ( NVL(fec_brkg_val,0)                                    /***  Ver 1.8 ***/
                + NVL(fec_stt,0)
                + NVL(fec_src_tx,0)
                + NVL(fec_sebi_tt,0)
                + NVL(fec_tran_chrg,0)
                + NVL(fec_stamp_duty,0)
                + NVL(fec_other_chrg,0)
               )
          /**  FROM fec_fo_exrc_conf_hstry,FDM_DT_MTCH
          WHERE  fec_clm_mtch_accnt = FDM_CLM_MTCH_ACCNT 
          where  fec_clm_mtch_accnt = :c_mtch_accnt_no ***/
					FROM   fec_fo_exrc_conf_hstry, CLM_CLNT_MSTR
          WHERE  fec_clm_mtch_accnt = clm_mtch_accnt
          /***AND    fec_xchng_cd       = :c_exchange_cd				**** Ver 2.0 comment****/
          AND    fec_xchng_cd       LIKE :c_exchange_cd						/*** Ver 2.0 ***/
          AND    fec_prdct_typ   LIKE :c_product_typ
          AND    fec_exrc_init      = 'E'
          AND    fec_exrc_dt       >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
          AND    fec_exrc_dt       <= to_date(:c_to_dt , 'dd-Mon-yyyy')
					AND    clm_bp_id          = :c_user_id
          /****order by 13,14 desc;****/
          order by 1 desc;
        END;
        END-EXEC;

	
		}
		else
		{
			  EXEC SQL  EXECUTE
        BEGIN
        OPEN  :sys_cursor FOR
              SELECT  feb_clm_mtch_accnt,                                 /***Ver 1.5***/
                      feb_exrc_rfrnc_no, 
                      feb_xchng_cd, 
                      feb_prdct_typ,
                      feb_indstk,
                      feb_undrlyng, 
                      to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                      feb_exer_typ, 
                      feb_opt_typ, 
                      feb_strk_prc,
                      feb_exrc_rqst_typ, 
                      NVL( feb_exrc_qty, 0 ), 
                      feb_exrc_stts,
                      to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                      NVL( feb_ack_nmbr, ' ' ),
                      NVL( feb_curr_mkt_prc, 0 ),
                      NVL( feb_channel , '*'),                                  /***1.1***/
                      NVL( feb_bp_id , ' '),                                    /***1.1***/
                      feb_pipe_id,                                              /***1.4***/
                      0.00                                                      /***  Ver 1.8 ***/
                 /***  FROM  feb_fo_exrc_rqst_book,FDM_DT_MTCH 
                 WHERE  feb_clm_mtch_accnt = FDM_CLM_MTCH_ACCNT 
                 WHERE  feb_clm_mtch_accnt = :c_mtch_accnt_no ***/
                 FROM   feb_fo_exrc_rqst_book,uac_usr_accnts
                 WHERE  feb_clm_mtch_accnt = uac_clm_mtch_accnt
                 /**AND    feb_xchng_cd       = :c_exchange_cd					**** Ver 2.0 comment***/
                 AND    feb_xchng_cd       LIKE :c_exchange_cd							/*** Ver 2.0***/
                 AND    feb_prdct_typ   LIKE :c_product_typ
                 AND    feb_exrc_stts   LIKE :c_exrc_stts 
                 AND    feb_exrc_rfrnc_no >= :c_min_ref_num 
                 AND    feb_exrc_rfrnc_no <  :c_max_ref_num 
								 AND    uac_usr_id         = :c_user_id
  
        UNION ALL
  
              SELECT  feb_clm_mtch_accnt,                                     /***Ver 1.5***/
                      feb_exrc_rfrnc_no, 
                      feb_xchng_cd, 
                      feb_prdct_typ,
                      feb_indstk,
                      feb_undrlyng, 
                      to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                      feb_exer_typ, 
                      feb_opt_typ, 
                      feb_strk_prc,
                      feb_exrc_rqst_typ, 
                      NVL( feb_exrc_qty, 0 ), 
                      feb_exrc_stts,
                      to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                      NVL( feb_ack_nmbr, ' ' ),
                      NVL( feb_curr_mkt_prc, 0 ),
                      NVL( feb_channel , '*'),                                /***1.1***/
                      NVL( feb_bp_id , ' '),                                  /***1.1***/
                      feb_pipe_id,                                            /***1.4***/
                      0.00                                                    /***  Ver 1.8 ***/
                 /***  FROM  feb_fo_exrc_rqst_book_hstry,FDM_DT_MTCH 
                 WHERE  feb_clm_mtch_accnt   = FDM_CLM_MTCH_ACCNT  
                 WHERE  feb_clm_mtch_accnt   = :c_mtch_accnt_no ****/
								 FROM   feb_fo_exrc_rqst_book_hstry,uac_usr_accnts
                 WHERE  feb_clm_mtch_accnt   = uac_clm_mtch_accnt
                 /***AND    feb_xchng_cd         = :c_exchange_cd				**** Ver 2.0 comment**/
                 AND    feb_xchng_cd         LIKE :c_exchange_cd						/** Ver 2.0 ***/
                 AND    feb_prdct_typ     LIKE :c_product_typ
                 AND    feb_exrc_stts     LIKE :c_exrc_stts 
                 AND    feb_exrc_rfrnc_no   >= :c_min_ref_num 
                 AND    feb_exrc_rfrnc_no   <  :c_max_ref_num
								 AND    uac_usr_id           = :c_user_id

      UNION ALL

        SELECT fec_clm_mtch_accnt,                                      /***Ver 1.5***/
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
               ' ',                                                     /***1.1***/
               ' ',                                                     /***1.1***/
               '*',                                                     /***1.4***/
							( NVL(fec_brkg_val,0)                                     /***  Ver 1.8 ***/
                + NVL(fec_stt,0)
                + NVL(fec_src_tx,0)
                + NVL(fec_sebi_tt,0)
                + NVL(fec_tran_chrg,0)
                + NVL(fec_stamp_duty,0)
                + NVL(fec_other_chrg,0)
               )
          /*** FROM fec_fo_exrc_conf,FDM_DT_MTCH
          WHERE  fec_clm_mtch_accnt = FDM_CLM_MTCH_ACCNT  ***/
				  FROM   fec_fo_exrc_conf, uac_usr_accnts
          WHERE  fec_clm_mtch_accnt = uac_clm_mtch_accnt
          /*** where  fec_clm_mtch_accnt = :c_mtch_accnt_no ***/
         /** AND    fec_xchng_cd       = :c_exchange_cd						*** Ver 2.0 comment***/
          AND    fec_xchng_cd       LIKE :c_exchange_cd						/*** Ver 2.0 ***/
          AND    fec_prdct_typ   LIKE :c_product_typ
          AND    fec_exrc_init      = 'E'
          AND    fec_exrc_dt       >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
          AND    fec_exrc_dt       <= to_date(:c_to_dt , 'dd-Mon-yyyy')
					AND    uac_usr_id         = :c_user_id

      UNION ALL

        SELECT fec_clm_mtch_accnt,                                    /***Ver 1.5***/
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
               ' ',                                                     /***1.1***/
               ' ',                                                     /***1.1***/
               '*',                                                     /***1.4***/
							 ( NVL(fec_brkg_val,0)                                    /***  Ver 1.8 ***/
                + NVL(fec_stt,0)
                + NVL(fec_src_tx,0)
                + NVL(fec_sebi_tt,0)
                + NVL(fec_tran_chrg,0)
                + NVL(fec_stamp_duty,0)
                + NVL(fec_other_chrg,0)
               )
          /***  FROM fec_fo_exrc_conf_hstry,FDM_DT_MTCH
          WHERE  fec_clm_mtch_accnt = FDM_CLM_MTCH_ACCNT   
          where  fec_clm_mtch_accnt = :c_mtch_accnt_no ***/
					FROM   fec_fo_exrc_conf_hstry, uac_usr_accnts
          WHERE  fec_clm_mtch_accnt = uac_clm_mtch_accnt
          /**AND    fec_xchng_cd       = :c_exchange_cd							**** Ver 2.0 comment ***/
          AND    fec_xchng_cd       LIKE :c_exchange_cd							/** Ver 2.0***/
          AND    fec_prdct_typ   LIKE :c_product_typ
          AND    fec_exrc_init      = 'E'
          AND    fec_exrc_dt       >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
          AND    fec_exrc_dt       <= to_date(:c_to_dt , 'dd-Mon-yyyy')
					AND    uac_usr_id         = :c_user_id
          /****order by 13,14 desc;****/
          order by 1 desc;
        END;
        END-EXEC;
		}
		/*** Ver 1.9 Ends ***/
		
    }
  } /*** End of multiple match id's , Ver 1.5 Ends**/
  else 
  {
    if ( c_opr_typ == CONTRACT_IP )
    {
    	fn_userlog(c_ServiceName,"Inside c_opr_typ == CONTRACT_IP");  
     	EXEC SQL  EXECUTE
        BEGIN
         	OPEN  :sys_cursor FOR
            	 SELECT  feb_clm_mtch_accnt,                                   /***Ver 1.5***/
              	       feb_exrc_rfrnc_no, 
                	     feb_xchng_cd, 
                      feb_prdct_typ, 
                      feb_indstk, 
                      feb_undrlyng, 
                      to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                      feb_exer_typ,
                      feb_opt_typ, 
                      feb_strk_prc, 
                      feb_exrc_rqst_typ, 
                      NVL( feb_exrc_qty, 0 ),
                      feb_exrc_stts, 
                      to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                      NVL( feb_ack_nmbr, ' ' ),
                      NVL( feb_curr_mkt_prc, 0 ),
                      NVL( feb_channel , '*'),                                  /***1.1***/
                      NVL( feb_bp_id , ' '),                                    /***1.1***/                     
                      feb_pipe_id,                                                /***1.4***/
                      0.00
              FROM    feb_fo_exrc_rqst_book
             WHERE    feb_clm_mtch_accnt = :c_mtch_accnt_no
              /** AND    feb_xchng_cd       = :c_exchange_cd				**** Ver 2.0 comment***/
               AND    feb_xchng_cd       LIKE :c_exchange_cd						/** Ver 2.0 ***/
               AND    feb_prdct_typ      = :c_product_typ
               AND    feb_undrlyng       = :c_underlying
               AND    feb_expry_dt       = to_date( :c_expiry_dt,'dd-mon-yyyy')
               AND    feb_exer_typ       = :c_exercise_type
               AND    feb_opt_typ        = :c_option_type
               AND    feb_strk_prc       = :li_strike_price
               AND    feb_exrc_stts   LIKE :c_exrc_stts

      UNION ALL

        SELECT fec_clm_mtch_accnt,                    /***Ver 1.5***/
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),
               ' ',                                   /***1.1***/
               '  ',                                  /***1.1***/
               '*',                                   /***1.4***/
 /*  1.7 */    (      NVL(fec_brkg_val,0)
 										+ NVL(fec_stt,0)
										+ NVL(fec_src_tx,0)
										+ NVL(fec_sebi_tt,0)
										+ NVL(fec_tran_chrg,0)
										+ NVL(fec_stamp_duty,0)
										+ NVL(fec_other_chrg,0)
								)
        FROM fec_fo_exrc_conf
        where fec_clm_mtch_accnt = :c_mtch_accnt_no
         /** AND fec_xchng_cd = :c_exchange_cd					*** Ver 2.0 comment ***/
          AND fec_xchng_cd  LIKE :c_exchange_cd					/*** Ver 2.0***/
          AND fec_prdct_typ = :c_product_typ
          AND fec_undrlyng = :c_underlying
          AND fec_expry_dt = to_date( :c_expiry_dt,'dd-mon-yyyy')
          AND fec_exer_typ = :c_exercise_type
          AND fec_opt_typ = :c_option_type
          AND fec_strk_prc = :li_strike_price
          AND fec_exrc_init = 'E'
          order by 13,14 desc;

      END;
      END-EXEC;
    }
    else if ( c_opr_typ == CONTRACT_AND_DATE_IP )
    {
    fn_userlog(c_ServiceName,"Inside c_opr_typ == CONTRACT_AND_DATE_IP");
      if ( c_date_flag == 'N' )
      {
        fn_userlog( c_ServiceName,"From/To Dates are not Found in the Buffer" );
        strcpy(c_errmsg,"From/To Dates are not Found in the Buffer");
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
        /** tpcommit(0); commented for Ver 1.9 **/
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

    li_rec_cnt_contract_date = 0;
      EXEC SQL
          SELECT    1
            INTO    :li_rec_cnt_contract_date
          FROM      dual
          WHERE     EXISTS
          (
          SELECT    1
            FROM    feb_fo_exrc_rqst_book_hstry
           WHERE    feb_clm_mtch_accnt = :c_mtch_accnt_no
             /*AND    feb_xchng_cd       = :c_exchange_cd			*** Ver 2.0 comment***/
             AND    feb_xchng_cd       LIKE :c_exchange_cd				/*** Ver 2.0***/
             AND    feb_prdct_typ      = :c_product_typ
             AND    feb_undrlyng       = :c_underlying
             AND    feb_expry_dt       = to_date( :c_expiry_dt,'dd-mon-yyyy')
             AND    feb_exer_typ       = :c_exercise_type
             AND    feb_opt_typ        = :c_option_type
             AND    feb_strk_prc       = :li_strike_price
             AND    feb_exrc_stts   LIKE :c_exrc_stts 
             AND    feb_exrc_rfrnc_no >=    :c_min_ref_num 
             AND    feb_exrc_rfrnc_no <     :c_max_ref_num
          ); 

      if ( ( SQLCODE !=0 ) && ( SQLCODE != NO_DATA_FOUND ) )
      { 
      fn_errlog( c_ServiceName, "S31070", SQLMSG, c_errmsg  );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
      /** tpcommit(0); commented for Ver 1.9 **/
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

    li_rec_cnt_conf_date = 0;
      EXEC SQL
          SELECT    1
            INTO    :li_rec_cnt_conf_date
          FROM      dual
          WHERE     EXISTS
          (
          SELECT    1
            FROM fec_fo_exrc_conf_hstry
            where fec_clm_mtch_accnt = :c_mtch_accnt_no
              /*AND fec_xchng_cd = :c_exchange_cd			**** Ver 2.0 comment***/
              AND fec_xchng_cd  LIKE :c_exchange_cd				/*** Ver 2.0***/
              AND fec_prdct_typ = :c_product_typ
              AND fec_undrlyng = :c_underlying
              AND fec_expry_dt = to_date( :c_expiry_dt,'dd-mon-yyyy')
              AND fec_exer_typ = :c_exercise_type
              AND fec_opt_typ = :c_option_type
              AND fec_strk_prc = :li_strike_price
              AND fec_exrc_init = 'E'
              AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
              AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')
          ); 

      if ( ( SQLCODE !=0 ) && ( SQLCODE != NO_DATA_FOUND ) )
      { 
        fn_errlog( c_ServiceName, "S31075", SQLMSG, c_errmsg  );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
        /** tpcommit(0); commented for Ver 1.9 **/
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      if ( ( li_rec_cnt_contract_date != 1 ) && ( li_rec_cnt_conf_date != 1 ) )
      {
        EXEC SQL  EXECUTE
          BEGIN
            OPEN  :sys_cursor FOR
                SELECT  feb_clm_mtch_accnt,                                     /***Ver 1.5***/
                        feb_exrc_rfrnc_no, 
                        feb_xchng_cd, 
                        feb_prdct_typ,
                        feb_indstk,
                        feb_undrlyng, 
                        to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                        feb_exer_typ, 
                        feb_opt_typ, 
                        feb_strk_prc,
                        feb_exrc_rqst_typ, 
                        NVL( feb_exrc_qty, 0 ), 
                        feb_exrc_stts,
                        to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                        NVL( feb_ack_nmbr, ' ' ),
                      NVL( feb_curr_mkt_prc, 0 ),
                      NVL( feb_channel , '*'),                                    /***1.1***/
                      NVL( feb_bp_id , ' ') ,
                      feb_pipe_id,                                               /***1.4***/
                      0.00
                FROM  feb_fo_exrc_rqst_book 
               WHERE  feb_clm_mtch_accnt = :c_mtch_accnt_no
                /*** AND  feb_xchng_cd       = :c_exchange_cd				*** Ver 2.0 comment **/
                 AND  feb_xchng_cd       LIKE :c_exchange_cd						/*** Ver 2.0***/
                 AND  feb_prdct_typ      = :c_product_typ
                 AND  feb_undrlyng       = :c_underlying
                 AND  feb_expry_dt       = to_date( :c_expiry_dt,'dd-mon-yyyy')
                 AND  feb_exer_typ       = :c_exercise_type
                 AND  feb_opt_typ        = :c_option_type
                 AND  feb_strk_prc       = :li_strike_price
                 AND  feb_exrc_stts   LIKE :c_exrc_stts 
                 AND  feb_exrc_rfrnc_no >=    :c_min_ref_num 
                 AND  feb_exrc_rfrnc_no <     :c_max_ref_num
      UNION ALL

          SELECT fec_clm_mtch_accnt,                                    /***Ver 1.5***/ 
                 fec_exrc_rfrnc_no,
                 fec_xchng_cd,
                 fec_prdct_typ,
                 fec_indstk,
                 fec_undrlyng,
                 to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
                 fec_exer_typ,
                 fec_opt_typ,
                 fec_strk_prc,
                 'E',
                 NVL( fec_exrc_qty, 0 ),
                 'E',
                 to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
                 'Exchange Initiated',
                 NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
                 ' ',                                                     /***1.1***/
                 ' ',                                                     /***1.1***/
                 '*',
 /*  1.7 */    (      NVL(fec_brkg_val,0)
 										+ NVL(fec_stt,0)
										+ NVL(fec_src_tx,0)
										+ NVL(fec_sebi_tt,0)
										+ NVL(fec_tran_chrg,0)
										+ NVL(fec_stamp_duty,0)
										+ NVL(fec_other_chrg,0)
								)
            FROM fec_fo_exrc_conf
            where fec_clm_mtch_accnt = :c_mtch_accnt_no
             /** AND fec_xchng_cd = :c_exchange_cd					*** Ver 2.0 comment***/
              AND fec_xchng_cd LIKE  :c_exchange_cd							/*** Ver 2.0***/
              AND fec_prdct_typ = :c_product_typ
              AND fec_undrlyng = :c_underlying
              AND fec_expry_dt = to_date( :c_expiry_dt,'dd-mon-yyyy')
              AND fec_exer_typ = :c_exercise_type
              AND fec_opt_typ = :c_option_type
              AND fec_strk_prc = :li_strike_price
              AND fec_exrc_init = 'E'
              AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
              AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')
            order by 13,14 desc;

          END;
        END-EXEC;
      }
      if ( ( li_rec_cnt_contract_date != 1 ) && ( li_rec_cnt_conf_date == 1 ) )
      {
        EXEC SQL  EXECUTE
          BEGIN
            OPEN  :sys_cursor FOR
              SELECT  feb_clm_mtch_accnt,                                   /***Ver 1.5***/
                      feb_exrc_rfrnc_no, 
                      feb_xchng_cd, 
                      feb_prdct_typ,
                      feb_indstk,
                      feb_undrlyng, 
                      to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                      feb_exer_typ, 
                      feb_opt_typ, 
                      feb_strk_prc,
                      feb_exrc_rqst_typ, 
                      NVL( feb_exrc_qty, 0 ), 
                      feb_exrc_stts,
                      to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                      NVL( feb_ack_nmbr, ' ' ),
                      NVL( feb_curr_mkt_prc, 0 ),
                      NVL( feb_channel , '*'),
                      NVL( feb_bp_id , ' '),
                      feb_pipe_id,                                               /***1.4***/
                      0.00
                FROM  feb_fo_exrc_rqst_book 
               WHERE  feb_clm_mtch_accnt = :c_mtch_accnt_no
                /** AND  feb_xchng_cd       = :c_exchange_cd ****Ver 2.0 comment **/
                 AND  feb_xchng_cd       LIKE  :c_exchange_cd				/*** Ver 2.0***/
                 AND  feb_prdct_typ      = :c_product_typ
                 AND  feb_undrlyng       = :c_underlying
                 AND  feb_expry_dt       = to_date( :c_expiry_dt,'dd-mon-yyyy')
                 AND  feb_exer_typ       = :c_exercise_type
                 AND  feb_opt_typ        = :c_option_type
                 AND  feb_strk_prc       = :li_strike_price
                 AND  feb_exrc_stts   LIKE :c_exrc_stts 
                 AND  feb_exrc_rfrnc_no >=    :c_min_ref_num 
                 AND  feb_exrc_rfrnc_no <     :c_max_ref_num
      UNION ALL

          SELECT fec_clm_mtch_accnt,                                      /***Ver 1.5***/
                 fec_exrc_rfrnc_no,
                 fec_xchng_cd,
                 fec_prdct_typ,
                 fec_indstk,
                 fec_undrlyng,
                 to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
                 fec_exer_typ,
                 fec_opt_typ,
                 fec_strk_prc,
                 'E',
                 NVL( fec_exrc_qty, 0 ),
                 'E',
                 to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
                 'Exchange Initiated',
                 NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
                 ' ',                                                     /***1.1***/
                 ' ',                                                     /***1.1***/
                 '*',                                                     /***1.4***/
 /*  1.7 */    (      NVL(fec_brkg_val,0)
 										+ NVL(fec_stt,0)
										+ NVL(fec_src_tx,0)
										+ NVL(fec_sebi_tt,0)
										+ NVL(fec_tran_chrg,0)
										+ NVL(fec_stamp_duty,0)
										+ NVL(fec_other_chrg,0)
								)
          FROM fec_fo_exrc_conf
          where fec_clm_mtch_accnt = :c_mtch_accnt_no
           /** AND fec_xchng_cd = :c_exchange_cd												**** Ver 2.0comment ***/
            AND fec_xchng_cd 	LIKE  :c_exchange_cd											/*** Ver 2.0***/
            AND fec_prdct_typ = :c_product_typ
            AND fec_undrlyng = :c_underlying
            AND fec_expry_dt = to_date( :c_expiry_dt,'dd-mon-yyyy')
            AND fec_exer_typ = :c_exercise_type
            AND fec_opt_typ = :c_option_type
            AND fec_strk_prc = :li_strike_price
            AND fec_exrc_init = 'E'
            AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
            AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')

      UNION ALL

          SELECT fec_clm_mtch_accnt,                                      /***Ver 1.5***/
                 fec_exrc_rfrnc_no,
                 fec_xchng_cd,
                 fec_prdct_typ,
                 fec_indstk,
                 fec_undrlyng,
                 to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
                 fec_exer_typ,
                 fec_opt_typ,
                 fec_strk_prc,
                 'E',
                 NVL( fec_exrc_qty, 0 ),
                 'E',
                 to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
                 'Exchange Initiated',
                 NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
                 ' ',                                                     /***1.1***/
                 ' ',                                                     /***1.1***/
                 '*',                                                     /***1.4***/
 /*  1.7 */    (      NVL(fec_brkg_val,0)
 										+ NVL(fec_stt,0)
										+ NVL(fec_src_tx,0)
										+ NVL(fec_sebi_tt,0)
										+ NVL(fec_tran_chrg,0)
										+ NVL(fec_stamp_duty,0)
										+ NVL(fec_other_chrg,0)
								)
            FROM fec_fo_exrc_conf_hstry
            where fec_clm_mtch_accnt = :c_mtch_accnt_no
             /** AND fec_xchng_cd = :c_exchange_cd										**** Ver 2.0 comment***/
              AND fec_xchng_cd 	LIKE :c_exchange_cd												/*** Ver 2.0***/
              AND fec_prdct_typ = :c_product_typ
              AND fec_undrlyng = :c_underlying
              AND fec_expry_dt = to_date( :c_expiry_dt,'dd-mon-yyyy')
              AND fec_exer_typ = :c_exercise_type
              AND fec_opt_typ = :c_option_type
              AND fec_strk_prc = :li_strike_price
              AND fec_exrc_init = 'E'
              AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
              AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')
            order by 13,14 desc;

          END;
        END-EXEC;

      }
      else
      {
        EXEC SQL  EXECUTE
          BEGIN
            OPEN  :sys_cursor FOR
              SELECT  feb_clm_mtch_accnt,                                         /***Ver 1.5***/
                      feb_exrc_rfrnc_no, 
                      feb_xchng_cd, 
                      feb_prdct_typ,
                      feb_indstk,
                      feb_undrlyng, 
                      to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                      feb_exer_typ, 
                      feb_opt_typ, 
                      feb_strk_prc,
                      feb_exrc_rqst_typ, 
                      NVL( feb_exrc_qty, 0 ), 
                      feb_exrc_stts,
                      to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                      NVL( feb_ack_nmbr, ' ' ),
                      NVL( feb_curr_mkt_prc, 0 ),                                   /***1.1***/
                      NVL( feb_channel , '*'),                                      /***1.1***/
                      NVL( feb_bp_id , ' '),                                        /***1.1***/
                      feb_pipe_id,                                                  /***1.4***/
                      0.00
                FROM  feb_fo_exrc_rqst_book
               WHERE  feb_clm_mtch_accnt = :c_mtch_accnt_no
                /* AND  feb_xchng_cd       = :c_exchange_cd						*** Ver 2.0 comment***/
                 AND  feb_xchng_cd       LIKE  :c_exchange_cd							/*** Ver 2.0***/
                 AND  feb_prdct_typ      = :c_product_typ
                 AND  feb_undrlyng       = :c_underlying
                 AND  feb_expry_dt       = to_date( :c_expiry_dt,'dd-mon-yyyy')
                 AND  feb_exer_typ       = :c_exercise_type
                 AND  feb_opt_typ        = :c_option_type
                 AND  feb_strk_prc       = :li_strike_price
                 AND  feb_exrc_stts   LIKE :c_exrc_stts 
                 AND  feb_exrc_rfrnc_no >=    :c_min_ref_num 
                 AND  feb_exrc_rfrnc_no <     :c_max_ref_num 

               UNION ALL      
      
              SELECT  feb_clm_mtch_accnt,                                     /***Ver 1.5***/
                      feb_exrc_rfrnc_no, 
                      feb_xchng_cd, 
                      feb_prdct_typ,
                      feb_indstk,
                      feb_undrlyng, 
                      to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                      feb_exer_typ, 
                      feb_opt_typ, 
                      feb_strk_prc,
                      feb_exrc_rqst_typ, 
                      NVL( feb_exrc_qty, 0 ), 
                      feb_exrc_stts,
                      to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                      NVL( feb_ack_nmbr, ' ' ),
                      NVL( feb_curr_mkt_prc, 0 ),
                      NVL( feb_channel , '*'),
                      NVL( feb_bp_id , ' '),
                      feb_pipe_id,                                               /***1.4***/
                      0.00
                FROM  feb_fo_exrc_rqst_book_hstry 
               WHERE  feb_clm_mtch_accnt = :c_mtch_accnt_no
                /*** AND  feb_xchng_cd       = :c_exchange_cd						**** Ver 2.0 comment*/
                 AND  feb_xchng_cd       LIKE :c_exchange_cd								/*** Ver 2.0***/
                 AND  feb_prdct_typ      = :c_product_typ
                 AND  feb_undrlyng       = :c_underlying
                 AND  feb_expry_dt       = to_date( :c_expiry_dt,'dd-mon-yyyy')
                 AND  feb_exer_typ       = :c_exercise_type
                 AND  feb_opt_typ        = :c_option_type
                 AND  feb_strk_prc       = :li_strike_price
                 AND  feb_exrc_stts   LIKE :c_exrc_stts 
                 AND  feb_exrc_rfrnc_no >=    :c_min_ref_num 
                 AND  feb_exrc_rfrnc_no <     :c_max_ref_num
      UNION ALL

        SELECT fec_clm_mtch_accnt,                                    /***Ver 1.5***/
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
               ' ',                                                     /***1.1***/
               ' ',                                                     /***1.1***/
               '*',                                                       /***1.4***/
 /*  1.7 */    (      NVL(fec_brkg_val,0)
 										+ NVL(fec_stt,0)
										+ NVL(fec_src_tx,0)
										+ NVL(fec_sebi_tt,0)
										+ NVL(fec_tran_chrg,0)
										+ NVL(fec_stamp_duty,0)
										+ NVL(fec_other_chrg,0)
								)
        FROM fec_fo_exrc_conf
        where fec_clm_mtch_accnt = :c_mtch_accnt_no
         /** AND fec_xchng_cd = :c_exchange_cd														***Ver 2.0 comment**/
          AND fec_xchng_cd LIKE :c_exchange_cd															/*** Ver 2.0***/
          AND fec_prdct_typ = :c_product_typ
          AND fec_undrlyng = :c_underlying
          AND fec_expry_dt = to_date( :c_expiry_dt,'dd-mon-yyyy')
          AND fec_exer_typ = :c_exercise_type
          AND fec_opt_typ = :c_option_type
          AND fec_strk_prc = :li_strike_price
          AND fec_exrc_init = 'E'
          AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
          AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')

      UNION ALL

        SELECT fec_clm_mtch_accnt,                                    /***Ver 1.5***/
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
               ' ',                                                     /***1.1***/
               ' ',                                                     /***1.1***/
               '*',                                                       /***1.4***/
 /*  1.7 */    (      NVL(fec_brkg_val,0)
 										+ NVL(fec_stt,0)
										+ NVL(fec_src_tx,0)
										+ NVL(fec_sebi_tt,0)
										+ NVL(fec_tran_chrg,0)
										+ NVL(fec_stamp_duty,0)
										+ NVL(fec_other_chrg,0)
								)
          FROM fec_fo_exrc_conf_hstry
          where fec_clm_mtch_accnt = :c_mtch_accnt_no
           /* AND fec_xchng_cd = :c_exchange_cd						**** Ver 2.0 comment****/
            AND fec_xchng_cd LIKE  :c_exchange_cd				/*** Ver 2.0***/
            AND fec_prdct_typ = :c_product_typ
            AND fec_undrlyng = :c_underlying
            AND fec_expry_dt = to_date( :c_expiry_dt,'dd-mon-yyyy')
            AND fec_exer_typ = :c_exercise_type
            AND fec_opt_typ = :c_option_type
            AND fec_strk_prc = :li_strike_price
            AND fec_exrc_init = 'E'
            AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
            AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')
            order by 13,14 desc;
          END;
        END-EXEC;
      }
    }
    else if ( c_opr_typ == UNDERLYING_IP )
    {
    fn_userlog(c_ServiceName,"Inside c_opr_typ == UNDERLYING_IP");
      EXEC SQL  EXECUTE
          BEGIN
            OPEN  :sys_cursor FOR
              SELECT  feb_clm_mtch_accnt,                                      /***Ver 1.5***/
                      feb_exrc_rfrnc_no, 
                      feb_xchng_cd, 
                      feb_prdct_typ, 
                      feb_indstk, 
                      feb_undrlyng, 
                      to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                      feb_exer_typ,
                      feb_opt_typ, 
                      feb_strk_prc, 
                      feb_exrc_rqst_typ, 
                      NVL( feb_exrc_qty, 0 ),
                      feb_exrc_stts, 
                      to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                      NVL( feb_ack_nmbr, ' ' ),
                      NVL( feb_curr_mkt_prc, 0 ),                                 /***1.1***/
                      NVL( feb_channel , '*'),                                    /***1.1***/
                      NVL( feb_bp_id , ' '),                                      /***1.1***/
                      feb_pipe_id,                                                /***1.4***/
                      0.00
             FROM   feb_fo_exrc_rqst_book
             WHERE    feb_clm_mtch_accnt = :c_mtch_accnt_no
               /**AND    feb_xchng_cd       = :c_exchange_cd			*** Ver 2.0 comment***/
               AND    feb_xchng_cd       LIKE :c_exchange_cd					/*** Ver 2.0***/
               AND    feb_undrlyng       = :c_underlying
               AND    feb_prdct_typ   LIKE :c_product_typ
               AND    feb_exrc_stts   LIKE :c_exrc_stts
      UNION ALL

        SELECT fec_clm_mtch_accnt,                                      /***Ver 1.5***/
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
               ' ',                                                     /***1.1***/
               ' ',                                                     /***1.1***/
               '*',                                                       /***1.4***/
 /*  1.7 */    (      NVL(fec_brkg_val,0)
 										+ NVL(fec_stt,0)
										+ NVL(fec_src_tx,0)
										+ NVL(fec_sebi_tt,0)
										+ NVL(fec_tran_chrg,0)
										+ NVL(fec_stamp_duty,0)
										+ NVL(fec_other_chrg,0)
								)
          FROM fec_fo_exrc_conf
          where fec_clm_mtch_accnt = :c_mtch_accnt_no
           /* AND fec_xchng_cd = :c_exchange_cd										*** Ver 2.0 Comment **/
            AND fec_xchng_cd  LIKE  :c_exchange_cd											/*** Ver 2.0***/
            AND fec_prdct_typ LIKE :c_product_typ
            AND fec_undrlyng = :c_underlying
            AND fec_exrc_init = 'E'
            order by 13,14 desc;
          END;
        END-EXEC;
    }
    else if ( c_opr_typ == UNDERLYING_AND_DATE_IP )
    {
    fn_userlog(c_ServiceName,"Inside c_opr_typ == UNDERLYING_AND_DATE_IP");
      if ( c_date_flag == 'N' )
      {
        fn_userlog( c_ServiceName,"From/To Dates are not Found in the Buffer" );
        strcpy(c_errmsg,"From/To Dates are not Found in the Buffer");
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
        /** tpcommit(0);  commented for Ver 1.9 **/
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      li_rec_cnt_undrlyng_dt = 0;
      EXEC SQL
          SELECT    1
            INTO    :li_rec_cnt_undrlyng_dt
        FROM      dual
        WHERE     EXISTS
        (
        SELECT    1
          FROM    feb_fo_exrc_rqst_book_hstry
         WHERE    feb_clm_mtch_accnt = :c_mtch_accnt_no
          /** AND    feb_xchng_cd       = :c_exchange_cd				*** Ver 2.0 comment****/
           AND    feb_xchng_cd       LIKE :c_exchange_cd						/*** Ver 2.0***/
           AND    feb_undrlyng       = :c_underlying
           AND    feb_prdct_typ   LIKE :c_product_typ
           AND    feb_exrc_stts   LIKE :c_exrc_stts 
           AND    feb_exrc_rfrnc_no >=    :c_min_ref_num 
           AND    feb_exrc_rfrnc_no <     :c_max_ref_num
        ); 

    if ( ( SQLCODE !=0 ) && ( SQLCODE != NO_DATA_FOUND ) )
    { 
      fn_errlog( c_ServiceName, "S31080", SQLMSG, c_errmsg  );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
      /** tpcommit(0); commented for Ver 1.9 **/
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }


    li_rec_cnt_conf_date = 0;
      EXEC SQL
          SELECT    1
            INTO    :li_rec_cnt_conf_date
          FROM      dual
          WHERE     EXISTS
          (
          SELECT    1
            FROM fec_fo_exrc_conf_hstry
            where fec_clm_mtch_accnt = :c_mtch_accnt_no
             /** AND fec_xchng_cd = :c_exchange_cd				*** Ver 2.0 comment***/
              AND fec_xchng_cd  LIKE  :c_exchange_cd						/*** Ver 2.0***/
              AND fec_prdct_typ LIKE :c_product_typ
              AND fec_undrlyng = :c_underlying
              AND fec_exrc_init = 'E'
              AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
              AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')
          ); 

      if ( ( SQLCODE !=0 ) && ( SQLCODE != NO_DATA_FOUND ) )
      { 
        fn_errlog( c_ServiceName, "S31085", SQLMSG, c_errmsg  );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
        /** tpcommit(0);  commented for Ver 1.9 **/ 
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      if ( ( li_rec_cnt_undrlyng_dt != 1 ) && ( li_rec_cnt_conf_date != 1 ) )
      {
        EXEC SQL  EXECUTE
          BEGIN
            OPEN  :sys_cursor FOR
                 SELECT feb_clm_mtch_accnt,                             /***Ver 1.5***/
                        feb_exrc_rfrnc_no, 
                        feb_xchng_cd, 
                        feb_prdct_typ,
                        feb_indstk,
                        feb_undrlyng, 
                        to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                        feb_exer_typ, 
                        feb_opt_typ, 
                        feb_strk_prc,
                        feb_exrc_rqst_typ, 
                        NVL( feb_exrc_qty, 0 ), 
                        feb_exrc_stts, 
                        to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                        NVL( feb_ack_nmbr, ' ' ),
                        NVL( feb_curr_mkt_prc, 0 ),
                        NVL( feb_channel , '*'),                                    /***1.1***/
                        NVL( feb_bp_id , ' '),                                      /***1.1***/
                        feb_pipe_id,                                                /***1.4***/
                        0.00
                 FROM  feb_fo_exrc_rqst_book
               WHERE  feb_clm_mtch_accnt = :c_mtch_accnt_no
                /** AND  feb_xchng_cd       = :c_exchange_cd				**** Ver 2.0 comment ***/
                 AND  feb_xchng_cd       LIKE  :c_exchange_cd						/*** Ver 2.0***/
                 AND  feb_undrlyng       = :c_underlying
                 AND  feb_prdct_typ   LIKE :c_product_typ
                 AND  feb_exrc_stts   LIKE :c_exrc_stts 
                 AND  feb_exrc_rfrnc_no >=    :c_min_ref_num 
                 AND  feb_exrc_rfrnc_no <     :c_max_ref_num
      UNION ALL

        SELECT fec_clm_mtch_accnt,                             /***Ver 1.5***/
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
               ' ',                                                     /***1.1***/
               ' ',                                                     /***1.1***/
               '*',                                                       /***1.4***/
 /*  1.7 */    (      NVL(fec_brkg_val,0)
 										+ NVL(fec_stt,0)
										+ NVL(fec_src_tx,0)
										+ NVL(fec_sebi_tt,0)
										+ NVL(fec_tran_chrg,0)
										+ NVL(fec_stamp_duty,0)
										+ NVL(fec_other_chrg,0)
								)
        FROM fec_fo_exrc_conf
        where fec_clm_mtch_accnt = :c_mtch_accnt_no
         /** AND fec_xchng_cd = :c_exchange_cd												**** Ver 2.0 comment ***/
          AND fec_xchng_cd 	LIKE  :c_exchange_cd														/*** Ver 2.0***/
          AND fec_prdct_typ LIKE :c_product_typ
          AND fec_undrlyng = :c_underlying
          AND fec_exrc_init = 'E'
          AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
          AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')
          order by 13,14 desc;
        END;
      END-EXEC;
    }
    else if ( ( li_rec_cnt_undrlyng_dt != 1 ) && ( li_rec_cnt_conf_date == 1 ) )
    {
      EXEC SQL  EXECUTE
        BEGIN
          OPEN  :sys_cursor FOR
               SELECT feb_clm_mtch_accnt,                             /***Ver 1.5***/
                      feb_exrc_rfrnc_no, 
                      feb_xchng_cd, 
                      feb_prdct_typ,
                      feb_indstk,
                      feb_undrlyng, 
                      to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                      feb_exer_typ, 
                      feb_opt_typ, 
                      feb_strk_prc,
                      feb_exrc_rqst_typ, 
                      NVL( feb_exrc_qty, 0 ), 
                      feb_exrc_stts, 
                      to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                      NVL( feb_ack_nmbr, ' ' ),
                      NVL( feb_curr_mkt_prc, 0 ),
                      NVL( feb_channel , '*'),                                  /***1.1***/
                      NVL( feb_bp_id , ' '),                                    /***1.1***/             
                      feb_pipe_id,                                                /***1.4***/
                      0.00
                FROM  feb_fo_exrc_rqst_book
               WHERE  feb_clm_mtch_accnt = :c_mtch_accnt_no
                /** AND  feb_xchng_cd       = :c_exchange_cd						**** Ver 2.0 comment**/
                 AND  feb_xchng_cd    LIKE :c_exchange_cd								/*** Ver 2.0***/
                 AND  feb_undrlyng       = :c_underlying
                 AND  feb_prdct_typ   LIKE :c_product_typ
                 AND  feb_exrc_stts   LIKE :c_exrc_stts 
                 AND  feb_exrc_rfrnc_no >=    :c_min_ref_num 
                 AND  feb_exrc_rfrnc_no <     :c_max_ref_num
      UNION ALL

        SELECT fec_clm_mtch_accnt,                             /***Ver 1.5***/
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
               ' ',                                                     /***1.1***/
               ' ',                                                     /***1.1***/
               '*',                                                       /***1.4***/
 /*  1.7 */    (      NVL(fec_brkg_val,0)
 										+ NVL(fec_stt,0)
										+ NVL(fec_src_tx,0)
										+ NVL(fec_sebi_tt,0)
										+ NVL(fec_tran_chrg,0)
										+ NVL(fec_stamp_duty,0)
										+ NVL(fec_other_chrg,0)
								)
        FROM fec_fo_exrc_conf
        where fec_clm_mtch_accnt = :c_mtch_accnt_no
         /** AND fec_xchng_cd = :c_exchange_cd											***Ver 2.0 comment **/
          AND fec_xchng_cd  LIKE :c_exchange_cd													/*** Ver 2.0***/
          AND fec_prdct_typ LIKE :c_product_typ
          AND fec_undrlyng = :c_underlying
          AND fec_exrc_init = 'E'
          AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
          AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')

      UNION ALL

        SELECT fec_clm_mtch_accnt,                             /***Ver 1.5***/
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
               ' ',                                                     /***1.1***/
               ' ',                                                     /***1.1***/
               '*',                                                       /***1.4***/
 /*  1.7 */    (      NVL(fec_brkg_val,0)
 										+ NVL(fec_stt,0)
										+ NVL(fec_src_tx,0)
										+ NVL(fec_sebi_tt,0)
										+ NVL(fec_tran_chrg,0)
										+ NVL(fec_stamp_duty,0)
										+ NVL(fec_other_chrg,0)
								)
        FROM fec_fo_exrc_conf_hstry
        where fec_clm_mtch_accnt = :c_mtch_accnt_no
         /*** AND fec_xchng_cd = :c_exchange_cd													***Ver 2.0 comment ***/
          AND fec_xchng_cd  LIKE  :c_exchange_cd												/*** Ver 2.0***/
          AND fec_prdct_typ LIKE :c_product_typ
          AND fec_undrlyng = :c_underlying
          AND fec_exrc_init = 'E'
          AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
          AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')

          order by 13,14 desc;
        END;
      END-EXEC;

    }
    else
    {
      EXEC SQL  EXECUTE
        BEGIN
          OPEN  :sys_cursor FOR
              SELECT  feb_clm_mtch_accnt,                             /***Ver 1.5***/
                      feb_exrc_rfrnc_no, 
                      feb_xchng_cd, 
                      feb_prdct_typ,
                      feb_indstk,
                      feb_undrlyng, 
                      to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                      feb_exer_typ, 
                      feb_opt_typ, 
                      feb_strk_prc,
                      feb_exrc_rqst_typ, 
                      NVL( feb_exrc_qty, 0 ), 
                      feb_exrc_stts,
                      to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                      NVL( feb_ack_nmbr, ' ' ),
                      NVL( feb_curr_mkt_prc, 0 ),
                      NVL( feb_channel , '*'),                                  /***1.1***/
                      NVL( feb_bp_id , ' '),                                    /***1.1***/
                      feb_pipe_id,                                               /***1.4***/
                      0.00
                FROM  feb_fo_exrc_rqst_book 
               WHERE  feb_clm_mtch_accnt = :c_mtch_accnt_no
                /** AND  feb_xchng_cd       = :c_exchange_cd								*** Ver 2.0 comment***/
                 AND  feb_xchng_cd      LIKE  :c_exchange_cd										/*** Ver 2.0***/
                 AND  feb_undrlyng       = :c_underlying
                 AND  feb_prdct_typ   LIKE :c_product_typ
                 AND  feb_exrc_stts   LIKE :c_exrc_stts 
                 AND  feb_exrc_rfrnc_no >=    :c_min_ref_num 
                 AND  feb_exrc_rfrnc_no <     :c_max_ref_num 

               UNION ALL

              SELECT  feb_clm_mtch_accnt,                             /***Ver 1.5***/
                      feb_exrc_rfrnc_no, 
                      feb_xchng_cd, 
                      feb_prdct_typ,
                      feb_indstk,
                      feb_undrlyng, 
                      to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                      feb_exer_typ, 
                      feb_opt_typ, 
                      feb_strk_prc,
                      feb_exrc_rqst_typ, 
                      NVL( feb_exrc_qty, 0 ), 
                      feb_exrc_stts,
                      to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                      NVL( feb_ack_nmbr, ' ' ),
                      NVL( feb_curr_mkt_prc, 0 ),
                      NVL( feb_channel , '*'),                                  /***1.1***/
                      NVL( feb_bp_id , ' '),                                    /***1.1***/
                      feb_pipe_id,                                               /***1.4***/
                      0.00
                FROM  feb_fo_exrc_rqst_book_hstry 
               WHERE  feb_clm_mtch_accnt = :c_mtch_accnt_no
                /** AND  feb_xchng_cd       = :c_exchange_cd					*** Ver 2.0 comment**/
                 AND  feb_xchng_cd       LIKE  :c_exchange_cd							/*** Ver 2.0***/
                 AND  feb_undrlyng       = :c_underlying
                 AND  feb_prdct_typ   LIKE :c_product_typ
                 AND  feb_exrc_stts   LIKE :c_exrc_stts 
                 AND  feb_exrc_rfrnc_no >=    :c_min_ref_num 
                 AND  feb_exrc_rfrnc_no <     :c_max_ref_num

      UNION ALL

        SELECT fec_clm_mtch_accnt,                             /***Ver 1.5***/
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
               ' ',                                                     /***1.1***/
               ' ',                                                     /***1.1***/
               '*',                                                       /***1.4***/
 /*  1.7 */    (      NVL(fec_brkg_val,0)
 										+ NVL(fec_stt,0)
										+ NVL(fec_src_tx,0)
										+ NVL(fec_sebi_tt,0)
										+ NVL(fec_tran_chrg,0)
										+ NVL(fec_stamp_duty,0)
										+ NVL(fec_other_chrg,0)
								)
        FROM fec_fo_exrc_conf
        where fec_clm_mtch_accnt = :c_mtch_accnt_no
         /** AND fec_xchng_cd = :c_exchange_cd					*** Ver 2.0 comment***/
          AND fec_xchng_cd  LIKE  :c_exchange_cd							/*** Ver 2.0***/
          AND fec_prdct_typ LIKE :c_product_typ
          AND fec_undrlyng = :c_underlying
          AND fec_exrc_init = 'E'
          AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
          AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')

      UNION ALL

        SELECT fec_clm_mtch_accnt,                             /***Ver 1.5***/
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
               ' ',                                                     /***1.1***/
               ' ',                                                     /***1.1***/
               '*',                                                       /***1.4***/
 /*  1.7 */    (      NVL(fec_brkg_val,0)
 										+ NVL(fec_stt,0)
										+ NVL(fec_src_tx,0)
										+ NVL(fec_sebi_tt,0)
										+ NVL(fec_tran_chrg,0)
										+ NVL(fec_stamp_duty,0)
										+ NVL(fec_other_chrg,0)
								)
          FROM fec_fo_exrc_conf_hstry
          where fec_clm_mtch_accnt = :c_mtch_accnt_no
           /** AND fec_xchng_cd = :c_exchange_cd								*** Ver 2.0 comment***/
            AND fec_xchng_cd  lIKE :c_exchange_cd											/*** Ver 2.0***/
            AND fec_prdct_typ LIKE :c_product_typ
            AND fec_undrlyng = :c_underlying
            AND fec_exrc_init = 'E'
            AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
            AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')
            order by 13,14 desc;
          END;
        END-EXEC;
      }
    }
    else if ( c_opr_typ == STATUS_PRODUCT_IP )
    {
    fn_userlog(c_ServiceName,"Inside c_opr_typ == STATUS_PRODUCT_IP");
      EXEC SQL  EXECUTE
          BEGIN
            OPEN  :sys_cursor FOR
                SELECT  feb_clm_mtch_accnt,                             /***Ver 1.5***/
                        feb_exrc_rfrnc_no, 
                        feb_xchng_cd, 
                        feb_prdct_typ, 
                        feb_indstk, 
                        feb_undrlyng, 
                        to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                        feb_exer_typ,
                        feb_opt_typ, 
                        feb_strk_prc, 
                        feb_exrc_rqst_typ, 
                        NVL( feb_exrc_qty, 0 ),
                        feb_exrc_stts, 
                        to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                        NVL( feb_ack_nmbr, ' ' ),
                        NVL( feb_curr_mkt_prc, 0 ),
                        NVL( feb_channel , '*'),                                  /***1.1***/
                        NVL( feb_bp_id , ' '),                                    /***1.1***/
                        feb_pipe_id,                                               /***1.4***/
                        0.00
                FROM    feb_fo_exrc_rqst_book
               WHERE    feb_clm_mtch_accnt = :c_mtch_accnt_no
                /* AND    feb_xchng_cd       = :c_exchange_cd					*** Ver 2.0 comment***/
                 AND    feb_xchng_cd    LIKE :c_exchange_cd						/*** Ver 2.0***/
                 AND    feb_prdct_typ   LIKE :c_product_typ
                 AND    feb_exrc_stts   LIKE :c_exrc_stts
        UNION ALL

          SELECT fec_clm_mtch_accnt,                             /***Ver 1.5***/
                 fec_exrc_rfrnc_no,
                 fec_xchng_cd,
                 fec_prdct_typ,
                 fec_indstk,
                 fec_undrlyng,
                 to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
                 fec_exer_typ,
                 fec_opt_typ,
                 fec_strk_prc,
                 'E',
                 NVL( fec_exrc_qty, 0 ),
                 'E',
                 to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
                 'Exchange Initiated',
                 NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
                 ' ',                                                     /***1.1***/
                 ' ',                                                     /***1.1***/
                 '*',                                                       /***1.4***/
 /*  1.7 */    (      NVL(fec_brkg_val,0)
 										+ NVL(fec_stt,0)
										+ NVL(fec_src_tx,0)
										+ NVL(fec_sebi_tt,0)
										+ NVL(fec_tran_chrg,0)
										+ NVL(fec_stamp_duty,0)
										+ NVL(fec_other_chrg,0)
								)
          FROM fec_fo_exrc_conf
          where fec_clm_mtch_accnt = :c_mtch_accnt_no
           /** AND fec_xchng_cd = :c_exchange_cd								**** Ver 2.0 Comment ***/
            AND fec_xchng_cd LIKE  :c_exchange_cd										/*** Ver 2.0***/
            AND fec_prdct_typ LIKE :c_product_typ
            AND fec_exrc_init = 'E'
            order by 13,14 desc;
          END;
        END-EXEC;
    }
    else if ( c_opr_typ == STATUS_PRODUCT_AND_DATE_IP )
    {
    fn_userlog(c_ServiceName,"Inside c_opr_typ == STATUS_PRODUCT_AND_DATE_IP");
      if ( c_date_flag == 'N' )
      {
        fn_userlog( c_ServiceName,"From/To Dates are not Found in the Buffer" );
        strcpy(c_errmsg,"From/To Dates are not Found in the Buffer");
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
        /** tpcommit(0); commented for Ver 1.9 **/
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }

      li_rec_cnt_status_date = 0;
      EXEC SQL
          SELECT    1
            INTO    :li_rec_cnt_status_date
          FROM      dual
          WHERE     EXISTS
          (
          SELECT    1
            FROM    feb_fo_exrc_rqst_book_hstry
           WHERE    feb_clm_mtch_accnt = :c_mtch_accnt_no
            /** AND    feb_xchng_cd       = :c_exchange_cd		**** Ver 2.0 comment ***/
             AND    feb_xchng_cd    LIKE :c_exchange_cd				/*** Ver 2.0***/
             AND    feb_prdct_typ   LIKE :c_product_typ
             AND    feb_exrc_stts   LIKE :c_exrc_stts 
             AND    feb_exrc_rfrnc_no >=    :c_min_ref_num 
             AND    feb_exrc_rfrnc_no <     :c_max_ref_num
          ); 

      if ( ( SQLCODE !=0 ) && ( SQLCODE != NO_DATA_FOUND ) )
      { 
        fn_errlog( c_ServiceName, "S31090", SQLMSG, c_errmsg  );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
        /** tpcommit(0); commented for Ver 1.9 **/
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }


    li_rec_cnt_conf_date = 0;
      EXEC SQL
          SELECT    1
            INTO    :li_rec_cnt_conf_date
          FROM      dual
          WHERE     EXISTS
          (
          SELECT    1
            FROM fec_fo_exrc_conf_hstry
            where fec_clm_mtch_accnt = :c_mtch_accnt_no
             /** AND fec_xchng_cd = :c_exchange_cd							**** Ver 2.0 comment ***/
              AND fec_xchng_cd  LIKE :c_exchange_cd						  /** Ver 2.0 **/
              AND fec_prdct_typ LIKE :c_product_typ
              AND fec_exrc_init = 'E'
              AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
              AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')
          ); 

      if ( ( SQLCODE !=0 ) && ( SQLCODE != NO_DATA_FOUND ) )
      { 
        fn_errlog( c_ServiceName, "S31095", SQLMSG, c_errmsg  );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
        /** tpcommit(0); commented for Ver 1.9 **/
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
       
      fn_userlog( c_ServiceName,"1226 : li_rec_cnt_status_date : %d",li_rec_cnt_status_date );

      fn_userlog( c_ServiceName,"1228 :li_rec_cnt_conf_date : %d",li_rec_cnt_conf_date );

      if ( ( li_rec_cnt_status_date != 1 ) && ( li_rec_cnt_conf_date != 1 ) )
      {
        
        EXEC SQL  EXECUTE
          BEGIN
            OPEN  :sys_cursor FOR
                SELECT  feb_clm_mtch_accnt,                             /***Ver 1.5***/
                        feb_exrc_rfrnc_no, 
                        feb_xchng_cd, 
                        feb_prdct_typ,
                        feb_indstk,
                        feb_undrlyng, 
                        to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                        feb_exer_typ, 
                        feb_opt_typ, 
                        feb_strk_prc,
                        feb_exrc_rqst_typ, 
                        NVL( feb_exrc_qty, 0 ), 
                        feb_exrc_stts,
                        to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                        NVL( feb_ack_nmbr, ' ' ),
                        NVL( feb_curr_mkt_prc, 0 ),
                        NVL( feb_channel , '*'),                                  /***1.1***/
                        NVL( feb_bp_id , ' '),                                    /***1.1***/
                        feb_pipe_id,                                               /***1.4***/
                        0.00
                  FROM  feb_fo_exrc_rqst_book 
                 WHERE  feb_clm_mtch_accnt = :c_mtch_accnt_no
                  /** AND  feb_xchng_cd       = :c_exchange_cd						**Ver 2.0comment **/
                   AND  feb_xchng_cd    LIKE :c_exchange_cd								/*** Ver 2.0***/
                   AND  feb_prdct_typ   LIKE :c_product_typ
                   AND  feb_exrc_stts   LIKE :c_exrc_stts 
                   AND  feb_exrc_rfrnc_no >=    :c_min_ref_num 
                   AND  feb_exrc_rfrnc_no <     :c_max_ref_num 
        UNION ALL

          SELECT fec_clm_mtch_accnt,                             /***Ver 1.5***/
                 fec_exrc_rfrnc_no,
                 fec_xchng_cd,
                 fec_prdct_typ,
                 fec_indstk,
                 fec_undrlyng,
                 to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
                 fec_exer_typ,
                 fec_opt_typ,
                 fec_strk_prc,
                 'E',
                 NVL( fec_exrc_qty, 0 ),
                 'E',
                 to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
                 'Exchange Initiated',
                 NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
                 ' ',                                                     /***1.1***/
                 ' ',                                                     /***1.1***/
                 '*',                                                       /***1.4***/
 /*  1.7 */    (      NVL(fec_brkg_val,0)
 										+ NVL(fec_stt,0)
										+ NVL(fec_src_tx,0)
										+ NVL(fec_sebi_tt,0)
										+ NVL(fec_tran_chrg,0)
										+ NVL(fec_stamp_duty,0)
										+ NVL(fec_other_chrg,0)
								)
          FROM fec_fo_exrc_conf
          where fec_clm_mtch_accnt = :c_mtch_accnt_no
           /** AND fec_xchng_cd = :c_exchange_cd									** Ver 2.0 comment***/
            AND fec_xchng_cd  LIKE :c_exchange_cd											/*** Ver 2.0***/
            AND fec_prdct_typ LIKE :c_product_typ
            AND fec_exrc_init = 'E'
            AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
            AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')
            order by 13,14 desc;
          END;
        END-EXEC;
      }
      else if ( ( li_rec_cnt_status_date != 1 ) && ( li_rec_cnt_conf_date == 1 ) )
      {
        EXEC SQL  EXECUTE
          BEGIN
            OPEN  :sys_cursor FOR
                SELECT  feb_clm_mtch_accnt,                             /***Ver 1.5***/
                        feb_exrc_rfrnc_no, 
                        feb_xchng_cd, 
                        feb_prdct_typ,
                        feb_indstk,
                        feb_undrlyng, 
                        to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                        feb_exer_typ, 
                        feb_opt_typ, 
                        feb_strk_prc,
                        feb_exrc_rqst_typ, 
                        NVL( feb_exrc_qty, 0 ), 
                        feb_exrc_stts,
                        to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                        NVL( feb_ack_nmbr, ' ' ),
                        NVL( feb_curr_mkt_prc, 0 ), 
                        NVL( feb_channel , '*'),                                 /***1.1***/
                        NVL( feb_bp_id , ' '),                                   /***1.1***/
                        feb_pipe_id,                                              /***1.4***/
                        0.00
                  FROM  feb_fo_exrc_rqst_book 
                 WHERE  feb_clm_mtch_accnt = :c_mtch_accnt_no
                  /** AND  feb_xchng_cd       = :c_exchange_cd					** Ver 2.0 comment **/
                   AND  feb_xchng_cd    LIKE :c_exchange_cd							/*** Ver 2.0***/
                   AND  feb_prdct_typ   LIKE :c_product_typ
                   AND  feb_exrc_stts   LIKE :c_exrc_stts 
                   AND  feb_exrc_rfrnc_no >=    :c_min_ref_num 
                   AND  feb_exrc_rfrnc_no <     :c_max_ref_num 
        UNION ALL

          SELECT fec_clm_mtch_accnt,                             /***Ver 1.5***/
                 fec_exrc_rfrnc_no,
                 fec_xchng_cd,
                 fec_prdct_typ,
                 fec_indstk,
                 fec_undrlyng,
                 to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
                 fec_exer_typ,
                 fec_opt_typ,
                 fec_strk_prc,
                 'E',
                 NVL( fec_exrc_qty, 0 ),
                 'E',
                 to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
                 'Exchange Initiated',
                 NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
                 ' ',                                                     /***1.1***/
                 ' ',                                                     /***1.1***/
                 '*',                                                       /***1.4***/
 /*  1.7 */    (      NVL(fec_brkg_val,0)
 										+ NVL(fec_stt,0)
										+ NVL(fec_src_tx,0)
										+ NVL(fec_sebi_tt,0)
										+ NVL(fec_tran_chrg,0)
										+ NVL(fec_stamp_duty,0)
										+ NVL(fec_other_chrg,0)
								)
          FROM fec_fo_exrc_conf
          where fec_clm_mtch_accnt = :c_mtch_accnt_no
           /** AND fec_xchng_cd = :c_exchange_cd						*** Ver 2.0 comment ****/
            AND fec_xchng_cd  LIKE  :c_exchange_cd								/*** Ver 2.0***/
            AND fec_prdct_typ LIKE :c_product_typ
            AND fec_exrc_init = 'E'
            AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
            AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')

        UNION ALL

        SELECT fec_clm_mtch_accnt,                             /***Ver 1.5***/
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
               ' ',                                                     /***1.1***/
               ' ',                                                     /***1.1***/
               '*',                                                       /***1.4***/
 /*  1.7 */    (      NVL(fec_brkg_val,0)
 										+ NVL(fec_stt,0)
										+ NVL(fec_src_tx,0)
										+ NVL(fec_sebi_tt,0)
										+ NVL(fec_tran_chrg,0)
										+ NVL(fec_stamp_duty,0)
										+ NVL(fec_other_chrg,0)
								)
        FROM fec_fo_exrc_conf_hstry
        where fec_clm_mtch_accnt = :c_mtch_accnt_no
         /** AND fec_xchng_cd = :c_exchange_cd								**** Ver 2.0 comment***/
          AND fec_xchng_cd  LIKE  :c_exchange_cd										/*** Ver 2.0***/
          AND fec_prdct_typ LIKE :c_product_typ
          AND fec_exrc_init = 'E'
          AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
          AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')
          order by 13,14 desc;
        END;
      END-EXEC;

    }
    else
    {
      EXEC SQL  EXECUTE
        BEGIN
          OPEN  :sys_cursor FOR
              SELECT  feb_clm_mtch_accnt,                             /***Ver 1.5***/
                      feb_exrc_rfrnc_no, 
                      feb_xchng_cd, 
                      feb_prdct_typ,
                      feb_indstk,
                      feb_undrlyng, 
                      to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                      feb_exer_typ, 
                      feb_opt_typ, 
                      feb_strk_prc,
                      feb_exrc_rqst_typ, 
                      NVL( feb_exrc_qty, 0 ), 
                      feb_exrc_stts,
                      to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                      NVL( feb_ack_nmbr, ' ' ),
                      NVL( feb_curr_mkt_prc, 0 ),
                      NVL( feb_channel , '*'),                                  /***1.1***/
                      NVL( feb_bp_id , ' '),                                   /***1.1***/
                      feb_pipe_id,                                              /***1.4***/
                      0.00
                FROM  feb_fo_exrc_rqst_book 
               WHERE  feb_clm_mtch_accnt = :c_mtch_accnt_no
                /** AND  feb_xchng_cd       = :c_exchange_cd				**Ver 2.0comment **/
                 AND  feb_xchng_cd    LIKE :c_exchange_cd						/*** Ver 2.0***/
                 AND  feb_prdct_typ   LIKE :c_product_typ
                 AND  feb_exrc_stts   LIKE :c_exrc_stts 
                 AND  feb_exrc_rfrnc_no >=    :c_min_ref_num 
                 AND  feb_exrc_rfrnc_no <     :c_max_ref_num 
  
               UNION ALL
  
              SELECT  feb_clm_mtch_accnt,                             /***Ver 1.5***/
                      feb_exrc_rfrnc_no, 
                      feb_xchng_cd, 
                      feb_prdct_typ,
                      feb_indstk,
                      feb_undrlyng, 
                      to_char ( feb_expry_dt, 'dd-Mon-yyyy' ), 
                      feb_exer_typ, 
                      feb_opt_typ, 
                      feb_strk_prc,
                      feb_exrc_rqst_typ, 
                      NVL( feb_exrc_qty, 0 ), 
                      feb_exrc_stts,
                      to_char ( feb_trd_dt, 'dd-Mon-yyyy' ), 
                      NVL( feb_ack_nmbr, ' ' ),
                      NVL( feb_curr_mkt_prc, 0 ),
                      NVL( feb_channel , '*'),                                  /***1.1***/
                      NVL( feb_bp_id , ' '),                                   /***1.1***/
                      feb_pipe_id,                                              /***1.4***/
                      0.00
                FROM  feb_fo_exrc_rqst_book_hstry 
               WHERE  feb_clm_mtch_accnt = :c_mtch_accnt_no
                /** AND  feb_xchng_cd       = :c_exchange_cd				****Ver 2.0 comment ***/
                 AND  feb_xchng_cd    LIKE    :c_exchange_cd						/*** Ver 2.0***/
                 AND  feb_prdct_typ   LIKE :c_product_typ
                 AND  feb_exrc_stts   LIKE :c_exrc_stts 
                 AND  feb_exrc_rfrnc_no >=    :c_min_ref_num 
                 AND  feb_exrc_rfrnc_no <     :c_max_ref_num
      UNION ALL

        SELECT fec_clm_mtch_accnt,                             /***Ver 1.5***/
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
               ' ',                                                     /***1.1***/
               ' ',                                                     /***1.1***/
               '*',                                                     /***1.4***/
 /*  1.7 */    (      NVL(fec_brkg_val,0)
 										+ NVL(fec_stt,0)
										+ NVL(fec_src_tx,0)
										+ NVL(fec_sebi_tt,0)
										+ NVL(fec_tran_chrg,0)
										+ NVL(fec_stamp_duty,0)
										+ NVL(fec_other_chrg,0)
								)
        FROM fec_fo_exrc_conf
        where fec_clm_mtch_accnt = :c_mtch_accnt_no
         /** AND fec_xchng_cd = :c_exchange_cd								**** Ver 2.0 Comment ***/
          AND fec_xchng_cd  LIKE :c_exchange_cd										/*** Ver 2.0***/
          AND fec_prdct_typ LIKE :c_product_typ
          AND fec_exrc_init = 'E'
          AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
          AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')

      UNION ALL

        SELECT fec_clm_mtch_accnt,                             /***Ver 1.5***/
               fec_exrc_rfrnc_no,
               fec_xchng_cd,
               fec_prdct_typ,
               fec_indstk,
               fec_undrlyng,
               to_char ( fec_expry_dt, 'dd-Mon-yyyy' ), 
               fec_exer_typ,
               fec_opt_typ,
               fec_strk_prc,
               'E',
               NVL( fec_exrc_qty, 0 ),
               'E',
               to_char ( fec_exrc_dt, 'dd-Mon-yyyy' ), 
               'Exchange Initiated',
               NVL( fec_curr_mkt_prc, 0 ),                              /***1.1***/
               ' ',                                                     /***1.1***/
               ' ',                                                     /***1.1***/
               '*',                                                     /***1.4***/
 /*  1.7 */    (      NVL(fec_brkg_val,0)
 										+ NVL(fec_stt,0)
										+ NVL(fec_src_tx,0)
										+ NVL(fec_sebi_tt,0)
										+ NVL(fec_tran_chrg,0)
										+ NVL(fec_stamp_duty,0)
										+ NVL(fec_other_chrg,0)
								)
        FROM fec_fo_exrc_conf_hstry
        where fec_clm_mtch_accnt = :c_mtch_accnt_no
           /** AND fec_xchng_cd = :c_exchange_cd							**** Ver 2.0 comment**/
            AND fec_xchng_cd  LIKE  :c_exchange_cd									/*** Ver 2.0***/
            AND fec_prdct_typ LIKE :c_product_typ
            AND fec_exrc_init = 'E'
            AND fec_exrc_dt >= to_date(:c_frm_dt, 'dd-Mon-yyyy')
            AND fec_exrc_dt <= to_date(:c_to_dt , 'dd-Mon-yyyy')
            order by 13,14 desc;
          END;
        END-EXEC;
      }
    }
		else if ( c_opr_typ == ORDER_RFRNC_IP)			/***	Ver	1.8	***/
		{
			fn_userlog(c_ServiceName,"Inside c_opr_typ ORDER_RFRNC_IP ");

		  EXEC SQL EXECUTE
        BEGIN
          OPEN  :sys_cursor FOR
					SELECT	FEB_CLM_MTCH_ACCNT,    
        		    	FEB_EXRC_RFRNC_NO,
          		   	FEB_XCHNG_CD,
            		 	FEB_PRDCT_TYP,
             			FEB_INDSTK,
             			FEB_UNDRLYNG,
	             		TO_CHAR ( FEB_EXPRY_DT, 'dd-Mon-yyyy' ),
  	           		FEB_EXER_TYP,
    	         		FEB_OPT_TYP,
      	       		FEB_STRK_PRC,
        	     		FEB_EXRC_RQST_TYP,
          	   		NVL( FEB_EXRC_QTY, 0 ),
            	 		FEB_EXRC_STTS,
             			TO_CHAR ( FEB_TRD_DT, 'dd-Mon-yyyy' ),
     	        		NVL( FEB_ACK_NMBR, ' ' ),
      	       		NVL( FEB_CURR_MKT_PRC, 0 ),
        	     		NVL( FEB_CHANNEL , '*'),
          	   		NVL( FEB_BP_ID , ' '),
            	 		FEB_PIPE_ID,
             			0.00
     			FROM    FEB_FO_EXRC_RQST_BOOK
    			WHERE   FEB_CLM_MTCH_ACCNT = :c_mtch_accnt_no
					AND			FEB_EXRC_RFRNC_NO	 = :c_ordr_rfrnc

					UNION ALL

       		SELECT	FEC_CLM_MTCH_ACCNT,        
         			   	FEC_EXRC_RFRNC_NO,
           				FEC_XCHNG_CD,
           				FEC_PRDCT_TYP,
           				FEC_INDSTK,
           				FEC_UNDRLYNG,
           				TO_CHAR ( FEC_EXPRY_DT, 'dd-Mon-yyyy' ),
           				FEC_EXER_TYP,
           				FEC_OPT_TYP,
           				FEC_STRK_PRC,
           				'E',
           				NVL( FEC_EXRC_QTY, 0 ),
           				'E',
           				TO_CHAR ( FEC_EXRC_DT, 'dd-Mon-yyyy' ),
           				'Exchange Initiated',
           				NVL( FEC_CURR_MKT_PRC, 0 ),
           				' ',                               
           				'  ',                             
           				'*',                             
   								( NVL(FEC_BRKG_VAL,0)
									+ NVL(FEC_STT,0)
									+ NVL(FEC_SRC_TX,0)
							  	+ NVL(FEC_SEBI_TT,0)
							  	+ NVL(FEC_TRAN_CHRG,0)
							  	+	NVL(FEC_STAMP_DUTY,0)
                	+ NVL(FEC_OTHER_CHRG,0)
             			)
					FROM 		FEC_FO_EXRC_CONF
       		WHERE 	FEC_CLM_MTCH_ACCNT 	= :c_mtch_accnt_no
					AND			FEC_EXRC_RFRNC_NO		=	:c_ordr_rfrnc
        	ORDER BY 13,14 DESC;

			END;
    END-EXEC;
		}
	}

  if ( SQLCODE != 0 )
  {
    fn_errlog( c_ServiceName, "S31100", SQLMSG, c_errmsg  );
    EXEC SQL FREE :sys_cursor;
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
    /** tpcommit(0); commented for Ver 1.9 **/
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
  /****Ver 1.5 starts ***/

  l_bufferlength=sizeof( struct vw_exrcbook)+sizeof(c_mod_can_flg)+sizeof(c_request_tm)+sizeof(c_ack_time)
                  +sizeof(c_remarks) + sizeof((c_spl_flg)*2);

    fn_userlog(c_ServiceName,"i_count:%d:",i_count);  
  fn_userlog(c_ServiceName,"bufferlength:%ld",l_bufferlength);

  /*** tpfree ( ( char * )ptr_fml_Obuf); ** Ver 2.2 **/

  /*** Output Buffer is allocated size of (Number of match accnt's * 1024) so that it will never go in
  reallocation loop***/

  ptr_fml_Obuf = (FBFR32 *)tpalloc( "FML32", NULL, MIN_FML_BUF_LEN * i_count );

  if ( ptr_fml_Obuf == NULL )
  {
    fn_errlog( c_ServiceName, "S31105", TPMSG, c_errmsg  );
    EXEC SQL CLOSE :sys_cursor;
    EXEC SQL FREE :sys_cursor;
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
    /** tpcommit(0); commented for Ver 1.9 **/
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  /***Ver 1.5 Ends ***/

	/*** Commented for Ver 2.1 *******
  ptr_st_exrcbook = ( struct vw_exrcbook * ) tpalloc ( "VIEW32",
                                                         "vw_exrcbook",
                                               sizeof ( struct vw_exrcbook ) );
	********** Ver 2.1 **********/

	/**** Added for Ver 2.1 ****/
	ptr_st_exrcbook = malloc(sizeof(struct vw_exrcbook));
	/***** End for Ver 2.1 ***/
  if ( ptr_st_exrcbook == NULL )
  {
    fn_errlog( c_ServiceName, "S31110", TPMSG, c_errmsg  );
    Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
    /** tpcommit(0); commented for Ver 1.9 **/
    tpfree((char*) ptr_fml_Obuf);  /** Ver 2.2 **/  
    tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  memset ( ptr_st_exrcbook, 0, sizeof ( struct vw_exrcbook ) );

  strcpy ( ptr_st_exrcbook->c_user_id, st_usr_prfl.c_user_id );
  ptr_st_exrcbook->c_oprn_typ = c_opr_typ; 
  strcpy ( ptr_st_exrcbook->c_cln_mtch_accnt, c_mtch_accnt_no );

  i_counter = 1;
  i_cnt = 0;

  for ( ; ; )
  {
    EXEC SQL FETCH :sys_cursor
              INTO :ptr_st_exrcbook->c_cln_mtch_accnt,              /*** Ver 1.5 ***/
                   :ptr_st_exrcbook->c_exrc_ordr_rfrnc,
                   :ptr_st_exrcbook->c_xchng_cd,  
                   :ptr_st_exrcbook->c_prd_typ,  
                   :ptr_st_exrcbook->c_ctgry_indstk,  
                   :ptr_st_exrcbook->c_undrlyng,  
                   :c_exp_date, 
                   :ptr_st_exrcbook->c_exrc_typ,  
                   :ptr_st_exrcbook->c_opt_typ,  
                   :ptr_st_exrcbook->l_strike_prc,  
                   :ptr_st_exrcbook->c_exrc_rqst_typ,  
                   :ptr_st_exrcbook->l_exrc_qty,  
                   :ptr_st_exrcbook->c_exrc_stts,  
                   :c_trd_date,
                   :ptr_st_exrcbook->c_xchng_ack,
                   :ptr_st_exrcbook->l_cur_mkt_prc,
                   :ptr_st_exrcbook->c_channel,
                   :ptr_st_exrcbook->c_bp_id,
                   :ptr_st_exrcbook->c_pipe_id,                       /***1.4***/
                   :ptr_st_exrcbook->l_brkg_val;								       /*  1.7 */

    if (DEBUG_MSG_LVL_3)
    { 
     fn_userlog( c_ServiceName, "ptr_st_exrcbook->c_exrc_ordr_rfrnc : %s", ptr_st_exrcbook->c_exrc_ordr_rfrnc );
     fn_userlog( c_ServiceName, "ptr_st_exrcbook->c_cln_mtch_accnt : %s", ptr_st_exrcbook->c_cln_mtch_accnt );
     fn_userlog( c_ServiceName, "ptr_st_exrcbook->l_brkg_val	 : %ld", ptr_st_exrcbook->l_brkg_val	 );
    }  

    if ( SQLCODE != 0 )
    {
      if ( SQLCODE == NO_DATA_FOUND )
      {
      	/* 1.7 */
      	fn_userlog( c_ServiceName, "No data found in main FETCH. No exercise records are present !! ");
        break;
      }
      else
      {
        fn_errlog( c_ServiceName, "S31115", SQLMSG, c_errmsg  );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_st_exrcbook );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
        /** tpcommit(0); commented for Ver 1.9 **/
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }
    
/******************************************************************************/
    /*Ver 1.7 Starts*/
	if (ptr_st_exrcbook->l_brkg_val == 0)
	{
    if (DEBUG_MSG_LVL_3)
    { 
     fn_userlog( c_ServiceName, "ptr_st_exrcbook->l_brkg_val	- 0  : %ld", ptr_st_exrcbook->l_brkg_val	 );
    }  
	
		EXEC SQL
		
			SELECT  SUM(NVL( brokerage , 0 ))
			INTO :ptr_st_exrcbook->l_brkg_val
			FROM
			(
			SELECT 
			SUM
				(     NVL(fec_brkg_val,0)
						+ NVL(fec_stt,0)
						+ NVL(fec_src_tx,0)
						+ NVL(fec_sebi_tt,0)
						+ NVL(fec_tran_chrg,0)
						+ NVL(fec_stamp_duty,0)
						+ NVL(fec_other_chrg,0)
				) AS brokerage
	      FROM  fec_fo_exrc_conf
	      WHERE fec_clm_mtch_accnt =    :c_mtch_accnt_no
	       /* AND fec_xchng_cd       =    :c_exchange_cd			**** Ver 2.0 comment**/
	        AND fec_xchng_cd       LIKE    :c_exchange_cd			/**** Ver 2.0 **/
					AND fec_exrc_rfrnc_no  =    :ptr_st_exrcbook->c_exrc_ordr_rfrnc
					AND fec_exrc_dt				 =    :c_trd_date

    UNION ALL
        
      SELECT 
			SUM
			(     NVL(fec_brkg_val,0)
					+ NVL(fec_stt,0)
					+ NVL(fec_src_tx,0)
					+ NVL(fec_sebi_tt,0)
					+ NVL(fec_tran_chrg,0)
					+ NVL(fec_stamp_duty,0)
					+ NVL(fec_other_chrg,0)
			) AS brokerage
      FROM  fec_fo_exrc_conf_hstry
      WHERE fec_clm_mtch_accnt =   :c_mtch_accnt_no
       /** AND fec_xchng_cd       =   :c_exchange_cd			**** Ver 2.0comment ***/
        AND fec_xchng_cd       LIKE   :c_exchange_cd					/*** Ver 2.0***/
				AND fec_exrc_rfrnc_no  =   :ptr_st_exrcbook->c_exrc_ordr_rfrnc
				AND fec_exrc_dt				 =    :c_trd_date
		);
        
    if ( SQLCODE != 0 )
    {
			if ( SQLCODE != NO_DATA_FOUND )
      {
        fn_errlog( c_ServiceName, "S31120", SQLMSG, c_errmsg  );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_st_exrcbook );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
        /** tpcommit(0);  commented for Ver 1.9 **/
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }
    
    if (DEBUG_MSG_LVL_3)
    	fn_userlog( c_ServiceName, "ptr_st_exrcbook->l_brkg_val	: %ld", ptr_st_exrcbook->l_brkg_val	 );
        
	}
	
	/*Version 1.7 Ends*/
/******************************************************************************/
  if(DEBUG_MSG_LVL_3) 
  {
    fn_userlog(c_ServiceName,"c_pipe_id :%s:",ptr_st_exrcbook->c_pipe_id);
  }


    i_count++;
    if(ptr_st_exrcbook->c_channel[0] == '*')                                /**1.1**/
    {
        strcpy(ptr_st_exrcbook->c_channel,"WEB") ;
    }
    if(strncmp(ptr_st_exrcbook->c_channel,"CN",2) == 0)       /** V1.2 super user **/ /* ver 1.5 Vikash comparing first two chars of channel now with CN earlier it was channel being compared to CN1 */
    {
        strcpy(ptr_st_exrcbook->c_channel,"CNT") ;
    }
  

		/***	Ver	1.8	Starts	***/

		if( ptr_st_exrcbook->c_bp_id[0]	==	BPID 	&&	ptr_st_exrcbook->c_user_id[0] ==	BPID	)
		{
			strcat(ptr_st_exrcbook->c_channel," DBC");
		}

		/***  Ver 1.8 Ends	***/

    fn_userlog(c_ServiceName,"c_channel is :%s:",ptr_st_exrcbook->c_channel);
    fn_userlog(c_ServiceName,"c_bp_id is :%s:",ptr_st_exrcbook->c_bp_id);

    SETNULL(c_exp_date);
    SETNULL(c_trd_date);

    if(DEBUG_MSG_LVL_3)
    {
      fn_userlog(c_ServiceName,"l_cur_mkt_prc :%ld:",ptr_st_exrcbook->l_cur_mkt_prc);
    }
    strcpy ( ptr_st_exrcbook->c_expry_dt, ( char * ) c_exp_date.arr );
    strcpy ( ptr_st_exrcbook->c_trd_dt,   ( char * ) c_trd_date.arr );
  

		/******* Commented for Ver 2.1 *******
    i_returncode = Fvstof32( ptr_fml_Obuf, (char *) ptr_st_exrcbook,
                              FCONCAT, "vw_exrcbook" );
		***** Ver 2.1 *********/

		/******** Added for Ver 2.1 ****/
    i_returncode = fn_pack_vartofml(c_ServiceName,
                                    c_errmsg,
                                    &ptr_fml_Obuf,
																		24,
															FFO_USR_ID, (char*)ptr_st_exrcbook->c_user_id,
															FFO_OPERATION_TYP, (char*)&ptr_st_exrcbook->c_oprn_typ,
															FFO_EBA_MTCH_ACT_NO, (char*)ptr_st_exrcbook->c_cln_mtch_accnt,
															FFO_ORDR_RFRNC, (char*)ptr_st_exrcbook->c_exrc_ordr_rfrnc,
															FFO_XCHNG_CD, (char*)ptr_st_exrcbook->c_xchng_cd,
															FFO_PRDCT_TYP, (char*)&ptr_st_exrcbook->c_prd_typ,
															FFO_CTGRY_INDSTK, (char*)&ptr_st_exrcbook->c_ctgry_indstk,
															FFO_UNDRLYNG, (char*)ptr_st_exrcbook->c_undrlyng,
															FFO_EXER_TYP, (char*)&ptr_st_exrcbook->c_exrc_typ,
															FFO_OPT_TYP, (char*)&ptr_st_exrcbook->c_opt_typ,
															FFO_STRK_PRC, (char*)&ptr_st_exrcbook->l_strike_prc,
															FFO_EX_ORDR_TYP, (char*)&ptr_st_exrcbook->c_exrc_rqst_typ,
															FFO_ORD_TOT_QTY, (char*)&ptr_st_exrcbook->l_exrc_qty,
															FFO_EXRC_STTS, (char*)&ptr_st_exrcbook->c_exrc_stts,
															FFO_ACK_NMBR, (char*)ptr_st_exrcbook->c_xchng_ack,
															FFO_CUR_MKT_PRC, (char*)&ptr_st_exrcbook->l_cur_mkt_prc,
															FFO_CHANNEL, (char*)ptr_st_exrcbook->c_channel,
															FFO_BP_ID, (char*)ptr_st_exrcbook->c_bp_id,
															FFO_PIPE_ID, (char*)ptr_st_exrcbook->c_pipe_id,
															FFO_BRKRG_VL, (char*)&ptr_st_exrcbook->l_brkg_val,
															FFO_EXPRY_DT, (char*)ptr_st_exrcbook->c_expry_dt,
															FFO_TRD_DT, (char*)ptr_st_exrcbook->c_trd_dt,
															FFO_MDFCTN_CNTR, (char*)&ptr_st_exrcbook->l_mdfctn_cntr,
															FFO_EXRC_STTS, (char*)&ptr_st_exrcbook->c_exrc_stts);

		/******** Ver 2.1 ****/


    if ( i_returncode == -1 )
    {
      if( Ferror32 == FNOSPACE )
      {
        fn_userlog(c_ServiceName,"Inside concat of exrcbook to Obuf:NO_SPACE-I"); 
        i_counter++;
        i_count++;
        ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,
                            i_counter *i_count* MIN_FML_BUF_LEN );  /***Ver 1.5  Output Buffer will be allocated double 
                                                                    the size which was allocated first time ***/ 
        if ( ptr_fml_Obuf == NULL )
        {
          fn_errlog( c_ServiceName, "S31125", TPMSG, c_errmsg  );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_st_exrcbook );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
          /** tpcommit(0); commented for Ver 1.9 **/
          tpfree ( ( char * ) ptr_fml_Obuf ); /** Ver 2.2 **/ 
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
        
				/***** Commented for Ver 2.1 ********
        i_returncode = Fvstof32( ptr_fml_Obuf, (char *) ptr_st_exrcbook,
                                 FCONCAT, "vw_exrcbook" );

																
				******** Ver 2.1 *********/

				/******** Added for Ver 2.1 *********/
				i_returncode = fn_pack_vartofml(c_ServiceName,
																				c_errmsg,
																				&ptr_fml_Obuf,
																				24,
															FFO_USR_ID, (char*)ptr_st_exrcbook->c_user_id,
															FFO_OPERATION_TYP, (char*)&ptr_st_exrcbook->c_oprn_typ,
															FFO_EBA_MTCH_ACT_NO, (char*)ptr_st_exrcbook->c_cln_mtch_accnt,
															FFO_ORDR_RFRNC, (char*)ptr_st_exrcbook->c_exrc_ordr_rfrnc,
															FFO_XCHNG_CD, (char*)ptr_st_exrcbook->c_xchng_cd,
															FFO_PRDCT_TYP, (char*)&ptr_st_exrcbook->c_prd_typ,
															FFO_CTGRY_INDSTK, (char*)&ptr_st_exrcbook->c_ctgry_indstk,
															FFO_UNDRLYNG, (char*)ptr_st_exrcbook->c_undrlyng,
															FFO_EXER_TYP, (char*)&ptr_st_exrcbook->c_exrc_typ,
															FFO_OPT_TYP, (char*)&ptr_st_exrcbook->c_opt_typ,
															FFO_STRK_PRC, (char*)&ptr_st_exrcbook->l_strike_prc,
															FFO_EX_ORDR_TYP, (char*)&ptr_st_exrcbook->c_exrc_rqst_typ,
															FFO_ORD_TOT_QTY, (char*)&ptr_st_exrcbook->l_exrc_qty,
															FFO_EXRC_STTS, (char*)&ptr_st_exrcbook->c_exrc_stts,
															FFO_ACK_NMBR, (char*)ptr_st_exrcbook->c_xchng_ack,
															FFO_CUR_MKT_PRC, (char*)&ptr_st_exrcbook->l_cur_mkt_prc,
															FFO_CHANNEL, (char*)ptr_st_exrcbook->c_channel,
															FFO_BP_ID, (char*)ptr_st_exrcbook->c_bp_id,
															FFO_PIPE_ID, (char*)ptr_st_exrcbook->c_pipe_id,
															FFO_BRKRG_VL, (char*)&ptr_st_exrcbook->l_brkg_val,
															FFO_EXPRY_DT, (char*)ptr_st_exrcbook->c_expry_dt,
															FFO_TRD_DT, (char*)ptr_st_exrcbook->c_trd_dt,
															FFO_MDFCTN_CNTR, (char*)&ptr_st_exrcbook->l_mdfctn_cntr,
															FFO_EXRC_STTS, (char*)&ptr_st_exrcbook->c_exrc_stts);

				/******** End for Ver 2.1 *********/

        if ( i_returncode == -1 )
        {
          fn_errlog( c_ServiceName, "S31130", FMLMSG, c_errmsg  );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_st_exrcbook );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
          /** tpcommit(0);  commented for Ver 1.9 **/
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
      else
      {
        fn_errlog( c_ServiceName, "S31135", FMLMSG, c_errmsg  );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_st_exrcbook );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
        /** tpcommit(0); commented for Ver 1.9 **/
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }
      /*  SETLEN(ptr_st_exrcbook->c_exrc_ordr_rfrnc);  */

      /***Ver 1.5 starts ****/
  
      if(strcmp(ptr_st_exrcbook->c_exrc_ordr_rfrnc,"Exchange Initiated")!=0)
      {
        fn_userlog(c_ServiceName,"Outside condition exchange Initiated");
        EXEC SQL
          SELECT FEB_MDFCTN_CNTR
          INTO :ptr_st_exrcbook->l_mdfctn_cntr
          FROM feb_fo_exrc_rqst_book
          WHERE FEB_EXRC_RFRNC_NO = :ptr_st_exrcbook->c_exrc_ordr_rfrnc;
        if ( ( SQLCODE != 0 ) && ( SQLCODE != NO_DATA_FOUND) )
        {
          fn_errlog( c_ServiceName, "S31140", SQLMSG, c_errmsg  );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_st_exrcbook );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
          /** tpcommit(0); commented for Ver 1.9 **/
          tpfree ( ( char * ) ptr_fml_Obuf );  /** Ver 2.2 **/
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
        if ( SQLCODE == NO_DATA_FOUND )
        {
          EXEC SQL
          SELECT FEB_MDFCTN_CNTR
          INTO :ptr_st_exrcbook->l_mdfctn_cntr
          FROM feb_fo_exrc_rqst_book_hstry
            WHERE FEB_EXRC_RFRNC_NO = :ptr_st_exrcbook->c_exrc_ordr_rfrnc;
          if ( SQLCODE != 0 )
          {
            fn_errlog( c_ServiceName, "S31145", SQLMSG, c_errmsg  );
            EXEC SQL CLOSE :sys_cursor;
            EXEC SQL FREE :sys_cursor;
            tpfree ( ( char * ) ptr_st_exrcbook );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
            /** tpcommit(0); commented for Ver 1.9 **/
            tpfree ( ( char * ) ptr_fml_Obuf );  /** Ver 2.2 **/
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
          }
        }
      }
    fn_userlog(c_ServiceName,"l_mdfctn_cntr:%d:",ptr_st_exrcbook->l_mdfctn_cntr); 
   EXEC SQL
      SELECT 1
        INTO   :i_rec_count
      FROM  dual
      WHERE exists
                  (
                    SELECT 1
                    FROM   fxb_fo_xchng_book
                    WHERE  fxb_ordr_rfrnc = :ptr_st_exrcbook->c_exrc_ordr_rfrnc
                  );

    if ( ( SQLCODE != 0 ) && ( SQLCODE != NO_DATA_FOUND ) )
    {
      fn_errlog( c_ServiceName, "S31150", SQLMSG, c_err_msg  );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      tpfree ( ( char * ) ptr_fml_Obuf );
      l_acnt_id = -1;
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID ,(char*)&l_acnt_id, 0 );
      /** tpcommit(0); commented for Ver 1.9 **/
      tpfree ( ( char * ) ptr_st_exrcbook ); /** Ver 2.2 **/
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
    }

    fn_userlog(c_ServiceName,"i_rec_count:%d",i_rec_count);
    if ( i_rec_count != 1 )
    {

      EXEC SQL
          SELECT  nvl(MIN(to_char(fxb_rqst_tm,'DD-Mon-yyyy hh24:mi:ss')),'*')
          INTO    :c_request_tm
          FROM    fxb_fo_xchng_book_hstry
          WHERE   fxb_ordr_rfrnc = :ptr_st_exrcbook->c_exrc_ordr_rfrnc;

      if ( (SQLCODE != 0) && (SQLCODE!=NO_DATA_FOUND))   /** CHECK IF NDF IS RQRD**/
      {
        fn_errlog( c_ServiceName, "S31155", SQLMSG, c_err_msg );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, (char*)c_err_msg, 0 );
        tpfree ( ( char * ) ptr_fml_Obuf );
        l_acnt_id = -1;
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID ,(char*)&l_acnt_id, 0 );
        /** tpcommit(0); commented for Ver 1.9 **/
        tpfree ( ( char * ) ptr_st_exrcbook ); /** Ver 2.2 **/
        tpreturn(TPFAIL, ERR_BFR, ( char * )ptr_fml_Ibuf, 0, 0 );
      }

      EXEC SQL
          SELECT    nvl(to_char(FXB_ACK_TM, 'dd-mon-yyyy hh24:mi:ss'),'*') ,
                    nvl(FXB_XCHNG_RMRKS,'*'),
                    nvl(FXB_SPL_FLAG,0),
                    fxb_rqst_typ,
                    fxb_plcd_stts
          INTO      :c_ack_time,
                    :c_remarks,
                    :c_spl_flg,
                    :c_rqst_typ,
                    :c_plcd_stts
          FROM      fxb_fo_xchng_book_hstry
          WHERE     fxb_ordr_rfrnc = :ptr_st_exrcbook->c_exrc_ordr_rfrnc AND
                    fxb_plcd_stts = 'A' AND
                    fxb_mdfctn_cntr = :ptr_st_exrcbook->l_mdfctn_cntr
                                      /**( SELECT  MAX(FXB_MDFCTN_CNTR)
                                        FROM    fxb_fo_xchng_book_hstry
                                        WHERE   fxb_ordr_rfrnc = :c_ordr_rfrnc AND
                                                fxb_plcd_stts = 'A'
                                      ) **/ ;     
                                            /***Ver 1.5 Exrta fetch is avoided ***/
    }
    else
    {

      EXEC SQL
          SELECT  nvl(MIN(to_char(fxb_rqst_tm,'DD-Mon-yyyy hh24:mi:ss')),'*')
          INTO    :c_request_tm
          FROM    fxb_fo_xchng_book
          WHERE   fxb_ordr_rfrnc = :ptr_st_exrcbook->c_exrc_ordr_rfrnc;

      if ( SQLCODE != 0 )
      {
        fn_errlog( c_ServiceName, "S31160", SQLMSG, c_err_msg );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, (char*)c_err_msg, 0 );
        tpfree ( ( char * ) ptr_fml_Obuf );
        l_acnt_id = -1;
        Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID ,(char*)&l_acnt_id, 0 );
        /** tpcommit(0); commented for Ver 1.9 **/
        tpfree ( ( char * ) ptr_st_exrcbook ); /** Ver 2.2 **/ 
        tpreturn(TPFAIL, ERR_BFR, ( char * )ptr_fml_Ibuf, 0, 0 );
      }

      EXEC SQL
          SELECT    nvl(to_char(FXB_ACK_TM, 'dd-mon-yyyy hh24:mi:ss'),'*') ,
                    nvl(FXB_XCHNG_RMRKS,'*'),
                    nvl(FXB_SPL_FLAG,'*'),
                    fxb_rqst_typ,
                    fxb_plcd_stts
          INTO      :c_ack_time,
                    :c_remarks,
                    :c_spl_flg,
                    :c_rqst_typ,
                    :c_plcd_stts
          FROM      fxb_fo_xchng_book
          WHERE     fxb_ordr_rfrnc = :ptr_st_exrcbook->c_exrc_ordr_rfrnc AND
                    fxb_plcd_stts = 'A' AND
                    fxb_mdfctn_cntr = :ptr_st_exrcbook->l_mdfctn_cntr
                                      /***  ( SELECT  MAX(FXB_MDFCTN_CNTR)
                                        FROM    fxb_fo_xchng_book
                                        WHERE   fxb_ordr_rfrnc = :c_ordr_rfrnc AND
                                                fxb_plcd_stts = 'A'
                                      )***/;
                                            /***Ver 1.5 Exrta fetch is avoided ***/

    }

    if ( (SQLCODE != 0) && (SQLCODE != NO_DATA_FOUND) )
    {
      fn_errlog( c_ServiceName, "S31165", SQLMSG, c_err_msg );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, (char*)c_err_msg, 0 );
      tpfree ( ( char * ) ptr_fml_Obuf );
      l_acnt_id = -1;
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID ,(char*)&l_acnt_id, 0 );
      /** tpcommit(0); commented for Ver 1.9 **/
      tpfree ( ( char * ) ptr_st_exrcbook ); /** Ver 2.2 **/ 
      tpreturn(TPFAIL, ERR_BFR, ( char * )ptr_fml_Ibuf, 0, 0 );
    }

    SETNULL( c_request_tm );

    if ( (SQLCODE == NO_DATA_FOUND) )
    {
      fn_userlog(c_ServiceName,"Inside NO_DATA_FOUND");
      strcpy((char*)c_ack_time.arr,"*");
      strcpy((char*)c_remarks.arr,"*");
      c_spl_flg = '*';
    }
    else
    {
      SETNULL( c_ack_time );
      SETNULL( c_remarks );
    }
  
    c_mod_can_flg = 'N';

    if ( ( ptr_st_exrcbook->c_exrc_stts == REQUESTED ) ||
         ( ptr_st_exrcbook->c_exrc_stts == ORDERED   )  )
    {
      c_mod_can_flg = 'Y';
    }

   /***Commented for Ver 1.5  if ( ptr_st_exrcbook->c_exrc_stts == ORDERED )
    { 
      EXEC SQL
        SELECT FEB_MDFCTN_CNTR
        INTO :ptr_st_exrcbook->l_mdfctn_cntr
        FROM feb_fo_exrc_rqst_book
        WHERE FEB_EXRC_RFRNC_NO = :ptr_st_exrcbook->c_exrc_ordr_rfrnc;
      if ( ( SQLCODE != 0 ) && ( SQLCODE != NO_DATA_FOUND) )
      {
        fn_errlog( c_ServiceName, "S31170", SQLMSG, c_errmsg  );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_st_exrcbook );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
        tpcommit(0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
      if ( SQLCODE == NO_DATA_FOUND )
      {
        EXEC SQL
          SELECT FEB_MDFCTN_CNTR
          INTO :ptr_st_exrcbook->l_mdfctn_cntr
          FROM feb_fo_exrc_rqst_book_hstry
          WHERE FEB_EXRC_RFRNC_NO = :ptr_st_exrcbook->c_exrc_ordr_rfrnc;
        if ( SQLCODE != 0 )
        {
          fn_errlog( c_ServiceName, "S31175", SQLMSG, c_errmsg  );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_st_exrcbook );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
          tpcommit(0);
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      } 

      EXEC SQL
            SELECT fxb_rqst_typ,
                   fxb_plcd_stts
            INTO   :c_rqst_typ,
                   :c_plcd_stts
            FROM fxb_fo_xchng_book
            WHERE fxb_xchng_cd    = :ptr_st_exrcbook->c_xchng_cd
            AND   fxb_ordr_rfrnc  = :ptr_st_exrcbook->c_exrc_ordr_rfrnc
            AND   fxb_mdfctn_cntr = :ptr_st_exrcbook->l_mdfctn_cntr;
      if ( SQLCODE != 0 )
      {
        fn_errlog( c_ServiceName, "S31180", SQLMSG, c_errmsg  );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_st_exrcbook );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
        tpcommit(0);
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    } ****Comment Ens Ver 1.5**/
      
      if ( ptr_st_exrcbook->c_exrc_stts == ORDERED )
      {
        if (( c_rqst_typ == CANCELLED ) && ( c_plcd_stts != REJECT ))
        {
             c_mod_can_flg = 'N';
        }

      }
      fn_userlog(c_ServiceName,"FFO_MOD_CAN_FLG:%c",c_mod_can_flg);

    i_returncode = Fadd32 ( ptr_fml_Obuf, FFO_MOD_CAN_FLG, 
                                    (char *)&c_mod_can_flg, 0);
    if ( i_returncode == -1 )
    {
      if( Ferror32 == FNOSPACE )
      {
        fn_userlog(c_ServiceName,"Inside concat of exrcbook to Obuf:NO_SPACE-II"); 
        i_counter++;
        ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,
                            i_counter * i_count * MIN_FML_BUF_LEN );

        if ( ptr_fml_Obuf == NULL )
        {
          fn_errlog( c_ServiceName, "S31185", TPMSG, c_errmsg  );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_st_exrcbook );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
          /** tpcommit(0); commented for Ver 1.9  **/
          tpfree ( ( char * ) ptr_fml_Obuf );  /** Ver 2.2 **/
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
        
        i_returncode = Fadd32 ( ptr_fml_Obuf, FFO_MOD_CAN_FLG, 
                                    (char *)&c_mod_can_flg, 0);
        if ( i_returncode == -1 )
        {
          fn_errlog( c_ServiceName, "S31190", FMLMSG, c_errmsg  );
          EXEC SQL CLOSE :sys_cursor;
          EXEC SQL FREE :sys_cursor;
          tpfree ( ( char * ) ptr_st_exrcbook );
          tpfree ( ( char * ) ptr_fml_Obuf );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
          /** tpcommit(0); comented for Ver 1.9 **/
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
        }
      }
      else
      {
        fn_errlog( c_ServiceName, "S31195", FMLMSG, c_errmsg  );
        EXEC SQL CLOSE :sys_cursor;
        EXEC SQL FREE :sys_cursor;
        tpfree ( ( char * ) ptr_st_exrcbook );
        tpfree ( ( char * ) ptr_fml_Obuf );
        Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
        /** tpcommit(0); commented for Ver 1.9 **/
        tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
      }
    }

  if(DEBUG_MSG_LVL_3)
  { 
      fn_userlog(c_ServiceName,"FFO_RQST_TM:%s",c_request_tm.arr);
      fn_userlog(c_ServiceName,"FFO_ACK_TM:%s",c_ack_time.arr);
      fn_userlog(c_ServiceName,"FFO_XCHNG_RMRKS:%s",c_remarks.arr);
      fn_userlog(c_ServiceName,"FFO_SPL_FLG:%c",c_spl_flg);
  }

      i_err[0] = Fadd32( ptr_fml_Obuf, FFO_RQST_TM, (char *)c_request_tm.arr, 0);
      i_err[1] = Fadd32( ptr_fml_Obuf, FFO_ACK_TM, (char *)c_ack_time.arr,0);
      i_err[2] = Fadd32( ptr_fml_Obuf, FFO_XCHNG_RMRKS, (char *)c_remarks.arr, 0);
      i_err[3] = Fadd32( ptr_fml_Obuf, FFO_SPL_FLG, (char *)&c_spl_flg, 0);

      for ( k=0;k<4;k++ )
      {
        if(i_err[k] == -1)
/*** Added in ver 1.5 Vikash***/
        {
          if( Ferror32 == FNOSPACE )
          {
            fn_userlog(c_ServiceName,"Inside concat of exrcbook to Obuf:NO_SPACE-II"); 
            i_counter++;
            ptr_fml_Obuf = (FBFR32 *)tprealloc( (char *)ptr_fml_Obuf,
                            i_counter * i_count * MIN_FML_BUF_LEN );

            if ( ptr_fml_Obuf == NULL )
            {
              fn_errlog( c_ServiceName, "S31200", TPMSG, c_errmsg  );
              EXEC SQL CLOSE :sys_cursor;
              EXEC SQL FREE :sys_cursor;
              tpfree ( ( char * ) ptr_st_exrcbook );
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
              /** tpcommit(0); commented for Ver 1.9 **/
              tpfree ( ( char * ) ptr_fml_Obuf );  /** Ver 2.2 **/
              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
            }
        
            i_returncode = Fadd32 ( ptr_fml_Obuf, FFO_MOD_CAN_FLG, 
                                    (char *)&c_mod_can_flg, 0);
            if ( i_returncode == -1 )
            {
              fn_errlog( c_ServiceName, "S31205", FMLMSG, c_errmsg  );
              EXEC SQL CLOSE :sys_cursor;
              EXEC SQL FREE :sys_cursor;
              tpfree ( ( char * ) ptr_st_exrcbook );
              tpfree ( ( char * ) ptr_fml_Obuf );
              Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
              /** tpcommit(0); commented for Ver 1.9 **/
              tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
            }
          }
          else
          {
            fn_errlog( c_ServiceName, "S31210", FMLMSG, c_errmsg  );
            EXEC SQL CLOSE :sys_cursor;
            EXEC SQL FREE :sys_cursor;
            tpfree ( ( char * ) ptr_st_exrcbook );
            tpfree ( ( char * ) ptr_fml_Obuf );
            Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_errmsg, 0 );
            /** tpcommit(0); commented for Ver 1.9 **/
            tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
          }
        }
/**** ver 1.5 addition ends ****/
       /*   fn_errlog( c_ServiceName, "S31215",FMLMSG,c_err_msg);
          fn_userlog( c_ServiceName, "Error in Fadd for k=[%d] ", k );
          Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
          l_acnt_id = -1;
          Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID ,(char*)&l_acnt_id, 0 );
          tpcommit(0);
          tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 ); commented in ver 1.5 Vikash */
        }
  /*i_mtch_cnt++;*/

  i_mtch_cnt=1;                          /***Ver 1.5 Buffer count is hardcoded as 1 for every order***/

  if( Fadd32 ( ptr_fml_Obuf, FFO_SUB_BUF_CNT,(char *)&i_mtch_cnt,0) == -1 )
  {
      fn_errlog( c_ServiceName, "S31220", FMLMSG, c_err_msg  );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      tpfree ( ( char * ) ptr_fml_Obuf );
      /** tpfree ( ( char * ) ptr_fml_Obuf ); ** Ver 2.2 **/
      tpfree ( ( char * ) ptr_st_exrcbook ); /** Ver 2.2 **/ 
      l_acnt_id = -1;
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID ,(char*)&l_acnt_id, 0 );
      /** tpcommit(0); commented for Ver 1.9 **/ 
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }
  l_actn_id=0;                          /**Ver 1.5 Actn Id is hardcoded as 1 for every order ***/

  Fadd32( ptr_fml_Obuf, FFO_ACTN_ID ,(char*)&l_acnt_id, 0 );

  } /*** End of for loop ***/

  if(DEBUG_MSG_LVL_3)
  {   
    fn_userlog(c_ServiceName,"i_counter value is [%ld]",i_counter);
    fn_userlog(c_ServiceName,"i_mtch_count value is [%ld]",i_mtch_cnt);
  }

  if( Fadd32 ( ptr_fml_Obuf, FFO_SUB_BUF_CNT,(char *)&i_mtch_cnt,0) == -1 )
  {
      fn_errlog( c_ServiceName, "S31225", FMLMSG, c_err_msg  );
      Fadd32( ptr_fml_Ibuf, FFO_ERR_MSG, c_err_msg, 0 );
      tpfree ( ( char * ) ptr_fml_Obuf );
      /** tpfree ( ( char * ) ptr_fml_Obuf ); *** Ver 2.2 **/
      tpfree ( ( char * ) ptr_st_exrcbook ); /** Ver 2.2 **/
      l_acnt_id = -1;
      Fadd32( ptr_fml_Ibuf, FFO_ACTN_ID ,(char*)&l_acnt_id, 0 );
      /** tpcommit(0);  commented for Ver 1.9 **/
      tpreturn(TPFAIL, ERR_BFR, (char *)ptr_fml_Ibuf, 0, 0 );
  }

  EXEC SQL CLOSE :sys_cursor;
  EXEC SQL FREE :sys_cursor;
  tpfree ( ( char * ) ptr_st_exrcbook );

  /** tpcommit(0); commented for Ver 1.9 **/		


  /***Ver 1.5 Ends ***/
  fn_userlog(c_ServiceName, "END OF SFO_EXRC_BOOK for :%s:",ptr_st_exrcbook->c_cln_mtch_accnt);

		
  tpreturn( TPSUCCESS, 0, (char *)ptr_fml_Obuf, 0 , 0 );
}
